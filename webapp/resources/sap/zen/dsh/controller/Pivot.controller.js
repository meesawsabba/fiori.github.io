/*!
 * SAPUI5
  (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define("sap/zen/dsh/controller/Pivot.controller",["sap/zen/dsh/utils/Utilities","sap/zen/dsh/utils/ResourceBundle","sap/ui/core/mvc/Controller","sap/zen/dsh/utils/ErrorHandler","sap/zen/dsh/NavigationCmdType","sap/zen/dsh/DimensionType","sap/zen/dsh/CellValueType","sap/zen/commons/CellType","sap/zen/dsh/Axis","sap/zen/dsh/SortType","sap/zen/dsh/SortDirection"],function(U,R,C,E,N,D,a,b,A,S,c){"use strict";C.extend("sap.zen.dsh.controller.Pivot",{onAfterRendering:function(){var t=this;var v=t.getView();v.getModel("om").attachRequestSent(function(d){if(t.getPivot().getDataProviderName()==d.getParameter("infoObject")){t.getPivot().getEasyGrid().setBusyIndicatorDelay(0);t.getPivot().getEasyGrid().setBusy(true);}});v.getModel("om").attachRequestCompleted(function(){var e=t.getPivot().getEasyGrid();e.setBusy(false);});v.getModel("om").attachRequestFailed(function(){var e=t.getPivot().getEasyGrid();e.setBusy(false);});},requestRows:function(e){var t=this;var o=t.getView().getModel("om");var d=o.getDataProvider(t.getPivot().getDataProviderName());var n=e.getParameter("currentRow");if(d&&n!==d.virtualOffsetRow){t.getPivot().fireNavigationCmd({navigationCmdType:N.RowRequest,cmd:function(){t.getPivot().getEasyGrid().setBusy(false);return d.setOffsetRow(n).synchronize(true);}});}},onExit:function(){var t=this;t.getView().removeAllDependents();},requestColumns:function(e){var t=this;var o=t.getView().getModel("om");var d=o.getDataProvider(t.getPivot().getDataProviderName());var n=e.getParameter("currentColumn");t.getPivot().fireNavigationCmd({navigationCmdType:sap.zen.dsh.NavigationCmdType.ColumnRequest,cmd:function(){t.getPivot().getEasyGrid().setBusy(false);return d.setOffsetCol(n).synchronize(true);}});},onDrill:function(e){var o=e.getParameter("cell");var k=e.getParameter("keepOffset");var d=this.getView().getModel("om").getDataProvider(this.getPivot().getDataProviderName());function f(){return Promise.resolve(null).then(function(){return d.drill(o.data("cellDimension"),o.data("tupleIndex"),k);});}this.getPivot().fireNavigationCmd({navigationCmdType:N.HierarchyNavigation,cmd:f,cell:o});},onRightClick:function(e){var t=this;var o=e.getParameter("cell");var d=o.data("cellDimension");var m;var s;var f=null;var g=null;var v=t.getView();var O=v.getModel("om");var l=e.getParameter("link");var h=O.getDataProvider(t.getPivot().getDataProviderName()).Dimensions[d];var i=null;if(h){if(h.Axis===A.Rows){i=O.getDataProvider(t.getPivot().getDataProviderName()).getRowSelection(o.data("tupleIndex"));}else if(h.Axis===A.Columns){i=O.getDataProvider(t.getPivot().getDataProviderName()).getColumnSelection(o.data("tupleIndex"));}}else if(o.getCellType()===b.STANDARD||o.getCellType()===b.RESULT){i=O.getDataProvider(t.getPivot().getDataProviderName()).getSelection(o.data("dataRow"),o.data("dataColumn"));}function j(){return Promise.resolve(o.data().dataRow===null||o.data().dataColumn===null?[]:t.getView().getModel("om").getDataProvider(t.getPivot().getDataProviderName()).getRRITargets(o.data().dataRow,o.data().dataColumn)).then(function(r){var F=O.getDataProvider(t.getPivot().getDataProviderName()).FreeDimensions;if(d){s=null;if(o.getCellType()===b.RESULT||o.getCellType()===b.STANDARD){m=null;}else{m=o.data("cellMember");}if(!h.IsStructure){if(h.SortDirection===c.DESCENDING){f="sap-icon://sort-descending";g=R.getText("DESCENDING");}else if(h.SortDirection===c.ASCENDING){f="sap-icon://sort-ascending";g=R.getText("ASCENDING");}}var H=false;var k=h.HierarchyActive;v.getModel("cm").setData({Dimension:h.Name,axis:h.Axis,isDataCell:o.data("dataRow")>-1,Member:m,hasDrill:k,isDynMember:false,IsStructure:h.IsStructure,IsKeyFigureStructure:h.Type===D.MeasureDimension,hasSelCandidate:H,sortOrder:s,sortIcon:f,sortTooltip:g,sortType:o.data("cellValueType")===a.Text?S.MemberText:S.MemberKey,hierarchyActive:h.HierarchyActive,hasFilter:h.HasFilter,rri:r,FreeDimensions:F,dataCell:o.data("dataCell"),hasMember:!!m});}else{v.getModel("cm").setData({row:o.data("dataRow"),column:o.data("dataColumn"),isDataCell:o.data("dataRow")>-1,dataCell:o.data("dataCell"),Dimension:false,FreeDimensions:F,Member:false,rri:r,IsStructure:false});}return U.getDialogs();}).then(function(k){return k.ContextMenu.open(l,t.getPivot(),v.getModel("cm"),v.getModel("om"));}).catch(E.handleWithPopUp);}t.getPivot().fireNavigationCmd({cmd:j,anchor:l,cell:o,selection:i,navigationCmdType:N.CellClick});return;}});return sap.zen.dsh.controller.Pivot;});
