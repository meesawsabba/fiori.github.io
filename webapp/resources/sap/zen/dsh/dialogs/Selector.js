/*!
 * SAPUI5
  (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define("sap/zen/dsh/dialogs/Selector",["sap/base/Log","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/m/Token","sap/zen/dsh/utils/ResourceModel","sap/zen/dsh/utils/ResourceBundle","sap/zen/dsh/utils/TokenHelper","sap/zen/dsh/DimensionType","sap/zen/commons/thirdparty/lodash"],function(L,F,J,M,T,R,a,b,D,_){"use strict";var d;var r,c;var O={EQ:"",LT:"<",LE:"<=",GT:">",GE:">=",NE:"!"};function t(o,H){function f(){var l=H[o.Low];var s=l?l.description:o.Low;var j=H[o.High];if(o.ComparisonOperator==="BT"){var k=l&&j?j.description:o.High;return[s,k].join("-");}else{return[O[o.ComparisonOperator],s].join("");}}var i=new T({key:o.Low,text:f()});i.data().range=o;if(o.ComparisonOperator==="NE"){o.ComparisonOperator="EQ";o.exclude=true;}return i;}function h(f,i){r=f;c=i;}var e;function g(C){return C.runAsOwner(function(){return Promise.resolve(F.load({name:"sap.zen.dsh.fragment.Selector",controller:{search:function(){d.setBusy(true);Promise.resolve(null).then(function(){return d.getModel("om").getDataProvider(d.getModel().getProperty("/dpname")).getMemberCatalog(d.getModel().getProperty("/dimension"),sap.ui.getCore().byId("fbdimtext").getValue());}).then(function(o){e.getModel().setData(o.catalog);e.clearSelection();d.setBusy(false);}).catch(function(E){L.error(E.stack);d.setBusy(false);M.show(E.message,{icon:M.Icon.ERROR,title:d.getModel("i18n").getResourceBundle().getText("ERROR_OPEN"),actions:[M.Action.CLOSE]});});},onOkValueHelp:function(E){d.close();var f=r;r=null;f(_.map(E.getParameter("tokens"),function(o){var i=o.data("range");return i?{ComparisonOperator:i.exclude?"NE":i.operation,Low:i.value1 instanceof Date?b.dateToYMD(i.value1):i.value1,High:i.value2 instanceof Date?b.dateToYMD(i.value2):i.value2}:{ComparisonOperator:"EQ",Low:o.getKey(),Text:o.getText()};}));},onAfterClose:function(){d.close();if(r){r(null);}}}})).then(function(f){d=f;d.setModel(new J());d.setModel(R,"i18n");d.openSelector=function(i,j,k,l){d.setBusy(true);d.getModel().setProperty("/supportRanges",!i.getDataProvider(j).Dimensions[k].IsStructure);d.getModel().setProperty("/dpname",j);d.getModel().setProperty("/dimension",k);d.getModel().setProperty("/description",i.getDataProvider(j).Dimensions[k].Description);d.open();d.getTableAsync().then(function(o){e=o;e.setModel(new J());e.setModel(new J(),"columns");e.getModel("columns").setData({cols:[{label:a.getText("KEY"),template:"key"},{label:a.getText("DISPLAY_KEY"),template:"displayKey"},{label:a.getText("Description"),template:"description"}]});e.getModel("columns").setData({cols:[{label:"Key",template:"key",visible:false},{label:a.getText("DISPLAY_KEY"),template:"displayKey"},{label:a.getText("Description"),template:"description"}]});e.getColumns()[0].setVisible(false);e.bindRows("/");e.getModel().setData([]);f.setModel(i,"om");return d.getModel("om").getDataProvider(d.getModel().getProperty("/dpname")).getMemberCatalog(d.getModel().getProperty("/dimension"),sap.ui.getCore().byId("fbdimtext").getValue());}).then(function(m){var n=m||{};e.getModel().setData(n.catalog);if(e.bindRows){e.bindRows("/");}d.setTokens([]);var p=_.reduce(l,function(o,s){o[s]=true;return o;},{});_.forEach(n.catalog,function(E,o){if(p[E.key]){e.addSelectionInterval(o,o);}});var H=_.reduce(n.catalog,function(o,q){o[q.key]=q;return o;},{});d.setTokens(_.map(l,function(o){var q=t(o,H);return q;}));f.setRangeKeyFields([{key:"displayKey",type:i.getDataProvider(j).Dimensions[k].Type===D.DateDimension?"date":null,label:"{i18n>DISPLAY_KEY}"}]);d.setBusy(false);}).catch(function(E){d.setBusy(false);c(E);});return new Promise(h);};return d;});});}return g;});
