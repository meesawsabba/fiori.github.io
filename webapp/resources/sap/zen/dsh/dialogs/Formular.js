/*!
 * SAPUI5
  (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define("sap/zen/dsh/dialogs/Formular",["sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/zen/dsh/utils/ResourceBundle","sap/zen/dsh/utils/ResourceModel","sap/zen/commons/thirdparty/lodash"],function(F,J,R,b,_){"use strict";var r,f;function h(a,c){r=a;f=c;}var d=null;var D;var p={"+":1,"-":2,"*":3,"/":4};var s="";function g(c){return c.runAsOwner(function(){return Promise.resolve(F.load({name:"sap.zen.dsh.fragment.FormularDialog",controller:{onOk:function(){d.setBusy(true);var H=_.reduce(D.getModel("Formular").getProperty("/Members"),function(C,o){C[o.FDescription]=o.Name;return C;},{});function e(i){function j(o){return o.getType()==="Operator"&&o.getKey()==="(";}function k(o){return o.getType()==="Operator"&&o.getKey()===")";}function l(a){var n=0;function q(o,t){if(!o){return t;}return p[o]<=p[t]?o:t;}return _.reduce(a,function(C,o,t){if(j(o)){n++;return C;}else if(k(o)){n--;return C;}else if(o.getType()==="Operator"&&n===0){var u=q(C.operator,o.getKey());if(u!==C.operator){C.operator=u;C.leftItems=a.slice(0,t);C.rightItems=a.slice(t+1,a.length);}return C;}else{return C;}},{operator:null,leftItems:null,rightItems:null});}function m(a){if(!j(a[0])||!k(a[a.length-1])){return a;}var q=_.reduce(a.slice(1,a.length-1),function(t,o){var n=t;if(j(o)){n++;}else if(k(o)){n--;}return n;},0)===0?m(a.slice(1,a.length-1)):a;return q;}var I=m(i);var O=l(I);if(O.operator){return{operator:O.operator,left:O.leftItems?e(O.leftItems):null,right:O.rightItems?e(O.rightItems):null};}else if(I[0].getType()==="CustomFunction"||I[0].getType()==="Function"){return{operator:I[0].getKey(),left:e(I.slice(1,I.length-1))};}else{return{operator:I[0].getType(),left:I[0].getType()==="Variable"?H[I[0].getKey()]:parseFloat(I[0].getKey())};}}if(D.getContent()[0].byId("builder").getItems().length){var P=e(D.getContent()[0].byId("builder").getItems());D.getModel("om").getDataProvider(s).addFormula(D.getModel("Formular").getProperty("/StructureKey"),D.getModel("Formular").getProperty("/Description"),P,D.getModel("Formular").getProperty("/exceptionalAggregation"),D.getModel("Formular").getProperty("/exceptionalAggregationDim")).then(function(){r(true);D.close();}).catch(function(E){f(E);D.close();});}else{D.close();}},beforeClose:function(){d.setBusy(false);},onCancel:function(){r(false);D.close();}}}).then(function(o){d=o;o.setModel(b,"i18n");D=o;D.setModel(new J(),"Formular");var O=D.open;D.open=function(e,i,j,m){s=i;var C=D.getModel("Formular");D.setModel(e,"om");var a=e.getProperty(["/dataProvider",s,"Dimensions",encodeURIComponent(j)].join("/"));var k=_.filter(e.getDataProvider(s).Dimensions,function(l){return!l.IsStructure;}).map(function(l){return{Name:l.Name,Description:l.Description};}).sort(function(l,n){return l.Description<n.Description;});D.setTitle(R.getText(m?"DISP_FORMULA":"FORMULA_SETTINGS"));C.setData({changeMode:!m,displayMode:!!m,exceptionalAggregationDim:k[0].Name,dimensions:k,exceptionalAggregation:"DEFAULT",Structure:a.Description,StructureKey:a.Name,isValid:true,Expression:m?e.getDataProvider(s).getFormulaContent(j,m):"0",Members:_.map(e.getDataProvider(s).getStructureMembers(j),function(M){return{Name:M.Name,Description:M.Description,FDescription:M.Description.replace(/\s/g,"")};}),Description:m?m.Description:R.getText("FORMULAR_DESCR",1)});d.setBusy(false);O.call(D);return new Promise(h);};return D;}));});}return g;});
