/*!
 * SAPUI5
  (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/zen/dsh/firefly/ff0005.language.ext","sap/zen/dsh/firefly/ff2100.runtime"],function(f){"use strict";f.RpcSqlInaUtil={QY_MESSAGES:"Messages",QY_MESSAGE_CLASS:"MessageClass",QY_NUMBER:"Number",QY_TYPE:"Type",QY_TEXT:"Text",VA_SEVERITY_ERROR:2,createErrorResponse:function(e){var r=f.PrFactory.createStructure();var m=r.putNewList(f.RpcSqlInaUtil.QY_MESSAGES);var s=e.size();for(var i=0;i<s;i++){var a=e.get(i);var b=m.addNewStructure();b.putString(f.RpcSqlInaUtil.QY_TEXT,a.getText());b.putInteger(f.RpcSqlInaUtil.QY_TYPE,f.RpcSqlInaUtil.VA_SEVERITY_ERROR);b.putInteger(f.RpcSqlInaUtil.QY_NUMBER,a.getCode());b.putString(f.RpcSqlInaUtil.QY_MESSAGE_CLASS,"RpcSql");}return r;},getErrors:function(d){var e=f.XList.create();if(f.notNull(d)&&d.isStructure()){var r=d.asStructure().getByKey(f.RpcSqlInaUtil.QY_MESSAGES);if(f.notNull(r)&&r.isList()){var m=r.asList();for(var i=0,s=m.size();i<s;i++){if(m.getStructureAt(i).getIntegerByKey(f.RpcSqlInaUtil.QY_TYPE)===f.RpcSqlInaUtil.VA_SEVERITY_ERROR){e.add(f.XMessage.createError("RpcSql",m.getStructureAt(i).getStringByKey(f.RpcSqlInaUtil.QY_TEXT),null,false,null));}}}}return e;}};f.RpcSqlDriverFactory=function(){};f.RpcSqlDriverFactory.prototype=new f.SqlDriverFactory();f.RpcSqlDriverFactory.prototype._ff_c="RpcSqlDriverFactory";f.RpcSqlDriverFactory.staticSetup=function(){f.SqlDriverFactory.registerFactory(new f.RpcSqlDriverFactory());};f.RpcSqlDriverFactory.prototype.newSqlDriver=f.noSupport;f.RpcSqlProxy=function(){};f.RpcSqlProxy.prototype=new f.XObject();f.RpcSqlProxy.prototype._ff_c="RpcSqlProxy";f.RpcSqlProxy.prototype.m_connectionstring=null;f.RpcSqlProxy.prototype.m_drivername=null;f.RpcSqlProxy.prototype.m_username=null;f.RpcSqlProxy.prototype.m_password=null;f.RpcSqlProxy.prototype.convert=function(s){var m=s.getMetaData();var r=f.PrFactory.createStructure();var c=r.putNewList("columns");for(var i=0;i<m.size();i++){c.add(f.PrFactory.createString(m.get(i)));}var v=r.putNewList("values");while(s.next()){var a=v.addNewList();for(var j=0;j<m.size();j++){var t=m.getType(j);if(t===f.SqlResultSetType.DOUBLE){a.add(f.PrFactory.createDouble(s.getDoubleAt(j)));continue;}if(t===f.SqlResultSetType.LONG){a.add(f.PrFactory.createLong(s.getLongAtExt(j,-1)));continue;}if(t===f.SqlResultSetType.INTEGER){a.add(f.PrFactory.createInteger(s.getIntegerAtExt(j,-1)));continue;}if(t===f.SqlResultSetType.BOOLEAN){a.add(f.PrFactory.createBoolean(s.getBooleanAtExt(j,true)));continue;}if(t===f.SqlResultSetType.STRING){a.add(f.PrFactory.createString(s.getStringAtExt(j,null)));continue;}a.addNull();}}return r;};f.RpcSqlProxy.prototype.getDataBaseProvider=function(){var d=f.SqlDriverFactory.create(this.m_drivername);d.processOpenExt(f.SyncType.BLOCKING,null,null,this.m_connectionstring,this.m_username,this.m_password);return d;};f.RpcSqlProxy.prototype.onHttpRequest=function(a){var r=a.getClientRequest().getJsonContent();var b=a.getClientRequest().getRelativePath();var n=a.newServerResponse();n.setContentType(f.ContentType.APPLICATION_JSON);if(f.XString.isEqual(b,"/sap/sql/ina/GetServerInfo")){var d=f.PrFactory.createStructure();var e=d.putNewStructure("ServerInfo");e.putString("SystemId","SQLJSON");e.putString("DataBaseManagementSystem","Generic Sql");var g=d.putNewList("Services");var s=g.addNewStructure();var h=s.putNewList("Capabilities");var i=h.addNewStructure();i.putString("Capability","BasicSql");i.putString("Description","A simple sql protocol");i=h.addNewStructure();i.putString("Capability","BasicSqlMetaData");i.putString("Description","Metadata for Sql Database");s.putString("Service","Analytics");d.putNewStructure("Settings");n.setString(d.toString());a.setResponse(n);return;}else if(f.XString.isEqual(b,"/BasicSql")){if(f.isNull(r)||!r.isStructure()){var c=f.MessageManagerSimple.createMessageManager();c.addError(1,"Expected a json object!");this.respondWithInaError(a,n,c.getErrors());return;}var j=r.asStructure().getStringByKey("sql");var t=r.asStructure().getStringByKey("type");var k=this.getDataBaseProvider();if(f.XString.isEqual(t,"update")){k.processExecuteUpdate(f.SyncType.BLOCKING,null,null,j);if(k.hasErrors()){this.respondWithInaError(a,n,k.getErrors());}else{n.setStatusCode(201);a.setResponse(n);}}else if(f.XString.isEqual(t,"query")){var l=k.processExecuteQuery(f.SyncType.BLOCKING,null,null,j);if(k.hasErrors()){this.respondWithInaError(a,n,k.getErrors());}else{var m=this.convert(l.getData());n.setStatusCode(200);n.setString(m.toString());a.setResponse(n);}}else{var o=f.MessageManagerSimple.createMessageManager();o.addError(1,f.XStringUtils.concatenate2("Unexpected query type: ",t));this.respondWithInaError(a,n,o.getErrors());}k.close();}else if(f.XString.isEqual(b,"/GetSchemas")){this.getSchemas(r.asStructure(),a,n);}else if(f.XString.isEqual(b,"/GetTables")){this.getTables(r.asStructure(),a,n);}else if(f.XString.isEqual(b,"/GetColumns")){this.getColumns(r.asStructure(),a,n);}else if(f.XString.isEqual(b,"/GetImportedKeys")){this.getImportedKeys(r.asStructure(),a,n);}else{n.setStatusCode(404);a.setResponse(n);}};f.RpcSqlProxy.prototype.getSchemas=function(r,s,n){var d=this.getDataBaseProvider();var t=d.processGetSchemas(f.SyncType.BLOCKING,null,null);if(d.hasErrors()){this.respondWithInaError(s,n,d.getErrors());}else{n.setStatusCode(200);n.setString(this.convert(t.getData()).toString());s.setResponse(n);}d.close();};f.RpcSqlProxy.prototype.getTables=function(r,s,n){var d=this.getDataBaseProvider();var c=r.getStringByKey("catalog");var a=r.getStringByKey("schemaNamePattern");var t=r.getStringByKey("tableNamePattern");var b=d.processGetTables(f.SyncType.BLOCKING,null,null,c,a,t);if(d.hasErrors()){this.respondWithInaError(s,n,d.getErrors());}else{n.setStatusCode(200);n.setString(this.convert(b.getData()).toString());s.setResponse(n);}d.close();};f.RpcSqlProxy.prototype.getColumns=function(r,s,n){var d=this.getDataBaseProvider();var c=r.getStringByKey("catalog");var a=r.getStringByKey("schemaNamePattern");var t=r.getStringByKey("tableNamePattern");var b=r.getStringByKey("columnNamePattern");var e=d.processGetColumns(f.SyncType.BLOCKING,null,null,c,a,t,b);if(d.hasErrors()){this.respondWithInaError(s,n,d.getErrors());}else{n.setStatusCode(200);n.setString(this.convert(e.getData()).toString());s.setResponse(n);}d.close();};f.RpcSqlProxy.prototype.getImportedKeys=function(r,s,n){var d=this.getDataBaseProvider();var c=r.getStringByKey("catalog");var a=r.getStringByKey("schema");var t=r.getStringByKey("table");var b=d.processGetImportedKeys(f.SyncType.BLOCKING,null,null,c,a,t);if(d.hasErrors()){this.respondWithInaError(s,n,d.getErrors());}else{n.setStatusCode(200);n.setString(this.convert(b.getData()).toString());s.setResponse(n);}d.close();};f.RpcSqlProxy.prototype.respondWithInaError=function(s,n,e){var c=f.MessageManagerSimple.createMessageManager();c.setServerStatusCode(404);n.setString(f.RpcSqlInaUtil.createErrorResponse(e).toString());n.setStatusCode(200);s.setResponse(n);};f.RpcSqlProxy.prototype.initServerContainer=function(e){this.m_drivername=e.getByKey("drivername");this.m_connectionstring=e.getByKey("connectionstring");this.m_username=e.getByKey("username");this.m_password=e.getByKey("password");};f.RpcSqlDriver=function(){};f.RpcSqlDriver.prototype=new f.MessageManager();f.RpcSqlDriver.prototype._ff_c="RpcSqlDriver";f.RpcSqlDriver.create=function(d,a,s){var n=new f.RpcSqlDriver();n.setupDriver(a,s);return n;};f.RpcSqlDriver.prototype.m_connectionUri=null;f.RpcSqlDriver.prototype.m_connection=null;f.RpcSqlDriver.prototype.m_application=null;f.RpcSqlDriver.prototype.m_systemAlias=null;f.RpcSqlDriver.prototype.setupDriver=function(a,s){this.m_application=a;this.m_systemAlias=s;this.setupSessionContext(null);};f.RpcSqlDriver.prototype.open=function(u){this.m_connection=this.m_application.getConnectionPool().getConnection(this.m_systemAlias);var s=this.m_connection.getServerMetadata();if(f.isNull(s)){this.addError(9,"Failed to connect to server, missing Server Metadata");return;}if(!s.supportsAnalyticCapability("BasicSql")){this.addError(10,"Server doesn't support BasicSql");return;}};f.RpcSqlDriver.prototype.openExt=function(u,a,p){this.open(f.XUri.createFromUrl(u));};f.RpcSqlDriver.prototype.close=function(){};f.RpcSqlDriver.prototype.executeUpdate=function(s){var a=f.PrFactory.createStructure();a.putString("type","update");a.putString("sql",s);var r=this.m_connection.newRpcFunction("/BasicSql");r.getRpcRequest().setMethod(f.HttpRequestMethod.HTTP_POST);r.getRpcRequest().setRequestStructure(a);r.processFunctionExecution(f.SyncType.BLOCKING,null,null);this.addAllMessages(r);return 0;};f.RpcSqlDriver.prototype.processExecuteUpdate=function(s,l,c,a){return f.RpcSqlUpdateAction.createAndRun(this,this.m_connection,s,l,c,this.getSession(),a);};f.RpcSqlDriver.prototype.executeQuery=function(s){var a=f.PrFactory.createStructure();a.putString("type","query");a.putString("sql",s);var r=this.m_connection.newRpcFunction("/BasicSql");r.getRpcRequest().setMethod(f.HttpRequestMethod.HTTP_POST);r.getRpcRequest().setRequestStructure(a);r.processFunctionExecution(f.SyncType.BLOCKING,null,null);this.addAllMessages(r);var b=f.PrFactory.createList();b.add(r.getRpcResponse().getRootElement());return f.SqlJsonResultSet.create(b);};f.RpcSqlDriver.prototype.processExecuteQuery=function(s,l,c,a){return f.RpcSqlQueryAction.createAndRun(this,this.m_connection,s,l,c,this.getSession(),a);};f.RpcSqlDriver.prototype.getConnection=function(){return this.m_connectionUri;};f.RpcSqlDriver.prototype.processOpen=function(s,l,c,u){this.open(u);return f.RpcSqlOpenAction.createAndRun(this,s,l,c,this.getSession());};f.RpcSqlDriver.prototype.processOpenExt=function(s,l,c,u,a,p){this.openExt(u,a,p);return f.RpcSqlOpenAction.createAndRun(this,s,l,c,this.getSession());};f.RpcSqlDriver.prototype.processGetSchemas=function(s,l,c){var a=this.m_connection.getServerMetadata();if(f.isNull(a)){this.addError(9,"Failed to connect to server, missing Server Metadata");return f.SqlSynchroniousQueryAction.createAndRun(null,s,l,c,this.getSession());}if(!a.supportsAnalyticCapability("BasicSqlMetaData")){this.addError(10,"Server doesn't support BasicSqlMetaData");return f.SqlSynchroniousQueryAction.createAndRun(null,s,l,c,this.getSession());}return f.RpcSqlQueryAction.createAndRunSpecial(this,this.m_connection,s,l,c,this.getSession(),"/GetSchemas",f.PrFactory.createStructure());};f.RpcSqlDriver.prototype.processGetTables=function(s,l,c,a,b,t){var d=this.m_connection.getServerMetadata();if(f.isNull(d)){this.addError(9,"Failed to connect to server, missing Server Metadata");return f.SqlSynchroniousQueryAction.createAndRun(null,s,l,c,this.getSession());}if(!d.supportsAnalyticCapability("BasicSqlMetaData")){this.addError(10,"Server doesn't support BasicSqlMetaData");return f.SqlSynchroniousQueryAction.createAndRun(null,s,l,c,this.getSession());}var e=f.PrFactory.createStructure();e.putString("catalog",a);e.putString("schemaNamePattern",b);e.putString("tableNamePattern",t);return f.RpcSqlQueryAction.createAndRunSpecial(this,this.m_connection,s,l,c,this.getSession(),"/GetTables",e);};f.RpcSqlDriver.prototype.processGetColumns=function(s,l,c,a,b,t,d){var e=this.m_connection.getServerMetadata();if(f.isNull(e)){this.addError(9,"Failed to connect to server, missing Server Metadata");return f.SqlSynchroniousQueryAction.createAndRun(null,s,l,c,this.getSession());}if(!e.supportsAnalyticCapability("BasicSqlMetaData")){this.addError(10,"Server doesn't support BasicSqlMetaData");return f.SqlSynchroniousQueryAction.createAndRun(null,s,l,c,this.getSession());}var g=f.PrFactory.createStructure();g.putString("catalog",a);g.putString("schemaNamePattern",b);g.putString("tableNamePattern",t);g.putString("columnNamePattern",d);return f.RpcSqlQueryAction.createAndRunSpecial(this,this.m_connection,s,l,c,this.getSession(),"/GetColumns",g);};f.RpcSqlDriver.prototype.processGetImportedKeys=function(s,l,c,a,b,t){var d=this.m_connection.getServerMetadata();if(f.isNull(d)){this.addError(9,"Failed to connect to server, missing Server Metadata");return f.SqlSynchroniousQueryAction.createAndRun(null,s,l,c,this.getSession());}if(!d.supportsAnalyticCapability("BasicSqlMetaData")){this.addError(10,"Server doesn't support BasicSqlMetaData");return f.SqlSynchroniousQueryAction.createAndRun(null,s,l,c,this.getSession());}var e=f.PrFactory.createStructure();e.putString("catalog",a);e.putString("schema",b);e.putString("table",t);return f.RpcSqlQueryAction.createAndRunSpecial(this,this.m_connection,s,l,c,this.getSession(),"/GetImportedKeys",e);};f.RpcSqlOpenAction=function(){};f.RpcSqlOpenAction.prototype=new f.SyncAction();f.RpcSqlOpenAction.prototype._ff_c="RpcSqlOpenAction";f.RpcSqlOpenAction.createAndRun=function(d,s,l,c,a){var o=new f.RpcSqlOpenAction();o.m_driver=d;o.setupActionAndRun(s,l,c,a);return o;};f.RpcSqlOpenAction.prototype.m_driver=null;f.RpcSqlOpenAction.prototype.callListener=function(e,l,d,c){l.onOpened(e,d,c);};f.RpcSqlOpenAction.prototype.processSynchronization=function(s){this.setData(this.m_driver);return false;};f.RpcSqlQuery=function(){};f.RpcSqlQuery.prototype=new f.SyncAction();f.RpcSqlQuery.prototype._ff_c="RpcSqlQuery";f.RpcSqlQuery.createAndRun=function(d,s,l,c,a){var o=new f.RpcSqlQuery();o.m_driver=d;o.setupActionAndRun(s,l,c,a);return o;};f.RpcSqlQuery.prototype.m_driver=null;f.RpcSqlQuery.prototype.callListener=function(e,l,d,c){l.onQueryResult(e,d,c);};f.RpcSqlQuery.prototype.processSynchronization=function(s){this.m_driver.addInfo(0,"");this.setData(null);return false;};f.RpcSqlQueryAction=function(){};f.RpcSqlQueryAction.prototype=new f.SyncAction();f.RpcSqlQueryAction.prototype._ff_c="RpcSqlQueryAction";f.RpcSqlQueryAction.createAndRun=function(d,c,s,l,a,b,e){var g=f.PrFactory.createStructure();g.putString("type","query");g.putString("sql",e);return f.RpcSqlQueryAction.createAndRunSpecial(d,c,s,l,a,b,"/BasicSql",g);};f.RpcSqlQueryAction.createAndRunSpecial=function(d,c,s,l,a,b,e,g){var o=new f.RpcSqlQueryAction();o.m_driver=d;if(f.isNull(c)){d.addError(2,"Not Connected!");o.m_rpc=null;}else{var r=c.newRpcFunction(e);r.getRpcRequest().setMethod(f.HttpRequestMethod.HTTP_POST);r.getRpcRequest().setRequestStructure(g);o.m_rpc=r;}o.setupActionAndRun(s,l,a,b);return o;};f.RpcSqlQueryAction.prototype.m_driver=null;f.RpcSqlQueryAction.prototype.m_rpc=null;f.RpcSqlQueryAction.prototype.callListener=function(e,l,d,c){l.onQueryResult(e,d,c);};f.RpcSqlQueryAction.prototype.processSynchronization=function(s){if(f.isNull(this.m_rpc)){return false;}this.m_rpc.processFunctionExecution(s,this,null);return true;};f.RpcSqlQueryAction.prototype.onFunctionExecuted=function(e,r,c){this.m_driver.addAllMessages(this.m_rpc);if(this.m_rpc.isValid()&&this.m_rpc.getServerStatusCode()===200){var a=f.RpcSqlInaUtil.getErrors(this.m_rpc.getRpcResponse().getRootElement());if(a.size()>0){for(var i=0,s=a.size();i<s;i++){this.m_driver.addMessage(a.get(i));}}else{var b=f.PrFactory.createList();b.add(this.m_rpc.getRpcResponse().getRootElement());this.setData(f.SqlJsonResultSet.create(b));}}else{this.m_driver.addError(2,"Failed to execute Query");this.setData(null);}this.endSync();};f.RpcSqlUpdateAction=function(){};f.RpcSqlUpdateAction.prototype=new f.SyncAction();f.RpcSqlUpdateAction.prototype._ff_c="RpcSqlUpdateAction";f.RpcSqlUpdateAction.createAndRun=function(d,c,s,l,a,b,e){var o=new f.RpcSqlUpdateAction();o.m_driver=d;if(f.isNull(c)){d.addError(2,"Not Connected!");o.m_rpc=null;}else{var g=f.PrFactory.createStructure();g.putString("type","update");g.putString("sql",e);var r=c.newRpcFunction("/BasicSql");r.getRpcRequest().setMethod(f.HttpRequestMethod.HTTP_POST);r.getRpcRequest().setRequestStructure(g);o.m_rpc=r;}o.setupActionAndRun(s,l,a,b);return o;};f.RpcSqlUpdateAction.prototype.m_driver=null;f.RpcSqlUpdateAction.prototype.m_rpc=null;f.RpcSqlUpdateAction.prototype.callListener=function(e,l,d,c){l.onUpdated(e,d,c);};f.RpcSqlUpdateAction.prototype.processSynchronization=function(s){if(f.isNull(this.m_rpc)){return false;}this.m_rpc.processFunctionExecution(s,this,null);return true;};f.RpcSqlUpdateAction.prototype.onFunctionExecuted=function(e,r,c){this.m_driver.addAllMessages(this.m_rpc);if(this.m_rpc.isValid()&&this.m_rpc.getServerStatusCode()>=200&&this.m_rpc.getServerStatusCode()<300){var a=f.RpcSqlInaUtil.getErrors(this.m_rpc.getRpcResponse().getRootElement());if(a.size()>0){for(var i=0,s=a.size();i<s;i++){this.m_driver.addMessage(a.get(i));}this.setData(f.XIntegerValue.create(1));}else{this.setData(f.XIntegerValue.create(0));}}else{this.m_driver.addError(2,"Failed to execute Update");this.setData(f.XIntegerValue.create(1));}this.endSync();};f.SqlModule=function(){};f.SqlModule.prototype=new f.DfModule();f.SqlModule.prototype._ff_c="SqlModule";f.SqlModule.s_module=null;f.SqlModule.getInstance=function(){if(f.isNull(f.SqlModule.s_module)){f.DfModule.checkInitialized(f.RuntimeModule.getInstance());f.SqlModule.s_module=f.DfModule.startExt(new f.SqlModule());f.DfModule.stopExt(f.SqlModule.s_module);}return f.SqlModule.s_module;};f.SqlModule.prototype.getName=function(){return"ff3500.sql";};f.SqlModule.getInstance();return sap.firefly;});
