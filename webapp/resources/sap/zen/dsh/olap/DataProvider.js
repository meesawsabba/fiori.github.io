/*!
 * SAPUI5
  (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define("sap/zen/dsh/olap/DataProvider",["sap/base/Log","sap/zen/commons/Format","sap/zen/dsh/Axis","sap/zen/commons/CellType","sap/zen/dsh/DimensionType","sap/zen/dsh/DisplayType","sap/zen/dsh/ComparisonOperator","sap/zen/dsh/utils/Utilities","sap/zen/dsh/utils/SyncActionHelper","sap/zen/dsh/utils/ListHelper","sap/zen/dsh/utils/TokenHelper","sap/zen/dsh/utils/ResultSetHelper","sap/zen/dsh/utils/ResourceBundle","sap/zen/commons/SpreadSheet/CellInfo","sap/zen/commons/SpreadSheet/CXpStyle","sap/zen/commons/thirdparty/lodash"],function(L,F,A,C,D,a,c,U,S,d,T,R,e,f,g,_){"use strict";var h=function(O,v,u,j,q,k){var t=this;var Q=null;var r;var l=U.getDialogs();var I=true;function m(o){switch(o){case sap.firefly.ComparisonOperator.EQUAL:return"EQ";case sap.firefly.ComparisonOperator.LESS_THAN:return"LT";case sap.firefly.ComparisonOperator.LESS_EQUAL:return"LE";case sap.firefly.ComparisonOperator.GREATER_THAN:return"GT";case sap.firefly.ComparisonOperator.GREATER_EQUAL:return"GE";case sap.firefly.ComparisonOperator.BETWEEN:return"BT";case sap.firefly.ComparisonOperator.NOT_EQUAL:return"NE";default:throw new Error("Invalid Operator: "+o.getName());}}var V={};t.OffsetCol=0;t.Messages=[];t.Name=k;t.OffsetRow=0;t.SuppressRepetition=true;t.Chart={chartType:"column",vizProperties:{categoryAxis:{axisLine:{size:1,visible:true},title:{visible:true},axisTick:{visible:true},label:{alignment:"center",visible:true}},categoryAxis2:{axisLine:{size:1,visible:true},title:{visible:true},axisTick:{visible:true},label:{alignment:"center",visible:true}},valueAxis2:{size:1,visible:true},legend:{visible:true},title:{visible:true},axisTick:{visible:true},label:{alignment:"center",visible:true},valueAxis:{axisLine:{size:1,visible:true},title:{visible:true},axisTick:{visible:true},label:{alignment:"Right",visible:true}}}};var p=F.ExcelStyle;q.setRequestCellDocumentID(true);t.produceGraph=function(){t.Graph={nodes:[{key:0,title:"Iron Man",group:1,status:"Error",icon:"sap-icon://key-user-settings",attributes:[{label:"Release date",value:"May 2, 2008"},{label:"Director",value:"Jon Favreau"}]},{"key":1,"title":"Iron Man 2","group":1,"status":"Error","icon":"sap-icon://key-user-settings","attributes":[{"label":"Release date","value":"May 7, 2010"},{"label":"Director","value":"Jon Favreau"}]},{"key":2,"title":"The Incredible Hulk","group":1,"icon":"sap-icon://theater","attributes":[{"label":"Release date","value":"June 13, 2008"},{"label":"Director","value":"Louis Leterrier"}]},{"key":3,"title":"Thor","group":1,"status":"Warning","icon":"sap-icon://wrench","attributes":[{"label":"Release date","value":"May 6, 2011"},{"label":"Director","value":"Kenneth Branagh"}]},{"key":4,"title":"Captain America: The First Avenger","group":1,"status":"Success","icon":"sap-icon://unfavorite","attributes":[{"label":"Release date","value":"July 22, 2011"},{"label":"Director","value":"Joe Johnston"}]},{"key":5,"title":"Marvel's The Avengers","group":1,"status":"Error","icon":"sap-icon://text-color","attributes":[{"label":"Release date","value":"May 4, 2012"},{"label":"Director","value":"Joss Whedon"}]},{"key":6,"title":"Iron Man 3","group":2,"status":"Error","icon":"sap-icon://key-user-settings","attributes":[{"label":"Release date","value":"May 3, 2013"},{"label":"Director","value":"Shane Black"}]},{"key":7,"title":"Thor: The Dark World","group":2,"status":"Warning","icon":"sap-icon://wrench","attributes":[{"label":"Release date","value":"November 8, 2013"},{"label":"Director","value":"Alan Taylor"}]},{"key":8,"title":"Captain America: The Winter Soldier","group":2,"status":"Success","icon":"sap-icon://unfavorite","attributes":[{"label":"Release date","value":"April 4, 2014"},{"label":"Director","value":"Anthony & Joe Russo"}]},{"key":9,"title":"Doctor Strange","group":3,"icon":"sap-icon://activate","attributes":[{"label":"Release date","value":"November 4, 2016"},{"label":"Director","value":"Scott Derrickson"}]},{"key":10,"title":"Avengers: Age of Ultron","group":2,"status":"Error","icon":"sap-icon://text-color","attributes":[{"label":"Release date","value":"May 1, 2015"},{"label":"Director","value":"Joss Whedon"}]},{"key":11,"title":"Ant-Man and the Wasp","group":3,"icon":"sap-icon://chain-link","attributes":[{"label":"Release date","value":"July 6, 2018"},{"label":"Director","value":"Peyton Reed"}]},{"key":12,"title":"Thor: Ragnarok","group":3,"status":"Warning","icon":"sap-icon://wrench","attributes":[{"label":"Release date","value":"November 3, 2017"},{"label":"Director","value":"Taika Waititi"}]},{"key":13,"title":"Ant-Man","group":2,"icon":"sap-icon://chain-link","attributes":[{"label":"Release date","value":"July 17, 2015"},{"label":"Director","value":"Peyton Reed"}]},{"key":14,"title":"Captain America: Civil War","group":3,"status":"Success","icon":"sap-icon://unfavorite","attributes":[{"label":"Release date","value":"May 6, 2016"},{"label":"Director","value":"Anthony & Joe Russo"}]},{"key":15,"title":"Guardians of the Galaxy","group":2,"icon":"sap-icon://shield","attributes":[{"label":"Release date","value":"August 1, 2014"},{"label":"Director","value":"James Gunn"}]},{"key":16,"title":"Spider-Man: Homecoming","group":3,"icon":"sap-icon://tree","attributes":[{"label":"Release date","value":"July 7, 2017"},{"label":"Director","value":"Jon Watts"}]},{"key":17,"title":"Black Panther","group":3,"icon":"sap-icon://circle-task-2","attributes":[{"label":"Release date","value":"February 16, 2018"},{"label":"Director","value":"Ryan Coogler"}]},{"key":18,"title":"Guardians of the Galaxy Vol. 2","icon":"sap-icon://shield","group":3,"attributes":[{"label":"Release date","value":"May 5, 2017"},{"label":"Director","value":"James Gunn"}]},{"key":19,"title":"'Avengers 4'","group":3,"status":"Error","icon":"sap-icon://text-color","attributes":[{"label":"Release date","value":"May 3, 2019"},{"label":"Director","value":"Anthony & Joe Russo"}]},{"key":20,"title":"Avengers: Infinity War","group":3,"status":"Error","icon":"sap-icon://text-color","attributes":[{"label":"Release date","value":"April 27, 2018"},{"label":"Director","value":"Anthony & Joe Russo"}]}],lines:[{"from":0,"to":1},{"from":1,"to":5},{"from":2,"to":5},{"from":3,"to":5},{"from":4,"to":5},{"from":5,"to":6},{"from":5,"to":7},{"from":5,"to":8},{"from":6,"to":10},{"from":7,"to":10},{"from":8,"to":10},{"from":9,"to":12},{"from":10,"to":12},{"from":10,"to":13},{"from":13,"to":11},{"from":10,"to":14},{"from":13,"to":14},{"from":14,"to":16},{"from":14,"to":17},{"from":12,"to":20},{"from":16,"to":20},{"from":17,"to":20},{"from":15,"to":18},{"from":18,"to":20},{"from":5,"to":19},{"from":10,"to":19},{"from":20,"to":19}]};O.checkUpdate();};t.setFormat=function(s){p=s;if(t.Grid){t.Grid.format=p;}O.checkUpdate();};t.setOffsetCol=function(n){t.virtualOffsetCol=n;return t;};t.setOffsetRow=function(n){t.virtualOffsetRow=n;return t;};var w;t.getStructureMembers=function(s){var o=q.getQueryModel().getDimensionByName(t.Dimensions[s].TechName);var K=o.getDisplayKeyField();var b=_.reduce(t.getFilterOfDim(s),function(i,M){i[M.Low]=true;return i;},{});return _.map(d.arrayFromList(o.getAllStructureMembers()),function(M){return{Name:M.getFieldValue(K)?M.getFieldValue(K).getValue().getString():M.getName(),TechName:M.getName(),Description:M.getText(),isInFilter:!!b[M.getName()]};});};function x(b){w=q.getQueryModel().getCurrencyTranslationManager()&&q.getQueryModel().getCurrencyTranslationManager().getCurrencyTranslationDetails();t.AllowsNewLines=false;t.Functions=[];t.HasVariables=false;t.CurrencyTranslation=w&&{Name:w.getCurrencyTranslationName(),Target:w.getCurrencyTranslationTarget()};if(t.Grid){t.Grid.inputEnabled=_.some(t.Grid.Cells,function(o){return o.Input;});t.Grid.input=t.Grid.inputEnabled&&I;t.Grid.DataChanged=O.getPlanningService()?O.getPlanningService().getPlanningContext().hasChangedData():false;if(sap.ushell&&sap.ushell.Container&&O.getPlanningService()){sap.ushell.Container.setDirtyFlag(O.getPlanningService().getPlanningContext().hasChangedData());}}u(j.getUndoManager().getAvailableUndoStepCount()>0);t.QueryTitle=q.getQueryModel().getText()||q.getQueryModel().getDataSource().getName();t.QueryName=q.getQueryModel().getDataSource().getName();t.QueryType=q.getQueryModel().getDataSource().getType().getName();t.SystemName=q.getSystemDescription().getName();t.HasVariables=q.getQueryModel().getVariableContainer().hasVariables();V=_.reduce(d.arrayFromIter(q.getQueryModel().getVariables().getIterator()),function(G,o){G[o.getNameExternal()||o.getName()]=o.getName();return G;},V);if(q.getQueryModel().getCubeInfo()){t.CreatedBy=q.getQueryModel().getCubeInfo().getCreatedBy();t.CreatedOn=(function(){var o=q.getQueryModel().getCubeInfo().getCreatedOn();return o?new Date([o.getYear(),o.getMonthOfYear(),o.getDayOfMonth()].join("-")):new Date();}());t.CreatedOnText=t.QueryDueDateText=sap.ui.core.format.DateFormat.getDateInstance({style:"medium"}).format(t.CreatedOn);t.QueryDueDate=(function(){var o=q.getQueryModel().getCubeInfo().getDueDate();return o?new Date([o.getYear(),o.getMonthOfYear(),o.getDayOfMonth()].join("-")):new Date();}());t.QueryDueDateText=sap.ui.core.format.DateFormat.getDateInstance({style:"medium"}).format(t.QueryDueDate);if(q.getQueryModel().getResultAlignment()){t.ResultAlignmentRows=q.getQueryModel().getResultAlignment().getName();t.ResultAlignmentColumns=q.getQueryModel().getResultAlignment().getName();}t.LastUpdated=(function(){var o=q.getQueryModel().getCubeInfo().getUpdatedOn();return o?new Date([o.getYear(),o.getMonthOfYear(),o.getDayOfMonth()].join("-")):new Date();}());t.LastUpdatedBy=q.getQueryModel().getCubeInfo().getUpdatedBy();t.LastUpdatedText=sap.ui.core.format.DateFormat.getDateInstance({style:"medium"}).format(t.LastUpdated);}t.HasCurrencyTranslation=(function(){var o=q.getQueryModel().getModelCapabilities();return(o.supportsCurrencyTranslation()||o.supportsQueryCurrencyTranslation())&&w&&q.getQueryModel().getCurrencyTranslationEnabledType()!=="NoCurrency";}());Q=q.getQueryModel();var s=Q.getSortingManager();function i(o){if(s.supportsDimensionSorting(o,null)){return o.getResultSetSorting().getDirection().getName();}else{return null;}}t.Dimensions=_.reduce(d.arrayFromList(Q.getDimensions()),function(G,o){var H=o.getAxis();if(o.getDimensionType().getName()===D.MeasureStructure){o.getExternalName=_.constant("MeasureStructure");}else if(o.getDimensionType().getName()===D.SecondaryStructure){o.getExternalName=_.constant("NonMeasureStructure");}G[o.getExternalName()||o.getName()]={Name:o.getExternalName()||o.getName(),TechName:o.getName(),Description:o.getText(),Axis:H.getName(),Type:o.getDimensionType().getName(),HierarchyActive:o.isHierarchyActive(),HasFilter:!!o.getFilter(),SortDirection:i(o),Position:H.getDimensionIndex(o.getName()),LastPosition:H.getDimensionCount()-1,IsStructure:o.getDimensionType().getName()===D.MeasureStructure||o.getDimensionType().getName()===D.SecondaryStructure,IsMeasureStructure:o.getDimensionType().getName()===D.MeasureStructure||o.getDimensionType().getName()===D.SecondaryStructure};if(o.getDimensionType().getName()===D.MeasureStructure||o.getDimensionType().getName()===D.SecondaryStructure){var K=o.getDisplayKeyField();G[o.getExternalName()||o.getName()].Members=_.map(d.arrayFromList(o.getAllStructureMembers()),function(J){return{Name:J.getFieldValue(o.getDisplayKeyField())?J.getFieldValue(K).getValue().getString():J.getName(),TechName:J.getName(),Description:J.getText()};});}return G;},{});t.FreeDimensions=_.sortBy(_.filter(t.Dimensions,{Axis:A.Free}),"Description");t.ColumnsDimensions=_.sortBy(_.filter(t.Dimensions,{Axis:A.Columns}),"Position");t.RowsDimensions=_.sortBy(_.filter(t.Dimensions,{Axis:A.Rows}),"Postion");t.FlatDimensions=_.filter(_.concat(t.RowsDimensions,t.ColumnsDimensions),function(o){return!o.IsMeasureStructure;});t.AllDimensions=_.sortBy(_.concat(t.RowsDimensions,t.ColumnsDimensions,t.FreeDimensions),"Description");if(!t.Chart.catDimension){t.Chart.catDimension=t.FlatDimensions.length?t.FlatDimensions[0].Name:null;}if(!t.Chart.cat2Dimension){t.Chart.cat2Dimension=t.FlatDimensions.length>1?t.FlatDimensions[1].Name:null;}var n=q.getQueryModel().getMeasureDimension().getExternalName()||q.getQueryModel().getMeasureDimension().getName();var M=q.getQueryModel().getMeasureDimension()?t.Dimensions[n]:null;if(!t.Chart.valDimension&&M){t.Chart.valDimension=M.Name;}if(!t.Chart.val2Dimension&&M){t.Chart.val2Dimension=M.Name;}t.Chart.vizProperties.title.text=t.QueryTitle||t.QueryName;var E=q.getQueryModel().getMeasureDimension()&&M.Members||[];if(b){t.FlatResultSet=b.FlatResultSet;t.Chart.Measures=b.Measures;t.Chart.Dimensions=b.Dimensions;}else{t.Measures=E;}t.Conditions=_.map(q.getQueryModel().getConditionManager()?d.arrayFromList(q.getQueryModel().getConditionManager()):[],function(o){return{Name:o.getName(),Description:o.getText(),StatusText:e.getText(o.isActive()?"ACTIVE":"INACTIVE"),active:o.isActive()};});t.Exceptions=_.map(q.getQueryModel().getExceptionManager()?d.arrayFromList(q.getQueryModel().getExceptionManager()):[],function(o){return{Name:o.getName(),Description:o.getText(),StatusText:e.getText(o.isActive()?"ACTIVE":"INACTIVE"),active:o.isActive()};});(function(o){t.Chart.Feeds=o.Feeds;t.Chart.Messages=o.Messages;}(R.calculateFeeds(t.Chart.chartType,t.Chart.Dimensions||[],t.Chart.Measures||[],t.Chart)));}x();t.getInfoProviderName=function(){var i=q.getQueryModel().getInfoProvider();return i?i.getName():"";};t.getInfoProviderText=function(){var i=q.getQueryModel().getInfoProvider();return i?i.getText():"";};t.variablePrompt=function(s){var b,i;function n(o,E){b=o;i=E;}sap.firefly.VdDragonflyEntryPoint.createEntryPoint(s||t.QueryTitle,q.getOlapEnv().getVariableProcessor(),{onRenderDone:_.constant(null),onBeforeSubmit:_.constant(null),onOk:function(){var E=d.arrayFromList(q.getOlapEnv().getAllAreaQueryManager());Promise.all(_.map(E,function(o){return S.syncActionToPromise(o.processQueryExecution,o,[]);})).then(function(){b(null);}).catch(function(o){i(o);});},onCancel:function(){b(null);}}).open();return new Promise(n);};t.setInputEnabled=function(b){q.getPlanningManager().setDataEntryEnabled(b);I=b;return t;};(function(){var s=null;t.suppressUnit=function(b){s=b;};t.getSuppressedUnit=function(){return s;};}());t.openAxisDialog=function(){var o=sap.firefly.AldEntryPoint.createEntryPoint(j);var b;function i(n){b=n;}o.openAldDialog(e.getText("QUERY_SETTINGS",[t.QueryTitle]),Q,{onSubmit:function(){b(true);b=null;},onClose:function(){if(b){b(false);}}});return new Promise(i);};t.openCellDialog=function(b,M,i,n){var o=t.Dimensions[b];if(!o||!o.IsStructure){throw new Error("Dimension is not a structure:"+b);}var E=q.getQueryModel().getDimensionByName(o.TechName).getDisplayKeyField();var G=_.find(d.arrayFromList(q.getQueryModel().getDimensionByName(t.Dimensions[b].TechName).getAllStructureMembers()),function(o){var Y=o.getFieldValue(E);var s=Y?Y.getString():o.getName();return s===M;});if(!G){throw new Error("Member "+M+" not found in structure: "+b);}var H;if(i){var J=t.Dimensions[i];if(!J||!J.IsStructure){throw new Error("Dimension is not a structure:"+i);}var K=q.getQueryModel().getDimensionByName(t.Dimensions[i].TechName).getDisplayKeyField();H=_.find(d.arrayFromList(q.getQueryModel().getDimensionByName(t.Dimensions[i].TechName).getAllStructureMembers()),function(o){var Y=o.getFieldValue(K);var s=Y?Y.getString():o.getName();return s===n;});if(!H){throw new Error("Member "+n+" not found in structure: "+i);}}var N;function P(s){N=s;}var W=new Promise(P);var X=sap.firefly.DataCellDialogDragonflyEntryPoint.createEntryPoint(q);X.setI18nProvider(e,null);X.openDataCellPropertiesDialog({onDataCellOk:function(){var s=N;N=null;return s(true);},onDataCellClose:function(){if(N){N(false);}X.close();}},q,G.getName(),H?H.getName():null);return W;};t.openDimDialog=function(s){var E=sap.firefly.DdEntryPoint.createEntryPoint(j);var o=q.getQueryModel().getDimensionByName(t.Dimensions[s].TechName);var b;E.setI18nProvider({getText:function(n){return e.getText(n.substr(5));},getTextWithPlaceholder:function(n,P){return e.getText(n.substr(5),P);}},null);function i(n){b=n;}E.openDimensionDialog(e.getText("DD_DIMENSION_SETTINGS",[o.getText()]),o,{onSubmit:function(){b(true);},onClose:function(){b(false);}});return new Promise(i);};t.setResultVisibility=function(s,b){Q.getDimensionByName(t.Dimensions[s].TechName).setResultVisibility(sap.firefly.ResultVisibility[b]);return t.getResultSet();};t.setDimensionDisplay=function(s,b){var Q=q.getQueryModel();var i=Q.getDimensionByName(t.Dimensions[s].TechName);var K=i.getDisplayKeyField()||i.getKeyField();var n=i.getTextField();var E=i.getResultSetFields();var G=_.filter(d.arrayFromList(E).map(function(o){return o;}),function(o){return o!==i.getKeyField()&&o!==i.getTextField()&&o!==i.getDisplayKeyField();});E.clear();switch(b){case a.Key:E.add(K);break;case a.Text:E.add(n);break;case a.KeyText:E.add(K);E.add(n);break;case a.TextKey:E.add(n);E.add(K);break;}_.forEach(G,function(o){E.add(o);});return t.getResultSet();};t.isVariableInputEnabled=function(s){var n=V[s];if(!n){return false;}var o=q.getQueryModel().getVariable(n);return!!o&&o.isInputEnabled&&o.isInputEnabled();};t.hasVariableValueHelp=function(s){var o=q.getQueryModel().getVariable(s);return!!o&&o.supportsValueHelp&&o.supportsValueHelp();};function y(b,i,n){if(i!=null&&n!=null){b.addSupplementValue(i.getName(),n);}}function z(o,b,s){var n=o.getKeyField();var E=o.getDisplayKeyField()!==n?o.getDisplayKeyField():null;var G=o.getTextField();b.addSupplementField(E);b.addSupplementField(G);for(var i=0;i<s.size();i++){var H=s.get(i);var J=b.addNewCartesianElement();J.setComparisonOperator(sap.firefly.ComparisonOperator.EQUAL);J.setField(n);var K=J.getLow();K.setValue(sap.firefly.XValueUtil.getValueFromString(H.getKey(),n.getValueType()));y(K,E,H.getDisplayKey());y(K,G,H.getText());}}t.applySelectionToVariable=function(s,b){var i=q.getQueryModel().getVariable(O.getProperty("/variables/"+s+"/TechName"));if(!i||!i.isInputEnabled()){return;}if(i.getVariableType()===sap.firefly.VariableType.DIMENSION_MEMBER_VARIABLE){var o=i.getDimension();var M=i.getMemberFilter();M.clear();z(o,M,b);}else{if(!b.isEmpty()){i.setValueByStringExt(b.get(0).getKey(),true);}}v(q);};t.openVariableSelector=function(s){if(!O.getProperty("/variables/"+s).SupportsValueHelp){throw new Error("No Value help for variable "+s);}if(q.isReinitNeeded()){q.reInitVariablesAfterSubmit(sap.firefly.SyncType.BLOCKING,null,null);}var b=q.getQueryModel().getVariable(O.getProperty("/variables/"+s+"/TechName"));var o=b.getDimension();var i=sap.firefly.FdEntryPoint.createEntryPoint(j,e.getText("SELECTOR",[o.getText()]));var n=i.getConfiguration();n.setAlwaysShowSelectionContainer(true);n.setFunctionalValuesEnabled(true);n.setMultiSelection(b.supportsMultipleValues());n.setDetermineSelectionFromContext(true);i.getUiContext().getLocalization().setExternalLocalization(sap.firefly.OrcaI18nMapping.create(),e);var E;function G(J){E=J;}i.openWithVariable(b,{onFilterDialogOk:function(J){E(J);},onFilterDialogCancel:function(){E(null);}});var H=new Promise(G);return H.then(function(J){if(!J){return false;}return J;});};t.openCurrencyTranslationDialog=function(){var b;function i(n){b=n;}var E=sap.firefly.CtEntryPoint.createEntryPoint(j);E.setI18nProvider(e,null);E.openQCTDialog(e.getText("QCT_CURRENCY_TRANSLATION"),q.getQueryModel().getCurrencyTranslationManager(),{onSubmit:function(){b(true);b=null;},onClose:function(){if(b){b(false);}}});return new Promise(i);};t.getFilterOfDim=function(s){var o=q.getQueryModel().getDimensionByName(t.Dimensions[s].TechName);function b(i){var n=o.getKeyField();var E=o.getDisplayKeyField()!==n?o.getDisplayKeyField():null;var G=o.getTextField();var H=i.getLow();var J=null;if(E!=null){J=H.getSupplementValueString(E.getName());}if(!J&&G){J=H.getSupplementValueString(G.getName());}return J;}return _.map(d.arrayFromList(q.getQueryModel().getFilter().getDynamicFilter().getCartesianListByField(o.getKeyField())),function(i){return{ComparisonOperator:m(i.getComparisonOperator()),Text:b(i),Low:i.getLow().getString(),High:i.getHigh().getString(),IsExcluding:i.getSetSign()===sap.firefly.SetSign.EXCLUDING};});};t.openSelector=function(s){var o=q.getQueryModel().getDimensionByName(t.Dimensions[s].TechName);if(!Q.getFilter().getDynamicFilter().isCartesianProduct()){throw new Error("Filter to complex");}var b;function i(n){b=n;}return Promise.resolve(null).then(function(){var n=sap.firefly.FdEntryPoint.createEntryPoint(j,e.getText("SELECTOR",[o.getText()]));var E=n.getConfiguration();E.setFunctionalValuesEnabled(true);E.setMultiSelection(true);E.setDetermineSelectionFromContext(true);n.getUiContext().getLocalization().setExternalLocalization(sap.firefly.OrcaI18nMapping.create(),e);n.openWithDimension(o,{onFilterDialogOk:function(H){b(H);},onFilterDialogCancel:function(){b(false);}});var G=new Promise(i);return G.then(function(H){if(!H){return false;}var J=o.getFilter();if(J!=null){J.clear();}else{var K=o.getQueryModel().getFilter().getDynamicFilter();J=K.getCartesianListWithDefault(o);}z(o,J,H);return true;});});};t.setAxesLayout=function(o){_.forEach(_.map(t.FlatDimensions,"Name"),function(s){q.getQueryModel().getAxis(sap.firefly.AxisType.FREE).add(q.getQueryModel().getDimensionByName(t.Dimensions[s].TechName));});_.forEach(o.rows,function(s){q.getQueryModel().getAxis(sap.firefly.AxisType.ROWS).add(q.getQueryModel().getDimensionByName(t.Dimensions[s].TechName));});_.forEach(o.columns,function(s){q.getQueryModel().getAxis(sap.firefly.AxisType.COLUMNS).add(q.getQueryModel().getDimensionByName(t.Dimensions[s].TechName));});return t;};t.removeDrilldown=function(s){q.getQueryModel().getAxis(sap.firefly.AxisType.FREE).add(q.getQueryModel().getDimensionByName(t.Dimensions[s].TechName));return t.getResultSet();};t.drilldown=function(s,b){var o=q.getQueryModel();if(s){var i=o.getDimensionByName(t.Dimensions[s].TechName);var n=o.getAxesManager().getRowsAxis().getDimensionCount()?i.getAxis():o.getAxesManager().getRowsAxis();var E=!n.getDimensionCount()?0:i.getDimension().getAxis().getDimensionIndex(i.getName())+1;n.insert(E,o.getDimensionByName(t.Dimensions[b].TechName));}else{o.getAxesManager().getRowsAxis().insert(o.getAxesManager().getRowsAxis().getDimensionCount(),o.getDimensionByName(t.Dimensions[b].TechName));}return t.getResultSet();};t.moveUp=function(s){var o=q.getQueryModel();var b=o.getDimensionByName(t.Dimensions[s].TechName);var i=b.getAxis();var n=i.getDimensionIndex(b.getName())-1;i.insert(n,b);return t;};t.moveDown=function(s){var o=q.getQueryModel();var b=o.getDimensionByName(t.Dimensions[s].TechName);var i=b.getAxis();var n=i.getDimensionIndex(b.getName())+1;i.insert(n,b);return t;};t.setDisplayHierarchy=function(s,b,n,i){var o=q.getQueryModel();var E=o.getDimensionByName(t.Dimensions[s].TechName);if(n){E.setHierarchyName(n);if(i){E.setHierarchyVersion(i);}}E.setHierarchyActive(b);return t;};t.getScalingFactor=function(M,n){var b=t.Dimensions.MeasureStructure;if(!b){throw new Error("No measure Structure");}var N=n?t.Dimensions.NonMeasureStructure:null;var i=b.TechName;var E=d.arrayFromList(q.getQueryModel().getDimensionByName(i).getAllStructureMembers());var G=q.getQueryModel().getDimensionByName(i).getDisplayKeyField();var H=(function(){var Z=_.find(E,function(o){var $=o.getFieldValue(G);var s=$?$.getString():o.getName();return s===M;});if(!Z){throw new Error("Member "+M+" not found in structure: "+i);}return Z;}());if(!N){return H.getNumericShift()?-1*H.getNumericShift().getInteger():0;}else{var J=N.TechName;var K=d.arrayFromList(q.getQueryModel().getDimensionByName(J).getAllStructureMembers());var P=q.getQueryModel().getDimensionByName(J).getDisplayKeyField();var W=(function(){var Z=_.find(K,function(o){var $=o.getFieldValue(P);var s=$?$.getString():o.getName();return s===n;});if(!Z){throw new Error("Member "+M+" not found in structure: "+i);}return Z;}());var X=d.arrayFromIter(q.getQueryModel().getQueryDataCells().getIterator());var Y=_.find(X,function(o){return o.hasMemberReference(H)&&o.hasMemberReference(W);});if(!Y){throw new Error("Invalid Query Cell");}return Y.getScalingFactor();}};t.setScalingFactor=function(n,M,N){var b=t.Dimensions.MeasureStructure;if(!b){throw new Error("No measure Structure");}var i=N?t.Dimensions.NonMeasureStructure:null;var E=b.TechName;var G=d.arrayFromList(q.getQueryModel().getDimensionByName(E).getAllStructureMembers());var H=q.getQueryModel().getDimensionByName(E).getDisplayKeyField();var J=(function(){var Y=_.find(G,function(o){var Z=o.getFieldValue(H);var s=Z?Z.getString():o.getName();return s===M;});if(!Y){throw new Error("Member "+M+" not found in structure: "+E);}return Y;}());if(!i){J.setNumericShift(-1*n);return t;}else{var K=i.TechName;var P=d.arrayFromList(q.getQueryModel().getDimensionByName(K).getAllStructureMembers());H=q.getQueryModel().getDimensionByName(K).getDisplayKeyField();var W=(function(){var Y=_.find(P,function(o){var Z=o.getFieldValue(H);var s=Z?Z.getString():o.getName();return s===N;});if(!Y){throw new Error("Member "+N+" not found in structure: "+K);}return Y;}());var X=d.arrayFromIter(q.getQueryModel().getQueryDataCells().getIterator());X=_.filter(X,function(o){return o.hasMemberReference(J)&&o.hasMemberReference(W);});if(!X||X.length<1){throw new Error("Invalid Query Cell");}return _.forEach(X,function(o){o.setScalingFactor(n);});}};t.setDecimalPlaces=function(n,M,N){var b=t.Dimensions.MeasureStructure;if(!b){throw new Error("No measure Structure");}var i=N?t.Dimensions.NonMeasureStructure:null;var E=b.TechName;var G=d.arrayFromList(q.getQueryModel().getDimensionByName(E).getAllStructureMembers());var H=q.getQueryModel().getDimensionByName(E).getDisplayKeyField();var J=(function(){var Y=_.find(G,function(o){var Z=o.getFieldValue(H);var s=Z?Z.getString():o.getName();return s===M;});if(!Y){throw new Error("Member "+M+" not found in structure: "+E);}return Y;}());if(!i){J.setNumericScale(n);return t;}else{var K=i.TechName;var P=d.arrayFromList(q.getQueryModel().getDimensionByName(K).getAllStructureMembers());H=q.getQueryModel().getDimensionByName(K).getDisplayKeyField();var W=(function(){var Y=_.find(P,function(o){var Z=o.getFieldValue(H);var s=Z?Z.getString():o.getName();return s===N;});if(!Y){throw new Error("Member "+N+" not found in structure: "+K);}return Y;}());var X=d.arrayFromIter(q.getQueryModel().getQueryDataCells().getIterator());X=_.filter(X,function(o){return o.hasMemberReference(J)&&o.hasMemberReference(W);});if(!X||X.length<1){throw new Error("Invalid Query Cell");}return _.forEach(X,function(o){o.setDecimalPlaces(n);});}};t.getDecimalPlaces=function(M,n){var b=t.Dimensions.MeasureStructure;if(!b){throw new Error("No measure Structure");}var N=n?t.Dimensions.NonMeasureStructure:null;var i=b.TechName;var E=d.arrayFromList(q.getQueryModel().getDimensionByName(i).getAllStructureMembers());var G=q.getQueryModel().getDimensionByName(i).getDisplayKeyField();var H=(function(){var Z=_.find(E,function(o){var $=o.getFieldValue(G);var s=$?$.getString():o.getName();return s===M;});if(!Z){throw new Error("Member "+M+" not found in measureDim: "+i);}return Z;}());if(!N){return H.getNumericScale();}else{var J=N.TechName;var K=d.arrayFromList(q.getQueryModel().getDimensionByName(J).getAllStructureMembers());var P=q.getQueryModel().getDimensionByName(J).getDisplayKeyField();var W=(function(){var Z=_.find(K,function(o){var $=o.getFieldValue(P);var s=$?$.getString():o.getName();return s===n;});if(!Z){throw new Error("Member "+n+" not found in measureDim: "+J);}return Z;}());var X=d.arrayFromIter(q.getQueryModel().getQueryDataCells().getIterator());var Y=_.find(X,function(o){return o.hasMemberReference(H)&&o.hasMemberReference(W);});if(!Y){throw new Error("Invalid Query Cell");}return Y.getDecimalPlaces();}};t.setFilter=function(b,i){var n=t.Dimensions[b];var M=[];if(typeof i==="string"){M.push(i);}else{M=i;}sap.firefly.QFilterUtil.clearSelectionsInContainerByDimension(t.Dimensions[b].TechName,q.getQueryModel().getFilter().getDynamicFilter());var E=t.Dimensions[b].TechName;var G=q.getQueryModel().getDimensionByName(E);var H=n.IsStructure?d.arrayFromList(G.getAllStructureMembers()):[];var J=n.IsStructure?G.getDisplayKeyField():null;_.forEach(M,function(K){var s=n.IsStructure?(function(){var N=_.find(H,function(o){var P=o.getFieldValue(J);var s=P?P.getString():o.getName();return s===K;});if(!N){throw new Error("Member "+K+" not found in structure: "+E);}return N.getName();}()):K;q.getQueryModel().getFilter().getDynamicFilter().addSingleMemberFilterByName(E,s,sap.firefly.ComparisonOperator.EQUAL);});return t;};t.removeFilter=function(s){sap.firefly.QFilterUtil.clearSelectionsInContainerByDimension(t.Dimensions[s].TechName,q.getQueryModel().getFilter().getDynamicFilter());return t;};t.filterAndDrillDown=function(b,M,i){var n=q.getQueryModel();var E=t.Dimensions[b];var s=E.IsStructure?_.find(E.Members,function(o){return o.Name===M;}).TechName:M;n.getFilter().getDynamicFilter().addSingleMemberFilterByName(t.Dimensions[b].TechName,s,sap.firefly.ComparisonOperator.EQUAL);var G=n.getDimensionByName(t.Dimensions[b].TechName);G.getAxis().add(n.getDimensionByName(t.Dimensions[i].TechName));n.getAxis(sap.firefly.AxisType.FREE).add(G);return t;};t.sort=function(s,b,i,M){var o=q.getQueryModel().getDimensionByName(t.Dimensions[s].TechName);if(t.Dimensions[s].IsStructure){var n=q.getConvenienceCommands();n.clearSort(null,null);n.sortByMeasure(_.find(t.Dimensions[s].Members,function(E){return E.Name===M;}).TechName,sap.firefly.XSortDirection[b]);}else{o.getResultSetSorting().setDirection(sap.firefly.XSortDirection[b]);if(i){o.getResultSetSorting().setSortType(sap.firefly.SortType[i]);}}return t;};t.toRows=function(s){var o=q.getQueryModel();o.getAxis(sap.firefly.AxisType.ROWS).add(o.getQueryModel().getDimensionByName(t.Dimensions[s].TechName));return t;};t.toColumns=function(s){var o=q.getQueryModel();o.getAxis(sap.firefly.AxisType.COLUMNS).add(o.getQueryModel().getDimensionByName(t.Dimensions[s].TechName));return t;};t.drill=function(s,n,K){var o=q.getQueryModel().getDimensionByName(t.Dimensions[s].TechName);var b=r.getAxis(o.getAxisType()).getTupleAt(n).getTupleElementByDimension(o);b.setNextDrillState(b.getDrillState()!==sap.firefly.DrillState.COLLAPSED?sap.firefly.DrillState.COLLAPSED:sap.firefly.DrillState.EXPANDED);return t.getResultSet(K);};t.exchange=function(s,b){var o=q.getQueryModel();var i=o.getDimensionByName(t.Dimensions[s].TechName);var n=o.getDimensionByName(t.Dimensions[b].TechName);var E=n.getAxis();i.getAxis().insert(i.getDimension().getAxis().getDimensionIndex(t.Dimensions[s].TechName)+1,n);E.add(i);return t;};t.submitVariables=function(){return S.syncActionToPromise(q.submitVariables,q,[]).then(function(b){x();if(b&&b.getMessages().length){O.addMessages(d.arrayFromList(b.getMessages()).map(function(o){var s=o.getSeverity().getName();if(s==="Info"){s="Information";}return{Text:o.getText(),Severity:s,Code:o.getCode(),MessageClass:o.getMessageClass(),LongTextUri:o.getMessageClass()?["/sap/opu/odata/iwbep/message_text;o=LOCAL/T100_longtexts(MSGID='",encodeURIComponent(o.getMessageClass()),"',MSGNO='",encodeURIComponent(o.getCode()),",',MESSAGE_V1='',MESSAGE_V2='',MESSAGE_V3='',MESSAGE_V4='')/$value"].join(""):null};}));}v(q);O.checkUpdate();}).catch(function(E){O.addMessages(E.getMessages?E.getMessages():[]);if(!E.getMessages){throw E;}t.Grid=null;O.checkUpdate();});};var B;t.setPlanValue=function(n,s){var o=t.Grid.Cells[n];var b=q.getCursorResultSet().getDataCell(o.DataColumn,o.DataRow);b.setNewValueExternal(s);if(b.getValueException()!==sap.firefly.ValueException.NULL_VALUE){o.DisplayValue=b.getString();if(s===o.DisplayValue){o.valueState="Success";}else{o.valueState="Warning";}}else{o.DisplayValue=s;o.valueState="Success";}O.checkUpdate();return t;};t.transferValue=function(){q.transferNewValues();return t;};t.getResultSet=function(K){if(!K){t.setOffsetCol(0);t.setOffsetRow(0);}if(B){j.getSession().notifyInterruptStep(B,false);}if(q.hasChangedCells()){q.transferNewValues();}q.setOffsetColumns(t.virtualOffsetCol);q.setOffsetRows(t.virtualOffsetRow);q.setMaxRows(O.getLimit().rowLimit);q.setMaxColumns(O.getLimit().colLimit);O.fireRequestSent({infoObject:t.Name});return S.syncActionToPromise(q.processQueryExecution,q,[]).then(function(b){B=sap.firefly.XInterruptStep.create();j.getSession().notifyInterruptStep(B,true);r=b.getClassicResultSet();var i=(function(){var o=sap.firefly.FioriGridFactory.createFioriGrid(r);if(t.getSuppressedUnit()){o.setSuppressUnit(t.getSuppressedUnit());}_.map(O.getSemanticStyles(),function(s,M){o.addSemanticStyle(M,s);});return o.exportToFireflyGrid(t.SuppressRepetition);}());t.Grid=i.convertToNative();t.Grid.format=p;t.Grid.virtualOffsetCol=t.virtualOffsetCol;t.Grid.virtualOffsetRow=t.virtualOffsetRow;if(!t.Grid.Cells||t.Grid.Cells.length===0){t.Grid.Cells=[{Column:0,Row:0,DisplayValue:e.getText("no_data"),CellType:C.EMPTY}];}t.Grid.fixedRows=i.getIntegerByKey("FixedRows");t.Grid.fixedColumns=i.getIntegerByKey("FixedColumns");var n=r.getAxis(sap.firefly.AxisType.ROWS).getTuplesCountTotal();if(n===-1){n=r.getAxis(sap.firefly.AxisType.ROWS).getTuplesCount();}t.Grid.virtualRows=n;n=r.getAxis(sap.firefly.AxisType.COLUMNS).getTuplesCountTotal();if(n===-1){n=r.getAxis(sap.firefly.AxisType.COLUMNS).getTuplesCount();}t.Grid.virtualColumns=n;x(R.flatten(r,t));if(r.getMessages().length){O.addMessages(d.arrayFromList(r.getMessages()).map(function(o){var s=o.getSeverity().getName();if(s==="Info"){s="Information";}return{Text:o.getText(),Severity:s,Code:o.getCode(),MessageClass:o.getMessageClass(),LongTextUri:o.getMessageClass()?["/sap/opu/odata/iwbep/message_text;o=LOCAL/T100_longtexts(MSGID='",encodeURIComponent(o.getMessageClass()),"',MSGNO='",encodeURIComponent(o.getCode()),",',MESSAGE_V1='',MESSAGE_V2='',MESSAGE_V3='',MESSAGE_V4='')/$value"].join(""):null};}));}O.checkUpdate();O.fireRequestCompleted({infoObject:t.Name});return t;}).catch(function(E){O.addMessages(E.getMessages?E.getMessages():[]);if(!E.getMessages){throw E;}O.checkUpdate(true);O.fireRequestFailed({});return t;});};t.getRRITargets=function(n,b){var i=q.getRriTargetManager();if(!i){return Promise.resolve([]);}i.setResultSetContext(n,b);var s,E;function G(o,H){s=o;E=H;}i.processRriTargetResolution(sap.firefly.SyncType.NON_BLOCKING,{onRriTargetResolution:function(H){if(H.hasErrors()){E(H.getMessages());}else{var J=sap.ushell?sap.ushell.Container.getService("URLParsing"):{isIntentUrl:_.constant(false)};s(_.filter(H.getData().getListFromImplementation().map(function(o){return o.getParameters().getMapFromImplementation();}),function(o){return J.isIntentUrl(o.URL)||!!o.URL.match(/#/);}).map(function(o){o.URL=o.URL.split("#")[1];return o;}));}}});return new Promise(G);};t.refreshLeaveMsg=function(){return t.getResultSet(false);};t.synchronize=function(K){O.clearMessages();return t.getResultSet(K);};t.getColumnSelection=function(n){return R.tupleToObject(r.getColumnsAxis().getTupleAt(n));};t.getRowSelection=function(n){return R.tupleToObject(r.getRowsAxis().getTupleAt(n));};t.getSelection=function(n,b){return _.assign(n>=0&&n<r.getRowsAxis().getTuplesCount()?R.tupleToObject(r.getRowsAxis().getTupleAt(n)):{},b>=0&&b<r.getColumnsAxis().getTuplesCount()?R.tupleToObject(r.getColumnsAxis().getTupleAt(b)):{});};t.setSuppressRepetition=function(b){t.SuppressRepetition=b;};t.getMemberCatalog=function(s,b){var i,n;function o(J,M){i=J;n=M;}var E=q.getQueryModel().getDimensionByName(t.Dimensions[s].TechName);var G=E.getDisplayKeyField()||E.getKeyField();var H=E.getTextField()||E.getDisplayKeyField();var K=E.getKeyField();E.clearSelectorFilter();E.getSelectorFields().clear();E.getSelectorFields().add(E.getKeyField());E.getSelectorFields().add(E.getDisplayKeyField());E.getSelectorFields().add(E.getTextField()||E.getDisplayKeyField());E.setSelectorFilterOnDisplayKey(true);if(b){E.addSelectorFilterForKey(b,sap.firefly.ComparisonOperator.MATCH);E.addSelectorFilterForText(b,sap.firefly.ComparisonOperator.MATCH);}var P=new Promise(o);E.processValueHelpResultSet(sap.firefly.SyncType.NON_BLOCKING,{onValuehelpExecuted:function(J){return J.hasErrors()?n(S.reject(J)):i(J.getData());}},null);return P.then(function(J){var M=J.getClassicResultSet().getRowsAxis();var N=_.range(M.getTuplesCount()).map(function(W){var X=M.getTupleAt(W);return{key:X.getStringByField(K),displayKey:X.getStringByField(G)||X.getStringByField(K),description:X.getStringByField(H)||X.getStringByField(G)||X.getStringByField(K)};});return{catalog:N};});};t.readHierarchy=function(s,n){var b,i;function o(J,K){b=J;i=K;}var H=q.getValueHelpProvider();var E=q.getQueryModel().getDimensionByName(t.Dimensions[s].TechName);var G=E.getInitialDrillLevel();E.setSelectorInitialDrillLevel(n);var P=new Promise(o);H.processValueHelp(E,sap.firefly.SyncType.NON_BLOCKING,{onValuehelpExecuted:function(J){return J.hasErrors()?i(S.reject(J.getErrors())):b(J.getData());}},null,null);return P.then(function(J){function K(N){if(!N){return{};}var W=N.getChildren();return{Name:N.getName(),Text:N.getDimensionMember().getText()||N.getDimensionMember(N.getDimension().getHierarchyDisplayKeyField()).getValue().getString(),hierNodes:W?_.map(W.getListFromImplementation(),K):null};}E.setSelectorInitialDrillLevel(G);var M=_.filter(J.getListFromImplementation(),function(N){return!N.getParentNode();});return M.length===1?K(M[0]):{Name:"$Root",Text:e.getText("ARTIFICIAL_ROOT"),hierNodes:_.map(M,K)};});};t.hasVariable=function(s){var n=V[s];if(!n){return false;}var o=q.getQueryModel().getVariable(n);return!!o&&o.isInputEnabled();};t.setVariableValue=function(s,b){var o=q.getQueryModel().getVariable(V[s]);if(!o){return t;}if(!o.isInputEnabled()){throw new Error("Variable not input enabled");}o.clear();if(!b){return t;}var M=o.getMemberFilter?o.getMemberFilter():null;_.forEach(b,function(i){if(M){var n=M.addNewCartesianElement();var E=sap.firefly.XValueAccess.createWithType(o.getValueType());E.parseString(i.Low);n.getLow().setValue(E.getValue());if(i.High){E=sap.firefly.XValueAccess.createWithType(o.getValueType());E.parseString(i.High);n.getHigh().setValue(E.getValue());}n.setComparisonOperator(sap.firefly.ComparisonOperator[i.Comparison]);n.setSetSign(sap.firefly.SetSign[i.IsExcluding?"EXCLUDING":"INCLUDING"]);var K=o.getDimension().getFirstFieldByType(sap.firefly.PresentationType.KEY_NOT_COMPOUND);if(K){n.setField(K);}}else{o.setValueByStringExt(i.Low,true);}});v(q);return t;};t.deserialize=function(s){q.getQueryModel().deserializeExt(sap.firefly.QModelFormat.INA_REPOSITORY,s);};t.serialize=function(){return q.getQueryModel().serializeToContentExt(sap.firefly.QModelFormat.INA_REPOSITORY,null).getString();};t.openCreateFormulaDialog=function(s){return l.then(function(l){return l.Formular.open(O,k,s);});};t.openConditionDialog=function(){return l.then(function(l){return l.Condition;}).then(function(o){return o.open(O,k);});};t.openExceptionDialog=function(){return l.then(function(l){return l.Exception.open(O,k);});};t.openCreateRestrictionDialog=function(s,M){return l.then(function(l){return l.Restriction.open(O,k,s,M);});};t.getResultRequest=function(){return q.getResultsetContainer().getResultSetManager().getDataRequest().convertToNative();};t.getQueryView=function(){return q.getQueryModel().serializeToElement(sap.firefly.QModelFormat.INA_DATA).convertToNative();};t.getMemberDescription=function(s,M){if(t.Dimensions[s].IsStructure){return _.find(t.Dimensions[s].Members,function(o){return o.Name===M;}).Description;}else{var b=_.find(d.arrayFromList(q.getQueryModel().getDimensionByName(s).getAllDimensionMembers()),function(o){return o.getName()===M;});if(!b){L.error("Could not find measure");return"";}return b.getText();}};t.addRestriction=function(o){var b=q.getQueryModel();var i=q.getQueryModel().getMeasureDimension().addNewRestrictedMeasure(["REST_",Date.now()].join("_"),o.Description);var n=i.getFilter();n.addSingleMemberFilterByDimension(q.getQueryModel().getMeasureDimension(),_.find(t.Dimensions[o.Dimension].Members,function(M){return M.Name===o.Keyfigure;}).TechName,sap.firefly.ComparisonOperator.EQUAL);_.forEach(o.Dimensions,function(s){if(s.ConstantSelection){i.addExternalDimensionToIgnore(t.Dimensions[s.Name].TechName);}_.forEach(s.Values,function(E){n.addSingleMemberFilterByDimension(b.getDimensionByName(t.Dimensions[s.Name].TechName,E.Low,sap.firefly.ComparisonOperator[E.ComparisonOperator]),E.Low);});});if(q.getQueryModel().getFilter().getDynamicFilter().getDimensionsUsedInFilter().contains(q.getQueryModel().getMeasureDimension().getName())){q.getQueryModel().getFilter().getDynamicFilter().addSingleMemberFilterByName(q.getQueryModel().getMeasureDimension().getName(),i.getName(),sap.firefly.ComparisonOperator.EQUAL);}return t;};t.addFormula=function(s,b,P,E,i){var M=_.reduce(t.getStructureMembers(s),function(o,n){o[n.Name]=n;return o;},{});return Promise.resolve(null).then(function(){var o=q.getQueryModel().getDimensionByName(t.Dimensions[s].TechName);function n(N){var W=sap.firefly.QFactory.newFormulaConstant(q);W.setString(N.left);return W;}function G(N){var W=sap.firefly.QFactory.newFormulaFunctionWithName(q,N.operator);W.add(H(N.left));W.add(H(N.right));return W;}function H(N){switch(N.operator){case"Variable":return sap.firefly.QFactory.newFormulaMemberWithName(q,M[N.left].TechName);case"Literal":return n(N);case"+":case"-":case"*":case"/":return G(N);default:throw new Error("Invalid operator:"+N.operator);}}var J=["CALC_",Date.now()].join("");var K=o.addNewFormulaMeasure(J,b);if(E&&E!=="DEFAULT"&&i){K.setAggregationType(sap.firefly.AggregationType[E]);K.addExceptionAggregationDimension(q.getQueryModel().getDimensionByName(t.Dimensions[i].TechName));}K.setNumericShift(0);K.setNumericScale(2);K.setNumericPrecision(31);K.setFormula(H(P));if(q.getQueryModel().getFilter().getDynamicFilter().getDimensionsUsedInFilter().contains(s)){q.getQueryModel().getFilter().getDynamicFilter().addSingleMemberFilterByName(t.Dimensions[s].TechName,J,sap.firefly.ComparisonOperator.EQUAL);}return t;});};t.addException=function(o){return Promise.resolve(null).then(function(){var i=["EXC_",Date.now()].join("");var E=q.getQueryModel().getExceptionManager().newException(i,o.Description);var s=q.getQueryModel().getDimensionByName(t.Dimensions[o.Structure1Key].TechName);var M=t.Dimensions[o.Structure1Key].Members[parseInt(o.measure1,10)];E.setMeasure(s.getStructureMember(M.TechName));var b=E.newThreshold(o.Value,sap.firefly.AlertLevel[o.alertLevel]);b.setOperator(sap.firefly.ComparisonOperator[o.operator]);E.addThreshold(b);q.getQueryModel().getExceptionManager().add(E);return t;});};t.addCondition=function(o){return Promise.resolve(null).then(function(){var i=["COND_",Date.now()].join("");var b=q.getQueryModel().getConditionManager().addNewCondition(i);b.setDescription(o.Description);b.setText(o.Description);var s=q.getQueryModel().getDimensionByName(t.Dimensions[o.Structure1Key].TechName);var E=_.find(t.Dimensions[o.Structure1Key].Members,function(M){return o.measure1===M.Name;}).TechName;if(!E){throw new Error("Invalid measure");}b.setDimensionEvaluationType(sap.firefly.ConditionDimensionEvaluationType.ALL_IN_DRILL_DOWN);var n=b.createThreshold();var G=s.getStructureMember(E);if(!G){throw new Error("Invalid measure");}n.addMeasureCoordinate(G);n.setComparisonOperator(sap.firefly.ConditionComparisonOperator[o.operator]);n.getLow().setString(o.Value);return t;});};t.setExceptionActive=function(n,b){q.getQueryModel().getExceptionManager().getByKey(n).setActive(b);return t.getResultSet();};t.setConditionActive=function(n,b){q.getQueryModel().getConditionManager().getByKey(n).setActive(b);return t.getResultSet();};t.blendWithDataProvider=function(s,o){L.info(s);L.info(o);return null;};t.exportToExcel=function(W){var s=_.reduce(_.groupBy(t.Grid.Cells,"Row"),function(o,b){_.reduce(b,function(i,n){var E=new f();E.setFormattedValue(n.DisplayValue);var G;switch(n.CellType){case C.HEADER:G=g.HEADER;break;case C.TITLE:G=g.GROUP;break;default:G=g.STANDARD;}E.setStyle(G);W.setCell(W.addCell(i),E);return i;},W.createRow(o));return o;},W.addWorksheet(t.QueryName));W.closeWorkSheet(s);return t;};t.resetToDefault=function(){q.getConvenienceCommands().resetToDefault();};};h.prototype.hasVariable=function(){};h.prototype.setAxesLayout=function(){};h.prototype.openCellDialog=function(){};h.prototype.openAxisDialog=function(){};h.prototype.openCurrencyTranslationDialog=function(){};h.prototype.openConditionDialog=function(){};h.prototype.openExceptionDialog=function(){};h.prototype.openDimDialog=function(){};h.prototype.openSelector=function(){};h.prototype.setFilter=function(){};h.prototype.removeFilter=function(){};h.prototype.filterAndDrillDown=function(){};h.prototype.sort=function(){};h.prototype.toRows=function(){};h.prototype.toColumns=function(){};h.prototype.drill=function(){};h.prototype.exchange=function(){};h.prototype.submitVariables=function(){};h.prototype.setPlanValue=function(){};h.prototype.transferValue=function(){};h.prototype.getResultSet=function(){};h.prototype.getRRITargets=function(){};h.prototype.setExceptionActive=function(){};h.prototype.addCondition=function(){};h.prototype.moveUp=function(){};h.prototype.moveDown=function(){};h.prototype.setConditionActive=function(){};h.prototype.setDisplayHierarchy=function(){};h.prototype.openCreateFormulaDialog=function(){};h.prototype.openCreateRestrictionDialog=function(){};h.prototype.getFilterOfDim=function(){};h.prototype.synchronize=function(){};h.prototype.setFormat=function(){};h.prototype.getScalingFactor=function(){};h.prototype.setScalingFactor=function(){};h.prototype.getDecimalPlaces=function(){};h.prototype.setDecimalPlaces=function(){};h.prototype.suppressUnit=function(){};h.prototype.applySelectionToVariable=function(){};h.prototype.resetToDefault=function(){};return h;});
