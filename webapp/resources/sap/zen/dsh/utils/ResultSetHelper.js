/*
 * SAPUI5
  (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define("sap/zen/dsh/utils/ResultSetHelper",["sap/base/Log","sap/zen/dsh/ValueType","sap/zen/dsh/utils/ListHelper","sap/zen/dsh/MemberType","sap/zen/dsh/utils/ResourceBundle","sap/zen/commons/thirdparty/lodash"],function(L,V,a,M,R,_){"use strict";L.info("ResultSetHelper loaded");function b(){var t=this;t.dimensionMembersToList=function(D,r){if(!r){return null;}return _.filter(_.map(a.arrayFromIter(r.getAxis(D.getAxisType()).getTuplesIterator()),function(o){var T=o.getTupleElementByDimension(D);var E=T&&T.getDimensionMember();return E?{Name:D.isStructure()&&D.getAllStructureMembers().getByKey(E.getName()).getFieldValue(D.getDisplayKeyField())?D.getAllStructureMembers().getByKey(E.getName()).getFieldValue(D.getDisplayKeyField()).getValue().getString():E.getName(),TechName:E.getName(),Description:E.getText()}:null;}),_.identity);};t.tupleToObject=function(T){return _.reduce(T.getElements().getListFromImplementation(),function(C,E){var n=E.getDimensionMember().getName();C[E.getDimension().getExternalName()||E.getDimension().getName()]=n;return C;},{});};t.flatten=function(r,D){var k={};var o={};var m=(D.Chart.valDimension&&(function(){return r.getQueryModel().getDimensionByName(D.Dimensions[D.Chart.valDimension].TechName);}()))||r.getQueryModel().getMeasureDimension();function j(T){return{tuple:T,member:_.reduce(T.getElements().getListFromImplementation(),function(s,E){var K=E.getDimensionMember().getDimension().getKeyField();var u=E.getDimensionMember().getDimension().getDisplayKeyField()||K;var x=E.getDimensionMember().getDimension().getTextField()||u;if(E.getDimension()!=m){if(s&&E.getDimensionMember().getMemberType().getName()==M.Member){var y=E.getDimension().getExternalName()||E.getDimension().getName();o[y]={Name:y,Description:E.getDimensionMember().getFieldValue(x).getString()};s[y]=E.getDimensionMember().getFieldValue(x).getString();return s;}else{return s;}}else{if(E.getDimension().isStructure()){var z=E.getDimensionMember().getKeyFieldValue();if(z){var S=E.getDimension().getStructureMemberByKey(z.getString()).getFieldValue(u)||E.getDimension().getStructureMemberByKey(z.getString()).getFieldValue(K);if(S){T.kyf=S.getString();}else{L.error("Structure member has no string represenation");}}else{L.error("Structure member has no string represenation");}}else{T.kyf=E.getDimensionMember().getFieldValue(u).getString();}k[T.kyf]={Name:T.kyf,Description:E.getDimensionMember().getFieldValue(x)?E.getDimensionMember().getFieldValue(x).getString():T.kyf};return s;}},{})};}function n(A){return _.map(a.arrayFromIter(A.getTuplesIterator()),j);}var C=_.filter(n(r.getColumnsAxis()),"member");var q=_.filter(n(r.getRowsAxis()),"member");var F=q.length>0?_.flatten(_.map(q,function(s){return _.map(C,function(u){var x=_.assign(_.clone(s.member),u.member);var y=r.getDataCellByTuples(u.tuple,s.tuple);if(y){if(y.getDataCell()){if(m){var E=y.getDataCell().getReferenceStructureElement1();var z=y.getDataCell().getReferenceStructureElement2();var A=(E?(E.getFieldValue(E.getDimension().getDisplayKeyField())?E.getFieldValue(E.getDimension().getDisplayKeyField()).getString():E.getName()):null);var B=(z?(z.getFieldValue(z.getDimension().getDisplayKeyField())?z.getFieldValue(z.getDimension().getDisplayKeyField()).getString():z.getName()):null);x[A||B]=!(y.getValueException()===sap.firefly.ValueException.NULL_VALUE||y.getValueException()===sap.firefly.ValueException.UNDEFINED)?y.getValue():0;}}else if((s.tuple&&s.tuple.kyf)||(u.tuple.kyf&&u.tuple.kyf)){x[(s.tuple&&s.tuple.kyf)||(u.tuple.kyf&&u.tuple.kyf)]=!(y.getValueException()===sap.firefly.ValueException.NULL_VALUE||y.getValueException()===sap.firefly.ValueException.UNDEFINED)?y.getValue():0;}}return x;});})):(C.length>0?_.map(C,function(s){var u=_.clone(s.member);var x=r.getDataCell(s.tuple.getAxisIndex(),0);if(x){if(x.getDataCell()){if(m){var E=x.getDataCell().getReferenceStructureElement1();var y=x.getDataCell().getReferenceStructureElement2();var z=(E?(E.getFieldValue(E.getDimension().getDisplayKeyField())?E.getFieldValue(E.getDimension().getDisplayKeyField()).getString():E.getName()):null);var A=(y?(y.getFieldValue(y.getDimension().getDisplayKeyField())?y.getFieldValue(y.getDimension().getDisplayKeyField()).getString():y.getName()):null);u[z||A]=x.getValueException()!==sap.firefly.ValueException.NULL_VALUE?x.getValue():0;}}else if((s.tuple.kyf&&s.tuple.kyf)){u[(s.tuple.kyf&&s.tuple.kyf)]=x.getValueException()!==sap.firefly.ValueException.NULL_VALUE?x.getValue():0;}}return u;}):[]);return{FlatResultSet:F,Measures:_.map(k,_.identity),Dimensions:_.map(o,_.identity)};};function c(D,m,C){if(D.length<1||m.length<1){return{Messages:[{msgText:R.getText("CHARTTYPE_NEEDS_SUPPORTED",[1,1])}]};}return{Feeds:[{uid:"categoryAxis",type:"Dimension",values:[C.catDimension||D[0].Name]},{uid:"valueAxis",type:"Measure",values:_.map(m,function(o){return o.Name;})}]};}function p(D,m){return(D.length<1||m.length<1)?{Messages:[{msgText:R.getText("CHARTTYPE_NEEDS_SUPPORTED",[1,1])}]}:{Feeds:[{uid:"color",type:"Dimension",values:[D[0].Name]},{uid:"size",type:"Measure",values:[m[0].Name]}]};}function h(D,m,C){if(D.length<2||m.length<1){return{Messages:[{msgText:R.getText("CHARTTYPE_NEEDS_SUPPORTED",[1,1])}]};}var F=[{uid:"categoryAxis",type:"Dimension",values:[C.catDimension||D[0].Name]},{uid:"color",type:"Measure",values:[m[0].Name]}];if(C.cat2Dimension){F.push({uid:"categoryAxis2",type:"Dimension",values:[C.cat2Dimension]});}return{Feeds:F};}function d(D,m,C){return(D.length<1||m.length<1)?{Messages:[{msgText:R.getText("CHARTTYPE_NEEDS_SUPPORTED",[2,1])}]}:{Feeds:[{uid:"valueAxis",type:"Measure",values:[m[0].Name]},{uid:"categoryAxis",type:"Dimension",values:[C.catDimension||D[0].Name]},{uid:"color",type:"Dimension",values:[C.colDimension]}]};}function e(D,m){return(D.length<1||m.length<3)?{Messages:[{msgText:R.getText("CHARTTYPE_NEEDS_SUPPORTED",[1,3])}]}:{Feeds:[{uid:"valueAxis",type:"Measure",values:[m[0].Name]},{uid:"valueAxis2",type:"Measure",values:[m[1].Name]},{uid:"bubbleWidth",type:"Measure",values:[m[2].Name]},{uid:"color",type:"Dimension",values:[D[0].Name]}]};}function f(D,m){return(D.length<2||m.length<3)?{Messages:[{msgText:R.getText("CHARTTYPE_NEEDS_SUPPORTED",[2,2])}]}:{Feeds:[{uid:"title",type:"Dimension",values:[D[0].Name]},{uid:"title",type:"Dimension",values:[D[1].Name]},{uid:"color",type:"Measure",values:[m[0].Name]},{uid:"weight",type:"Measure",values:[m[1].Name]}]};}function g(D,m){return(D.length<1||m.length<2)?{Messages:[{msgText:R.getText("CHARTTYPE_NEEDS_SUPPORTED",[1,2])}]}:{Feeds:[{uid:"valueAxis",type:"Measure",values:[m[0].Name]},{uid:"valueAxis2",type:"Measure",values:[m[1].Name]},{uid:"color",type:"Dimension",values:[D[0].Name]}]};}function w(D,m){return(D.length<2||m.length<1)?{Messages:[{msgText:R.getText("CHARTTYPE_NEEDS_SUPPORTED",[2,1])}]}:{Feeds:[{uid:"valueAxis",type:"Measure",values:[m[0].Name]},{uid:"categoryAxis",type:"Dimension",values:[D[0].Name]},{uid:"waterfallType",type:"Dimension",values:[D[1].Name]}]};}function l(D,m){return(D.length<1)?{Messages:[{msgText:R.getText("CHARTTYPE_NEED_SUPPORTED",[1])}]}:{Feeds:[{uid:"categoryAxis",type:"Dimension",values:[D[0].Name]},{uid:"valueAxis",type:"Measure",values:_.map(m,function(o){return o.Name;})}]};}function i(D,m){return(D.length<1)?{Messages:[{msgText:R.getText("CHARTTYPE_NEED_SUPPORTED",[1])}]}:{Feeds:[{uid:"timeAxis",type:"Dimension",values:[D[0].Name]},{uid:"valueAxis",type:"Measure",values:_.map(m,function(o){return o.Name;})}]};}function v(D,m){if(D.length<1||m.length<3&&m.length<2){return{Messages:[{msgText:R.getText("CHARTTYPE_NEEDS_SUPPORTED",[1,2])}]};}var F=[{uid:"actualValues",type:"Measure",values:[m[0].Name]},{uid:"targetValues",type:"Measure",values:[m[1].Name]},{uid:"categoryAxis",type:"Dimension",values:[D[0].Name]}];if(m.length>2){F.push({uid:"additionalValues",type:"Measure",values:[m[2].Name]});}return{Feeds:F};}t.calculateFeeds=function j(C,D,m,o){switch(C){case"bar":return c(D,m,o);case"column":return c(D,m,o);case"bubble":return e(D,m);case"stacked_column":return d(D,m,o);case"pie":return p(D,m);case"donut":return p(D,m);case"stacked_bar":return d(D,m,o);case"vertical_bullet":return v(D,m);case"horizontal_bullet":return v(D,m);case"heatmap":return h(D,m,o);case"line":return l(D,m);case"time_line":return i(D,m);case"scatter":return g(D,m);case"waterfall":return w(D,m);case"horizontal_waterfall":return w(D,m);case"treemap":return f(D,m);default:return{Messages:[{msgText:R.getText("CHARTTYPE_NOT_SUPPORTED",[C])}]};}};t.transformVariable=function(o){return{Name:o.getNameExternal()||o.getName(),Dimension:o.getDimension&&o.getDimension()&&(o.getDimension().getExternalName()||o.getDimension().getName()),ValueType:o.getValueType().getName(),VariableType:o.getVariableType().getName(),Description:o.getText(),Mandatory:o.isMandatory(),SupportsMultipleValues:o.supportsMultipleValues(),TechName:o.getName(),InputEnabled:o.isInputEnabled(),Position:o.getVariableOrder(),SupportsValueHelp:o.supportsValueHelp&&o.supportsValueHelp(),Hints:{IsDate:o.getValueType().getName()===V.Date,IsNoDate:o.getValueType().getName()!==V.Date},MemberFilter:o.getMemberFilter?_.map(a.arrayFromList(o.getMemberFilter()),function(j){var D=j.getDimension();var T=D&&D.getTextField()&&j.getLow().getSupplementValueString(j.getDimension().getTextField().getName())?j.getLow().getSupplementValueString(j.getDimension().getTextField().getName()):j.getLow().getString();var s=D&&D.getTextField()&&j.getHigh().getSupplementValueString(j.getDimension().getTextField().getName())?j.getHigh().getSupplementValueString(j.getDimension().getTextField().getName()):j.getHigh().getString();var k=s?[T,s].join(" - "):T;if(j.getSetSign()===sap.firefly.SetSign.EXCLUDING){k="!( "+k+")";}return{Low:j.getLow().getString(),High:j.getHigh().getString(),ComparisonOperator:j.getComparisonOperator().getName(),Text:k,IsExcluding:j.getSetSign().getName()};}):(function(){var s=o.getValueByString();if(!s){return[];}return[{Low:s,ComparisionOperator:"EQUAL",Text:s,IsExcluding:false}];}())};};}return new b;});
