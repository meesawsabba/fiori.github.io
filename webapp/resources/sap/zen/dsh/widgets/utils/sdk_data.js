/*
 * SAPUI5
  (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["jquery.sap.global","sap/zen/commons/thirdparty/lodash","sap/zen/dsh/widgets/utils/info_chart_exception","sap/zen/dsh/utils/BaseHandler"],function(q,_,I){"use strict";function S(d){if(!d){throw new I("mapper.nodata");}var m=e(d);this._dimensions=m.dimensions;this._measureMembers=m.measureMembers;a(this._dimensions);this._tupleTree=_.reduce(m.tuples,function(i,n,o){var p=d.conditionalFormatValues&&d.conditionalFormatValues[o];var s=d.data[o];var v=m.measureMembers[n[m.measureIndex]].key;var w=r(n,m.measureIndex);var x=h(m.dimensions,w);var y={"isLeaf":true,"measures":{}};y.measures[v]={"value":s,"index":o};if(p){y.measures[v].conditionalFormat=_.values(p)[0];}u(i,x,y);return i;},{});}S.prototype.keepDimensions=function(d){var i=this;function m(n,o){var p=i._dimensions[n];var s=!o.isLeaf&&!_.includes(d,p.key);var v,w;if(o.isLeaf){w=o;}else if(s){v=f(o,_.map(p.members,"key"));w=m(n+1,v);}else{w=b(o,_.partial(m,n+1));}return w;}this._tupleTree=m(0,this._tupleTree);this._dimensions=_.filter(this._dimensions,function(n){return _.includes(d,n.key);});};function a(d){d.forEach(function(D){if(D.displayMode&&D.displayMode!=="TEXT"){D.members.forEach(function(m){if(D.displayMode==="KEY"){m.text=m.key+" ("+m.text+")";}else if(D.displayMode==="KEY_TEXT"){m.text=m.key+" | "+m.text;}else if(D.displayMode==="TEXT_KEY"){m.text=m.text+" | "+m.key;}});}});}function b(o,m){var d={};_.forEach(o,function(v,n){d[n]=m(v);});return d;}function f(o,p){var d=_.find(p,_.partial(_.has,o));return o[d];}S.prototype.getConditionalFormatValues=function(){var d=this,i={};_.forEach(g(this._tupleTree,this._dimensions),function(m){_.forEach(m.measures,function(n,o){if(n.conditionalFormat){var p=_.map(d._dimensions,"key");var s=_.map(m.tuple,"key");var v=_.object(p,s);v[o]=n.value;i[n.conditionalFormat]=i[n.conditionalFormat]||[];i[n.conditionalFormat].push(v);}});});return i;};S.prototype.toFlatData=function(d){return{"metadata":{"fields":t(this._dimensions,this._measureMembers)},"data":c(this,!!d)};};S.prototype.getSDKFormatStrings=function(){return _.reduce(this._measureMembers,function(d,m){if(m.formatString)d[m.key]=m.formatString;return d;},{});};S.prototype.getMeasuresArray=function(){return this._measureMembers;};function t(i,n){var o=_.map(i,function(d){return{"id":d.key,"name":d.text,"type":"Dimension","semanticType":"Dimension","dataType":"String"};});var p=_.map(n,function(m){return{"id":m.key,"name":m.text,"type":"Measure","semanticType":"Measure","dataType":"Number"};});return o.concat(p);}function c(s,d){var i=_.map(g(s._tupleTree,s._dimensions,d),function(m){var n=_.map(m.tuple,function(p){return{"v":p.key,"d":p.text};});var o=_.map(s._measureMembers,function(p){var v=m.measures[p.key];if(v){return v.value;}else{return null;}});return n.concat(o);});return i;}function g(d,i,m){var n=[];var o=[];var p=function(d,n,o){if(d.isLeaf){d.tuple=_.map(o,function(s,v){var w=_.find(i[v].members,{"key":s});d.containsTotal=d.containsTotal||w.type==="RESULT";return{"key":s,"text":w.text};});if(!m||(m&&!d.containsTotal)){n.push(d);}}else{_.forEach(d,function(s,v){p(s,n,o.concat([v]));});}};p(d,n,o);return _.sortBy(n,function(s){var v=_.map(s.measures,"index");return _.min(v);});}function u(d,p,i){if(p.length===0){d.isLeaf=true;d.measures=d.measures||{};_.extend(d.measures,i.measures);}else{d[_.head(p)]=d[_.head(p)]||{};u(d[_.head(p)],_.tail(p),i);}}function e(d){var i=k(d.dimensions)||[];var m=k(d.tuples)||[];var n;var o;var p;var s;if(d.externalDimensions){n=_.find(d.externalDimensions,_.property("containsMeasures"));if(n){i=i.concat(n);m=_.map(m,l);}}o=_.partition(i,_.property("containsMeasures"));s=o[0][0]&&o[0][0].members;if(!s){s=[{"key":" ","text":" "}];m=_.map(m,l);p=i.length;}else{p=j(i,_.property("containsMeasures"));}return{"dimensions":o[1],"measureMembers":s,"measureIndex":p,"tuples":m};}function h(d,i){if(d.length!==i.length){throw new Error("Tuples do not match dimensions");}return _.map(i,function(m,n){return d[n].members[m].key;});}function j(d,p){for(var i=0;d&&d.length&&i<d.length;i++){if(p(d[i])){return i;}}return-1;}function r(d,i){var m=d.slice(0);m.splice(i,1);return m;}function k(d){return(d&&d.slice(0))||[];}function l(d){return d.concat(0);}return S;});
