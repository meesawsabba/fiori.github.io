/*
 * SAPUI5
  (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["jquery.sap.global","sap/zen/commons/thirdparty/lodash","sap/base/Log","sap/ui/comp/filterbar/FilterBar","sap/m/Button","sap/ui/comp/smartvariants/PersonalizableInfo","sap/ui/comp/smartvariants/SmartVariantManagement","sap/zen/dsh/utils/BaseHandler","sap/zen/dsh/widgets/filterpanel_m_handler"],function(jQuery,_,Log,FilterBar,Button,PersonalizableInfo,SmartVariantManagement,BaseHandler){"use strict";var FilterBarHandler=function(){BaseHandler.apply(this,arguments);var dispatcher=BaseHandler.dispatcher;var me=this;me.create=function(c,C){var i=C["id"];var Z=FilterBar.extend("sap.zen.ZenFilterBar",{renderer:{}});Z.prototype._createVariantManagement=function(){this._smartVm=false;var l;if(sap.zen.dsh.sapbi_page.appComponent){l=new SmartVariantManagement(this.getId()+"-variant",{showExecuteOnSelection:false,showShare:true});this._smartVm=true;}return l;};var f=new Z(i,{advancedMode:false,considerGroupTitle:false,showRestoreButton:false,filterBarExpanded:C.expanded,persistencyKey:C.VARIANT_KEY}).addStyleClass("zenFilterBarM");f._initializeVariantManagementOriginal=sap.ui.comp.filterbar.FilterBar.prototype._initializeVariantManagement;f._initializeVariantManagement=function(){if(this._smartVm){if(this._oVariantManagement&&this.getPersistencyKey()){this._sOwnerId=sap.zen.dsh.sapbi_page&&sap.zen.dsh.sapbi_page.appComponent.getId();var l=new PersonalizableInfo({type:"filterBar",keyName:"persistencyKey"});l.setControl(this);this._oVariantManagement.addPersonalizableControl(l);f._initializeVariantManagementOriginal.call(f);}else{this.fireInitialise();}}else{f._initializeVariantManagementOriginal.call(f);}};if(f._oVariantManagement){f._oVariantManagement._initializeOriginal=f._oVariantManagement._initialize;f._oVariantManagement._initialize=function(p,o){if(C.ignoreDefaultVariant){this.setInitialSelectionKey(f._oVariantManagement.STANDARDVARIANTKEY);var l=me.allowVariantSave(f,C);f._oVariantManagement.currentVariantSetModified(l);}f._oVariantManagement._initializeOriginal.call(f._oVariantManagement,p,o);};}f.applyVariant=function(v,s,I){if(v){var l=v.filterBarVariant;if(l){var a=getCommand(f,"loadSfinBookmark");if(a){me.applyForChildren(f,function(d){var b=d.getModel();var e;if(b){e=b.getProperty("/filters");}if(e){for(var g in e){if(Object.prototype.hasOwnProperty.call(e,g)){if(e[g].dirty){e[g].dirty=false;}}}}});if(a.indexOf("__bmId__")>=0){a=me.prepareCommand(a,"__bmId__","42");a=me.prepareCommand(a,"__arg2__",l);new Function(a).call();}}}if(I&&this._isNewFilterBarDesign()){this._fHandleResize();}}};f.registerFetchData(function(){if(!sap.zen.dsh.wnd){sap.zen.dsh.wnd={};}var l=sap.zen.dsh.wnd[C.PAGE_ID].getWindow().getContext("BookmarkInternal").createBookmark().getBookmark();var a=JSON.parse(JSON.stringify(l));return a;});f._initializeVariantManagement();if(!sap.zen.designmode&&!C.fbVisible){f.toggleStyleClass("zenFilterBarMHidden");}f.custProp={};f.custProp.i18n={"expand":C.EXPAND_ACTION,"collapse":C.COLLAPSE_ACTION,"novariant":C.NO_VARIANT};f.custProp.allChildrenSubmit=C.allChildrenSubmit;me.addCustomExpandButton(f);if(typeof(sap.zen.dsh.DSH_deployment)!=="undefined"){setCommand(f,"loadSfinBookmark",C.loadsfinbookmarkcmd);}f.zenInitLater=function(){init(f,C);f.zenInitLater=null;};setCommand(f,"EXPAND",C.expandcmd);setCommand(f,"DELAYRERENDER",C.delayrerendercmd);if(!sap.zen.designmode){f.addEventDelegate({onAfterRendering:function(e){e.srcControl.removeEventDelegate(this);me.updateEnablement(e.srcControl,C);jQuery(e.srcControl.getParent().getDomRef()).addClass("zenFilterBarMParentCont");}});}f.registerGetFiltersWithValues(function(){return handleDetermineFilterCount(f);});f.attachSearch(function(){handleFilterDialog_submit(f);});handleFilterDialog(f);me.initOverflowExpand(f,C);return f;};me.update=function(c,C){if(C){if(c.zenInitLater){setTimeout(c.zenInitLater);}else{init(c,C,true);}me.updateVisibility(c,C);me.updateEnablement(c,C);var l=me.allowVariantSave(c,C);if(c._oVariantManagement){c._oVariantManagement.currentVariantSetModified(l);}}return c;};function init(c,C,u){var l=C.content;if(l&&l[0]){if(l[0].component.content&&l[0].component.content.control.newds){c.custProp.allChildrenSubmit=C.allChildrenSubmit;if(u){l.forEach(function(o){if(o.component.content&&o.component.content.control.newds){o.component.content.control.newds=false;}});}}me.updateChildren(l,c,function(n,I,g){if(g){var h=new sap.ui.comp.filterbar.FilterGroupItem(c.getId()+n.getId(),{name:c.getId()+"-"+n.getId(),groupName:sap.ui.comp.filterbar.FilterBar.INTERNAL_GROUP,partOfCurrentVariant:true,visibleInFilterBar:false});h.setControl(n);if(g.content&&g.content.control&&g.content.control.characteristics&&g.content.control.characteristics.length>0){h.setLabel(g.content.control.characteristics[0].characteristic.text);}n.addStyleClass("zenFilterBarMFilter");if(n.ZEN_multiInput&&n.ZEN_multiInput[0]){n.ZEN_multiInput[0].attachTokenChange(function(E){c.fireFilterChange(E);});}c.addFilterGroupItem(h);}},function(){});c.fireFilterChange();}if(C.visibleDimensionNames){var a=C.visibleDimensionNames;var b=c.getFilterGroupItems();for(var i=0;i<b.length;i++){var d=b[i];var e=c.determineControlByFilterItem(d);if(e){d.setVisibleInFilterBar(false);var m=e.getModel();if(!m){Log.error("FilterControl "+e.getId()+" has no model");}else{var f=m.getProperty("/characteristics/0/characteristic/name");for(var j=0;j<a.length;j++){if(f===a[j]._n){d.setVisibleInFilterBar(true);break;}}}}}}}me.applyForChildren=function(f,a){var l=f.getAllFilterItems();for(var i=0;i<l.length;i++){var b=f.determineControlByFilterItem(l[i]);if(b){var c=a(b);if(c){return c;}}}return null;};me.getType=function(){return"filterbar";};me.updateVisibility=function(f,c){if(c.visibilityChanged){f.toggleStyleClass("zenFilterBarMHidden");}};me.allowVariantSave=function(f,c){if(f._oVariantManagement){var l=f._oVariantManagement;if(l.getSelectionKey()!==l.STANDARDVARIANTKEY&&c.datasourcechanged){return true;}else{return false;}}return null;};me.initOverflowExpand=function(oFilterBar,oControlProperties){dispatcher.registerResizeHandler(oFilterBar,{endResize:function(e){if(e){if(getSampleDFWidth()===-1){me.sampleDimensionFilterWidth(oFilterBar);}if(oFilterBar.getFilterBarExpanded()){me.refreshCollapseVisibleDFCount(oFilterBar);}me.updateCustomExpandVisibility(oFilterBar);}}});oFilterBar.orig_setFilterBarExpanded=oFilterBar.setFilterBarExpanded;oFilterBar.setFilterBarExpanded=function(showExpanded){var lOldExpanded=this.getFilterBarExpanded();oFilterBar.orig_setFilterBarExpanded.call(oFilterBar,showExpanded);if(showExpanded!==lOldExpanded){var lCommandString=getCommand(oFilterBar,"EXPAND");if(lCommandString){eval(lCommandString);}new Function(oControlProperties.onToggle).call();}};};me.addCustomExpandButton=function(f){if(f._oToolbar){var l;if(f._oHideShowButton){l=f._oToolbar.indexOfContent(f._oHideShowButton);}if(l){f.customExpandButton=new Button({text:f.custProp.i18n.expand,visible:false,type:sap.m.ButtonType.Transparent});f.customExpandButton.attachPress(function(){me.toggleExpandOverlay(f);});f.customExpandButton.addStyleClass("zenCustomExpandButton");f._oToolbar.insertContent(f.customExpandButton,l);}}};me.updateCustomExpandVisibility=function(f){var l=false;if(f.getFilterBarExpanded()){l=me.checkCustomExpandVisibility(f)&&f.getFilterBarExpanded();}f.customExpandButton.setVisible(l);if(f.custProp.customExpanded&&!l){me.toggleExpandOverlay(f,true);}};me.refreshCollapseVisibleDFCount=function(f){if(getSampleDFWidth()===-1){me.sampleDimensionFilterWidth(f);}var l=Math.floor(((jQuery(f.getDomRef()).width())/getSampleDFWidth()));var a=f.getFilterGroupItems();var b=0;for(var i=0;i<a.length;i++){var c=a[i];if(c.getVisibleInFilterBar()){var d=f.determineControlByFilterItem(c);if(d){var e=d.getParent();if(e&&e.addStyleClass&&e.removeStyleClass){if(b++>=l){e.addStyleClass("zenFBIhidden");}else{e.removeStyleClass("zenFBIhidden");}}}}}};me.checkCustomExpandVisibility=function(f){var l=false;var a=getVisibleDFCount(f);if(getSampleDFWidth()!==-1){if((a*getSampleDFWidth())>(jQuery(f.getDomRef()).width())){l=true;}}return l;};me.sampleDimensionFilterWidth=function(f){var l=-1;var a=f.getAllFilterItems();if(a.length>1){var d=jQuery(f.getDomRef()).find(".sapUiAFLayoutItem:first-of-type");if(d){var b=parseInt(d.css("padding-left"))+parseInt(d.css("padding-right"));if(isNaN(b)){b=0;}var c=parseInt(d.css("margin-left"))+parseInt(d.css("margin-right"));if(isNaN(c)){c=0;}l=d.width()+b+c;}}setSampleDFWidth(l);};me.toggleExpandOverlay=function(f,m){if(f.custProp.customExpanded||m===true){f.removeStyleClass("zenCustomExpand");f.custProp.customExpanded=false;f.customExpandButton.setText(f.custProp.i18n.expand);}else{f.addStyleClass("zenCustomExpand");f.custProp.customExpanded=true;f.customExpandButton.setText(f.custProp.i18n.collapse);}};function handleDetermineFilterCount(f){var l=[];var a=f.getFilterGroupItems();for(var i=0;i<a.length;i++){var b=f.determineControlByFilterItem(a[i]);if(b&&b.ZEN_multiInput&&b.ZEN_multiInput[0]&&b.ZEN_multiInput[0].getTokens().length){l.push(a[i]);}}return l;}function handleFilterDialog(f){f.attachFiltersDialogBeforeOpen(function(){handleFilterDialog_show(f);});f.attachFiltersDialogClosed(function(){handleFilterDialog_close(f);});me.originalCancelFilterDialog=f._cancelFilterDialog;f.attachFiltersDialogCancel(function(){handleFilterDialog_cancel(f);});}function handleFilterDialog_show(f){jQuery(document.body).addClass("zenFilterBarDialogOpened");me.applyForChildren(f,function(d){d.ZENFilterBeforeDialog=JSON.stringify(d.getModel().getProperty("/filters"));});}function handleFilterDialog_close(f){if(!me._bFilterDialogCancelled){handleFilterDialog_submit(f);}me._bFilterDialogCancelled=null;me.applyForChildren(f,function(d){if(d.ZENFilterBeforeDialog){d.ZENFilterBeforeDialog=null;}});jQuery(document.body).removeClass("zenFilterBarDialogOpened");if(f.getFilterBarExpanded()){me.refreshCollapseVisibleDFCount(f);}me.updateCustomExpandVisibility(f);}function handleFilterDialog_cancel(f){me._bFilterDialogCancelled=true;me.applyForChildren(f,function(d){if(d.ZENFilterBeforeDialog){d.getModel().setProperty("/filters",JSON.parse(d.ZENFilterBeforeDialog));d.ZENFilterBeforeDialog=null;}});if(me.originalCancelFilterDialog){me.originalCancelFilterDialog.call(f);}}function handleFilterDialog_submit(oFilterBar){var lSubmitMethod=oFilterBar.custProp.allChildrenSubmit;var lKeyWordToReplace=lSubmitMethod.indexOf("__STRING____");while(lKeyWordToReplace>0){var lKeyWeNeedToReplace;if(typeof(sap.zen.dsh.DSH_deployment)==="undefined"){lKeyWeNeedToReplace=lSubmitMethod.substring(lKeyWordToReplace,lSubmitMethod.indexOf("'",lKeyWordToReplace));}else{lKeyWeNeedToReplace=lSubmitMethod.substring(lKeyWordToReplace,lSubmitMethod.indexOf("\\x27",lKeyWordToReplace));}var lIdWeNeed=lKeyWeNeedToReplace.substring(12)+"_filter1";var loDimensionFilter=sap.ui.getCore().byId(lIdWeNeed);var lOriginalSubmitMethod=lSubmitMethod;lSubmitMethod=loDimensionFilter.ZEN_submit(lKeyWeNeedToReplace,lSubmitMethod);if(!lSubmitMethod){lSubmitMethod=lOriginalSubmitMethod.replace(lKeyWeNeedToReplace,"{}");}lKeyWordToReplace=lSubmitMethod.indexOf("__STRING____");}var lDelayrerendercmdStart=getCommand(oFilterBar,"DELAYRERENDER");if(lDelayrerendercmdStart&&lDelayrerendercmdStart.indexOf("__arg1__")>=0){lDelayrerendercmdStart=lDelayrerendercmdStart.replace("__arg1__","true");}var lDelayrerendercmdEnd=getCommand(oFilterBar,"DELAYRERENDER");if(lDelayrerendercmdEnd&&lDelayrerendercmdEnd.indexOf("__arg1__")>=0){lDelayrerendercmdEnd=lDelayrerendercmdEnd.replace("__arg1__","false");}var lVisibleDimensions=me.getVisibleDimensions(oFilterBar);if(lVisibleDimensions&&lDelayrerendercmdEnd&&lDelayrerendercmdEnd.indexOf("__arg2__")>=0){lDelayrerendercmdEnd=lDelayrerendercmdEnd.replace("__arg2__",lVisibleDimensions);}lSubmitMethod=lDelayrerendercmdStart+lDelayrerendercmdEnd+lSubmitMethod;eval(lSubmitMethod);}me.getVisibleDimensions=function(f){if(typeof(sap.zen.dsh.DSH_deployment)!=="undefined"){var l=f.getFilterGroupItems();var a=[];for(var i=0;i<l.length;i++){var b=l[i];if(b.getVisibleInFilterBar()){var c=f.determineControlByFilterItem(b);if(c){var d=c.getModel().getProperty("/characteristics/0/characteristic/name");if(d){a.push(d);}}}}return JSON.stringify(a);}return null;};me.updateEnablement=function(f){if(f._oVariantManagement){f._oVariantManagement.setEnabled(true);}};function getVisibleDFCount(f){var l=f.getAllFilterItems(true);var a=0;for(var i=0;l&&i<l.length;i++){if(l[i].getVisibleInFilterBar()){a++;}}return a;}function setSampleDFWidth(v){me._sampleDFWidth=v;}function getSampleDFWidth(){if(!me._sampleDFWidth){me._sampleDFWidth=-1;}return me._sampleDFWidth;}function getCommand(c,t){var l;if(c.custProp&&c.custProp.commands){l=c.custProp.commands[t];}return l;}function setCommand(c,t,a){if(c.custProp){if(!c.custProp.commands){c.custProp.commands={};}c.custProp.commands[t]=a;}}this.getDecorator=function(){return"DataSourceFixedHeightDecorator";};};var instance=new FilterBarHandler();BaseHandler.dispatcher.addHandlers(instance.getType(),instance);return instance;});
