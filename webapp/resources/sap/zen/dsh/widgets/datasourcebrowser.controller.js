/*
 * SAPUI5
  (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["jquery.sap.global","sap/base/Log","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","sap/zen/dsh/utils/BaseHandler"],function(q,L,J,R,B){"use strict";sap.ui.controller("dsb.datasourcebrowser",{getControl:function(i){var v=this.getView();return v.byId(i);},onInit:function(){this.imageBaseUrl="zen.res/zen.rt.components.ui5/datasourcebrowser/images/";var v=this.getView();this.oResourceModel=new R({bundleUrl:"sap/zen/dsh/i18n/dsb/localization.properties"});v.setModel(this.oResourceModel,"i18n");var m=new J();var c={};var d="";if(v.controlProperties.config){c=JSON.parse(v.controlProperties.config);d=c.title;}if(!d){c.title=this.oResourceModel.getResourceBundle().getText("DLGTITLE");}var l=this.oResourceModel.getResourceBundle().getText("LOADING");c.loadingText=l;m.setData(c);v.setModel(m);var s=this.getControl("searchTab");var r=this.getControl("rolesTab");r.isInitial=true;var w=this.getControl("workspacesTab");w.isInitial=true;var f=this.getControl("foldersTab");f.isInitial=true;if(c.hiddenTabs){var h=c.hiddenTabs;h.forEach(function(e){if(e==="searchTab"){s.setVisible(false);}else if(e==="rolesTab"){r.setVisible(false);}else if(e==="workspacesTab"){w.setVisible(false);}else if(e==="foldersTab"){f.setVisible(false);}});}if(v.controlProperties.connectionType==="BAE"||v.controlProperties.connectionType==="HTTP"){r.setVisible(false);w.setVisible(false);f.setText(this.oResourceModel.getResourceBundle().getText("FOLDERS"));}this.defaultIndex=-1;if(c.defaultTab){var t=this.getControl("tabStrip");if(!B.dispatcher.isMainMode()){if(c.defaultTab==="searchTab"&&s.getVisible()){t.setSelectedIndex(0);this.defaultIndex=0;}else if(c.defaultTab==="rolesTab"&&r.getVisible()){t.setSelectedIndex(1);this.defaultIndex=1;}else if(c.defaultTab==="workspacesTab"&&w.getVisible()){t.setSelectedIndex(2);this.defaultIndex=2;}else if(c.defaultTab==="foldersTab"&&f.getVisible()){t.setSelectedIndex(3);this.defaultIndex=3;}}else{if(c.defaultTab==="searchTab"&&s.getVisible()){this.defaultIndex=0;t.setSelectedKey(this.createId("searchTab"));}else if(c.defaultTab==="rolesTab"&&r.getVisible()){this.defaultIndex=1;t.setSelectedKey(this.createId("rolesTab"));}else if(c.defaultTab==="workspacesTab"&&w.getVisible()){this.defaultIndex=2;t.setSelectedKey(this.createId("workspacesTab"));}else if(c.defaultTab==="foldersTab"&&f.getVisible()){this.defaultIndex=3;t.setSelectedKey(this.createId("foldersTab"));}}}if(this.defaultIndex===-1){if(s.getVisible()){this.defaultIndex=0;}else if(r.getVisible()){this.defaultIndex=1;}else if(w.getVisible()){this.defaultIndex=2;}else if(f.getVisible()){this.defaultIndex=3;}}var a=this.getControl("dialog");if(c.width){a.setWidth(c.width);}if(c.height){a.setHeight(c.height);}if(s.getVisible()){a.setInitialFocus(this.getControl("searchPattern"));}a.open();},iconFormatter:function(t){if(t===null){return"";}if(t==="QUERY"){return this.imageBaseUrl+"query.png";}else if(t==="VIEW"){return this.imageBaseUrl+"queryview.png";}else if(t==="INFOPROVIDER"){return this.imageBaseUrl+"cube.png";}else if(t==="FOLDER"){return this.imageBaseUrl+"folder.png";}return"";},tooltipFormatter:function(t){if(t===null){return"";}if(t==="QUERY"){return"Query";}else if(t==="VIEW"){return"QueryView";}else if(t==="INFOPROVIDER"){return"InfoProvider";}return"";},onAfterRendering:function(){if(this.defaultIndex>0){this.populateTab(this.defaultIndex);}},getSelectedNode:function(){var c,s;if(this.getSelectedIndex()===0){c=this.getControl("resultTable");}if(this.getSelectedIndex()===1){c=this.getControl("rolesTree");}if(this.getSelectedIndex()===2){c=this.getControl("workspacesTree");}if(this.getSelectedIndex()===3){c=this.getControl("foldersTree");}if(c){s=c.getSelectedIndex();if(s>-1){var a=c.getContextByIndex(s);return a.getObject();}}return undefined;},textFieldChanged:function(){this.searchClicked();},textFieldLiveChanged:function(e){var v=e.getParameters().liveValue;this.getControl("searchButton").setEnabled(v!=="");},fetchRootNodes:function(r,t){t.setModel(this.oResourceModel,"i18n");var a=t.getModel("i18n").getResourceBundle();var l=a.getText("LOADING");t.setNoData(l);var b=this;this.callZtlNoUndo("getRootFolders",r,function(c){var T=new sap.ui.model.json.JSONModel();var d={};for(var i=0,n=c.length;i<n;i++){var e=c[i];var f=b.iconFormatter(e.type);var g={name:e.name,description:e.description,type:e.type,icon:f,hasChildren:e.hasChildren,id:e.id};d[""+i]=g;if(e.hasChildren){g["0"]={name:"",description:l,type:"LOADING",hasChildren:false};}}T.setSizeLimit(Number.MAX_VALUE);T.setData({root:d});t.setModel(T);t.bindRows("/root");var h="";if(r==="ROLES"){h=a.getText("ROLES");}if(r==="WORKSPACES"){h=a.getText("WORKSPACES");}if(r==="FOLDERS"){h=a.getText("WORKSPACES");}var j=a.getText("NO_X_FOUND");var k=j.replace("{0}",h);t.setNoData(k);});},populateTab:function(s){if(s===0){this.getControl("searchPattern").focus();}else if(s===1){var r=this.getControl("rolesTab");if(r.isInitial){this.fetchRootNodes("ROLES",this.getControl("rolesTree"));r.isInitial=false;}}else if(s===2){var w=this.getControl("workspacesTab");if(w.isInitial){this.fetchRootNodes("WORKSPACES",this.getControl("workspacesTree"));w.isInitial=false;}}else if(s===3){var f=this.getControl("foldersTab");if(f.isInitial){this.fetchRootNodes("INFO_AREA_OR_FOLDER",this.getControl("foldersTree"));f.isInitial=false;}}if(this.getSelectedNode()===undefined){this.getControl("okButton").setEnabled(false);}else{this.getControl("okButton").setEnabled(true);}},getSelectedIndex:function(){var s;var t=this.getControl("tabStrip");if(!B.dispatcher.isMainMode()){s=t.getSelectedIndex();}else{var a=t.getSelectedKey();if(a.indexOf("searchTab")>-1){s=0;}else if(a.indexOf("rolesTab")>-1){s=1;}else if(a.indexOf("workspacesTab")>-1){s=2;}else if(a.indexOf("foldersTab")>-1){s=3;}}return s;},tabSelected:function(){this.populateTab(this.getSelectedIndex());},toggleExpandedState:function(e){if(e.getParameters().expanded){var c=e.getParameters().rowContext;var t=e.getSource();var m=t.getModel();var r=t.getModel("i18n").getResourceBundle();var l=r.getText("LOADING");var a=c.getObject();var f=a["0"];if(f.type==="LOADING"){var b=this;this.callZtlNoUndo("getChildren",a.id,function(d){if(d.length===0){delete a["0"];}else{for(var i=0,n=d.length;i<n;i++){var g=d[i];var h=b.iconFormatter(g.type);var j={name:g.name,description:g.description,type:g.type,icon:h,hasChildren:g.hasChildren,id:g.id};a[""+i]=j;if(g.hasChildren){j["0"]={name:"",description:l,type:"LOADING",hasChildren:false};}}}m.refresh();});}}},searchClicked:function(e){var s=e.getSource();s.setBusy(true);var a=this.getControl("searchResultsLabel");var r=this.getView().getModel("i18n").getResourceBundle();var t=this.getControl("resultTable");t.setModel(new sap.ui.model.json.JSONModel({}));t.setNoDataText(r.getText("SEARCHING"));var b=this;this.callZtlNoUndo("searchDataSources",s.getValue(),function(c){for(var i=0,n=c.length;i<n;i++){var d=b.tooltipFormatter(c[i].type);var f=b.iconFormatter(c[i].type);c[i].icon=f;c[i].tooltip=d;}var S=new sap.ui.model.json.JSONModel();S.setSizeLimit(Number.MAX_VALUE);S.setData({data:c});t.setModel(S);t.bindRows("/data");var g=r.getText("RESULTS_COUNT");var h=g.replace("{0}",c.length+"");a.setText(h);if(c.length===0){t.setNoDataText(r.getText("NO_SEARCH_RESULTS"));}s.setBusy(false);});},tableRowSelected:function(){var s=this.getControl("resultTable").getSelectedIndex();this.getControl("okButton").setEnabled((s!==-1));},treeNodeSelected:function(e){var t=e.getSource();var s=t.getSelectedIndex();if(s===-1){this.getControl("okButton").setEnabled(false);}else{var c=e.getParameters().rowContext;if(c!==null){var n=c.getObject();var a=n.type;this.getControl("okButton").setEnabled(a==="QUERY"||a==="VIEW"||a==="INFOPROVIDER");if(a==="FOLDER"){t.setSelectedIndex(-1);}}}},okClicked:function(){this.getControl("dialog").close();this.selectedNodeId=this.getSelectedNode().id;this.getControl("dialog").close();},dialogClosed:function(){this.callZtl("close",this.selectedNodeId);},cancelClicked:function(){this.selectedNodeId=undefined;this.getControl("dialog").close();},callZtl:function(n,a,r){var v=this.getView();v.callZTLFunction(n,r,a);},callZtlNoUndo:function(n,a,r){var v=this.getView();v.callZTLFunctionNoUndo(n,r,a);}});});
