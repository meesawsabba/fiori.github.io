/*
 * SAPUI5
  (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","jquery.sap.global","sap/zen/dsh/utils/BaseHandler"],function(L,q,B){"use strict";var F=function(){B.apply(this,arguments);var t=this;this.aAllowedSemanticSources=[];this.aValidJumpTargets=[];this.sCmdOnTileSettingsSubmitted=null;this.sCmdSetAppUrl=null;this.oBookmarkTileData=null;this.oBookmarkTileGroup=null;this.oAppState=null;this.sSelection=null;this.create=function(C,o){this.oAppState=null;this.sSelection=null;var l=o["id"];var a=this.createDefaultProxy(l);this.init(a,o);a.setVisible(false);return a;};this.update=function(C,o){this.init(C,o);return C;};this.init=function(C,o){if(o){if(o.appstate){this.setApplicationState(o.appstate,o.hostui5control);}if(o.context){this.setSelection(o.context,o.hostui5control);}this.sCmdOnTileSettingsSubmitted=o.ontilesettingssubmittedcommand;var l=o.clientaction;if(l&&l.length>0){if(l==="FETCH_JUMP_TARGETS"){this.fetchJumpTargets(o);}else if(l==="JUMP_TO"){this.jumpToTarget(o);}else if(l==="SAVE_TILE"){this.saveTile(o);}else if(l==="OPEN_TILE_SETTINGS"){this.openSaveTileDialog(o);}else if(l==="GET_APP_URL"){this.sCmdSetAppUrl=o.getappurlcommand;this.sendAppUrl();}else if(l==="NAVIGATE_BACK"){this.navigateBack();}}if(o.shellapptitle){this.setTitle(o.shellapptitle);}}};this.setTitle=function(T){if(sap.zen.dsh.sapbi_page&&sap.zen.dsh.sapbi_page.appComponent){sap.zen.dsh.sapbi_page.appComponent.getService("ShellUIService").then(function(s){if(s){s.setTitle(T);}}.bind(this),function(){});}};this.setApplicationState=function(a,h){if(a){var l=h&&sap.ui.getCore().byId(h);if(l&&l.fireStateChange){return l.fireStateChange({state:a});}if(!sap.zen.dsh.sapbi_page.appComponent){return;}if(sap.ushell&&sap.ushell.Container){sap.ushell.Container.getServiceAsync("CrossApplicationNavigation").then(function(C){if(this.oAppState){var b=this.oAppState.getData();if(b&&b.customData&&b.customData.bookmarkedAppState===a){return;}}this.oAppState=C.createEmptyAppState(sap.zen.dsh.sapbi_page.appComponent);var d={"customData":{"bookmarkedAppState":a}};this.oAppState.setData(d);this.oAppState.save();sap.ushell.Container.getServiceAsync("ShellNavigation").then(function(s){if(sap.zen.dsh.iaminjump){delete sap.zen.dsh.iaminjump;}else{s.toAppHash("sap-iapp-state="+this.oAppState.getKey(),false);this.sendAppUrl();}}.bind(this));}.bind(this));}}};this.sendAppUrl=function(){if(this.sCmdSetAppUrl&&this.sCmdSetAppUrl.length>0){var l;var a="";var b={};if(typeof hasher!=="undefined"){var d=URI(hasher.getHash());a=d.path();b=URI.parseQuery(d.query());l=URI(hasher.getURL()).fragment("").toString();}else{l=URI("");}var e=this.sCmdSetAppUrl;e=t.prepareCommand(e,"__BASE_URL__",l);e=t.prepareCommand(e,"__BASE_HASH__",a);e=t.prepareCommand(e,"__PARAM_JSON__",encodeURI(JSON.stringify(b)));var f=new Function(e);f();}};this.setSelection=function(C,h){var l=h&&sap.ui.getCore().byId(h);if(l&&l.fireSelectionChange){var a=JSON.stringify(C);if(this.sSelection!==a){this.sSelection=a;l.fireSelectionChange({selection:this.createSelectionVariantObject(C)});}}};this.openSaveTileDialog=function(C){var t=this;var l=new sap.ushell.ui.footerbar.AddBookmarkButton({beforePressHandler:function(){if(C.shellapptitle){l.setTitle(C.shellapptitle);}if(C.tileSubtitle){l.setSubtitle(C.tileSubtitle);}if(C.tileInfo){l.setInfo(C.tileInfo);}},afterPressHandler:function(){}});l.firePress();};this.saveTile=function(C){if(sap.ushell&&sap.ushell.Container){sap.ushell.Container.getServiceAsync("Bookmark").then(function(b){var l=C.urlparameters;if(b){var a=typeof hasher!=="undefined"?hasher.getHashAsArray():[""];if(C.usefrontendtilesettings){if(l){this.oBookmarkTileData.url=this.mixInURLParameters(a,l);}b.addBookmark(this.oBookmarkTileData,this.oBookmarkTileGroup);}else{var d=this.mixInURLParameters(a,l);b.addBookmark({title:C.title||"",url:d,info:C.info||"",subtitle:C.subtitle||""});}}}.bind(this));}};this.mixInURLParameters=function(a,u){var l=URI.parseQuery(u);var b=a[0];var d=URI.parse(b);var e=URI.parseQuery(d.query);for(var f in l){if(Object.prototype.hasOwnProperty.call(l,f)){e[f]=l[f];}}var g="#"+URI(d.path).addQuery(e);if(a.length>1){if(b.endsWith("&")&&!g.endsWith("&")){g=g+"&";}for(var h=1;h<a.length;++h){g=g+"/"+a[h];}}return g;};this.navigateBack=function(){if(sap.ushell&&sap.ushell.Container){sap.ushell.Container.getServiceAsync("CrossApplicationNavigation").then(function(C){if(C){C.backToPreviousApp();}}.bind(this));}};this.jumpToTarget=function(C){if(sap.ushell&&sap.ushell.Container){sap.ushell.Container.getServiceAsync("CrossApplicationNavigation").then(function(o){var l=C.hash;if(o&&l&&l.length>0){if(C.navigateinplace){sap.zen.dsh.iaminjump=true;o.toExternal({target:{shellHash:l}});}else{window.open(l);}}}.bind(this));}};this.fetchJumpTargets=function(C){this.determineAllowedSemanticSources(C);var l=C.context;var a=this.createSelectionVariantObject(l);var b={};this.addNameSelectionPairFromArray(l.selections,b);this.addNameSelectionPairFromArray(l.filter,b);this.addNameSelectionPairFromArray(l.variables,b);if(sap.ushell&&sap.ushell.Container){sap.ushell.Container.getServiceAsync("CrossApplicationNavigation").then(function(o){var d;if(a!==undefined&&sap.zen.dsh.sapbi_page&&sap.zen.dsh.sapbi_page.appComponent){var e=o.createEmptyAppState(sap.zen.dsh.sapbi_page.appComponent);var f={"selectionVariant":a};e.setData(f);e.save();d=e.getKey();}this.determineValidJumpTargets(o,b,d,C);}.bind(this));}};this.determineAllowedSemanticSources=function(C){this.aAllowedSemanticSources=[];if(C.navigation&&C.navigation.allowed_semantic_sources){var l=C.navigation.allowed_semantic_sources.length;if(l&&l>0){for(var i=0;i<l;i++){this.aAllowedSemanticSources.push(C.navigation.allowed_semantic_sources[i].entry.semanticname);}}}return this.aAllowedSemanticSources;};this.determineValidJumpTargets=function(C,p,A,o){this.aValidJumpTargets=[];var l=[];this.aAllowedSemanticSources.forEach(function(s){l.push([{semanticObject:s,params:p,ignoreFormFactor:false,ui5Component:sap.zen.dsh.sapbi_page.appComponent,appStateKey:A,compactIntents:false}]);});var d=C.hrefForAppSpecificHash("");if(d){var e=d.indexOf("?");d=d.substring(0,e>0?e:d.length-2);}var f=[];C.getLinks(l).done(function(g){g.forEach(function(a){a[0].forEach(function(b){if(b.text&&b.intent&&b.intent!==d&&b.intent.indexOf(d+"?")!==0){f.push(b);}});});f.sort(function(a,b){return a.text.localeCompare(b.text);});if(f&&f.length>0){for(var i=0;i<f.length;++i){var h=f[i];t.aValidJumpTargets.push({"text":h.text,"hash":h.intent});}}t.sendJumpTargetsToRuntime(o.onjumptargetsfetchedcommand);});};this.createSelectionVariantObject=function(C){if(!C){return;}var l={};var a=this.getSelectOptions(C);if(a!==undefined){l.SelectOptions=a;l.SelectionVariantID=new Date().toISOString();l.Text="Temporary Variant "+l.SelectionVariantID;return l;}};this.getSelectOptions=function(C){var l={};var a=[];this.addSelectOptionsFromArray(C.selections,l);this.addSelectOptionsFromArray(C.filter,l);this.addSelectOptionsFromArray(C.variables,l);for(var b in l){if(Object.prototype.hasOwnProperty.call(l,b)){a.push({"PropertyName":b,"Ranges":l[b]});}}if(a.length>0){return a;}};this.addSelectOptionsFromArray=function(s,S){if(s){var l=s.length;if(l>0){for(var i=0;i<l;i++){var n=s[i].dimension.name;if(n&&n.length>0&&!Object.prototype.hasOwnProperty.call(S,n)){if(s[i].dimension.selection){S[n]=[{"Sign":"I","Option":"EQ","Low":s[i].dimension.selection,"High":null}];}else if(s[i].dimension.selections&&s[i].dimension.selections.length>0){S[n]=s[i].dimension.selections.map(function(a){if(a.LowType!=="DATE"){return a;}var b={};for(var d in a){if(Object.prototype.hasOwnProperty.call(a,d)){b[d]=(d==="Low"||d==="High")&&a[d]?a[d]+"T00:00:00.000Z":a[d];}}return b;});}}}}}};this.addNameSelectionPairFromArray=function(a,p){var n,s,S;if(a&&p){var l=a.length;if(l>0){for(var i=0;i<l;i++){n=a[i].dimension.name;if(n&&n.length>0&&!p[n]){s=a[i].dimension.selection;if(s&&s.length>0){p[n]=s;}else{S=a[i].dimension.selections;if(S&&S.length===1&&S[0].Sign&&S[0].Sign==="I"&&S[0].Option&&S[0].Option==="EQ"){p[n]=S[0].Low==="#"?"":S[0].Low;if(S[0].LowType==="DATE"){p[n]=p[n]+"T00:00:00.000Z";}}}}}}}};this.sendJumpTargetsToRuntime=function(o){if(o&&o.length>0){var l=JSON.stringify(this.aValidJumpTargets);l=encodeURI(l);var a=t.prepareCommand(o,"__JUMPTARGETS__",l);var b=new Function(a);b();}};this.getDefaultProxyClass=function(){return["sap.m.Button","sap.ui.commons.Button"];};this.getType=function(){return"fiorihelper";};};var c=new F();B.dispatcher.addHandlers(c.getType(),c);return c;});
