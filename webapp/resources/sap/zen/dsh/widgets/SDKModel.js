/*
 * SAPUI5
  (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["jquery.sap.global","sap/zen/dsh/utils/BaseHandler","sap/zen/dsh/widgets/databuffer","sap/ui/model/ClientModel","sap/ui/model/ClientListBinding"],function(jQuery,BaseHandler,DataBuffer,ClientModel,ClientListBinding){"use strict";var SDKModel=ClientModel.extend("sap.zen.dsh.widgets.SDKModel",{constructor:function(d){ClientModel.apply(this,arguments);if(d&&typeof d=="object"){this.setData(d);}},metadata:{}});SDKModel.prototype.setData=function(d){this.buffer=new DataBuffer(null,d);this.checkUpdate();};SDKModel.prototype._getSelections=function(p,c){var s=this._getObject(p,c);if(isSelection(s)){var m=[],i;for(i=0;i<s.length;i++){if(s[i]===undefined){m[i]=[-1];}else{m[i]=s[i];}}var r=this.buffer.fetchData(m,{includeTuples:true,includeResults:true});var S=[];for(i=0;i<r.tuples.length;i++){var t=r.tuples[i];var n=[];n.isSelection=true;for(var j=0;j<t.length;j++){if(s[j]===null||s[j]===false){n[j]=[t[j]];}else{n[j]=s[j];}}S.push(n);}return S;}else{return s;}};function intersectSelections(p,c){if(!p)return c;var r=[];r.isSelection=true;for(var i=0;i<c.length;i++){if(c[i]===undefined)r[i]=p[i];else r[i]=c[i];}return r;}SDKModel.prototype._parsePart=function(sPath){if(sPath.indexOf(":")===-1){return null;}if(sPath.charAt(0)==="/"){sPath=sPath.substring(1);}sPath=sPath.replace(/%2F/g,"/");var sel=eval("({"+sPath+"})");var result=this.buffer.getIndexSelection(sel);result.isSelection=true;return result;};function isSelection(o){return o&&o.isSelection===true;}SDKModel.prototype._getObject=function(p,c){if(p==="/dimensions"){return this.buffer.buffer.dimensions;}var a=null;var s=p.lastIndexOf("/");if(s>0){var b=p.substring(0,s);p=p.substring(s+1);a=this._getObject(b,c);}else if(s===-1&&!c){return null;}else if(c){a=c.oSelection;}var d;if(p==="value"){d=this.buffer.fetchData(a,{includeData:true,includeResults:true});return d.data[0];}if(p==="formattedValue"){d=this.buffer.fetchData(a,{includeFormattedData:true,includeResults:true});return d.formattedData[0];}if(p==="format"){d=this.buffer.fetchData(a,{includeConditionalFormats:true,includeResults:true});return d.conditionalFormatValues[0];}var e=this._parsePart(p);if(e!=null){return intersectSelections(a,e);}if(isSelection(a)){var f=_findByKey(this.buffer.buffer.dimensions,p);if(f!==-1&&a){return this.buffer.buffer.dimensions[f].members[a[f]];}}if(a&&!isSelection(a)){if(Array.isArray(a)&&a[p]===undefined){p=_findByKey(a,p);}return a[p];}return null;};function _findByKey(a,k){k=k.replace(/%2F/g,"/");for(var i=0;i<a.length;i++){var e=a[i];if(e.key===k){return i;}if(k==="(MEASURES_DIMENSION)"&&e.containsMeasures){return i;}}return-1;}SDKModel.prototype.getProperty=function(p,c){return this._getObject(p,c);};SDKModel.prototype.bindList=function(p,c,s,f,P){var b=new sap.zen.model.SDKListBinding(this,p,c,s,f,P);return b;};SDKModel.prototype.bindProperty=function(p,c,P){var b=new sap.zen.model.SDKPropertyBinding(this,p,c,P);return b;};var SDKListBinding=ClientListBinding.extend("sap.zen.dsh.widgets.SDKListBinding");SDKListBinding.prototype.getContexts=function(s,l){if(!s){s=0;}if(!l){l=Math.min(this.iLength,this.oModel.iSizeLimit);}var e=Math.min(s+l,this.aIndices.length);var c,C=[],p=this.oModel.resolve(this.sPath,this.oContext);if(p&&!jQuery.sap.endsWith(p,"/")){p+="/";}for(var i=s;i<e;i++){c=this.oModel.getContext(p+this.aIndices[i]);c.oSelection=this.oList[i];C.push(c);}return C;};SDKListBinding.prototype.update=function(){this.oList=this.oModel._getSelections(this.sPath,this.oContext);if(!this.oList){this.oList=[];}this.updateIndices();this.applyFilter();this.applySort();this.iLength=this._getLength();};SDKListBinding.prototype.checkUpdate=function(f){var l=this.oModel._getObject(this.sPath,this.oContext);if(!jQuery.sap.equal(this.oList,l)||f){this.update();this._fireChange({reason:sap.ui.model.ChangeReason.Change});}};var SDKPropertyBinding=sap.ui.model.ClientPropertyBinding.extend("sap.zen.dsh.widgets.SDKPropertyBinding");SDKPropertyBinding.prototype.setValue=function(){};SDKPropertyBinding.prototype.checkUpdate=function(f){var v=this._getValue();if(!jQuery.sap.equal(v,this.oValue)||f){this.oValue=v;this._fireChange({reason:sap.ui.model.ChangeReason.Change});}};return SDKModel;});
