/*
 * SAPUI5
  (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define("sap/zen/dsh/rsrt/controller/App.controller",["jquery.sap.global","sap/ui/core/mvc/Controller","sap/zen/dsh/utils/ErrorHandler","sap/m/MessageToast","sap/zen/dsh/utils/TokenHelper","sap/zen/dsh/NavigationCommandType","sap/zen/commons/thirdparty/lodash"],function(q,C,E,M,T,N,_){"use strict";function a(b){if(typeof(b)!=="object"){throw new Error("Invalid date");}var d=b.getDate();var m=b.getMonth()+1;var y=b.getFullYear();return""+y+"-"+(m<=9?"0"+m:m)+"-"+(d<=9?"0"+d:d);}C.extend("sap.zen.dsh.rsrt.controller.App",{displayMessages:function(e){var s=e.getSource();this.getOwnerComponent().getMsg().openBy(s);},onClusterPress:function(){this.getView().byId("ChartView").byId("Map")[this.getView().getModel().getProperty("/mapCluster")?"cluster":"uncluster"]();},onVariantSave:function(e){var t=this;var k=e.getParameter("key");var n=e.getParameter("name");var v=t.getView().getModel("settings").getProperty("/variants");var V=_.find(v,function(o){return o.key===k;});if(!V){V={key:k,name:n,appState:t.getOwnerComponent().Utilities.serialize()};v.push(V);}else{V.name=n;V.appState=t.getOwnerComponent().Utilities.serialize();}t.getView().getModel("settings").setProperty("/variants",v);return t.getOwnerComponent().Utilities.persistPersonalization().catch(E.handleWithPopUp);},onVariantSet:function(e){var t=this;var k=e.getParameter("key");var v=_.find(t.getView().getModel("settings").getProperty("/variants"),function(o){return o.key===k;});t.getOwnerComponent().Utilities.deserialize(v?v.appState:null).then(function(){return t.onRefresh();});},onVariantManage:function(e){var t=this;var v=t.getView().getModel("settings").getProperty("/variants");var d=_.reduce(e.getParameter("deleted"),function(D,s){D[s]=true;return D;},{});var r=_.reduce(e.getParameter("renamed"),function(D,o){D[o.key]=o.name;return D;},{});v=_.filter(v,function(o){return!d[o.key];});v=_.map(v,function(o){if(r[o.key]){o.name=r[o.key];}return o;});t.getView().getModel("settings").setProperty("/variants",v);t.getOwnerComponent().Utilities.persistPersonalization().catch(E.handleWithPopUp);},onFIChange:function(e){var s=e.getSource();if(s.getMaxTokens()!=1){var t=T.stringToTokens(e.getParameter("newValue"));_.forEach(t,function(o){s.addToken(o);});}else{s.removeAllTokens();s.addToken(T.stringToToken(e.getParameter("newValue")));}s.setValue(null);},onDateChange:function(e){var m=e.getSource().getParent().getItems()[1];m.removeAllTokens();var d=new Date(e.getSource().getDateValue());m.addToken(T.stringToToken(a(d)));},onDateRangeChange:function(e){var m=e.getSource().getParent().getItems()[1];m.removeAllTokens();var d=new Date(e.getSource().getDateValue());var b=new Date(e.getSource().getSecondDateValue());m.addToken(T.stringToToken(a(d)+" - "+a(b)));},onFilterItemChanged:function(){return null;},onExportExcel:function(){function d(f,b){var n="navigator";if(window[n].msSaveBlob){window.navigator.msSaveBlob(new window.Blob([b]),f);}else{var g=document.createElement("a");g.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(b));g.setAttribute("download",f);g.style.display="none";document.body.appendChild(g);g.click();document.body.removeChild(g);}}function e(s,S){d(s+".svg",S);}var t=this;var i=t.getView().getModel().getProperty("/innerTab");var c=t.getView().getModel().getProperty("/chartType");if(i==="chart"&&c!=="map"){e(t.getView().getModel("om").getDataProvider("0").QueryTitle,t.getView().byId("ChartView").byId("idVizFrame").exportToSVGString());}else{t.getView().setBusy(true);t.getView().getModel("om").exportToExcel("DataDownload.xlsx").catch(E.handleWithPopUp).then(function(){t.getView().setBusy(false);});}},onBeforeRendering:function(){var u=this.getOwnerComponent().Utilities;u&&u.adjustFilterBar();},submitVariables:function(){var t=this;var v=this.getView();var O=v.getModel("om");v.setBusy(true);Promise.resolve(null).then(function(){O.clearMessages();_.forEach(v.byId("VariableBar").getFilterGroupItems(),function(f){var m=f.getControl().getItems()[1];var r=_.map(m.getTokens(),T.tokenToRange);O.setVariableValue(f.getName(),r);});return v.getModel("om").submitVariables();}).then(function(){_.forEach(v.byId("VariableBar").getFilterGroupItems(),function(f){var V=O.getProperty("/variables/"+encodeURIComponent(f.getName()));var m=f.getControl().getItems()[1];var d=f.getControl().getItems()[2];var D=f.getControl().getItems()[0];m.removeAllTokens();_.forEach(V.MemberFilter,function(o){m.addToken(T.rangeToToken(o));if(d.getVisible()){d.setDateValue(T.datsToDate(o.Low));}else if(D.getVisible()){D.setDateValue(T.datsToDate(o.Low));D.setSecondDateValue(T.datsToDate(o.High));}});});if(_.some(O.getProperty("/messages"),function(o){return o.Severity==="Error";})){t.getOwnerComponent().getMsg().openBy(t.getView().byId("msgBtn"));}else{return O.synchronize();}return null;}).then(t.getOwnerComponent().Utilities.saveAppState).catch(E.handleWithPopUp).then(function(){v.setBusy(false);}).then(function(){if(_.some(O.getProperty("/messages"),function(o){return o.Severity==="Error";})){setTimeout(function(){t.getOwnerComponent().getMsg().openBy(t.getView().byId("msgBtn"));},150);}});},onNavStarted:function(e){var t=this;t.getView().setBusy(e.getParameter("navigationCmdType")!==N.CellClick);var O=t.getView().getModel("om");O.clearMessages();return Promise.resolve(null).then(e.getParameter("cmd")).then(function(){if(sap.ushell&&sap.ushell.Container){sap.ushell.Container.setDirtyFlag(false);}}).then(function(){if(_.some(O.getProperty("/dataProvider/0/Messages"),function(o){return o.type==="Error";})){t.getOwnerComponent().getMsg().openBy(t.getView().byId("msgBtn"));}}).then(t.getOwnerComponent().Utilities.saveAppState).catch(E.handleWithPopUp).then(function(){t.getView().setBusy(false);});},filterDialogBO:function(e){var t=this;var s=e.getSource();var d=s.getFilterDialogContent()?s.getFilterDialogContent()[0].getParent():null;t._FilterDlg=d;},onResetBuffer:function(){var t=this;t.getView().setBusy(true);var d=t.getView().getModel("om").getDataProvider("0");t.getView().getModel("om").resetBuffer().then(function(){d.synchronize();}).then(function(){M.show(t.getView().getModel("i18n").getResourceBundle().getText("Buffer_cleared"));}).catch(E.handleWithPopUp).then(function(){t.getView().setBusy(false);});},onSaveBuffer:function(){var t=this;t.getView().setBusy(true);var d=t.getView().getModel("om").getDataProvider("0");d.synchronize().then(function(){return t.getView().getModel("om").saveBuffer();}).then(function(){return d.synchronize();}).then(function(){M.show(t.getView().getModel("i18n").getResourceBundle().getText("Buffer_saved"));}).catch(E.handleWithPopUp).then(function(){t.getView().setBusy(false);});},gotoLayout:function(){var t=this;t.getView().getModel().setProperty("/innerTab","layout");},gotoConditions:function(){var t=this;t.getView().getModel().setProperty("/innerTab","conditions");},gotoExceptions:function(){var t=this;t.getView().getModel().setProperty("/innerTab","exceptions");},gotoChart:function(){var t=this;t.getView().getModel().setProperty("/innerTab","chart");},gotoData:function(){var t=this;t.getView().getModel().setProperty("/innerTab","data");},shareActions:function(e){var t=this;var g=q.sap.getObject("sap.ushell.Container.getUser");t.getView().getModel().setProperty("/jamVisible",!!g&&g().isJamActive());var s=e.getSource();t.getOwnerComponent().getASShare().openBy(s);},furtherActions:function(e){this.getOwnerComponent().getASFA().openBy(e.getSource());},onNewLines:function(){var t=this;t.getView().byId("PivotTable").createNewLines().catch(E.handleWithPopUp);},onSettings:function(){var t=this;t.getView().getModel("om").getDataProvider(0).openAxisDialog().then(function(b){return b&&t.getView().getModel("om").getDataProvider(0).getResultSet();}).catch(E.handleWithPopUp).then(function(){t.getView().setBusy(false);});},onOpen:function(){var t=this;return t.getView().getModel("om").openQueryDialog().catch(E.handleWithPopUp);},onCurrencyTranslation:function(){var t=this;var d=t.getView().getModel("om").getDataProvider("0");d.openCurrencyTranslationDialog().then(function(b){return b&&d.getResultSet();}).catch(E.handleWithPopUp);},onRefresh:function(){var t=this;if(sap.ushell&&sap.ushell.Container){sap.ushell.Container.setDirtyFlag(false);}t.getView().setBusy(true);t.getView().byId("PivotTable").invalidate();t.getView().getModel("om").synchronize().catch(E.handleWithPopUp).then(function(){t.getView().setBusy(false);});},onSubmitGeoFilter:function(){M.show("Not implemented yet");},clearGeoFilter:function(){M.show("Not implemented yet");},onSetGeoFilter:function(){M.show("Not implemented yet");},onSetGeoFilter2:function(){M.show("Not implemented yet");},onSelectRegion:function(){M.show("Not implemented yet");},onGeoDimChange:function(){M.show("Not implemented yet");},onChartProperties:function(){var t=this;t.getOwnerComponent().getChartSettings().openDialog(t.getView().byId("ChartView").getController()).then(function(){t.byId("ChartView").getController().updateChart();}).catch(E.handleWithPopUp);},onShowGraph:function(){var t=this;t.getOwnerComponent().getGraphDialog().openDialog();},gotoGraph:function(){var t=this;t.getView().getModel().setProperty("/innerTab","graph");},gotoMap:function(){var t=this;t.getView().getModel().setProperty("/innerTab","map");},onValueHelpRequest:function(e){var t=this;var v=this.getView();var s=e.getSource();var O=v.getModel("om");var f=_.find(v.byId("VariableBar").getFilterGroupItems(),function(o){return o.getControl().getItems()[1]==s;});var V=f.getName();v.setBusy(true);Promise.resolve(null).then(function(){return O.openVariableSelector(V,true);}).then(function(b){if(s.getMaxTokens()===1&&b&&b.length){s.removeAllTokens();}_.forEach(b,function(o){s.addToken(o);});}).catch(E.handleWithPopUp).then(function(){t.getView().setBusy(false);});},onOpenEclipse:function(){M.show("Not implemented yet");},onBack:function(){var t=this;t.getView().setBusy(true);t.getView().getModel("om").undo().catch(E.handleWithPopUp).then(function(){t.getView().setBusy(false);});},onBackToStart:function(){M.show("Not implemented yet");},onVariablePrompt:function(){this.getView().getModel("om").getDataProvider(0).variablePrompt().catch(E.handleWithPopUp);},onExecuteFunction:function(e){var t=this;t.getView().setBusy(true);t.getView().getModel("om").processService(e.getSource().data().name).then(function(m){t.getView().getModel("om").addMessages(m);}).catch(E.handleWithPopUp).then(function(){t.getView().setBusy(false);});},onCreateFunction:function(){var t=this;t.getView().getModel("om").openSelectFunction().then(function(p){if(p){t.getView().getModel("om").addFunction(p.Name,p.Text);}}).then(function(){return t.getOwnerComponent().Utilities.saveAppState();}).catch(E.handleWithPopUp).then(function(){t.getView().setBusy(false);});},onFunctionPress:function(){var t=this;if(t.getView().getModel().getProperty("/functionsVisible")===true){t.getView().getModel().setProperty("/filterVisible",false);}},onFilterPress:function(){var t=this;if(t.getView().getModel().getProperty("/filterVisible")===true){t.getView().getModel().setProperty("/functionsVisible",false);}},onCreateCond:function(){var t=this;t.getView().getModel("om").getDataProvider(0).openConditionDialog().then(function(b){return b&&t.getView().getModel("om").getDataProvider(0).getResultSet();}).catch(E.handleWithPopUp).then(function(){t.getView().setBusy(false);});},onCreateExcept:function(){var t=this;t.getView().getModel("om").getDataProvider(0).openExceptionDialog().then(function(b){return b&&t.getView().getModel("om").getDataProvider(0).getResultSet();}).catch(E.handleWithPopUp).then(function(){t.getView().setBusy(false);});},applyConditions:function(){var t=this;t.getView().setBusy(true);this.getView().getModel("om").getResultSet().catch(E.handleWithPopUp).then(function(){t.getView().setBusy(false);});}});return sap.zen.dsh.rsrt.controller.App;});
