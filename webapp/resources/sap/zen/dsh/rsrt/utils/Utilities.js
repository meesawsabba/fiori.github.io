/*
 * SAPUI5
  (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define("sap/zen/dsh/rsrt/utils/Utilities",["sap/base/Log","sap/ui/core/Component","sap/zen/dsh/utils/TokenHelper","sap/zen/dsh/ValueType","sap/ui/core/routing/HashChanger","sap/ui/core/Fragment","sap/zen/dsh/rsrt/controller/AxisAction.controller","sap/zen/dsh/utils/ResourceBundle","sap/zen/dsh/olap/OlapModel","sap/zen/commons/thirdparty/lodash","sap/ushell/library"],function(L,C,T,V,H,F,A,R,O,_){"use strict";var h=new H();var U=function(c){var t=this;function g(o,s){return Array.isArray(o[s])?o[s][0]:o[s];}var a=null;var S=false;t.readComponentData=function(){a=(function(){if(!S&&c.getComponentData()&&c.getComponentData().startupParameters){var s=c.getComponentData().startupParameters;S=true;return{name:g(s,"name"),systemName:g(s,"systemName"),systemType:g(s,"systemType"),package:g(s,"package"),schema:g(s,"schema"),host:g(s,"host"),type:g(s,"type"),port:g(s,"port"),path:g(s,"path"),protocol:g(s,"protocol")||(window.location.protocol==="http:"?"HTTP":"HTTPS")};}else{return{name:c.getDataSourceName(),systemName:c.getSystemName(),systemType:c.getSystemType(),package:c.getPackageName(),schema:c.getSchemaName(),host:c.getHost(),type:c.getDataSourceType(),port:c.getPort(),path:c.getPath(),protocol:c.getProtocolType()||(window.location.protocol==="http:"?"HTTP":"HTTPS")};}}());};t.attachFragments=function(){return c.runAsOwner(function(){return Promise.all(_.map([{name:"sap.zen.dsh.rsrt.fragments.Messages",controller:c.getRootControl().getController()},{name:"sap.zen.dsh.rsrt.fragments.Share",controller:c.getRootControl().getController()},{name:"sap.zen.dsh.rsrt.fragments.ASFA",controller:c.getRootControl().getController()},{name:"sap.zen.dsh.rsrt.fragments.AxisActionMenu",controller:A},{name:"sap.zen.dsh.rsrt.fragments.ChartSettings",controller:{onApply:function(){c.getChartSettings()._prom.resolve(c.getChartSettings()._updater);},onOk:function(){c.getChartSettings()._prom.resolve(c.getChartSettings()._updater);c.getChartSettings().close();}}}],F.load));}).then(function(f){c.getMsg=_.constant(f[0]);c.getASShare=_.constant(f[1]);c.getASFA=_.constant(f[2]);c.getAxisActionMenu=_.constant(f[3]);c.getChartSettings=_.constant(f[4]);c.getChartSettings().openDialog=function(u){function D(){var t=this;function b(r,d){t.resolve=r;t.reject=d;}t.promise=new Promise(b);}c.getChartSettings()._prom=new D();c.getChartSettings()._updater=u;c.getChartSettings().open();return c.getChartSettings()._prom.promise;};_.forEach(f,function(o){c.getRootControl().addDependent(o);});});};t.adjustLandscape=function(){if(a.systemType){c.getModel("om").addSystem(a);}};t.getPersonalizer=function(){if(!sap.ushell.Container){return{getPersData:_.constant(null)};}var p=sap.ushell.Container.getService("Personalization");var s={keyCategory:p.constants.keyCategory.FIXED_KEY,writeFrequency:p.constants.writeFrequency.LOW,clientStorageAllowed:true};if(!c.getComponentData().startupParameters.query&&!c.getComponentData().startupParameters.package){return{getPersData:_.constant(null)};}var P={container:"sap.zen.dsh.rsrt",item:["system:","[",(a.systemName||""),"]",a.type||"query:","[",a.schema||"","][",a.package||"","][",a.name,"]"].join(".")};return p.getPersonalizer(P,s,c);};t.handleFexAnalysis=function(){if(window.___sapfinFlexAnal){var o={isFlex:true,om:{DataProvider:{},semanticStyles:window.___sapfinFlexAnal.om.semanticStyles}};o.om.DataProvider["0"]=window.___sapfinFlexAnal.om.DataProvider[window.___sapfinFlexAnal.dpName];delete window.___sapfinFlexAnal;return o;}return false;};t.openFlexAnalyis=function(d){if(d.isFlex){return c.getModel("om").deserialize(d.om).then(function(){return c.getModel("om").submitVariables();}).then(function(){return c.getModel("om").synchronize();});}else{return Promise.resolve(false);}};t.determineDataSource=function(){return t.loadAppState().then(function(b){if(b){return b;}return t.handleFexAnalysis(t);}).then(function(b){if(b){return b;}return a.name?a:c.getModel("om").openQueryDialog();});};t.adjustTitle=function(){if(sap.ushell.Container){return c.getService("ShellUIService").then(function(s){var d=c.getModel("om").getDataProvider(0);if(d&&s){s.setTitle(R.getText("PREVIEW",[c.getModel("om").getDataProvider(0).QueryTitle]));}}).then(function(){c.getRootControl().getModel().setProperty("/hasShellContainer",true);}).catch(function(e){L.info("No Shell Service");L.debug(e);});}return null;};t.loadDataSource=function(d){if(d instanceof O){return d;}if(!d){throw new Error(R.getText("NO_DATASOURCE_SPECIFIED"));}return t.openFlexAnalyis(d).then(function(b){return b||c.getModel("om").addQuery("0",d.name,d.systemName,d.package,d.schema,d.type);});};t.terminateApplication=function(e){L.error(e);c.getRootControl().setBusy(false);if(sap.ushell.Container){sap.ushell.Container.getService("CrossApplicationNavigation").toExternal({target:{semanticObject:"Shell",action:"home"},params:{},writeHistory:true});}};t.adjustFilterBar=function(){var v=c.getRootControl();var b=c.getModel("om");var s=c.getComponentData()?c.getComponentData().startupParameters:{};c.getModel().setProperty("/showGraph",!!g(s,"showGraph"));c.getModel().setProperty("/showMap",!!g(s,"showMap"));_.forEach(v.byId("VariableBar").getFilterGroupItems(),function(f){var d=b.getProperty("/variables/"+encodeURIComponent(f.getName()));f.setMandatory(d.Mandatory);var i=f.getControl().getItems();var m=i[1];var D=i[0];var e=i[2];m.setVisible(d.ValueType!==V.Date);D.setVisible(d.ValueType===V.Date&&d.SupportsMultipleValues);e.setVisible(d.ValueType===V.Date&&!d.SupportsMultipleValues);if(e.getVisible()){_.forEach(d.MemberFilter,function(o){e.setDateValue(T.datsToDate(o.Low));});}if(D.getVisible()){_.forEach(d.MemberFilter,function(o){D.setDateValue(T.datsToDate(o.Low));D.setSecondDateValue(T.datsToDate(o.High));});}m.setShowValueHelp(d.SupportsValueHelp);m.setMaxTokens(d.SupportsMultipleValues?100:1);m.removeAllTokens();_.forEach(d.MemberFilter,function(o){m.addToken(T.rangeToToken(o));});});};t.executeDataSourceIfPossible=function(){A.connectToView(c.getRootControl());var d=c.getModel("om").getDataProvider(0);c.getModel().setProperty("/showHeader",d.HasVariables);c.getModel().setProperty("/filterVisible",d.HasVariables);return!c.getModel("om").getProperty("/FlatVariables").length&&d.getResultSet();};t.serialize=function(){return{main:_.clone(c.getModel().getData()),om:c.getModel("om").serialize(),};};t.deserialize=function(o){if(!o){return Promise.resolve(null);}c.getModel().setData(o.main);return c.getModel("om").deserialize(o.om);};t.updateVariants=function(p){c.getModel("settings").setProperty("/variants",p?p.variants||[]:[]);};t.getPersData=function(){return t.getPersonalizer().getPersData();};t.persistPersonalization=function(){return Promise.resolve(t.getPersonalizer().setPersData(c.getModel("settings").getData()));};(function(){var p=c.getModel("om").dataLoaded().then(function(){return c.rootControlLoaded();}).then(function(){return c.getRootControl().loaded();}).then(t.attachFragments);t.initComp=function(){return p;};}());t.loadAppState=function(){var s=h.getHash();var m=s.match(/\/sap-iapp-state=(.+)(&|$)/);return(!m)?Promise.resolve(false):Promise.resolve(sap.ushell.Container.getService("CrossApplicationNavigation").getAppState(c,m[1])).then(function(o){var b=o.getData();return b?t.deserialize(b):false;});};t.saveAppState=function(s){if(!sap.ushell.Container){return Promise.resolve(null);}var o=sap.ushell.Container.getService("CrossApplicationNavigation").createEmptyAppState(c,!s);o.setData(t.serialize());return Promise.resolve(o.save()).then(function(){var b=h.getHash();var m=b.match(/\/sap-iapp-state=(.+)(&|$)/);h.replaceHash(m?b.replace(m[1],o.getKey()):[b,"&/sap-iapp-state=",o.getKey()].join(""));return o.getKey();});};};return U;});
