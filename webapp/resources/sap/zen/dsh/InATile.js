/*!
 * SAPUI5
  (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define("sap/zen/dsh/InATile",["sap/base/Log","jquery.sap.global","sap/zen/dsh/library","sap/ushell/ui/tile/TileBase","sap/zen/dsh/olap/OlapModel","sap/ui/core/format/NumberFormat","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/zen/commons/thirdparty/lodash","sap/zen/dsh/InATileRenderer"],function(L,q,u,C,O,N,F,J,_){"use strict";var I=C.extend("sap.zen.dsh.InATile",{metadata:{properties:{host:{type:"string",},port:{type:"int",defaultValue:443},path:{type:"string"},systemType:{type:"sap.zen.dsh.SystemType"},systemName:{type:"string",defaultValue:"localAbapAnalyticEngine"},protocolType:{type:"sap.zen.dsh.ProtocolType",},client:{type:"string",},dataSourceName:{type:"string",},dataSourceType:{type:"sap.zen.dsh.DataSourceType",},packageName:{type:"string"},schemaName:{type:"string"},widgetType:{widgetType:"sap.zen.dsh.WidgetType",defaultValue:"pivot"},}},init:function(){function a(n){var b;var c=30;if(isNaN(n)){b=n;}else{var o=N.getFloatInstance({maxFractionDigits:2});var d;var e=Math.abs(n);if(e>=1000000000){d="B";n/=1000000000;}else if(e>=1000000){d="M";n/=1000000;}else if(e>=1000){d="K";n/=1000;}}b=o.format(n);var f=b;var g=f[c-1];c-=(g==="."||g===",")?1:0;f=f.substring(0,c);return[f,d].join(" ");}var t=this;var m=null;t.getMicrochartBar=function(){return m;};C.prototype.init.apply(t,arguments);t.setBusy(true);t.getInit=_.constant(Promise.resolve(F.load({name:"sap.zen.dsh.fragment.MicroBarChart",controller:{press:function(){L.info("Micro Chart Pressed");}}})).then(function(f){t.addDependent(f);m=f;if(t.getWidgetType()!=="pivot"){m.setModel(new J(),"mc");}t.setBusy(true);var p={systemLandsape:t.getSystemType()?[{systemName:t.getSystemName(),systemType:t.getSystemType(),protocolType:t.getProtocolType(),port:t.getPort(),client:t.getClient()}]:null,dataProvider:{"0":{dataSourceName:t.getDataSourceName(),dataSourceType:t.getDataSourceType(),packageName:t.getPackageName(),schemaName:t.getSchemaName(),systemName:t.getSystemName()}}};t.setModel(new O(p),"om");t.setBusy(true);return t.getModel("om").dataLoaded();}).then(function(){var d=t.getModel("om").getDataProvider("0");t.setTitle(d.QueryTitle||d.QueryName);_.forEach(d.FlatDimensions,function(D){d.removeDrilldown(D.Name);});t.setBusy(true);return t.getModel("om").synchronize();}).then(function(){var d=t.getModel("om").getDataProvider("0");if(d.FlatResultSet.length>0){if(t.getWidgetType()==="pivot"){t.setSubtitle(_.map(d.FlatResultSet[0],function(n,s){var M=_.find(d.Measures,function(o){return o.Name===s;});return[(M&&M.Description)||s,a(n)].join(": ");}).join("\n"));}if(d.FlatResultSet.length>1){if(t.getWidgetType()==="pivot"){t.setInfo(_.map(d.FlatResultSet[1],function(n,s){var M=_.find(d.Measures,function(o){return o.Name===s;});return[(M&&M.Description)||s,a(n)].join(": ");}).join("\n"));}else{m.getModel("mc").setData({columns:_.map(d.FlatResultSet,function(o){return _.reduce(o,function(c,n,s){var M=_.find(d.Measures,function(o){return o.Name===s;});return{label:(M&&M.Description)||s,value:n,displayValue:a(n)};},null);})});m.getModel("mc").refresh();t.getModel().refresh();}}}}).then(function(){m.invalidate();t.invalidate();}).catch(function(e){L.error(e);}).then(function(){t.setBusy(false);}));},onAfterRendering:function(){var t=this;var T=q(t.getDomRef()).find(".sapZenDshInATile");T.children().width(T.width()-30);}});return I;});
