/*!
 * (c) Copyright 2010-2019 SAP SE or an SAP affiliate company.
 */
sap.ui.define("sap/zen/crosstab/paging/PageManager",["jquery.sap.global","sap/zen/crosstab/paging/Page","sap/zen/crosstab/paging/PagingConstants","sap/zen/crosstab/paging/RequestHandler","sap/zen/crosstab/paging/CellMerger","sap/zen/crosstab/datahandler/JsonDataHandler"],function(q,P,a,R,C,J){"use strict";q.sap.declare("sap.zen.crosstab.paging.PageManager");sap.zen.crosstab.paging.PageManager=function(c){var j=new J(c);var o=new C(this);var r=null;var p={};var h={};var b=0;var d=0;var s="";var e=0;var f=0;var H=false;var g=[];var k=false;var n=true;var l={};var A={};var m={};var t={};var u={};var v={};var w={};var x={};function y(){B();if(k||n){k=false;n=false;z();}}function z(){var i=c.getDataArea();var N=i.getRenderRowCnt();var O=i.getRenderColCnt();var Q=Math.round(O/d)+1;var V=Math.round(N/b)+1;var S=Math.max(1,Q*V*2);if(r){r.setMaxQueueRequests(S);}}this.enableTimeout=function(i){if(r){r.enableTimeout(i);}};this.getRequestStackSize=function(){var i=-1;if(r){i=r.getMaxQueueRequests();}return i;};this.resizeEvent=function(){k=true;if(r){r.unlimitStack();}};this.checkResponseConsistency=function(i){if(i.pvcheck||i.removeselection){return true;}if(b>0&&d>0){return(i.tilerows===b&&i.tilecols===d);}return true;};this.receiveData=function(i){var N=this.checkResponseConsistency(i);if(N){G(i);var O={};O.iRow=e;O.iCol=f;var Q=null;var S=F();if(S){Q=this.createPage(O);H=true;}else{Q=this.getPage(O);}if(Q){Q.receiveData(i,S);}if(c.getPropertyBag().isDebugMode()){var T=Q.getPosition();var U=T.iRow+"_"+T.iCol;l[U]={};l[U].component=i;}}};function B(){var i=0;var N=null;var O="";for(i=0;i<g.length;i++){N=g[i];if(N){N.removeData();O=N.getPageKey();delete p[O];}}g=[];}c.getRenderEngine().addAfterFinishRenderingHandler(y);this.removeRequest=function(i){g.push(i);};this.getRequestCommandTemplate=function(){return s;};this.removeHeaderTileRequest=function(i,T,N){var O=h[i.getAreaType()];if(O){var Q=O[T];if(Q){var S=q.inArray(N,Q.aRequestingPages);if(S!==-1){Q.aRequestingPages.splice(S,1);if(Q.aRequestingPages.length===0){Q.iStatus=a.PAGE_STATUS_UNKNOWN;}}}}};this.getHeaderTileInfo=function(i,T){return E(i,T);};this.setHeaderTileInfo=function(i,T,N){var O=D(i);O[T]=N;};function D(i){var T=h[i.getAreaType()];if(!T){T={};h[i.getAreaType()]=T;}return T;}function E(i,T){var N=D(i);var O=N[T];if(!O){O={};O.iStatus=a.PAGE_STATUS_UNKNOWN;O.iRefCnt=0;N[T]=O;}return O;}this.ensureCellAvailable=function(i,N,O){var Q=null;var T=a.PAGE_STATUS_UNKNOWN;var S=false;var U=false;var V=i.getAreaType()+"/"+N+"/"+O;if(!A[V]){var W=I(N,O,i);if(W){if(i.isRowHeaderArea()){T=this.getHeaderTileInfo(i,W.iRow).iStatus;S=true;}else if(i.isColHeaderArea()){T=this.getHeaderTileInfo(i,W.iCol).iStatus;S=true;}Q=this.getPage(W);if(S){if(T===a.PAGE_STATUS_UNKNOWN){U=true;}}else{U=!Q;}if(U){Q=this.createPage(W);Q.provideLoadingCells(i);if(!r){r=new R(this);}r.sendPageRequest(Q);}else{if((Q&&Q.getStatus()===a.PAGE_STATUS_LOADED)||T&&T===a.PAGE_STATUS_LOADED){A[V]=true;K(i,N,O);}}}}};this.reset=function(){p={};h={};H=false;if(r){r.reset();}n=true;l={};A={};m={};t={};u={};v={};w={};x={};b=0;d=0;};this.getDataHandler=function(){return j;};this.getTileRowCnt=function(){return b;};this.getTileColCnt=function(){return d;};this.getPageKeyFromPos=function(i){return this.getPageKeyFromRowCol(i.iRow,i.iCol);};this.getPageKeyFromRowCol=function(i,N){return i+"/"+N;};this.getPagePosFromKey=function(i){var N={};var O=i.split("/");N.iRow=parseInt(O[0],10);N.iCol=parseInt(O[1],10);return N;};this.getCrosstab=function(){return c;};this.createPage=function(i){var N=null;var O=this.getPageKeyFromPos(i);if(O){N=new P(i,O,this);p[O]=N;}return N;};this.getPage=function(i){return this.getPageFromRowCol(i.iRow,i.iCol);};this.getPageFromRowCol=function(i,N){var O=null;var Q=this.getPageKeyFromRowCol(i,N);if(Q){O=p[Q];}return O;};this.getCellMerger=function(){return o;};function F(){return(e===0&&f===0)||!H;}function G(i){b=i.tilerows;d=i.tilecols;s=i.scrollaction;e=i.v_pos;if(e){e=Math.floor(e/b);}else{e=0;}f=i.h_pos;if(f){f=Math.floor(f/d);}else{f=0;}}function I(i,N,O){var Q={iRow:0,iCol:0};if(O.isRowHeaderArea()){Q.iRow=Math.floor(i/b);Q.iCol=Math.floor(c.getColumnHeaderArea().getRenderStartCol()/d);}else if(O.isColHeaderArea()){Q.iRow=Math.floor(c.getRowHeaderArea().getRenderStartRow()/b);Q.iCol=Math.floor(N/d);}else if(O.isDataArea()){Q.iRow=Math.floor(i/b);Q.iCol=Math.floor(N/d);}return Q;}this.getReceivedPages=function(){return JSON.stringify(l);};function K(i,N,O){if(i.isRowHeaderArea()){L(m,N,O);L(t,O,N);}else if(i.isColHeaderArea()){L(u,N,O);L(v,O,N);}else if(i.isDataArea()){L(w,N,O);L(x,O,N);}}function L(i,N,V){if(!i[N]){i[N]=[];}i[N].push(V);}function M(i,N){var O=null;if(i.isDataArea()){O=N?w:x;}else if(i.isRowHeaderArea()){O=N?m:t;}else if(i.isColHeaderArea()){O=N?u:v;}return O;}this.getLoadedCellColumnsByRow=function(i,N){var O=[];var Q=M(i,true);if(Q){O=Q[N];}return O;};this.getLoadedCellRowsByCol=function(i,N){var O=[];var Q=M(i,false);if(Q){O=Q[N];}return O;};this.getPages=function(){return p;};this.isCellLoaded=function(i,N,O){var Q=i.getAreaType()+"/"+N+"/"+O;if(A[Q]){return true;}return false;};};return sap.zen.crosstab.paging.PageManager;});
