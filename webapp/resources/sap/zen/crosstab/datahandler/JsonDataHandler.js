/*!
 * (c) Copyright 2010-2019 SAP SE or an SAP affiliate company.
 */
sap.ui.define(["jquery.sap.global","sap/zen/crosstab/TextConstants","sap/zen/crosstab/utils/Utils","sap/zen/crosstab/rendering/RenderingConstants","sap/zen/crosstab/CrosstabCellApi","sap/zen/crosstab/DataCell","sap/zen/crosstab/HeaderCell","sap/zen/crosstab/CellStyleHandler"],function(q,T,U,R,C,D,H,a){"use strict";q.sap.declare("sap.zen.crosstab.datahandler.JsonDataHandler");sap.zen.crosstab.datahandler.JsonDataHandler=function(c){var d=c.getDimensionHeaderArea();var o=c.getColumnHeaderArea();var r=c.getRowHeaderArea();var b=c.getDataArea();var f=0;var F=0;var t=0;var e=0;var g=false;var h=false;var k=false;var J=null;var l=null;var m=0;var n=0;var p={};var s={};function u(){if(!sap.zen.CrosstabTextCache){sap.zen.CrosstabTextCache={};sap.zen.CrosstabTextCache.filled=false;sap.zen.CrosstabTextCache.oTexts={};sap.zen.CrosstabTextCache.oSortingTextLookupTable={};sap.zen.CrosstabTextCache.defaultProvided=false;}var i=c.getPropertyBag();i.addText(T.ROW_TEXT_KEY,"Row");i.addText(T.COL_TEXT_KEY,"Column");i.addText(T.COLWIDTH_ADJUST_TEXT_KEY,"Double Click to adjust Column Width");i.addText(T.MOBILE_MENUITEM_COLWIDTH_ADJUST_TEXT_KEY,"Adjust Column Width");i.addText(T.MEASURE_STRUCTURE_TEXT_KEY,"Measure Structure");w(i);sap.zen.CrosstabTextCache.defaultProvided=true;}function v(i){if(sap.zen.CrosstabTextCache.filled===false){var j=c.getPropertyBag();if(i){j.addText(T.ROW_TEXT_KEY,i.rowtext||"Row");j.addText(T.COL_TEXT_KEY,i.coltext||"Column");j.addText(T.COLWIDTH_ADJUST_TEXT_KEY,i.colwidthtext||"Double Click to adjust Column Width");j.addText(T.MOBILE_MENUITEM_COLWIDTH_ADJUST_TEXT_KEY,i.mobilemenuitemcolwidthtext||"Adjust Column Width");j.addText(T.MEASURE_STRUCTURE_TEXT_KEY,i.measurestructtext||"Measure Structure");x(i,j);}sap.zen.CrosstabTextCache.filled=true;}}function w(i){var j={};j.alttext="Unsorted. Select to sort ascending";j.tooltipidx=0;i.addSortingTextLookup("0",j);j={};j.alttext="Sorted ascending. Select to sort descending";j.tooltipidx=1;i.addSortingTextLookup("1",j);j={};j.alttext="Sorted descending. Select to sort ascending";j.tooltipidx=2;i.addSortingTextLookup("2",j);}function x(j,Y){var Z=j.sorting;if(!Z){w(Y);}else{var i=0;var $=parseInt(Z.length,10);for(i=0;i<$;i++){var _={};_.alttext=Z[i].alttext;_.tooltipidx=Z[i].tooltipidx;Y.addSortingTextLookup(i+"",_);}}}this.determineBasicAreaData=function(i,j){if(!sap.zen.CrosstabTextCache||(sap.zen.CrosstabTextCache&&!sap.zen.CrosstabTextCache.defaultProvided)){u();}J=i;if(J.rootcause&&J.rootcause==="bookmark"){c.getPropertyBag().setBookmarkProcessing(true);}if(!J.rows){B(J);E();c.setHasData(false);}else{c.setHasData(true);if(j||J.changed){v(J.texts);p={};s={};f=J.fixedcolheaders;F=J.fixedrowheaders;if(!J.pixelscrolling){c.setHCutOff(false);c.setVCutOff(false);t=J.totaldatacols;e=J.totaldatarows;}else{c.setHCutOff(J.totaldatacols>J.sentdatacols);c.setVCutOff(J.totaldatarows>J.sentdatarows);t=J.sentdatacols;e=J.sentdatarows;}if(!f||!F){d.setRowCnt(0);d.setColCnt(0);if(!F){r.setRowCnt(0);r.setColCnt(0);if(f){o.setRowCnt(f);o.setColCnt(t);}}else if(!f){o.setRowCnt(0);o.setColCnt(0);if(F){r.setRowCnt(e);r.setColCnt(F);}}}else{d.setRowCnt(f);d.setColCnt(F);r.setRowCnt(e);r.setColCnt(F);o.setRowCnt(f);o.setColCnt(t);}b.setRowCnt(e);b.setColCnt(t);c.setTotalRows(f+e);c.setTotalCols(F+t);c.setOnSelectCommand(J.onselectcommand);c.getPropertyBag().setDisplayExceptions(J.displayexceptions);c.getPropertyBag().setEnableColResize(J.enablecolresize);c.setScrollNotifyCommand(J.scrollnotifier);c.setUpdateColWidthCommand(J.updatecolwidthcmd);y(i);var Y=new C(c,F,f,t,e);c.setCellApi(Y);}z();if(!(c.getPropertyBag().isMobileMode()||c.getPropertyBag().isTestMobileMode())){if(J.transferdatacommand){c.setTransferDataCommand(J.transferdatacommand);}else{c.setTransferDataCommand(null);}if(J.callvaluehelpcommand){c.setCallValueHelpCommand(J.callvaluehelpcommand);}if(J.newlinescnt){c.setNewLinesCnt(J.newlinescnt);}if(J.newlinespos){c.setNewLinesPos(J.newlinespos);}}if(J.contextmenucmd){c.getPropertyBag().setContextMenuCommand(J.contextmenucmd);c.createContextMenu();}if(J.headerscrolling&&J.headerscrolling==true){c.setHeaderScrollingConfigured(true);if(J.userheaderresize){c.setUserHeaderResizeAllowed(J.userheaderresize);}if(J.userheaderwidthcommand){c.setUserHeaderWidthCommand(J.userheaderwidthcommand);}if(J.headerwidth){c.getPropertyBag().setMaxHeaderWidth(J.headerwidth);}else{c.getPropertyBag().setMaxHeaderWidth(0);}if(J.headerwidthcurrent){c.getPropertyBag().setUserHeaderWidth(J.headerwidthcurrent);}else{c.getPropertyBag().setUserHeaderWidth(0);}}else{c.setHeaderScrollingConfigured(false);c.setUserHeaderResizeAllowed(false);c.setUserHeaderWidthCommand(null);c.getPropertyBag().setMaxHeaderWidth(0);c.getPropertyBag().setUserHeaderWidth(0);}if(J.selectionmode){c.setSelectionProperties(J.selectionmode,J.selectionspace,J.disablehovering,J.singleonselectevent);}var Z=c.getSelectionHandler();if(Z){Z.setSelection(J.selection);}if(J.headerinfo){c.initHeaderInfo(J.headerinfo);}if(J.repeattxt&&J.repeattxt===true){c.getPropertyBag().setRepeatTexts(true);}else{c.getPropertyBag().setRepeatTexts(false);}if(J.dragdropcommands){c.getPropertyBag().setDragDropEnabled(true);c.setDragDropCommands(J.dragdropcommands);}else{c.getPropertyBag().setDragDropEnabled(false);}if(J.zebra){c.getPropertyBag().setZebraMode(J.zebra);}else{c.getPropertyBag().setZebraMode(R.ZEBRA_FULL);}}};function y(j){var Y=j.usercolwidths;if(Y){for(var i=0;i<Y.length;i++){var Z=Y[i];var $=Z.colid;if(isNaN(Z.colwidth)){continue;}var _=Math.max(0,parseInt(Z.colwidth,10));var a1=false;if(Z.ignore!==undefined){a1=Z.ignore;}if($==="*"){if(f&&F){o.setColUserWidth($,_,a1);b.setColUserWidth($,_,a1);d.setColUserWidth($,_,a1);r.setColUserWidth($,_,a1);}else{if(!F){o.setColUserWidth($,_,a1);}else if(!f){r.setColUserWidth($,_,a1);}b.setColUserWidth($,_,a1);}}else{if(f&&F){if($>=F){o.setColUserWidth($-F,_,a1);b.setColUserWidth($-F,_,a1);}else{d.setColUserWidth($,_,a1);r.setColUserWidth($,_,a1);}}else{if(!F){o.setColUserWidth($,_,a1);b.setColUserWidth($,_,a1);}else if(!f){if($>=F){b.setColUserWidth($-F,_,a1);}else{r.setColUserWidth($,_,a1);}}}}}}}function z(){var i=c.getRenderEngine().getCrossRequestManager();if(i){if(J.clienthpos!==undefined&&J.clientvpos!==undefined&&J.clienthscrolledtoend!==undefined&&J.clientvscrolledtoend!==undefined){if(J.clienthscrolledtoend===true){J.clienthpos=J.totaldatacols-1;}if(J.clientvscrolledtoend===true){J.clientvpos=J.totaldatarows-1;}if(!i.hasSavedVScrollInfo()&&!i.hasSavedHScrollInfo()){i.setScrollData(parseInt(J.clienthpos,10),J.clienthscrolledtoend,parseInt(J.clientvpos,10),J.clientvscrolledtoend);}}if(J.rootcause){i.setRootCause(J.rootcause);if(J.rootcause==="hierarchy"){i.setHierarchyAction(J.rootcause_hierarchy);i.setIsHierarchyDirectionDown(J.rootcause_hierarchy_directiondown);}i.handleRootCause();}else{if(J.changed===true){i.setScrollData(0,false,0,false);}}var j=false;if(J.rootcause&&c.getPropertyBag().isBookmarkProcessing()){j=true;}else{if(!J.dataproviderchanged){if(J.resultsetchanged){if(J.rootcause){j=J.rootcause==="sorting"||J.rootcause==="hierarchy"||J.rootcause==="plan"||J.rootcause==="dragdrop";}}else{j=true;}}}if(J.clientheaderhpos&&j){i.setHeaderScrollData({"iHPos":parseInt(J.clientheaderhpos,10)});}else{i.setHeaderScrollData({"iHPos":0});}}}this.jsonToDataModel=function(Y){if(J.rows){l=Y.oCrosstabAreasToBeFilled;m=Y.iColOffset;n=Y.iRowOffset;A();var Z=J.rows;for(var i=0,$=Z.length;i<$;i++){var _=Z[i].row.rowidx;var a1=Z[i].row.cells;for(var j=0,b1=a1.length;j<b1;j++){var c1=a1[j].control;var d1=c1.colidx;G(c1,_,d1);}}}c.setColHeaderHierarchyLevels(p);c.setRowHeaderHierarchyLevels(s);};function A(){g=l[d.getAreaType()];h=l[r.getAreaType()];k=l[o.getAreaType()];}function B(J){d.setRowCnt(2);d.setColCnt(1);var i=O(d,0,0);i.setText(J.messagetitle);d.insertCell(i,0,0);i=O(d,1,0);i.setText(J.messagetext);d.insertCell(i,1,0);}function E(){var i=c.getSelectionHandler();if(i){i.setSelection(null);}}var G=function(j,i,Y){var Z=i-1;var $=Y-1;if(Y>F&&i>f){K(j,Z+n,$+m);}else if(g&&Y<=F&&i<=f){L(j,Z,$);}else if(k&&i<=f&&Y>F){N(j,Z,$+m);}else if(h&&Y<=F&&i>f){M(j,Z+n,$);}};function I(i,j){var Y=new D();Y.setArea(b);Y.setRow(i);Y.setCol(j);Y.addStyle(c.getPropertyBag().isCozyMode()?R.STYLE_DATA_CELL_COZY:R.STYLE_DATA_CELL);return Y;}var K=function(j,i,Y){var Z=i-f;var $=Y-F;var _=I(Z,$);_.setTableRow(i);_.setTableCol(Y);Q(j,_);if(c.getPropertyBag().getZebraMode()!==R.ZEBRA_OFF){if(Z%2===1){_.addStyle(R.STYLE_ALTERNATING);}}b.insertCell(_,Z,$);};var L=function(j,i,Y){P(j,d,i,Y,i,Y);};var M=function(j,i,Y){var Z=i;if(j.axisidx!==undefined){Z=j.axisidx+f;}P(j,r,i-f,Y,Z,Y);};var N=function(j,i,Y){var Z=Y;if(j.axisidx!==undefined){Z=j.axisidx+F;}P(j,o,i,Y-F,i,Z);};function O(i,j,Y){var Z=new H();Z.setArea(i);Z.setRow(j);Z.setCol(Y);Z.addStyle(c.getPropertyBag().isCozyMode()?R.STYLE_HEADER_CELL_COZY:R.STYLE_HEADER_CELL);return Z;}var P=function(j,i,Y,Z,$,_){var a1=O(i,Y,Z);a1.setTableRow($);a1.setTableCol(_);Q(j,a1);S(j,a1,i);if(c.getPropertyBag().isRtl()&&a1.getRow()===c.getDimensionHeaderArea().getRowCnt()-1&&a1.getCol()===c.getDimensionHeaderArea().getColCnt()-1){a1.setText(sap.zen.crosstab.utils.Utils.swapPivotKeyText(a1.getText()));}i.insertCell(a1,Y,Z);};var Q=function(j,Y){var Z=W(j);if(Z){Y.setFormatter(Z);}var $=j._v;if($){var _=sap.zen.crosstab.utils.Utils.prepareStringForRendering($);Y.setText(_.text);Y.setNumberOfLineBreaks(_.iNumberOfLineBreaks);}var a1=j.exceptionvisualizations;if(a1){for(var b1 in a1){if(Object.prototype.hasOwnProperty.call(a1,b1)){var c1=a1[b1];if(c1){a.setExceptionStylesOnCell(Y,c1.formattype,c1.alertlevel);}}}}if(j.isemphasized){Y.addStyle(R.STYLE_EMPHASIZED);}if(!(c.getPropertyBag().isMobileMode()||c.getPropertyBag().isTestMobileMode())){if(j.isdataentryenabled){Y.addStyle(R.STYLE_DATA_ENTRY_ENABLED);Y.setEntryEnabled(true);if(j.unit){Y.setUnit(j.unit);}}if(j.hasinvalidvalue){Y.addStyle(R.STYLE_INVALID_VALUE);}if(j.hasnewvalue){Y.addStyle(R.STYLE_NEW_VALUE);}if(j.islocked){Y.addStyle(R.STYLE_LOCKED);}}if(j.isresult){if(Y.setResult){Y.setResult(j.isresult);}Y.addStyle(R.STYLE_TOTAL);}if(j.passivetype){Y.setPassiveCellType(j.passivetype);}if(j.additionalstyles){for(var i=0;i<j.additionalstyles.length;i++){Y.addStyle(j.additionalstyles[i].style.stylename);}}};var S=function(j,i,Y){if(j.rowspan){i.setRowSpan(j.rowspan);}else{i.setRowSpan(1);}if(j.colspan){i.setColSpan(j.colspan);}else{i.setColSpan(1);}if(j.key){i.setMergeKey(j.key);}if(j.sort){i.setSort(j.sort);}if(j.sorttxtidx){i.setSortTextIndex(parseInt(j.sorttxtidx,10));}if(j.sortaction){i.setSortAction(j.sortaction);}if(j.alignment){i.setAlignment(j.alignment);}if(j.memberid){i.setMemberId(j.memberid);}if(j.parentmemberid){i.setParentMemberId(j.parentmemberid);}if(typeof(j.level)!="undefined"){i.setLevel(j.level);V(Y,i,j.level);}else{i.setLevel(-1);}if(j.drillstate){if(j.drillstate!=="A"){i.setDrillState(j.drillstate);}}if(j.hierarchyaction){i.setHierarchyAction(j.hierarchyaction);}if(j.hierarchytooltip){i.setHierarchyTooltip(j.hierarchytooltip);}if(j.nodeAlignment){i.setNodeAlignment(j.nodeAlignment);}if(c.getPropertyBag().getZebraMode()===R.ZEBRA_FULL){if(Y.isRowHeaderArea()&&i.getRow()%2===1&&i.getRowSpan()===1){var Z=c.getHeaderInfo();if(Z){if((i.getCol()+i.getColSpan()-1)>=Z.getStartColForInnermostDimension()){i.addStyle(R.STYLE_ALTERNATING);}}}}};var V=function(i,j,Y){if(i.getAreaType()===R.TYPE_COLUMN_HEADER_AREA){var Z=j.getRow();if(p[Z]!=undefined){if(p[Z]<Y){p[Z]=Y;}}else{p[Z]=Y;}}else if(i.getAreaType()===R.TYPE_ROW_HEADER_AREA){var $=j.getCol();if(s[$]!=undefined){if(s[$]<Y){s[$]=Y;}}else{s[$]=Y;}}};function W(j){var i;if(j.valueType){var Y=X(j.formatString);var Z;if(j.valueType==="Integer"||j.valueType==="Double"){Z={groupingEnabled:true,maxFractionDigits:j.decimals,pattern:Y,showMeasure:true};i=sap.ui.core.format.NumberFormat.getCurrencyInstance(Z);}else if(j.valueType==="Amount"||j.valueType==="Price"||j.valueType==="Quantity"){Z={groupingEnabled:true,maxFractionDigits:j.decimals,pattern:Y,showMeasure:true};i=sap.ui.core.format.NumberFormat.getCurrencyInstance(Z);}}return i;}function X(i){var j;if(i){j=i;var Y="#(?![#|"+","+"]).(?=#)";var Z=new RegExp(Y,"g");i=i.replace(Z,"#"+",");Y="0(?![0|"+"."+"]).(?=0)";Z=new RegExp(Y,"g");j=j.replace(Z,"0"+".");}return j;}};return sap.zen.crosstab.datahandler.JsonDataHandler;});
