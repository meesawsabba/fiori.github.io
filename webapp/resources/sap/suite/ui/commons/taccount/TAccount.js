sap.ui.define(["sap/suite/ui/commons/library","sap/ui/Device","sap/ui/core/Control","sap/ui/core/delegate/ItemNavigation","./TAccountGroup","./TAccountPanel","sap/ui/core/IconPool","sap/ui/core/Icon","sap/ui/core/InvisibleText","sap/base/security/encodeXML","./TAccountUtils","sap/suite/ui/commons/Utils","sap/ui/thirdparty/bignumber","sap/ui/thirdparty/jqueryui/jquery-ui-core","sap/ui/thirdparty/jqueryui/jquery-ui-widget","sap/ui/thirdparty/jqueryui/jquery-ui-mouse","sap/ui/thirdparty/jqueryui/jquery-ui-draggable","sap/ui/thirdparty/jqueryui/jquery-ui-droppable","sap/ui/thirdparty/jqueryui/jquery-ui-selectable"],function(l,D,C,I,T,a,b,c,d,e,f,U,B){"use strict";var r=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.commons");var g=Object.freeze({UP:"UP",DOWN:"DOWN",PREVIOUS:"PREVIOUS",NEXT:"NEXT"});var s=D.os.macintosh?"metaKey":"ctrlKey";var h=C.extend("sap.suite.ui.commons.taccount.TAccount",{metadata:{library:"sap.suite.ui.commons",properties:{measureOfUnit:{type:"string",group:"Misc",defaultValue:""},collapsed:{type:"boolean",group:"Misc",defaultValue:false},title:{type:"string",group:"Misc",defaultValue:null},subtitle:{type:"string",group:"Misc",defaultValue:null},orderBy:{type:"string",group:"Misc",defaultValue:""},opening:{type:"boolean",group:"Misc",defaultValue:false},openingDebit:{type:"any",group:"Misc",defaultValue:0},openingCredit:{type:"any",group:"Misc",defaultValue:0}},aggregations:{debit:{type:"sap.suite.ui.commons.taccount.TAccountItem",multiple:true,singularName:"debit"},credit:{type:"sap.suite.ui.commons.taccount.TAccountItem",multiple:true,singularName:"credit"}}},renderer:function(R,A){var w=function(k,m){k.forEach(function(n,i){n._bIsDebit=m;n._index=i+1;n._indexSize=k.length;R.renderControl(n);});};var W=function(k){var m=A.getOrderBy();k.forEach(function(n){var P=n.getProperties();n._sOrderBy="";for(var i=0;i<P.length;i++){if(P[i].getKey().toLowerCase()===m.toLowerCase()){n._sOrderBy=P[i].getValue();break;}}});k.sort(function(i,n){return new Date(i._sOrderBy)>=new Date(n._sOrderBy)?1:-1;});A._setItemsAttrs(k);k.forEach(function(i){R.renderControl(i.addStyleClass(i._bIsDebit?"sapSuiteUiCommonsAccountItemLeft":"sapSuiteUiCommonsAccountItemRight"));});};var p=A._getPanel();var j=function(i){var k=i?A.getDebit():A.getCredit(),m=new B(i?A.getOpeningDebit():A.getOpeningCredit());k.forEach(function(n){m=m.plus(new B(n.getValue()));});return f.formatCurrency(m,A.getMeasureOfUnit(),p?p.getMaxFractionDigits():0);};var u=A.getMeasureOfUnit(),o=f.formatCurrency(A.getOpeningDebit(),u,p?p.getMaxFractionDigits():0),O=f.formatCurrency(A.getOpeningCredit(),u,p?p.getMaxFractionDigits():0),H=(A.getDebit().length>0||A.getCredit().length>0);R.write("<div");if(A.getCollapsed()){R.addClass("sapSuiteUiCommonsAccountCollapsed");}R.addClass("sapSuiteUiCommonsAccount");if(!H){R.addClass("sapSuiteUiCommonsAccountEmpty");}R.writeClasses(A);R.writeControlData(A);R.writeAttribute("role","region");R.writeAttribute("aria-describedby",A.getId());R.writeAttributeEscaped("aria-label",A._getAriaLabelText());R.writeAttribute("tabindex","0");R.write(">");R.write("<div class=\"sapSuiteUiCommonsTAccountDropZoneTop\"></div>");R.write("<div class=\"sapSuiteUiCommonsTAccountDropZoneBottom\"></div>");R.write("<div class=\"sapSuiteUiCommonsTAccountInfoIconWrapper sapSuiteUiCommonsTAccountBaseInfoIconWrapper\" aria-labelledby=\""+A.getId()+"-mark-text\" title=\""+r.getText("TACCOUNT_SELECTED")+"\">");R.renderControl(A._getAriaMarkText());R.write("<div class=\"sapSuiteUiCommonsInfoIcon\">");R.write("!");R.write("</div>");R.write("</div>");R.write("<div class=\"sapSuiteUiCommonsAccountHeader\">");R.write("<div class=\"sapSuiteUiCommonsAccountHeaderFirst\">");R.write("<div");R.addClass("sapSuiteUiCommonsAccountHeaderExpandWrapper");R.writeClasses();R.write(">");R.renderControl(A._getDownArrow());R.write("</div>");var t=e(A.getTitle()).replace(/&#xa;|\n/g,"<br>");if(A.getSubtitle()){var S=e(A.getSubtitle()).replace(/&#xa;|\n/g,"<br>");R.write("<div class=\"sapSuiteUiCommonsAccountHeaderTitleWrapper\">");R.write("<div id=\""+A.getId()+"-title"+"\" class=\"sapSuiteUiCommonsAccountHeaderTitleWithSubtitle\">"+t+"</div>");R.write("<div class=\"sapSuiteUiCommonsAccountHeaderSubtitle\">"+S+"</div>");R.write("</div>");}else{R.write("<span id=\""+A.getId()+"-title"+"\" class=\"sapSuiteUiCommonsAccountHeaderTitle\">"+t+"</span>");}R.write("</div>");R.write("<div class=\"sapSuiteUiCommonsAccountHeaderSecond\">");R.write("<span id=\""+A.getId()+"-sum"+"\" class=\"sapSuiteUiCommonsAccountHeaderSUM\">"+A._getSumText()+"</span>");R.write("</div>");R.write("</div>");R.write("<div id=\""+A.getId()+"-content"+"\" class=\"sapSuiteUiCommonsAccountTWrapper\"");if(A.getCollapsed()){R.addStyle("display","none");R.writeStyles();}R.write(">");if(H||A.getOpening()){R.write("<div");R.addClass("sapSuiteUiCommonsAccountTHeader");if(A.getOpening()){R.addClass("sapSuiteUiCommonsAccountTHeaderOpening");}R.writeClasses();R.write(">");R.write("<span id=\""+A.getId()+"-debit-text"+"\" class=\"sapSuiteUiCommonsAccountTHeaderTitle\">"+r.getText("TACCOUNT_DEBIT")+"</span>");R.write("<span id=\""+A.getId()+"-credit-text"+"\" class=\"sapSuiteUiCommonsAccountTHeaderTitle\">"+r.getText("TACCOUNT_CREDIT")+"</span>");R.write("</div>");if(H){if(A.getOpening()){R.write("<div class=\"sapSuiteUiCommonsAccountOpeningHeader\">");R.write("<span id=\""+A.getId()+"-opening-debit-text"+"\" class=\"sapSuiteUiCommonsAccountTHeaderOpeningDebitTitle\">"+o+" "+u+"</span>");R.write("<span id=\""+A.getId()+"-opening-credit-text"+"\" class=\"sapSuiteUiCommonsAccountTHeaderOpeningCreditTitle\">"+O+" "+u+"</span>");R.write("</div>");}R.write("<div class=\"sapSuiteUiCommonsAccountTBody\"");R.writeAttribute("role","listbox");R.write(">");if(A._isOrdered()){R.write("<div class=\"sapSuiteUiCommonsAccountDebitCredit\"");R.writeAttribute("role","listbox");R.writeAttribute("aria-labelledby",A.getId()+"-debit-text "+A.getId()+"-credit-text");R.write(">");R.write("<div class=\"sapSuiteUiCommonsAccountMiddleBorder\"></div>");W(A.getDebit().concat(A.getCredit()));}else{R.write("<div class=\"sapSuiteUiCommonsAccountDebit\"");R.writeAttribute("role","listbox");R.writeAttribute("aria-labelledby",A.getId()+"-debit-text");R.write(">");w(A.getDebit(),true);}R.write("</div>");if(!A._isOrdered()){R.write("<div class=\"sapSuiteUiCommonsAccountCredit\"");R.writeAttribute("role","listbox");R.writeAttribute("aria-labelledby",A.getId()+"-credit-text");R.write(">");w(A.getCredit(),false);R.write("</div>");}R.write("</div>");}}else{R.write("<div class=\"sapSuiteUiCommonsAccountNoData\">");R.write(r.getText("TACCOUNT_NO_DATA"));R.write("</div>");}if(A.getOpening()){R.write("<div class=\"sapSuiteUiCommonsAccountClosingHeaderLine\"></div>");R.write("<div class=\"sapSuiteUiCommonsAccountClosingHeader\">");R.write("<span id=\""+A.getId()+"-closing-debit-text"+"\" class=\"sapSuiteUiCommonsAccountTHeaderOpeningDebitTitle\">"+j(true)+" "+u+"</span>");R.write("<span id=\""+A.getId()+"-closing-credit-text"+"\" class=\"sapSuiteUiCommonsAccountTHeaderOpeningCreditTitle\">"+j(false)+" "+u+"</span>");R.write("</div>");}R.write("</div>");R.write("</div>");}});h.prototype.onBeforeRendering=function(){this._bRendered=false;this._iOldSum=this._iSum;this._iSum=null;};h.prototype.onAfterRendering=function(){var p=this.getParent();this._bRendered=true;this._setupDraggable();this._setupKeyboard();if(p&&this._hasGroupParent(p)){if(!p._bRendered){p.addEventDelegate({onAfterRendering:this._setupTooltips.bind(this)});}if(p._bRendered&&this._iOldSum!=null){var i=this._iSum-this._iOldSum;p._valueChanged(i);}}else{this._setupTooltips();}this.$().find(".sapSuiteUiCommonsAccountGroupCollapseIcon").attr("aria-pressed",!this.getCollapsed());};h.prototype.onsapdownmodifiers=function(E){if(E[s]){this._handleArrowMoveEvent(E,g.DOWN);}};h.prototype.onsapupmodifiers=function(E){if(E[s]){this._handleArrowMoveEvent(E,g.UP);}};h.prototype.onsappreviousmodifiers=function(E){if(E[s]){this._handleArrowMoveEvent(E,g.PREVIOUS);}};h.prototype.onsapnextmodifiers=function(E){if(E[s]){this._handleArrowMoveEvent(E,g.NEXT);}};h.prototype.reset=function(){this._oSum=null;};h.prototype._isOrdered=function(){return!!this.getOrderBy();};h.prototype._setupKeyboard=function(){if(!this._oItemNavigation){this._oItemNavigation=new I();this.addDelegate(this._oItemNavigation);}this._oItemNavigation.setRootDomRef(this.$().find(".sapSuiteUiCommonsAccountTBody")[0]);this._oItemNavigation.setItemDomRefs(this.$().find(".sapSuiteUiCommonsAccountItem"));this._oItemNavigation.setCycling(true);};h.prototype._isInGroup=function(){return this.getParent()instanceof T;};h.prototype._getPanel=function(){if(this._isInGroup()){var p=this.getParent().getParent();if(p instanceof a){return p;}}return null;};h.prototype._setupDraggable=function(){if(this._isInGroup()){var $=this.$(),p=this.getParent();$.draggable({revert:"invalid",delay:100,helper:function(){return $.clone().width($.width()).css("z-index",500);},opacity:0.6,scope:p.getId()+"-content",handle:".sapSuiteUiCommonsAccountHeader",start:function(){$.addClass("sapSuiteUiCommonsAccountItemDragging");p.$().find(".sapSuiteUiCommonsAccountGroupDroppingArea").addClass("sapSuiteUiCommonsAccountGroupDroppingAreaHighlight");p.$().find(".sapSuiteUiCommonsAccountHeader").css("cursor","grabbing");},stop:function(){$.removeClass("sapSuiteUiCommonsAccountItemDragging");p.$().find(".sapSuiteUiCommonsAccountGroupDroppingArea").removeClass("sapSuiteUiCommonsAccountGroupDroppingAreaHighlight");p.$().find(".sapSuiteUiCommonsAccountHeader").css("cursor","grab");}});U._setupMobileDraggable($);}};h.prototype._setItemsAttrs=function(j){j.forEach(function(o,i){o._index=i+1;o._indexSize=j.length;});this.getDebit().forEach(function(i){i._bIsDebit=true;});};h.prototype._getExpandAltText=function(i){return(i?r.getText("TACCOUNT_COLLAPSE"):r.getText("TACCOUNT_EXPAND"))+" "+r.getText("TACCOUNT_TITLE");};h.prototype._getDownArrow=function(){var i=this.getCollapsed();if(!this._oArrowDown){this._oArrowDown=new c({alt:this._getExpandAltText(!i),tooltip:this._getExpandAltText(!i),decorative:false,src:!i?"sap-icon://navigation-right-arrow":"sap-icon://navigation-down-arrow",press:function(){this.setCollapsed(!this.getCollapsed());}.bind(this)}).addStyleClass("sapSuiteUiCommonsAccountGroupCollapseIcon");}this._oArrowDown.$().attr("aria-pressed",!this.getCollapsed());return this._oArrowDown;};h.prototype._getAriaMarkText=function(){if(!this._oMarkText){this._oMarkText=new d({id:this.getId()+"-mark-text",text:r.getText("TACCOUNT_SELECTED")});this.addDependent(this._oMarkText);}return this._oMarkText;};h.prototype._getSum=function(){if(this._iSum==null){var S=new B("0");this.getCredit().forEach(function(i){S=S.plus(new B(i.getValue()));});this.getDebit().forEach(function(i){S=S.minus(new B(i.getValue()));});if(this.getOpening()){S=S.plus(new B(this.getOpeningCredit()));S=S.minus(new B(this.getOpeningDebit()));}this._iSum=S;}return this._iSum;};h.prototype._getAriaLabelText=function(){return this.getTitle()+" "+this._getSumText()+" "+r.getText("TACCOUNT_NAVIGATION");};h.prototype._getSumText=function(){var i=this.getMeasureOfUnit();var v=this._getSum();v=v.isLessThan(0)?v.times(-1):v;var p=this._getPanel();var V=f.formatCurrency(v,i,p?p.getMaxFractionDigits():0);return(this._getSum().isGreaterThan(0)?r.getText("TACCOUNT_CREDIT"):r.getText("TACCOUNT_DEBIT"))+": "+V+" "+e(i);};h.prototype._valueChanged=function(i,j){if(this._bRendered){if(j){this._iSum=this._getSum().minus(i);}else{this._iSum=this._getSum().plus(i);}this.$("sum").text(this._getSumText());var p=this.getParent();if(this._hasGroupParent(p)){p._valueChanged(i,j);}}};h.prototype._hasGroupParent=function(p){return(p||this.getParent())instanceof T;};h.prototype._handleArrowMoveEvent=function(E,o){this._moveTAccount(o);E.preventDefault();E.stopImmediatePropagation();};h.prototype._moveTAccount=function(o){var $,i,j,m,k=o===g.UP,S=true,n=this.$();var M=function(A){if(j.length===0){S=false;return;}n.detach();$.detach();j[A](n);j[A]($);};if(k||o===g.DOWN){m=k?["next","prev","insertBefore","append"]:["prev","next","insertAfter","prepend"];$=n[m[0]](".sapSuiteUiCommonsAccountGroupDroppingArea");i=n[m[1]]()[m[1]](".sapSuiteUiCommonsAccount");if(i.length!==0){n.detach()[m[2]](i);$.detach()[m[2]](i);}else{j=n.parent()[m[1]](".sapSuiteUiCommonsAccountGroupColumn");M(m[3]);}}else{$=n.prev(".sapSuiteUiCommonsAccountGroupDroppingArea");j=n.parent()[o===g.NEXT?"next":"prev"](".sapSuiteUiCommonsAccountGroupColumn");M("append");}if(S){n.focus();}};h.prototype._setControlKeyName=function(k){s=k;};h.prototype._setupTooltips=function(){var i=function(j){var E=this.$().find(j);if(E[0]&&E[0].clientHeight<E[0].scrollHeight){E.attr("title",E.html());}}.bind(this);if(this.getSubtitle()){i(".sapSuiteUiCommonsAccountHeaderTitleWithSubtitle");i(".sapSuiteUiCommonsAccountHeaderSubtitle");}else{i(".sapSuiteUiCommonsAccountHeaderTitle");}};h.prototype.updateBindingContext=function(){this.reset();return C.prototype.updateBindingContext.apply(this,arguments);};h.prototype.setMeasureOfUnit=function(v){this.setProperty("measureOfUnit",v,true);if(this._bRendered){this.$("sum").text(this._getSumText());var p=this.getParent();if(this._hasGroupParent(p)){p._measureChanged(v);}}this.invalidate();return this;};h.prototype.invalidate=function(){this._bRendered=false;C.prototype.invalidate.apply(this,arguments);};h.prototype.setCollapsed=function(v){this.setProperty("collapsed",v,true);var t=this._getExpandAltText(!v);this._getDownArrow().setTooltip(t);this._getDownArrow().$().attr("aria-label",t);this._getDownArrow().setSrc(!v?"sap-icon://navigation-down-arrow":"sap-icon://navigation-right-arrow");this.$()[v?"addClass":"removeClass"]("sapSuiteUiCommonsAccountCollapsed");this.$().find(".sapSuiteUiCommonsAccountGroupCollapseIcon").attr("aria-pressed",!v);if(this.getDomRef()){this.$("content")[v?"hide":"show"]("medium");}return this;};return h;});
