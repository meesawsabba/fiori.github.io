/*!
 * SAPUI5
 * (c) Copyright 2009-2021 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/thirdparty/jquery",'./library','sap/m/library','sap/ui/core/Control','sap/ui/Device','sap/m/FlexBox','sap/ui/core/ResizeHandler',"sap/base/Log","sap/f/IllustratedMessage","sap/f/library","./InteractiveBarChartRenderer"],function(q,l,M,C,D,F,R,L,I,s){"use strict";var a=C.extend("sap.suite.ui.microchart.InteractiveBarChart",{metadata:{library:"sap.suite.ui.microchart",properties:{displayedBars:{type:"int",group:"Appearance",defaultValue:3},labelWidth:{type:"sap.ui.core.Percentage",group:"Appearance",defaultValue:"40%"},selectionEnabled:{type:"boolean",group:"Behavior",defaultValue:true},min:{type:"float",group:"Appearance"},max:{type:"float",group:"Appearance"},showError:{type:"boolean",group:"Appearance",defaultValue:false},errorMessageTitle:{type:"string",group:"Appearance"},errorMessage:{type:"string",group:"Appearance"}},defaultAggregation:"bars",aggregations:{bars:{type:"sap.suite.ui.microchart.InteractiveBarChartBar",multiple:true,bindable:"bindable"}},events:{selectionChanged:{parameters:{selectedBars:{type:"sap.suite.ui.microchart.InteractiveBarChartBar[]"},bar:{type:"sap.suite.ui.microchart.InteractiveBarChartBar"},selected:{type:"boolean"}}},press:{}},associations:{ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"}}}});a.MIN_BAR_WIDTH_IN_PX=1;a.BAR_VALUE_PADDING_LEFT_IN_PX=4;a.BAR_VALUE_PADDING_RIGHT_IN_PX=4;a.SELECTION_AREA_BORDER_IN_PX=1;a.DIVIDER_WIDTH_IN_PX=1;a.AREA_HEIGHT_MINVALUE=18;a.BAR_HEIGHT_FONT_SMALLER=22;a.BAR_HEIGHT_MINVALUE=6;a.BAR_HEIGHT_LABEL_HIDE=16;a.CHART_WIDTH_FONT_SMALLER=288;a.LABEL_WIDTH_MINVALUE=80;a.CHART_WIDTH_MINVALUE=130;a.AREA_HEIGHT_INTERACTIVE_MINVALUE=48;a.AREA_HEIGHT_INTERACTIVE_MINVALUE_COMPACT=32;a.AREA_HEIGHT_PADDING_STAGE1=34;a.AREA_HEIGHT_PADDING_STAGE1_COMPACT=32;a.AREA_HEIGHT_PADDING_STAGE2=28;a.AREA_HEIGHT_PADDING_STAGE2_COMPACT=31;a.prototype.init=function(){this._iVisibleBars=0;this._bInteractiveMode=true;this._bMinMaxValid=null;this._fDividerPositionRight=0;this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.microchart");this._fMin=null;this._fMax=null;this._bThemeApplied=true;this._oIllustratedMessageControl=new I({illustrationSize:s.IllustratedMessageSize.Base,illustrationType:s.IllustratedMessageType.NoData});if(!sap.ui.getCore().isInitialized()){this._bThemeApplied=false;sap.ui.getCore().attachInit(this._handleCoreInitialized.bind(this));}else{this._handleCoreInitialized();}};a.prototype._handleCoreInitialized=function(){this._bThemeApplied=sap.ui.getCore().isThemeApplied();sap.ui.getCore().attachThemeChanged(this._handleThemeApplied,this);};a.prototype.onBeforeRendering=function(){this._bCompact=this._isCompact();this._bInteractiveMode=true;this._setResponsivenessData();this._setInternalMinMax();this._errorMessage=this.getErrorMessage();this._errorMessageTitle=this.getErrorMessageTitle();this._oIllustratedMessageControl.setTitle(this._errorMessageTitle);this._oIllustratedMessageControl.setDescription(this._errorMessage);this._bMinMaxValid=this._checkIfMinMaxValid();if(this.getAggregation("bars")&&this.getDisplayedBars()){this._iVisibleBars=Math.min(this.getAggregation("bars").length,this.getDisplayedBars());}if(!this.data("_parentRenderingContext")&&typeof this.getParent==="function"){this.data("_parentRenderingContext",this.getParent());}this._deregisterResizeHandler();this._updateUseSemanticTooltip();};a.prototype.onAfterRendering=function(){this._adjustToParent();l._checkControlIsVisible(this,this._onControlIsVisible);this._bindMouseEnterLeaveHandler();};a.prototype._updateUseSemanticTooltip=function(){var b=this.getBars();this._bUseSemanticTooltip=false;for(var i=0;i<this._iVisibleBars;i++){if(b[i].getColor()!==M.ValueColor.Neutral){this._bUseSemanticTooltip=true;return;}}};a.prototype._onControlIsVisible=function(){this._sResizeHandlerId=R.register(this,this._onResize.bind(this));this._calcBarsWidth();this._onResize();if(this.$().length>0){var c=this._isCompact();if(c!==this._bCompact){this._bCompact=c;this.invalidate();}}};a.prototype.exit=function(){this._deregisterResizeHandler();this._oIllustratedMessageControl.destroy();};a.prototype.onclick=function(e){if(!this.getSelectionEnabled()){return;}if(this._bInteractiveMode){var i=q(e.target).attr("id")||q(e.target).parents(".sapSuiteIBCBarInteractionArea").attr("id"),f=this.$().find(".sapSuiteIBCBarInteractionArea"),b,h;if(i){b=i.substring(i.lastIndexOf("-")+1);if(isNaN(b)){return;}else{b=parseInt(b);}this._toggleSelected(b);h=f.index(this.$().find(".sapSuiteIBCBarInteractionArea[tabindex='0']"));this._switchTabindex(h,b,f);}}else{this.firePress();if(D.browser.msie){this.$().trigger("focus");e.preventDefault();}}};a.prototype.onsapenter=function(e){if(this._bInteractiveMode){var i=this.$().find(".sapSuiteIBCBarInteractionArea").index(e.target);if(i!==-1){this._toggleSelected(i);}e.preventDefault();e.stopImmediatePropagation();}else{this.firePress();}};a.prototype.onsapspace=a.prototype.onsapenter;a.prototype.onsapup=function(e){var f=this.$().find(".sapSuiteIBCBarInteractionArea");var i=f.index(e.target);if(f.length>0){this._switchTabindex(i,i-1,f);}e.preventDefault();e.stopImmediatePropagation();};a.prototype.onsapdown=function(e){var f=this.$().find(".sapSuiteIBCBarInteractionArea");var i=f.index(e.target);if(f.length>0){this._switchTabindex(i,i+1,f);}e.preventDefault();e.stopImmediatePropagation();};a.prototype.onsaphome=function(e){var f=this.$().find(".sapSuiteIBCBarInteractionArea");var i=f.index(e.target);if(i!==0&&f.length>0){this._switchTabindex(i,0,f);}e.preventDefault();e.stopImmediatePropagation();};a.prototype.onsapend=function(e){var f=this.$().find(".sapSuiteIBCBarInteractionArea"),i=f.index(e.target),b=f.length;if(i!==b-1&&b>0){this._switchTabindex(i,b-1,f);}e.preventDefault();e.stopImmediatePropagation();};a.prototype.onsapleft=a.prototype.onsapup;a.prototype.onsapright=a.prototype.onsapdown;a.prototype.getSelectedBars=function(){var b=this.getAggregation("bars"),S=[],i;for(i=0;i<b.length;i++){if(b[i].getSelected()){S.push(b[i]);}}return S;};a.prototype.setSelectedBars=function(b){var B=this.getAggregation("bars"),i,c;this._deselectAllSelectedBars();if(!b){return this;}if(b instanceof l.InteractiveBarChartBar){b=[b];}if(Array.isArray(b)){for(i=0;i<b.length;i++){c=this.indexOfAggregation("bars",b[i]);if(c>=0){B[c].setProperty("selected",true,true);}else{L.warning("setSelectedBars method called with invalid InteractiveBarChartBar element");}}}this.invalidate();return this;};a.prototype.getTooltip_AsString=function(c){if(this._isChartEnabled()){t=this._createTooltipText(c,true);if(!t&&l._isTooltipSuppressed(t)){t=null;}}else{var t=this.getTooltip_Text();if(!t){t=this._createTooltipText();}else if(l._isTooltipSuppressed(t)){t=null;}}return t;};a.prototype._isCompact=function(){return q("body").hasClass("sapUiSizeCompact")||this.$().is(".sapUiSizeCompact")||this.$().closest(".sapUiSizeCompact").length>0;};a.prototype._setResponsivenessData=function(){if(this._bCompact){this._iAreaHeightInteractiveMinValue=a.AREA_HEIGHT_INTERACTIVE_MINVALUE_COMPACT;this._iAreaHeightPaddingStage1=a.AREA_HEIGHT_PADDING_STAGE1_COMPACT;this._iAreaHeightPaddingStage2=a.AREA_HEIGHT_PADDING_STAGE2_COMPACT;}else{this._iAreaHeightInteractiveMinValue=a.AREA_HEIGHT_INTERACTIVE_MINVALUE;this._iAreaHeightPaddingStage1=a.AREA_HEIGHT_PADDING_STAGE1;this._iAreaHeightPaddingStage2=a.AREA_HEIGHT_PADDING_STAGE2;}};a.prototype._handleThemeApplied=function(){this._bThemeApplied=true;this._bCompact=this._isCompact();};a.prototype._adjustToParent=function(){var $=this.$();if(this.data("_parentRenderingContext")&&this.data("_parentRenderingContext")instanceof F){var p=this.data("_parentRenderingContext").$();var P=p.width()-2;var i=p.height()-2;$.outerWidth(P);$.outerHeight(i);}};a.prototype._calcBarsWidth=function(){var $=this.$(),b=$.find(".sapSuiteIBCBarLabel"),d=a.DIVIDER_WIDTH_IN_PX,f=parseFloat(this.getLabelWidth()),B,t,c,e,g,h,v,E,j,k,r=sap.ui.getCore().getConfiguration().getRTL();if(!this._bMinMaxValid){return this;}if(this._bFullWidth){f=100;B=100;}else{B=100-f;}t=Math.abs(this._fMax-this._fMin);if(this._fMin>=0&&this._fMax>=0){c=0;e=1;}else if(this._fMin<0&&this._fMax<0){c=1;e=0;}else{c=Math.abs(this._fMin/t);e=Math.abs(this._fMax/t);}if(this._bFullWidth){if(e>=c){g=e*100;h=c*100;}else{g=c*100;h=0;}b.css("width",g+"%");b.css(r?"right":"left",h+"%");}else{b.css("width",f+"%");b.css(r?"right":"left","");}$.find(".sapSuiteIBCBarWrapper").css("width",B+"%");if(c>0){$.find(".sapSuiteIBCBarWrapperNegative").width("calc("+c*100+"% - "+d+"px)");}else{$.find(".sapSuiteIBCBarWrapperNegative").width("0%");}if(e>0){$.find(".sapSuiteIBCBarWrapperPositive").width("calc("+e*100+"% - "+d+"px)");}else{$.find(".sapSuiteIBCBarWrapperPositive").width("0%");}for(var i=0;i<this._iVisibleBars;i++){v=this.getBars()[i].getValue();j=this.$("bar-negative-"+i);k=this.$("bar-positive-"+i);if(this.getBars()[i]._bNullValue||v===0){k.add(j).css("min-width",0);}else if(!this.getBars()[i]._bNullValue){if(v>0){E=Math.min(Math.max(v,this._fMin),this._fMax);k.css({"width":this._calcPercent(E,t,Math.max(0,this._fMin),e),"min-width":1});j.css("min-width",0);}else{E=Math.max(Math.min(v,this._fMax),this._fMin);j.css({"width":this._calcPercent(E,t,Math.min(0,this._fMax),c),"min-width":1});k.css("min-width",0);}}}};a.prototype._calcPercent=function(v,t,b,c){return Math.abs((v-b)/(t*c)*100).toFixed(5)+"%";};a.prototype._deselectAllSelectedBars=function(){var b=this.getAggregation("bars"),B=b.length,i;for(i=0;i<B;i++){b[i].setProperty("selected",false,true);}};a.prototype._toggleSelected=function(i){var b=this.getAggregation("bars"),B=b[i];if(i<0||i>=b.length){return;}var $=this.$("interactionArea-"+i);if(B.getSelected()){$.removeClass("sapSuiteIBCBarSelected");B.setProperty("selected",false,true);}else{$.addClass("sapSuiteIBCBarSelected");B.setProperty("selected",true,true);}$.attr("aria-selected",B.getSelected());this.fireSelectionChanged({selectedBars:this.getSelectedBars(),bar:B,selected:B.getSelected()});};a.prototype._showValueOutsideBar=function(){var $=this.$(),b,v,B,V,f,c,d,e,g=this.$("bar-positive-0").parent().width(),h=this.$("bar-negative-0").parent().width(),r=sap.ui.getCore().getConfiguration().getRTL();b=$.find(".sapSuiteIBCBarValue");if(b.length===0){return;}for(var i=0;i<this._iVisibleBars;i++){V=this.getBars()[i].getValue();B=(b.eq(i).width()+a.BAR_VALUE_PADDING_LEFT_IN_PX+a.BAR_VALUE_PADDING_RIGHT_IN_PX);f=this.$("bar-positive-"+i).width();c=this.$("bar-negative-"+i).width();d=g-f;e=h-c;if(V>0||((this.getBars()[i]._bNullValue||V===0)&&this._fMin+this._fMax>=0)){if(B>f&&B>d){b.eq(i).css("visibility","hidden");}else{b.eq(i).css("visibility","inherit");}if(B>f){v=(this.$("bar-positive-"+i).width()+a.BAR_VALUE_PADDING_LEFT_IN_PX)+"px";b.eq(i).addClass("sapSuiteIBCBarValueOutside");}else{v="";b.eq(i).removeClass("sapSuiteIBCBarValueOutside");}if(r){b.eq(i).css({"right":v});}else{b.eq(i).css({"left":v});}}else{if(B>c&&B>e){b.eq(i).css("visibility","hidden");}else{b.eq(i).css("visibility","inherit");}if(B>c){v=(this.$("bar-negative-"+i).width()+a.BAR_VALUE_PADDING_RIGHT_IN_PX)+"px";b.eq(i).addClass("sapSuiteIBCBarValueOutside");}else{v="";b.eq(i).removeClass("sapSuiteIBCBarValueOutside");}if(r){b.eq(i).css({"left":v});}else{b.eq(i).css({"right":v});}}}};a.prototype._checkIfMinMaxValid=function(){if(this._fMin>this._fMax){L.warning("Min value for InteractiveBarChart is larger than Max value.");return false;}return true;};a.prototype._setInternalMinMax=function(){var m=null,f=null,b,B=this.getBars(),r=Math.min(this.getDisplayedBars(),B.length);for(var i=0;i<r;i++){if(!B[i]._bNullValue){b=B[i].getValue();m=Math.min(m,b);f=Math.max(f,b);}}this._fMin=this.getMin();this._fMax=this.getMax();if(!q.isNumeric(this._fMin)||!q.isNumeric(this._fMax)){if(m>=0&&f>=0){if(!q.isNumeric(this._fMin)){this._fMin=0;}if(!q.isNumeric(this._fMax)){this._fMax=f;}}else if(m<0&&f<0){if(!q.isNumeric(this._fMin)){this._fMin=m;}if(!q.isNumeric(this._fMax)){this._fMax=0;}}else{if(!q.isNumeric(this._fMin)){this._fMin=m;}if(!q.isNumeric(this._fMax)){this._fMax=f;}}}};a.prototype.validateProperty=function(p,v){if(p==="labelWidth"&&(v!==null||v!==undefined)){var V=parseFloat(v);if(V<0||V>100){L.warning("LabelWidth for InteractiveBarChart is not between 0 and 100.");v=null;}}return C.prototype.validateProperty.apply(this,[p,v]);};a.prototype._switchTabindex=function(o,n,f){if(o>=0&&o<f.length&&n>=0&&n<f.length){f.eq(o).removeAttr("tabindex");f.eq(n).attr("tabindex","0");f.eq(n).trigger("focus");}};a.prototype._isChartEnabled=function(){return this.getSelectionEnabled()&&this._bInteractiveMode;};a.prototype._resizeVertically=function(f){var A,m,b,$=this.$(),S=false,c=$.find(".sapSuiteIBCBarInteractionArea"),i=$.height(),d=0,v=this._iVisibleBars;if(this._bInteractiveMode){d=1;}m=parseInt(c.css("margin-bottom"))+parseInt(c.css("margin-top"));A=((i-((m+2*a.SELECTION_AREA_BORDER_IN_PX)*v))/v);if(A+d<this._iAreaHeightInteractiveMinValue){if(this._bInteractiveMode){this._bInteractiveMode=false;S=true;$.addClass("sapSuiteIBCNonInteractive");if(this.getSelectionEnabled()){var e=this.$().find(".sapSuiteIBCBarInteractionArea[tabindex='0']");this._iActiveElement=c.index(e);e.removeAttr("tabindex");this.$().attr("tabindex","0");}this.$().attr({"role":"button","aria-multiselectable":"false","aria-disabled":!this._isChartEnabled()});}}else if(!this._bInteractiveMode){this._bInteractiveMode=true;S=true;$.removeClass("sapSuiteIBCNonInteractive");if(this.getSelectionEnabled()){this.$().removeAttr("tabindex");if(!this._iActiveElement||this._iActiveElement<0){this._iActiveElement=0;}c.eq(this._iActiveElement).attr("tabindex","0");}this.$().attr({"role":"listbox","aria-multiselectable":"true","aria-disabled":!this._isChartEnabled()});}if(S){if(this._isChartEnabled()){$.removeAttr("title");this._addInteractionAreaTooltip(c);}else{c.removeAttr("title");$.attr("title",this.getTooltip_AsString());}}c.height(A);if(A<=this._iAreaHeightPaddingStage2){$.addClass("sapSuiteIBCStage2");}else{$.removeClass("sapSuiteIBCStage2");if(A<=this._iAreaHeightPaddingStage1){$.addClass("sapSuiteIBCStage1");}else{$.removeClass("sapSuiteIBCStage1");}}var B=this.$().find(".sapSuiteIBCBar");if(B.length>0&&B[0].getBoundingClientRect()){b=B[0].getBoundingClientRect().height;}if(b<=a.BAR_HEIGHT_FONT_SMALLER){$.addClass("sapSuiteIBCSmallFont");}if(b<=a.BAR_HEIGHT_LABEL_HIDE){$.find(".sapSuiteIBCBarValue").css("visibility","hidden");f.labelsVisible=false;}else{$.find(".sapSuiteIBCBarValue").css("visibility","inherit");}if(A<a.AREA_HEIGHT_MINVALUE){$.css("visibility","hidden");f.labelsVisible=false;f.chartVisible=false;}};a.prototype._resizeHorizontally=function(f){if(!f.chartVisible){return;}var $=this.$(),S=$.find(".sapSuiteIBCBarInteractionArea"),b=$.find(".sapSuiteIBCBarLabel"),B=parseFloat(this.getLabelWidth())/100*S.eq(0).width(),c=0,d=$.width(),e,g=false;if(d<a.CHART_WIDTH_FONT_SMALLER){$.addClass("sapSuiteIBCSmallFont");B=parseFloat(this.getLabelWidth())/100*S.eq(0).width();}if(this._bFullWidth){c=6;}for(var i=0;i<b.length;i++){b.eq(i).css("width",B+"px");if(b.eq(i).children(".sapSuiteIBCBarLabelText").prop("clientWidth")<b.eq(i).children(".sapSuiteIBCBarLabelText").prop("scrollWidth")-c){g=true;}b.eq(i).css("width","100%");}if(B<a.LABEL_WIDTH_MINVALUE&&g){$.addClass("sapSuiteIBCFullWidth");this._bFullWidth=true;this._calcBarsWidth();}else{$.removeClass("sapSuiteIBCFullWidth");this._bFullWidth=false;this._calcBarsWidth();}var h=this.$().find(".sapSuiteIBCBar");if(h.length>0&&h[0].getBoundingClientRect()){e=h[0].getBoundingClientRect().height;}if(d<a.CHART_WIDTH_MINVALUE||e<a.BAR_HEIGHT_MINVALUE){$.css("visibility","hidden");f.labelsVisible=false;f.chartVisible=false;}else if(e<=a.BAR_HEIGHT_LABEL_HIDE){$.find(".sapSuiteIBCBarValue").css("visibility","hidden");f.labelsVisible=false;}};a.prototype._onResize=function(){var $=this.$(),f={chartVisible:true,labelsVisible:true};$.css("visibility","visible");$.removeClass("sapSuiteIBCSmallFont");this._resizeVertically(f);this._resizeHorizontally(f);if(f.labelsVisible){this._showValueOutsideBar();}};a.prototype._deregisterResizeHandler=function(){if(this._sResizeHandlerId){R.deregister(this._sResizeHandlerId);this._sResizeHandlerId=null;}};a.prototype._addInteractionAreaTooltip=function(b){var B=this.getBars(),e,S;b.each(function(i,c){e=q(c);S=parseInt(e.attr("data-sap-ui-ibc-selection-index"));e.attr("title",B[S].getTooltip_AsString());});};a.prototype._createTooltipText=function(c,b){var d=true,B=this.getBars(),e,t="";for(var i=0;i<this._iVisibleBars;i++){if(b){if(c&&c-1===i){e=B[i].getTooltip_AsString();if(e){t+=(d?"":"\n")+e;d=false;break;}}}else{e=B[i]._getBarTooltip(this._bUseSemanticTooltip);if(e){t+=(d?"":"\n")+e;d=false;}}}return t;};a.prototype._bindMouseEnterLeaveHandler=function(){this.$().find(".sapSuiteIBCBarInteractionArea").on("mouseenter.tooltip",this._addTitleAttribute.bind(this));this.$().find(".sapSuiteIBCBarInteractionArea").on("mouseleave.tooltip",this._removeTitleAttribute.bind(this));};a.prototype._addTitleAttribute=function(e){if(this._isChartEnabled()&&this._hasData()){var b=this.getDomRef().querySelectorAll(".sapSuiteIBCBarInteractionArea");var p=e.target.getAttribute("aria-posinset");if(p&&b[parseInt(p)-1]&&!b[parseInt(p)-1].getAttribute("title")){b[parseInt(p)-1].setAttribute("title",this.getTooltip_AsString(parseInt(p)));}else{var E=e.target;var c=E.closest(".sapSuiteIBCBarInteractionArea");if(c&&!c.getAttribute("title")){c.setAttribute("title",this.getTooltip_AsString(parseInt(c.getAttribute("aria-posinset"))));}}}};a.prototype._removeTitleAttribute=function(e){var p=e.target.getAttribute("aria-posinset");var b=this.getDomRef().querySelectorAll(".sapSuiteIBCBarInteractionArea");if(p&&b[parseInt(p)-1]&&b[parseInt(p)-1].getAttribute("title")){b[parseInt(p)-1].removeAttribute("title");}else{var E=e.target;var c=E.closest(".sapSuiteIBCBarInteractionArea");if(c&&c.getAttribute("title")){c.removeAttribute("title");}}};a.prototype._hasData=function(){return this.getBars().length>0;};return a;});
