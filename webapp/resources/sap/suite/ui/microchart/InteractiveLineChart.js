/*!
 * SAPUI5
 * (c) Copyright 2009-2021 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/thirdparty/jquery",'./library','sap/m/library','sap/ui/core/Control','sap/suite/ui/microchart/InteractiveLineChartPoint','sap/ui/Device','sap/ui/core/ResizeHandler','sap/m/FlexBox',"sap/base/Log","sap/f/IllustratedMessage","sap/f/library","./InteractiveLineChartRenderer"],function(q,l,M,C,I,D,R,F,L,a,s){"use strict";var b=C.extend("sap.suite.ui.microchart.InteractiveLineChart",{metadata:{library:"sap.suite.ui.microchart",properties:{displayedPoints:{type:"int",group:"Appearance",defaultValue:6},precedingPoint:{type:"float",group:"Data",defaultValue:0},succeedingPoint:{type:"float",group:"Data",defaultValue:0},selectionEnabled:{type:"boolean",group:"Behavior",defaultValue:true},showError:{type:"boolean",group:"Appearance",defaultValue:false},errorMessageTitle:{type:"string",group:"Appearance"},errorMessage:{type:"string",group:"Appearance"}},defaultAggregation:"points",aggregations:{points:{type:"sap.suite.ui.microchart.InteractiveLineChartPoint",multiple:true,bindable:"bindable"}},events:{selectionChanged:{parameters:{selectedPoints:{type:"sap.suite.ui.microchart.InteractiveLineChartPoint[]"},point:{type:"sap.suite.ui.microchart.InteractiveLineChartPoint"},selected:{type:"boolean"}}},press:{}},associations:{ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"}}}});b.MAX_SCALED_CANVAS_VALUE=99;b.MIN_SCALED_CANVAS_VALUE=1;b.AREA_WIDTH_INTERACTIVE_MINVALUE=48;b.AREA_WIDTH_INTERACTIVE_MINVALUE_COMPACT=32;b.CHART_HEIGHT_MINVALUE=106;b.AREA_WIDTH_MINVALUE=24;b.LABEL_WIDTH_MINVALUE=32;b.AREA_WIDTH_SMALLFONT=36;b.prototype.init=function(){this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.microchart");this._aNormalizedValues=[];this._iAreaWidthInteractiveMinValue=b.AREA_WIDTH_INTERACTIVE_MINVALUE;this._bInteractiveMode=true;this._fNormalizedZero=0;this._bThemeApplied=true;this._oIllustratedMessageControl=new a({illustrationSize:s.IllustratedMessageSize.Base,illustrationType:s.IllustratedMessageType.NoData});if(!sap.ui.getCore().isInitialized()){this._bThemeApplied=false;sap.ui.getCore().attachInit(this._handleCoreInitialized.bind(this));}else{this._handleCoreInitialized();}};b.prototype._handleCoreInitialized=function(){this._bThemeApplied=sap.ui.getCore().isThemeApplied();sap.ui.getCore().attachThemeChanged(this._handleThemeApplied,this);};b.prototype.onBeforeRendering=function(){this._bCompact=this._isCompact();this._bInteractiveMode=true;var p=this.getPoints();this._errorMessage=this.getErrorMessage();this._errorMessageTitle=this.getErrorMessageTitle();this._oIllustratedMessageControl.setTitle(this._errorMessageTitle);this._oIllustratedMessageControl.setDescription(this._errorMessage);this._iVisiblePointsCount=Math.min(this.getDisplayedPoints(),p.length);this._setResponsivenessData();if(!this.data("_parentRenderingContext")&&typeof this.getParent==="function"){this.data("_parentRenderingContext",this.getParent());}this._updateNormalizedValues();this._deregisterResizeHandler();this._bSemanticTooltip=false;for(var i=0;i<this._iVisiblePointsCount;i++){if(p[i].getColor()!==M.ValueColor.Neutral){this._bSemanticTooltip=true;break;}}};b.prototype.onAfterRendering=function(){this._adjustToParent();l._checkControlIsVisible(this,this._onControlIsVisible);this._bindMouseEnterLeaveHandler();};b.prototype._onControlIsVisible=function(){this._sResizeHandlerId=R.register(this,this._onResize.bind(this));this._onResize();};b.prototype.exit=function(){this._deregisterResizeHandler();this._oIllustratedMessageControl.destroy();};b.prototype.onclick=function(e){if(!this.getSelectionEnabled()){return;}if(this._bInteractiveMode){var i=q(e.target).parent();var h,f=this.$().find(".sapSuiteILCInteractionArea");var c=this.$().find(".sapSuiteILCSection").index(i);if(c>=0){this._toggleSelected(c);h=f.index(this.$().find(".sapSuiteILCInteractionArea[tabindex='0']"));this._switchTabindex(h,c,f);}}else{this.firePress();if(D.browser.msie){this.$().trigger("focus");e.preventDefault();}}};b.prototype.onsapleft=function(e){var f=this.$().find(".sapSuiteILCInteractionArea");var i=f.index(e.target);if(f.length>0){this._switchTabindex(i,i-1,f);}e.preventDefault();e.stopImmediatePropagation();};b.prototype.onsapright=function(e){var f=this.$().find(".sapSuiteILCInteractionArea");var i=f.index(e.target);if(f.length>0){this._switchTabindex(i,i+1,f);}e.preventDefault();e.stopImmediatePropagation();};b.prototype.onsapup=b.prototype.onsapleft;b.prototype.onsapdown=b.prototype.onsapright;b.prototype.onsapenter=function(e){if(this._bInteractiveMode){var i=this.$().find(".sapSuiteILCInteractionArea").index(e.target);if(i!==-1){this._toggleSelected(i);}e.preventDefault();e.stopImmediatePropagation();}else{this.firePress();}};b.prototype.onsapspace=b.prototype.onsapenter;b.prototype.onsaphome=function(e){var f=this.$().find(".sapSuiteILCInteractionArea");var i=f.index(e.target);if(i!==0&&f.length>0){this._switchTabindex(i,0,f);}e.preventDefault();e.stopImmediatePropagation();};b.prototype.onsapend=function(e){var f=this.$().find(".sapSuiteILCInteractionArea");var i=f.index(e.target),c=f.length;if(i!==c-1&&c>0){this._switchTabindex(i,c-1,f);}e.preventDefault();e.stopImmediatePropagation();};b.prototype.getTooltip_AsString=function(c){if(this._isChartEnabled()){t=this._createTooltipText(c,true);if(!t&&l._isTooltipSuppressed(t)){t=null;}}else{var t=this.getTooltip_Text();if(!t){t=this._createTooltipText();}else if(l._isTooltipSuppressed(t)){t=null;}}return t;};b.prototype.getSelectedPoints=function(){var S=[],p=this.getAggregation("points");for(var i=0;i<p.length;i++){if(p[i].getSelected()){S.push(p[i]);}}return S;};b.prototype.setSelectedPoints=function(c){var p=this.getAggregation("points"),d;this._deselectAllSelectedPoints();if(!c){return this;}if(c instanceof I){c=[c];}if(Array.isArray(c)){for(var i=0;i<c.length;i++){d=this.indexOfAggregation("points",c[i]);if(d>=0){p[d].setProperty("selected",true,true);}else{L.warning("setSelectedPoints method called with invalid InteractiveLineChartPoint element");}}}this.invalidate();return this;};b.prototype._fnIsNumber=function(v){return typeof v==='number'&&!isNaN(v)&&isFinite(v);};b.prototype._isCompact=function(){return q("body").hasClass("sapUiSizeCompact")||this.$().is(".sapUiSizeCompact")||this.$().closest(".sapUiSizeCompact").length>0;};b.prototype._setResponsivenessData=function(){if(this._bCompact){this._iAreaWidthInteractiveMinValue=b.AREA_WIDTH_INTERACTIVE_MINVALUE_COMPACT;}else{this._iAreaWidthInteractiveMinValue=b.AREA_WIDTH_INTERACTIVE_MINVALUE;}};b.prototype._handleThemeApplied=function(){this._bThemeApplied=true;this._bCompact=this._isCompact();};b.prototype._deselectAllSelectedPoints=function(){var p=this.getPoints();for(var i=0;i<p.length;i++){if(p[i].getSelected()){p[i].setProperty("selected",false,true);}}};b.prototype._switchTabindex=function(o,n,f){if(o>=0&&o<f.length&&n>=0&&n<f.length){f.eq(o).removeAttr("tabindex");f.eq(n).attr("tabindex","0");f.eq(n).trigger("focus");}};b.prototype._toggleSelected=function(i){var p=this.getPoints()[i],S=this.$("point-area-"+i),P=this.$("point-"+i);if(p.getSelected()){S.add(P).removeClass("sapSuiteILCSelected");p.setProperty("selected",false,true);}else{S.add(P).addClass("sapSuiteILCSelected");p.setProperty("selected",true,true);}S.find(".sapSuiteILCInteractionArea").attr("aria-selected",p.getSelected());this.fireSelectionChanged({selectedPoints:this.getSelectedPoints(),point:p,selected:p.getSelected()});};b.prototype._updateNormalizedValues=function(){var p=this.getPoints(),n=p.length,i=0;this.nMax=-Number.MAX_VALUE;this.nMin=Number.MAX_VALUE;this._aNormalizedValues=[];for(i=0;i<n;i++){if(!p[i]._bNullValue){var v=p[i].getValue();this.nMax=Math.max(this.nMax,v);this.nMin=Math.min(this.nMin,v);}}var c=(this.nMax!=-Number.MAX_VALUE&&this.nMin!==Number.MAX_VALUE)?this.nMax-this.nMin:0;var S=function(v){if(typeof v!=="undefined"){var d=(v-this.nMin)/c;return b.MIN_SCALED_CANVAS_VALUE+d*(b.MAX_SCALED_CANVAS_VALUE-b.MIN_SCALED_CANVAS_VALUE);}return null;}.bind(this);for(i=0;i<n;i++){if(p[i]._bNullValue){this._aNormalizedValues.push(0);}else{this._aNormalizedValues.push(c?S(p[i].getValue()):50);}}if(p.length>0){this._fNormalizedPrecedingPoint=this._bIsPrecedingPointSet&&!p[0]._bNullValue?S(this.getPrecedingPoint()):null;this._fNormalizedSucceedingPoint=this._bIsSucceedingPointSet&&!p[p.length-1]._bNullValue?S(this.getSucceedingPoint()):null;}if(this.nMin<0&&this.nMax>0){this._fNormalizedZero=(Math.max(0-this.nMin,0)/c)*100;}else{this._fNormalizedZero=null;}};b.prototype._adjustToParent=function(){if(this.data("_parentRenderingContext")&&this.data("_parentRenderingContext")instanceof F){var p=this.data("_parentRenderingContext").$();var P=parseFloat(p.width())-2;var i=parseFloat(p.height())-2;this.$().outerWidth(P);this.$().outerHeight(i);}};b.prototype._isChartEnabled=function(){return this.getSelectionEnabled()&&this._bInteractiveMode;};b.prototype._switchModeInteractive=function(c){var $=this.$(),S=false;if(c<this._iAreaWidthInteractiveMinValue){if(this._bInteractiveMode){this._bInteractiveMode=false;S=true;$.addClass("sapSuiteILCNonInteractive");if(this.getSelectionEnabled()){var A=$.find(".sapSuiteILCInteractionArea[tabindex='0']");this._iActiveElement=$.find(".sapSuiteILCInteractionArea").index(A);A.removeAttr("tabindex");$.attr("tabindex","0");}$.attr({"role":"button","aria-multiselectable":"false","aria-disabled":!this._isChartEnabled()});}}else if(!this._bInteractiveMode){this._bInteractiveMode=true;S=true;$.removeClass("sapSuiteILCNonInteractive");if(this.getSelectionEnabled()){$.removeAttr("tabindex");if(!this._iActiveElement||this._iActiveElement<0){this._iActiveElement=0;}$.find(".sapSuiteILCInteractionArea").eq(this._iActiveElement).attr("tabindex","0");}$.attr({"role":"listbox","aria-multiselectable":"true","aria-disabled":!this._isChartEnabled()});}if(S){if(this._isChartEnabled()){$.removeAttr("title");this._addInteractionAreaTooltip();}else{$.find(".sapSuiteILCInteractionArea").removeAttr("title");$.attr("title",this.getTooltip_AsString());}}};b.prototype._addInteractionAreaTooltip=function(){var i=this.$().find(".sapSuiteILCInteractionArea"),p=this.getPoints();i.each(function(c,e){q(e).attr("title",p[c].getTooltip_AsString());});};b.prototype._onResize=function(){var c,B=false,$=this.$(),t=$.find(".sapSuiteILCToplabel"),d=$.find(".sapSuiteILCBottomText"),e=$.find(".sapSuiteILCInteractionArea"),f=$.height(),g=$.width(),n=this.getPoints().length,h=$.find(".sapSuiteILCSection:first-child .sapSuiteILCBottomText"),j=$.find(".sapSuiteILCSection:last-child .sapSuiteILCBottomText");if(e.length>0){c=e[0].getBoundingClientRect().width;}if(c<b.AREA_WIDTH_MINVALUE||f<b.CHART_HEIGHT_MINVALUE){$.css("visibility","hidden");return;}else{$.css("visibility","");}this._switchModeInteractive(c);if(c<=b.AREA_WIDTH_SMALLFONT){$.addClass("sapSuiteILCSmallFont");}else{$.removeClass("sapSuiteILCSmallFont");}$.removeClass("sapSuiteILCExpandedLabels");h.add(j).css("width","");for(var i=0;i<n;i++){if(t.eq(i).prop("offsetWidth")<t.eq(i).prop("scrollWidth")){t.eq(i).css("visibility","hidden");}else{t.eq(i).css("visibility","");}if(d.eq(i).prop("offsetWidth")<d.eq(i).prop("scrollWidth")){B=true;}}if(c<b.LABEL_WIDTH_MINVALUE&&B){$.addClass("sapSuiteILCExpandedLabels");h.add(j).css("width",(g/2)-4+"px");}else{$.removeClass("sapSuiteILCExpandedLabels");h.add(j).css("width","");}};b.prototype._deregisterResizeHandler=function(){if(this._sResizeHandlerId){R.deregister(this._sResizeHandlerId);this._sResizeHandlerId=null;}};b.prototype._createTooltipText=function(c,d){var e=true,A,t="",p=this.getPoints();for(var i=0;i<this._iVisiblePointsCount;i++){if(d){if(c&&c-1===i){A=p[i].getTooltip_AsString();if(A){t+=(e?"":"\n")+A;e=false;break;}}}else{A=p[i]._getAreaTooltip();if(A){t+=(e?"":"\n")+A;e=false;}}}return t;};b.prototype.setPrecedingPoint=function(v){this._bIsPrecedingPointSet=this._fnIsNumber(v);return this.setProperty("precedingPoint",this._bIsPrecedingPointSet?v:NaN);};b.prototype.setSucceedingPoint=function(v){this._bIsSucceedingPointSet=this._fnIsNumber(v);return this.setProperty("succeedingPoint",this._bIsSucceedingPointSet?v:NaN);};b.prototype._bindMouseEnterLeaveHandler=function(){this.$().find(".sapSuiteILCInteractionArea").on("mouseenter.tooltip",this._addTitleAttribute.bind(this));this.$().find(".sapSuiteILCInteractionArea").on("mouseleave.tooltip",this._removeTitleAttribute.bind(this));};b.prototype._addTitleAttribute=function(e){var p=e.target.getAttribute("aria-posinset");var o=this.getDomRef().querySelectorAll(".sapSuiteILCInteractionArea");if(this._isChartEnabled()&&this._hasData()&&o[parseInt(p)-1]&&!o[parseInt(p)-1].getAttribute("title")){o[parseInt(p)-1].setAttribute("title",this.getTooltip_AsString(parseInt(p)));}};b.prototype._removeTitleAttribute=function(e){var p=e.target.getAttribute("aria-posinset");var o=this.getDomRef().querySelectorAll(".sapSuiteILCInteractionArea");if(o[parseInt(p)-1]&&o[parseInt(p)-1].getAttribute("title")){o[parseInt(p)-1].removeAttribute("title");}};b.prototype._hasData=function(){return this.getPoints().length>0;};return b;});
