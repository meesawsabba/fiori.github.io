sap.ui.define(["sap/ui/core/support/Plugin","sap/ui/core/support/Support","sap/ui/core/format/DateFormat","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/suite/ui/generic/template/support/lib/CommonChecks","sap/suite/ui/generic/template/support/lib/CommonMethods","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/base/util/extend","sap/ui/core/mvc/XMLView"],function(P,S,D,J,M,C,a,t,e,X){"use strict";var p="sapUiSupportFioriElementsPluginALPLROP";window.diagnosticToolSpace={};function g(s){var o,A,v=p+"-View",d=[],E=sap.ui.getCore().getEventBus(),m,b,r,c,I,T=10,f;function G(){return p;}function F(i){var o1=D.getDateInstance({source:{pattern:"YYYYMMdd"},style:"short"});return o1.format(o1.parse(String(i).substring(0,8)));}function h(i){var o1=window.location.origin;var p1=window.location.pathname;var q1=i||C.getComponentIDByStructure();if(q1){m=C.getManifestPath(q1);if(m){var r1=C.getManifestURL(o1,p1,m);if(r1){return r1;}}}return"";}function j(i,o1,p1,q1,r1){if(i==="string"){d.push({order:p1,name:o1,type:i,value:q1});return true;}else if(i==="link"){d.push({order:p1,name:o1,type:i,value:q1,target:r1});return true;}else if(i==="group"){d.push({order:p1,name:o1,type:i});return true;}return false;}function k(i,o1,p1){return j("string",i,o1,p1,"");}function l(i,o1,p1,q1){return j("link",i,o1,p1,q1);}function n(i,o1){return j("group",i,o1,"","");}function q(i){if(!(i&&a.hasObjectContent(i))){return undefined;}if(!(i.getMetadata()&&a.hasObjectContent(i.getMetadata()))){return undefined;}var o1=i.getMetadata();if(!(o1.getManifest()&&a.hasObjectContent(o1.getManifest()))){return undefined;}return o1.getManifest();}function u(i){d=[];k("Error",0,i);Y();}function w(i){try{var o1=C.getUI5VersionInfo();if(o1&&a.hasObjectContent(o1)){k("OpenUI5 Version",i,o1.version+" (built at "+F(o1.buildTimestamp)+")");return true;}else{k("OpenUI5 Version",i,"ERROR: OpenUI5 version is not available!");return false;}}catch(ex){k("OpenUI5 Version",i,sap.ui.version+", detailed UI5 version info is not available! Possible reason: missing file \"sap-ui-version.json\"");return true;}}function x(i){var o1=a.getApplicationName(window.location.href);if(o1){l("Application URL",i,"#"+o1,window.location.href);return true;}else{k("Application URL",i,"ERROR: Could not extract application name (#semanticObject-action) from URL!");return false;}}function y(i){if(m&&b){var o1=m;if(m.indexOf("./")===0){o1=m.substring(2,m.length);}l("Manifest",i,o1,b);return true;}else{k("Manifest",i,"ERROR: Could not generate link to manifest.json! Possible reason: The application did not finish loading or is not a Fiori Elements application.");return false;}}function z(i){if(!(c)){return false;}var o1=C.getRegistrationIDsByManifest(c);if(o1&&Array.isArray(o1)&&o1.length>0){k((o1.length>1?"Fiori IDs":"Fiori ID"),i,a.concatStrings(o1));return true;}return false;}function B(i){var o1=C.getApplicationComponentByManifest(c);if(o1){k("Application Component (ACH)",i,o1);return true;}else{k("Application Component (ACH)",i,"ERROR: Path /sap.app/ach not found in manifest.json! Possible reason: Invalid manifest.json");return false;}}function H(i){var o1=C.getApplicationIDByManifest(c);if(o1){k("Application ID",i,o1);return true;}else{k("Application ID",i,"ERROR: Path /sap.app/id not found in manifest.json! Possible reason: Invalid manifest.json");return false;}}function K(i){if(c){var o1=C.getFloorplanByManifest(c);}else{o1=C.getFloorplanByStructure();}if(!C.isValidFloorplan(o1)){o1=C.mFloorplans.UNKNOWN;}if(o1===C.mFloorplans.UNKNOWN){k("Floorplan Component (ACH)",i,C.getTicketComponentForFloorplan(o1)+" (ERROR: Unknown floorplan! Possible reason: Invalid manifest.json)");return false;}else{k("Floorplan Component (ACH)",i,C.getTicketComponentForFloorplan(o1)+" ("+o1+")");return true;}}function L(i,o1){if(!(c&&a.hasObjectContent(c))){return false;}if(!(c["sap.app"]&&c["sap.app"].dataSources&&c["sap.app"].dataSources[i])){k("OData Service Metadata",o1,"ERROR: Data source "+i+" not found at /sap.app/dataSources/"+i+" in manifest.json! Possible reason: Invalid manifest.json");return false;}if(!c["sap.app"].dataSources[i].uri){k("OData Service Metadata",o1,"ERROR: Data source URI not found at /sap.app/dataSources/"+i+"/uri in manifest.json! Possible reason: Invalid manifest.json");return false;}var p1=c["sap.app"].dataSources[i].uri;if(p1.lastIndexOf("/")!==p1.length-1){p1+="/";}p1+="$metadata";l("OData Metadata",o1,p1,window.location.origin+p1);return true;}function N(i,o1){if(!(c&&a.hasObjectContent(c)&&r)){return false;}if(!(c["sap.app"]&&c["sap.app"].dataSources&&c["sap.app"].dataSources[i])){k("Annotations",o1,"ERROR: Data source "+i+" not found at /sap.app/dataSources/"+i+" in manifest.json! Possible reason: Invalid manifest.json");return false;}if(!(c["sap.app"].dataSources[i].settings&&c["sap.app"].dataSources[i].settings.annotations&&c["sap.app"].dataSources[i].settings.annotations!==[])){k("Annotations",o1,"ERROR: Data source "+i+" has no annotations at /sap.app/dataSources/"+i+"/settings/annotations in manifest.json! Possible reason: Invalid manifest.json");return false;}var p1=c["sap.app"].dataSources[i].settings.annotations;p1=p1.reverse();for(var q1 in p1){if(!p1.hasOwnProperty(q1)){continue;}var r1=p1[q1];if(c["sap.app"].dataSources[r1]){var s1=c["sap.app"].dataSources[r1].uri;if(!s1){continue;}var t1="";var u1="";if(s1.indexOf("/")===0){u1="Backend Annotation";t1=window.location.origin;}else{u1="Local Annotation";t1=r;if(t1.lastIndexOf("/")!==t1.length-1){t1+="/";}}u1+=" (Prio. "+parseInt(parseInt(q1,10)+1,10)+")";l(u1,o1,c["sap.app"].dataSources[r1].uri,t1+c["sap.app"].dataSources[r1].uri);}}return true;}function O(i){if(!(c)){return;}var o1=0;function p1(x1){o1+=0.01;return x1+o1;}if(!(c["sap.ui5"]&&c["sap.ui5"].models)){k("Data Sources",i,"ERROR: Path /sap.ui5/models not found in manifest.json! Possible reason: Invalid manifest.json");return;}var q1=c["sap.ui5"].models;var r1=[];for(var s1 in q1){if(!q1.hasOwnProperty(s1)){continue;}if(q1[s1]&&q1[s1].dataSource&&q1[s1].dataSource!==""){var t1=false;for(var u1 in r1){if(!r1.hasOwnProperty(u1)){continue;}if(r1[u1].dataSource===q1[s1].dataSource){t1=true;break;}}var v1=(s1===""?"mainService":s1);if(!t1){r1.push({models:[v1],dataSource:q1[s1].dataSource});}else{r1[u1].models.push(v1);}}}if(r1.length===0){k("Data Sources",i,"ERROR: No models with data sources found in manifest.json! Possible reason: Invalid manifest.json");return;}for(var w1 in r1){if(!r1.hasOwnProperty(w1)){continue;}if(!(c["sap.app"]&&c["sap.app"].dataSources)){k("Data Sources",i,"ERROR: No data sources found at /sap.app/dataSources in manifest.json! Possible reason: Invalid manifest.json");return;}if(!c["sap.app"].dataSources[r1[w1].dataSource]){k("Data Sources",i,"ERROR: Data source "+r1[w1].dataSource+" not found at /sap.app/dataSources/"+r1[w1].dataSource+" in manifest.json! Possible reason: Invalid manifest.json");return;}n(a.concatStrings(r1[w1].models),p1(i));L(r1[w1].dataSource,p1(i));N(r1[w1].dataSource,p1(i));}}function Q(i){var o1=sap.ui.getCore().byId(i);if(o1){return Promise.resolve(o1);}return X.create({id:i,viewName:"sap.suite.ui.generic.template.support.DiagnosticsTool.view.DiagnosticsTool",viewData:{plugin:o}});}function R(){Q(v).then(function(i){i.placeAt(p);var o1=new J();i.setModel(o1,"data");});}function U(){o=this;A=window.location.hash.slice(1);if(s.isToolStub()){if(!s.hasListeners(p+"SetData")){s.attachEvent(p+"SetData",b1);}if(!s.hasListeners(p+"UpdateStatus")){s.attachEvent(p+"UpdateStatus",c1);}if(!s.hasListeners(p+"ShowDataRefreshed")){s.attachEvent(p+"ShowDataRefreshed",d1);}window.diagnosticToolSpace.fioriElementsPluginID=p;R();}else{if(!s.hasListeners(p+"GetData")){s.attachEvent(p+"GetData",a1);}E.unsubscribe("elements","ViewRendered",f1);E.unsubscribe("elements","ViewRenderingStarted",f1);E.subscribe("elements","ViewRendered",f1);E.subscribe("elements","ViewRenderingStarted",f1);if("onhashchange"in window){window.addEventListener("hashchange",g1);}}a1();}function V(){if(s.isToolStub()){window.diagnosticToolSpace.fnFEPluginToolInstanceExit=undefined;s.detachEvent(p+"SetData",b1);s.detachEvent(p+"UpdateStatus",c1);s.detachEvent(p+"ShowDataRefreshed",d1);Q(v).then(function(i){i.destroy();});}else{window.diagnosticToolSpace.fnFEPluginAppInstanceExit=undefined;s.detachEvent(p+"GetData",a1);E.unsubscribe("elements","ViewRendered",f1);E.unsubscribe("elements","ViewRenderingStarted",f1);if("onhashchange"in window){window.removeEventListener("hashchange",g1);}}}function W(){s.sendEvent(p+"GetData",{});}function Y(){var i={};i.origin=window.location.origin;i.url=window.location.href;var o1=new J();d.sort(a.getDynamicComparator("order"));i.properties=d;var p1=new Date().toLocaleTimeString([],{hour12:false,hour:"2-digit",minute:"2-digit",second:"2-digit"});i.retrieval=p1;var q1=true;if(!d||d.length===0){q1=false;}i.copyEnabled=q1;var r1=a.getApplicationStatus();if(!r1){a.setApplicationStatus(a.mApplicationStatus.UNKNOWN);r1=a.mApplicationStatus.UNKNOWN;}i.status=r1;var s1="";if(r1===a.mApplicationStatus.FAILED){s1="The application did not finish loading or is no Fiori Elements application! The shown data below could be collected anyway. If the application finishes loading, the data will be updated automatically.";}i.statusMessage=s1;o1.setData(i);s.sendEvent(p+"SetData",i);}function Z(i,o1){s.sendEvent(p+"UpdateStatus",{timeLeft:i,status:o1});}function $(){s.sendEvent(p+"ShowDataRefreshed",{});}function _(i){if(b){r=C.getRootPath(b);}d=[];Y();w(1);x(2);y(3);Y();if(i&&c&&a.hasObjectContent(c)){z(3);B(4);K(5);O(6);Y();$();}else if(b){a.getFileFromURI(b).then(function(o1){c=o1;z(3);H(4);B(5);K(6);O(7);}).catch(function(){k("Manifest",3,"ERROR: Could not access manifest.json even though link could be generated! Possible reason: missing permission to access file.");}).finally(function(){Y();$();});}}function a1(){c=undefined;b=undefined;r=undefined;var i=a.getApplicationStatus();var o1=a.getAppComponent();var p1=false;if(!(i&&a.isValidApplicationStatus(i))){i=a.mApplicationStatus.UNKNOWN;}if(i===a.mApplicationStatus.LOADING){f1();return;}else if(i===a.mApplicationStatus.FAILED){var q1=q(o1);if(q1&&a.hasObjectContent(q1)){c=q1;if(c&&c["sap.app"]&&c["sap.app"].id){b=h(c["sap.app"].id);if(!b){p1=true;}}else{p1=true;}}else{u("Could not load any data because manifest and component of current application are unknown!");$();return;}}else if(i===a.mApplicationStatus.RENDERED){b=h();if(!b){q1=q(o1);if(q1&&a.hasObjectContent(q1)){c=q1;if(c&&c["sap.app"]&&c["sap.app"].id){b=h(c["sap.app"].id);if(!b){p1=true;}}else{p1=true;}}else{u("Could not load any data because manifest and component of current application are unknown!");$();return;}}}else if(i===a.mApplicationStatus.UNKNOWN){if(C.getFloorplanByStructure()!==C.mFloorplans.UNKNOWN){c=C.getManifestByStructure();if(c&&a.hasObjectContent(c)){if(c&&c["sap.app"]&&c["sap.app"].id){b=h(c["sap.app"].id);if(!b){p1=true;}}else{p1=true;}}}else{u("Could not load any data because manifest and component of current application are unknown!");$();return;}}_(p1);}function b1(i){var o1=new J();o1.setJSON(JSON.stringify(i.getParameters()));Q(v).then(function(p1){p1.setModel(o1,"data");p1.invalidate();});}function c1(i){var o1=i.getParameters();Q(v).then(function(p1){p1.getController().updateStatus(o1.timeLeft,o1.status);});}function d1(){Q(v).then(function(i){i.getController().showDataRefreshed();});}function e1(){var i=a.getApplicationStatus();if(f>0){Z(f,i);}else{f=T;a.setApplicationStatus(a.mApplicationStatus.FAILED);Z(0,a.mApplicationStatus.FAILED);I.removeListener(e1);I=undefined;a1();}f--;}function f1(i,o1){if(o1==="ViewRenderingStarted"||(!o1&&a.getApplicationStatus()===a.mApplicationStatus.LOADING)){a.setApplicationStatus(a.mApplicationStatus.LOADING);if(!I){f=T;I=new sap.ui.core.IntervalTrigger(1000);I.addListener(e1);}}else if(o1==="ViewRendered"){a.setApplicationStatus(a.mApplicationStatus.RENDERED);f=T;if(I){I.removeListener(e1);I=undefined;}a1();}}function g1(o1){function p1(u1){for(var i=0;i<u1.length;i++){if(u1[i]==="/"||u1[i]==="&"||u1[i]==="?"||u1[i]==="~"){return i;}}return u1.length;}function q1(i,u1){if(!i||!u1){return false;}if(i===u1){return true;}var v1=p1(i);var w1=p1(u1);if(v1!==w1){return false;}else if(i.substr(0,v1)===u1.substr(0,w1)){return true;}return false;}var r1,s1,t1=false;if(o1.originalEvent.oldURL&&o1.originalEvent.newURL){r1=o1.originalEvent.oldURL.split("#")[1];s1=o1.originalEvent.newURL.split("#")[1];}else{r1=A;s1=window.location.hash.slice(1);A=s1;}if(r1.length>=s1.length){t1=q1(s1,r1);}else{t1=q1(r1,s1);}if(!t1){a.setApplicationStatus(a.mApplicationStatus.LOADING);a.setAppComponent(undefined);f1();f=(T/2);}}function h1(){return s;}function i1(){return d;}function j1(){d=[];}function k1(i){c=i;}function l1(i){b=i;}function m1(i){m=i;}function n1(i){r=i;}var F=t.testable(F,"DiagnosticsTool_fnFormatDate");var q=t.testable(q,"fnGetManifestFromAppComponent");var j=t.testable(j,"fnAddToData");var k=t.testable(k,"fnAddStringToData");var l=t.testable(l,"fnAddLinkToData");var n=t.testable(n,"fnAddGroupHeaderToData");var u=t.testable(u,"fnDisplayError");var w=t.testable(w,"fnAddVersionInfo");var y=t.testable(y,"fnAddManifestLink");var B=t.testable(B,"fnAddApplicationComponent");var K=t.testable(K,"fnAddFloorplanComponent");var L=t.testable(L,"fnAddODataServiceMetadataLink");var N=t.testable(N,"fnAddAnnotationsLinks");var O=t.testable(O,"fnAddDataSources");var z=t.testable(z,"fnAddFioriID");var H=t.testable(H,"fnAddApplicationID");var h1=t.testable(h1,"fnGetSupportStub");var i1=t.testable(i1,"fnGetData");var j1=t.testable(j1,"fnResetData");var k1=t.testable(k1,"fnSetManifest");var l1=t.testable(l1,"fnSetManifestURL");var m1=t.testable(m1,"fnSetManifestPath");var n1=t.testable(n1,"fnSetsRootPath");return{init:U,exit:V,getId:G,onRefresh:W};}return P.extend("sap.suite.ui.generic.template.support.DiagnosticsTool.DiagnosticsTool",{constructor:function(s){P.apply(this,[p,"SAP Fiori Elements",s]);e(this,g(s));}});});
