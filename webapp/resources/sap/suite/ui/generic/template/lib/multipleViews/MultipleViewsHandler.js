sap.ui.define(["sap/ui/base/Object","sap/ui/model/Filter","sap/suite/ui/generic/template/lib/multipleViews/MultipleTablesModeHelper","sap/suite/ui/generic/template/lib/multipleViews/SingleTableModeHelper","sap/ui/generic/app/navigation/service/SelectionVariant","sap/suite/ui/generic/template/genericUtilities/metadataAnalyser","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/base/util/extend","sap/base/security/encodeURL","sap/ui/comp/util/DateTimeUtil","sap/base/util/isEmptyObject"],function(B,F,M,S,a,m,b,t,e,c,D,d){"use strict";var l=new b("lib.multipleViews.MultipleViewsHandler").getLogger();function g(C,T,o){var s=Object.create(null);var f=T.oComponentUtils.getTemplatePrivateModel();var p=o.pathInTemplatePrivateModel+"/items";var P=o.pathInTemplatePrivateModel+"/selectedKey";f.setProperty(o.pathInTemplatePrivateModel,Object.create(null));f.setProperty(p,Object.create(null));var I=new(o.presentationControlHandler?S:M)(C,T,o);f.setProperty(o.pathInTemplatePrivateModel+"/mode",I.getMode());var h=T.oServices.oApplication.getBusyHelper().getBusyDelay();var k=C.getOwnerComponent().getModel();var n;var q;var r;function u(){if(q){var i=o.getSearchValue&&o.getSearchValue();var j=i?{search:i}:{};for(var b1 in s){var c1=s[b1];var d1=c1.getPath();c1.numberOfUpdates++;c1.updateStartFunction(c1.numberOfUpdates);k.read(d1+"/$count",{urlParameters:j,filters:c1.getFiltersForCount(),groupId:"updateMultipleViewsItemsCounts",success:c1.updateSuccessFunction.bind(null,c1.numberOfUpdates),error:c1.errorFunction.bind(null,c1.numberOfUpdates)});}}}function R(i,j){var b1="";var c1=j["parameters"];if(!j||!j.entitySetName||!j.navPropertyName||c1.length<1){b1="/"+i.name;return b1;}var d1=o.smartFilterBar&&o.smartFilterBar.getAnalyticalParameters();if(d1&&d1.length>0){var e1=o.smartFilterBar&&o.smartFilterBar.getUiState({allFilters:false});var f1=e1?JSON.stringify(e1.getSelectionVariant()):"{}";var g1=new a(f1);var h1=[];c1.forEach(function(i1){d1.forEach(function(j1){if(j1&&(j1.name===i1)){var k1=j1.name;var l1=g1.getParameter(k1);if(j1.type==='Edm.DateTime'||j1.type==='Edm.DateTimeOffset'){l1=new Date(l1);l1=D.localToUtc(l1);l1=c(j1.control.getModel().formatValue(l1,j1.type));h1.push(k1+'='+l1);}else{h1.push(k1+'='+"'"+l1+"'");}}});});b1='/'+j.entitySetName+'('+h1.join(',')+')/'+j.navPropertyName;}else{b1="/"+i.name;l.error("SelectionParameters","There are no parameters to resolve");return b1;}return b1;}function G(i){var j;var b1=i.getEntitySet();var c1=C.getOwnerComponent();if(o.smartFilterBar&&o.smartFilterBar.getConsiderAnalyticalParameters&&o.smartFilterBar.getConsiderAnalyticalParameters()){var d1=k.getMetaModel();var e1=d1.getODataEntitySet(b1);var f1=c1.getAppComponent();var g1=m.getParametersByEntitySet(f1.getModel(),b1);j=o.resolveParameterizedEntitySet?o.resolveParameterizedEntitySet(e1,g1):R(e1,g1);return j;}var h1=i.getBindingPath();j=h1?h1:"/"+b1;var i1=c1.getComponentContainer();var j1=i1.getElementBinding();return j1?j1.getPath()+'/'+j:j;}function v(b1,c1){var d1=k.getMetaModel();var e1=d1.getODataEntityType(d1.getODataEntitySet(b1.getEntitySet()).entityType);var f1=[],g1;var h1=c1.variantAnnotationPath;if(h1){var i1=e1[h1];if(!i1){return[];}if(!i1.SelectOptions&&i1.SelectionVariant){i1=i1.SelectionVariant;if(i1.Path){h1=i1.Path.split("@")[1];i1=h1&&e1[h1];}}if(i1.AnnotationPath){g1=i1.AnnotationPath.split("@")[1];i1=e1[g1];}for(var i in i1.SelectOptions){if(i1.SelectOptions[i].PropertyName){var j1=i1.SelectOptions[i].PropertyName.PropertyPath;for(var j in i1.SelectOptions[i].Ranges){var k1=i1.SelectOptions[i].Ranges[j].Sign;var l1=i1.SelectOptions[i].Ranges[j].Option;if(k1){l1.EnumMember=w(k1.EnumMember.replace("com.sap.vocabularies.UI.v1.SelectionRangeSignType/",""),l1.EnumMember.replace("com.sap.vocabularies.UI.v1.SelectionRangeOptionType/",""));}else{l1.EnumMember=l1.EnumMember.replace("com.sap.vocabularies.UI.v1.SelectionRangeOptionType/","");}var m1=i1.SelectOptions[i].Ranges[j].Low;var n1=i1.SelectOptions[i].Ranges[j].High;var o1=Object.keys(m1)[0];if(n1){var p1=Object.keys(n1)[0];f1.push(new F(j1,l1.EnumMember,m1[o1],n1[p1]));}else{f1.push(new F(j1,l1.EnumMember,m1[o1]));}}}}}return f1;}function w(i,j){var b1;var c1=new Map([["EQ","NE"],["BT","NB"],["CP","NP"],["LE","GT"],["GE","LT"],["NE","EQ"],["NB","BT"],["NP","CP"],["GT","LE"],["LT","GE"]]);if(i==="I"){b1=j;}else if(i==="E"){if(c1.has(j)){b1=c1.get(j);}else{b1=j;}}return b1;}function H(i){for(var j in s){var b1=s[j];if(b1.presentationControlHandler.getEntitySet()===i){return true;}}return false;}function O(i,j){var b1=i.filters.slice(0);var c1=y();i.filters=A(i.filters,c1,j,false);if(q){for(var d1 in s){var e1=s[d1];x(b1,e1,j);}}}function x(i,j,b1){j.getFiltersForCount=function(){return A(i,j,b1,true);};}function A(i,j,b1,c1){if(I.getFiltersAdaptedFromItem){i=I.getFiltersAdaptedFromItem(i,j,b1,c1);}return i.concat(j.selectionVariantFilters);}function y(){return s[r];}function z(i,r){return I.formatMessageStrip(i,r);}function E(){return r;}function J(){return I.getMode();}function K(r){f.setProperty(P,r||n);}function L(){return I.getContentForIappState(r);}function N(i){var j;if(!i){return"";}if(i.state==="error"){return T.oCommonUtils.getText("SEG_BUTTON_ERROR",i.text);}if(i.state===""||i.state==="busy"){var b1=sap.ui.core.format.NumberFormat.getIntegerInstance({groupingEnabled:true});j=b1.format(i.count);}return T.oCommonUtils.getText("SEG_BUTTON_TEXT",[i.text,i.state==="busyLong"?"...":j]);}function Q(i){r=I.getSelectedKeyAndRestoreFromIappState(i);if(s[r]){f.setProperty(P,r);}}function U(){return s[r].templateSortOrder;}function V(i){var j=y();if(i!==2){j.presentationControlHandler.rebind();}if(i>1){if(o.refreshModelOnTableRefresh){var b1=T.oCommonUtils.refreshModel(j.presentationControlHandler.getEntitySet());if(b1){a1(j.presentationControlHandler);}}j.presentationControlHandler.refresh();}}function W(i,j,b1){var c1=Array.isArray(j);var d1=T.oComponentUtils.isComponentActive();if((c1&&j.length===0)||(b1&&d(b1))){return;}I.refreshOperation(i,j,b1,r,c1,d1,V);}function X(){var i=y();return I.setActiveButtonState(i);}function Y(){var i=y();return I.restoreActiveButtonState&&I.restoreActiveButtonState(i);}function Z(i,j){if(I.setControlVariant){I.setControlVariant(i,j);}}function $(i,j,b1,c1){return T.oCommonUtils.getCustomDataText(i).then(function(d1){b1.text=d1;c1.text=d1;return{modelEntry:b1,pathToTheItem:j};});}function _(i){f.setProperty(i.pathToTheItem,i.modelEntry);}function a1(i){if(I.refreshSiblingControls){I.refreshSiblingControls(i);}}(function(){t.testable(function(){return I;},"getImplementingHelper");t.testable(function(){return q;},"getShowCounts");t.testable(function(){return s[r];},"getCurrentViewMeta");var j=function(e1,j1,k1,l1){if(e1.numberOfUpdates!==k1){return;}var g1=p+"/"+e1.switchingKey;var h1=e({},f.getProperty(g1));if(!h1.state&&j1=="busy"){setTimeout(function(){if(f.getProperty(g1).state==="busy"){h1=e({},f.getProperty(g1));h1.state="busyLong";f.setProperty(g1,h1);}},h);}h1.state=j1;if(!j1){h1.count=l1;}f.setProperty(g1,h1);};var b1=o.switchingControl.getItems();for(var i=0;i<b1.length;i++){var c1=b1[i];var d1=c1.getKey();if(i===0){n=d1;}var e1={presentationControlHandler:o.presentationControlHandler||o.getPresentationControlHandler(d1),switchingKey:d1};var f1=T.oCommonUtils.getElementCustomData(c1);var g1=p+"/"+e1.switchingKey;var h1=Object.create(null);h1.text=f1.text;h1.count=0;h1.state="";h1.facetId=o.sectionKey;$(c1,g1,h1,e1).then(_);e1.templateSortOrder=f1.TemplateSortOrder;e1.getPath=G.bind(null,e1.presentationControlHandler);e1.selectionVariantFilters=v(e1.presentationControlHandler,f1);e1.numberOfUpdates=0;e1.updateStartFunction=j.bind(null,e1,"busy");e1.updateSuccessFunction=j.bind(null,e1,"");e1.errorFunction=j.bind(null,e1,"error");s[d1]=e1;}if(I.init){I.init(s,W,y);}if(o.manifestSettings.showCounts===undefined){q=I.getDefaultShowCounts();}else{q=o.manifestSettings.showCounts;}K();r=f.getProperty(P);var i1=f.bindProperty(P);i1.attachChange(function(j1){var k1=j1.getSource().getValue();if(k1===r){return;}r=k1;if(I.onSelectedKeyChanged){I.onSelectedKeyChanged(k1);}var l1=o.isDataToBeShown();var m1=I.getRefreshMode(r);if(o.adaptRefreshRequestMode){m1=o.adaptRefreshRequestMode(m1);if(l1&&m1>0){V(m1);}else{y().presentationControlHandler.setEnabledToolbarButtons();}}o.appStateChange();});})();return{updateCounts:u,refreshOperation:W,onRebindContentControl:O,formatMessageStrip:z,getSelectedKey:E,setSelectedKey:K,getContentForIappState:L,restoreFromIappState:Q,formatItemTextForMultipleView:N,determineSortOrder:U,setActiveButtonState:X,restoreActiveButtonState:Y,setControlVariant:Z,hasEntitySet:H,refreshSiblingControls:a1,resolveParameterizedEntitySet:R,getMode:J};}return B.extend("sap.suite.ui.generic.template.lib.multipleViews.MultipleViewsHandler",{constructor:function(C,T,o){e(this,g(C,T,o));}});});
