sap.ui.define(["sap/ui/base/Object","sap/ui/model/Context","sap/suite/ui/generic/template/lib/MessageUtils","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(B,C,M,F,a){"use strict";function c(p,s,m,P,h){var o=m.createEntry(s,{properties:P,context:p,batchGroupId:"Changes",changeSetId:"Changes",canonicalRequest:h});return o;}function b(D,E,s,m,A,p,P){s=s||"/"+E;var h=A.mustRequireRequestsCanonical();return D.createNewDraftEntity(E,s,p,h,P).then(function(o){return o.context;});}function r(m,s,t){var p=new Promise(function(h,i){m.read(s,{urlParameters:{"$expand":"DraftAdministrativeData"},success:function(o){h(o);},error:function(o){i(o);}});});t.oBusyHelper.setBusy(p,true);return p;}function R(t,E,k,s,m,T){var p=new Promise(function(h,j){var i,l,P,v,n=[];if(k&&s&&m){l=k.length;for(i=0;i<l;i++){P=k[i].PropertyPath;v=s[P][0];n.push(new F(P,a.EQ,v));}if(t.getDraftController().getDraftContext().isDraftEnabled(E)){var D=new F({filters:[new F("IsActiveEntity","EQ",false),new F("SiblingEntity/IsActiveEntity","EQ",null)],and:false});n.push(D);}var o=new F(n,true);m.read("/"+E,{urlParameters:{"$expand":"DraftAdministrativeData"},filters:[o],success:function(q){var w=f(q,m,s);if(w){h(w);}else{j(q);}},error:function(q){j(q);}});}});T.oBusyHelper.setBusy(p,true);return p;}function f(o,m,s){var h,i,l,k;if(o&&o.results){l=o.results.length;if(l==0){k=null;}else if(l==1){k=o.results[0];}else if(l>=1){var D=[];var A=[];for(i=0;i<l;i++){h=o.results[i];if(h&&h.IsActiveEntity){A.push(h);}else if(h&&h.IsActiveEntity==false){D.push(h);}}if(A.length==0&&D.length>=2){var n;for(var j=0;j<D.length;j++){n=D[j];if(n.DraftUUID==s.DraftUUID){k=n;break;}}if(!k){k=D[0];}}else if(A.length==1&&D.length==1){k=A[0];}else if(A.length==1&&D.length>=2){k=A[0];}}}return k;}function e(t){var A=t.oAppComponent;var m=A.getModel();var o=m.getMetaModel();var n=A.getNavigationController();var h=A.getApplicationController();var D=h.getTransactionController().getDraftController().getDraftContext();var E=function(i){t.oApplicationProxy.getResourceBundleForEditPromise().then(function(j){M.handleError(M.operations.modifyEntity,null,null,i,{resourceBundle:j,navigationController:n,model:m});M.handleTransientMessages(t.oApplicationProxy.getDialogFragment);});};var p=function(i){var j=i.getParameter("context");if(!D.hasDraft(j)){return;}if(!o.getODataEntitySet(j.getPath().split("(")[0].substring(1))){return;}var P=i.getParameter("path");h.propertyChanged(P,j).catch(E);t.oApplicationProxy.markCurrentDraftAsModified();};m.attachPropertyChange(p);}function u(t,D,h){return new Promise(function(i,j){var U;t.oApplicationProxy.getDialogFragmentAsync("sap.suite.ui.generic.template.ObjectPage.view.fragments.UnsavedChangesDialog",{onEdit:function(){U.close();i();},onCancel:function(){U.close();j();}},"Dialog").then(function(o){U=o;var s=t.getText("DRAFT_LOCK_EXPIRED",[D.LastChangedByUserDescription||D.LastChangedByUser]);var k=new sap.ui.model.resource.ResourceModel({bundleName:"sap/suite/ui/generic/template/ObjectPage/i18n/i18n",async:true});U.setModel(k,"i18n");U.getModel("Dialog").setProperty("/unsavedChangesQuestion",s);(h||Function.prototype)();t.oBusyHelper.getUnbusy().then(function(){U.open();});});});}function d(t,E,s,m,T,h,k,S){if(s===""&&k&&S){return new Promise(function(i,j){R(t,E,k,S,m,T).then(function(l){var n="/"+m.createKey(E,l);var o=new C(m,n);if(!l.DraftAdministrativeData||l.DraftAdministrativeData.DraftIsCreatedByMe){i(t.editEntity(o,false));}else if(l.DraftAdministrativeData.InProcessByUser){j({lockedByUser:l.DraftAdministrativeData.InProcessByUserDescription||l.DraftAdministrativeData.InProcessByUser});}else{u(T,l.DraftAdministrativeData,h).then(function(){i(t.editEntity(o,false));},function(){j({lockedByUser:l.DraftAdministrativeData.LastChangedByUserDescription||l.DraftAdministrativeData.LastChangedByUser});});}},function(l){j({draftAdminReadResponse:l});});});}var D=t.getDraftController().getDraftContext();var o=new C(m,s);if(D.isDraftEnabled(E)){if(true||!D.hasPreserveChanges(o)){return new Promise(function(i,j){r(m,s,T).then(function(l){if(!l.DraftAdministrativeData||l.DraftAdministrativeData.DraftIsCreatedByMe){i(t.editEntity(o,false));}else if(l.DraftAdministrativeData.InProcessByUser){j({lockedByUser:l.DraftAdministrativeData.InProcessByUserDescription||l.DraftAdministrativeData.InProcessByUser});}else{u(T,l.DraftAdministrativeData,h).then(function(){i(t.editEntity(o,false));},function(){j({lockedByUser:l.DraftAdministrativeData.LastChangedByUserDescription||l.DraftAdministrativeData.LastChangedByUser});});}},function(l){j({draftAdminReadResponse:l});});});}}else{return Promise.resolve({context:o});}}function g(D,t,A,o){var h=D.hasActiveEntity(o);var s=h?A.getDraftSiblingPromise(o):Promise.resolve();return s.then(function(i){var T=function(){return{context:i};};var j=t.deleteEntity(o);var k=j.then(T);A.cancellationStarted(o,k,"discardAction");return j;});}return{createNonDraft:c,create:b,edit:d,enableAutomaticDraftSaving:e,discardDraft:g};});
