sap.ui.define(["sap/ui/core/CustomizingConfiguration","sap/ui/core/library","sap/ui/core/Component","sap/ui/core/UIComponent","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","sap/ui/Device","sap/suite/ui/generic/template/lib/reuseComponentHelper","sap/ui/core/CustomData","sap/suite/ui/generic/template/lib/StableIdDefinition","sap/suite/ui/generic/template/js/StableIdHelper","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/suite/ui/generic/template/js/AnnotationHelper","sap/base/util/extend","sap/base/util/deepExtend","sap/suite/ui/generic/template/genericUtilities/CacheHelper","sap/suite/ui/generic/template/genericUtilities/FeError","sap/ui/core/mvc/View"],function(C,c,a,U,J,R,D,r,b,S,d,F,A,e,f,g,h){"use strict";var s="lib.TemplateComponent";var l=new F(s).getLogger();var V=c.mvc.ViewType;function j(O){var i=O&&typeof O==="string"?O:(O&&a.getOwnerIdFor(O));var y=i&&a.get(i);if(y instanceof T){y=y.getAppComponent();}return y;}var G=C.getViewExtension;C.getViewExtension=function(i,y,O){var z=j(O),B=z&&z.getId(),H=G.call(C,i,y,B);return H;};function E(y){var I=new R({bundleName:"sap/suite/ui/generic/template/lib/i18n/i18n"});var z=[];var M=y.getAppComponent().getModel("i18n|"+y.getMetadata().getComponentName()+"|"+y.getEntitySet());if(M){z.push(M);}var B=y.getModel("i18n");if(B){z.push(B);}var H=y.getModel("@i18n");if(H){z.push(H);}var K=true;for(var L="i18n";K;){L=L+"||Parent";K=y.getModel(L);if(K){z.push(K);}}for(var i=z.length-1;i>=0;i--){I.enhance(z[i].getResourceBundle());}y.setModel(I,"i18n");}function k(i,M){var y=i.getAppComponent().getManifestEntry("sap.ui5");var z=y.extends&&y.extends.extensions&&y.extends.extensions["sap.ui.controllerExtensions"];var B=i.getTemplateName();var H=z&&z[B]&&z[B]["sap.ui.generic.app"];var I=i.getEntitySet();var K=H&&H[I]&&H[I].Actions;var L={};var N=m(i);if(K){if(N){n(L,K,N);}else{o(L,K);}}else{var O=H&&H[I]&&H[I]["Sections"];for(var Q in O){K=O[Q]["Actions"];if(K){o(L,K);}}}i.getModel("_templPriv").setProperty("/generic/listCommons/breakoutActionsEnabled",L);}function m(i){var y;var z=i.getAppComponent().getConfig();var B=z&&z.pages[0]&&z.pages[0].component&&z.pages[0].component.settings;if(B&&B.quickVariantSelectionX){y=B.quickVariantSelectionX.variants;}return y;}function n(B,y,z){var H;for(var I in y){H=true;if(y[I].requiresSelection){H=false;}for(var i in z){var K=y[I].id;var L=z[i];var M=A.getSuffixFromIconTabFilterKey(L);if(M){K=K.concat(M);}B[K]={enabled:H};}}}function o(B,i){var y;for(var z in i){y=true;if(i[z].requiresSelection){y=false;}B[i[z].id]={enabled:y};}}function p(i){if(i.getAppComponent().getMetadata().getComponentName()===""||i.getTemplateName()===""||i.getEntitySet()===""){}return i.getAppComponent().getMetadata().getComponentName()+"::"+i.getTemplateName()+"::"+i.getEntitySet();}function q(i,y){if(i.level===0){return[];}var z=y[i.parentRoute];var B=q(z,y);B.push(z);return B;}function t(i,y,M,z){var B=y.oComponent;var H=y.oAppComponent;var I=y.oTemplateContract.mRoutingTree[y.route];var K=B.getEntitySet();var L=y.utils.isDraftEnabled();var N=H.getTransactionController().getDraftController();var O=N.getDraftContext();var Q=H.getModel();var W=function(K){return O.isDraftEnabled(K);};var X=e({},I.page.component.settings);delete X.appComponent;delete X.entitySet;delete X.navigationProperty;X.subPages=I.page.pages;X.routeConfig=y.routeConfig;return new J({entitySet:K,entityType:i,treeNode:I,treeNodeAncestors:q(I,y.oTemplateContract.mRoutingTree),routingSpec:y.routingSpec,"sap-ui-debug":window["sap-ui-debug"],isDraftEnabled:L,checkIsDraftEnabled:W,settings:X,manifest:H.getInternalManifest(),metaModel:M,templateSpecific:z&&z(M,X,D,K,O,Q),appComponentName:H.getMetadata().getComponentName(),stableId:{definition:S,aParameter:[],getStableId:d.getStableId},variables:[]});}function u(i,y){var z=i.oComponent,B=i.createViewController,H=i.methods&&i.methods.getTemplateSpecificParameters,M=i.oAppComponent.getModel(),I,K,L,N,O,Q=i.routingSpec&&i.routingSpec.noOData;if(Q){I=new J({entitySet:{},entityType:{}});N=I.createBindingContext("/entitySet");O=I.createBindingContext("/entityType");}else{I=M&&M.getMetaModel();K=M&&z.getEntitySet();var W=K&&I.getODataEntitySet(K);L=W&&W.entityType;if(!L){return{loaded:function(){return Promise.reject(new h(s,"Unknown entityset "+K));}};}N=I.createBindingContext(I.getODataEntitySet(K,true));O=I.createBindingContext(I.getODataEntityType(L,true));}E(z);k(z,M);var X=p(z);var Y=sap.ui.getCore().byId(X);if(Y){l.warning("View with ID: "+X+" already exists - old view is getting destroyed now!");try{Y.destroy();}catch(Z){l.warning("Error destroying view: "+Z);}Y=null;}var $=new J(D);$.setDefaultBindingMode("OneWay");i.oParameterModel=t(L,i,I,H);z.runAsOwner(function(){var _=i.preprocessorsData;var a1={async:true,preprocessors:{xml:{bindingContexts:{entitySet:N,entityType:O},models:{device:$,appSettings:i.oTemplateContract.appSettings,entitySet:I,entityType:I,parameter:i.oParameterModel},preprocessorsData:_}},id:X,type:V.XML,viewName:z.getTemplateName(),height:"100%",cache:{keys:y,additionalData:[_]}};if(z.getDesigntimePath||z.getFlexibilityPath){var b1={key:"sap-ui-custom-settings",value:{}};if(z.getDesigntimePath){b1.value["sap.ui.dt"]={"designtime":z.getDesigntimePath()};}if(z.getFlexibilityPath){b1.value["sap.ui.fl"]={"flexibility":z.getFlexibilityPath()};}a1.customData=[new b(b1)];}a1.controller=B();Y=sap.ui.view(a1);});return Y;}function v(i,y,z){var B=i.oController.extensionAPI;var H=e({},B);if(B.getNavigationController){var N=e({},B.getNavigationController());var I=N.navigateInternal;N.navigateInternal=function(K,L){var M=L&&L.routeName;if(M){i.utils.navigateRoute(M,K,y,L&&L.replaceInHistory);}else{I(K,L);}};H.getNavigationController=function(){return N;};}H.getCommunicationObject=function(L){return L===1?z.communicationObject:i.utils.getCommunicationObject(L);};(i.methods.enhanceExtensionAPI4Reuse||Function.prototype)(H,z);return H;}function P(i,y,z,B,H){B.extensionAPI=v(i,z,B);r.transferEmbeddedComponentProxy(i,y,z,B,H);var I=i.oController.byId(B.containerId);var K=I&&I.getSettings();var L=H.getMetadata().getAllProperties();for(var M in K){if((M==="uiMode"||M==="semanticObject"||M.startsWith("st"))&&!L[M]){delete K[M];}}H.applySettings(K);I.setComponent(H);}function w(i,y,z){return z.componentUsage?i.createComponent({usage:z.componentUsage,id:y}):i.runAsOwner(function(){return a.create({name:z.componentName,id:y});});}function x(i){var y=i.oTemplateContract.mRoutingTree[i.route];i.reuseComponentsReady=new Promise(function(z,B){var H=Object.create(null);var I=z.bind(null,H);var L=function(K,M){l.error("Failed to load reuse component for key "+K,M instanceof Error?M.message:"","sap.suite.ui.generic.template.lib.TemplateComponent");};i.viewRegistered.then(function(){var K=[];for(var M in y.embeddedComponents){var N=y.embeddedComponents[M];var O=N.sectionId&&i.oController.byId(N.sectionId);if(O&&O.isStashed()){delete y.embeddedComponents[M];}else{var Q=i.oController.createId(N.containerId+"Content");var W=w(i.oAppComponent,Q,N);K.push(W);W.catch(L.bind(null,M));W.then(P.bind(null,i,H,M,N));}}Promise.all(K).then(I,function(X){var Y=i.oAppComponent.getNavigationController();Y.navigateToMessagePage({text:i.oTemplateContract.getText("ST_ERROR"),description:X instanceof Error?X.message:""});B();});});});y.willBeDisplayed.then(i.oTemplateContract.oBusyHelper.setBusy.bind(null,i.reuseComponentsReady,undefined,undefined,true));}var T=U.extend("sap.suite.ui.generic.template.lib.TemplateComponent",{metadata:{properties:{templateName:{type:"string",defaultValue:null},entitySet:{type:"string",defaultValue:null},navigationProperty:{type:"string",defaultValue:null},appComponent:{type:"object",defaultValue:null},isRefreshRequired:{type:"boolean",defaultValue:false},isLeaf:{type:"boolean"}},library:"sap.suite.ui.generic.template"},init:function(){(U.prototype.init||Function.prototype).apply(this);var i=new J({editable:false,enabled:false});this.setModel(i,"ui");var y=this.getComponentData();var z=y.registryEntry;var B=z.oTemplateContract.mRoutingTree[z.route];var H=Object.create(null);for(var K in B.embeddedComponents){H[K]={hidden:!!B.embeddedComponents[K].definition.hiddenByDefault};}var I=new J({generic:{isActive:false,listCommons:{},viewLevel:z.viewLevel,controlProperties:{},supportedIntents:{},embeddedComponents:H}});I.setDefaultBindingMode("TwoWay");this.setModel(I,"_templPriv");x(z);},getExtensionComponent:function(){return this.getAppComponent();},getManifestEntry:function(K){var i=U.prototype.getManifestEntry.apply(this,arguments);if(/^\/sap\.ui5\/componentUsages(\/.+)?$/.test(K)){i=f({},i,U.prototype.getManifestEntry.apply(this.getAppComponent(),arguments));}return i;},getComponentContainer:function(){return this.oContainer;},onBeforeRendering:function(i){if(i){var y=i.oComponent.getComponentContainer();var z=i.oAppComponent;var M=!i.createViewStarted&&y&&y.getModel();if(M){var B=g.getCacheKeyPartsAsyc(M);i.createViewStarted=true;u(i,B).loaded().then(function(H){if(i.utils.isDraftEnabled()){var I=i.utils.getRootExpand();if(I){var K=i.oComponent.getEntitySet();g.writeToLocalStorageAsync(z.getId(),K,B,I);}}i.oComponent.setAggregation("rootControl",H);i.fnViewRegisteredResolve();y.invalidate();},function(H){i.fnViewRegisteredResolve(H||{});});}}},getRouter:function(){if(this.getAppComponent()){return this.getAppComponent().getRouter();}return U.prototype.getRouter.apply(this,arguments);}});return T;});
