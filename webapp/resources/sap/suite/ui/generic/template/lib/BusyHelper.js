sap.ui.define(["sap/ui/base/Object","sap/suite/ui/generic/template/lib/MessageUtils","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/base/util/extend","sap/base/util/isEmptyObject","sap/suite/ui/generic/template/genericUtilities/FeError"],function(B,M,t,F,a,i,b){"use strict";var c="lib.BusyHelper";var f=new F(c);var l=f.getLogger();var L=f.Level;function g(T){var C=0;var m={};var I=false;var d=false;var h=0;T.oNavigationHost.setBusyIndicatorDelay(0);var u=Promise.resolve();var U=Function.prototype;var o={};var j;function k(){return h!==0||!i(m);}var A;function n(e){var y=k();if(y||e){d=false;var P=y&&!j;T.oNavigationHost.setBusy(P);l.info("Physical busy state has been changed to "+P);if(y!==I){I=y;if(!I){var z=T&&T.oNavigationControllerProxy&&T.oNavigationControllerProxy.getActiveComponents();if(z){for(var D=0;D<z.length;D++){var G=z[D];if(!G){continue;}var H=T.componentRegistry&&T.componentRegistry[G]&&T.componentRegistry[G].oController;H&&H.adaptTransientMessageExtension&&H.adaptTransientMessageExtension();}}u=Promise.resolve();var J=M.getTransientMessages();var K=q(J);var R=K?{action:T.oViewDependencyHelper.setActivePagesToDirty,actionLabel:T.getText("ETAG_REFRESH_BUTTON")}:null;u=M.handleTransientMessages(T.oApplicationProxy.getDialogFragment,o.actionLabel,R);o={};u.then(U);}}}else{var N=T.oNavigationObserver.getProcessFinished(true);N.then(A,A);}}A=n.bind(null,true);function E(e){if(e){n();}else if(!d){d=true;setTimeout(n,0);}}function p(){h--;if(!h){E(false);}}function q(e){var y=T.getText("ETAG_MESSAGE");var z=false;e.forEach(function(D){if(M.isMessageETagMessage(D)){z=true;D.setMessage(y);D.setDescription(undefined);D.setDescriptionUrl(undefined);}});return z;}function r(){if(I){return;}I=true;u=new Promise(function(R){U=R;});M.removeTransientMessages();}function s(y,z,D){var S=[],G="",H=T.oNavigationHost.getId(),J="sap.suite.ui.generic.template.busyHandling";try{throw new b(c,"Get the stack");}catch(e){S=e.stack.split(y,2);if(S.length>=2){S=S[1].split("\n");S.shift();}if(S.length){G=S[0].trim();}}if(l.getLevel(J)<L.INFO){l.setLevel(L.INFO,J);}l.info("busyHandling: "+y,D+" called (count: "+C+")",J,function(){var K={method:y,reason:D,promise:z,promisePending:true,caller:G,callStack:S,elementId:H,type:J};function P(){K.promisePending=false;}K.promise.then(P,P);return K;});}function v(R,e,y,S,z){z?j=T.bEnablePlaceholder:j=false;var D;if(e){a(o,S);r();if(!m[R]){C++;D=new Promise(function(G){m[R]=G;});if(sap.ui.support){s("setBusyReason",D,R);}}}else{if(m[R]){m[R]();}delete m[R];}E(e&&y);}function w(e,y,S,z){z?j=T.bEnablePlaceholder:j=false;C++;a(o,S);h++;r();e.then(p,p);E(y);if(sap.ui.support){s("setBusy",e,"");}}function x(){return 0;}return{setBusyReason:v,setBusy:w,isBusy:k,getUnbusy:function(){return u;},getBusyDelay:x};}return B.extend("sap.suite.ui.generic.template.lib.BusyHelper",{constructor:function(T){a(this,(t.testableStatic(g,"BusyHelper"))(T));}});});
