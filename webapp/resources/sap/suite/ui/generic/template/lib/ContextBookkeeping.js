sap.ui.define(["sap/ui/base/Object","sap/base/util/each","sap/base/util/extend","sap/suite/ui/generic/template/genericUtilities/oDataModelHelper"],function(B,e,a,d){"use strict";function g(t){var p={};var P=[];var A=Object.create(null);function c(i){var G=t.oAppComponent.getTransactionController().getDraftController();var H=G.getDraftContext();var I=i.getObject();var J=H.hasDraft(i);var K=J&&!I.IsActiveEntity;var L=K&&!I.HasActiveEntity;var M=false;var O=I.HasDraftEntity?i.getObject("DraftAdministrativeData/DraftIsCreatedByMe"):false;if(I.DraftEntityCreationDateTime&&I.DraftEntityLastChangeDateTime){M=I.DraftEntityCreationDateTime.getTime()!==I.DraftEntityLastChangeDateTime.getTime();}return{bIsDraft:K,bIsDraftSupported:J,bIsCreate:L,bIsDraftModified:M,bOwnDraftExists:O};}function r(G,V,H,K){var I=G.getPath();var J=c(G);if(V===1&&!J.bIsCreate){P.push(I);}var L=a(p[I]||{},{oContextInfo:J,oContext:G});p[I]=L;if(J.bIsDraft&&!J.bIsCreate){L.bReplaceByActive=false;}else if(J.bOwnDraftExists&&!J.bIsCreate){if(L.oEditingPromise){L.oEditingPromise.then(function(b1){var c1=b1.context.getPath();p[c1].bReplaceByActive=true;});}else{u(G).then(function(b1){var c1=b1.getPath();var d1=p[c1];if(d1){p[c1].bReplaceByActive=true;}});}}var S=null;var R;if(J.bIsDraftSupported&&!J.bIsCreate&&H){var T=t.mEntityTree[H];if(T&&!T.noOData){if(K){if(J.bIsDraft){var M=[];var N=t.oApplicationProxy.fillSiblingKeyPromise(T,K,M);N.then(function(b1){var c1=b1.getPath(3,M);if(!p[c1]){p[c1]={oContextInfo:{bIsDraft:false,bIsDraftSupported:true,bIsCreate:false,bIsDraftModified:false,bOwnDraftExists:true},aKeysFromIdentity:M};}});}if(T&&!T.noOData){var O=t.oApplicationProxy.getAncestralNode(T,1);var Q=A[O.entitySet];if(!Q){Q={treeNode:O,draftRoots:Object.create(null)};A[O.entitySet]=Q;}var U=K[1];R=Q[U];if(!R){R={treeNode:O,key:U,childContexts:Object.create(null)};Q[U]=R;}}}var W=G.getModel();var X=W.getMetaModel();var Y=X.getODataEntitySet(H);var Z=X.getODataEntityType(Y.entityType);var $=Z["com.sap.vocabularies.Common.v1.SemanticKey"];if($){S=[];for(var i=0;i<$.length;i++){S.push(G.getProperty($[i].PropertyPath));}}}}if(S){L.aSemanticKeysValues=S;}if(K){L.aKeysFromIdentity=K;}if(R){L.oRootContextInfo=R;R.childContexts[I]=L;}if(J.bIsDraftSupported&&L.oRootContextInfo){for(var _ in L.oRootContextInfo.childContexts){var a1=L.oRootContextInfo.childContexts[_];delete a1.oRemovalPromise;}}return J;}function b(){for(var i=P.length-1;i>=0;i--){var G=p[P[i]].oContext;if(G){return P[i];}}}function f(i){var G=i.getPath();var R=p[G];return R;}function h(i){var R=f(i);return!!(R&&(R.oContext||R.oRemovalPromise));}function s(i,R,I,G){if(!i.oContextInfo.bIsCreate||!I){if(G){i.oRemovalPromise=R.then(function(H){return H.context;});}else{i.oRemovalPromise=i.oSiblingPromise||(i.oContext&&u(i.oContext));}}R.then(function(){i.oContext=null;},function(){delete i.oRemovalPromise;});}function j(i,R,I,G){var H=f(i);if(G==="deleteAction"&&!H.oContextInfo.bIsCreate){H.oRemovalPromise=R.then(function(L){H.oContext=null;return L.context;},function(){delete H.oRemovalPromise;});}else if(H.oRootContextInfo){for(var J in H.oRootContextInfo.childContexts){var K=H.oRootContextInfo.childContexts[J];if(K.oContextInfo.bIsDraftSupported){s(K,R,I,H===K);}}}else{s(H,R,I,true);}if(!H.oContextInfo.bIsCreate||!I){R.then(function(L){var M=L.context.getPath();var N=p[M];if(N){delete N.oEditingPromise;m(N,false);}});}}function k(i,G){j(i,G,false);}function l(i,G,H){j(i,G,true,H);}function m(i,G){if(i.oRootContextInfo){e(i.oRootContextInfo.childContexts,function(){this.oContextInfo.bOwnDraftExists=G;});}else{i.oContextInfo.bOwnDraftExists=G;}}function n(i,G){var H=f(i);H.oEditingPromise=new Promise(function(R,I){var N=function(){delete H.oEditingPromise;m(H,false);I();};G.then(function(J){if(J.draftAdministrativeData){N();}else{m(H,true);var K=J.context.getPath();p[K]={sActiveContextPath:i.getPath(),oContext:J.context,oContextInfo:{bIsDraft:true,bIsDraftSupported:true,bIsCreate:false,bIsDraftModified:false,bOwnDraftExists:false}};R(J);}},N);});H.oEditingPromise.catch(Function.prototype);}function o(i){var G=p[i];if(G){G.oContext=null;}}function q(M,i,G){return new Promise(function(R,H){M.read(i+"/SiblingEntity",{success:function(I){if(I){var S="/"+M.getKey(I);var J=M.getContext(S);R(J);}else{H();}},error:function(I){H(I);},groupId:G});});}function u(i,G){var H=f(i);if(H.oContextInfo.bIsCreate){return Promise.resolve();}else if(H.sActiveContextPath){var I=p[H.sActiveContextPath];return Promise.resolve(I.oContext);}var S=H.oSiblingPromise;if(!S){if(H.oContextInfo.bIsDraftSupported&&H.oEditingPromise){S=H.oEditingPromise.then(function(J){var K=J.context.getPath();var L=K&&p[K];if(L&&!L.oRemovalPromise){return Promise.resolve(J.context);}else{return q(i.getModel(),i.getPath());}});}else{S=H.oContextInfo.bIsDraftSupported?q(i.getModel(),i.getPath(),G):Promise.resolve(i);if(H.oContextInfo.bIsDraft||!H.oContextInfo.bIsDraftSupported){H.oSiblingPromise=S;}}}return S;}function v(i,G){var H=p[i];if(H&&H.oSiblingPromise){return H.oSiblingPromise;}else if(H&&H.sActiveContextPath){var I=p[H.sActiveContextPath];return Promise.resolve(I.oContext);}else{var S=H&&H.oContext?u(H.oContext,G):q(t.oAppComponent.getModel(),i,G);S.then(function(J){if(J){var K=d.analyseContext(J).canonicalPath;if(!p[K]){p[K]={oContextInfo:c(J),oContext:J};}}var L=H&&H.oContext;if(!L){var M=t.oAppComponent.getModel();L=M.createBindingContext(i);if(L){H=H||{};H.oContext=L;H.oContextInfo=c(L);p[i]=H;}}if(L&&J&&H.oContextInfo.bIsDraftSupported){var N=H.oContextInfo.bIsDraft?i:K;var O=H.oContextInfo.bIsDraft?K:i;p[N].sActiveContextPath=O;}});return S;}}function w(i){if(i.treeNode.level===0){return Promise.resolve();}var M=t.oApplicationProxy.getAncestralNode(i.treeNode,1);if(M.noOData||!M.isDraft){return Promise.resolve();}var G=M.getPath(3,i.keys.slice(0,2));return x(G).then(function(H){if(!H){return null;}var I=H.iDisplayMode||1;var J=false;var T=H.context?["",d.analyseContext(H.context).key]:[""];var K=function(N){if(!J&&I===2){I=N.isDraft?6:1;}var O={treeNode:N,keys:T};var R={identity:O,displayMode:I};return t.oNavigationControllerProxy.adaptAppStates(i,O).then(function(){return R;});};if(!H.context){return K(t.mRoutingTree.root);}var L=function(N){if(N===i.treeNode){return K(N);}var O=t.oApplicationProxy.getAncestralNode(i.treeNode,N.level+1);var Q=i.keys.slice(0,O.level+1);var R=O.getPath(3,Q);return x(R).then(function(S){if(!S||!S.context){return K(N);}T.push(d.analyseContext(S.context).key);I=S.iDisplayMode;J=true;return L(O);});};return t.oApplicationProxy.fillSiblingKeyPromise(i.treeNode,i.keys,T).then(L);});}function x(i){var G=p[i];if(!G){return Promise.resolve();}if(!G.oContext){return Promise.resolve({});}return new Promise(function(R){var H=null;var I=function(){R(H);};var J=function(K){K.then(function(L){var M=L.context.getPath();var N=p[M];if(N&&N.oContext&&!N.bReplaceByActive){H={context:L.context,iDisplayMode:2};}I();},I);};if(G.oRemovalPromise){G.oRemovalPromise.then(function(K){H={context:K,iDisplayMode:1};var L=K.getPath();var M=p[L];var N=M&&M.oEditingPromise;if(N){J(N);}else{I();}},I);}else if(G.bReplaceByActive){u(G.oContext).then(function(K){H={context:K,iDisplayMode:1};I();});}else if(!G.oContextInfo.bIsDraft&&G.oContextInfo.bOwnDraftExists){if(G.oEditingPromise){J(G.oEditingPromise);}else if(G.oContext){u(G.oContext).then(function(K){var L=K.getPath();var M=p[L];if(!M||!M.bReplaceByActive){H={context:K,iDisplayMode:2};}I();});}else{I();}}else{I();}});}function y(i){var G=f(i);return G&&G.aKeysFromIdentity;}function z(G,H,I,J,N){return new Promise(function(R,K){var M=t.oAppComponent.getModel();var L=G&&d.analyseContextPath(G,M).canonicalPath;var O=H&&d.analyseContextPath(H,M).canonicalPath;if(L===O){R(true);return;}if(!L||!O){R(false);return;}var Q=p[L];if(!Q||!Q.oContextInfo.bIsDraftSupported){R(false);return;}var S=p[O];var T,U;if((!Q||!Q.oContext)&&(S&&!S.oContextInfo.bIsDraft)){var V=function(i){return i;};Q=V(S,S=Q);L=V(O,O=L);J=V(N,N=J);}function W(Q,S){if(!Q||!S){R(false);return;}if(!Q.oContextInfo.bIsDraft&&!S.oContextInfo.bIsDraft){R(false);return;}if(Q.oContextInfo.bIsCreate&&S.oContextInfo.bIsCreate){R(false);return;}if(I){x(L).then(function(_){R(!!(_&&_.context)&&_.context.getPath()===O);},K);return;}if(Q.aSemanticKeysValues){var $=!!S.aSemanticKeysValues;for(var i=0;$&&i<Q.aSemanticKeysValues.length;i++){$=Q.aSemanticKeysValues[i]===S.aSemanticKeysValues[i];}R($);return;}R(false);}if(Q.oContext&&!Q.oContextInfo.bIsDraft&&(!S||!S.oContext)){if(S&&S.oRemovalPromise){S.oRemovalPromise.then(function(i){var $=d.analyseContext(i).canonicalPath;R($===L);});return;}if(J&&N&&J.treeNode.entitySet===N.treeNode.entitySet){U=N&&N.keys;var X=M.getContext(O)||M.createBindingContext(O);var Y=X&&c(X);if(X&&!Y.bIsDraft){R(false);}else{var Z=u(Q.oContext);Z.then(function(i){if(i.sPath&&O===i.sPath){T=i;S=p[O];if(!S||!S.oContext){r(T,N.treeNode.level,N.treeNode.entitySet,U);p[O].sActiveContextPath=Q.oContext.getPath();}W(Q,p[O]);}else{R(false);}},function(){R(false);});}}else{R(false);return;}}else{W(Q,S);}});}function C(i){return p[i].oContextInfo.bIsDraftModified;}function D(i){if(p[i]){p[i].oContextInfo.bIsDraftModified=true;}}function E(i){if(p[i]){return p[i].oContextInfo.bIsDraft;}}function F(i){if(p[i]){return p[i].oContext;}}return{registerContext:r,adaptAfterObjectDeleted:o,activationStarted:k,cancellationStarted:l,editingStarted:n,getDraftSiblingPromise:u,getSiblingPromise:v,getAlternativeIdentityPromise:w,getPathOfLastShownDraftRoot:b,areTwoKnownPathesIdentical:z,markDraftAsModified:D,getIsDraftModified:C,getIdentityKeyForContext:y,checkmPath2ContextData:h,checkIfObjectIsADraftInstance:E,getContextForPath:F};}return B.extend("sap.suite.ui.generic.template.lib.ContextBookkeeping",{constructor:function(t){a(this,g(t));}});});
