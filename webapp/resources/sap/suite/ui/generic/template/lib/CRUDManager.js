sap.ui.define(["sap/ui/base/Object","sap/ui/generic/app/util/ModelUtil","sap/ui/generic/app/util/ActionUtil","sap/suite/ui/generic/template/lib/MessageUtils","sap/suite/ui/generic/template/lib/CRUDHelper","sap/suite/ui/generic/template/genericUtilities/CacheHelper","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/base/util/extend","sap/base/util/isEmptyObject","sap/suite/ui/generic/template/genericUtilities/FeError","sap/ui/model/Context","sap/m/MessageBox","sap/suite/ui/generic/template/genericUtilities/oDataModelHelper"],function(B,M,A,a,C,b,t,e,c,F,d,f,D){"use strict";var s="lib.CRUDManager";var r=Promise.reject();r.catch(Function.prototype);function g(o,k,v){var H=o.getHeaders();var i=e({},H);if(v===undefined){delete i[k];}else{i[k]=v;}o.setHeaders(i);}function m(o){return Object.keys(o).map(function(k){return o[k];});}function h(i){if(i){return i.map(function(k,l){return l;});}}function j(o,l,S,n,p){function q(i,k,W,X){if(W){a.handleError(i,o,S,W,X);}return(k||Function.prototype)(W);}var E;function u(i){return new Promise(function(k,W){var X=o.getOwnerComponent();var Y=X.getBindingContext();var Z=X.getModel();Z.read(Y.getPath(),{urlParameters:{"$expand":"DraftAdministrativeData"},success:function($){if(!$.DraftAdministrativeData){if(i){return q(a.operations.editEntity,W,i);}return k({});}if($.DraftAdministrativeData.InProcessByUser){var _=$.DraftAdministrativeData.InProcessByUserDescription||$.DraftAdministrativeData.InProcessByUser;var a1=Promise.resolve(i||l.getMainComponentUtils().then(function(b1){var c1=b1.getText("ST_GENERIC_DRAFT_LOCKED_BY_USER",[" ",_]);return new F(c1);}));return a1.then(function(i){q(a.operations.editEntity,W,i,i);});}return k({draftAdministrativeData:$.DraftAdministrativeData});},error:q.bind(null,a.operations.editEntity,W)});});}function v(){var i=o.getView().getModel().getMetaModel();var k=i.getODataEntityContainer();var W=k["Org.OData.Capabilities.V1.BatchSupport"];if(W&&W.ReferencesAcrossChangeSetsSupported&&W.ReferencesAcrossChangeSetsSupported.Bool){return W.ReferencesAcrossChangeSetsSupported.Bool==="true";}return false;}function w(){return new Promise(function(i){if(v()){l.getMainComponentUtils().then(function(k){i(k.getRootExpand());});}else{i(null);}});}function x(i,k,W){var X=i.bindingContext;if(W&&W.draftAdministrativeData){return Promise.resolve(W);}return w().then(function(Y){return new Promise(function(Z,$){S.oTransactionController.editEntity(X,!k,Y).then(function(_){var a1;a1=i.view;var b1=function(){X.getModel().invalidateEntry(X);a1.detachEvent("modelContextChange",b1);};if(a1){a1.attachEvent("modelContextChange",b1);}return Z({context:_.context});},function(_){if(_&&_.response&&_.response.statusCode==="409"&&!k){a.removeTransientMessages();return u(_).then(Z,$);}else{q(a.operations.editEntity,$,_,_);}});});});}E=function(i){var k=l.isDraftEnabled();var W,X;if(k){var Y=l.getViewLevel();var Z;if(Y>0){Z=l.getMainComponentDetails();var $=S.oApplication.checkContextData(Z.bindingContext);if(!$){S.oApplication.registerContext(Z.bindingContext,1,Z.entitySet,S.oApplication.getCurrentKeys(1));}X=l.getTargetKeyFromLevel(2);}if(!i){var _=S.oDraftController.getDraftContext();var a1=_.hasPreserveChanges(Z.bindingContext);if(!a1){W=u().then(x.bind(null,Z,true));}}W=W||x(Z,i,{});S.oApplication.editingStarted(Z.bindingContext,W);}else{var b1=o.getView().getBindingContext();W=Promise.resolve({context:b1});}var c1=Promise.all([W,X]);return c1.then(function(d1){var e1={};var f1=Object.keys(d1[0])[0];e1[f1]=d1[0][f1];e1.targetSiblingKey=d1[1];return e1;});};function y(i){if(p.isBusy()){return r;}var k=E(i);p.setBusy(k);return k;}function z(i,k,W){var X=new Promise(function(Y,Z){var $=function(){var b1=M.getEntitySetFromContext(W);var c1=S.oDraftController.getDraftContext();var d1=c1.isDraftRoot(b1);var e1=l.getViewLevel();var f1=e1>=2?n.getText("ITEM_DELETED"):n.getText("ST_GENERIC_OBJECT_DELETED");if(!i&&d1){f1=n.getText(k?"ST_GENERIC_DRAFT_WITH_ACTIVE_DOCUMENT_DELETED":"ST_GENERIC_DRAFT_WITHOUT_ACTIVE_DOCUMENT_DELETED");}a.showSuccessMessageIfRequired(f1,S);};var _=function(b1){if(b1.length===0){$();Y();}else{a.handleError(a.operations.deleteEntity,o,S,b1[0].oError,null);Z();}};var a1=H({pathes:[W.getPath()],withWarningDialog:true});a1.then(_,Z);});return X;}function G(){var i=new Promise(function(k,W){var X=o.getView().getBindingContext();var Y=S.oDraftController.isActiveEntity(X);var Z=S.oDraftController.hasActiveEntity(X);var $=Z&&!Y?S.oApplication.getDraftSiblingPromise(X):Promise.resolve();$.then(function(_){var a1=z(Y,Z,X);a1.then(k,W);if(!Y){var b1=function(){return{context:_};};var c1=a1.then(b1);S.oApplication.cancellationStarted(X,c1,"deleteAction");}},W);});return i;}function P(k,W,X){var Y={mFailed:Object.create(null),mSuccess:Object.create(null),mWarning:Object.create(null),aMessagesForUserDecision:[]};for(var i=0;i<k.length;i++){var Z=k[i];var $=W[i];var _=a.parseError($);var a1=parseInt(_.httpStatusCode,10);var b1=$&&$.response&&$.response.headers;if((a1>=200&&a1<300)||a1===304){Y.mSuccess[Z]=$;}else if(a1===412&&b1&&b1["preference-applied"]){Y.mWarning[Z]=$;}else{Y.mFailed[Z]=$;}}if(!c(Y.mWarning)&&X){Y.aMessagesForUserDecision=a.getTransientMessages();a.removeTransientMessages();}return Y;}function H(i){var W=new Promise(function(X,Y){var Z=Object.create(null);var $=Object.create(null);var _=function(a1,i1,j1){$[a1]={resolve:i1,reject:j1};};for(var k=0;k<i.pathes.length;k++){var a1=i.pathes[k];Z[a1]=new Promise(_.bind(null,a1));}S.oApplication.prepareDeletion(Z,i.suppressRefreshAllComponents);var b1=Object.create(null);var c1=Object.create(null);var d1;var e1=function(i1){if(!c(b1)){S.oApplication.markCurrentDraftAsModified();}for(var a1 in $){var j1=$[a1];j1[b1[a1]?"resolve":"reject"]();}if(i1){return Y();}var k1=i.pathes.map(function(a1){return{sPath:a1,oError:c1[a1]||d1[a1],isWarning:!!d1[a1]};}).filter(function(l1){return!!l1.oError;});X(k1);};var f1=function(i1){if(i1.length>0){var j1=l.getCRUDActionHandler();var k1={messagesForUserDecison:i1};j1.handleCRUDScenario(4,g1.bind(null,Object.keys(d1),false,false),e1.bind(null,true),"Delete",k1);return;}e1();};var g1=function(i1,j1,h1){if(i.suppressRefreshAllComponents&&i.smartTable){S.oPresentationControlHandlerFactory.getPresentationControlHandler(i.smartTable).refresh("Changes");}var k1=function(m1){var n1=P(i1,m1,h1,i.onlyOneDraftPlusActive);c1=e(c1,n1.mFailed);b1=e(b1,n1.mSuccess);d1=n1.mWarning;f1(n1.aMessagesForUserDecision);};var l1=S.oTransactionController.deleteEntities(i1,{bIsStrict:j1}).then(k1,k1);p.setBusy(l1);};var h1=i.withWarningDialog&&(i.pathes.length===1||i.onlyOneDraftPlusActive);g1(i.pathes,true,h1);});return W;}function I(i){var k=S.oDraftController.hasActiveEntity(i);var W=k?S.oApplication.getDraftSiblingPromise(i):Promise.resolve();return W.then(function(X){var Y=function(){return{context:X};};var Z=S.oTransactionController.deleteEntity(i);var $=Z.then(Y);S.oApplication.cancellationStarted(i,$,"discardAction");return Z;});}function J(i){var k=S.oTransactionController.updateMultipleEntities(i);p.setBusy(k);return k;}function K(i,k,W){var X=k.getMessageModel();var Y=X.bindList("/",null,null,[i]);var Z=Y.getCurrentContexts().map(function($){return $.getObject();});if(W){Z=Z.filter(function($){return!a.isMessageETagMessage($);});}return Z;}function L(i,k,W){if(p.isBusy()){k();return;}var X,Y,Z=Object.create(null),Y;X=sap.ui.getCore().getMessageManager();var $=W?W:S.oTemplateCapabilities.oMessageButtonHelper&&S.oTemplateCapabilities.oMessageButtonHelper.getContextFilter(false);Y=K($,X,true);Y=Y.map(function(c1){Z[c1.getId()]=c1;return c1;});var _=o.getView().getModel();var a1=function(){var c1=l.getCRUDActionHandler();c1.handleCRUDScenario(4,b1.bind(null,false),k,"Activate");};var b1=function(c1){if(c1){g(_,"Prefer","handling=strict");}else{g(_,"Prefer","handling=lenient");}var d1=S.oTransactionController.triggerSubmitChanges().then(function(e1){g(_,"Prefer");X.removeMessages(Y);i(e1.context);},function(e1){var f1=false;g(_,"Prefer");var g1=[];var h1=K($,X,true);var i1=h1.map(function(j1){if(!Z[j1.getId()]){j1.persistent=false;j1.technical=false;f1=f1||j1.technicalDetails.statusCode==="412"&&j1.technicalDetails.headers["preference-applied"]==="handling=strict";g1.push(j1);}return j1;});if(g1.length){X.removeMessages(i1);X.addMessages(g1);if(f1&&c1){a1();return;}if(!W){S.oTemplateCapabilities.oMessageButtonHelper.showMessagePopover();}}k();});p.setBusy(d1);};b1(true);}function N(i){var k=i;var W=new Promise(function(X,Y){S.oApplication.performAfterSideEffectExecution(L.bind(null,X,Y,k));});return W;}function O(i,k){if(p.isBusy()){return r;}var W=new Promise(function(X,Y){var Z=i?i:o.getView().getBindingContext();var $=k?k:S.oTemplateCapabilities.oMessageButtonHelper&&S.oTemplateCapabilities.oMessageButtonHelper.getContextFilter(true);var _=sap.ui.getCore().getMessageManager();var a1=false;var b1=function(){a1=true;var c1=function(){var e1=K($,_);var f1=S.oDraftController.activateDraftEntity(Z,true);S.oApplication.activationStarted(Z,f1);f1.then(function(g1){X(g1);},function(g1){var h1=K($,_).filter(function(k1){return k1.type==="Error";});if(h1.length){var i1=h1[0];var j1=e1.some(function(k1){return i1===k1;});if(!j1){a.removeTransientMessages();}}a.handleError(a.operations.activateDraftEntity,o,S,g1,null);Y();});p.setBusy(f1);};var d1=l.getCRUDActionHandler();d1.handleCRUDScenario(4,c1,Y,"Activate");};S.oApplication.getDraftSiblingPromise(Z).then(function(c1){if(c1){o.getOwnerComponent().getModel().invalidateEntry(c1);}var d1=K($,_);var e1=v()?l.getRootExpand():null;var f1=S.oDraftController.activateDraftEntity(Z,false,e1);p.setBusy(f1);S.oApplication.activationStarted(Z,f1);f1.then(function(g1){_.removeMessages(d1);X(g1);},function(g1){var h1=K($,_);if(h1.length){var i1=h1[0];var j1=d1.some(function(k1){return i1===k1;});if(!j1){a.removeTransientMessages();}}if(!i){a.handleError(a.operations.activateDraftEntity,o,S,g1,null,{"412":b1});if(!a1){Y();}}});});});return W;}function Q(i){return new A(i);}function R(i,k){if(!l.isDraftEnabled()){var W=n.getOwnerControl(i);var X,Y;if(W.getBindingContext()&&(W.getBindingContext().getPath()!==W.getParent().getEntitySet())){X=W.getBindingContext();Y=W.getParent().getTableBindingPath();}else{var Z=W.getModel();var $="/"+(W.getEntitySet?W.getEntitySet():W.getParent().getEntitySet());X=new d(Z,$);}return S.oTransactionController.getDefaultValues(X,k,Y);}else{return k;}}function T(i,k,W,X){if(p.isBusy()){X();return;}var Y=[];var Z=[];var $=[];var _=false;var a1;var b1=[];var c1=i.functionImportPath;var d1=i.contexts||[];var e1=i.sourceControlHandler;if(d1.length===0&&e1){var f1=e1.getModel();var g1="/";var h1=e1.getEntitySet();var i1=g1.concat(h1);d1.push(new d(f1,i1));}var j1=i.label;var k1=i.operationGrouping;var l1=i.skipProperties;var m1=function(){if(d1[0]){var r1=d1[0].oModel;if(r1&&r1.hasPendingChanges()){r1.resetChanges();}}};var n1=function(r1){m1();X(r1);};var o1=function(r1,s1){if(r1.length>0){var t1=l.getCRUDActionHandler();var u1;if(d1.length===0){u1=q1.bind(null,false,false,d1);}else{var v1=d1.filter(function(w1,x1){return b1.includes(""+x1);});u1=q1.bind(null,false,false,v1);}var i={messagesForUserDecison:r1,actionName:j1};t1.handleCRUDScenario(4,u1,s1,"BOPFAction",i);return;}s1();};var p1=d1.length<=1;var q1=function(r1,p1,s1){if(!r1){m1();}var t1=Q({controller:o,contexts:s1,applicationController:S.oApplicationController,operationGrouping:k1});t1.call(c1,j1,l.isDraftEnabled(),l1,r1,a1).then(function(w1){var x1={};x1.actionLabel=j1;p.setBusy(w1.executionPromise,null,x1);w1.executionPromise.then(u1,u1);},n1);var u1=function(w1){var x1=Array.isArray(w1)?w1:[w1];var y1=h(x1);var z1=x1.map(function(B1){var C1=B1.error||B1.response;if(C1){C1.actionContext=B1.actionContext;}return C1;});a1=x1[0].userEnteredAdditionalParams;var A1=P(y1,z1,p1);Z=Z.concat(m(A1.mFailed));Y=Y.concat(m(A1.mSuccess));b1=Object.keys(A1.mWarning);$=m(A1.mWarning);o1(A1.aMessagesForUserDecision,v1.bind(null,x1));};var v1=function(w1){var x1=Z.concat(Y.concat($));if(x1.length>1){var y1=$.length>0;var z1=Z.concat($);var A1=x1.length;var B1=z1.length;if(B1>0){var C1;if(A1===B1){C1=n.getText("ST_GENERIC_NOT_PROCESSED_RECORDS_PLURAL");}else{C1=n.getText("ST_GENERIC_NOT_PROCESSED_RECORDS",[B1,A1]);}if(y1){C1=C1+'\n';if(B1===1){C1=C1+n.getText("ST_GENERIC_ACTION_WITH_WARNING_SUGGESTION_SINGULAR");}else{C1=C1+n.getText("ST_GENERIC_ACTION_WITH_WARNING_SUGGESTION_PLURAL");}}p.getUnbusy().then(function(){if(Z.length>1){f.error(C1);}else{f.warning(C1);}});}}var D1,E1;_=_||t1.getExecutedSuccessfully();if(_){var F1;if(Y.length===1&&$.length===0&&Z.length===0){D1=Y[0];F1=w1[0].actionContext;}E1=D1&&D1.context;var G1;if(E1&&E1.getObject()){G1=S.oApplication.registerContext(E1);}if(E1&&E1!==F1&&E1.getPath()!=="/undefined"){S.oApplication.navigateToDetailContextIfPossible(E1,false,G1.bIsDraft?2*(1+G1.bIsCreate):1,G1);}var H1=e1.getBindingInfo();var I1=H1&&H1.binding;if(I1&&I1.oEntityType){e1.setEnabledToolbarButtons();if(l.getViewLevel()===0){e1.setEnabledFooterButtons();}}W(x1);}else{m1();X(x1);}};};q1(true,p1,d1);}function U(i,k){var W=new Promise(function(X,Y){S.oApplication.performAfterSideEffectExecution(T.bind(null,i,k,X,Y));});return W;}function V(i,k){if(!i){throw new F(s,"Unknown Table");}var W="";var X="";var Y;var Z=o.getOwnerComponent();var $=Z.getAppComponent();if(Z.getMetadata().getName()==="sap.suite.ui.generic.template.ListReport.Component"){Y=(Z.getCreationEntitySet&&Z.getCreationEntitySet())||(i.getEntitySet&&i.getEntitySet());}else{Y=(Z.getCreationEntitySet&&Z.getCreationEntitySet())||Z.getEntitySet();}var _=o.getView();var a1=_.getModel();var b1=_.getBindingContext();if(b1){X=S.oPresentationControlHandlerFactory.getPresentationControlHandler(n.getOwnerPresentationControl(i)).getBindingInfo().path;var c1=a1.getMetaModel();var d1=c1.getODataEntitySet(Y);var e1=c1.getODataEntityType(d1.entityType);var f1=c1.getODataAssociationSetEnd(e1,X);if(f1){Y=f1.entitySet;}X="/"+X;W=Z.getComponentContainer().getElementBinding().getPath()+X;}else{W="/"+Y;}return new Promise(function(g1,h1){var i1=b.getCacheKeyPartsAsyc(a1);Promise.all(i1).then(function(j1){function k1(q1){S.oApplication.getBusyHelper().setBusy(q1);}var l1;if(v()){var m1=b.getCacheKey($.getId(),Y,j1);l1=b.readFromLocalStorage(m1);}else{l1=null;}var n1=l.getSettings();var o1={sRootExpand:l1,oController:o,oApplicationController:S.oApplicationController,bUseNewActionForCreate:n1&&n1.useNewActionForCreate,fnSetBusy:k1};var p1=C.create(S.oDraftController,Y,W,a1,S.oApplication,k,o1);p1.catch(q.bind(null,a.operations.addEntry,function(q1){h1();if(q1){throw q1;}}));p1.then(function(q1){S.oApplication.markCurrentDraftAsModified();var j1=l.getCurrentKeys();j1.push(D.analyseContext(q1).key);var r1=j1.length-1;S.oApplication.registerContext(q1,r1,Y,j1);g1(q1);});l.preloadComponent(Y);});});}var q=t.testable(q,"handleError");var Q=t.testable(Q,"getActionUtil");return{editEntity:y,deleteEntity:G,deleteEntities:H,saveEntity:N,activateDraftEntity:O,discardDraft:I,callAction:U,addEntry:V,updateMultipleEntities:J,getDefaultValues:R};}return B.extend("sap.suite.ui.generic.template.lib.CRUDManager",{constructor:function(o,i,S,k,l){e(this,j(o,i,S,k,l));}});});
