sap.ui.define(["sap/base/util/extend","sap/base/util/isEmptyObject","sap/base/util/each","sap/m/MessageBox","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/analytics/odata4analytics","sap/ui/generic/app/util/ModelUtil","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/suite/ui/generic/template/genericUtilities/oDataModelHelper","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/suite/ui/generic/template/lib/CRUDHelper","sap/base/util/deepExtend"],function(e,a,b,M,F,c,o,d,f,D,t,C,g){"use strict";var s="lib.navigation.startupParameterHelper";var l=new f(s).getLogger();function h(i,O){return{mode:i&&O&&(O!==i)?"inconsistent":O||i||"display",force:!!O};}function p(i,O,Q,R){var S=r(O,Q,"Edm.DateTime");j(S,R);var U=i.oAppComponent.getModel("_templPrivGlobal");U.setProperty("/generic/forceFullscreenCreate",true);}function T(i,O){if(a(O)){return;}i.forEach(function(Q){var R=O[Q.name];if(R){var S=R[0];S=S.toLowerCase().replace(/(guid')([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})(')/,"$2");if(!S.match(/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/)){S=S.replace(/([0-9a-f]{8})([0-9a-f]{4})([0-9a-f]{4})([0-9a-f]{4})([0-9a-f]{12})/,"$1-$2-$3-$4-$5");}R[0]=S;}});}function j(i,O){if(a(O)){return;}i.forEach(function(Q){var R=O[Q.name];if(R&&typeof R[0]==="string"&&Q["type"]==="Edm.DateTime"&&Q["sap:display-format"]==="Date"){var S=new Date(R[0]);R[0]=S;}});}function r(i,O,Q){var R=i.getMetaModel();var S=R.getODataEntitySet(O);var U=S&&S.entityType;var V=R.getODataEntityType(U);var W=(V&&V.property)||[];var X=[];W.forEach(function(Y){if(Q===Y.type){X.push(Y);}});return X;}function k(i,O,Q){if(a(Q)){return;}var R=r(i,O,"Edm.Guid");T(R,Q);}function m(i){var O=i.oAppComponent.getInboundParameters();return O?Object.keys(O).filter(function(Q){return O[Q].useForCreate;}):[];}function P(O,Q){var R;var S=m(O);for(var i=0;i<S.length;i++){var U=S[i];var V=Q[U];if(V&&V.length===1){R=R||Object.create(null);R[U]=V[0];}}return R;}function n(i,O,Q){var R=i.getODataEntityType(i.getODataEntitySet(O).entityType);R.property.forEach(function(S){if(S["com.sap.vocabularies.Common.v1.EditableFieldFor"]){var U=S["com.sap.vocabularies.Common.v1.EditableFieldFor"].PropertyPath||S["com.sap.vocabularies.Common.v1.EditableFieldFor"].String;var V=S.name;if(Q[U]&&!Q[V]){Q[V]=Q[U];}if(Q[V]&&!Q[U]){Q[U]=Q[V];}}});}function q(i,O){return!(i.page.navigation&&i.page.navigation[O.mode]);}function u(i,O){return!!i&&i.every(function(Q){var R=Q.name||Q.PropertyPath;var S=O[R]||[];return S.length===1;});}function v(i){var S=D.splitCanonicalPath(i);return S.key;}function w(i,O,Q,R,S){if(Q.noKey){return{treeNode:Q,navigationPossible:true,keyValue:""};}var U=O.getODataEntitySet(Q.entitySet);if(!U){return null;}var V=O.getODataEntityType(U.entityType);var W=V["com.sap.vocabularies.Common.v1.SemanticKey"];if(u(W,R)){return{treeNode:Q,key:W,isSemantic:true};}return S&&V.key.propertyRef&&u(V.key.propertyRef,R)&&{treeNode:Q,navigationPossible:true,keyValue:v(i.createKey(Q.entitySet,R))};}function x(i,O,Q,R,S,U,V){R.children.forEach(function(W){var X=Q.mEntityTree[W];if(X.page.component.settings&&X.page.component.settings.allowDeepLinking&&q(X,U)){var Y=w(i,O,X,S,false);if(Y){V[X.sRouteName]=Y;x(i,O,Q,X,S,U,V);}}});}function y(i,O,Q,R,S){var U=Object.create(null);U.root={treeNode:O.mRoutingTree.root,navigationPossible:true,keyValue:""};var V=O.mEntityTree[Q];if(V&&!(V.page.component.settings&&V.page.component.settings.allowDeepLinking===false)&&q(V,S)){var W=i.getMetaModel();var X=w(i,W,V,R,true);if(X){U[V.sRouteName]=X;if(S.mode==="display"){x(i,W,O,V,R,S,U);}}}return U;}function z(i,O){var Q=O.key.map(function(S){var U=S.PropertyPath;var V=i[U][0];return new F(U,c.EQ,V);});if(O.treeNode.isDraft){var R=new F({filters:[new F("IsActiveEntity","EQ",false),new F("SiblingEntity/IsActiveEntity","EQ",null)],and:false});Q.push(R);}return new F(Q,true);}function A(O,Q,R){var S=R.treeNode.entitySet;var U="/"+S;try{var V=new o.Model(o.Model.ReferenceByModel(O));var W=V.findQueryResultByName(S);var X=new o.QueryResultRequest(W);var Y=W&&W.getParameterization();var Z=false;if(Y){X.setParameterizationRequest(new o.ParameterizationRequest(Y));var $=Y.getAllParameterNames();b($,function(){if(Q.hasOwnProperty(this)){Z=true;X.getParameterizationRequest().setParameterValue(this,Q[this][0]);}});for(var i=0;i<$.length;i++){if($[i].startsWith("P_")){var _=$[i].substr(2);if(Q.hasOwnProperty(_)){Z=true;X.getParameterizationRequest().setParameterValue($[i],Q[_][0]);}}}if(Z){U=X.getURIToQueryResultEntitySet();}}}catch(a1){l.info(a1.name+":"+a1.message);}return U;}function B(R){if(!(R&&R.results)){return null;}var i;R.results.some(function(O){i=O;return O.IsActiveEntity;});return i;}function E(i,O,Q){var R=z(O,Q);var S=A(i,O,Q);return new Promise(function(U){i.read(S,{filters:[R],success:function(V){var W=B(V);var X=W&&i.getKey(W);var Y=X&&v(X);U(Y);},error:function(){U();}});});}function N(O,Q,R,S){var U=Object.keys(R).filter(function(i){return!R[i].navigationPossible;});var V=U.map(function(i){var W=R[i];return E(Q,S,W);});return Promise.all(V).then(function(W){for(var i=0;i<U.length;i++){var X=R[U[i]];X.keyValue=W[i];}var Y=function(c1){var X=R[c1];if(X.navigationPossible===undefined){X.navigationPossible=!!X.keyValue&&Y(X.treeNode.parentRoute);}return X.navigationPossible;};var Z;b(R,function(c1){if(Y(c1)){var d1=R[c1].treeNode;Z=(!Z||Z.level<d1.level)?d1:Z;}});var $=[];for(var _=Z;_;_=_.level&&O.mRoutingTree[_.parentRoute]){$[_.level]=R[_.sRouteName].keyValue;}var a1=Object.create(null);if(O.oFlexibleColumnLayoutHandler){O.oFlexibleColumnLayoutHandler.adaptAppStatesForExternalNavigation(Z,a1);}var b1={treeNode:Z,keys:$,appStates:a1};return O.oNavigationControllerProxy.navigateToIdentity(b1,true,1).then(Function.prototype);});}function G(O,Q){if(Q==="create"&&O.mRoutingTree.root.page.component.settings&&O.mRoutingTree.root.page.component.settings.creationEntitySet){return Promise.resolve(O.mRoutingTree.root.page.component.settings.creationEntitySet);}return O.myIntentPromise?O.myIntentPromise.then(function(R){var S=O.mRoutingTree.root.children;for(var i=0;i<S.length;i++){var U=S[i];if(O.mEntityTree[U].semanticObject===R.semanticObject){return U;}}return O.mRoutingTree.root.entitySet;}):Promise.resolve(O.mRoutingTree.root.entitySet);}function H(i,O,Q,R){O=g({},O);p(i,Q,R,O);var S=P(i,O);var U=i.oAppComponent.getTransactionController().getDraftController();var V=U.getDraftContext().isDraftEnabled(R);if(V){var W=i.mEntityTree[R]||i.mRoutingTree.root;i.oNavigationControllerProxy.prepareHostView(W);var X=i.oNavigationControllerProxy.oRouter.getTargets();X.display(W.sRouteName);return W.componentCreated.then(function(Z){var $=i.componentRegistry[Z.getId()];return $.viewRegistered.then(function(){var _=null;var a1=$.oController;var b1=i.oAppComponent.getApplicationController();var c1=!!(i.mRoutingTree.root.page.component.settings&&i.mRoutingTree.root.page.component.settings.useNewActionForCreate);var d1={sRootExpand:_,oController:a1,oApplicationController:b1,bUseNewActionForCreate:c1};var e1=C.create(U,R,"/"+R,Q,i.oApplicationProxy,S,d1);return e1.then(function(f1){var Y=Object.create(null);if(i.oFlexibleColumnLayoutHandler){var W=i.mEntityTree[R];i.oFlexibleColumnLayoutHandler.adaptAppStatesForExternalNavigation(W,Y);}return i.oNavigationControllerProxy.navigateToSubContext(f1,true,4,null,Y).then(Function.prototype);},function(f1){return{title:i.getText("ST_GENERIC_ERROR_TITLE"),text:f1.messageText,description:"",icon:"sap-icon://message-error"};});});});}var Y=Object.create(null);if(i.oFlexibleColumnLayoutHandler){i.oFlexibleColumnLayoutHandler.adaptAppStatesForExternalNavigation(i.mEntityTree[R],Y);}return i.oNavigationControllerProxy.navigateForNonDraftCreate(R,S,null,Y).then(Function.prototype);}function I(O,Q,R,S){Q=g({},Q);p(O,R,S,Q);return new Promise(function(U){var V=function(b1){U({title:O.getText("ST_ERROR"),text:(b1&&b1.messageText)||O.getText("ST_GENERIC_UNKNOWN_NAVIGATION_TARGET"),icon:"sap-icon://message-error",description:""});};var W=R.getMetaModel().getODataEntitySet(S);var X=W["com.sap.vocabularies.Common.v1.DraftRoot"];if(X&&X.NewAction){var Y=R.getMetaModel().getODataFunctionImport(X.NewAction.String.split("/")[1]);var Z={};if(Y){var $=Y.parameter?Y.parameter.length:0;for(var i=0;i<$;i++){var _=Y.parameter[i];var a1=_.mode==="In"&&Q[_.name]&&Q[_.name][0];if(a1){Z[_.name]=a1;}}R.callFunction("/"+Y.name,{success:function(b1,c1){var d1=new d(R);var e1=d1.getContextFromResponse(b1);if(e1){O.oNavigationControllerProxy.navigateToSubContext(e1,true,4).then(U.bind(null,null));}else{V();}},error:V,method:"POST",urlParameters:Z});return;}}V();});}function J(i,O,Q,R,S){var U=e({},O);n(R.getMetaModel(),Q,U);var V=y(R,i,Q,U,S);var W;for(var X in V){if(X!=="root"){W=V[X];break;}}if(W){var Y=i.oAppComponent.getTransactionController();var Z=W.isSemantic?"":"/"+R.createKey(Q,U);var $=W.isSemantic&&W.key;var _=C.edit(Y,Q,Z,R,i,i.oNavigationControllerProxy.fnInitializationResolve,$,U);return _.then(function(a1){var b1=Object.create(null);if(i.oFlexibleColumnLayoutHandler){var c1=i.mEntityTree[Q];i.oFlexibleColumnLayoutHandler.adaptAppStatesForExternalNavigation(c1,b1);}return i.oNavigationControllerProxy.navigateToSubContext(a1.context,true,2,null,b1).then(Function.prototype);},function(a1){if(a1.lockedByUser){if(S.force){return{title:i.getText("LOCKED_OBJECT_POPOVER_TITLE"),text:i.getText("LOCKED_OBJECT_POPOVER_TITLE"),description:i.getText("ST_GENERIC_LOCKED_OBJECT_POPOVER_TEXT",[a1.lockedByUser]),icon:"sap-icon://message-error"};}return N(i,R,V,U);}if(a1.draftAdminReadResponse){return null;}return new Promise(function(b1){var c1=i.getText("ST_GENERIC_ERROR_NOT_AUTORIZED_EDIT");M.warning(c1,{onClose:function(){N(i,R,V,U).then(b1);}});});});}return Promise.resolve();}function K(i,O,Q,R,S){var U=e({},O);n(R.getMetaModel(),Q,U);var V=y(R,i,Q,U,S);return N(i,R,V,U);}function L(i,O){var R=O&&O.route&&O.route.length===1&&O.route[0];if(R){i.oNavigationControllerProxy.navigate(R,true);return Promise.resolve();}var Q=O&&O.preferredMode&&O.preferredMode[0];var S=O&&O.mode&&O.mode[0];var U=h(Q,S);var V=G(i,U.mode);return V.then(function(W){var X=i.oAppComponent.getModel();k(X,W,O);switch(U.mode){case"create":return H(i,O,X,W);case"createWithContext":return I(i,O,X,W);case"edit":return J(i,O,W,X,U);case"display":return K(i,O,W,X,U);}return{title:i.getText("ST_GENERIC_ERROR_TITLE"),text:i.getText("ST_GENERIC_ERROR_TITLE"),description:i.getText("PARAMETER_COMBINATION_NOT_SUPPORTED",[S,Q]),icon:"sap-icon://message-error",replaceURL:true};});}var k=t.testableStatic(k,"startupParameterHelper_fnTransformStartupParameters");return{parametersToNavigation:L};});
