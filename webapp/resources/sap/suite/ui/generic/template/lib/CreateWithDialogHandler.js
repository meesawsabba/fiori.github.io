sap.ui.define(["sap/ui/base/Object","sap/suite/ui/generic/template/js/StableIdHelper","sap/suite/ui/generic/template/lib/MessageUtils","sap/base/util/extend","sap/suite/ui/generic/template/genericUtilities/controlHelper","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/suite/ui/generic/template/lib/CRUDHelper","sap/base/util/isEmptyObject","sap/ui/model/Context"],function(B,S,M,e,c,t,C,i,a){"use strict";function g(s,o,T){var d,b;function G(){return{"aFilters":[{sPath:"fullTarget",sOperator:"StartsWith",oValue1:d.getBindingContext().getPath()},{sPath:"target",sOperator:"EQ",oValue1:"/"+o.getOwnerComponent().getEntitySet()}]};}function r(){var l=G(d);var m=sap.ui.getCore().getMessageManager().getMessageModel();if(l){var n=m.bindList("/",null,null,[l]);var p=n.getContexts();if(p.length){var E=[];for(var q in p){E.push(p[q].getObject());}sap.ui.getCore().getMessageManager().removeMessages(E);}}}function f(){d.close();if(T.oComponentUtils.isDraftEnabled()){T.oServices.oCRUDManager.discardDraft(d.getBindingContext());}else{r(d);o.getView().getModel().deleteCreatedEntry(d.getBindingContext());}d.setBindingContext(null);}function h(){var m=false;var F;var l=d&&typeof d.getContent==="function"&&d.getContent()&&d.getContent()[0];var n=l?l.check():Promise.resolve();n.then(function(){var p=sap.ui.getCore().getMessageManager().getMessageModel().getData();m=p.some(function(v){return v.type==="Error"&&v.validation;});if(!m&&T.oComponentUtils.isDraftEnabled()){var q=T.oComponentUtils.getCRUDActionHandler();F=G(d);q.handleCRUDScenario(1,A.bind(null,F));}else if(!m){T.oCommonEventHandlers.submitChangesForSmartMultiInput();F=G(d);var u=T.oServices.oCRUDManager.saveEntity(F);if(T.oComponentUtils.getViewLevel()===1){T.oServices.oApplicationController.executeSideEffects(b.getBindingContext(),[],[b.getTableBindingPath()]);}u.then(function(){d.close();if(s.oPresentationControlHandler){if(s.refreshModel){s.refreshModel();}else{T.oCommonUtils.refreshModel(s.oPresentationControlHandler.getEntitySet());}s.oPresentationControlHandler.refresh();M.showSuccessMessageIfRequired(T.oCommonUtils.getText("OBJECT_CREATED"),T.oServices);}else{T.oCommonUtils.refreshModel(b.getEntitySet());T.oServices.oPresentationControlHandlerFactory.getPresentationControlHandler(b).refresh();M.showSuccessMessageIfRequired(T.oCommonUtils.getContextText("ITEM_CREATED",b.getId()),T.oServices);}r(d);d.setBindingContext(null);});var E={saveEntityPromise:u};T.oComponentUtils.fire(o,"AfterSave",E);}});}function A(l){var m=T.oServices.oCRUDManager.activateDraftEntity(d.getBindingContext(),l);m.then(function(R){if(R&&R.response&&R.response.statusCode==="200"){d.close();d.setBindingContext(null);M.showSuccessMessageIfRequired(T.oCommonUtils.getText("OBJECT_CREATED"),T.oServices);s.oPresentationControlHandler.refresh();}},Function.prototype);var E={activationPromise:m};T.oComponentUtils.fire(o,"AfterActivate",E);}function j(l,E,p){b=T.oCommonUtils.getOwnerControl(E);b=c.isSmartTable(b)?b:b.getParent();var P=b.getParent().getBindingContext();p=i(p)?false:p;if(!p){var m=T.oServices.oCRUDManager.getDefaultValues(E,p);if(m instanceof Promise){var n=function(R){k(l,E,R,b,P);};m.then(n,n);}else{k(l,E,p,b,P);}}else{k(l,E,p,b,P);}}function k(l,E,p,b,P){var m=s.oSmartFilterbar;var n=P?b.getTableBindingPath():'/'+b.getEntitySet();var q=new sap.ui.model.json.JSONModel();d=l;d.setVisible(true);q.setProperty("/title",T.oCommonUtils.getContextText("CREATE_DIALOG_TITLE",b.getId()));d.setModel(q,"localModel");d.setEscapeHandler(f);if(T.oComponentUtils.isDraftEnabled()){T.oCommonEventHandlers.addEntry(E,false,m,p,false,true).then(function(u){T.oServices.oApplication.registerContext(u);d.setBindingContext(u);d.open();});}else{var N=C.createNonDraft(P,n,d.getModel(),p);d.setBindingContext(N);d.open();}}var A=t.testable(A,"fnActivateImpl");var r=t.testable(r,"fnRemoveOldMessageFromModel");var G=t.testable(G,"fnGetFilterForCurrentState");var k=t.testable(k,"openDialog");return{onCancelPopUpDialog:f,onSavePopUpDialog:h,createWithDialog:j};}return B.extend("sap.suite.ui.generic.template.lib.CreateWithDialogHandler",{constructor:function(s,o,T){e(this,g(s,o,T));}});});
