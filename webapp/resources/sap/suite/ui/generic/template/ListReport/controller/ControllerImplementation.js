sap.ui.define(["sap/ui/model/Filter","sap/suite/ui/generic/template/ListReport/extensionAPI/ExtensionAPI","sap/suite/ui/generic/template/listTemplates/listUtils","sap/suite/ui/generic/template/ListReport/controller/IappStateHandler","sap/suite/ui/generic/template/ListReport/controller/MultipleViewsHandler","sap/suite/ui/generic/template/ListReport/controller/WorklistHandler","sap/suite/ui/generic/template/lib/ShareUtils","sap/suite/ui/generic/template/genericUtilities/controlHelper","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/base/util/ObjectPath","sap/suite/ui/generic/template/js/StableIdHelper","sap/base/util/deepExtend","sap/suite/ui/generic/template/lib/CreateWithDialogHandler","sap/suite/ui/generic/template/listTemplates/semanticDateRangeTypeHelper","sap/suite/ui/generic/template/ListReport/controller/MultiEditHandler","sap/ui/generic/app/navigation/service/SelectionVariant","sap/base/util/isEmptyObject"],function(F,E,l,I,M,W,S,c,a,O,b,d,C,e,f,g,h){"use strict";var L=new a("ListReport.controller.ControllerImplementation").getLogger();var m={getMethods:function(v,t,o){var s={};s.oWorklistData={bWorkListEnabled:!!t.oComponentUtils.getSettings().isWorklist};var j;var w=null;function k(){var i=o.getOwnerComponent();var _=t.oComponentUtils.getTemplatePrivateModel();_.setProperty("/listReport/isLeaf",i.getIsLeaf());}function n(i){var _=i.getSource();var a1=o.getOwnerComponent().getAnnotationPath();if(a1!==undefined){A(_,a1);}o.onInitSmartFilterBarExtension(i);o.templateBaseExtension.onInitSmartFilterBar(i);s.oIappStateHandler.onSmartFilterBarInitialise();}function A(i,_){if(_.indexOf('com.sap.vocabularies.UI.v1.PresentationVariant')>-1){return;}var a1=new g(JSON.stringify(i.getUiState().getSelectionVariant()));var b1=o.getOwnerComponent().getModel().getMetaModel();var c1=o.getOwnerComponent().getEntitySet();var d1=b1.getODataEntityType(b1.getODataEntitySet(c1).entityType);var e1=b1.getObject(d1.$path+"/"+_);if(e1&&e1.SelectionVariant&&(e1.SelectionVariant.Path||e1.SelectionVariant.AnnotationPath)){_=(e1.SelectionVariant.Path||e1.SelectionVariant.AnnotationPath).split("@")[1];}var f1=b1.getObject(d1.$path+"/"+_);if(f1){f1=l.createSVObject(f1,i);f1.FilterContextUrl=a1.getFilterContextUrl();s.oIappStateHandler.setFiltersUsingUIState(f1.toJSONObject(),true,false);}else{var g1=o.getOwnerComponent().getAppComponent().getNavigationController();g1.navigateToMessagePage({title:t.oCommonUtils.getText("ST_ERROR"),text:"Manifest property 'annotationPath' is configured with "+_+" but no such annotation found.",description:""});}}var p;var q=new Promise(function(i){p=i;});q.then(function(){p=null;});function r(){if(!p){s.oIappStateHandler.changeIappState(false);}}function u(i){t.oCommonUtils.setEnabledToolbarButtons(i);if(!c.isSmartChart(i)){t.oCommonUtils.setEnabledFooterButtons(i);}}function R(i){var _;_=i.getSource();_.getChartAsync().then(function(a1){a1.attachSelectData(u.bind(null,_));a1.attachDeselectData(u.bind(null,_));});}function x(i){var _=i.getParameters();var a1=i.getSource();t.oCommonEventHandlers.onSemanticObjectLinkNavigationPressed(a1,_);}function y(i){var _,a1;_=i.getParameters();a1=i.getSource();t.oCommonEventHandlers.onSemanticObjectLinkNavigationTargetObtained(a1.getEntitySet(),a1.getFieldSemanticObjectMap(),_,s,undefined,undefined);}function z(i){var _,a1,b1,c1,d1,e1;_=i.getParameters().mainNavigation;d1=i.getParameters();e1=i.getSource();if(_){a1=e1.getText&&e1.getText();b1=t.oCommonUtils.getCustomData(i);if(b1&&b1["LinkDescr"]){c1=b1["LinkDescr"];_.setDescription(c1);}}t.oCommonEventHandlers.onSemanticObjectLinkNavigationTargetObtained(s.oPresentationControlHandler.getEntitySet(),{},d1,s,a1,_);}function B(_){var a1=v.getItems();for(var i=0;i<a1.length;i++){if(!_||a1[i].getBindingContextPath()===_){return a1[i];}}}function N(i){t.oCommonEventHandlers.onListNavigate(i,s,undefined,true);}function D(i,_,a1){var b1=t.oServices.oCRUDManager.getDefaultValues(_,i);if(b1 instanceof Promise){var c1=function(d1){a1.call(this,d1,_);};b1.then(c1,c1);}else{a1.call(this,i,_);}}function G(i,_){if(!i){D(null,_,H);}else{H(i,_);}}function H(i,_){if(!_.data("CrossNavigation")){t.oCommonEventHandlers.addEntry(_,false,s.oSmartFilterbar,i);}else{t.oCommonUtils.fnProcessDataLossOrDraftDiscardConfirmation(function(){t.oCommonEventHandlers.addEntry(_,false,s.oSmartFilterbar,i);},Function.prototype,"LeaveApp");}}function J(i){var _=b.getStableId({type:"ListReportAction",subType:"Create",sQuickVariantKey:i});t.oCommonUtils.executeIfControlReady(function(a1){var b1=b.getStableId({type:"ListReportAction",subType:"CreateWithDialog",sQuickVariantKey:i});var c1=b1&&o.byId(b1);if(c1){s.oCreateWithDialogHandler.createWithDialog(c1,a1);}else{G(null,a1);}},_);}function K(i){D(undefined,i.getSource(),P);}function P(i,_){var a1=o.getOwnerComponent().getCreateWithFilters();var b1=a1.strategy||"extension";var c1;switch(b1){case"extension":c1=o.getPredefinedValuesForCreateExtension(s.oSmartFilterbar,i)||{};break;default:L.error(b1+" is not a valid strategy to extract values from the SmartFilterBar");return;}var d1=b.getStableId({type:"ListReportAction",subType:"CreateWithDialog"});var e1=d1&&o.byId(d1);if(e1){s.oCreateWithDialogHandler.createWithDialog(e1,_,c1);}else{G(c1,_);}}function Q(i){var _=t.oComponentUtils.getTemplatePrivateModel();var a1=_.getProperty("/listReport/deleteEnabled");if(a1){t.oCommonEventHandlers.deleteEntries(i);}}function T(i){if(!t.oComponentUtils.isDraftEnabled()){return;}var _=t.oComponentUtils.getTemplatePrivateModel();var a1=_.getProperty("/listReport/vDraftState");switch(a1){case"1":i.push(new F("IsActiveEntity","EQ",true));i.push(new F("HasDraftEntity","EQ",false));break;case"2":i.push(new F("IsActiveEntity","EQ",false));break;case"3":i.push(new F("IsActiveEntity","EQ",true));i.push(new F("SiblingEntity/IsActiveEntity","EQ",null));i.push(new F("DraftAdministrativeData/InProcessByUser","NE",""));break;case"4":i.push(new F("IsActiveEntity","EQ",true));i.push(new F("SiblingEntity/IsActiveEntity","EQ",null));i.push(new F("DraftAdministrativeData/InProcessByUser","EQ",""));break;default:var b1=_.getProperty("/listReport/activeObjectEnabled");if(b1){i.push(new F("IsActiveEntity","EQ",true));}else{var c1=new F({filters:[new F("IsActiveEntity","EQ",false),new F("SiblingEntity/IsActiveEntity","EQ",null)],and:false});if(i[0]&&i[0].aFilters){var d1=i[0];i[0]=new F([d1,c1],true);}else{i.push(c1);}}break;}}function U(){return s.oSmartFilterbar.getBasicSearchValue()||s.oWorklistHandler.getSearchString();}function V(i){var _={shareEmailPressed:function(){var c1=t.oServices.oApplication.getBusyHelper();if(c1.isBusy()){return;}var d1=t.oCommonUtils.getText("EMAIL_HEADER",[t.oServices.oApplication.getAppTitle()]);var e1=S.getCurrentUrl().then(function(f1){sap.m.URLHelper.triggerEmail(null,d1,f1);});c1.setBusy(e1);},shareJamPressed:function(){S.openJamShareDialog(t.oServices.oApplication.getAppTitle());},getDownloadUrl:function(){var c1=s.oPresentationControlHandler.getBinding(s);return c1&&c1.getDownloadUrl()||"";},getServiceUrl:function(){var c1=e.isServiceUrlAllowedBySemanticDateRangeFilter(s.oSmartFilterbar,t.oComponentUtils)&&_.getDownloadUrl()||"";c1=c1&&c1+"&$top=0&$inlinecount=allpages";var d1={serviceUrl:c1};o.onSaveAsTileExtension(d1);return d1.serviceUrl;},getModelData:function(){var c1=O.get("sap.ushell.Container.getUser");var d1=o.getOwnerComponent();var e1=d1.getAppComponent();var f1=e1.getMetadata();var g1=f1.getManifestEntry("sap.ui");var h1=(g1&&g1.icons&&g1.icons.icon)||"";var i1=f1.getManifestEntry("sap.app");var j1=(i1&&i1.title)||"";return Promise.resolve().then(function(){return{serviceUrl:_.getServiceUrl(),icon:h1,title:j1,isShareInJamActive:!!c1&&c1().isJamActive(),customUrl:S.getCustomUrl()};});}};S.openSharePopup(t.oCommonUtils,i,_);var a1=this.getView().byId("template::Share");var b1=this.getView().byId("bookmarkButton");b1.setBeforePressHandler(function(){a1.focus();});}function X(i){var _=i.getId();var a1=s.oSmartFilterbar;var b1="";var c1=[];var d1=!!(t.oComponentUtils&&t.oComponentUtils.getSettings()&&(t.oComponentUtils.getSettings().quickVariantSelectionX||t.oComponentUtils.getSettings().quickVariantSelection));if(i.fetchVariant()&&i.fetchVariant().filter&&i.fetchVariant().filter.filterItems){c1=i.fetchVariant().filter.filterItems;}var e1={search:!!a1.getBasicSearchValue(),filter:!!(c1.length||a1.retrieveFiltersWithValues().length)};if(d1){b1=t.oCommonUtils.getContextText("NOITEMS_MULTIVIEW_LR_SMARTTABLE_WITH_FILTER",_);}else if(e1.search||e1.filter){b1=t.oCommonUtils.getContextText("NOITEMS_LR_SMARTTABLE_WITH_FILTER",_);}else{b1=t.oCommonUtils.getContextText("NOITEMS_LR_SMARTTABLE",_);}i.setNoData(b1);}function Y(i){var _=i.getId();var a1=t.oCommonUtils.getContextText("NOITEMS_LR_SMARTCHART",_);i.getChartAsync().then(function(b1){b1.setCustomMessages({NO_DATA:a1});});}function Z(i){var _=i.getEntitySet();t.oComponentUtils.preloadComponent(_);}var $;return{onInit:function(){s.oSmartFilterbar=o.byId("listReportFilter");s.oPresentationControlHandler=t.oServices.oPresentationControlHandlerFactory.getPresentationControlHandler(o.byId(b.getStableId({type:"ListReportTable",subType:"SmartTable"}))||o.byId(b.getStableId({type:"ListReportTable",subType:"SmartList"})));s.updateControlOnSelectionChange=u;j=t.oComponentUtils.getFclProxy();s.bLoadListAndFirstEntryOnStartup=j.isListAndFirstEntryLoadedOnStartup();var i=new M(s,o,t);s.oMultipleViewsHandler=i;s.refreshModel=function(){var a1=t.oCommonUtils.refreshModel(s.oPresentationControlHandler.getEntitySet());if(a1){i.refreshSiblingControls(s.oPresentationControlHandler);}};s.oCreateWithDialogHandler=new C(s,o,t);s.oWorklistHandler=new W(s,o,t);s.oIappStateHandler=new I(s,o,t);s.oMultiEditHandler=new f(s,o,t);var _=t.oComponentUtils.getTemplatePrivateModel();_.setProperty("/generic/bDataAreShownInTable",false);_.setProperty("/listReport/firstSelection",false);_.setProperty("/listReport/isHeaderExpanded",true);_.setProperty("/listReport/deleteEnabled",false);_.setProperty("/listReport/multiEditEnabled",false);if(t.oComponentUtils.isDraftEnabled()){_.setProperty("/listReport/activeObjectEnabled",false);_.setProperty("/listReport/vDraftState","0");}_.setProperty("/listReport/multipleViews/msgVisibility",false);v.adaptToChildContext=function(a1){s.oPresentationControlHandler.scrollToSelectedItemAsPerChildContext(a1);};v.getItems=function(){return s.oPresentationControlHandler.getItems();};v.displayNextObject=function(a1){return new Promise(function(b1,c1){w={aWaitingObjects:a1,resolve:b1,reject:c1};});};v.refreshBinding=function(a1,b1){if(s.oIappStateHandler.areDataShownInTable()){if(s.oMultipleViewsHandler.refreshOperation(2,null,!a1&&b1)){return;}if(a1||b1[o.getOwnerComponent().getEntitySet()]){t.oCommonUtils.refreshModel(o.getOwnerComponent().getEntitySet());s.oPresentationControlHandler.refresh();}}};v.getCurrentState=function(){return{permanentState:{data:s.oIappStateHandler.getCurrentAppState(),lifecycle:{permanent:true}}};};v.applyState=function(a1){s.oIappStateHandler.applyState(a1.permanentState).then(p);};k();o.byId("template::FilterText").attachBrowserEvent("click",function(){o.byId("page").setHeaderExpanded(true);});},handlers:{addEntry:J,addEntryWithFilters:K,deleteEntries:Q,deleteEntry:function(i){t.oCommonEventHandlers.deleteEntry(i);},updateTableTabCounts:function(){s.oMultipleViewsHandler.fnUpdateTableTabCounts();},onCancelCreateWithPopUpDialog:function(){s.oCreateWithDialogHandler.onCancelPopUpDialog();},onSaveCreateWithPopUpDialog:function(i){s.oCreateWithDialogHandler.onSavePopUpDialog(i);},onSelectionChange:function(i){var _=i.getSource();u(_);},onMultiSelectionChange:function(i){t.oCommonEventHandlers.onMultiSelectionChange(i);},onContactDetails:function(i){t.oCommonEventHandlers.onContactDetails(i);},onSmartFilterBarInitialise:n,onSmartFilterBarInitialized:function(){s.oIappStateHandler.onSmartFilterBarInitialized();},onBeforeSFBVariantFetch:function(){s.oIappStateHandler.onBeforeSFBVariantFetch();},onAfterSFBVariantSave:function(){s.oIappStateHandler.onAfterSFBVariantSave();},onAfterSFBVariantLoad:function(i){s.oIappStateHandler.onAfterSFBVariantLoad(i);},onDataRequested:function(){s.oMultipleViewsHandler.onDataRequested();},onDataReceived:function(_){if($){$();}$=Function.prototype;t.oCommonEventHandlers.onDataReceived(_);if(w){var a1;var b1=false;for(var i=0;i<w.aWaitingObjects.length&&!b1;i++){a1=B(w.aWaitingObjects[i]);if(a1){N(a1);w.resolve();b1=true;}}if(!b1){a1=B();if(a1){N(a1);w.resolve();}else{w.reject();}}w=null;return;}j.handleDataReceived(_.getSource(),N);var c1=t.oComponentUtils.getTemplatePrivateModel();c1.setProperty("/listReport/firstSelection",true);s.oIappStateHandler.setDataShownInTable(true);t.oComponentUtils.hidePlaceholder();},onSmartChartDataReceived:function(){s.oMultipleViewsHandler.onDataRequested();},onBeforeRebindTable:function(i){var _=i.getSource();X(_);var a1=i.getParameters().bindingParams;a1.events["dataRequested"]=Z.bind(null,_);s.oMultipleViewsHandler.aTableFilters=d({},a1.filters);var b1=a1.filters.slice(0);t.oCommonEventHandlers.onBeforeRebindTable(i,{determineSortOrder:s.oMultipleViewsHandler.determineSortOrder,ensureExtensionFields:o.templateBaseExtension.ensureFieldsForSelect,addTemplateSpecificFilters:T,getSearchString:U,addExtensionFilters:o.templateBaseExtension.addFilters,resolveParamaterizedEntitySet:s.oMultipleViewsHandler.resolveParameterizedEntitySet,isFieldControlRequired:false,isPopinWithoutHeader:true,isDataFieldForActionRequired:true,isFieldControlsPathRequired:true,isMandatoryFiltersRequired:true});o.onBeforeRebindTableExtension(i);s.oMultipleViewsHandler.onRebindContentControl(a1,b1);l.handleErrorsOnTableOrChart(t,i);},onListNavigate:function(i){t.oCommonEventHandlers.onListNavigate(i,s);},onCallActionFromToolBar:function(i){t.oCommonEventHandlers.onCallActionFromToolBar(i,s);},onDataFieldForIntentBasedNavigation:function(i){t.oCommonEventHandlers.onDataFieldForIntentBasedNavigation(i,s);},onDataFieldWithIntentBasedNavigation:function(i){t.oCommonEventHandlers.onDataFieldWithIntentBasedNavigation(i,s);},onBeforeSemanticObjectLinkNavigationCallback:function(i){return t.oCommonEventHandlers.onBeforeSemanticObjectLinkNavigationCallback(i);},onBeforeSemanticObjectLinkPopoverOpens:function(i){var _=i.getSource();var a1=s.oSmartFilterbar.getUiState().getSelectionVariant();if(s.oSmartFilterbar.getEntitySet()!==_.getEntitySet()){a1.FilterContextUrl=t.oServices.oApplication.getNavigationHandler().constructContextUrl(_.getEntitySet(),_.getModel());}var b1=JSON.stringify(a1);t.oCommonUtils.semanticObjectLinkNavigation(i,b1,o,s);},onSemanticObjectLinkNavigationPressed:x,onSemanticObjectLinkNavigationTargetObtained:y,onSemanticObjectLinkNavigationTargetObtainedSmartLink:z,onDraftLinkPressed:function(i){var _=i.getSource();var a1=_.getBindingContext();t.oCommonUtils.showDraftPopover(a1,_);},onAssignedFiltersChanged:function(i){if(i.getSource()){o.byId("template::FilterText").setText(i.getSource().retrieveFiltersWithValuesAsText());}},onFilterChange:r,onFiltersDialogBeforeOpen:function(){s.oIappStateHandler.onFiltersDialogBeforeOpen();},onFiltersDialogClosed:function(){s.oIappStateHandler.onFiltersDialogClosed();},onSearchButtonPressed:function(){var i=s.oSmartFilterbar.verifySearchAllowed();if(h(i)){s.oIappStateHandler.onSearchPressed();}},onAfterTableVariantSave:function(){s.oIappStateHandler.onAfterTableVariantSave();},onAfterApplyTableVariant:function(){if(!p){s.oIappStateHandler.onAfterApplyTableVariant();}},onAfterChartVariantSave:function(i){s.oIappStateHandler.onAfterTableVariantSave();},onAfterApplyChartVariant:function(i){if(!p){s.oIappStateHandler.onAfterApplyTableVariant();}},onBeforeRebindChart:function(i){var _=i.getSource();Y(_);var a1=i.getParameters().bindingParams;s.oMultipleViewsHandler.aTableFilters=d({},a1.filters);var b1=a1.filters.slice(0);var c1={setBindingPath:_.setChartBindingPath.bind(_),ensureExtensionFields:Function.prototype,addTemplateSpecificFilters:T,addExtensionFilters:o.templateBaseExtension.addFilters,resolveParamaterizedEntitySet:s.oMultipleViewsHandler.resolveParameterizedEntitySet,isFieldControlRequired:false,isMandatoryFiltersRequired:true};t.oCommonUtils.onBeforeRebindTableOrChart(i,c1,s.oSmartFilterbar);o.onBeforeRebindChartExtension(i);s.oMultipleViewsHandler.onRebindContentControl(a1,b1);l.handleErrorsOnTableOrChart(t,i);},onChartInitialized:function(i){R(i);t.oCommonUtils.checkToolbarIntentsSupported(i.getSource());},onSelectionDetailsActionPress:function(i){s.oMultipleViewsHandler.onDetailsActionPress(i);},onShareListReportActionButtonPress:function(i){t.oCommonUtils.executeIfControlReady(V,"template::Share");},onInlineDataFieldForAction:function(i){t.oCommonEventHandlers.onInlineDataFieldForAction(i);},onInlineDataFieldForIntentBasedNavigation:function(i){t.oCommonEventHandlers.onInlineDataFieldForIntentBasedNavigation(i.getSource(),s);},onDeterminingDataFieldForAction:function(i){t.oCommonEventHandlers.onDeterminingDataFieldForAction(i,s.oPresentationControlHandler);},onDeterminingDataFieldForIntentBasedNavigation:function(i){t.oCommonEventHandlers.onDeterminingDataFieldForIntentBasedNavigation(i.getSource(),s.oPresentationControlHandler.getSelectedContexts(),s.oSmartFilterbar);},onTableInit:function(i){var _=i.getSource();t.oCommonUtils.checkToolbarIntentsSupported(_);},onSearchWorkList:function(i){s.oWorklistHandler.performWorklistSearch(i);},onActiveButtonPress:function(i){var _=o.byId("template::PageVariant");var a1=t.oComponentUtils.getTemplatePrivateModel();var b1=a1.getProperty("/listReport/activeObjectEnabled");a1.setProperty("/listReport/activeObjectEnabled",!b1);_.currentVariantSetModified(true);s.oSmartFilterbar.search();s.oIappStateHandler.changeIappState(true);},onMultiEditButtonPress:function(){s.oMultiEditHandler.onMultiEditButtonPress();},onSaveMultiEditDialog:function(i){s.oMultiEditHandler.onSaveMultiEditDialog(i);},onCancelMultiEditDialog:function(i){s.oMultiEditHandler.onCancelMultiEditDialog(i);}},formatters:{formatDraftType:function(i,_,a1){if(i&&i.DraftUUID){if(!_){return sap.m.ObjectMarkerType.Draft;}else if(a1){return i.InProcessByUser?sap.m.ObjectMarkerType.Locked:sap.m.ObjectMarkerType.Unsaved;}}return sap.m.ObjectMarkerType.Flagged;},formatDraftVisibility:function(i,_){if(i&&i.DraftUUID){if(!_){return sap.m.ObjectMarkerVisibility.TextOnly;}}return sap.m.ObjectMarkerVisibility.IconAndText;},formatDraftLineItemVisible:function(i,_,a1){if(i&&i.DraftUUID){if(a1==="0"&&_){return false;}return true;}return false;},formatDraftOwner:function(i,_){var a1="";if(i&&i.DraftUUID&&_){var b1=i.InProcessByUserDescription||i.InProcessByUser||i.LastChangedByUserDescription||i.LastChangedByUser;if(b1){a1=t.oCommonUtils.getText("ST_DRAFT_OWNER",[b1]);}else{a1=t.oCommonUtils.getText("ST_DRAFT_ANOTHER_USER");}}return a1;},formatItemTextForMultipleView:function(i){return s.oMultipleViewsHandler?s.oMultipleViewsHandler.formatItemTextForMultipleView(i):"";},formatMessageStrip:function(i,_){return s.oMultipleViewsHandler?s.oMultipleViewsHandler.formatMessageStrip(i,_):"";}},extensionAPI:new E(t,o,s)};}};return m;});
