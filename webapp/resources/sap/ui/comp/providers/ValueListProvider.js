/*
 * ! SAPUI5
 * (c) Copyright 2009-2021 SAP SE. All rights reserved.
 */
sap.ui.define(['sap/ui/core/library','sap/ui/comp/library','sap/m/library','sap/ui/comp/odata/MetadataAnalyser','sap/ui/comp/util/DateTimeUtil','sap/ui/core/SeparatorItem','sap/m/GroupHeaderListItem','sap/m/Column','sap/m/ColumnListItem','sap/m/Text','sap/m/Token','./BaseValueListProvider','sap/ui/core/ListItem','sap/ui/model/Filter','sap/ui/model/Sorter','sap/ui/model/json/JSONModel','sap/ui/model/FilterOperator','sap/ui/comp/util/FormatUtil','sap/ui/comp/smartfilterbar/FilterProvider','sap/ui/comp/historyvalues/HistoryValuesProvider','sap/ui/comp/historyvalues/HistoryOptOutProvider','sap/ui/comp/historyvalues/Constants','sap/m/ComboBox','sap/m/MultiComboBox','sap/base/util/deepEqual','sap/ui/Device','sap/base/Log','sap/base/util/values','sap/m/Label','sap/base/strings/whitespaceReplacer'],function(c,l,L,M,D,S,G,C,d,T,e,B,f,F,g,J,h,j,k,H,m,n,o,p,q,r,s,v,t,w){"use strict";var u=l.smartfilterbar.DisplayBehaviour;var P=L.PopinDisplay;var W=L.WrappingType;var V=c.ValueState;var y={Recommendations:10,RecentlyUsed:20,Others:30};var z="list";var A=B.extend("sap.ui.comp.providers.ValueListProvider",{constructor:function(a){if(!k){k=sap.ui.require("sap/ui/comp/smartfilterbar/FilterProvider");}if(a){this.sAggregationName=a.aggregation;this.bTypeAheadEnabled=!!a.typeAheadEnabled;this.bEnableShowTableSuggestionValueHelp=a.enableShowTableSuggestionValueHelp===undefined?true:a.enableShowTableSuggestionValueHelp;this.dropdownItemKeyType=a.dropdownItemKeyType;this.sDeferredGroupId=a.deferredGroupId;this._fieldHistoryEnabled=a.fieldHistoryEnabled;this._fieldHistoryEnabledInitial=a.fieldHistoryEnabledInitial;}this._aRecommendations=[];this._oRecommendationListPromise=Promise.resolve();this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");this._groupHeaderFactory=this._groupHeaderFactory.bind(this);B.apply(this,arguments);this._onInitialise();}});A.prototype._onInitialise=function(){if(!this.bTypeAheadEnabled){this.oAfterRenderingEventDelegate={onAfterRendering:this._onMetadataInitialised};this.oControl.addEventDelegate(this.oAfterRenderingEventDelegate,this);}else if(this.oControl.attachSuggest){this._fSuggest=function(E){this.oControl=E.getSource();if(!this.bInitialised){return;}if(!this._oTemplate||!this.oControl.data("_hassuggestionTemplate")){this._createSuggestionTemplate();}var i=E.getParameter("suggestValue");this._fetchData(i);}.bind(this);this.oControl.attachSuggest(this._fSuggest);if(!this.oFilterModel){var a=this;var b=this.oControl.setParent;this.oControl.setParent=function(N,i,x){var O=this.getParent();var R=b.apply(this,arguments);N=this.getParent();var E=!(N&&(O===null));if((N!==O)&&E){a.unbindAggregation();}return R;};}this._handleSelect();}this.oControl.setModel(new J(),z);this._setupHistoryValues();this._setupRecommendations();};A.prototype._onMetadataInitialised=function(){if(this.bInitialised){if(this.oAfterRenderingEventDelegate){this.oControl.removeEventDelegate(this.oAfterRenderingEventDelegate);}if(this.oPrimaryValueListAnnotation){if(this.sAggregationName&&this.sAggregationName=="suggestionRows"){this._createSuggestionTemplate();}else{this._createDropDownTemplate();}this._fetchData();if(this._isControlDropdown()){if(this.mOutParams&&Object.keys(this.mOutParams).length>1){this._handleOutParameters();}if(this.mInParams&&Object.keys(this.mInParams).length>1){this._handleInParameters();}}}else{s.error("ValueListProvider","Missing primary ValueListAnnotation for "+(this._sFullyQualifiedFieldName||this.sFieldName));}if(this.oAfterRenderingEventDelegate){delete this.oAfterRenderingEventDelegate;}}};A.prototype._onAnnotationLoad=function(a){var b=B.prototype._onAnnotationLoad.call(this,a);if(!this._isControlSupportedForHistory(this.oControl)){return b;}if(this._shouldHaveRecommendations()||this._shouldHaveHistory()){this._setupSuggestionInteractions();}return b;};A.prototype._isSortable=function(N){if(this.oPrimaryValueListAnnotation){for(var i=0;i<this.oPrimaryValueListAnnotation.valueListFields.length;i++){if(this.oPrimaryValueListAnnotation.valueListFields[i].name===N){return this.oPrimaryValueListAnnotation.valueListFields[i].sortable!==false;}}return false;}return false;};A.prototype._createDropDownTemplate=function(){this._oTemplate=new f({key:{path:this._resolveSuggestionBindingPath(this.sKey),type:this.dropdownItemKeyType},text:{parts:[{path:this._resolveSuggestionBindingPath(this.sKey),type:this.dropdownItemKeyType},{path:this._resolveSuggestionBindingPath(this.sDescription)}],formatter:function(K,a){var b=j.getFormatterFunctionFromDisplayBehaviour(this.sDDLBDisplayBehaviour),i=b(K,a);return w(i);}.bind(this)}});if(this._oRecommendationListAnnotation){this._oTemplate.bindProperty("additionalText",{path:this._resolveSuggestionBindingPath(this._oRecommendationListAnnotation.rankProperty)});}this._oSorter=null;if(this.sDDLBDisplayBehaviour===u.idOnly||this.sDDLBDisplayBehaviour===u.idAndDescription){if(this._isSortable(this.sKey)){this._oSorter=new g(this.sKey);}}else{if(this._isSortable(this.sDescription)){this._oSorter=new g(this.sDescription);}else if((this.sDescription!==this.sKey)&&this._isSortable(this.sKey)){this._oSorter=new g(this.sKey);}}};A.prototype._createSuggestionTemplate=function(){var i=0,a=0,b=0,x=this._aHighImportanceCols||this._aRecommendationCols||this._aCols;this._oTemplate=new d();if(x){this.oControl.removeAllSuggestionColumns();a=x.length;for(i=0;i<a;i++){var E=false,I="1px",K=x[i].width;if(r.system.phone){K=undefined;if(i>=2){E=true;I=(i+1)*10+"rem";}}this.oControl.addSuggestionColumn(new C({header:new t({wrapping:true,wrappingType:W.Hyphenated,text:x[i].label}),demandPopin:E,popinDisplay:P.Inline,minScreenWidth:I,width:K}));this._oTemplate.addCell(new t({wrapping:true,text:{path:this._resolveSuggestionBindingPath(x[i].template),type:x[i].oType,formatter:function(N){return w(N);}}}));if(K){b+=parseFloat(K.substring(0,K.length-2));}}if(b>0){this.oControl.setProperty('maxSuggestionWidth',b+a+"em",true);}}this.oControl.data("_hassuggestionTemplate",true);if(this.oControl&&this.oControl._oSuggestionTable){this.oControl._oSuggestionTable.addStyleClass("sapUiCompValueListProviderTable");}};A.prototype._handleRowSelect=function(a,b){var K,i,x;if(a){K=a[this.sKey];i=a[this.sDescription];}if(K||(K==="")){if(this.oControl.addToken){i=j.getFormattedExpressionFromDisplayBehaviour(this.sTokenDisplayBehaviour,K,i);x=new e();x.setKey(K);x.setText(i);x.setTooltip(i);x.data("row",a);if(b){b(x);}if(this.oControl.getValue()===""){this.oControl.setValue("");}delete this.oControl.__sValidationText;}else{if(this.sContext==="SmartField"&&this._selectedODataRowHandler){this._selectedODataRowHandler(K,a);}this.oControl.setValue(K);this.oControl.fireChange({value:K,validated:true});}}this._calculateAndSetFilterOutputData([a]);};A.prototype._multiInputValidator=function(a){if(!this.bInitialised){return;}if(this._aValidators){var b;this._aValidators.some(function(K){b=K(a);return b;},this);if(b){return b;}}var R=a.suggestionObject,i,I=a.text;if(R){var x=this._getSuggestionsModelName(),E=R.getBindingContext(x);i=E.getObject();this._handleRowSelect(i,a.asyncCallback);}else if(I){this._validateInput(I,a.asyncCallback);}};A.prototype._validateInput=function(i,a){var b,x=[],E=this.oControl,I;if(this.sDisplayFormat==="UpperCase"){i=i.toUpperCase();}if(E.__sValidationText!==i){E.__sValidationText=i;if(i===this._truncateSearchText(i)){E.__bValidatingToken=true;this._calculateFilterInputData();if(this.mFilterInputData&&this.aFilterField){x=k.generateFilters(this.aFilterField,this.mFilterInputData);}x.push(new F(this.sKey,h.EQ,i));if(this.bSupportBasicSearch){I={"search-focus":this.sKey};}b=new Promise(function(R,K){this.oODataModel.read("/"+this.sValueListEntitySetName,{filters:x,urlParameters:I,success:function(N){if(!this.oControl||!this.oControl.hasOwnProperty("__bValidatingToken")){return;}var O=N;delete this.oControl.__bValidatingToken;if(N){if(N.results&&N.results.length>=1){if(N.results.length===1){O=N.results[0];}if(this.oControl.data("__validationError")){this.oControl.data("__validationError",null);this.oControl.setValueState("None");}}else{this.oControl.setValueState("Error");this.oControl.data("__validationError",true);}if(O&&O[this.sKey]){E._pendingAutoTokenGeneration=true;this._handleRowSelect(O,a);E._pendingAutoTokenGeneration=false;}}this._afterTokenValidate();R();}.bind(this),error:function(){if(this.oControl.data("__validationError")){this.oControl.setValueState("None");}delete this.oControl.__bValidatingToken;this._afterTokenValidate();R();}.bind(this)});}.bind(this));this._addValidationPromise(b);}}else{if(E.data("__validationError")){E.setValueState(V.Error);}}};A.prototype._validateStringSingleWithValueList=function(E){var a;if(E.getParameter("validated")){return;}a=E.getParameter("value");if(a===""||a===undefined){return;}this._validateInput(a);};A.prototype._afterTokenValidate=function(){if(this.oFilterProvider&&this.oFilterProvider._oSmartFilter&&this.oFilterProvider._oSmartFilter.bIsSearchPending&&this.oFilterProvider._oSmartFilter.search){if(this.oFilterProvider._oSmartFilter.getLiveMode&&this.oFilterProvider._oSmartFilter.getLiveMode()){return;}this.oFilterProvider._oSmartFilter.search();}};A.prototype._onSuggestionItemSelected=function(E){var R=E.getParameter("selectedRow");if(R){var a=this._getSuggestionsModelName();this._handleRowSelect(R.getBindingContext(a).getObject());}};A.prototype._setFilterOutputDataFromSelectedRow=function(R){var a,b,i;if(R){a=this._getSuggestionsModelName();b=R.getBindingContext(a);i=b.getObject();this._calculateAndSetFilterOutputData([i]);}};A.prototype._onMultiComboBoxItemSelected=function(E){if(!E.getParameter("selected")){return;}var R=E.getParameter("changedItem");this._setFilterOutputDataFromSelectedRow(R);};A.prototype._onComboBoxItemSelected=function(E){var a=E.getParameter("value"),N=E.getParameter("newValue"),b=E.getParameter("filterChangeReason");if(b&&!a&&!N){return;}var R=this.oControl.getSelectedItem();this._setFilterOutputDataFromSelectedRow(R);};A.prototype._handleSelect=function(){if(this.oControl.addValidator){this._aValidators=this.oControl&&this.oControl.isA('sap.m.MultiInput')?this.oControl.getValidators().slice():[];this.oControl.removeAllValidators();this._fValidator=this._multiInputValidator.bind(this);this.oControl.addValidator(this._fValidator);}else if(this.oControl.attachSuggestionItemSelected){this.oControl.attachSuggestionItemSelected(this._onSuggestionItemSelected,this);if(this.sContext==="SmartFilterBar"&&this._fieldViewMetadata&&this._fieldViewMetadata.hasValueListAnnotation){this.oControl.attachChange(this._validateStringSingleWithValueList,this);}}if(this.oControl.setRowResultFunction){this.oControl.setRowResultFunction(function(a){var b,R="",i=this._getSuggestionsModelName();if(a){b=a.getBindingContext(i);}if(b&&this.sKey){R=b.getProperty(this.sKey);}return R;}.bind(this));}};A.prototype._filterDropdownRowsByInParameters=function(){this._calculateFilterInputData();if(this.mFilterInputData&&this.aFilterField){this.oControl.setBusy(true);this._fetchData();this._mLastFilterInputData=this.mFilterInputData;this._cleanupControlSelection();}};A.prototype.isInSmartFilterBar=function(){return!!this.oFilterModel;};A.prototype._isControlDropdown=function(a){if(!a){a=this.oControl;}return!!(a.isA("sap.m.MultiComboBox")||a.isA("sap.m.ComboBox"));};A.prototype._cleanupControlSelection=function(){if(this.isInSmartFilterBar()&&this.oControl.isA("sap.m.MultiComboBox")){this.oFilterModel.setProperty("/"+this.sFieldName+"/items",[]);this.oControl.setSelectedKeys(null);}else{this.oControl.setSelectedKey(null);this.oControl.clearSelection();}};A.prototype._openDropdown=function(){if(this.oControl.isA("sap.m.MultiComboBox")){p.prototype.open.apply(this.oControl,arguments);}else if(this.oControl.isA("sap.m.ComboBox")){o.prototype.open.apply(this.oControl,arguments);}};A.prototype._handleOutParameters=function(){if(this.oControl.isA("sap.m.MultiComboBox")){this.oControl.attachSelectionChange(this._onMultiComboBoxItemSelected,this);}else if(this.oControl.isA("sap.m.ComboBox")){this.oControl.attachChange(this._onComboBoxItemSelected,this);}};A.prototype._handleInParameters=function(){this.oControl.setBusyIndicatorDelay(0);this._calculateFilterInputData();this._mLastFilterInputData=this.mFilterInputData;this.oControl.open=function(){this._calculateFilterInputData();if(q(this._mLastFilterInputData,this.mFilterInputData)){this._openDropdown();return;}this._filterDropdownRowsByInParameters();this._openDropdown();}.bind(this);this.oControl.addEventDelegate({onmousedown:function(E){if(E.target===this.oControl.getIcon().getFocusDomRef()){this._bSkipFocusIn=true;}}.bind(this),onmouseup:function(E){if(this._bSkipFocusIn&&E.target===this.oControl.getIcon().getFocusDomRef()){this.oControl.open();}this._bSkipFocusIn=false;}.bind(this),onfocusin:function(E){if(this._bSkipFocusIn){return E;}setTimeout(function(){this._calculateFilterInputData();if(q(this._mLastFilterInputData,this.mFilterInputData)){return;}this._filterDropdownRowsByInParameters();}.bind(this));return E;}.bind(this)});};A.prototype._fetchData=function(a){var b={},i=[],x=this._getBindingLength(),E="",I,K;a=a||"";if(this.bTypeAheadEnabled){if(a&&this.sDisplayFormat==="UpperCase"){a=a.toUpperCase();}if(this.bSupportBasicSearch){if(this._shouldHaveRecommendations()||this._shouldHaveHistory()){b={"search-focus":this.sKey,"search":a};}else{b.custom={"search-focus":this.sKey,"search":a};}}this._calculateFilterInputData();if(this.mFilterInputData&&this.aFilterField){i=k.generateFilters(this.aFilterField,this.mFilterInputData,{dateSettings:this._oDateFormatSettings});}if(!this.bSupportBasicSearch){if(this._fieldViewMetadata&&this._fieldViewMetadata.filterType==="numc"){i.push(new F(this.sKey,h.Contains,a));}else{E=this._truncateSearchText(a);if(E===a){i.push(new F(this.sKey,h.StartsWith,E));}else{this.oControl.closeSuggestions();return;}}}x=10;}b["$top"]=x;b["$skip"]=0;if(!this.sValueListEntitySetName){s.error("ValueListProvider","Empty sValueListEntitySetName for "+this.sAggregationName+" binding! (missing primaryValueListAnnotation)");}if(this.sDeferredGroupId){b["batchGroupId"]=this.sDeferredGroupId;}if(this.aSelect&&this.aSelect.length){b["$select"]=this.aSelect.toString();}if(!(this._shouldHaveRecommendations()||this._shouldHaveHistory())||!this._isControlSupportedForHistory(this.oControl)){if(this.bTypeAheadEnabled&&this.bEnableShowTableSuggestionValueHelp){K={dataReceived:function(Q){var R=Q.getSource(),U;if(R){U=R.getLength();if(U&&U<=x){this.oControl.setShowTableSuggestionValueHelp(false);}else{this.oControl.setShowTableSuggestionValueHelp(true);}}}.bind(this)};}else if(this.bTypeAheadEnabled){this.oControl.setShowTableSuggestionValueHelp(false);}if(this.aSelect&&this.aSelect.length){b["select"]=this.aSelect.toString();delete b["$select"];}if(this._isControlDropdown(this.oControl)&&(this.mInParams&&Object.keys(this.mInParams).length>1||this.mConstParams&&Object.keys(this.mConstParams).length>=1)){if(!K){K={dataReceived:function(){this.oControl.setBusy(false);}.bind(this)};}this._calculateFilterInputData();if(this.mFilterInputData&&this.aFilterField){i=k.generateFilters(this.aFilterField,this.mFilterInputData,{dateSettings:this._oDateFormatSettings});}}this.oControl.bindAggregation(this.sAggregationName,{path:"/"+this.sValueListEntitySetName,length:x,parameters:b,filters:i,sorter:this._oSorter,events:K,template:this._oTemplate,templateShareable:true});return;}this._bindInnerControlSuggestions();var N=this;I=new Promise(function(Q,R){if(!N.sValueListEntitySetName){Q({results:[]});}N.oODataModel.read("/"+N.sValueListEntitySetName,{urlParameters:b,filters:i,sorters:N._oSorter&&[N._oSorter],success:function(U){Q(U);},error:function(U){R(U);}});});var O=Promise.resolve([]);if(this._shouldHaveHistory()){O=N._oHistoryValuesProvider.getFieldData();}Promise.all([I,this._oRecommendationListPromise,O]).then(function(R){var Q=[],U=[],X=[],Y=[],Z=N._getSuggestionsModelName(),$=N.oControl;if(!$){return;}var _=$.getModel(Z);if(Array.isArray(R[0]&&R[0].results)){U=N._addSuggestionsToGroup(R[0].results,y.Others);}if(Array.isArray(R[1]&&R[1].results)){X=N._addSuggestionsToGroup(R[1].results,y.Recommendations);}if(N._shouldHaveHistory()&&Array.isArray(R[2])){Y=N._addSuggestionsToGroup(R[2],y.RecentlyUsed);Y=N._parseHistoryJsonDates(Y);}Q=Q.concat(X).concat(Y).concat(U);Q=N._getDistinctSuggestions(Q);Q=Q.filter(N._filterSuggestionsWithInParams.bind(N,N.mFilterInputData));N._showSuggestionsMoreButton(U.length>=x);if(N.oControl.isA("sap.m.MultiInput")){N.oControl._oSuggPopover._oProposedItem=null;}_.setData(Q);});};A.prototype._sortRecommendations=function(a,b){var R=this._oRecommendationListAnnotation.rankProperty,i=parseFloat(a[R]),x=parseFloat(b[R]);return x-i;};A.prototype._showSuggestionsMoreButton=function(b){if(!this.bTypeAheadEnabled){return;}if(this.bEnableShowTableSuggestionValueHelp){this.oControl.setShowTableSuggestionValueHelp(b);}else{this.oControl.setShowTableSuggestionValueHelp(false);}};A.prototype._addSuggestionsToGroup=function(a,i){if(!a){return[];}return a.map(function(b){var x={};x[n.getSuggestionsGroupPropertyName()]=i;return Object.assign({},b,x);});};A.prototype._groupHeaderFactory=function(a){var b=this._getGroupHeaderTitle(a.key);if(this._isControlDropdown()){return new S({key:n.getHistoryPrefix()+a.key+".key",text:b});}return new G({title:b});};A.prototype._getGroupHeaderTitle=function(a){switch(a){case y.Recommendations:return this._oResourceBundle.getText("VALUELIST_RECOMMENDATIONS_TITLE");case y.RecentlyUsed:return this._oResourceBundle.getText("VALUELIST_RECENTLY_USED_TITLE");default:return this._oResourceBundle.getText("VALUELIST_OTHERS_TITLE");}};A.prototype._getGroupHeaderSorter=function(){if(this._groupHeaderSorter){return this._groupHeaderSorter;}this._groupHeaderSorter=new g({path:n.getSuggestionsGroupPropertyName(),descending:false,group:function(a){return a.getProperty(n.getSuggestionsGroupPropertyName());}});return this._groupHeaderSorter;};A.prototype._getDistinctSuggestions=function(a){var U={},b=[];a.forEach(function(x){var i=Object.assign({},x);delete i[n.getSuggestionsGroupPropertyName()];delete i.__metadata;var K=v(i).join();if(!U[K]){b.push(x);U[K]=true;}},this);return b;};A.prototype._resolveRecommendationListAnnotationData=function(R){var a=R.fieldsToDisplay,b,x,E;this._aRecommendationCols=[];this.aRecommendationSelect=[];for(var i=0;i<a.length;i++){b=a[i];x=this._getColumnConfigFromField(b);if(b.visible){this._aRecommendationCols.push(x);this.aRecommendationSelect.push(b.name);}}if(this._aHighImportanceCols&&this._oRecommendationListAnnotation){E=this._oRecommendationListAnnotation.rankField[0];E=this._getColumnConfigFromField(E);this._aHighImportanceCols.push(E);}};A.prototype._setupRecommendations=function(){if(!this._shouldHaveRecommendations()||!this._isControlSupportedForHistory(this.oControl)){return;}this._resolveRecommendationListAnnotationData(this._getRecommendationListAnnotation());this._fetchRecommendations();};A.prototype._shouldHaveRecommendations=function(){return M.isRecommendationList(this._fieldViewMetadata);};A.prototype._getRecommendationListAnnotation=function(){if(!this._oRecommendationListAnnotation){var R=this._oMetadataAnalyser._getRecommendationListAnnotation(this._sFullyQualifiedFieldName);this._oRecommendationListAnnotation=this._oMetadataAnalyser._enrichRecommendationListAnnotation(R);}return this._oRecommendationListAnnotation;};A.prototype._fetchRecommendations=function(){var a=this;this._oRecommendationListPromise=new Promise(function(b,i){a.oODataModel.read("/"+a._oRecommendationListAnnotation.path,{urlParameters:{$skip:0,$top:5,$select:a.aRecommendationSelect.toString()},sorter:a._oSorter,success:function(x){var R=a._addSuggestionsToGroup(x.results,y.Recommendations),E=a._getSuggestionsModelName(),I=a.oControl.getModel(E),K=I.getData(),N=R.sort(a._sortRecommendations.bind(a));a._aRecommendations=N;if(Array.isArray(K)){N=[].concat(K).concat(N);}I.setData(N);a._showSuggestionsMoreButton(false);b(x);},error:function(x){i(x);}});});};A.prototype._createHistoryValuesProvider=function(){return new H(this.oControl,this._sFullyQualifiedFieldName);};A.prototype._createHistoryOptOutProvider=function(){return m.createOptOutSettingPage();};A.prototype._setupHistoryValues=function(){if(!this._shouldHaveHistory()||!this._isControlSupportedForHistory(this.oControl)){return;}this._oHistoryValuesProvider=this._createHistoryValuesProvider();this._createHistoryOptOutProvider();this._oHistoryValuesProvider.getHistoryEnabled().then(function(E){if(!E||!this._oHistoryValuesProvider){return;}this._oHistoryValuesProvider.attachChangeListener();this._oHistoryValuesProvider.attachEvent("fieldUpdated",this._onHistoryFieldUpdated,this);this._oHistoryValuesProvider.getFieldData().then(this._onHistoryDataInitialized.bind(this));}.bind(this));};A.prototype._onHistoryDataInitialized=function(a){this._updateModelHistoryData(a);return a;};A.prototype._onHistoryFieldUpdated=function(E){var a=E.getParameter("fieldData")||[];if(this.oControl.isA("sap.m.Input")){setTimeout(function(){this._updateModelHistoryData(a);this.oControl&&this.oControl._oSuggPopover._oPopover.close();}.bind(this));return;}this._updateModelHistoryData(a);if(this.oControl.isA("sap.m.ComboBox")){setTimeout(function(){this.oControl&&this.oControl._oSuggestionPopover._oPopover.close();}.bind(this));}};A.prototype._updateModelHistoryData=function(a){if(!this.oControl){return;}a=this._parseHistoryJsonDates(a);var b=[],R=this._addSuggestionsToGroup(a,y.RecentlyUsed),i=this._getSuggestionsModelName(),x=this.oControl.getModel(i),O=x.getData();if(!Array.isArray(O)){O=[];}b=this._getDistinctSuggestions(b.concat(R).concat(O));x.setData(b);this._showSuggestionsMoreButton(false);};A.prototype._shouldHaveHistory=function(){if(!this._fieldHistoryEnabled||!this._fieldViewMetadata||!this._sFullyQualifiedFieldName||!this.oControl||(this._isControlDropdown()&&(this._fieldHistoryEnabledInitial||this._fieldHistoryEnabledInitial===undefined)&&this._fieldHistoryEnabled)){return false;}var a=window["sap-ushell-config"],b,i,E;if(a){b=a.apps;}if(b){i=b.inputFieldHistory;}if(i){E=i.enabled;}return sap.ushell&&sap.ushell.Container&&E&&!M.isPotentiallySensitive(this._fieldViewMetadata);};A.prototype._bindInnerControlSuggestions=function(){if(this.sAggregationName&&this.oControl.isBound(this.sAggregationName)){return;}if(this.sAggregationName&&this.sAggregationName==="suggestionRows"){this._createSuggestionTemplate();}else{this._createDropDownTemplate();}var b={path:this._getSuggestionsModelName()+">/",template:this._oTemplate,templateShareable:true,length:this._getBindingLength()};b.groupHeaderFactory=this._groupHeaderFactory;b.sorter=this._getGroupHeaderSorter();if(this.sAggregationName){this.oControl.bindAggregation(this.sAggregationName,b);}};A.prototype._setupSuggestionInteractions=function(){if(this.sAggregationName==="suggestionRows"){this._setupInputSuggestionInteractions();return;}this._setupComboBoxSuggestionInteractions();};A.prototype._setupInputSuggestionInteractions=function(){var i=this.oControl;i.setFilterSuggests(true);i.setFilterFunction(function(a,I){var b=this._getSuggestionsModelName(),x=I.getBindingContext(b).getObject(),K=x[this.sKey],E=x[this.sDescription],N=j.getFormatterFunctionFromDisplayBehaviour(this.sDDLBDisplayBehaviour),O=N(K,E);a=a.replace(/\*$/,"");a=a.replace(/^\*/,"");var Q=Object.keys(x).some(function(K){var U=x[K]+"";return U.toLowerCase().indexOf(a.toLowerCase())!==-1;});var R=O.toLowerCase().indexOf(a.toLowerCase())!==-1;return Q||R;}.bind(this));i.attachLiveChange(function(E){var a=E.getParameter("value"),b=[y.RecentlyUsed,y.Recommendations];if(a===""){this.oControl._oSuggPopover._oPopover.close();this._showInitialSuggestions(b);}},this);i.addEventDelegate({onmousedown:function(E){if((this.oControl.getAggregation("_suggestionPopup")&&this.oControl.getAggregation("_suggestionPopup").isOpen())||E.target.tagName!=="INPUT"){return;}this._bindInnerControlSuggestions();setTimeout(function(){this._showInitialSuggestions("suggestionRows",i.getValue());}.bind(this));},onkeyup:function(E){this._bindInnerControlSuggestions();if(E.keyCode!==9){return;}setTimeout(function(){this._showInitialSuggestions("suggestionRows",i.getValue());}.bind(this));}},this);if(i.isA("sap.m.MultiInput")||!this._shouldHaveRecommendations()){return;}i.attachSuggestionItemSelected(function(E){var a=this._getSuggestionsModelName(),b=E.getParameter("selectedRow"),I;if(b){var x=b.getBindingContext(a).getObject();I=x&&x[this.sKey];}if(this._isNotRecommendationItemSelected("suggestionRows",I)){this._setControlValueState(V.Warning);}else{this._setControlValueState(V.None);}},this);};A.prototype._setupComboBoxSuggestionInteractions=function(){var a=this.oControl;a.setShowSecondaryValues(true);a.addEventDelegate({onmousedown:function(E){if((this.oControl.getPicker()&&this.oControl.getPicker().isOpen())||E.target.tagName!=="INPUT"){return;}this._bindInnerControlSuggestions();setTimeout(function(){this._showInitialSuggestions("items",a.getValue());}.bind(this));},onkeyup:function(E){this._bindInnerControlSuggestions();if(E.keyCode!==9){return;}setTimeout(function(){this._showInitialSuggestions("items",a.getValue());}.bind(this));}},this);if(a.isA("sap.m.MultiComboBox")||!this._shouldHaveRecommendations()){return;}a.attachChange(function(E){if(this._isNotRecommendationItemSelected("items",E.getParameter("value"))){this._setControlValueState(V.Warning);}else{this._setControlValueState(V.None);}},this);};A.prototype._isNotRecommendationItemSelected=function(a,b){return this._findSuggestionItemGroup(a,b)!==y.Recommendations;};A.prototype._findSuggestionItemGroup=function(a,b){var x=this.oControl.getBinding(a),I=x?x.getCurrentContexts():[],E;for(var i=0;i<I.length;i++){var K=I[i].getObject(),N=K[this.sKey],O=K[this.sDescription];if(N===b||O===b){E=K;break;}}return E?E[n.getSuggestionsGroupPropertyName()]:null;};A.prototype._setControlValueState=function(a){this.oControl.setValueState(a?a:V.None);this.oControl.setValueStateText(" ");};A.prototype._showInitialSuggestions=function(a,b){var i=this,x=[y.RecentlyUsed,y.Recommendations],E=[y.RecentlyUsed],I=[];if(this._isNotRecommendationItemSelected(a,b)){I=x;}else if(this._shouldHaveHistory()){I=E;}this._calculateFilterInputData();this.oControl.showItems(function(b,K){var N=i._getSuggestionsModelName(),O=K.getBindingContext(N),Q=O?O.getObject():{},R=Q[n.getSuggestionsGroupPropertyName()];return i._filterSuggestionsWithInParams(i.mFilterInputData,Q)&&I.indexOf(R)!==-1;});};A.prototype._filterSuggestionsWithInParams=function(a,i){if(!a||a.length===0){return true;}return Object.keys(a).every(function(K){var b=i[K];var x=a[K];if(!b){return true;}if(typeof x==="string"){return x===b;}if(typeof x==="object"&&x.items&&x.items.length>0){return x.items.some(function(E){return E.key===b;});}return true;});};A.prototype._getSuggestionsModelName=function(){var a;if(!this._isControlSupportedForHistory(this.oControl)){return a;}if(this._shouldHaveRecommendations()||this._shouldHaveHistory()){a=z;}return a;};A.prototype._resolveSuggestionBindingPath=function(a){var b=this._getSuggestionsModelName();if(b){a=b+">"+a;}return a;};A.prototype._isControlSupportedForHistory=function(a){if(!a){return false;}if(a.isA("sap.ui.comp.smartfield.DisplayComboBox")){return false;}if(a.isA("sap.m.ComboBox")||a.isA("sap.m.MultiComboBox")||a.isA("sap.m.Input")||a.isA("sap.m.MultiInput")){return true;}return false;};A.prototype._getBindingLength=function(){var i=300;if(this.oODataModel&&this.oODataModel.iSizeLimit&&this.oODataModel.iSizeLimit>i){i=this.oODataModel.iSizeLimit;}return i;};A.prototype._parseHistoryJsonDates=function(a){return a.map(function(i){return Object.keys(i).reduce(function(R,K){if(D._hasJsonDateString(i[K])){R[K]=D._parseJsonDateString(i[K]);}else{R[K]=i[K];}return R;},{});});};A.prototype._truncateSearchText=function(a){var i=-1;if(this._sMaxLength){i=parseInt(this._sMaxLength);}else if(this._fieldViewMetadata&&this._fieldViewMetadata.maxLength){i=parseInt(this._fieldViewMetadata.maxLength);}if(i>-1&&a.length>i){a=a.substr(0,i);}return a;};A.prototype.unbindAggregation=function(){if(this.oControl){this.oControl.unbindAggregation(this.sAggregationName);}return this;};A.prototype.destroy=function(){if(this.oControl){if(this.oControl.detachSuggest&&this._fSuggest){this.oControl.detachSuggest(this._fSuggest);this._fSuggest=null;}if(this.oControl.removeValidator&&this._fValidator){this.oControl.removeValidator(this._fValidator);this._fValidator=null;}else if(this.oControl.detachSuggestionItemSelected){this.oControl.detachSuggestionItemSelected(this._onSuggestionItemSelected,this);}if(this.oControl.detachChange){this.oControl.detachChange(this._validateStringSingleWithValueList,this);}this.oControl.unbindAggregation(this.sAggregationName);this.oControl.data("_hassuggestionTemplate",false);delete this.oControl.__sValidationText;delete this.oControl.__bValidatingToken;}if(this._oHistoryValuesProvider){this._oHistoryValuesProvider.destroy();this._oHistoryValuesProvider=null;}B.prototype.destroy.apply(this,arguments);if(this.oJsonModel){this.oJsonModel.destroy();this.oJsonModel=null;}if(this._oTemplate){this._oTemplate.destroy();}this._oTemplate=null;this.sAggregationName=null;this.bTypeAheadEnabled=null;this._oSorter=null;};return A;});
