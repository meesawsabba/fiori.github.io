/*
 * ! SAPUI5
 * (c) Copyright 2009-2021 SAP SE. All rights reserved.
 */
sap.ui.define(['sap/m/P13nConditionPanel','sap/m/library','sap/ui/core/library','sap/ui/core/Control','sap/ui/core/IconPool','sap/ui/Device','sap/ui/core/InvisibleText','sap/ui/core/ResizeHandler','sap/ui/core/Item','sap/ui/core/ListItem','sap/ui/model/odata/type/Boolean','sap/ui/model/type/String','sap/ui/model/odata/type/String','sap/ui/model/type/Date','sap/ui/model/type/Time','sap/ui/model/odata/type/DateTime','sap/ui/model/type/Float','sap/ui/layout/Grid','sap/ui/layout/GridData','sap/m/Button','sap/m/OverflowToolbar','sap/m/OverflowToolbarLayoutData','sap/m/ToolbarSpacer','sap/m/Text','sap/m/SearchField','sap/m/CheckBox','sap/m/ComboBox','sap/m/Select','sap/m/Label','sap/m/Input','sap/m/DatePicker','sap/m/TimePicker','sap/m/DateTimePicker','sap/base/Log','sap/ui/thirdparty/jquery','sap/ui/comp/odata/type/StringDate','sap/ui/comp/p13n/P13nOperationsHelper','sap/m/P13nConditionPanelRenderer',"sap/ui/model/json/JSONModel",'sap/ui/model/Sorter'],function(P,a,c,C,I,D,b,R,d,L,B,S,e,f,T,g,F,G,h,k,O,m,o,p,q,r,s,t,u,v,w,x,y,z,Q,A,E,H,J,K){"use strict";var M=a.ButtonType,N=a.P13nConditionOperation,U=a.P13nConditionOperationType,V=c.ValueState,W=[N.BT,N.EQ,N.LE,N.LT,N.GE,N.GT,N.NotBT,N.NotEQ,N.NotLE,N.NotLT,N.NotGE,N.NotGT];var X=P.extend("sap.ui.comp.p13n.P13nConditionPanel",{metadata:{library:"sap.ui.comp.p13n"},renderer:H.renderer});X.prototype.init=function(){this._oRbComp=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");P.prototype.init.apply(this);this._oOperationsHelper=new E();};X.prototype.setOperations=function(i,j,l){var n=l?U.Exclude:U.Include;j=j||"default";if(this._oTypeOperations[j]===undefined){this._oTypeOperations[j]={};}this._oTypeOperations[j][n]=i;this._updateAllOperations();};X._createKeyFieldTypeInstance=function(i){var j;if(!i.typeInstance){switch(i.type){case"boolean":i.typeInstance=new B();break;case"numc":if(!(i.formatSettings&&i.formatSettings.isDigitSequence)){z.error("sap.m.P13nConditionPanel","NUMC type support requires isDigitSequence==true!");i.formatSettings=Object.assign({},i.formatSettings,{isDigitSequence:true});}j=i.formatSettings;if(i.maxLength){j=Object.assign({},j,{maxLength:i.maxLength});}if(!j.maxLength){z.error("sap.m.P13nConditionPanel","NUMC type suppport requires maxLength!");}i.typeInstance=new e({},j);break;case"date":i.typeInstance=new f(Object.assign({},i.formatSettings,{strictParsing:true}),{});break;case"time":i.typeInstance=new T(Object.assign({},i.formatSettings,{strictParsing:true}),{});break;case"datetime":i.typeInstance=new g(Object.assign({},i.formatSettings,{strictParsing:true}),{displayFormat:"Date"});var n=i.typeInstance;if(!n.oFormat){n.formatValue(new Date(),"string");}if(n.oFormat){n.oFormat.oFormatOptions.UTC=false;}break;case"stringdate":i.typeInstance=new A(Object.assign({},i.formatSettings,{strictParsing:true}));break;case"numeric":if(i.precision||i.scale){j={};if(i.precision){j["maxIntegerDigits"]=parseInt(i.precision);}if(i.scale){j["maxFractionDigits"]=parseInt(i.scale);}}i.typeInstance=new F(j);break;default:var l=i.formatSettings;if(i.maxLength){l=Object.assign({},l,{maxLength:i.maxLength});}i.typeInstance=new S({},l);break;}}};X.prototype.setKeyFields=function(i){this._aKeyFields=i;this._aKeyFields.forEach(function(j){X._createKeyFieldTypeInstance(j);},this);this._updateKeyFieldItems(this._oConditionsGrid,true);this._updateAllConditionsEnableStates();this._createAndUpdateAllKeyFields();this._updateAllOperations();this._updateConditionFields();};X.prototype.setValues=function(i,j){j=j||"default";this._oTypeValues[j]=i;};X.prototype.addOperation=function(i,j,l){var n=l?U.Exclude:U.Include;j=j||"default";if(this._oTypeOperations[j]===undefined){this._oTypeOperations[j]={};}if(this._oTypeOperations[j][n]===undefined){this._oTypeOperations[j][n]=[];}this._oTypeOperations[j][n].push(i);this._updateAllOperations();};X.prototype.getOperations=function(i,j){var l,n,Y,Z;i=i||"default";if(j!==undefined){l=j?U.Exclude:U.Include;Z=this._oTypeOperations[i]&&this._oTypeOperations[i][l]||[];}else{n=this._oTypeOperations[i]&&this._oTypeOperations[i][U.Include]||[];Y=this._oTypeOperations[i]&&this._oTypeOperations[i][U.Exclude]||[];Z=n.concat(Y);}return Z;};X.prototype._updatePaginatorToolbar=function(){if(this._sConditionType!=="Filter"||this.getMaxConditions()!=="-1"){return;}var i=this._aConditionKeys.length;var j=1+Math.floor(Math.max(0,i-1)/this._iConditionPageSize);var l=1+Math.floor(this._iFirstConditionIndex/this._iConditionPageSize);var n=this.getParent();if(!this._oPaginatorToolbar){if(i>this._iConditionPageSize){this._createPaginatorToolbar();this.insertAggregation("content",this._oPaginatorToolbar,0);this._onGridResize();}else{if(n&&n.getMetadata().getName()==="sap.m.Panel"){if(this._sOrgHeaderText==undefined){this._sOrgHeaderText=n.getHeaderText();}}return;}}this._oPrevButton.setEnabled(this._iFirstConditionIndex>0);this._oNextButton.setEnabled(this._iFirstConditionIndex+this._iConditionPageSize<i);if(n&&n.setHeaderToolbar){if(!n.getHeaderToolbar()){this.removeAggregation("content",this._oPaginatorToolbar);n.setHeaderToolbar(this._oPaginatorToolbar);n.attachExpand(function($){this._setToolbarElementVisibility($.getSource().getExpanded()&&this._bPaginatorButtonsVisible);}.bind(this));}}if(n&&n.getMetadata().getName()==="sap.m.Panel"){if(this._sOrgHeaderText==undefined){this._sOrgHeaderText=n.getHeaderText();}var Y=this._sOrgHeaderText+(i>0?" ("+i+")":"");this._oHeaderText.setText(Y);}else{this._oHeaderText.setText(i+" Conditions");}this._oPageText.setText(l+"/"+j);this._bPaginatorButtonsVisible=this._bPaginatorButtonsVisible||j>1;this._setToolbarElementVisibility(this._bPaginatorButtonsVisible);if(l>j){this._iFirstConditionIndex-=Math.max(0,this._iConditionPageSize);this._clearConditions();this._fillConditions();}var Z=0;this._oConditionsGrid.getContent().forEach(function($){if($.select.getSelected()){Z++;}},this);if(j==l&&(i-this._iFirstConditionIndex)>Z){this._clearConditions();this._fillConditions();}};X.prototype._setToolbarElementVisibility=function(i){this._oPrevButton.setVisible(i);this._oNextButton.setVisible(i);this._oPageText.setVisible(i);this._oFilterField.setVisible(false);this._setLayoutVisible(this._oAddButton,i);this._setLayoutVisible(this._oRemoveAllButton,i);};X.prototype._unregisterResizeHandler=function(){if(this._sContainerResizeListener){R.deregister(this._sContainerResizeListener);this._sContainerResizeListener=null;}};X.prototype._registerResizeHandler=function(){if(this.getContainerQuery()){this._sContainerResizeListener=R.register(this._oConditionsGrid,this._onGridResize.bind(this));this._onGridResize();}};X.prototype._handleRemoveCondition=function(i,j){var l=i.getContent().indexOf(j);this._removeCondition(i,j);if(this.getAutoReduceKeyFieldItems()){this._updateKeyFieldItems(i,false);}if(l>=0){l=Math.min(l,i.getContent().length-1);var j=i.getContent()[l];setTimeout(function(){j.remove.focus();});}this._updatePaginatorToolbar();};X.prototype._getCurrentKeyFieldItem=function(i){if(i.getSelectedKey&&i.getSelectedKey()){var j=i.getSelectedKey();var l=this._aKeyFields;for(var n in l){var Y=l[n];if(Y.key===j){return Y;}}}return null;};X.prototype._createConditionRow=function(i,j,l,n,Y){var Z,$=this,_=new J();if(n===undefined){n=i.getContent().length;}var a1=new G({width:"100%",defaultSpan:"L12 M12 S12",hSpacing:1,vSpacing:0,containerQuery:this.getContainerQuery()}).data("_key",l);for(var b1 in this._aConditionsFields){var c1;var d1=this._aConditionsFields[b1];switch(d1["Control"]){case"CheckBox":c1=new r({enabled:false,layoutData:new h({span:d1["Span"+this._sConditionType]})});this._setLayoutVisible(c1,false);if(d1["ID"]==="showIfGrouped"){c1.setEnabled(true);c1.setText(d1["Label"]);c1.attachSelect(function(){$._changeField(a1);});c1.setSelected(j?j.showIfGrouped:true);}else{if(j){c1.setSelected(true);c1.setEnabled(true);}}break;case"ComboBox":if(d1["ID"]==="keyField"){c1=new s({width:"100%",ariaLabelledBy:this._oInvisibleTextField});var e1=c1.setSelectedKey.bind(c1);c1.setSelectedKey=function(l){e1(l);var s1=$.getValidationExecutor();if(s1){s1();}};var f1=c1.setSelectedItem.bind(c1);c1.setSelectedItem=function(s1){f1(s1);var t1=$.getValidationExecutor();if(t1){t1();}};c1.setLayoutData(new h({span:d1["Span"+this._sConditionType]}));this._fillKeyFieldListItems(c1,this._aKeyFields);if(c1.attachSelectionChange){c1.attachSelectionChange(function(s1){var t1=$.getValidationExecutor();if(t1){t1();}$._handleSelectionChangeOnKeyField(i,a1);});}if(c1.attachChange){c1.attachChange(function(s1){a1.keyField.close();$._handleChangeOnKeyField(i,a1);});}if(c1.setSelectedItem){if(j){c1.setSelectedKey(j.keyField);this._aKeyFields.forEach(function(g1,s1){var t1=g1.key;if(t1===undefined){t1=g1;}if(j.keyField===t1){c1.setSelectedItem(c1.getItems()[s1]);}},this);}else{if(this.getUsePrevConditionSetting()&&!this.getAutoReduceKeyFieldItems()){if(n>0&&!l&&Y){Z=i.getContent()[n-1];if(Z.keyField.getSelectedKey()){c1.setSelectedKey(Z.keyField.getSelectedKey());}else{if(!c1.getSelectedItem()&&c1.getItems().length>0){c1.setSelectedItem(c1.getItems()[0]);}}}else{this._aKeyFields.some(function(g1,s1){if(g1.isDefault){c1.setSelectedItem(c1.getItems()[s1]);return true;}if(!c1.getSelectedItem()&&g1.type!=="boolean"){c1.setSelectedItem(c1.getItems()[s1]);}},this);if(!c1.getSelectedItem()&&c1.getItems().length>0){c1.setSelectedItem(c1.getItems()[0]);}}}else{this._aKeyFields.forEach(function(g1,s1){if(g1.isDefault){c1.setSelectedItem(c1.getItems()[s1]);}},this);}}}}if(d1["ID"]==="operation"){c1=new s({width:"100%",ariaLabelledBy:this._oInvisibleTextOperator,layoutData:new h({span:d1["Span"+this._sConditionType]})});c1.addEventDelegate({onmouseup:function(){if(!this.isOpen()){this.showItems();}}},c1);c1.setFilterFunction(function(){return true;});c1.setModel(_);c1.attachChange(function(s1){$._validateOperationValue(s1);$._handleChangeOnOperationField(i,a1);});a1[d1["ID"]]=c1;this._updateOperationItems(i,a1);var g1=this._getCurrentKeyFieldItem(a1.keyField),h1=this._getRelevantOperations(g1);if(j){var i1=this.getCurrentOparation(j);h1.some(function(s1){if(i1===s1){c1.setSelectedKey(s1);return true;}},this);}else{if(this.getUsePrevConditionSetting()){if(n>0&&l===null){var Z=i.getContent()[n-1],j1=Z.operation.getSelectedKey()||h1[0];c1.setSelectedKey(j1);}else{c1.setSelectedKey(h1[0]);}}}}if(c1.getSelectedItem&&c1.getSelectedItem()&&c1.getMetadata()._sUIDToken!=="box"){c1.setTooltip(c1.getSelectedItem().getTooltip());}break;case"TextField":var k1=this._getCurrentKeyFieldItem(a1.keyField);c1=this._createValueField(k1,d1,a1);c1.oTargetGrid=i;if(c1.addAriaDescribedBy){c1.addAriaDescribedBy(this._oInvisibleTextOperatorInputValue);}if(j&&j[d1["ID"]]!==undefined){var l1=j[d1["ID"]];if(c1 instanceof t){if(typeof l1==="boolean"){c1.setSelectedIndex(l1?2:1);}}else if(l1!==null&&a1.oType){if(typeof l1==="string"&&a1.oType.getName()==="sap.ui.comp.odata.type.StringDate"){c1.setValue(l1);}else{var m1=a1&&a1.operation&&W.indexOf(a1.operation.getSelectedKey())!==-1;if(typeof l1==="string"&&["String","sap.ui.model.odata.type.String","sap.ui.model.odata.type.Decimal"].indexOf(a1.oType.getName())==-1){try{l1=a1.oType.parseValue(l1,"string",m1);c1.setValue(a1.oType.formatValue(l1,"string",m1));}catch(n1){z.error("sap.m.P13nConditionPanel","Value '"+l1+"' does not have the expected type format for "+a1.oType.getName()+".parseValue()");}}else{c1.setValue(a1.oType.formatValue(l1,"string",m1));if(c1.isA("sap.m.ComboBox")){if(l1===""){c1.getModel().attachEventOnce("batchRequestCompleted",function(c1){c1.setSelectedItem(c1.getItems()[0]);}.bind(null,c1));}else{c1.setSelectedKey(l1);}}}}}else{c1.setValue(l1);}}break;case"Label":c1=new u({text:d1["Text"]+":",visible:this.getShowLabel(),layoutData:new h({span:d1["Span"+this._sConditionType]})}).addStyleClass("conditionLabel");c1.oTargetGrid=i;break;}a1[d1["ID"]]=c1;a1.addContent(c1);}this._addButtons(a1,i);i.insertContent(a1,n);this._updateOperationItems(i,a1);this._changeOperationValueFields(i,a1);this._updateAllConditionsEnableStates();this._updateConditionButtons(i);if(this.getAutoReduceKeyFieldItems()){this._updateKeyFieldItems(i,false);}if(this._sLayoutMode){this._updateLayout({name:this._sLayoutMode});}if(j){var o1=this._getFormatedConditionText(j.operation,j.value1,j.value2,j.exclude,j.keyField,j.showIfGrouped);j._oGrid=a1;j.value=o1;this._oConditionsMap[l]=j;}var p1=a1.operation.getSelectedKey();if(p1==="BT"&&a1.value1.setMinDate&&a1.value2.setMaxDate){var q1=a1.value1.getDateValue();var r1=a1.value2.getDateValue();this._updateMinMaxDate(a1,q1,r1);}else{this._updateMinMaxDate(a1,null,null);}return a1;};X.prototype._fillOperationListItems=function(i,j,l){var n={items:[]};if(l==="_STRING_"){l="";}if(l==="_TIME_"||l==="_DATETIME_"){l="_DATE_";}if(l==="_BOOLEAN_"||l==="_NUMC_"){l="";}i.destroyItems();if(j&&j.length>0){j.forEach(function(Y){var Z=this._oRb.getText("CONDITIONPANEL_OPTION"+l+Y);if(Z.startsWith("CONDITIONPANEL_OPTION")){Z=this._oRb.getText("CONDITIONPANEL_OPTION"+Y);}n.items.push({key:Y,text:Z,sorter:this._oOperationsHelper.isExcludeType(Y)?this._oRbComp.getText("VALUEHELPDLG_EXCLUDE"):this._oRbComp.getText("VALUEHELPDLG_INCLUDE"),tooltip:Z});}.bind(this));i.getModel().setData(n);i.bindAggregation("items",{path:"/items",sorter:new K("sorter",true,true),template:new L({key:"{key}",text:"{text}"})});}};X.prototype._validateOperationValue=function(i){var j=i.getSource(),l=j.getSelectedKey(),n=j.getValue();if(!l&&n){j.setValueState(V.Error);j.setValueStateText(this._oRbComp.getText("VALUEHELPDLG_VALUE_NOT_EXIST",n));}else{j.setValueState(V.None);}};X.prototype._fillKeyFieldListItems=function(i,j){i.destroyItems();for(var l in j){var n=j[l];i.addItem(new L({key:n.key,text:n.text,tooltip:n.tooltip}));}this._setLayoutVisible(i,i.getItems().length>1);};X.prototype._updateOperationItems=function(i,j){var l=this._getCurrentKeyFieldItem(j.keyField);var n=l&&l.type||"";var Y=j.operation;var Z=Y.getSelectedItem();var $=this._getRelevantOperations(l);this._fillOperationListItems(Y,$,n?"_"+n.toUpperCase()+"_":"");if(Z&&Y.getItemByKey(Z.getKey())){Y.setSelectedKey(Z.getKey());}else{Y.setSelectedItem(Y.getItems()[1]);}this._sConditionType="Filter";if($[0]===N.Ascending||$[0]===N.Descending){this._sConditionType="Sort";}if($[0]===N.GroupAscending||$[0]===N.GroupDescending){this._sConditionType="Group";}this._adjustValue1Span(j);};X.prototype._updateKeyFieldItems=function(l,Y,Z,$){var n=l.getContent().length;var i;var _={};if(!Y){for(i=0;i<n;i++){var a1=l.getContent()[i].keyField;var b1=a1.getSelectedKey();if(b1!=null&&b1!==""){_[b1]=true;}}}for(i=0;i<n;i++){var a1=l.getContent()[i].keyField;var c1=l.getContent()[i].select;var d1=a1.getSelectedKey();var j=0;var e1=this._aKeyFields;if(a1!==$){if(Z){j=e1.length-1;}else{a1.destroyItems();}for(j;j<e1.length;j++){var f1=e1[j];if(f1.key==null||f1.key===""||!_[f1.key]||f1.key===d1){a1.addItem(new L({key:f1.key,text:f1.text,tooltip:f1.tooltip}));}}this._setLayoutVisible(a1,a1.getItems().length>1);}if(d1){a1.setSelectedKey(d1);}else if(a1.getItems().length>0){a1.setSelectedItem(a1.getItems()[0]);}if(!c1.getSelected()){this._aKeyFields.some(function(g1,h1){if(g1.isDefault){a1.setSelectedItem(a1.getItems()[h1]);return true;}if(!a1.getSelectedItem()){if(g1.type!=="boolean"){a1.setSelectedItem(a1.getItems()[h1]);}}},this);}if(a1.getSelectedItem()){a1.setTooltip(a1.getSelectedItem().getTooltip());}}};X.prototype._adjustValue1Span=function(i){if(this._sConditionType==="Filter"&&i.value1&&i.operation){var j=i.operation;var n=this._aConditionsFields[5]["Span"+this._sConditionType];var l=j.getSelectedKey();if(l!==N.BT&&l!==N.NotBT){n=this._aKeyFields.length>1?"L5 M11 S10":"XL8 L8 M8 S10";}var Y=i.value1.getLayoutData();if(Y.getSpan()!==n){Y.setSpan(n);}}};X.prototype._changeField=function(i,j){var l=i.keyField.getSelectedKey();if(i.keyField.getSelectedItem()){i.keyField.setTooltip(i.keyField.getSelectedItem().getTooltip());}else{i.keyField.setTooltip(null);}var n=i.operation.getSelectedKey();var Y=this._oOperationsHelper.isExcludeType(n);n=Y?this._oOperationsHelper.getCorrespondingIncludeOperation(n):n;if(i.operation.getSelectedItem()){i.operation.setTooltip(i.operation.getSelectedItem().getTooltip());}else{i.operation.setTooltip(null);}var Z=function(l1,m1,j){var g1,n1,i=l1.getParent();if(l1.getDateValue&&!(l1.isA("sap.m.TimePicker"))&&m1.getName()!=="sap.ui.comp.odata.type.StringDate"){n1=l1.getDateValue();if(m1&&n1){if((j&&j.getParameter("valid"))||l1.isValidValue()){g1=m1.formatValue(n1,"string");}else{g1="";}}}else{g1=this._getValueTextFromField(l1);n1=g1;if(m1&&m1.getName()==="sap.ui.comp.odata.type.StringDate"){g1=m1.formatValue(n1,"string");}else if(m1&&g1){try{var o1=i&&i.operation&&W.indexOf(i.operation.getSelectedKey())!==-1;n1=m1.parseValue(g1,"string",o1);var d1=this._getCurrentKeyFieldItem(i.keyField);if(d1&&d1.type==="numc"&&!o1&&n1===null){g1=m1.formatValue(n1,"string",o1);l1.setValue(g1);}m1.validateValue(n1);if((l1.isA("sap.m.ComboBox")&&!l1.getSelectedKey())||j&&l1.getId()==j.getSource().getId()&&i.operation.getSelectedKey()===N.BT&&(this._isInvalidFiscalRange(i)||(this._isFieldNumeric(i)&&this._isInvalidRange(i)))){g1="";}}catch(p1){z.error("sap.m.P13nConditionPanel","not able to parse value "+g1+" with type "+m1.getName());g1="";}}}return[n1,g1];}.bind(this);var $=Z(i.value1,i.oType,j);var _=$[0],a1=$[1];$=Z(i.value2,i.oType,j);var b1=$[0],c1=$[1];if(this._hasSecondValue(n)){this._updateMinMaxDate(i,_,b1);}else{this._updateMinMaxDate(i,null,null);}var d1=this._getCurrentKeyFieldItem(i.keyField);if(d1&&d1.type==="numc"){if([N.Contains,N.EndsWith].indexOf(n)!=-1){_=i.oType.formatValue(_,"string");}}var e1=i.showIfGrouped.getSelected();var f1=i.select;var g1="";var h1;if(l===""||l==null){l=null;h1=this._getKeyFromConditionGrid(i);this._removeConditionFromMap(h1);this._enableCondition(i,false);var i1=this._getIndexOfCondition(i);if(f1.getSelected()){f1.setSelected(false);f1.setEnabled(false);this._bIgnoreSetConditions=true;this.fireDataChange({key:h1,index:i1,operation:"remove",newData:null});this._bIgnoreSetConditions=false;}return;}this._enableCondition(i,true);g1=this._getFormatedConditionText(n,a1,c1,Y,l,e1);var j1={"value":g1,"exclude":Y,"operation":n,"keyField":l,"value1":_,"value2":this._hasSecondValue(n)?b1:null,"showIfGrouped":e1};h1=this._getKeyFromConditionGrid(i);if(g1!==""||i.value1.isA("sap.m.ComboBox")){f1.setSelected(true);f1.setEnabled(true);var k1="update";if(!this._oConditionsMap[h1]){k1="add";}this._oConditionsMap[h1]=j1;if(k1==="add"){this._aConditionKeys.splice(this._getIndexOfCondition(i),0,h1);}i.data("_key",h1);this.fireDataChange({key:h1,index:this._getIndexOfCondition(i),operation:k1,newData:j1});}else if(this._oConditionsMap[h1]!==undefined){this._removeConditionFromMap(h1);i.data("_key",null);var i1=this._getIndexOfCondition(i);if(f1.getSelected()){f1.setSelected(false);f1.setEnabled(false);this._bIgnoreSetConditions=true;this.fireDataChange({key:h1,index:i1,operation:"remove",newData:null});this._bIgnoreSetConditions=false;}}this._updatePaginatorToolbar();};X.prototype._getConditions=function(i){return{"index":this._iConditions,"key":this._createConditionKey(),"exclude":this._oOperationsHelper.isExcludeType(i.oOperation),"operation":i.oOperation,"keyField":i.oKeyField,"value1":i.oPastedValue,"value2":null};};X.prototype._isFieldNumeric=function(i){var j=this._getCurrentKeyFieldItem(i.keyField),l=j.type;return!!(l==="numc"||l==="numeric");};X.prototype._isFiscalField=function(i){var j=this._getCurrentKeyFieldItem(i.keyField);return j.typeInstance&&j.typeInstance.isA("sap.ui.comp.odata.type.FiscalDate");};X.prototype._isInvalidRange=function(i){var j=i.value1.getValue(),l=i.value2.getValue();return!!(j&&l&&(Number(i.oType.parseValue(j,"string"))>Number(i.oType.parseValue(l,"string"))));};X.prototype._isInvalidFiscalRange=function(i){var j,l,n,Y,Z=i.value1.getValue(),$=i.value2.getValue(),_=this._getCurrentKeyFieldItem(i.keyField),a1=_.typeInstance&&_.typeInstance.sAnotationType;if(!this._isFiscalField(i)||!Z||!$){return false;}if(a1==="com.sap.vocabularies.Common.v1.IsFiscalYearPeriod"||a1==="com.sap.vocabularies.Common.v1.IsFiscalYearQuarter"||a1==="com.sap.vocabularies.Common.v1.IsFiscalYearWeek"){if(Z.indexOf("/")!==-1&&$.indexOf("/")!==-1){j=Z.split("/")[0];n=$.split("/")[0];l=Z.split("/")[1];Y=$.split("/")[1];return l===Y?j>n:l>Y;}}else{return parseFloat(Z)>parseFloat($);}};X.prototype._validateAndFormatFieldValue=function(i){var j=i.oSource;var l=j.getParent();var n;var Y=this._oRbComp.getText("VALUEHELPVALDLG_FIELD_RANGE_MESSAGE"),Z=l&&l.operation&&W.indexOf(l.operation.getSelectedKey())!==-1;if(j.getDateValue&&i){n=i.getParameter("value");var $=i.getParameter("valid");this._makeFieldValid(j,$);return;}else{n=j.getValue&&j.getValue();}if(!l){return;}if(this.getDisplayFormat()==="UpperCase"&&n){n=n.toUpperCase();j.setValue(n);}if(l.oType&&n){try{var _=l.oType.parseValue(n,"string",Z);l.oType.validateValue(_);this._makeFieldValid(j,true);n=l.oType.formatValue(_,"string",Z);j.setValue(n);if(l.operation.getSelectedKey()===N.BT){if((this._isFieldNumeric(l)&&this._isInvalidRange(l,i))||this._isInvalidFiscalRange(l,i)){this._makeFieldValid(j,false,Y);}else{this._makeFieldValid(l.value1,true);this._makeFieldValid(l.value2,true);}}}catch(a1){var b1=a1.message;this._makeFieldValid(j,false,b1);}}else{this._makeFieldValid(j,true);}};X.prototype._changeOperationValueFields=function(i,j){P.prototype._changeOperationValueFields.apply(this,arguments);var l=j.getContent().length,n=j.remove,Y=j.indexOfContent(n),Z=l-1;if(Y!==Z){j.insertContent(n,Z);}};X.prototype._updateLayout=function(i){};X.prototype._updateConditionFields=function(){this._aConditionsFields=this._createConditionsFields();};X.prototype._addButtons=function(i,j){var l=this;var n=new k({type:M.Transparent,icon:I.getIconURI("decline"),tooltip:this._oRb.getText("CONDITIONPANEL_REMOVE"+(this._sAddRemoveIconTooltipKey?"_"+this._sAddRemoveIconTooltipKey:"")+"_TOOLTIP"),press:function(){l._handleRemoveCondition(this.oTargetGrid,i);},layoutData:new h({span:"XL1 L1 M1 S1"})});n.oTargetGrid=j;i.addContent(n);i["remove"]=n;var Y=new k({text:this._oRbComp.getText("VALUEHELPDLG_CONDITIONPANEL_ADD"),press:function(){l._handleAddCondition(this.oTargetGrid,i,true);},layoutData:new h({span:"XL2 L3 M3 S3",indent:"XL9 L8 M8 S7",linebreak:true}),ariaDescribedBy:l._oInvisibleTextOperatorAddButton});Y.oTargetGrid=j;Y.addStyleClass("conditionAddBtnFloatRight");i.addContent(Y);i["add"]=Y;};X.prototype.getCurrentOparation=function(i){return i.exclude?this._oOperationsHelper.getCorrespondingExcludeOperation(i.operation):i.operation;};X.prototype._hasSecondValue=function(i){return P.prototype._hasSecondValue.apply(this,arguments)||i===N.NotBT;};X.prototype._hasNoValues=function(i){return P.prototype._hasNoValues.apply(this,arguments)||i===N.NotEmpty;};X.prototype._createConditionsFields=function(){return[{"ID":"select","Label":"","SpanFilter":"L1 M1 S1","SpanSort":"L1 M1 S1","SpanGroup":"L1 M1 S1","Control":"CheckBox","Value":""},{"ID":"keyFieldLabel","Text":"Sort By","SpanFilter":"L1 M1 S1","SpanSort":"L1 M1 S1","SpanGroup":"L1 M1 S1","Control":"Label"},{"ID":"keyField","Label":"","SpanFilter":"L3 M5 S10","SpanSort":"L5 M5 S12","SpanGroup":"L4 M4 S12","Control":"ComboBox"},{"ID":"operationLabel","Text":"Sort Order","SpanFilter":"L1 M1 S1","SpanSort":"L1 M1 S1","SpanGroup":"L1 M1 S1","Control":"Label"},{"ID":"operation","Label":"","SpanFilter":this._aKeyFields.length>1?"L3 M6 S10":"XL3 L3 M3 S10","SpanSort":D.system.phone?"L5 M5 S8":"L5 M5 S9","SpanGroup":"L2 M5 S10","Control":"ComboBox"},{"ID":"value1","Label":this._sFromLabelText,"SpanFilter":this._aKeyFields.length>1?"L3 M10 S10":"XL4 L4 M4 S10","SpanSort":"L3 M10 S10","SpanGroup":"L3 M10 S10","Control":"TextField","Value":""},{"ID":"value2","Label":this._sToLabelText,"SpanFilter":this._aKeyFields.length>1?"L2 M10 S10":"XL4 L4 M4 S10","SpanSort":"L2 M10 S10","SpanGroup":"L2 M10 S10","Control":"TextField","Value":""},{"ID":"showIfGrouped","Label":this._sShowIfGroupedLabelText,"SpanFilter":"L1 M10 S10","SpanSort":"L1 M10 S10","SpanGroup":"L3 M4 S9","Control":"CheckBox","Value":"false"}];};X.prototype._getSecondValueNegativeIndex=function(){return 2;};X.prototype._getConditionsGridAtPosition=function(n){var i=this._oConditionsGrid.getContent();if(n>=i.length){return null;}return i[n];};X.prototype._getConditionsCount=function(){var i=this._oConditionsGrid.getContent();return i.length;};X.prototype.fireDataChange=function(i){var j,l=i.newData;if(l){j=l.operation;l.operation=this._oOperationsHelper.isExcludeType(j)?this._oOperationsHelper.getCorrespondingIncludeOperation(j):j;}return C.prototype.fireEvent.call(this,"dataChange",i);};X.prototype._makeFieldValid=function(i,j,l,n){if(n){var Y=i.getSelectedItem();if(!Y){i.setValueState(V.Error);}else{i.setValueState(V.None);}}else if(j){i.setValueState(V.None);i.setValueStateText("");}else{i.setValueState(V.Warning);i.setValueStateText(l?l:this._sValidationDialogFieldMessage);}};X.prototype._getRelevantOperations=function(i){var j,l=i&&i.typeInstance,n=l&&i.typeInstance.oConstraints&&i.typeInstance.oConstraints.isDigitSequence,Y=l&&(i.typeInstance.sAnotationType==="com.sap.vocabularies.Common.v1.IsFiscalPeriod"||i.typeInstance.sAnotationType==="com.sap.vocabularies.Common.v1.IsFiscalYearPeriod"),Z=n&&Y?"numcFiscal":i&&i.type,$=i&&i.type&&this.getOperations(Z);if(i&&i.operations){j=i.operations;}else if(Array.isArray($)&&$.length>0){j=$;}else{j=this.getOperations("default");}return j;};X.prototype._createValueField=function(j,n,Y){var Z,$,_=this,a1={value:n["Value"],width:"100%",placeholder:n["Label"],change:function(g1){_._validateAndFormatFieldValue(g1);_._changeField(Y,g1);},layoutData:new h({span:n["Span"+this._sConditionType]})};if(j&&j.typeInstance){var b1=j.typeInstance;$=this._findConfig(b1,"ctrl");if($==="DateTimePicker"&&b1.getMetadata().getName()==="sap.ui.model.odata.type.DateTime"){if(!(b1.oConstraints&&b1.oConstraints.isDateOnly)){z.error("sap.m.P13nConditionPanel","sap.ui.model.odata.type.DateTime without displayFormat = Date is not supported!");b1.oConstraints=Object.assign({},b1.oConstraints,{isDateOnly:true});}$="DatePicker";}Y.oType=b1;if($=="select"){var c1=[];var d1=j.values||this._oTypeValues[$]||["",b1.formatValue(false,"string"),b1.formatValue(true,"string")];d1.forEach(function(g1,h1){c1.push(new d({key:h1.toString(),text:g1.toString()}));});a1={width:"100%",items:c1,change:function(){_._changeField(Y);_._makeFieldValid(Z,true);},layoutData:new h({span:n["Span"+this._sConditionType]})};Z=new t(a1);}else if($=="TimePicker"){if(b1.oFormatOptions&&b1.oFormatOptions.style){a1.displayFormat=b1.oFormatOptions.style;}Z=new x(a1);}else if($=="DateTimePicker"){if(b1.oFormatOptions&&b1.oFormatOptions.style){a1.displayFormat=b1.oFormatOptions.style;}Z=new y(a1);}else if($==="DatePicker"){if(b1.oFormatOptions){a1.displayFormat=b1.oFormatOptions.style||b1.oFormatOptions.pattern;if(b1.isA("sap.ui.comp.odata.type.StringDate")){a1.valueFormat="yyyyMMdd";}}Z=new w(a1);}else{var e1=this.data("dropdownFields");Z=new v(a1);if(e1){for(var i=0;i<e1.length;i++){if(e1[i].name===j.key){a1={width:"100%",items:[],change:function(){_._changeField(Y);_._makeFieldValid(Z,true,undefined,true);},layoutData:new h({span:n["Span"+this._sConditionType]})};Z=new s(a1);break;}}}if(this._fSuggestCallback){j=this._getCurrentKeyFieldItem(Y.keyField);if(j&&j.key){var f1=this._fSuggestCallback(Z,j.key);if(f1){Z._oSuggestProvider=f1;}}}}}else{Y.oType=null;Z=new v(a1);}if($!=="boolean"&&$!=="enum"&&Z){Z.onpaste=function(g1){var h1;if(window.clipboardData){h1=window.clipboardData.getData("Text");}else{h1=g1.originalEvent.clipboardData.getData('text/plain');}var Y=g1.srcControl.getParent();var i1=h1.split(/\r\n|\r|\n/g);if(i1&&i1[i1.length-1].trim()===""){i1.pop();}var j1=Y.operation;var op=j1.getSelectedKey();if(i1&&i1.length>1&&op!=="BT"){setTimeout(function(){var k1=i1?i1.length:0;var l1=_._getCurrentKeyFieldItem(Y.keyField);var j1=Y.operation;for(var i=0;i<k1;i++){if(_._aConditionKeys.length>=_._getMaxConditionsAsNumber()){break;}var m1=i1[i].trim();if(m1){var n1;if(l1.typeInstance){try{n1=l1.typeInstance.parseValue(m1,"string");l1.typeInstance.validateValue(n1);}catch(o1){z.error("sap.m.P13nConditionPanel.onPaste","not able to parse value "+m1+" with type "+l1.typeInstance.getName());m1="";n1=null;}if(!n1){continue;}}var p1={"index":_._iConditions,"key":_._createConditionKey(),"exclude":_.getExclude()||_._oOperationsHelper.isExcludeType(j1.getSelectedKey()),"operation":j1.getSelectedKey(),"keyField":l1.key,"value1":n1,"value2":null};_._addCondition2Map(p1);_.fireDataChange({key:p1.key,index:p1.index,operation:"add",newData:p1});}}_._clearConditions();_._fillConditions();},0);}};}if(j&&j.maxLength&&Z.setMaxLength){var l=-1;if(typeof j.maxLength==="string"){l=parseInt(j.maxLength);}if(typeof j.maxLength==="number"){l=j.maxLength;}if(l>0&&(!Z.getShowSuggestion||!Z.getShowSuggestion())){Z.setMaxLength(l);}}return Z;};X.prototype._enableCondition=function(i,j){var l=this._getCurrentKeyFieldItem(i.keyField);l&&l.type==="boolean"?i.operation.setEnabled(false):i.operation.setEnabled(j);i.value1.setEnabled(j);i.value2.setEnabled(j);i.showIfGrouped.setEnabled(j);};X.prototype._getValueTextFromField=function(i){if(i instanceof t){return i.getSelectedItem()?i.getSelectedItem().getText():"";}if(i.isA("sap.m.ComboBox")){return i.getSelectedItem()?i.getSelectedItem().getKey():"";}return i.getValue();};return X;});
