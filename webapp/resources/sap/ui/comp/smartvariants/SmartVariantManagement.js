/*
 * ! SAPUI5
 * (c) Copyright 2009-2021 SAP SE. All rights reserved.
 */
sap.ui.define(['sap/ui/thirdparty/jquery','sap/ui/comp/library','sap/ui/comp/variants/VariantItem','sap/ui/comp/odata/ODataModelUtil','sap/ui/comp/odata/MetadataAnalyser','./SmartVariantManagementAdapter','./SmartVariantManagementBase','sap/base/Log','sap/base/util/merge','sap/ui/base/SyncPromise'],function(q,l,V,O,M,S,a,L,m,b){"use strict";var F;var c;var d;var e=a.extend("sap.ui.comp.smartvariants.SmartVariantManagement",{metadata:{library:"sap.ui.comp",designtime:"sap/ui/comp/designtime/smartvariants/SmartVariantManagement.designtime",properties:{persistencyKey:{type:"string",group:"Misc",defaultValue:null},entitySet:{type:"string",group:"Misc",defaultValue:null},displayTextForExecuteOnSelectionForStandardVariant:{type:"string",group:"Misc",defaultValue:""}},aggregations:{personalizableControls:{type:"sap.ui.comp.smartvariants.PersonalizableInfo",multiple:true,singularName:"personalizableControl"}},events:{initialise:{},save:{parameters:{tile:{type:"boolean"}}},afterSave:{}}},renderer:{apiVersion:2}});e.prototype.init=function(){a.prototype.init.apply(this);this._bIsInitialized=false;this._bIsVariantAdaptationEnabled=false;this._oStandardVariant=null;this._fRegisteredApplyAutomaticallyOnStandardVariant=null;this._oControlPromise=null;this._oPersoControl=null;this._sAppStandardVariantKey=null;this._mShadowContent={};this._oSelectionVariantHandler={};this._oAppStdContent=null;this._aPersonalizableControls=[];if(this.setLifecycleSupport){this.setLifecycleSupport(true);}this._setBackwardCompatibility(false);this._oAdapter=null;this._bApplyingUIState=false;this.setSupportExecuteOnSelectOnSandardVariant(true);this._mVariants={};this._loadFlex();};e.prototype.setEntitySet=function(E){this.setProperty("entitySet",E,true);this.attachModelContextChange(this._initializeMetadata,this);this._createMetadataPromise();this._initializeMetadata();return this;};e.prototype._createMetadataPromise=function(){this._oMetadataPromise=new Promise(function(r,f){this._fResolveMetadataPromise=r;}.bind(this));};e.prototype._resolveMetadataPromise=function(){if(this._fResolveMetadataPromise){this._fResolveMetadataPromise();}};e.prototype._initializeMetadata=function(){if(!this.bIsInitialised){O.handleModelInit(this,this._onMetadataInitialised);}};e.prototype._onMetadataInitialised=function(){this._bMetaModelLoadAttached=false;if(!this.bIsInitialised){var o=new M(this.getModel());if(o){this._oAdapter=new S({selectionPresentationVariants:o.getSelectionPresentationVariantAnnotationList(this.getEntitySet())});this.detachModelContextChange(this._initializeMetadata,this);this.bIsInitialised=true;this._resolveMetadataPromise();}}};e.prototype.applySettings=function(s){if(!s||!s.hasOwnProperty("useFavorites")){this.setUseFavorites(true);}a.prototype.applySettings.apply(this,arguments);};e.prototype._createControlWrapper=function(C){var o=null;var f=sap.ui.getCore().byId(C.getControl());if(f){o={control:f,type:C.getType(),dataSource:C.getDataSource(),keyName:C.getKeyName(),loaded:q.Deferred()};}return o;};e.prototype._getControlWrapper=function(C){var f=this._getAllPersonalizableControls();if(f&&f.length){for(var i=0;i<f.length;i++){if(f[i].control===C){return f[i];}}}return null;};e.prototype.addPersonalizableControl=function(C){var o,s=C.getControl();var f=sap.ui.getCore().byId(s);if(!f){L.error("couldn't obtain the control with the id="+s);return this;}this.addAggregation("personalizableControls",C,true);o=this._createControlWrapper(C);if(o){this._aPersonalizableControls.push(o);}if(this.isPageVariant()){return this;}this.setPersControler(f);return this;};e.prototype.getTransportSelection=function(){if(c){return Promise.resolve(c._getTransportSelection());}else{return this._loadFlex().then(function(){return c._getTransportSelection();});}};e.prototype._loadFlex=function(){var r=function(){return new Promise(function(R){sap.ui.require(["sap/ui/fl/apply/api/SmartVariantManagementApplyAPI","sap/ui/fl/write/api/SmartVariantManagementWriteAPI","sap/ui/fl/apply/api/FlexRuntimeInfoAPI"],function(f,g,h){F=f;c=g;d=h;R();});});};if(!this._oFlLibrary){if(!this._oPersistencyPromise){this._oPersistencyPromise=new Promise(function(R,f){this._fResolvePersistencyPromise=R;this._fRejectPersistencyPromise=f;}.bind(this));}this._oFlLibrary=new Promise(function(R){sap.ui.getCore().loadLibrary('sap.ui.fl',{async:true}).then(function(){r().then(R);});});}return this._oFlLibrary;};e.prototype.setPersControler=function(C){if(F&&c&&d){this._setPersControler(C);}else{this._loadFlex().then(function(){this._setPersControler(C);}.bind(this));}};e.prototype._setPersControler=function(C){if(!this._oPersoControl){if(this._isFlexSupported(C)){this._oPersoControl=C;this._handleGetChanges(C);}}};e.prototype._isFlexSupported=function(C){return d.isFlexSupported({element:C});};e.prototype.setPersistencyKey=function(k){this.setProperty("persistencyKey",k);this.setPersControler(this);return this;};e.prototype.isPageVariant=function(){if(this.getPersistencyKey()){return true;}return false;};e.prototype._getAdapter=function(){return this._oAdapter;};e.prototype._getFilterBarAdapter=function(){return(this._oSelectionVariantHandler["#"]);};e.prototype._handleGetChanges=function(C){if(C&&F){this._mShadowContent={};this._oControlPromise=new Promise(function(r,f){Promise.all([this._oMetadataPromise]).then(function(){if(this._bIsBeingDestroyed){return;}var p={control:this._oPersoControl,standardVariant:{id:this.STANDARDVARIANTKEY,name:this._determineStandardVariantName(),executeOnSelection:this.bExecuteOnSelectForStandardViaXML}};if(this._getAdapter()){p.variants=this._getAdapter().getODataVariants();}else if(this._getFilterBarAdapter()){p.variants=this._getFilterBarAdapter().variants;}F.loadVariants(p).then(function(v){this._fResolvePersistencyPromise();r(v);}.bind(this),function(g){this._fRejectPersistencyPromise(g);f(g);}.bind(this));}.bind(this));}.bind(this));}};e.prototype._getVariantById=function(k){if(this._mVariants&&this._mVariants[k]){return this._mVariants[k];}return null;};e.prototype.getVariantContent=function(C,k){var p,o=this._getVariantContent(k);if(o&&this.isPageVariant()&&C){p=this._getControlPersKey(C);if(p){o=this._retrieveContent(o,p);}}return o;};e.prototype._isUIAdaptationMode=function(){return(sap.ui.dt&&sap.ui.dt.OverlayRegistry&&sap.ui.dt.OverlayRegistry.getOverlay(this.getId()));};e.prototype._getContent=function(v){if(this._mShadowContent[v.getId()]&&this._isUIAdaptationMode()){return this._mShadowContent[v.getId()];}return v.getContent();};e.prototype.assignShadowContent=function(k,s){this._mShadowContent[k]=s;};e.prototype._removeShadowContent=function(k){if(this._mShadowContent[k]){delete this._mShadowContent[k];}};e.prototype._getVariantContent=function(k){var v=this._getVariantById(k);if(v){var C=this._getContent(v);if(C){if((k===this.STANDARDVARIANTKEY)&&(Object.keys(C).length<1)){C=this.getStandardVariant();}return m({},C);}}return null;};e.prototype._getAllPersonalizableControls=function(){return this._aPersonalizableControls;};e.prototype.removeAllPersonalizableControls=function(){this.removeAllAggregation("personalizableControls");this._aPersonalizableControls=[];};e.prototype.removePersonalizableControl=function(C){var p=this.removeAggregation("personalizableControls",C);if(p){this._aPersonalizableControls.some(function(P,i){if(P.control.getId()===p.getControl()){this._aPersonalizableControls.splice(i,1);return true;}return false;}.bind(this));}return p;};e.prototype.removePersonalizableControlById=function(C){var p=this.getAggregation("personalizableControls");if(p){p.some(function(P,i){if(P.getControl()===C.getId()){this.removePersonalizableControl(P);return true;}return false;}.bind(this));}};e.prototype._createVariantItem=function(v){this._mVariants[v.getId()]=v;var o=new V({key:v.getId(),global:!v.isUserDependent(),lifecycleTransportId:v.getRequest(),lifecyclePackage:v.getPackage(),namespace:v.getNamespace(),readOnly:!v.isEditEnabled(),labelReadOnly:!v.isRenameEnabled(),favorite:v.getFavorite(),executeOnSelection:this._getExecuteOnSelection(v),author:v.getOwnerId()});if(v.getContexts){o.setContexts(v.getContexts());}o.setText(v.getName());this.addVariantItem(o);};e.prototype._createVariantEntries=function(v){var s,A=null;this.removeAllVariantItems();if(v){if(v.standardVariant){this._createVariantItem(v.standardVariant);var C=this._getVariantContent(v.standardVariant.getId());if(Object.keys(C).length>0){A=v.standardVariant.getId();}}if(v.variants){v.variants.forEach(function(o){this._createVariantItem(o);}.bind(this));}}if(this._oPersoControl){s=this._getDefaultVariantKey();if(s){this.setInitialSelectionKey(s);}var f=this._isApplicationVariant({control:this._oPersoControl});if(f){this._setIndustrySolutionMode(f);f=this._isVendorLayer();this._setVendorLayer(f);}if(this._getIndustrySolutionMode()&&A){this._sAppStandardVariantKey=A;if(A!==this.STANDARDVARIANTKEY){this.setStandardVariantKey(A);}}if(F&&F.isVariantDownport()){this._enableManualVariantKey(true);}}};e.prototype._isApplicationVariant=function(o){return F.isApplicationVariant(o);};e.prototype._isVendorLayer=function(){return F.isVendorLayer();};e.prototype._addFavorites=function(f){f.forEach(function(E){if(E.key!==this.STANDARDVARIANTKEY){var v=this._getVariantById(E.key);if(v){this._flUpdateVariant(v,{favorite:E.visible});}}}.bind(this));};e.prototype._flUpdateVariant=function(v,p){var u;var P={control:this._oPersoControl,id:v.getId()};if(p.hasOwnProperty("content")||p.hasOwnProperty("name")){var f=m({},P);f.layer=v.getLayer();if(p.hasOwnProperty("content")){f.content=p.content;}if(p.hasOwnProperty("name")){f.name=p.name;}if(p.hasOwnProperty("packageName")){f.packageName=p.packageName;}if(p.hasOwnProperty("transportId")){f.transportId=p.transportId;}u=this._flWriteUpdateVariant(f);if(u){this._mVariants[u.getId()]=u;}}P={control:this._oPersoControl,id:v.getId()};if(p.hasOwnProperty("favorite")||p.hasOwnProperty("executeOnSelection")){P.isUserDependent=true;if(p.hasOwnProperty("favorite")){P.favorite=p.favorite;}if(p.hasOwnProperty("executeOnSelection")){P.executeOnSelection=p.executeOnSelection;}u=this._flWriteUpdateVariant(P);if(u){this._mVariants[u.getId()]=u;}}};e.prototype._flRemoveVariant=function(v){var p={control:this._oPersoControl,id:v.getId(),layer:v.getLayer()};var D=this._flWriteRemoveVariant(p);if(D){delete this._mVariants[D.getId()];}};e.prototype._flWriteUpdateVariant=function(p){if(c){return c.updateVariant(p);}return null;};e.prototype._flWriteRemoveVariant=function(p){if(c){return c.removeVariant(p);}return null;};e.prototype._flWriteAddVariant=function(p){if(c){return c.addVariant(p);}return null;};e.prototype.flWriteOverrideStandardVariant=function(f){if(c){c.overrideStandardVariant({control:this._oPersoControl,executeOnSelection:f});}};e.prototype.getCurrentVariantId=function(){var k=this._getCurrentVariantId();if(k===this.STANDARDVARIANTKEY){k="";}return k;};e.prototype._getCurrentVariantId=function(){var k=this.getSelectionKey();return k;};e.prototype.setCurrentVariantId=function(v,D){var i=this._determineVariantId(v);if(this._oPersoControl){if(!this._oStandardVariant){this._setSelectionByKey(i);}else{this._applyCurrentVariantId(i,D);}}};e.prototype._applyCurrentVariantId=function(v,D){var o,C;if(this._oPersoControl){o=this._getVariantById(v);if(o){C=this._getVariantContent(v);if(C){this._setSelectionByKey(v);if(!D){if(this.isPageVariant()){this._applyVariants(C,"SET_VM_ID",o.getExecuteOnSelection());}else{this._applyVariant(this._oPersoControl,C,"SET_VM_ID",false,o.getExecuteOnSelection());}}}}}};e.prototype._determineVariantId=function(v){var i=v;if(!i){i=this.getStandardVariantKey();}else{if(!this.getItemByKey(i)){i=this.getStandardVariantKey();}}return i;};e.prototype.initialise=function(C,p){var o,E;try{if(p&&C){o=this._getControlWrapper(p);if(!o){L.error("initialise on an unknown control.");return;}if(o.bInitialized){L.error("initialise on "+p.getId()+" already executed");return;}o.fInitCallback=C;}else if(!this.isPageVariant()){o=this._getControlWrapper(this._oPersoControl);}if(this._oPersistencyPromise){this._oPersistencyPromise.then(function(){if(this._oControlPromise&&this._oPersoControl&&o){Promise.all([this._oMetadataPromise,this._oControlPromise,c.isVariantSharingEnabled(),c.isVariantPersonalizationEnabled(),c.isVariantAdaptationEnabled()]).then(function(v){this._dataReceived(v[1],v[2],v[3],v[4],o);}.bind(this),function(g){E="'loadVariants' failed:";if(g&&g.message){E+=(' '+g.messages);}this._errorHandling(E,C,p);}.bind(this),function(g){if(g&&g.message){E=g.message;}else{E="accessing either flexibility functionality or odata metadata.";}this._errorHandling("'initialise' failed: "+E,C,p);}.bind(this));}else{this._errorHandling("'initialise' no personalizable component available",C,p);}}.bind(this),function(g){if(g&&g.message){E=g.message;}else{E="accessing the flexibility functionality.";}this._errorHandling("'initialise' failed: "+E,C,p);}.bind(this));}else{this._errorHandling("'initialise' no '_oPersistencyPromise'  available",C,p);}}catch(f){this._errorHandling("exception occurs during 'initialise' processing",C,p);}};e.prototype._errorHandling=function(E,C,p){var f={variantKeys:[]};this._setErrorValueState(this.oResourceBundle.getText("VARIANT_MANAGEMENT_READ_FAILED"),E);if(C&&p){C.call(p);}else{this.fireEvent("initialise",f);}if(p.variantsInitialized){p.variantsInitialized();}};e.prototype.isVariantAdaptationEnabled=function(){return this._bIsVariantAdaptationEnabled;};e.prototype._dataReceived=function(v,i,I,f,C){var D,k,p={variantKeys:[]};if(this._bIsBeingDestroyed){return;}if(!this._bIsInitialized){this._bIsVariantAdaptationEnabled=f;this.setVariantCreationByUserAllowed(I);this.setShowShare(i);this._bIsInitialized=true;this._createVariantEntries(v);k=this._getDefaultVariantKey();if(k){D=this._getVariantById(k);if(D){this.setDefaultVariantKey(k);this.setInitialSelectionKey(k);}}if(this._sAppStandardVariantKey){this._oAppStdContent=this._getVariantContent(this._sAppStandardVariantKey);}}this._initialize(p,C);};e.prototype._initialize=function(p,C){var k,o=null,i=this.isPageVariant();var v,E=false;if(this._oAppStdContent){if((C.type==="table")||(C.type==="chart")){if(i){this._applyControlVariant(C.control,this._oAppStdContent,"STANDARD",true);}else{this._applyVariant(C.control,this._oAppStdContent,"STANDARD",true);}}}if(C.fInitCallback){C.fInitCallback.call(C.control);delete C.fInitCallback;C.bInitialized=true;}else{p.variantKeys=Object.keys(this._mVariants);this.fireEvent("initialise",p);}k=this.getSelectionKey();if(k&&(k!==this.getStandardVariantKey())){o=this._getVariantContent(k);v=this._getVariantById(k);if(v){E=v.getExecuteOnSelection();}}else if(this._oAppStdContent){o=this._oAppStdContent;if((C.type==="table")||(C.type==="chart")){o=null;}}var r;if(this._sAppStandardVariantKey){r=this._updateStandardVariant(C,this._oAppStdContent);}else{r=this._setStandardVariant(C);}b.resolve(r).then(function(r){C.loaded.resolve();if(o){if(i){this._applyControlVariant(C.control,o,"INIT",true,E);}else{this._applyVariant(C.control,o,"INIT",true,E);}}if(this.bConsiderXml!==undefined){this._executeOnSelectForStandardVariantByXML(this.bConsiderXml);}if(C.control.variantsInitialized){C.control.variantsInitialized();}if(this._getCurrentVariantId()===this.getStandardVariantKey()){if(this._getApplyAutomaticallyOnStandardVariant()&&C.control.search){C.control.search();}if(this.getExecuteOnSelectForStandardVariant()&&this._oAppStdContent){var I=this.getItemByKey(this._getCurrentVariantId());if(I){I.setExecuteOnSelection(true);}}}if(!this.getEnabled()){this.setEnabled(true);}}.bind(this)).catch(function(f){L.error("'_initialize' throws an exception:"+f.message);}).unwrap();};e.prototype._updateVariant=function(v){if(this._isIndustrySolutionModeAndVendorLayer()||(v.key!==this.getStandardVariantKey())){if(v){var o=this._getVariantById(v.key);if(o){try{return b.resolve(this._fetchContentAsync()).then(function(C){if(C){var i=this.getItemByKey(v.key);if(this._isIndustrySolutionModeAndVendorLayer()&&(v.key===this.getStandardVariantKey())){C.standardvariant=true;}var p={content:C};if((v.lifecycleTransportId!==null)&&(v.lifecycleTransportId!==undefined)){p.transportId=v.lifecycleTransportId;}if((v.lifecyclePackage!==null)&&(v.lifecyclePackage!==undefined)){p.packageName=v.lifecyclePackage;}if(i){p.executeOnSelection=i.getExecuteOnSelection();}this._flUpdateVariant(o,p);if(v.def===true){this._setDefaultVariantKey(v.key);}}this._save(false);this.setEnabled(true);}.bind(this)).catch(function(f){L.error("'_updateVariant' throws an exception:"+f.message);}).unwrap();}catch(f){L.error("'_updateVariant' throws an exception");}}}}};e.prototype._createChangeHeader=function(){if(this.isPageVariant()){return{type:"page",dataService:"n/a"};}var C=this._getAllPersonalizableControls();if(C&&C.length>0){return{type:C[0].type,dataService:C[0].dataSource};}};e.prototype._newVariant=function(v){var i,I=false;if(v){var t=this._createChangeHeader();var u=!v.global;var p="";if((v.lifecyclePackage!==null)&&(v.lifecyclePackage!==undefined)){p=v.lifecyclePackage;}var T="";if((v.lifecycleTransportId!==null)&&(v.lifecycleTransportId!==undefined)){T=v.lifecycleTransportId;}i=this._isVariantDownport()?v.key:null;if(this._isIndustrySolutionModeAndVendorLayer()&&(this.getStandardVariantKey()===this.STANDARDVARIANTKEY)){if((T||p)&&(v.name===this.oResourceBundle.getText("VARIANT_MANAGEMENT_STANDARD"))){this.setStandardVariantKey(i);I=true;}}return b.resolve(this._fetchContentAsync()).then(function(C){if(C){if(I){C.standardvariant=true;}}var P={type:t.type,ODataService:t.dataSource,texts:{variantName:v.name},content:C,isVariant:true,packageName:p,isUserDependent:u,executeOnSelection:v.exe,id:i};var o=this._flWriteAddVariant({control:this._oPersoControl,changeSpecificData:P});if(o){i=o.getId();this._mVariants[i]=o;if(!this._isVendorLayer()){this._flUpdateVariant(o,{favorite:true});}if(v.implicit&&!this.verifyVariantKey(v.key)){v.key=this.createVariantEntry(v);}this.replaceKey(v.key,i);this.setInitialSelectionKey(i);if(this._isIndustrySolutionModeAndVendorLayer()&&((v.key===this.STANDARDVARIANTKEY)||this._isVariantDownport())){this.setStandardVariantKey(i);}if(v.def===true){this._setDefaultVariantKey(i);}o.setRequest(T);var f=this.getItemByKey(i);if(f){f.setNamespace(o.getNamespace());f.setFavorite(true);}this._save(true);this.setEnabled(true);}}.bind(this)).catch(function(f){L.error("'_newVariant' throws an exception:"+f.message);}).unwrap();}};e.prototype._setFavorite=function(i){var I=this.getItemByKey(i);if(I){I.setFavorite(true);}this._addFavorites([{key:i,visible:true}]);};e.prototype._fetchContent=function(){var C,p,o,f={};var g=this._getAllPersonalizableControls();for(var i=0;i<g.length;i++){C=g[i];if(C&&C.control&&C.control.fetchVariant){o=C.control.fetchVariant();if(o){o=m({},o);if(this.isPageVariant()){p=this._getControlPersKey(C);if(p){f=this._assignContent(f,o,p);}else{L.error("no persistancy key retrieved");}}else{f=o;break;}}}}return f;};e.prototype._fetchContentAsync=function(){var C,p,o,f={},g=[],h=[];var j=this._getAllPersonalizableControls();for(var i=0;i<j.length;i++){C=j[i];if(C&&C.control&&C.control.fetchVariant){o=C.control.fetchVariant();if(o){if(o&&o instanceof Promise){this.setEnabled(false);g.push(o);h.push(C);continue;}o=m({},o);if(this.isPageVariant()){p=this._getControlPersKey(C);if(p){f=this._assignContent(f,o,p);}else{L.error("no persistancy key retrieved");}}else{f=o;break;}}}}if(g.length>0){var r=null;var P=new Promise(function(k,n){r=k;});Promise.all(g).then(function(k){for(var i=0;i<k.length;i++){o=m({},k[i]);if(this.isPageVariant()){p=this._getControlPersKey(h[i]);if(p){f=this._assignContent(f,o,p);}else{L.error("no persistancy key retrieved");}}else{f=o;break;}}r(f);}.bind(this));return P;}else{return f;}};e.prototype._getControlInfoPersKey=function(C){var p=null;if(C.keyName==="id"){p=C.control.getId();}else{p=C.control.getProperty(C.keyName);}return p;};e.prototype._getControlPersKey=function(C){var o=C;if(!C.keyName){o=this._getControlWrapper(C);}return this._getControlInfoPersKey(o);};e.prototype._appendLifecycleInformation=function(v,i){var t;var I=this.getItemByKey(i);if(I){t=I.getLifecycleTransportId();if(t===null||t===undefined){t="";}}return t;};e.prototype._renameVariant=function(v){if(v.key!==this.getStandardVariantKey()){if(v){var o=this._getVariantById(v.key);if(o){var p={name:v.name};var t=this._appendLifecycleInformation(o,v.key);if(t!=undefined){p.transportId=t;}this._flUpdateVariant(o,p);}}}};e.prototype._deleteVariants=function(v){var t;if(v&&v.length){var s=this._getDefaultVariantKey();for(var i=0;i<v.length;i++){if(v[i]===this.getStandardVariantKey()){if(!this._isIndustrySolutionModeAndVendorLayer()){continue;}else{this.setStandardVariantKey(this.STANDARDVARIANTKEY);}}var o=this._getVariantById(v[i]);if(o){t=this._appendLifecycleInformation(o,v[i]);o.setRequest(t);this._flRemoveVariant(o);if(s&&s===v[i]){this._setDefaultVariantKey("");}}}}};e.prototype._getDefaultVariantKey=function(){var D="";if(F){D=F.getDefaultVariantId({control:this._oPersoControl});}return D;};e.prototype._executeOnSelectForStandardVariantByXML=function(s){a.prototype._executeOnSelectForStandardVariantByXML.apply(this,arguments);this._reapplyExecuteOnSelectForStandardVariant(s);};e.prototype._reapplyExecuteOnSelectForStandardVariant=function(s){if(Object.keys(this._mVariants).length>0){this.bConsiderXml=undefined;this.flWriteOverrideStandardVariant(s);var f=this.getStandardVariantKey();var v=this._getVariantById(f);if(v){var o=this.getItemByKey(f);if(o){o.setExecuteOnSelection(v.getExecuteOnSelection());}}}else{this.bConsiderXml=s;}};e.prototype.setExecuteOnStandard=function(s){this._reapplyExecuteOnSelectForStandardVariant(s);};e.prototype.getExecuteOnStandard=function(){var s=this.getStandardVariantKey();var o=this.getItemByKey(s);if(o){return o.getExecuteOnSelection();}return undefined;};e.prototype.registerApplyAutomaticallyOnStandardVariant=function(C){this._fRegisteredApplyAutomaticallyOnStandardVariant=C;return this;};e.prototype._getApplyAutomaticallyOnStandardVariant=function(){var E=this.getExecuteOnSelectForStandardVariant();if(this._fRegisteredApplyAutomaticallyOnStandardVariant&&this.getDisplayTextForExecuteOnSelectionForStandardVariant()){try{E=this._fRegisteredApplyAutomaticallyOnStandardVariant();}catch(f){L.error("callback for determination of apply automatically on standard variant failed");}}return E;};e.prototype._setDefaultVariantKey=function(v){if(c){c.setDefaultVariantId({control:this._oPersoControl,defaultVariantId:v});}};e.prototype._isVariantDownport=function(){var D=false;if(F){D=F.isVariantDownport();}return D;};e.prototype._getExecuteOnSelection=function(v){return v.getExecuteOnSelection();};e.prototype._setExecuteOnSelections=function(v){if(v&&v.length){for(var i=0;i<v.length;i++){var o=this._getVariantById(v[i].key);if(o){this._flUpdateVariant(o,{executeOnSelection:v[i].exe});}}}};e.prototype._save=function(n,i){if(c){try{c.save({control:this._oPersoControl}).then(function(){if(!i){if(n){this._updateUser();}this.fireEvent("afterSave");}}.bind(this),function(g){var E="'_save' failed:";if(g&&g.message){E+=(' '+g.message);}this._setErrorValueState(this.oResourceBundle.getText("VARIANT_MANAGEMENT_SAVE_FAILED"),E);}.bind(this));}catch(f){this._setErrorValueState(this.oResourceBundle.getText("VARIANT_MANAGEMENT_SAVE_FAILED"),"'_save' throws an exception");}}};e.prototype._updateUser=function(){var i=this.getInitialSelectionKey();var u,v=this._getVariantById(i);if(v){u=v.getOwnerId();if(u){this._assignUser(i,u);}}};e.prototype.fireSave=function(v){var E={};if(v){if(v.hasOwnProperty("tile")){E.tile=v.tile;}if(v.overwrite){if(this._isIndustrySolutionModeAndVendorLayer()||(v.key!==this.getStandardVariantKey())){this.fireEvent("save",E);if(v.key===this.STANDARDVARIANTKEY){this._newVariant(v);}else{this._updateVariant(v);}}}else{this.fireEvent("save",E);this._newVariant(v);}}};e.prototype.fireManage=function(v){var i,D=false;if(v){if(v.renamed){for(i=0;i<v.renamed.length;i++){this._renameVariant(v.renamed[i]);}}if(v.deleted){this._deleteVariants(v.deleted);}if(v.exe){this._setExecuteOnSelections(v.exe);}if(v.def){var s=this._getDefaultVariantKey();if(s!==v.def){if(!((s==="")&&(v.def===this.STANDARDVARIANTKEY))){this._setDefaultVariantKey(v.def);D=true;}}}if(v.fav&&(v.fav.length>0)){this._addFavorites(v.fav);}if((v.deleted&&v.deleted.length>0)||(v.renamed&&v.renamed.length>0)||(v.exe&&v.exe.length>0)||D){this._save();}else if(v.fav&&(v.fav.length>0)){this._save(false,true);}this.fireEvent("manage",v);}};e.prototype.fireSelect=function(v,C){if(this._oPersoControl&&v&&v.key){this._triggerSelectVariant(v.key,C);this.fireEvent("select",v);}};e.prototype._selectVariant=function(v,C){this.fireSelect({key:v},C);};e.prototype._checkForSelectionHandler=function(v){var h=null,H=Object.keys(this._oSelectionVariantHandler);if(H.length>-1){H.some(function(k){if(v.indexOf(k)===0){h=this._oSelectionVariantHandler[k];return true;}return false;}.bind(this));}return h;};e.prototype._triggerSelectVariant=function(v,C){var E,o,h=false,H=this._checkForSelectionHandler(v);var f=this._getVariantById(v);if(f){E=f.getExecuteOnSelection();if(v===this.getStandardVariantKey()){E=this._getApplyAutomaticallyOnStandardVariant();}h=(Object.entries(this._getContent(f)).length===0)?false:true;}if(h){o=this._getGeneralSelectVariantContent(v,C);}else if(this._getAdapter()&&(v.substring(0,1)==="#")){this._applyUiState(v,C,E);return;}else if(H){o=this._getSpecialSelectVariantContent(v,C,H);}else{o=this._getGeneralSelectVariantContent(v,C);}if(o){if(this.isPageVariant()){this._applyVariants(o,C,E);}else{this._applyVariant(this._oPersoControl,o,C,false,E);}}};e.prototype._getSpecialSelectVariantContent=function(v,C,h){return h.callback.call(h.handler,v,C);};e.prototype._getGeneralSelectVariantContent=function(v,C){var o=this._getVariantContent(v);if(o){o=m({},o);}return o;};e.prototype.currentVariantSetModified=function(f){if(!this._bApplyingUIState){a.prototype.currentVariantSetModified.apply(this,arguments);}};e.prototype._applyControlUiState=function(C,o){if(C&&o){C.loaded.then(function(){if(C.control.setUiStateAsVariant){C.control.setUiStateAsVariant(o);}});}};e.prototype._applyUiState=function(v,C,E){var i,A=this._getAdapter(),o=null,f=this._getAllPersonalizableControls();var s=null;if(A){o=A.getUiState(v);this._bApplyingUIState=true;for(i=0;i<f.length;i++){if(f[i]&&f[i].control&&f[i].loaded){this._applyControlUiState(f[i],o,C);if(f[i].control.search){s=f[i].control;}}}this._bApplyingUIState=false;if(E&&s){s.search();}}};e.prototype._applyControlWrapperVariants=function(C,o,s,E){if(C){C.loaded.then(function(){this._applyControlVariant(C.control,o,s,false,E);}.bind(this));}};e.prototype._applyVariants=function(C,s,E){var i,f=this._getAllPersonalizableControls();for(i=0;i<f.length;i++){if(f[i]&&f[i].control&&f[i].loaded){this._applyControlWrapperVariants(f[i],C,s,E);}}};e.prototype._setStandardVariant=function(C){var o=C.control;if(o){if(o.fireBeforeVariantSave){o.fireBeforeVariantSave(l.STANDARD_VARIANT_NAME);}return this._assignStandardVariantAsync(C);}};e.prototype._retrieveContent=function(C,p){var r=C;if(this.isPageVariant()&&C){r=C[p];if(!r&&(p===this.getPersistencyKey())&&this._aPersonalizableControls&&this._aPersonalizableControls.length===1){r=C;}}return r;};e.prototype._assignContent=function(t,C,p){if(this.isPageVariant()){t[p]=C;}else{t=C;}return t;};e.prototype._updateStandardVariant=function(C,o){if(C.control){var f=o;if(this.isPageVariant()){var p=this._getControlPersKey(C);if(p){f=this._retrieveContent(o,p);}}return this._assignStandardVariantForControl(C,f);}return o;};e.prototype._assignStandardVariantAsync=function(C){var s=null;if(C.control){if(C.control.fetchVariant){s=C.control.fetchVariant();}if(s instanceof Promise){this.setEnabled(false);}return b.resolve(s).then(function(s){return this._assignStandardVariantForControl(C,s);}.bind(this)).catch(function(f){L.error("'_assignStandardVariant' throws an exception: "+f.message);}).unwrap();}return null;};e.prototype._assignStandardVariantForControl=function(C,s){var o=s;if(C){if(this.isPageVariant()){var p=this._getControlPersKey(C.control);if(p){if(!this._oStandardVariant){this._oStandardVariant={};}this._oStandardVariant=this._assignContent(this._oStandardVariant,o,p);}}else{this._oStandardVariant=o;}}return this._oStandardVariant;};e.prototype.getStandardVariant=function(C){var p,o,f=null;if(this._oStandardVariant){if(!C){f=this._oStandardVariant;}else{if(this.isPageVariant()){o=this._getControlWrapper(C);if(o){p=this._getControlPersKey(C);if(p){f=this._retrieveContent(this._oStandardVariant,p);}}}else{if((C===this._oPersoControl)){f=this._oStandardVariant;}}}}return f;};e.prototype._applyVariant=function(C,o,s,i,E){if(C&&C.applyVariant){if(E!=undefined){o.executeOnSelection=E;}C.applyVariant(o,s,i);}};e.prototype._applyVariantByPersistencyKey=function(p,C,s){var o=null;this.getAggregation("personalizableControls",[]).some(function(P){var g=sap.ui.getCore().byId(P.getControl());if(g){var h=P.getKeyName();if(g.getProperty(h)===p){o=g;}return o!=null;}});if(o){var f=this._retrieveContent(C,p);this._applyVariant(o,f,s);}};e.prototype._applyControlVariant=function(C,o,s,i,E){var f,p;p=this._getControlPersKey(C);if(p){f=this._retrieveContent(o,p);if(f){this._applyVariant(C,f,s,i,E);}}};e.prototype.registerSelectionVariantHandler=function(h,k){this._oSelectionVariantHandler[k]=h;};e.prototype.unregisterSelectionVariantHandler=function(h){var E=null;if(!this._oSelectionVariantHandler){return;}if(typeof h==='string'){E=h;}else{Object.keys(this._oSelectionVariantHandler).some(function(k){if(this._oSelectionVariantHandler[k].handler===h){E=k;return true;}return false;}.bind(this));}if(E){delete this._oSelectionVariantHandler[E];}};e.prototype._setErrorValueState=function(t,s){this.setInErrorState(true);if(s){L.error(s);}};e.prototype.exit=function(){a.prototype.exit.apply(this,arguments);this._aFavorites=null;this._aPersonalizableControls=null;this._fRegisteredApplyAutomaticallyOnStandardVariant=null;this._fResolvePersistencyPromise=null;this._fRejectPersistencyPromise=null;this._fResolveMetadataPromise=null;this._oMetadataPromise=null;this._fResolveMetadataPromise=null;this._oControlPromise=null;this._oFlLibrary=null;this._oPersistencyPromise=null;this._oPersoControl=null;this._oAppStdContent=null;this._sAppStandardVariantKey=null;this._oSelectionVariantHandler=null;this._aFavoriteChanges=null;if(this._oAdapter){this._oAdapter.destroy();this._oAdapter=null;}this._mVariants=null;this._mShadowContent=null;};return e;});
