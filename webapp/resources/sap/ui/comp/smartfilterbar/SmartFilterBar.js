/*
 * ! SAPUI5
 * (c) Copyright 2009-2021 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/m/MessageBox","sap/ui/comp/util/DateTimeUtil","sap/ui/comp/filterbar/FilterBar","sap/ui/comp/filterbar/FilterGroupItem","sap/ui/comp/filterbar/FilterItem","sap/ui/comp/library","./AdditionalConfigurationHelper","./ControlConfiguration","./FilterProvider","./GroupConfiguration","sap/ui/comp/util/FormatUtil","sap/ui/comp/smartvariants/PersonalizableInfo","sap/ui/comp/smartvariants/SmartVariantManagement","sap/ui/comp/odata/ODataModelUtil","sap/ui/core/library","sap/ui/comp/variants/VariantItem","sap/ui/model/odata/AnnotationHelper","sap/ui/model/Context","sap/ui/comp/filterbar/VariantConverterFrom","sap/base/Log","sap/base/util/merge",'sap/ui/Device'],function(q,M,D,F,a,b,l,A,C,c,G,d,P,S,O,f,V,g,h,k,L,m,n){"use strict";var o=f.ValueState;var p=l.smartfilterbar.FilterType;var r=F.extend("sap.ui.comp.smartfilterbar.SmartFilterBar",{metadata:{library:"sap.ui.comp",designtime:"sap/ui/comp/designtime/smartfilterbar/SmartFilterBar.designtime",properties:{entityType:{type:"string",group:"Misc",defaultValue:null},entitySet:{type:"string",group:"Misc",defaultValue:null},resourceUri:{type:"string",group:"Misc",defaultValue:null},basicSearchFieldName:{type:"string",group:"Misc",defaultValue:null},enableBasicSearch:{type:"boolean",group:"Misc",defaultValue:false},liveMode:{type:"boolean",group:"Misc",defaultValue:false},showMessages:{type:"boolean",group:"Misc",defaultValue:false},considerAnalyticalParameters:{type:"boolean",group:"Misc",defaultValue:false},useDateRangeType:{type:"boolean",group:"Misc",defaultValue:null},suppressSelection:{type:"boolean",group:"Misc",defaultValue:false},considerSelectionVariants:{type:"boolean",group:"Misc",defaultValue:false},defaultSelectionVariantName:{type:"string",group:"Misc",defaultValue:null},useProvidedNavigationProperties:{type:"boolean",group:"Misc",defaultValue:false},navigationProperties:{type:"string",group:"Misc",defaultValue:""}},associations:{smartVariant:{type:"sap.ui.comp.smartvariants.SmartVariantManagement",multiple:false}},aggregations:{controlConfiguration:{type:"sap.ui.comp.smartfilterbar.ControlConfiguration",multiple:true,singularName:"controlConfiguration"},groupConfiguration:{type:"sap.ui.comp.smartfilterbar.GroupConfiguration",multiple:true,singularName:"groupConfiguration"}},events:{pendingChange:{pendingValue:{type:"boolean"}}}},renderer:{apiVersion:2}});r.LIVE_MODE_INTERVAL=300;r.SELECTION_VARIANT_KEY_PREFIX="#";r.prototype.init=function(){if(!c){c=sap.ui.require("sap/ui/comp/smartfilterbar/FilterProvider");}this._bCreateFilterProviderCalled=false;this._aFilterBarViewMetadata=null;this._oFilterBarViewMetadataExtend=null;this._bSetFilterDataSuspended=false;this._oStoredFilterData={};F.prototype.init.apply(this);sap.ui.getCore().getMessageManager().registerObject(this,true);this.getMetadata().addPublicMethods(["suspendSelection","resumeSelection"]);};r.prototype._initializeMetadata=function(){if(!this.bIsInitialised){O.handleModelInit(this,this._onMetadataInitialised,!this.getIsRunningInValueHelpDialog());}};r.prototype._onMetadataInitialised=function(){var R,e,E,s;this._bMetaModelLoadAttached=false;if(!this.bIsInitialised&&!this._bCreateFilterProviderCalled){e=this.getModel();R=this.getResourceUri();E=this.getEntityType();s=this.getEntitySet();if((e||R)&&(E||s)){this._bCreateFilterProviderCalled=true;this._createFilterProvider(e,R,E,s).then(function(i){if(!i){return;}if(this.bIsDestroyed){i.destroy();return;}this._oFilterProvider=i;this._aFilterBarViewMetadata=i.getFilterBarViewMetadata();this._oFilterBarViewMetadataExtend=i._getFilterBarViewMetadataExtend();if(this._aFilterBarViewMetadata){this._attachAdditionalConfigurationChanged();this.bIsInitialised=true;this.setModel(i.oModel,i.sFilterModelName);this.registerGetFiltersWithValues(this.getFiltersWithValues.bind(this));this.registerFetchData(function(v){return this.getFilterDataAsStringForVariant(true,v);}.bind(this));this.registerApplyData(function(j,v){this.setFilterDataAsStringFromVariant(j,true,v);}.bind(this));this._initializeVariantManagement();}i.attachPendingChange(function(j){this.firePendingChange({pendingValue:j.getParameter("pending")});}.bind(this));}.bind(this));}}};r.prototype._setInitialFocus=function(){var e=this.getAssociation("smartVariant")||this.getConsiderSelectionVariants(),B=this.getBasicSearchControl(),v=this.getAllFilterItems(true),i;if(!e){if(this.getEnableBasicSearch()){this._onAfterRenderingBasicSearchDelegate={onAfterRendering:function(){setTimeout(function(){B.focus();B.removeDelegate(this._onAfterRenderingBasicSearchDelegate);}.bind(this));}.bind(this)};B.addDelegate(this._onAfterRenderingBasicSearchDelegate,this);}else if(v.length>0){i=v[0].getControl();this._onAfterRenderingFirstFilterVisibleFieldDelegate={onAfterRendering:function(){setTimeout(function(){i.focus();i.removeDelegate(this._onAfterRenderingFirstFilterVisibleFieldDelegate);}.bind(this));}.bind(this)};i.addDelegate(this._onAfterRenderingFirstFilterVisibleFieldDelegate,this);}}};r.prototype.getModelData=function(){return this._oFilterProvider?this._oFilterProvider.getModel().getData():null;};r.prototype.getFilterContextUrl=function(){return this._oFilterProvider?this._oFilterProvider.getFilterContextUrl():null;};r.prototype.getParameterContextUrl=function(){return this._oFilterProvider?this._oFilterProvider.getParameterContextUrl():null;};r.prototype.getFilterBarViewMetadata=function(e){var i;if(this._aFilterBarViewMetadata===null){return[];}i=Object.assign({},this._aFilterBarViewMetadata);i=this._aFilterBarViewMetadata.map(function(j){var s=Object.assign({},j);if(e&&this._oFilterBarViewMetadataExtend!==null){s.fields=s.fields.map(function(t){var u,v=t.groupName,w=t.fullName,x=this._oFilterBarViewMetadataExtend[v]&&this._oFilterBarViewMetadataExtend[v][w];if(x!==undefined){u=Object.assign({},t,x);}else{u=Object.assign({},t);}return u;}.bind(this));}return s;}.bind(this));return i;};r.prototype.getAnalyticalParameters=function(){return this._oFilterProvider?this._oFilterProvider.getAnalyticParameters():[];};r.prototype.getSelectionVariants=function(){var s=null;if(this._oFilterProvider){s=this._oFilterProvider.getSelectionVariants();if(Object.keys(s).length<1){s=null;}}return s;};r.prototype._createFilterProvider=function(e,R,E,s){return c._createFilterProvider({basicSearchFieldName:this.getBasicSearchFieldName(),enableBasicSearch:this.getEnableBasicSearch(),entityType:E,entitySet:s,serviceUrl:R,isRunningInValueHelpDialog:this.getIsRunningInValueHelpDialog(),model:e,additionalConfiguration:this.getAdditionalConfiguration(),defaultDropDownDisplayBehaviour:this.data("defaultDropDownDisplayBehaviour"),defaultTokenDisplayBehaviour:this.data("defaultTokenDisplayBehaviour"),dateFormatSettings:this.data("dateFormatSettings"),useContainsAsDefaultFilter:this.data("useContainsAsDefaultFilter"),smartFilter:this,considerAnalyticalParameters:this.getConsiderAnalyticalParameters(),useDateRangeType:this.getUseDateRangeType(),considerSelectionVariants:this.getConsiderSelectionVariants(),considerNavigations:this.getUseProvidedNavigationProperties()?this._createArrayFromString(this.getNavigationProperties()):null,suppressValueListsAssociation:this.getSuppressValueListsAssociation()});};r.prototype._createArrayFromString=function(s){return!s?[]:s.split(",").filter(function(e){return e!==""?e.trim():false;});};r.prototype._attachAdditionalConfigurationChanged=function(){var e,j,i,s;j=this.getGroupConfiguration();s=j.length;for(i=0;i<s;i++){j[i].attachChange(this._handleGroupConfigurationChanged.bind(this));}e=this.getControlConfiguration();s=e.length;for(i=0;i<s;i++){e[i].attachChange(this._handleControlConfigurationChanged.bind(this));}};r.prototype._handleControlConfigurationChanged=function(e){var s,i,j,K,v;s=e.getParameter("propertyName");i=e.oSource;if(!i){return;}K=i.getKey();j=this._getFilterItemByName(K);if(!j){this._handleControlConfigurationChangedForDelayedFilterItems(K,i,s);return;}if(s==="visible"){v=i.getVisible();j.setVisible(v);}else if(s==="label"){v=i.getLabel();j.setLabel(v);}else if(s==="visibleInAdvancedArea"){v=i.getVisibleInAdvancedArea();if(j.setVisibleInAdvancedArea){j.setVisibleInAdvancedArea(v);}}};r.prototype._handleControlConfigurationChangedForDelayedFilterItems=function(K,e,s){var v,i;if(this._aFilterBarViewMetadata){this._aFilterBarViewMetadata.some(function(j){j.fields.some(function(I){if(I.fieldName===K){i=I;}return!!i;});return!!i;});}if(i){if(s==="visible"){v=e.getVisible();i.isVisible=v;}else if(s==="label"){v=e.getLabel();i.label=v;}else if(s==="visibleInAdvancedArea"){v=e.getVisibleInAdvancedArea();i.visibleInAdvancedArea=v;}}};r.prototype._handleGroupConfigurationChanged=function(e){var s,i;s=e.getParameter("propertyName");i=e.oSource;if(s==="label"){this._handleGroupConfigurationLabelChanged(i);}};r.prototype._handleGroupConfigurationLabelChanged=function(e){var i,K,s;if(!e){return;}s=e.getLabel();K=e.getKey();i=this._getFilterGroupItemByGroupName(K);if(i){i.setGroupTitle(s);}else{this._handleGroupConfigurationLabelChangedForDelayedFilterItems(K,s);}};r.prototype._handleGroupConfigurationLabelChangedForDelayedFilterItems=function(K,s){var e=null;if(this._aFilterBarViewMetadata){this._aFilterBarViewMetadata.some(function(i){if(i.groupName===K){e=i;}return!!e;});}if(e){e.groupLabel=s;}};r.prototype._getFilterItemByName=function(N){return this.determineFilterItemByName(N);};r.prototype._getFilterGroupItemByGroupName=function(N){return this.determineFilterItemByName(N);};r.prototype.getAdditionalConfiguration=function(){return new A(this.getControlConfiguration(),this.getGroupConfiguration());};r.prototype.setEntityType=function(e){this.setProperty("entityType",e);this._initializeMetadata();return this;};r.prototype.setEntitySet=function(e){this.setProperty("entitySet",e);this._initializeMetadata();return this;};r.prototype.setResourceUri=function(R){this.setProperty("resourceUri",R);this._initializeMetadata();return this;};r.prototype.propagateProperties=function(){F.prototype.propagateProperties.apply(this,arguments);this._initializeMetadata();};r.prototype._getFilterInformation=function(){var H=this.data("hiddenFields"),e,i,j,s=0,t=0,u,v=[],w;if(this._aFilterBarViewMetadata){s=this._aFilterBarViewMetadata.length;for(i=0;i<s;i++){e=this._aFilterBarViewMetadata[i];u=e.fields;t=u.length;for(j=0;j<t;j++){w=u[j];if(Array.isArray(H)&&H.indexOf(w.name)!==-1){continue;}else if(w.name===c.BASIC_SEARCH_FIELD_ID){this.setBasicSearch(w.control);this._attachToBasicSearch(w.control);continue;}else if(e.groupName===c.BASIC_FILTER_AREA_ID){this._createFieldInAdvancedArea({groupName:F.INTERNAL_GROUP,groupLabel:""},w);}else{this._createFieldInAdvancedArea(e,w);}v.push(w);}}var x=this.getAnalyticalParameters();s=x.length;for(i=0;i<s;i++){w=x[i];this._createAnalyticParameter(w);v.push(w);}}return v;};r.prototype._validateState=function(){var e,i,j,I=false;e=this.getAllFilterItems(true);if(Array.isArray(e)){i=e.length;while(i--){j=this.determineControlByFilterItem(e[i],true);if(j){if(j.__bValidatingToken){this.bIsSearchPending=true;I=true;break;}else if(j.getValueState&&j.getValueState()===o.Error&&!j.data("__mandatoryEmpty")){I=true;break;}}}}if(this._oFilterProvider){return!I&&!this._oFilterProvider._validateConditionTypeFields();}else{return!I;}};r.prototype._isDateRangeTypeFilter=function(s){return!!(this._oFilterProvider&&this._oFilterProvider._mConditionTypeFields[s]);};r.prototype._specialControls=function(e,s){return!!(e.setValue&&(this._isDateRangeTypeFilter(s)||e.isA("sap.m.DatePicker")));};r.prototype._clearErroneusControlValues=function(){var e,i,j,v;e=this.getAllFilterItems(true);if(e){i=e.length;while(i--){j=this.determineControlByFilterItem(e[i],true);if(j){if(j.getValueState&&j.getValueState()===o.Error){v=j.getBinding("value");if(v&&!this._specialControls(j,e[i].getName())){v.checkUpdate(true);}else if(j.setValue){j.setValue("");j.setValueState(o.None);}}}}}};r.prototype._attachToBasicSearch=function(B){if(B){B.attachSearch(function(e){if(e&&e.getParameter("clearButtonPressed")){return;}if(!this.isDialogOpen()){this.search();}}.bind(this));B.attachChange(this._onChange.bind(this));}};r.prototype._onLiveChange=function(e){var i=e.getSource();if(i.data("__validationError")&&!i.getValue()){i.data("__validationError",null);i.setValueState(o.None);delete i.__sValidationText;}};r.prototype._onChange=function(e){var i=e.getSource();if(i.data("__mandatoryEmpty")){i.data("__mandatoryEmpty",null);i.setValueState(o.None);}if(i.data("__validationError")&&!i.getValue()){i.data("__validationError",null);i.setValueState(o.None);}if(i.isA("sap.m.ComboBox")&&i.getValue()){this._filterSetInErrorState(i);if(!i.getSelectedItem()){i.data("__validationError",true);i.setValueState(o.Error);return;}if(i.data("__validationError")){i.data("__validationError",null);i.setValueState(o.None);}}if(this._oFilterProvider._bUpdatingFilterData||this._oFilterProvider._bCreatingInitialModel){return;}if(!i||(i&&!i.__bValidatingToken)){this.fireFilterChange(e);this._oFilterProvider._updateConditionTypeFields(e.getParameter("filterChangeReason"));}else{this._filterSetInErrorState(i);}if(this.isLiveMode()){if(e.getSource().isA("sap.m.MultiComboBox")||e.getSource().isA("sap.m.ComboBox")){this.triggerSearch();}else{this.search();}}};r.prototype._handleChange=function(e){if(e){if(e.attachChange){e.attachChange(this._onChange.bind(this));}if(e.attachLiveChange){e.attachLiveChange(this._onLiveChange.bind(this));}}};r.prototype._handleSelectionChange=function(e){if(e){if(e.attachSelectionChange){e.attachSelectionChange(this._onChange.bind(this));}}};r.prototype._handleEnter=function(i){if(this.isLiveMode()){return;}i.attachBrowserEvent("keydown",function(e){if(e.which===13){i.__bSuggestInProgress=(i._oSuggestionPopup&&i._oSuggestionPopup.isOpen());}});i.attachBrowserEvent("keyup",function(e){if(e.which===13&&!i.__bSuggestInProgress&&(i.isA("sap.m.InputBase")||i.isA("sap.m.Select"))){this.search();}}.bind(this));};r.prototype._createFilterFieldControl=function(e){if(e.conditionType){e.control=e.conditionType.initializeFilterItem();}else if(!e.control&&e.fCreateControl){e.fCreateControl(e);delete e.fCreateControl;}this._handleEnter(e.control);this._handleChange(e.control);if(e.isCustomFilterField&&e.control.isA("sap.m.MultiComboBox")){this._handleSelectionChange(e.control);}};r.prototype._createAnalyticParameter=function(e){e.factory=function(){this._createFilterFieldControl(e);if(!e.control){return;}var i=new a({controlTooltip:e.quickInfo,name:e.fieldName,mandatory:e.isMandatory,visible:e.isVisible,control:e.control,hiddenFilter:false});this._setLabel(i,e.label);this._addParameter(i);}.bind(this);e.groupName=F.INTERNAL_GROUP;return e;};r.prototype._createFieldInAdvancedArea=function(e,i){i.factory=function(){this._createFilterFieldControl(i);var j=new a({controlTooltip:i.quickInfo,name:i.fieldName,groupName:e.groupName,groupTitle:e.groupLabel,entitySetName:i.groupEntitySet,entityTypeName:i.groupEntityType,mandatory:i.isMandatory,visible:i.isVisible,visibleInAdvancedArea:i.visibleInAdvancedArea||(e.groupName===F.INTERNAL_GROUP),control:i.control,hiddenFilter:i.hiddenFilter});if(i.isCustomFilterField){j.data("isCustomField",true);this._attachCustomControlCustomDataChange(j.getControl().getCustomData());}if(i.control&&i.control.getTooltip&&i.control.getTooltip()){j.setControlTooltip(i.control.getTooltip());}if(i.quickInfo){this._setLabelTooltip(j,i.quickInfo);}this._setLabel(j,i.label);this.addFilterGroupItem(j);}.bind(this);i.groupName=e.groupName;i.groupTitle=e.groupLabel;return i;};r.prototype._setLabel=function(e,s){if(s.match(/{@i18n>.+}/gi)){e.bindProperty("label",s.substring(1,s.length-1));}else{e.setLabel(s);}};r.prototype._setLabelTooltip=function(e,Q){var R=/{(@?i18n>.+)}/i.exec(Q);if(R&&R[1]){e.bindProperty("labelTooltip",R[1]);}else{e.setLabelTooltip(Q);}};r.prototype._logAccessWhenNotInitialized=function(s){if(!this.bIsInitialised){L.error("SmartFilterBar."+s+": called before the SmartFilterBar is initialized");}};r.prototype.ensureLoadedValueHelp=function(s){this._logAccessWhenNotInitialized("ensureLoadedValueHelp");if(this._oFilterProvider){this._oFilterProvider.getAssociatedValueHelpProviders().some(function(v){if(v.sFieldName===s){this._ensureLoadedValueHelpList(v);return true;}}.bind(this));}};r.prototype.ensureLoadedValueList=function(s){if(this._oFilterProvider){this._oFilterProvider.getAssociatedValueListProviders().some(function(v){if(v.sFieldName===s){this._ensureLoadedValueHelpList(v);return true;}}.bind(this));}};r.prototype._ensureLoadedValueHelpList=function(B){if(!B._bValueListRequested){B.loadAnnotation();}};r.prototype._getValueListHelpProvider=function(s){var v=null;if(this._oFilterProvider){this._oFilterProvider.getAssociatedValueListProviders().some(function(e){if(e.sFieldName===s){v=e;}return v!=null;});if(!v){this._oFilterProvider.getAssociatedValueHelpProviders().some(function(e){if(e.sFieldName===s){v=e;}return v!=null;});}}return v;};r.prototype.getDescriptionForKeys=function(e){var i=[];if(e){e.forEach(function(I){var B=this._getValueListHelpProvider(I.filterName);if(B){if(!B._bValueListRequested){B.loadAnnotation();}I.provider=B;i.push(I);}}.bind(this));if(i&&i.length>0){i.forEach(function(I){if(I.provider){I.provider.readData(I.keys);}});}}};r.prototype.ensureLoadedValueHelpList=function(s){this.ensureLoadedValueHelp(s);this.ensureLoadedValueList(s);};r.prototype.getFilters=function(e){this._logAccessWhenNotInitialized("getFilters");if(!e||!e.length){if(this.getIsRunningInValueHelpDialog()){e=this._getAllFieldNames();}else{e=this._getVisibleFieldNames(true);}}return this._oFilterProvider?this._oFilterProvider.getFilters(e):[];};r.prototype.getParameters=function(){this._logAccessWhenNotInitialized("getParameters");return this._oFilterProvider?this._oFilterProvider.getParameters():{};};r.prototype.getAnalyticBindingPath=function(){var B="";this._logAccessWhenNotInitialized("getAnalyticBindingPath");if(this._oFilterProvider){B=this._oFilterProvider.getAnalyticBindingPath();}return B;};r.prototype.getParameterBindingPath=function(){return this.getAnalyticBindingPath();};r.prototype.getControlByKey=function(K){this._logAccessWhenNotInitialized("getControlByKey");return this.determineControlByName(K);};r.prototype._getAllFieldNames=function(){var e,j=[],i,s,I;if(this._oFilterProvider&&this._oFilterProvider._oMetadataAnalyser){e=this._oFilterProvider._oMetadataAnalyser.getFieldsByEntitySetName(this.getEntitySet());}if(e){s=e.length;for(i=0;i<s;i++){I=e[i];if(I){j.push(I.name);}}}return j;};r.prototype._getAllFilterAndParameterNames=function(i){var e=[],v=this.getAllFilterItems(false),j=v.length,I;while(j--){I=v[j];if(I){if(i&&I._isParameter()){continue;}e.push(I.getName());}}return e;};r.prototype._getVisibleFieldNames=function(i){var e=[],v=this.getAllFilterItems(true),j=v.length,I;while(j--){I=v[j];if(I){if(i&&I._isParameter()){continue;}e.push(I.getName());}}return e;};r.prototype._checkHasValueData=function(e){if(!e||e==="false"){return false;}if(typeof e==="boolean"){return e;}else if(typeof e==="string"&&e.toLowerCase()==="true"){return true;}return false;};r.prototype._checkForValues=function(e,i,j){var v=null,s;if(e&&i&&j){if(!i.data("isCustomField")){v=e[i.getName()];if(!v&&j.getSelectedItem&&j.getSelectedItem()){s=c._getFieldMetadata(this._aFilterBarViewMetadata,i.getName());if(s&&(s.type==="Edm.Boolean")){if(j.getSelectedItem().getKey()===""){return false;}}return true;}if(!v&&j.getSelectedKey&&j.getSelectedKey()){return true;}if(v&&j.isA("sap.m.ComboBox")&&!j.getItemByKey(v.toString())){return false;}if(v===undefined){return false;}}else{var t=j.data("hasValue");if((t!==undefined)&&(t!=null)){return this._checkHasValueData(t);}else{if(j.getValue){if(j.getValue()){return true;}}if(j.getSelectedItem&&j.getSelectedItem()){return true;}if(j.getSelectedKey&&j.getSelectedKey()){return true;}if(j.getSelectedKeys&&j.getSelectedKeys().length>0){return true;}if(j.getTokens&&j.getTokens().length>0){return true;}}}}return!!v;};r.prototype.getFiltersWithValues=function(){this._logAccessWhenNotInitialized("getFiltersWithValues");return this._getFiltersWithAssignedValues(true);};r.prototype.getAllFiltersWithValues=function(){return this._getFiltersWithAssignedValues(false);};r.prototype._getFiltersWithAssignedValues=function(e){var i=[];var j=this.getAllFilterItems(e),s,t,u=0,v;if(e){s=this.getFilterData();}else if(this._oFilterProvider){s=this._oFilterProvider.getFilledFilterData(this._getAllFilterAndParameterNames());}if(j&&s){u=j.length;while(u--){t=j[u];v=this.determineControlByFilterItem(t,true);if(this._checkForValues(s,t,v)){i.push(t);}}}return i.reverse();};r.prototype._checkIfFilterHasValue=function(s){var e=this._oFilterProvider.getFilterData();var v=e[s]||(e._CUSTOM&&e._CUSTOM[s]);if(v===null||typeof v==="undefined"){return false;}if(typeof v==="string"&&v){return true;}if(typeof v==="number"){return true;}if(typeof v==="object"&&Object.prototype.toString.call(v)==="[object Date]"){return true;}if(typeof v==="object"&&(v.hasOwnProperty("low")||v.hasOwnProperty("high"))){return!!v.low||!!v.high;}if(typeof v==="object"&&(v.hasOwnProperty("value")||v.hasOwnProperty("items")||v.hasOwnProperty("ranges"))){return!!v.value||(v.items&&!!v.items.length)||(v.ranges&&!!v.ranges.length);}return false;};r.prototype._removeEmptyFilters=function(s){var e=JSON.parse(s);var i={};Object.keys(e).forEach(function(j){if((j==="_CUSTOM")||this._checkIfFilterHasValue(j)){i[j]=e[j];}}.bind(this));return JSON.stringify(i);};r.prototype._removeValuesForNonPartOfCurrentVariants=function(e){var i=[];if(this._oFilterProvider&&e&&(e.length>0)){var j=this._oFilterProvider.getFilterData();e.forEach(function(s){var t=s.getName();if(!s.data("isCustomField")){var u=this._oFilterProvider._getFieldMetadata(t);if(u.conditionType){i.push(u);}this._oFilterProvider._createInitialModelForField(j,u,false);}else if(j._CUSTOM&&j._CUSTOM[t]){delete j._CUSTOM[t];}},this);this.setFilterData(j);i.forEach(function(s){var t=s.fieldName;this._oFilterProvider._mConditionTypeFields[t].conditionType.initialize(j[t]);},this);}};r.prototype.getFilterDataAsStringForVariant=function(e,v){var j={},i=this._oFilterProvider._aFilterBarDateTimeFieldNames;if(i.length>0){j=m(j,this.getFilterData(e));i.forEach(function(s){var t,u,w=c._getFieldMetadata(this._aFilterBarViewMetadata,s);if(w&&(w.type==="Edm.DateTimeOffset")){u=j[s];if(u&&u.low){if(w.filterRestriction===p.interval){t=d.parseDateTimeOffsetInterval(u.low);if(t&&(t.length===2)){u.low=w.ui5Type.parseValue(t[0],"string");u.high=w.ui5Type.parseValue(t[1],"string");}}}}}.bind(this));if(v==="V3"){this._oFilterProvider._aFilterBarDateFieldNames.concat(this._oFilterProvider._aFilterBarTimeFieldNames).forEach(function(s){var t,u=c._getFieldMetadata(this._aFilterBarViewMetadata,s);if(!u){u=this.getParameterMetadata(s);}if(u&&(u.filterType==="date")||(u.filterType==="time")){t=j[s];if(t){if((u.filterRestriction===p.multiple)||(u.filterRestriction===p.auto)){this._processDateRanges(t.ranges);}else if(u.filterRestriction===p.single){j[s]=this._dateConvert(t);}else if(u.filterRestriction===p.interval){if(t.ranges){this._processDateRanges(t.ranges);}else{if(t.low){t.low=this._dateConvert(t.low);}if(t.high){t.high=this._dateConvert(t.high);}}}}}}.bind(this));}return JSON.stringify(j);}else{return this.getFilterDataAsString(e);}};r.prototype._dateConvert=function(v){if(this.isInUTCMode()){if(typeof v==="string"){v=new Date(v);}v=D.localToUtc(v).toJSON();}if(v.indexOf('Z')===(v.length-1)){v=v.substr(0,v.length-1);}return v;};r.prototype._processDateRanges=function(R){if(!Array.isArray(R)){return;}R.forEach(function(e){e.tokenText=null;if(e.value1){e.value1=this._dateConvert(e.value1);}if(e.value2){e.value2=this._dateConvert(e.value2);}}.bind(this));};r.prototype.getFilterData=function(e){if(this._bSetFilterDataSuspended){return Object.assign({},this._oStoredFilterData);}var i=this._oFilterProvider;this._logAccessWhenNotInitialized("getFilterData");if(!i){return null;}return e?i.getFilterData():i.getFilledFilterData(this._getVisibleFieldNames());};r.prototype.getFilterDataAsString=function(e){var i=this._oFilterProvider;this._logAccessWhenNotInitialized("getFilterDataAsString");if(!i){return null;}return e?i.getFilterDataAsString():i.getFilledFilterDataAsString(this._getVisibleFieldNames());};r.prototype.getParameterMetadata=function(N){var e=null,i=this.getAnalyticalParameters();if(N.indexOf(l.ANALYTICAL_PARAMETER_PREFIX)===0){N=N.substring(l.ANALYTICAL_PARAMETER_PREFIX.length);}if(Array.isArray(i)){i.some(function(j){if(j.name===N){e=j;}return e!==null;});}return e;};r.prototype.setFilterDataAsStringFromVariant=function(j,R,v){var J,e=this._oFilterProvider._aFilterBarDateTimeFieldNames;if(j){if(e.length>0){J=JSON.parse(j);e.forEach(function(s){var t,u=c._getFieldMetadata(this._aFilterBarViewMetadata,s);if(u&&(u.type==="Edm.DateTimeOffset")){t=J[s];if(t&&(u.filterRestriction===p.multiple||u.filterRestriction===p.auto)){if(t.ranges){for(var i=0;i<t.ranges.length;i++){delete t.ranges[i].tokenText;}}}}}.bind(this));if(v==="V3"){this._oFilterProvider._aFilterBarDateFieldNames.concat(this._oFilterProvider._aFilterBarTimeFieldNames).forEach(function(s){var t,u=c._getFieldMetadata(this._aFilterBarViewMetadata,s);if(!u){u=this.getParameterMetadata(s);}if(u&&(u.filterType==="date")||(u.filterType==="time")){t=J[s];if(t){if(t.ranges){for(var i=0;i<t.ranges.length;i++){delete t.ranges[i].tokenText;}}}}}.bind(this));}this.setFilterData(J,R);}else{this.setFilterDataAsString(j,R);}}};r.prototype.setFilterData=function(j,R){if(this._bSetFilterDataSuspended){if(R){this._oStoredFilterData=j;}else{this._oStoredFilterData=Object.assign({},this._oStoredFilterData,j);}return;}this._setFilterData(j,R);};r.prototype.suspendSetFilterData=function(){this._bSetFilterDataSuspended=true;};r.prototype.resumeSetFilterData=function(){if(this._bSetFilterDataSuspended){this._bSetFilterDataSuspended=false;this.setFilterData(this._oStoredFilterData,true);this._oStoredFilterData={};}};r.prototype._setFilterData=function(j,R){this._logAccessWhenNotInitialized("setFilterData");if(this._oFilterProvider){this._oFilterProvider.setFilterData(j,R);}if(j&&(Object.keys(j).length===1)&&j._CUSTOM){return;}this.fireFilterChange({afterFilterDataUpdate:true});};r.prototype.setFilterDataAsString=function(j,R){if(j){this.setFilterData(JSON.parse(j),R);}};r.prototype.fireClear=function(){this._clearFilterFields();this.fireEvent("clear",arguments);};r.prototype._clearFilterFields=function(){if(this._oFilterProvider){this._oFilterProvider.clear();this._clearErroneusControlValues();}this.fireFilterChange({afterFilterDataUpdate:true});};r.prototype.fireReset=function(){this._resetFilterFields();this.fireEvent("reset",arguments);};r.prototype._resetFilterFields=function(){if(this._oFilterProvider){this._oFilterProvider.reset();this._clearErroneusControlValues();}this.fireFilterChange({afterFilterDataUpdate:true});};r.prototype._suspendedTriggerSearch=function(i){if(this.getSuppressSelection()){return;}this._oSuspendedTriggerSearch={delay:i};return true;};r.prototype._regularTriggerSearch=function(i){if(this.getSuppressSelection()){return;}this._clearDelayedSearch();this._iDelayedSearchId=setTimeout(function(){var e=this._getVisibleControlsLoadingPromises();if(!this._bSearchTriggeredOnce&&e.length){Promise.all(e).then(this._search.bind(this)).catch(this._search.bind(this));}else{this._search();}}.bind(this),i||0);};r.prototype.suspendSelection=function(){this.triggerSearch=this._suspendedTriggerSearch;};r.prototype.resumeSelection=function(){this.triggerSearch=this._regularTriggerSearch;if(this._oSuspendedTriggerSearch){this.triggerSearch(this._oSuspendedTriggerSearch.delay);this._oSuspendedTriggerSearch=undefined;}};r.prototype.triggerSearch=r.prototype._regularTriggerSearch;r.prototype._getVisibleControlsLoadingPromises=function(){var e=[];this.determineMandatoryFilterItems().forEach(function(i){var j=i.getControl();if(j&&j.isA("sap.m.ComboBox")&&j.isBound("items")&&!j.getItems().length){e.push(new Promise(function(s){j.getBinding("items").attachEventOnce("dataReceived",s);}));}});return e;};r.prototype.search=function(s){if(this.getSuppressSelection()){return undefined;}this._logAccessWhenNotInitialized("search");if(s&&!this.isLiveMode()){return this._search();}this.triggerSearch(0);return true;};r.prototype._search=function(){var e=true,i=false,E,I,H;this._bSearchTriggeredOnce=true;I=this.verifySearchAllowed();if(I.hasOwnProperty("pending")){if(this._iDelayedSearchId&&!this.getSuppressSelection()){this.triggerSearch();}return undefined;}else if(I.hasOwnProperty("error")){e=false;i=true;}else if(I.hasOwnProperty("mandatory")){e=false;}if(this.isPending()&&!this._bIsPendingChangeAttached){H=function(j){if(j.getParameter("pendingValue")===false){this.detachPendingChange(H);this._bIsPendingChangeAttached=false;this.triggerSearch();}}.bind(this);this._bIsPendingChangeAttached=true;this.attachPendingChange(H);return undefined;}this._clearDelayedSearch();if(e){if(this._isTablet()&&this.getUseToolbar()&&!this.getAdvancedMode()){this.setFilterBarExpanded(false);}this.fireSearch([{selectionSet:this._retrieveCurrentSelectionSet(false,true)}]);}else{if(!this._oResourceBundle){this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");}if(!i){if(!this._sMandatoryErrorMessage){this._sMandatoryErrorMessage=this._oResourceBundle.getText("EMPTY_MANDATORY_MESSAGE");}E=this._sMandatoryErrorMessage;}else{if(!this._sValidationErrorMessage){this._sValidationErrorMessage=this._oResourceBundle.getText("VALIDATION_ERROR_MESSAGE");}E=this._sValidationErrorMessage;}if(this.getShowMessages()&&!this.getLiveMode()){try{M.error(E,{styleClass:(this.$()&&this.$().closest(".sapUiSizeCompact").length)?"sapUiSizeCompact":"",onClose:this._setFocusOnFirstErroneousField.bind(this)});}catch(x){return undefined;}}else{this._setFocusOnFirstErroneousField();L.warning("search was not triggered. "+E);if(n.system.desktop){this.setFilterBarExpanded(true);}}if(this._bExpandAdvancedFilterArea&&this.rerenderFilters){this.rerenderFilters(true);}}return e;};r.prototype.validateMandatoryFields=function(){this._logAccessWhenNotInitialized("validateMandatoryFields");return this._validateMandatoryFields();};r.prototype.verifySearchAllowed=function(){this._logAccessWhenNotInitialized("verifySearchAllowed");this.bIsSearchPending=false;if(this._validateState()){if(this.validateMandatoryFields()){return{};}return{mandatory:true};}if(this.bIsSearchPending){return{pending:true};}return{error:true};};r.prototype._setFocusOnFirstErroneousField=function(){var e,j,s,i;e=this.getAllFilterItems(true);if(Array.isArray(e)){j=e.length;for(i=0;i<j;i++){s=this.determineControlByFilterItem(e[i],true);if(s&&s.getValueState&&s.getValueState()===o.Error){setTimeout(s["focus"].bind(s),0);break;}}}};r.prototype.setLiveMode=function(e){if(!this._isPhone()){if(e){this.hideGoButton();}else{this.restoreGoButton();}}if(this._oSmartVariantManagement){if(e){if(this._bShowShareState===undefined){this._bShowShareState=this._oSmartVariantManagement.getShowExecuteOnSelection();}this._oSmartVariantManagement.setShowExecuteOnSelection(false);}else if(this._bShowShareState!==undefined){this._oSmartVariantManagement.setShowExecuteOnSelection(this._bShowShareState);}}return this.setProperty("liveMode",e);};r.prototype.isLiveMode=function(){return this._isPhone()?false:this.getLiveMode();};r.prototype._clearDelayedSearch=function(){if(this._iDelayedSearchId){clearTimeout(this._iDelayedSearchId);this._iDelayedSearchId=null;}};r.prototype.isPending=function(){return!this._oFilterProvider?false:this._oFilterProvider.isPending();};r.prototype._validateMandatoryFields=function(){var e=true,i=this.determineMandatoryFilterItems(),j,s=this.getFilterData(),t=0,u;this._bExpandAdvancedFilterArea=false;if(i&&s){t=i.length;while(t--){j=i[t];u=this.determineControlByFilterItem(j,true);if(u&&u.setValueState){if(this._checkForValues(s,j,u)){if(u.data("__mandatoryEmpty")){u.data("__mandatoryEmpty",null);u.setValueState(o.None);}}else{e=false;u.setValueState(o.Error);u.data("__mandatoryEmpty",true);if(j.getGroupName){this._bExpandAdvancedFilterArea=true;}}}}}return e;};r.prototype._setSmartVariant=function(s){var e;if(!s){return;}e=sap.ui.getCore().byId(s);if(e){if(e.isA("sap.ui.comp.smartvariants.SmartVariantManagement")){if(this._oVariantManagement&&!this._oVariantManagement.isPageVariant()){this._replaceVariantManagement(e);this._oSmartVariantManagement=e;}}else{L.error("Control with the id="+s+" not of expected type");}}else{L.error("Control with the id="+s+" not found");}};r.prototype.setSmartVariant=function(s){if(this.getAdvancedMode()){L.error("not supported for the advanced mode");return this;}this.setAssociation("smartVariant",s);this._setSmartVariant(s);return this;};r.prototype.getSmartVariant=function(){if(this.getAdvancedMode()){L.error("not supported for the advanced mode");return null;}var s=this.getAssociation("smartVariant");if(s){return sap.ui.getCore().byId(s);}return this._oSmartVariantManagement;};r.prototype._createVariantManagement=function(){if(this.getAdvancedMode()){return F.prototype._createVariantManagement.apply(this);}this._setSmartVariant(this.getSmartVariant());if(!this._oSmartVariantManagement){this._oSmartVariantManagement=new S(this.getId()+"-variant",{showExecuteOnSelection:true,showShare:true});}return this._oSmartVariantManagement;};r.prototype._initializeVariantManagement=function(){if(!this.getIsRunningInValueHelpDialog()&&this._oSmartVariantManagement&&this.getPersistencyKey()){var e=new P({type:"filterBar",keyName:"persistencyKey",dataSource:this.getEntitySet()||this.getEntityType()});e.setControl(this);if(this.getConsiderSelectionVariants()&&!this._oSmartVariantManagement.isPageVariant()){this._oSmartVariantManagement._createMetadataPromise();this._prepareSelectionVariants();this._oSmartVariantManagement._resolveMetadataPromise();}this._oSmartVariantManagement.addPersonalizableControl(e);if(this._checkHasValueData(this.data("executeStandardVariantOnSelect"))){this._oSmartVariantManagement._executeOnSelectForStandardVariantByXML(true);}F.prototype._initializeVariantManagement.apply(this,arguments);}else{this.fireInitialise();this.fireInitialized();}};r.prototype.fireInitialized=function(){if(this.getConsiderSelectionVariants()&&this._oSmartVariantManagement&&!this._oSmartVariantManagement.isPageVariant()){if(this._oStandardSelectionVariant){this._oSmartVariantManagement._oStandardVariant=m({},this._defaultSelectionVariantHandling(this._oStandardSelectionVariant));}if(!this._oSmartVariantManagement._getDefaultVariantKey()){if(this.getDefaultSelectionVariantName()){var s=r.SELECTION_VARIANT_KEY_PREFIX+this.getDefaultSelectionVariantName();this._oSmartVariantManagement.setInitialSelectionKey(s);this._oSmartVariantManagement.fireSelect({key:s});}else if(this._oStandardSelectionVariant){this._oSmartVariantManagement.fireSelect({key:this._oSmartVariantManagement.STANDARDVARIANTKEY});}}this._oStandardSelectionVariant=null;}F.prototype.fireInitialized.apply(this,arguments);};r.prototype._prepareSelectionVariants=function(){var s,K=r.SELECTION_VARIANT_KEY_PREFIX,v=[],e=this._oSmartVariantManagement;s=this.getSelectionVariants();if(s){var R={callback:this.getSelectionVariant,handler:this};s.forEach(function(i){var j=K+i.qualifier;if(i.qualifier){v.push({id:j,favorite:true,name:i.annotation.Text.String});}else{this._oStandardSelectionVariant=i;}}.bind(this));if(v.length>0){R.variants=v;e.registerSelectionVariantHandler(R,K);}}};r.prototype._defaultSelectionVariantHandling=function(s){var v={},e=this._oSmartVariantManagement,i,j;if(!e||e._sAppStandardVariantKey||!(s&&s.annotation)){return v;}v=this.convertSelectionVariantToInternalVariant(s.annotation);if(!v){return v;}if(!e.isPageVariant()){v.version="V1";j=JSON.parse(v.filterBarVariant);if(e._oStandardVariant){i=JSON.parse(e._oStandardVariant.filterBarVariant);if(i._CUSTOM){j._CUSTOM=i._CUSTOM;v.filterBarVariant=JSON.stringify(j);}}}return v;};r.prototype._adaptFilterVisibilityProperties=function(e){var i,j=[];if(this._oSmartVariantManagement&&this._oSmartVariantManagement._oStandardVariant&&this._oSmartVariantManagement._oStandardVariant.filterbar){m(j,this._oSmartVariantManagement._oStandardVariant.filterbar);}Object.keys(e).forEach(function(E){i=false;j.some(function(s){if(s.name===E){i=true;s.partOfCurrentVariant=true;}return i;});if(!i){j.push({group:this._determineGroupNameByName(E),name:E,partOfCurrentVariant:true,visibleInFilterBar:false,visible:true});}}.bind(this));return j;};r.prototype.getSelectionVariant=function(K){var v=null,s=null,e=K.substring(r.SELECTION_VARIANT_KEY_PREFIX.length);this.getSelectionVariants().some(function(i){if(i.qualifier===e){s=i;return true;}return false;});if(s){if(s.variantContent){v=s.variantContent;}else{v=this.convertSelectionVariantToInternalVariant(s.annotation);s.variantContent=v;}}return v;};r.prototype.convertSelectionVariantToInternalVariant=function(s){var e=JSON.parse(JSON.stringify(s)),v,i,j,t=e.SelectOptions,u=e.Parameters,w;if(t||u){j=new h(null,"/");}if(t){t.forEach(function(x){x.PropertyName=x.PropertyName.PropertyPath;x.Ranges.forEach(function(y){y.Sign=y.Sign.EnumMember.split("/")[1];y.Option=y.Option.EnumMember.split("/")[1];y.Low=y.Low&&g.format(j,y.Low)||null;y.High=y.High&&g.format(j,y.High)||null;});});}if(u){u.forEach(function(x){x.PropertyName=x.PropertyName.PropertyPath.split("/")[1]||x.PropertyName.PropertyPath;x.PropertyValue=g.format(j,x.PropertyValue)||null;});}w=new k();v=w.convert(JSON.stringify(e),this,true);i=JSON.parse(v.payload);v={"version":"V2","filterbar":this._adaptFilterVisibilityProperties(i),"filterBarVariant":JSON.stringify(i)};return v;};r.prototype.getBasicSearchControl=function(){return sap.ui.getCore().byId(this.getBasicSearch());};r.prototype.addFieldToAdvancedArea=function(K){var e;this._logAccessWhenNotInitialized("addFieldToAdvancedArea");e=this._getFilterItemByName(K);if(e&&e.setVisibleInAdvancedArea){e.setVisibleInAdvancedArea(true);}};r.prototype._onCustomFieldCustomDataChange=function(e){var N=e.getParameter("newValue"),v=e.getParameter("oldValue"),s=e.getParameter("name");if(v!==N&&s==="value"){this._updateToolbarText();}};r.prototype._attachCustomControlCustomDataChange=function(e){var j,i;for(i=0;i<e.length;i++){j=e[i];if(j.getKey()==="hasValue"){j.attachEvent("_change",this._onCustomFieldCustomDataChange,this);break;}}};r.prototype.getConditionTypeByKey=function(K){if(this._oFilterProvider._mConditionTypeFields[K]){return this._oFilterProvider._mConditionTypeFields[K].conditionType;}};r.prototype.isInUTCMode=function(){if(this._oFilterProvider&&this._oFilterProvider._oDateFormatSettings){return this._oFilterProvider._oDateFormatSettings.UTC;}return false;};r.prototype.isInitialised=function(){return!!this.bIsInitialised;};r.prototype.associateValueLists=function(){if(this.getSuppressValueListsAssociation()&&this._oFilterProvider){this._oFilterProvider._fireEvent(c.ASSOCIATE_VALUE_LISTS);this._oFilterProvider._bSuppressValueListsAssociation=false;this._fireValueListAnnotationLoaded();if(typeof this._enhanceFilterItemsWithTextOnValueListAssociation==="function"){this._enhanceFilterItemsWithTextOnValueListAssociation();}}};r.prototype._enhanceFilterItemsWithTextValue=function(v,s){if(!this._enhanceFilterItemsWithTextOnValueListAssociation&&this.getSuppressValueListsAssociation()){this._enhanceFilterItemsWithTextOnValueListAssociation=function(){var u=this.getUiState();F.prototype._enhanceFilterItemsWithTextValue.call(this,u.getValueTexts(),u.getSelectionVariant());}.bind(this);}else{F.prototype._enhanceFilterItemsWithTextValue.apply(this,arguments);}};r.prototype._createVisibleFilters=function(){F.prototype._createVisibleFilters.apply(this,arguments);if(!this.getSuppressValueListsAssociation()&&this._oFilterProvider){this._fireValueListAnnotationLoaded();}this._setInitialFocus();};r.prototype._attachValueListAnnotationLoaded=function(e,i,j){this.attachEvent("valueListAnnotationLoaded",e,i,j);};r.prototype._fireValueListAnnotationLoaded=function(e){if(this._oFilterProvider&&Array.isArray(this._oFilterProvider.aFilterAnnotations)){Promise.all(this._oFilterProvider.aFilterAnnotations).then(function(){this.fireEvent("valueListAnnotationLoaded",e);}.bind(this));}};r.prototype.getSuppressValueListsAssociation=function(){return false;};r.prototype.setCustomFilterData=function(j){if(this._oFilterProvider&&this._oFilterProvider.getModel()){this._oFilterProvider.getModel().setProperty("/"+c.CUSTOM_FIELDS_MODEL_PROPERTY,j);}};r.prototype.getCustomFilterData=function(){if(this._oFilterProvider&&this._oFilterProvider.getModel()){return this._oFilterProvider.getModel().getProperty("/"+c.CUSTOM_FIELDS_MODEL_PROPERTY);}};r.prototype.refreshFiltersCount=function(){return Promise.all(this._oFilterProvider._getCurrentValidationPromises()).then(function(){return this._updateToolbarText();}.bind(this));};r.prototype.destroy=function(){this._clearDelayedSearch();if(this._oFilterProvider&&this._oFilterProvider.destroy){this._oFilterProvider.destroy();}this._oFilterProvider=null;if(this._oSmartVariantManagement&&this.getConsiderSelectionVariants()){this._oSmartVariantManagement.unregisterSelectionVariantHandler(this);}F.prototype.destroy.apply(this,arguments);sap.ui.getCore().getMessageManager().unregisterObject(this);this._aFilterBarViewMetadata=null;this._oFilterBarViewMetadataExtend=null;this._bExpandAdvancedFilterArea=null;this._oResourceBundle=null;this._sMandatoryErrorMessage=null;this._sValidationErrorMessage=null;this._oSmartVariantManagement=null;};return r;});
