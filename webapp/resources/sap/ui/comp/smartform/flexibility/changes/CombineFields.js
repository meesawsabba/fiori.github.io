/*!
 * SAPUI5
 * (c) Copyright 2009-2021 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/fl/changeHandler/Base","sap/ui/comp/smartform/flexibility/changes/RenameField"],function(B,R){"use strict";var C={};C._evaluateElementForIndex=function(m,g){var M=-1;return g.reduce(function(p,G){return p.then(m.getAggregation.bind(m,G,"fields")).then(function(s){return Promise.all(s.map(function(S){M++;return m.getProperty(S,"mandatory");}));});},Promise.resolve()).then(function(b){return b?M:-1;});};C._getPreviousLabelPropertyOnControl=function(o,m,p){return Promise.resolve().then(m.getProperty.bind(m,o,p)).then(function(l){if(l&&(typeof l!=="string")){p="text";o=l;}return m.getPropertyBindingOrProperty(o,p);}).then(function(P){return P?P:"$$Handled_Internally$$";});};function c(g,s,m,v,i,S){if(g!==s){var p=m.getParent(g);return S.reduce(function(a,o,k){return a.then(m.removeAggregation.bind(m,g,"elements",o)).then(m.insertAggregation.bind(m,s,"elements",o,i+k,v));},Promise.resolve()).then(m.removeAggregation.bind(m,p,"groupElements",g)).then(m.insertAggregation.bind(m,p,"dependents",g,0,v));}return Promise.resolve();}C.applyChange=function(o,a,p){var b=o.getDefinition();var m=p.modifier;var A=p.appComponent;var v=p.view;var s=m.bySelector(b.content.sourceSelector,A,v);var l=[];var P;var t;var r;var g=b.content.combineFieldSelectors.map(function(d){return m.bySelector(d,A,v);});return this._collectRevertDataForElements(m,g,A).then(function(d){r=d;return this._evaluateElementForIndex(m,g);}.bind(this)).then(function(M){if(M>0){m.setProperty(s,"elementForLabel",M);}var I=sap.ui.getCore().getConfiguration().getRTL();return g.reduce(function(d,G,i){return d.then(function(){var L="fieldLabel"+i.toString();t=b.texts[L];if(t&&t.value!==P&&t.value.length>0){I?l.unshift(t.value):l.push(t.value);P=t.value;}return m.getAggregation(G,"elements");}).then(function(S){return c(G,s,m,v,i,S);});},Promise.resolve());}).then(function(){return R.setLabelPropertyOnControl(s,l.join("/"),m,"label");}).then(function(){o.setRevertData(r);});};C._collectRevertDataForElements=function(m,g,a){var r={elementStates:[]};var f=0;var l=0;return Promise.all(g.map(function(e){var p=m.getParent(e);return Promise.all([m.getAggregation(e,"elements"),m.getAggregation(p,"groupElements"),this._getPreviousLabelPropertyOnControl(e,m,"label"),m.getProperty(e,"elementForLabel")]).then(function(b){l=f+b[0].length-1;r.elementStates.push({groupElementSelector:m.getSelector(m.getId(e),a),parentSelector:m.getSelector(m.getId(p),a),groupElementIndex:b[1].indexOf(e),firstFieldIndex:f,lastFieldIndex:l,label:b[2],elementForLabel:b[3]});f=l+1;});}.bind(this))).then(function(){return r;});};C.revertChange=function(o,s,p){var r=o.getRevertData();var m=p.modifier;var a=p.appComponent;var f=[];return r.elementStates.reduce(function(b,e){var P=p.modifier.bySelector(e.parentSelector,a);var g=p.modifier.bySelector(e.groupElementSelector,a);return b.then(m.getAggregation.bind(m,P,"groupElements")).then(function(A){if(A.indexOf(g)===-1){return Promise.resolve().then(m.removeAggregation.bind(m,P,"dependents",g)).then(m.insertAggregation.bind(m,P,"groupElements",g,e.groupElementIndex));}else{return Promise.resolve().then(m.getAggregation.bind(m,g,"elements")).then(function(d){f=d;return m.removeAllAggregation(g,"elements");});}});},Promise.resolve()).then(function(){return r.elementStates.reduce(function(b,e){var g;var P;return b.then(function(){g=m.bySelector(e.groupElementSelector,a);var I=[];for(var i=e.firstFieldIndex;i<=e.lastFieldIndex;i++){I.push(m.insertAggregation(g,"elements",f[i],f.length));}return Promise.all(I);}).then(function(){P=e.label;if(P==="$$Handled_Internally$$"){P=undefined;return m.getAggregation(g,"fields");}}).then(function(A){if(A&&A.length){var E=A[e.elementForLabel];m.setProperty(E,"textLabel",undefined);}m.setProperty(g,"elementForLabel",e.elementForLabel);return R.setLabelPropertyOnControl(g,P,m,"label");});},Promise.resolve());}).then(o.resetRevertData.bind(o));};C.completeChangeContent=function(o,s,p){var m=p.modifier;var v=p.view;var a=p.appComponent;var b=o.getDefinition();var d=s.combineElementIds;if(d&&d.length>=2){b.content.combineFieldSelectors=d.map(function(e){return m.getSelector(e,a);});o.addDependentControl(d,"combinedFields",p);}else{throw new Error("oSpecificChangeInfo.combineElementIds attribute required");}if(s.sourceControlId){b.content.sourceSelector=m.getSelector(s.sourceControlId,a);o.addDependentControl(s.sourceControlId,"sourceControl",p);}else{throw new Error("oSpecificChangeInfo.sourceControlId attribute required");}var t;var f;var g;for(var i=0;i<b.content.combineFieldSelectors.length;i++){var S=b.content.combineFieldSelectors[i];g=m.bySelector(S,a,v);t=g.getLabelText();if(t){f="fieldLabel"+i;B.setTextInChange(b,f,t,"XFLD");}}};C.getChangeVisualizationInfo=function(o){return{affectedControls:[o.getDefinition().content.sourceSelector]};};return C;},true);
