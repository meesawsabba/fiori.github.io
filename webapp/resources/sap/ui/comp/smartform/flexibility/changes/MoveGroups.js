/*!
 * SAPUI5
 * (c) Copyright 2009-2021 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier"],function(L,J){"use strict";var M={};M._checkCompleteChangeContentConditions=function(s){if(!s.movedElements){throw new Error("oSpecificChangeInfo.movedElements attribute required");}if(s.movedElements.length===0){throw new Error("MovedElements array is empty");}s.movedElements.forEach(function(m){if(!m.id){throw new Error("MovedElements element has no id attribute");}if(typeof(m.targetIndex)!=="number"){throw new Error("Index attribute at MovedElements element is no number");}});};M._buildStableChangeInfo=function(m){var s=m.source.id;var t=m.target.id;var c={changeType:m.changeType,selector:{id:s},targetId:t!==s?t:null};c[m.changeType]=[];m.movedElements.forEach(function(a){c[m.changeType].push({id:a.id,sourceIndex:a.sourceIndex,index:a.targetIndex});});return c;};M.applyChange=function(c,s,p){function a(c,m){if(!c){return Promise.reject(new Error("No change instance"));}var C=c.getContent();return Promise.resolve().then(m.getAggregation.bind(m,s,"groups")).then(function(e){if(!e){L.error("Object has no smartform elements aggregation",m.getId(s));}if(!C||!C.moveGroups||C.moveGroups.length===0){return Promise.reject(new Error("Change format invalid"));}return undefined;});}function g(o,m,A,v){if(!o.selector&&!o.id){return Promise.reject(new Error("Change format invalid - moveGroups element has no id attribute"));}if(typeof(o.index)!=="number"){return Promise.reject(new Error("Change format invalid - moveGroups element index attribute is no number"));}return Promise.resolve(m.bySelector(o.selector||o.id,A,v));}var m=p.modifier;var v=p.view;var A=p.appComponent;var b=[];function d(o,G){if(!G){return Promise.resolve(L.warning("Group to move not found"));}return Promise.resolve().then(m.findIndexInParentAggregation.bind(m,G)).then(function(i){if(i===o.index&&typeof o.sourceIndex==="number"){i=o.sourceIndex;}b.push({selector:m.getSelector(G,A),index:i});}).then(m.removeAggregation.bind(m,s,"groups",G,v)).then(m.insertAggregation.bind(m,s,"groups",G,o.index));}return a(c,m).then(function(){var C=c.getContent();return C.moveGroups.reduce(function(e,o){return e.then(g.bind(null,o,m,A,v)).then(function(G){return d(o,G);});},Promise.resolve());}).then(function(){c.setRevertData({movedGroups:b});});};M.completeChangeContent=function(c,s,p){this._checkCompleteChangeContentConditions(s);s=this._buildStableChangeInfo(s);var C=c.getDefinition();if(!C.content){C.content={};}if(!C.content.moveGroups){C.content.moveGroups=[];}var m=s.moveGroups.map(function(g){var G=sap.ui.getCore().byId(g.id);var S=J.getSelector(G,p.appComponent);C.content.moveGroups.push({selector:S,sourceIndex:g.sourceIndex,index:g.index});return G;});c.addDependentControl(m,"movedGroups",p);};M.revertChange=function(c,s,p){var a=p.appComponent;var v=p.view;var m=p.modifier;var b=c.getRevertData().movedGroups;return b.reduce(function(d,o){var g=m.bySelector(o.selector,a,v);return d.then(m.removeAggregation.bind(m,s,"groups",g,v)).then(m.insertAggregation.bind(m,s,"groups",g,o.index));},Promise.resolve()).then(function(){c.resetRevertData();});};M.getChangeVisualizationInfo=function(c){var C=c.getContent();return{affectedControls:[C.moveGroups[0].selector],dependentControls:[(C.moveGroups[0].selector.source||c.getSelector())]};};return M;},true);
