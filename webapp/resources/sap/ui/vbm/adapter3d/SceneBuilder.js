/*!
 * SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(["sap/ui/base/Object","./Utilities","./PolygonHandler","./ModelHandler","./thirdparty/three","./thirdparty/DecalGeometry","./thirdparty/html2canvas","sap/base/Log"],function(B,U,P,M,T,D,h,L){"use strict";var t="sap.ui.vbm.adapter3d.SceneBuilder";var a=T.Matrix4;var V=T.Vector3;var d=T.Math.degToRad;var b=U.toArray;var c=U.toBoolean;var e=U.toVector3;var f=U.createMaterial;var p=U.propertyChanged;var g=U.propertyRemoved;var i=U.propertyAdded;var u=U.updateProperty;var r=U.refCountableDispose;var j;var k;var S=B.extend("sap.ui.vbm.adapter3d.SceneBuilder",{constructor:function(l,v){B.call(this);this._context=l;this._viewport=v;this._root=v.getRoot();this._scene=v.getScene();this._hotInstance=null;this._decalHelper=null;this._targets=new Map();this._textures=new Map();this._box4=null;this._box6=null;this._cylinder=null;this._cylinderCaps=null;this._polygonHandler=new P(this._root);this._modelHandler=new M(this._context.resources,this._textures,this._scene,this._root);this._textureLoader=null;}});S.prototype.destroy=function(){this._root=null;this._scene=null;this._viewport=null;this._context=null;if(this._box4){this._box.dispose();}if(this._box6){this._box6.dispose();}if(this._cylinder){this._cylinder.dispose();}if(this._cylinderCaps){this._cylinderCaps.dispose();}if(this._decalHelper){this._decalHelper.material.dispose();this._decalHelper.geometry.dispose();this._scene.remove(this._decalHelper);}this._polygonHandler.destroy();this._modelHandler.destroy();this._textures.forEach(function(l){l.dispose();});B.prototype.destroy.call(this);};S.prototype.synchronize=function(){var l=this;function m(n){var o=l._textures.get(n);if(!o){l._textures.set(n,null);}}return new Promise(function(n,o){var w=sap.ui.vbm.findInArray(l._context.windows,function(w){return w.type==="default";});var s=w&&sap.ui.vbm.findInArray(l._context.scenes,function(s){return s.id===w.refScene;});if(!s){n();return;}l._context.scene=s;if(l._context.setupView){var q=l._context.setupView;l._setupView(q.position,q.zoom,q.pitch,q.yaw,q.home,q.flyTo);l._context.setupView=undefined;}var v=[];var x=[],y=[];var z=l._context.voQueues.toAdd.get(s)||[];var A=l._context.voQueues.toUpdate.get(s)||[];var C=l._context.voQueues.toRemove.get(s)||[];[].concat(z,A).forEach(function(E){if(E.isModel){l._modelHandler.addModel(E);}if(E.texture&&p(E,"texture")){m(E.texture);}if(E.textureCap&&p(E,"textureCap")){m(E.textureCap);}if(E.isDecal&&E.text&&p(E,["text","size"])){v.push(E);}});l._loadTextures().then(function(){return l._modelHandler.loadModels();}).then(function(){return l._renderTexts(v);}).then(function(){C.forEach(l._removeInstance.bind(l));A.forEach(l._updateInstance.bind(l,y));z.forEach(l._addInstance.bind(l,x));l._polygonHandler.update();l._modelHandler.update();l._scene.updateMatrixWorld(true);y.forEach(l._updateInstance.bind(l,null));x.forEach(l._addInstance.bind(l,null));l._cleanupCache();n();}).catch(function(E){o(E);});});};S.prototype._findMesh=function(n){var m=null;n.traverse(function(o){if(!m&&o.isMesh){m=o;}});return m;};S.prototype._getGeometrySize=function(){return 2.0;};S.prototype._getZoomFactor=function(l,m){var n=new V();n.subVectors(m,l);return(this._getGeometrySize()*2)/n.length();};S.prototype._setupView=function(l,z,m,y,n,o){l=e(l||"0;0;0");z=parseFloat(z||"1");if(z===0){z=1;}else if(z<0){z=0.1;}var q=this._getGeometrySize()*2/z;m=parseFloat(m||"0");y=parseFloat(y||"0");m=(m%180===0?m+1:m);var s=new a();s.makeRotationX(d(m+180));var v=new a();v.makeRotationZ(d(-(y+180)));var w=new a();w.multiplyMatrices(v,s);var x=new V(0,0,-5);var A=new V(0,0,0);var C=new V();C.subVectors(A,x).normalize();C.multiplyScalar(q);C.applyMatrix4(w);C.add(l);A.add(l);var E={zoom:1.0,target:new V(-A.x,-A.z,A.y),position:new V(-C.x,-C.z,C.y)};if(n){this._viewport._setCameraHome(E);this._viewport._applyCamera(E,o);}else{this._viewport._applyCamera(E,o);}};S.prototype._getDecalTextKey=function(l){return l.size+";"+l.text;};S.prototype._renderTexts=function(l){var m=[];l.forEach(function(n){if(!this._textures.has(this._getDecalTextKey(n))){m.push(this._renderText(n));}},this);return Promise.all(m);};S.prototype._renderText=function(l){var m=this;return new Promise(function(n,o){var s=e(l.size);if(s.length()<1E-6){L.error("Unable render text to html: decal size is invalid","",t);n();}else{var q=512;var v=s.x/s.y;var w=Math.ceil(v>=1?q:q*v);var x=Math.ceil(v<=1?q:q/v);var y=document.createElement("iframe");y.style.visibility="hidden";y.width=w;y.height=x;document.body.appendChild(y);var z=y.contentDocument||y.contentWindow.document;z.open();z.close();z.body.innerHTML=l.text;var A=document.createElement("canvas");A.width=y.width*window.devicePixelRatio;A.height=y.height*window.devicePixelRatio;A.style.width=y.width+"px";A.style.height=y.height+"px";var C=A.getContext("2d");C.scale(window.devicePixelRatio,window.devicePixelRatio);h(z.body,{canvas:A,width:w,height:x,backgroundColor:null,logging:false}).then(function(E){if(E.width>0&&E.height>0){var F=new T.Texture(E);F.needsUpdate=true;U.addRef(F);m._textures.set(m._getDecalTextKey(l),F);}else{L.error("Failed render text to html","",t);}document.body.removeChild(y);n();});}});};S.prototype._loadTextures=function(){var l=[];this._textures.forEach(function(m,n){if(!m){l.push(this._loadTexture(n));}},this);return Promise.all(l);};S.prototype._loadTexture=function(l){var m=this;var n=this._context.resources.get(l);if(!n){this._textures.delete(l);L.error("Failed to get texture from context",l,t);return Promise.resolve();}return new Promise(function(o,q){m._getTextureLoader().load(U.makeDataUri(n),function(s){s.flipY=false;m._textures.set(l,s);o();},null,function(x){m._textures.delete(l);L.error("Failed to load texture from Data URI: "+l,"status: "+x.status+", status text: "+x.statusText,t);o();});});};S.prototype._cleanupCache=function(){this._textures.forEach(function(l){if(r(l)){l.dispose();this._textures.delete(l);}},this);if(this._box4&&r(this._box4)){this._box4.dispose();this._box4=null;}if(this._box6&&r(this._box6)){this._box6.dispose();this._box6=null;}if(this._cylinder&&r(this._cylinder)){this._cylinder.dispose();this._cylinder=null;}if(this._cylinderCaps&&r(this._cylinderCaps)){this._cylinderCaps.dispose();this._cylinderCaps=null;}};S.prototype._addInstance=function(l,m){if(!m.isDecal){this._updateInstanceKeys(m);}if(m.isPolygon){this._polygonHandler.addInstance(m);}else if(m.isModel){this._modelHandler.addInstance(m);}else if(m.isBox||m.isCylinder){m.object3D=new T.Group();m.object3D.matrixAutoUpdate=false;this._root.add(m.object3D);if(m.isBox){this._assignBoxProperties(m);}else{this._assignCylinderProperties(m);}}else if(m.isDecal){if(l){l.push(m);}else{this._assignDecalProperties(m);}}else{L.error("Unable to add instance: instance type is unknown","",t);}};S.prototype._updateInstance=function(l,m){if(!m.isDecal){this._updateInstanceKeys(m);}if(m.isPolygon){this._polygonHandler.updateInstance(m);}else if(m.isModel){this._modelHandler.updateInstance(m);}else if(m.isBox){this._assignBoxProperties(m,m===this._hotInstance);}else if(m.isCylinder){this._assignCylinderProperties(m,m===this._hotInstance);}else if(m.isDecal){if(l){l.push(m);}else{this._assignDecalProperties(m);}}else{L.error("Unable to update instance: instance type is unknown","",t);}};S.prototype._removeInstance=function(l){if(!l.isDecal){this._removeInstanceKeys(l);}if(l.isPolygon){this._polygonHandler.removeInstance(l);}else if(l.isModel){this._modelHandler.removeInstance(l);}else if(l.isBox||l.isCylinder||l.isDecal){if(l.object3D){this._deleteObject3D(l.object3D);l.object3D=null;l._last={};}else{L.error("Unable to remove instance: object3D is missing","",t);}}else{L.error("Unable to remove instance: instance type is unknown","",t);}if(this._hotInstance===l){this._hotInstance=null;}};S.prototype.updateSelection=function(s,l){s.concat(l).forEach(function(m){if(m.isPolygon){this._polygonHandler.updateInstance(m);}else if(m.isModel){this._modelHandler.updateInstance(m);}else if(m.isBox){this._assignBoxProperties(m,m===this._hotInstance);}else if(m.isCylinder){this._assignCylinderProperties(m,m===this._hotInstance);}},this);this._polygonHandler.update();this._modelHandler.update();};S.prototype._updateHotStatus=function(l,m){if(l.isBox){this._assignBoxProperties(l,m);}else if(l.isCylinder){this._assignCylinderProperties(l,m);}};S.prototype.updateHotInstance=function(l){this._polygonHandler.updateHotInstance(l);this._modelHandler.updateHotInstance(l);this._polygonHandler.update();this._modelHandler.update();if(this._hotInstance){this._updateHotStatus(this._hotInstance,false);}if(l){this._updateHotStatus(l,true);}this._hotInstance=l;};S.prototype._assignBoxProperties=function(l,m){var n=l.object3D.children.length===0?null:l.object3D.children[0];if(!n||p(l,"texture6")){var o=this._getBoxGeometry(c(l.texture6));U.addRef(o);if(n){U.subRef(n.geometry);n.geometry=o;}else{n=new T.Mesh(o,f(false));n.matrixAutoUpdate=false;n.layers.set(0);n._sapInstance=l;l.object3D.add(n);}}u(l,"texture6");this._assignProperties(l,m);};S.prototype._assignCylinderProperties=function(l,m){var n,o=false,q=c(l.isOpen),s=l.object3D.children.length===0?null:l.object3D.children[0];if(!s||p(l,"isOpen")){var v=this._getCylinderGeometry(q);U.addRef(v);if(s){U.subRef(s.geometry);s.geometry=v;if(q){n=s.material[1];if(n.map){U.subRef(n.map);n.dispose();}s.material=s.material[0];s.material.side=T.DoubleSide;s.material.needsUpdate=true;}else{n=s.material.clone();n.map=null;s.material=[s.material,n,n];s.material.forEach(function(w){w.needsUpdate=true;w.side=T.FrontSide;});o=true;}}else{if(q){s=new T.Mesh(v,f(true));}else{n=f(false);s=new T.Mesh(v,[f(false),n,n]);}s.matrixAutoUpdate=false;s.layers.set(0);s._sapInstance=l;l.object3D.add(s);}}if(p(l,"textureCap")||o){n=Array.isArray(s.material)?s.material[1]:null;if(n){if(n.map){U.subRef(n.map);n.map=null;n.needsUpdate=true;}if(l.textureCap){n.map=this._textures.get(l.textureCap);if(n.map){n.needsUpdate=true;U.addRef(n.map);}else{L.error("Unable to apply cap texture on cylinder, texture not found",l.textureCap,t);}}}}u(l,["isOpen","testureCap"]);this._assignProperties(l,m);};S.prototype._assignProperties=function(l,m){var n,o,q=l.object3D.children[0];if(p(l,"texture")){o=Array.isArray(q.material)?q.material[0]:q.material;if(o.map){U.subRef(o.map);o.map=null;o.needsUpdate=true;}if(l.texture){o.map=this._textures.get(l.texture);if(o.map){o.needsUpdate=true;U.addRef(o.map);}else{L.error("Unable to apply texture, texture not found",l.texture,t);}}}if(p(l,["color","selectColor","VB:s"])||m!==undefined){n=U.getColor(l,l.color,m);U.toArray(q.material).forEach(function(w){w.color.copy(n.rgb);w.opacity=n.opacity;w.transparent=w.opacity<1;w.needsUpdate=true;});}var s=q.children.length===0?null:q.children[0];if(g(l,"colorBorder")){s.material.dispose();s.geometry.dispose();q.remove(s);}else if(l.colorBorder){if(i(l,"colorBorder")){var v=l.isBox?new T.EdgesGeometry(q.geometry):new T.EdgesGeometry(q.geometry,60);s=new T.LineSegments(v,U.createLineMaterial());s.matrixAutoUpdate=false;s.layers.set(1);q.add(s);}if(p(l,["colorBorder","selectColor,","VB:s"])||m!==undefined){o=s.material;n=U.getColor(l,l.colorBorder,m);o.color.copy(n.rgb);o.opacity=n.opacity;o.transparent=o.opacity<1;o.needsUpdate=true;}}if(p(l,"normalize")){if(c(l.normalize)){U.normalizeObject3D(q);q.updateMatrix();}else{q.position.set(0,0,0);q.rotation.set(0,0,0);q.scale.set(1,1,1);}}if(p(l,["pos","rot","scale"])){U.getInstanceTransform(l,l.object3D.position,l.object3D.rotation,l.object3D.scale);l.object3D.updateMatrix();}u(l,["texture","color","selectColor","VB:s","colorBorder","normalize","pos","rot","scale"]);};S.prototype._assignDecalProperties=function(l){var m=false,n;if(p(l,["position","direction","size","rotation","target"])){m=true;}if(!l.target&&p(l,["planeOrigin","planeNormal"])){m=true;}if(m){if(l.object3D){n=l.object3D.material.clone();this._deleteObject3D(l.object3D);l.object3D=null;}var o=this._getDecalTarget(l);if(!o){L.error("Unable to create decal","target is missing",t);return;}var q=this._createDecal(l,o,n);this._disposeDecalTarget(l,o);if(!q){return;}}if(p(l,["texture","text"])){n=l.object3D.material;if(n.map){U.subRef(n.map);n.map=null;}n.map=this._textures.get(l.text?this._getDecalTextKey(l):l.texture);if(n.map){n.map.flipY=true;n.needsUpdate=true;U.addRef(n.map);}else{L.error("Unable to apply texture, texture not found",l.texture,t);}}u(l,["position","direction","size","rotation","target","texture","text","planeOrigin","planeNormal"]);};S.prototype._createDecal=function(l,m,n){this._root.updateMatrixWorld(true);var o=e(l.position);var q=e(l.direction).normalize();if(q.length()<1E-6){L.error("Unable create decal: direction is invalid","",t);return false;}var s=d(U.toFloat(l.rotation));var v=e(l.size);if(v.length()<1E-6){L.error("Unable create decal: size is invalid","",t);return false;}o.applyMatrix4(m.matrixWorld);q.transformDirection(m.matrixWorld);var w=new T.Raycaster(o,q);var x=w.intersectObject(m);if(!x.length){L.error("Unable create decal: cannot project decal to plane","",t);return false;}if(!this._decalHelper){this._decalHelper=new T.Mesh(new T.BoxBufferGeometry(1,1,5));this._decalHelper.visible=false;this._decalHelper.layers.set(1);this._decalHelper.up.set(0,1,0);this._scene.add(this._decalHelper);}var y=x[0];var z=y.point;var A=q.clone().negate();var C=new T.Box3().setFromObject(m);var E=C.max.clone().sub(C.min).length();A.multiplyScalar(E);A.add(z);this._decalHelper.position.copy(z);this._decalHelper.lookAt(A);this._decalHelper.rotation.z+=s;n=n||new T.MeshPhongMaterial({specular:0x444444,shininess:0,transparent:true,depthTest:true,depthWrite:false,polygonOffset:true,polygonOffsetUnits:0.1,polygonOffsetFactor:-1});var F=new T.DecalGeometry(m,z,this._decalHelper.rotation,v);l.object3D=new T.Mesh(F,n);l.object3D.matrixAutoUpdate=false;l.object3D.layers.set(1);this._scene.add(l.object3D);return true;};S.prototype._createPlane=function(l,m){var o=e(l.planeOrigin);var n=e(l.planeNormal).normalize();if(n.length()<1E-6){L.error("Unable to create plane for decal: normal is invalid","",t);return null;}var q=new V(n.x===0?10:-n.x,n.y===0?-10:n.y,n.z===0?10:-n.z);var s=o.clone(o).add(q);s.sub(n.clone().multiplyScalar(n.dot(s.clone().sub(o))));var v=10000;q=s.clone().sub(o).normalize();var w=n.clone().cross(q).normalize();q.multiplyScalar(v);w.multiplyScalar(v);var x=o.clone().add(q);var y=o.clone().sub(q);var z=o.clone().add(w);var A=o.clone().sub(w);var C=new T.BufferGeometry();C.setAttribute("position",new T.Float32BufferAttribute([x.x,x.y,x.z,z.x,z.y,z.z,y.x,y.y,y.z,y.x,y.y,y.z,A.x,A.y,A.z,x.x,x.y,x.z],3));C.setAttribute("normal",new T.Float32BufferAttribute([n.x,n.y,n.z,n.x,n.y,n.z,n.x,n.y,n.z,n.x,n.y,n.z,n.x,n.y,n.z,n.x,n.y,n.z],3));var E=new T.Mesh(C);m.add(E);return E;};S.prototype._getDecalTarget=function(l){if(l.target){var m=this._targets.get(l.target);if(m){if(m.isBox||m.isCylinder){return m.object3D.children[0];}else if(m.isPolygon){return this._polygonHandler.getTarget(m);}else if(m.isModel){return this._modelHandler.getTarget(m);}else{L.error("Unable to get decal's target","target instance type is unknown",t);return null;}}}else if(l.planeOrigin&&l.planeNormal){return this._createPlane(l,this._root);}else{L.error("Unable to get/create decal's target","missing parameters",t);return null;}};S.prototype._disposeDecalTarget=function(l,m){if(l.target){var n=this._targets.get(l.target);if(n){if(n.isPolygon||n.isModel){this._deleteObject3D(m);}}else{L.error("Unable to dispose decal's target","target not found",t);}}else{this._deleteObject3D(m);}};S.prototype._updateInstanceKeys=function(l){var v=this._getInstanceKeys(l);if(v){this._targets.set(v.key,l);this._targets.set(v.group,l);}};S.prototype._removeInstanceKeys=function(l){var v=this._getInstanceKeys(l);if(v){this._targets.delete(v.key);this._targets.delete(v.group);}};S.prototype._getInstanceKeys=function(l){if(l.dataInstance){var m=l.voGroup.keyAttributeName;if(m){var v=l.dataInstance[m];if(v){return{key:v,group:l.voGroup.id+"."+v};}}}return null;};S.prototype._deleteObject3D=function(o){o.traverse(function(n){if(n.geometry){if(U.refCountable(n.geometry)){U.subRef(n.geometry);}else{n.geometry.dispose();}}b(n.material).forEach(function(m){if(m.map){U.subRef(m.map);}m.dispose();});});o.parent.remove(o);};S.prototype._getBoxGeometry=function(s){if(s){return this._box6||(this._box6=j(s));}else{return this._box4||(this._box4=j(s));}};S.prototype._getCylinderGeometry=function(o){if(o){return this._cylinder||(this._cylinder=k(o));}else{return this._cylinderCaps||(this._cylinderCaps=k(o));}};S.prototype._getTextureLoader=function(){return this._textureLoader||(this._textureLoader=new T.TextureLoader());};j=function(s){var l=new T.BufferGeometry();l.setAttribute("position",new T.Float32BufferAttribute([0.1,0.1,-0.1,-0.1,-0.1,-0.1,-0.1,0.1,-0.1,0.1,0.1,-0.1,0.1,-0.1,-0.1,-0.1,-0.1,-0.1,0.1,0.1,0.1,-0.1,0.1,0.1,-0.1,-0.1,0.1,0.1,0.1,0.1,-0.1,-0.1,0.1,0.1,-0.1,0.1,0.1,0.1,-0.1,0.1,-0.1,0.1,0.1,-0.1,-0.1,0.1,0.1,-0.1,0.1,0.1,0.1,0.1,-0.1,0.1,0.1,-0.1,-0.1,-0.1,-0.1,0.1,-0.1,-0.1,-0.1,0.1,-0.1,-0.1,0.1,-0.1,0.1,-0.1,-0.1,0.1,-0.1,-0.1,-0.1,-0.1,0.1,0.1,-0.1,0.1,-0.1,-0.1,-0.1,-0.1,-0.1,-0.1,0.1,-0.1,0.1,0.1,0.1,0.1,0.1,-0.1,0.1,-0.1,-0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,-0.1,-0.1,0.1,-0.1],3));l.setAttribute("normal",new T.Float32BufferAttribute([0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0],3));l.setAttribute("color",new T.Float32BufferAttribute([0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5],3));if(s){l.setAttribute("uv",new T.Float32BufferAttribute([2/3,0.5,1.0,1.0,2/3,1.0,2/3,0.5,1.0,0.5,1.0,1.0,2/3,0.0,1.0,0.0,1.0,0.5,2/3,0.0,1.0,0.5,2/3,0.5,2/3,0.5,1/3,1.0,1/3,0.5,2/3,0.5,2/3,1.0,1/3,1.0,2/3,0.0,1/3,0.5,1/3,0.0,2/3,0.0,2/3,0.5,1/3,0.5,1/3,0.5,0.0,1.0,0.0,0.5,1/3,0.5,1/3,1.0,0.0,1.0,0.0,0.5,1/3,0.0,1/3,0.5,0.0,0.5,0.0,0.0,1/3,0.0],2));}else{l.setAttribute("uv",new T.Float32BufferAttribute([0.5,0.5,1.0,1.0,0.5,1.0,0.5,0.5,1.0,0.5,1.0,1.0,1.0,0.5,1.0,1.0,0.5,1.0,1.0,0.5,0.5,1.0,0.5,0.5,0.5,0.5,0.0,1.0,0.0,0.5,0.5,0.5,0.5,1.0,0.0,1.0,0.5,0.5,1.0,0.0,1.0,0.5,0.5,0.5,0.5,0.0,1.0,0.0,0.5,0.5,0.0,1.0,0.0,0.5,0.5,0.5,0.5,1.0,0.0,1.0,0.0,0.5,0.5,0.0,0.5,0.5,0.0,0.5,0.0,0.0,0.5,0.0],2));}return l;};k=function(o){var l=0.1;return new T.CylinderGeometry(l,l,2*l,24,1,o);};return S;});
