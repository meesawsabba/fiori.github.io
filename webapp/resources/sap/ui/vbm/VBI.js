/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(["sap/ui/core/Control","sap/ui/core/RenderManager","jquery.sap.global","sap/base/Log","./library","./VBIRenderer","./lib/sapvbi","./lib/saputilities","./lib/sapvbicontext","./lib/sapdataprovider","./lib/sapresources","./lib/sapgeomath","./lib/sapmaplayer","./lib/sapmapprovider","./lib/sapmapmanager","./lib/sapvoutils","./lib/sapvobase","./lib/sapevents","./lib/saplabels","./lib/sappositioning","./lib/sapscene","./lib/sapwindow","./lib/sapactions","./lib/sapautomations","./lib/sapgeolocation","./lib/sapgeotool","./lib/sapscale","./lib/sapnavigation","./lib/sapvbmenu","./lib/sapprojection","./lib/sapvbcluster","./lib/sapparsing","./lib/sapconfig","./lib/saplassotrack","./lib/saprecttrack","./lib/sapheatmap"],function(C,R,q,L,l,V){"use strict";var t="sap.ui.vbm.VBI";VBI.Utilities.GetTransparentImage();var a=C.extend("sap.ui.vbm.VBI",{metadata:{library:"sap.ui.vbm",properties:{width:{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:'800px'},height:{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:'600px'},config:{type:"object",group:"Misc",defaultValue:null},plugin:{type:"boolean",group:"Misc",defaultValue:false},rectangularSelection:{type:"boolean",group:"Misc",defaultValue:false},lassoSelection:{type:"boolean",group:"Misc",defaultValue:false},rectZoom:{type:"boolean",group:"Misc",defaultValue:false},allowKeyEventRepeat:{type:"boolean",group:"Behavior",defaultValue:true},keyEventDelay:{type:"int",group:"Behavior",defaultValue:250},enableOverlappingTest:{type:"boolean",group:"Behavior",defaultValue:true},ariaLabel:{type:"string",group:"Misc"}},associations:{ariaDescribedBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaDescribedBy"},ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"}},events:{submit:{parameters:{data:{type:"string"}}},thumbnailClick:{parameters:{pos:{type:"string"},zoomLevel:{type:"int"}}},render:{parameters:{canvas:{type:"object"}}},changeTrackingMode:{parameters:{mode:{type:"int"},bSet:{type:"boolean"}}},zoom:{parameters:{canvas:{type:"object"}}},move:{parameters:{canvas:{type:"object"}}},openWindow:{parameters:{contentarea:{type:"object"},id:{type:"string"}}},closeWindow:{parameters:{contentarea:{type:"object"},id:{type:"string"}}},containerCreated:{parameters:{contentarea:{type:"object"},id:{type:"string"}}},containerDestroyed:{parameters:{contentarea:{type:"object"},id:{type:"string"}}}}}});a.RttMap={};a.prototype.exit=function(){if(this.getPlugin()){var p=this.getPlugInControl();if(p){p.OnSubmit=null;}}else if(this.mVBIContext){this.mVBIContext.clear();}if(this.resizeID!=""){sap.ui.core.ResizeHandler.deregister(this.resizeID);this.resizeID="";}};a.prototype.resize=function(e){var c=(this.oControl!=undefined)?this.oControl:this;var b=c.mVBIContext;if(b){var s=b.GetMainScene();if(s){s.resizeCanvas(e);}if(b.m_Windows){b.m_Windows.NotifyResize();}}};a.prototype.init=function(){this.m_aLoadQueue=null;if(!this.getPlugin()){this.mVBIContext=new VBI.VBIContext(this);}this.resizeID="";this.m_renderList=[];};a.prototype.loadNative=function(d){var b=this.getId();var c=document.getElementById('VBI'+b);if(!c){return;}var s=function(g){try{var D;if((D=JSON.parse(g))){var v=D.SAPVB;var f=JSON.stringify(v,null,'  ');this.fireSubmit({data:f});}}catch(e){if(VBI.m_bTrace){VBI.Trace("Error submitting plugin event");}}};if(q.type(d)=='object'){var f=JSON.stringify(d,null,'  ');try{c.Load(f);c.OnSubmit=s.bind(this);}catch(e){L.error("Error loading vbiJSON from object","",t);}}else if(q.type(d)=='string'){try{c.Load(d);c.OnSubmit=s.bind(this);}catch(e){L.error("Error loading vbiJSON from string","",t);}}};a.prototype.loadHtml=function(d){var b=this.getId();var c=null;if(typeof d==='string'){c=JSON.parse(d.indexOf('{')?d.substr(d.indexOf('{')):d);}else if(typeof d==='object'){c=d;}if(!c){return;}if(!c["SAPVB"]){var m;if(this.mVBIContext&&(m=(new VBI.Adaptor(this.mVBIContext)).CreateLoadData(c))){this.loadHtml(m);return;}else{return;}}var M=false;var e=false;var f=false;var g=false;var h=false;var j=false;if(q.type(c)==='object'){if(c.SAPVB){if(c.SAPVB.Config){this.mVBIContext.GetConfig().load(c.SAPVB.Config,this.mVBIContext);}if(c.SAPVB.Resources){this.mVBIContext.GetResources().load(c.SAPVB.Resources,this.mVBIContext);g=true;}if(c.SAPVB.DataTypes){if(!this.mVBIContext.m_DataTypeProvider){this.mVBIContext.m_DataTypeProvider=new VBI.DataTypeProvider();}this.mVBIContext.m_DataTypeProvider.load(c.SAPVB.DataTypes,this.mVBIContext);}if(c.SAPVB.Data){if(!this.mVBIContext.m_DataProvider){this.mVBIContext.m_DataProvider=new VBI.DataProvider();}this.mVBIContext.m_DataProvider.load(c.SAPVB.Data,this.mVBIContext);M=true;}if(c.SAPVB.MapProviders){if(!this.mVBIContext.m_MapProviders){this.mVBIContext.m_MapProviders=new VBI.MapProviders();}this.mVBIContext.m_MapProviders.load(c.SAPVB.MapProviders,this.mVBIContext);j=true;}if(c.SAPVB.MapLayerStacks){if(!this.mVBIContext.m_MapLayerStackManager){this.mVBIContext.m_MapLayerStackManager=new VBI.MapLayerStackManager(this.mVBIContext);}this.mVBIContext.m_MapLayerStackManager.load(c.SAPVB.MapLayerStacks,this.mVBIContext);j=true;}if(c.SAPVB.Windows){if(!this.mVBIContext.m_Windows){this.mVBIContext.m_Windows=new VBI.Windows();}this.mVBIContext.m_Windows.load(c.SAPVB.Windows,this.mVBIContext);f=true;}if(c.SAPVB.Actions){if(!this.mVBIContext.m_Actions){this.mVBIContext.m_Actions=new VBI.Actions();}this.mVBIContext.m_Actions.load(c.SAPVB.Actions,this.mVBIContext);}if(c.SAPVB.Automation){if(!this.mVBIContext.m_Automations){this.mVBIContext.m_Automations=new VBI.Automations();}this.mVBIContext.m_Automations.load(c.SAPVB.Automation,this.mVBIContext);}if(c.SAPVB.Menus){if(!this.mVBIContext.m_Menus){this.mVBIContext.m_Menus=new VBI.Menus();}this.mVBIContext.m_Menus.load(c.SAPVB.Menus,this.mVBIContext);}if(c.SAPVB.Clustering){if(!this.mVBIContext.m_Clustering){this.mVBIContext.m_Clustering=new VBI.Clustering();}this.mVBIContext.m_Clustering.load(c.SAPVB.Clustering,this.mVBIContext);h=true;}if(c.SAPVB.Scenes){if(!this.mVBIContext.m_SceneManager){this.mVBIContext.m_SceneManager=new VBI.SceneManager();}this.mVBIContext.m_SceneManager.load(c.SAPVB.Scenes,this.mVBIContext);e=true;}else if(j){var s=this.mVBIContext.m_SceneManager.m_SceneArray;for(var i=0;i<s.length;++i){if(s[i].RefreshMapLayerStack){s[i].RefreshMapLayerStack();}}}}if(M){if(this.mVBIContext.m_Windows){this.mVBIContext.m_Windows.NotifyDataChange();}}if(e||f){if(this.mVBIContext.m_Windows){this.mVBIContext.m_Windows.Awake(b);}}if(e||M||h||g){if(this.mVBIContext.m_Windows){this.mVBIContext.m_Windows.RenderAsync();}}}};a.prototype.load=function(d){if(!d){return;}if(!this.isRendered()){if(!this.m_aLoadQueue){this.m_aLoadQueue=[];}if(d.SAPVB&&d.SAPVB.Scenes&&d.SAPVB.Scenes.Merge&&d.SAPVB.Scenes.Merge.SceneGeo){var p=d.SAPVB.Scenes.Merge.SceneGeo.initialStartPosition;var z=d.SAPVB.Scenes.Merge.SceneGeo.initialZoom;if(p||z){var b=this.m_aLoadQueue;for(var i=0;i<b.length;++i){if(b[i].SAPVB&&b[i].SAPVB.Scenes&&b[i].SAPVB.Scenes.Set&&b[i].SAPVB.Scenes.Set.SceneGeo){var e=b[i].SAPVB.Scenes.Set.SceneGeo;e.initialStartPosition=p||e.initialStartPosition;e.initialZoom=z||e.initialZoom;break;}}}}this.m_aLoadQueue.push(d);return;}if(this.getPlugin()){this.loadNative(d);}else{this.loadHtml(d);}if(this.resizeID==""&&this.mVBIContext.GetMainScene()){this.resize();this.resizeID=sap.ui.core.ResizeHandler.register(this,this.resize);}};
/**
	 * Returns a Screenshot of the Overlay. Please note that the map cannot be included due to browser restrictions. Function returns the visible part
	 * of the Canvas excluding map, copyright info, navigation control, scaler, legend, detail windows, container elements. Analytic Maps are returned
	 * as they are not treated as "maps" internally. Modes 2 & 3 are experimental, trying to load the map (this may work on inhouse servers with
	 * adapted settings, standard configurations should fail)
	 *
	 * @param {int} [iMode] 0: Overlay only; 1 (default) and 3: include Labels; 2 and 3: try to include maps (will return "" if not possible)
	 * @returns {string} Base64 encoded picture (PNG format) on success, "" otherwise
	 * @public
	 * @ui5-metamodel This method also will be described in the UI5 (legacy) designtime metamodel
	 */
a.prototype.getPicOfOverlay=function(m){var s=this.mVBIContext.GetMainScene();if(!(s&&s.GetOverlayPicture)){return"";}return s.GetOverlayPicture(m);};a.prototype.minimize=function(n,N,f,F,b,c,d,e){var v=this.mVBIContext;if(!v.moThumbnail){v.moThumbnail={bThumbnailed:false};}var g=v.moThumbnail;g.nThumbWidth=n;g.nThumbHeight=N;g.strFont=b;g.strCol=c;g.nFontPos=d;g.strText=e;if(f){g.nFullWidth=f;}if(F){g.nFullHeight=F;}var s=v.GetMainScene();if(s){v.DoMinimize(s);}};a.prototype.maximize=function(f,F){var s=this.mVBIContext.GetMainScene();if(s&&this.mVBIContext.moThumbnail){var n,b;if(f){n=String(f)+"px";}else{n=this.mVBIContext.moThumbnail.strOrgWidth?this.mVBIContext.moThumbnail.strOrgWidth:this.getWidth();}if(F){b=String(F)+"px";}else{b=this.mVBIContext.moThumbnail.strOrgHeight?this.mVBIContext.moThumbnail.strOrgHeight:this.getHeight();}this.mVBIContext.m_bThumbnail=false;this.setWidth(n);this.setHeight(b);s.m_Ctx.moThumbnail=undefined;s.resizeCanvas(0);}};a.prototype.zoomToGeoPosition=function(f,b,i){var s=null;if((s=this.mVBIContext.GetMainScene())){if(q.type(f)=='array'&&q.type(b)=='array'){if(f.length>1&&b.length>1){s.ZoomToMultiplePositions(f,b);}else{s.ZoomToGeoPosition(VBI.MathLib.DegToRad([parseFloat(f[0]),parseFloat(b[0])]),parseFloat(i));}}else{s.ZoomToGeoPosition(VBI.MathLib.DegToRad([parseFloat(f),parseFloat(b)]),parseFloat(i));}}};a.prototype.zoomToAreas=function(A,c){var s=null;if((s=this.mVBIContext.GetMainScene())){s.ZoomToAreas(A,c);}};a.prototype.getInfoForCluster=function(i,T){var s=null;if((s=this.mVBIContext.GetMainScene())){return s.getInfoForCluster(i,T);}return null;};a.prototype.setRectangularSelection=function(s){var b=this.mVBIContext.GetMainScene();if(b){if(!(s&&b.m_nInputMode==window.VBI.InputModeRectSelect)){b.endTrackingMode();if(s){this.setProperty("lassoSelection",false,true);this.setProperty("rectZoom",false,true);new b.RectSelection();b.m_Ctx.onChangeTrackingMode(VBI.InputModeRectSelect,true);}}}this.setProperty("rectangularSelection",s,true);return this;};a.prototype.setLassoSelection=function(s){var b=this.mVBIContext.GetMainScene();if(b){if(!(s&&b.m_nInputMode==window.VBI.InputModeLassoSelect)){b.endTrackingMode();if(s){this.setProperty("rectangularSelection",false,true);this.setProperty("rectZoom",false,true);new b.LassoSelection();b.m_Ctx.onChangeTrackingMode(VBI.InputModeLassoSelect,true);}}}this.setProperty("lassoSelection",s,true);return this;};a.prototype.setRectZoom=function(s){var b=this.mVBIContext.GetMainScene();if(b){if(!(s&&b.m_nInputMode==window.VBI.InputModeRectZoom)){b.endTrackingMode();if(s){this.setProperty("lassoSelection",false,true);this.setProperty("rectangularSelection",false,true);new b.RectangularZoom();b.m_Ctx.onChangeTrackingMode(VBI.InputModeRectZoom,true);}}}this.setProperty("rectZoom",s,true);return this;};a.prototype.onAfterRendering=function(){if(this.$oldContent.length>0){this.$().append(this.$oldContent);}if(this.m_aLoadQueue){var n;for(n=0;n<this.m_aLoadQueue.length;++n){this.load(this.m_aLoadQueue[n]);}this.m_aLoadQueue=null;}if(this.resizeID==""&&this.mVBIContext.GetMainScene()){this.resize();this.resizeID=sap.ui.core.ResizeHandler.register(this,this.resize);}var b=this.getId();if(this.mVBIContext.m_Windows){this.mVBIContext.m_Windows.Awake(b);}var e=q(this.getDomRef()).children(".vbi-hidden").children();for(var i=0,E;i<e.length;++i){E=e[i];var d=document.getElementById(E.attributes.getNamedItem("data").nodeValue);if(d){if(E.firstChild){d.appendChild(E.firstChild);}E.parentNode.removeChild(E);}}};a.prototype.onBeforeRendering=function(){var d=this.getDomRef();if(d&&!R.isPreservedContent(d)){R.preserveContent(d,true,false);}this.$oldContent=R.findPreservedContent(this.getId());};a.prototype.isRendered=function(){return this.getDomRef()?true:false;};a.prototype.getPlugInControl=function(){var b=this.getId();var e=document.getElementById('VBI'+b);return e?e:null;};a.prototype.setConfig=function(c){if(c){return this.load(c);}};a.prototype.setWidth=function(v){if(typeof v==='number'){this.setProperty("width",parseInt(v,10).toString()+"px");}else{this.setProperty("width",v);}};a.prototype.setHeight=function(v){if(typeof v==='number'){this.setProperty("height",parseInt(v,10).toString()+"px");}else{this.setProperty("height",v);}};a.prototype.addRenderItem=function(c,b){this.m_renderList.push({control:c,data:b});this.invalidate();};return a;});
