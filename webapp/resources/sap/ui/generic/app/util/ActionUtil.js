/*
 * ! SAPUI5

(c) Copyright 2009-2020 SAP SE. All rights reserved
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/base/ManagedObject","sap/m/MessageBox","sap/ui/comp/smartform/SmartForm","sap/ui/comp/smartform/Group","sap/ui/comp/smartform/GroupElement","sap/ui/comp/smartfield/SmartField","sap/ui/comp/smartfield/SmartLabel","sap/m/Dialog","sap/ui/generic/app/util/ModelUtil","sap/m/VBox","sap/m/Text","sap/base/strings/formatMessage","sap/base/Log"],function(q,M,a,S,G,b,c,d,D,e,V,T,f,L){"use strict";var A=M.extend("sap.ui.generic.app.util.ActionUtil",{metadata:{properties:{controller:{type:"object",group:"Misc",defaultValue:null},applicationController:{type:"object",group:"Misc",defaultValue:null},contexts:{type:"object",group:"Misc",defaultValue:null},successCallback:{type:"function",group:"Misc",defaultValue:null},operationGrouping:{type:"string",group:"Misc",defaultValue:null}}}});A.prototype.call=function(F,s,i,o,I,m){var t=this;return new Promise(function(r,g){var h;t._oActionPromiseCallback={resolve:r,reject:g};t._sFunctionImportPath=F;var C=t.getController();if(!C||!C.getView()){g("No View Controller provided");}t._oMetaModel=C.getView().getModel().getMetaModel();var j=F.split('/')[1];t._oFunctionImport=t._oMetaModel.getODataFunctionImport(j);t._sFunctionImportLabel=s||j;t._oSkipProperties=o||{};var p=function(){var n=t.getContexts();h=t._prepareParameters(n,i,m);h=h||[{}];var u=t.getApplicationController().getTransactionController().getDefaultValues(n[0],h[0].parameterData,undefined,j);if(u instanceof Promise){var v=function(w){h[0].parameterData=w;t._initiateCall(h,i,I);};u.then(v,v);}else{t._initiateCall(h,i,I);}};if(!t._oFunctionImport){g("Unknown Function Import "+j);}if(t._isActionCritical()){var k="ACTION_CONFIRM|"+j;var l;var R=C.getOwnerComponent().getAppComponent&&C.getOwnerComponent().getAppComponent().getModel("i18n")&&C.getOwnerComponent().getAppComponent().getModel("i18n").getResourceBundle();if(R&&R.hasText(k)){l=R.getText(k);}else{l=sap.ui.getCore().getLibraryResourceBundle("sap.ui.generic.app").getText("ACTION_CONFIRM");l=f(l,t._sFunctionImportLabel);}a.confirm(l,{title:t._sFunctionImportLabel,onClose:function(n){if(n==="OK"){p();}else if(n==="CANCEL"){t._oActionPromiseCallback.reject();}},sClass:t._getCompactModeStyleClass()});}else{p();}});};A.prototype._getCompactModeStyleClass=function(){if(this.getController().getView().$().closest(".sapUiSizeCompact").length){return"sapUiSizeCompact";}return"";};A.prototype._isActionCritical=function(){var C=this._oFunctionImport["com.sap.vocabularies.Common.v1.IsActionCritical"];if(!C){return false;}if(C.Bool===undefined){return true;}return this._toBoolean(C.Bool);};A.prototype._toBoolean=function(p){if(typeof p==="string"){var v=p.toLowerCase();return!(v=="false"||v==""||v==" ");}return!!p;};A.prototype._prepareParameters=function(C,I,m){if(!Array.isArray(C)&&!C.length){return undefined;}var g=[];C.forEach(function(s){var E=null;var o=s.getObject();if(s&&s.getPath()){var h=e.getEntitySetFromContext(s);var j=s.getModel().getMetaModel().getODataEntitySet(h,false);E=s.getModel().getMetaModel().getODataEntityType(j.entityType,false);}var k=this._getPropertyKeys(E);var p;var l={parameterData:{},additionalParameters:[],isDraftEnabled:I};if(this._oFunctionImport.parameter){for(var i=0;i<this._oFunctionImport.parameter.length;i++){var P=this._oFunctionImport.parameter[i];this._addParameterLabel(P,E);var n=P.name;var r=!!k[n];p=undefined;if(o&&o.hasOwnProperty(n)){p=o[n];}else if(r&&o){L.error("Key parameter of action not found in current context: "+n);throw new Error("Key parameter of action not found in current context: "+n);}l.parameterData[n]=(m&&m[n])||p;var t=!!this._oSkipProperties[n];if(!t&&!r&&P.mode.toUpperCase()=="IN"){l.additionalParameters.push(P);}}g.push(l);}else{g.push(l);}}.bind(this));return g;};A.prototype._getPropertyKeys=function(E){var k={};if(E&&E.key&&E.key.propertyRef){for(var i=0;i<E.key.propertyRef.length;i++){var K=E.key.propertyRef[i].name;k[K]=true;}}return k;};A.prototype._setAdditionalParameters=function(g,k,p,h){g.filter(function(o){if(k===o.name){if(o.hasOwnProperty("com.sap.vocabularies.UI.v1.Hidden")){h.oModel.setProperty(k,p[k],h);}else{h.oModel.setProperty(k,undefined,h);}}});};A.prototype._initiateCall=function(m,I,g){var h=m[0];var H=g?"strict":"lenient";var j={Prefer:"handling="+H};if(h!=undefined&&h.additionalParameters&&h.additionalParameters.length==0){this._call(h.parameterData,h.isDraftEnabled,j);}else if(h!=undefined&&h.additionalParameters&&h.additionalParameters.length>0){var t=this;var p={urlParameters:{},headers:j};var E=this.getContexts();var C=this.getApplicationController()._getChangeSetFunc(E,this.getOperationGrouping());var F=E.map(function(o,i){p.changeSetId=C(i);return this.getApplicationController().getNewActionContext(this._sFunctionImportPath,o,p);}.bind(this));var k=F.map(function(o){return o.context;});Promise.all(k).then(function(o){var l=o[0];var _=h.additionalParameters.map(function(x){return x.name;});o.forEach(function(x,i){var y=m[i].parameterData;for(var K in y){if(o.length>1&&_.indexOf(K)>-1){t._setAdditionalParameters(m[i].additionalParameters,K,y,x);}else{x.oModel.setProperty(K,y[K],x);}}});if(g){var P=t._buildParametersForm(h,l);var n=false;var r=new D({title:t._sFunctionImportLabel,content:[P.form],beginButton:new sap.m.Button({text:t._sFunctionImportLabel,type:'Emphasized',press:function(x){if(P.hasNoClientErrors()){if(P.getEmptyMandatoryFields().length==0){r.close();n=t._triggerActionPromise(F,E,h,o,g);}else{var y=new V();var R=sap.ui.getCore().getLibraryResourceBundle("sap.ui.generic.app").getText("ACTION_MISSING_MANDATORY");for(var i=0;i<P.getEmptyMandatoryFields().length;i++){var z=f(R,P.getEmptyMandatoryFields()[i].getTextLabel());y.addItem(new T({text:z}));}a.error(y,{sClass:t._getCompactModeStyleClass()});}}}}),endButton:new sap.m.Button({text:sap.ui.getCore().getLibraryResourceBundle("sap.ui.generic.app").getText("ACTION_CANCEL"),press:function(){F[0].abort();r.close();t._oActionPromiseCallback.reject();n=true;}}),afterClose:function(x){r.destroy();if(!n){t._oActionPromiseCallback.reject();}}}).addStyleClass("sapUiNoContentPadding");r.addStyleClass(t._getCompactModeStyleClass());r.setModel(l.oModel);if(this.getController().getView().getModel("@i18n")){r.setModel(this.getController().getView().getModel("@i18n"),"@i18n");}var s=r.getAggregation("content")[0].mAggregations["content"];var u=s.getFormContainers()[0].getFormElements();var v=true;for(var i=0;i<u.length;i++){var w=u[i].getFields()[0];if((w instanceof c)&&w.getVisible()===true){v=false;break;}}if(u.length===0||v){t._triggerActionPromise(F,E,h,o,g);r.destroy();}else{r.open();}}else{t._triggerActionPromise(F,E,h,o);}}.bind(this));}else{this._call(null,h!=undefined?h.isDraftEnabled:I,j);}};A.prototype._triggerActionPromise=function(F,E,m,o,I){var t=this;var u={};t._oActionPromiseCallback.resolve({executionPromise:t.getApplicationController()._newPromiseAll(F.map(function(g){return g.result;})).then(function(r){t._bExecutedSuccessfully=t.getApplicationController()._checkAtLeastOneSuccess(E,r);if(I){r.forEach(function(R){R.userEnteredAdditionalParams=u;});}if(t._bExecutedSuccessfully){return r;}else{return Promise.reject(r);}},function(g){t._bExecutedSuccessfully=false;g.forEach(function(h){h.userEnteredAdditionalParams=u;});throw g;})});var _=o[0].getObject();m.additionalParameters.forEach(function(p){var g=_[p.name];if(p.type=="Edm.Boolean"&&g==undefined){_[p.name]=false;g=false;}u[p.name]=g;o.forEach(function(h){h.oModel.setProperty(p.name,g,h);});});var s=t._sFunctionImportPath.split('/')[1];E.forEach(function(g,i){t.getApplicationController().submitActionContext(g,o[i],s);});if(I){return true;}};A.prototype._call=function(u,i,h){var C=this.getContexts();var p={urlParameters:u,operationGrouping:this.getOperationGrouping(),triggerChanges:i,headers:h};var o=this.getController();var g=this.getApplicationController()||o.getApplicationController();var t=this;t._oActionPromiseCallback.resolve({executionPromise:g.invokeActions(this._sFunctionImportPath,C,p).then(function(r){t._bExecutedSuccessfully=true;return r;},function(E){t._bExecutedSuccessfully=false;throw E;})});};A.prototype._getActionParameterData=function(p){var m=[];var r=p.getObject('/');var P={};for(var i=0;i<this._oFunctionImport.parameter.length;i++){var o=this._oFunctionImport.parameter[i];var s=o.name;if(r.hasOwnProperty(s)){var v=r[s];if(v===undefined){if(!this._toBoolean(o.nullable)){if(o.type==='Edm.Boolean'){P[s]=false;}else{m.push(o);}}}else{P[s]=v;}}else{throw new Error("Unknown parameter: "+s);}}return{preparedParameterData:P,missingMandatoryParameters:m};};A.prototype._buildParametersForm=function(p,C){var s=new S({editable:true});s.setBindingContext(C);var o;var F=[];var g;var v;var h=new G();for(var i=0;i<p.additionalParameters.length;i++){var P=p.additionalParameters[i];if(P["com.sap.vocabularies.UI.v1.Hidden"]&&!P["com.sap.vocabularies.UI.v1.Hidden"].Path&&!(P["com.sap.vocabularies.UI.v1.Hidden"].Bool==="false")){continue;}v=P["com.sap.vocabularies.Common.v1.ValueListWithFixedValues"]?"fixed-values":undefined;if(v==undefined){v=P["sap:value-list"]=="fixed-values"?"fixed-values":undefined;}o=new c("ActionUtil-"+this._sFunctionImportPath.replace("/","-")+"-"+P.name,{value:'{'+P.name+'}',textLabel:this._getParameterName(P),width:"100%"});o.data("configdata",{"configdata":{isInnerControl:false,path:P.name,entitySetObject:{},annotations:{valuelist:P["com.sap.vocabularies.Common.v1.ValueList"],valuelistType:v},modelObject:C.oModel,entityType:P.type,property:{property:P,typePath:P.name}}});if(P.nullable=="false"){o.setMandatory(true);}F.push(o);g=new d();g.setLabelFor(o);var j=new b();j.addElement(o);h.addGroupElement(j);}s.addGroup(h);var H=function(){var n=true;for(var i=0;i<F.length;i++){if(F[i].getValueState()!="None"){n=false;break;}}return n;};var k=function(){var m=q.grep(F,function(l){return(l.getMandatory()==true&&l.getValue()==""&&l.getDataType()!="Edm.Boolean");});return m;};return{form:s,hasNoClientErrors:H,getEmptyMandatoryFields:k};};A.prototype._getParameterName=function(p){return p["com.sap.vocabularies.Common.v1.Label"]?p["com.sap.vocabularies.Common.v1.Label"].String:p.name;};A.prototype._addParameterLabel=function(p,E){if(E&&p&&!p["com.sap.vocabularies.Common.v1.Label"]){var P=this._oMetaModel.getODataProperty(E,p.name,false);if(P&&P["com.sap.vocabularies.Common.v1.Label"]){p["com.sap.vocabularies.Common.v1.Label"]=P["com.sap.vocabularies.Common.v1.Label"];}}};A.prototype.getFunctionImportLabel=function(){return this._sFunctionImportLabel;};A.prototype.getExecutedSuccessfully=function(){return this._bExecutedSuccessfully;};return A;});
