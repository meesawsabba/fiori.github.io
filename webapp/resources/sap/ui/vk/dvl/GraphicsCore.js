/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/base/EventProvider","../thirdparty/html2canvas","../ve/dvl","./Scene","../ContentResource","../DownloadManager","./ViewStateManager","../DvlException","../Messages","sap/ui/thirdparty/URI","./GraphicsCoreApi","./checkResult","./getPointer","./getJSONObject","../getResourceBundle","../utf8ArrayBufferToString","sap/base/assert","sap/base/util/uid","sap/base/Log","sap/ui/core/Core"],function(E,H,D,S,C,a,V,b,M,U,G,c,d,f,h,u,j,k,L,l){"use strict";function n(e){return e instanceof File?"local":"remote";}function o(e){return e instanceof File?e.name:e;}var p=function(e){Object.defineProperties(this,{source:{value:e,writable:false,enumerable:true},_refCount:{value:0,writable:true,enumerable:false}});};p.prototype.isInUse=function(){return this._refCount>0;};p.prototype.addRef=function(){++this._refCount;return this;};p.prototype.release=function(){--this._refCount;j(this._refCount>=0,"Too many calls to SourceDatum.release().");return this;};p.prototype.destroy=function(){};var q=function(e,g,i){p.call(this,e);Object.defineProperties(this,{content:{value:i,writable:false,enumerable:true},vdsSourceDatum:{value:g,writable:false,enumerable:true}});};q.prototype=Object.create(p.prototype);q.prototype.constructor=q;q.prototype.destroy=function(){j(this.vdsSourceDatum,"VDSL source without VDS reference");if(this.vdsSourceDatum){this.vdsSourceDatum.release();}p.prototype.destroy.call(this);};var r=function(e,g,i){Object.defineProperties(this,{dvlSceneId:{value:e,writable:false,enumerable:true},sourceDatum:{value:g,writable:false,enumerable:true},root:{value:!!i,writable:false,enumerable:true},_refCount:{value:0,writable:true,enumerable:false}});};r.prototype.isInUse=function(){return this._refCount>0;};r.prototype.addRef=function(){++this._refCount;return this;};r.prototype.release=function(){--this._refCount;j(this._refCount>=0,"Too many calls to DvlSceneDatum.release().");return this;};r.prototype.destroy=function(){if(this.sourceDatum){this.sourceDatum.release();}};var s=function(e,g){Object.defineProperties(this,{source:{value:e.getSource()},sourceType:{value:e.getSourceType()},sourceId:{value:e.getSourceId(),writable:true},name:{value:e.getName()},localMatrix:{value:e.getLocalMatrix(),writable:true},password:{value:e.getPassword()},children:{value:e.getContentResources().map(function(e){return new s(e);})},dvlSceneDatum:{value:null,writable:true},nodeProxy:{value:null,writable:true},fake:{value:!!g},sourceProperties:{value:null,writable:true}});e._shadowContentResource=this;};s.prototype.destroy=function(){if(this.dvlSceneDatum){this.dvlSceneDatum.release();}};var t=function(e,g){Object.defineProperties(this,{vkScene:{value:e},shadowContentResource:{value:g}});};var v=E.extend("sap.ui.vk.dvl.GraphicsCore",{metadata:{publicMethods:["attachSceneLoadingFinished","attachSceneLoadingProgress","attachSceneLoadingStarted","buildSceneTree","buildSceneTreeAsync","createViewStateManager","destroyScene","destroyViewStateManager","detachSceneLoadingFinished","detachSceneLoadingProgress","detachSceneLoadingStarted","getApi","loadContentResourcesAsync","showDebugInfo","updateSceneTree","updateSceneTreeAsync"]},constructor:function(e,g){E.apply(this);var i=jQuery.extend({},e,{filePackagePrefixURL:sap.ui.require.toUrl("sap/ui/vk/ve")+"/"});this._dvlClientId=k();var m=this;this._initialized=new Promise(function(A){m._initResolve=A;});sap.ve.dvl.createRuntime(i).then(function(A){m._dvl=A;m._dvl.CreateCoreInstance(m._dvlClientId);c(m._dvl.Core.Init(m._DVLMajorVersion,m._DVLMinorVersion));var B=l;B.attachLocalizationChanged(m._onlocalizationChanged,m);c(m._dvl.Core.SetLocale(B.getConfiguration().getLanguageTag()));m._canvas=m._createRenderingCanvasAndContext(g);m._rendererId=d(m._dvl.Core.CreateRenderer());m._dvl.Renderer.SetOptionF(sap.ve.dvl.DVLRENDEROPTIONF.DVLRENDEROPTIONF_DPI,96*window.devicePixelRatio,m._rendererId);m._initResolve();});this._sourceData=[];this._dvlSceneData=[];this._vkSceneData=[];this._viewports=[];this._renderLoopRequestId=null;this._renderLoopFunction=this._renderLoop.bind(this);this._viewStateManagers=[];this._authorizationHandler=null;this._retryCount=1;},_DVLMajorVersion:7,_DVLMinorVersion:4});v.create=function(e,i){return new Promise(function(m,A){try{var g=new v(e,i);g._initialized.then(function(){m(g);});}catch(B){A(B);}});};v.prototype.destroy=function(){l.detachLocalizationChanged(this._onlocalizationChanged,this);var e=this._viewports.slice();e.reverse();e.forEach(function(g){g.control.setGraphicsCore(null);});this._viewports=null;this._cleanupVkSceneData();this._vkSceneData=null;this._cleanupDvlSceneData();j(this._dvlSceneData.length===0,"Not all DVL scenes are destroyed when sap.ui.vk.dvl.Scene objects are destroyed.");this._dvlSceneData=null;this._cleanupSourceData();j(this._sourceData.length===0,"Not all sources are deleted.");this._sourceData=null;this._viewStateManagers.slice().forEach(this.destroyViewStateManager.bind(this));this._viewStateManagers=null;this._webGLContext=null;this._canvas=null;this._dvl.Core.DeleteRenderer(this._rendererId);this._rendererId=null;this._dvl.Core.Release();this._dvl=null;E.prototype.destroy.apply(this);};v.prototype._createRenderingCanvasAndContext=function(e){var g=document.createElement("canvas");g.id=k();this._webGLContext=this._dvl.Core.CreateWebGLContext(g,e);return g;};v.prototype._getCanvas=function(){return this._canvas;};v.prototype._getWebGLContext=function(){return this._webGLContext;};v.prototype._getDvl=function(){return this._dvl;};v.prototype._getDvlClientId=function(){return this._dvlClientId;};v.prototype._findSourceData=function(e){var g=Object.getOwnPropertyNames(e);return this._sourceData.filter(function(i){return g.every(function(m){return e[m]===i[m];});});};v.prototype._destroySourceDatum=function(e){if(!(e instanceof q)){this._dvl.Core.DeleteFileByUrl(o(e.source),n(e.source));}e.destroy();return this;};v.prototype._cleanupSourceData=function(){var e=false;for(var i=this._sourceData.length-1;i>=0;--i){var g=this._sourceData[i];if(!g.isInUse()){var m=g instanceof q?g.vdsSourceDatum:null;this._sourceData.splice(i,1);this._destroySourceDatum(g);if(m&&!m.isInUse()){e=true;}}}if(e){this._cleanupSourceData();}return this;};v.prototype._findDvlSceneData=function(e){var g=Object.getOwnPropertyNames(e);return this._dvlSceneData.filter(function(i){return g.every(function(m){return e[m]===i[m];});});};v.prototype._destroyDvlSceneDatum=function(e){this._dvl.Scene.Release(e.dvlSceneId);e.destroy();return this;};v.prototype._cleanupDvlSceneData=function(){for(var i=this._dvlSceneData.length-1;i>=0;--i){var e=this._dvlSceneData[i];if(!e.isInUse()){this._dvlSceneData.splice(i,1);this._destroyDvlSceneDatum(e);}}};v.prototype._findVkSceneData=function(e){var g=Object.getOwnPropertyNames(e);return this._vkSceneData.filter(function(i){return g.every(function(m){return e[m]===i[m];});});};v.prototype._cleanupVkSceneData=function(){for(var i=this._vkSceneData.length-1;i>=0;--i){this.destroyScene(this._vkSceneData[i].vkScene);}};v.prototype._destroyShadowContentResource=function(g,i){if(i.children){i.children.forEach(this._destroyShadowContentResource.bind(this,g));}if(i.nodeProxy){var m=g.getDefaultNodeHierarchy();try{m.removeNode(i.nodeProxy.getNodeRef());}catch(e){var A="Failed to delete node with ID = "+i.nodeProxy.getNodeRef()+".";if(e instanceof b){A+=" Error code: "+e.code+". Message: "+e.message+".";}L.error(A);}m.destroyNodeProxy(i.nodeProxy);}i.destroy();};v.prototype._filterContentResources=function(e,g){var i=[];e.forEach(function A(m){if(g(m)){i.push(m);}m.getContentResources().forEach(A);});return i;};v.prototype._getContentResourcesWithMissingPasswords=function(g){var i=this._dvl.Library;return this._filterContentResources(g,function(m){var A=m.getSource();try{return A&&(f(i.RetrieveInfo(o(A),n(A))).flags&sap.ve.dvl.DVLFILEFLAG.ENCRYPTED)&&!m.getPassword();}catch(e){L.warning("Failed to get information from Emscripten virtual file system about file '"+o(A)+"'");return false;}});};v.prototype._getContentResourcesWithEncryptedVds3=function(g){var i=this._dvl.Library;return this._filterContentResources(g,function(m){var A=m.getSource();if(A){try{var B=f(i.RetrieveInfo(o(A),n(A)));return B.major<=3&&(B.flags&sap.ve.dvl.DVLFILEFLAG.ENCRYPTED);}catch(e){L.warning("Failed to get information from Emscripten virtual file system about file '"+o(A)+"'");return false;}}else{return false;}});};v.prototype._collectAndCheckSourceProperties=function(g){var i=g.dvlSceneDatum.sourceDatum;if(!i){return this;}try{if(i instanceof q){i=i.vdsSourceDatum;}var m=f(this._dvl.Library.RetrieveInfo(o(i.source),n(i.source)));g.sourceProperties={version:{major:m.major,minor:m.minor}};if(m.flags&(sap.ve.dvl.DVLFILEFLAG.PAGESCOMPRESSED|sap.ve.dvl.DVLFILEFLAG.WHOLEFILECOMPRESSED)){g.sourceProperties.compressed=true;}if(m.flags&sap.ve.dvl.DVLFILEFLAG.ENCRYPTED){g.sourceProperties.encrypted=true;}}catch(e){L.warning("Failed to get information from Emscripten virtual file system about file '"+o(g.source)+"'");}return this;};v.prototype.loadContentResourcesAsync=function(e,g,i){var A=this,B=[],F=new Map();e.forEach(function Q(m){var N=m.getSource();if(N&&B.indexOf(N)<0&&A._findSourceData({source:N}).length===0){B.push(N);var O=m.getSource();var P;if(O instanceof Object){P=O.name;}else{P=O;}if(m.getSourceType()==="vdsl"||m.getSourceType()==="vds"&&P.split(".").pop()==="vdsl"){F.set(N,{});}}m.getContentResources().forEach(Q);});var I=[];if(B.length>0){var J;var K=new a(B,null,this._authorizationHandler,this._retryCount).attachItemSucceeded(function(N){var O=N.getParameter("source");var P=N.getParameter("response");if(F.has(O)){var Q=u(P);if(Q.trim().length===0){J=J||[];J.push({source:O,status:M.VIT22.code,statusText:h().getText(M.VIT22.summary)});L.error(h().getText(M.VIT22.summary),M.VIT22.code,"sap.ui.vk.dvl.GraphicsCore");return;}else{var R=Q.split(/\n|\r\n/);var m=R[0].match(/^file=(.+)$/);if(!m){J=J||[];J.push({source:O,status:M.VIT23.code,statusText:h().getText(M.VIT23.summary)});L.error(h().getText(M.VIT23.summary),M.VIT23.code,"sap.ui.vk.dvl.GraphicsCore");return;}else{var T=F.get(O);T.content=R;var W=m[1];var X=W;var Y=new U(X);if(Y.is("relative")){if(O instanceof File){J=J||[];J.push({source:O,status:M.VIT24.code,statusText:h().getText(M.VIT24.summary)});L.error(h().getText(M.VIT24.summary),M.VIT24.code,"sap.ui.vk.dvl.GraphicsCore");return;}else{var Z=new U(O);W=Y.absoluteTo(Z).href();}}T.referencedSource=W;T.content[0]=T.content[0].replace(X,this._dvl.Core.GetFilename(T.referencedSource,"remote"));if(B.indexOf(T.referencedSource)<0&&this._findSourceData({source:T.referencedSource}).length===0){B.push(T.referencedSource);K.queue(T.referencedSource);}}}}else{var $=O instanceof File;var _=$?O.name:O;var a1=n(O);this._dvl.Core.CreateFileFromArrayBuffer(P,_,a1);I.push(new p(O));}},this).attachAllItemsCompleted(function(m){Array.prototype.push.apply(this._sourceData,I);F.forEach(function(N,O){var P=this._findSourceData({source:N.referencedSource})[0];if(P){var Q=new q(O,P,N.content.join("\n"));this._sourceData.push(Q);P.addRef();}}.bind(this));if(g){g(J);}},this).attachItemFailed(function(m){J=J||[];J.push({source:m.getParameter("source"),status:m.getParameter("status"),statusText:m.getParameter("statusText")});},this);if(i){K.attachItemProgress(i,this);}K.start();}else if(g){g();}return this;};v.prototype._buildPlaceholders=function(e,g,i,m){var A=[];m.forEach(function I(g,i,B){var F=e.createNode(g,B.name,i);B.nodeProxy=e.createNodeProxy(F);if(B.localMatrix){B.nodeProxy.setLocalMatrix(B.localMatrix);}if(B.source){A.push(B);}B.children.forEach(I.bind(this,F,null));}.bind(this,g,i));return A;};v.prototype._updatePlaceholders=function(e,g,m){var A=this,B=e.getDefaultNodeHierarchy(),F=[];(function P(I,m,J){function K(Q,R){if(!Q&&!R){return true;}else if(!!Q^!!R){return false;}else{return Q.source===R.getSource()&&Q.sourceType===R.getSourceType()&&Q.name===R.getName()&&Q.password===R.getPassword();}}function N(Q,R){R._shadowContentResource=Q;Q.sourceId=R.getSourceId();Q.localMatrix=R.getLocalMatrix();if(Q.nodeProxy){Q.nodeProxy.setLocalMatrix(Q.localMatrix);}}var i=0;var O=jQuery.sap.arrayDiff(I,m,K,true);O.forEach(function(Q){for(;i<Q.index;++i){P(I[i].children,m[i].getContentResources(),I[i].nodeProxy.getNodeRef());N(I[i],m[i]);}if(Q.type==="delete"){A._destroyShadowContentResource(e,I[Q.index]);I.splice(Q.index,1);}else if(Q.type==="insert"){var R;if(i<I.length&&I[i].nodeProxy){R=I[i].nodeProxy.getNodeRef();}var T=new s(m[Q.index]);F=F.concat(A._buildPlaceholders(B,J,R,[T]));I.splice(Q.index,0,T);++i;}});for(;i<I.length;++i){P(I[i].children,m[i].getContentResources(),I[i].nodeProxy&&I[i].nodeProxy.getNodeRef());N(I[i],m[i]);}})(g.fake?g.children:[g],m,null);return F;};v.prototype._loadAndMergeContentResource=function(g,i){if(i.source){var m=this._findSourceData({source:i.source})[0];if(!m){L.warning("Failed to load content resource with sourceId '"+i.sourceId+"' due to failed downloading from URL '"+o(i.source)+"'.");}else{var A=i.nodeProxy.getNodeRef();var B=this._findDvlSceneData({sourceDatum:m,root:false})[0];if(!B){try{B=new r(d(m instanceof q?this._dvl.Core.LoadSceneFromVDSL(m.content,i.password):this._dvl.Core.LoadSceneByUrl(o(i.source),i.password,n(i.source))),m,false);}catch(e){L.error(h().getText(M.VIT34.summary)+": "+o(i.source),M.VIT34.code,"sap.ui.vk.dvl.GraphicsCore");return;}this._dvlSceneData.push(B);m.addRef();}i.dvlSceneDatum=B;B.addRef();this._collectAndCheckSourceProperties(i);this._dvl.Renderer.ResetView(sap.ve.dvl.DVLRESETVIEWFLAG.CAMERA,this._rendererId);this._dvl.Scene.Merge(g._dvlSceneRef,B.dvlSceneId,A);}}};v.prototype.buildSceneTree=function(g){if(g.length===0){return null;}var i;var m;var A=g.map(function(J){return new s(J);});if(A.length===1&&A[0].name==null){m=A[0];if(m.source){var B=this._findSourceData({source:m.source})[0];try{i=new r(d(B instanceof q?this._dvl.Core.LoadSceneFromVDSL(B.content,m.password):this._dvl.Core.LoadSceneByUrl(o(m.source),m.password,n(m.source))),B,true);}catch(e){L.error(h().getText(M.VIT34.summary)+": "+o(m.source),M.VIT34.code,"sap.ui.vk.dvl.GraphicsCore");return null;}B.addRef();}else{i=new r(this._dvl.Core.CreateEmptyScene(),null,true);}}else{var F=new C({sourceType:"vds",sourceId:k()});m=new s(F,true);F.destroy();F=null;Array.prototype.push.apply(m.children,A);A=[m];i=new r(this._dvl.Core.CreateEmptyScene(),null,true);}this._dvlSceneData.push(i);m.dvlSceneDatum=i;i.addRef();this._collectAndCheckSourceProperties(m);var I=new S(this,i.dvlSceneId);this._vkSceneData.push(new t(I,m));this._buildPlaceholders(I.getDefaultNodeHierarchy(),null,null,m.children).forEach(this._loadAndMergeContentResource.bind(this,I.getDefaultNodeHierarchy()));return I;};v.prototype.updateSceneTree=function(e,g,i){if(g.length===0){return null;}var m;var A=this._getContentResourcesWithEncryptedVds3(g);if(A.length>0){L.error(h().getText(M.VIT25.summary),M.VIT25.code,"sap.ui.vk.dvl.GraphicsCore");m=m||{};m.contentResourcesWithEncryptedVds3=A;}var B=this._getContentResourcesWithMissingPasswords(g);if(B.length>0){L.error(h().getText(M.VIT21.summary),M.VIT21.code,"sap.ui.vk.dvl.GraphicsCore");m=m||{};m.contentResourcesWithMissingPasswords=B;}if(m&&i){i(m);}if(!e){return this.buildSceneTree(g);}var F=this._findVkSceneData({vkScene:e})[0].shadowContentResource;var I=!!F.source;var J=g.length===1&&!!g[0].getSource();if(!(I&&J&&F.source===g[0].getSource()||!I&&!J&&F.fake===g.length>1)||!F.fake&&g.length===1&&F.name!==g[0].getName()){return this.buildSceneTree(g);}this._updatePlaceholders(e,F,g).forEach(this._loadAndMergeContentResource.bind(this,e.getDefaultNodeHierarchy()));e.getDefaultNodeHierarchy().fireChanged();return e;};v.prototype._loadDvlSceneAsync=function(g,i){return new Promise(function(m,A){var B;var F=function(K){B();this.fireSceneLoadingFinished({source:g.source,sceneId:K.sceneId});m(K.sceneId);};var I=function(K){B();var N=K.errorMessage;if(N==null){N=sap.ve.dvl.DVLRESULT.getDescription?sap.ve.dvl.DVLRESULT.getDescription(K.errorCode):"";}var O={source:g.source,errorCode:K.errorCode,errorMessage:N};this.fireSceneLoadingFinished(O);A(O);};var J=function(K,N){this.fireSceneLoadingProgress({source:o(g.source),percentage:N});return true;}.bind(this);B=function(){this._dvl.Client.NotifyFileLoadProgress=null;this._dvl.Client.detachSceneFailed(I,this);this._dvl.Client.detachSceneLoaded(F,this);}.bind(this);this._dvl.Client.attachSceneLoaded(F,this);this._dvl.Client.attachSceneFailed(I,this);this._dvl.Client.NotifyFileLoadProgress=J;this.fireSceneLoadingStarted({source:o(g.source)});try{c(g instanceof q?this._dvl.Core.LoadSceneFromVDSLAsync(g.content,i):this._dvl.Core.LoadSceneByUrlAsync(o(g.source),i,n(g.source)));}catch(e){B();I.call(this,{errorCode:e instanceof b?e.code:sap.ve.dvl.DVLRESULT.FAIL,errorMessage:e instanceof b?null:e});}}.bind(this));};var w=function(e,g){return new Promise(function(i){(function A(m){if(m>=e.length){i();}else{g(e[m]).catch(function(){}).then(function(){A(m+1);});}})(0);});};v.prototype._loadAndMergeContentResourcesAsync=function(e,g){var i,m=this;return w(g,function(A){if(A.source){var B=m._findSourceData({source:A.source})[0];if(!B){var F="Failed to load content resource with sourceId '"+A.sourceId+"' due to failed downloading from URL '"+o(A.source)+"'.";L.warning(F);i=i||[];i.push({errorMessage:F,source:A.source});return Promise.reject();}return(function(){var I=m._findDvlSceneData({sourceDatum:B,root:false})[0];if(I){return Promise.resolve(I);}else{return m._loadDvlSceneAsync(B,A.password).then(function(J){I=new r(J,B,false);m._dvlSceneData.push(I);B.addRef();return Promise.resolve(I);},function(J){i=i||[];i.push(J);return Promise.reject();});}})().then(function(I){A.dvlSceneDatum=I;I.addRef();m._collectAndCheckSourceProperties(A);var J=A.nodeProxy.getNodeRef();m._dvl.Renderer.ResetView(sap.ve.dvl.DVLRESETVIEWFLAG.CAMERA,m._rendererId);m._dvl.Scene.Merge(e._dvlSceneRef,I.dvlSceneId,J);return Promise.resolve();});}return Promise.resolve();}).then(function(){return Promise.resolve(i);});};v.prototype.buildSceneTreeAsync=function(e){if(e.length===0){return Promise.resolve(null);}var g=e.map(function(i){return new s(i);});return function(){var i;if(g.length===1&&g[0].name==null){i=g[0];if(i.source){var m=this._findSourceData({source:i.source})[0];if(m){return this._loadDvlSceneAsync(m,i.password).then(function(B){var F=new r(B,m,true);m.addRef();return Promise.resolve({shadowContentResource:i,dvlSceneDatum:F});});}else{return Promise.reject({errorMessage:"Failed to download the root content resource.",source:i.source});}}return Promise.resolve({shadowContentResource:i,dvlSceneDatum:new r(this._dvl.Core.CreateEmptyScene(),null,true)});}else{var A=new C({sourceType:"vds",sourceId:k()});i=new s(A,true);A.destroy();A=null;Array.prototype.push.apply(i.children,g);g=[i];return Promise.resolve({shadowContentResource:i,dvlSceneDatum:new r(this._dvl.Core.CreateEmptyScene(),null,true)});}}.call(this).then(function(i){this._dvlSceneData.push(i.dvlSceneDatum);i.shadowContentResource.dvlSceneDatum=i.dvlSceneDatum;i.dvlSceneDatum.addRef();this._collectAndCheckSourceProperties(i.shadowContentResource);var m=new S(this,i.dvlSceneDatum.dvlSceneId);this._vkSceneData.push(new t(m,i.shadowContentResource));var A=m.getDefaultNodeHierarchy();return this._loadAndMergeContentResourcesAsync(A,this._buildPlaceholders(m.getDefaultNodeHierarchy(),null,null,i.shadowContentResource.children)).then(function(B){return Promise.resolve({scene:m,failureReason:B});});}.bind(this));};v.prototype.updateSceneTreeAsync=function(e,g){if(g.length===0){return Promise.resolve(null);}var i=this._getContentResourcesWithEncryptedVds3(g);if(i.length>0){L.error(h().getText(M.VIT25.summary),M.VIT25.code,"sap.ui.vk.dvl.GraphicsCore");}var m=this._getContentResourcesWithMissingPasswords(g);if(m.length>0){L.error(h().getText(M.VIT21.summary),M.VIT21.code,"sap.ui.vk.dvl.GraphicsCore");}if(!e){return this.buildSceneTreeAsync(g);}var A=this._findVkSceneData({vkScene:e})[0].shadowContentResource;var B=!!A.source;var F=g.length===1&&!!g[0].getSource();if(!(B&&F&&A.source===g[0].getSource()||!B&&!F&&A.fake===g.length>1)||!A.fake&&g.length===1&&A.name!==g[0].getName()){return this.buildSceneTreeAsync(g);}return new Promise(function(I,J){var K=e.getDefaultNodeHierarchy();this._loadAndMergeContentResourcesAsync(K,this._updatePlaceholders(e,A,g)).then(function(N){I({scene:e,failureReason:N});K.fireChanged();});}.bind(this));};v.prototype.destroyScene=function(e){var g;for(g=0;g<this._vkSceneData.length;++g){if(this._vkSceneData[g].vkScene===e){break;}}if(g===this._vkSceneData.length){L.warning("Scene with id '"+e.getId()+"' is not created by this GraphicsCore.");return this;}var i=this._vkSceneData.splice(g,1)[0];this._destroyShadowContentResource(e,i.shadowContentResource);e.destroy();return this;};var x=function(e,g,m){j(Array.isArray(e),"The first parameter must be an array.");j(typeof g==="function","The second parameter must be a function.");for(var i=0,A=e.length;i<A;++i){if(g.call(m,e[i],i,e)){return i;}}return-1;};var y=function(e,g){return x(e,function(i){return i.control===g;});};var z=function(e,g){return x(e,function(i){return i.rendererId===g;});};v.prototype._registerViewport=function(e){j(e,"The viewportControl parameter must not be null.");if(y(this._viewports,e)>=0){return false;}var g={control:e,canvas:null,rendererId:null};if(this._viewports.length===0){g.canvas=this._canvas;g.rendererId=this._rendererId;this._startRenderLoop();}else{if(this._viewports.length===1){var i=this._viewports[0];i.control._setCanvas(i.canvas=document.createElement("canvas"));this._dvl.Client.attachFrameFinished(this._handleFrameFinished,this);}g.canvas=document.createElement("canvas");g.rendererId=this._dvl.Core.CreateRenderer();}e._setCanvas(g.canvas);e._setRenderer(g.rendererId);e.attachResize(this._handleViewportResize,this);this._viewports.push(g);return true;};v.prototype._deregisterViewport=function(e){j(e,"The viewportControl parameter must not be null.");var i=y(this._viewports,e);if(i<0){return false;}j(i>0||this._viewports.length===1,"The first registered viewport control must be deregistered last.");var g=this._viewports.splice(i,1)[0];if(this._viewports.length===0){this._stopRenderLoop();}else{if(this._viewports.length===1){this._dvl.Client.detachFrameFinished(this._handleFrameFinished,this);var m=this._viewports[1-i];m.control._setCanvas(m.canvas=this._canvas);}this._dvl.Core.DeleteRenderer(g.rendererId);}e.detachResize(this._handleViewportResize,this);e._setRenderer(null);e._setCanvas(null);return true;};v.prototype._getViewportCount=function(){return this._viewports.length;};v.prototype._handleViewportResize=function(e){if(this._viewports.length>1){this._canvas.width=Math.max.apply(null,this._viewports.map(function(g){return g.canvas.width;}));this._canvas.height=Math.max.apply(null,this._viewports.map(function(g){return g.canvas.height;}));}};v.prototype._startRenderLoop=function(){if(!this._renderLoopRequestId){this._renderLoopRequestId=window.requestAnimationFrame(this._renderLoopFunction);}return this;};v.prototype._stopRenderLoop=function(){if(this._renderLoopRequestId){window.cancelAnimationFrame(this._renderLoopRequestId);this._renderLoopRequestId=null;}return this;};v.prototype._renderLoop=(function(){var e;return function(){var m=this._viewports.length>1;this._viewports.forEach(function(g){var i=g.canvas,A=g.rendererId;this._dvl.Renderer._processCommandQueue(A);if(i.width>0&&i.height>0&&this._dvl.Renderer.ShouldRenderFrame(A)){if(m&&e!==A){this._dvl.Renderer.SetDimensions(i.width,i.height,A);}g.control.renderFrame();e=A;}},this);this._renderLoopRequestId=window.requestAnimationFrame(this._renderLoopFunction);};})();v.prototype._handleFrameFinished=function(e){j(this._viewports.length>1,"Method _handleFrameFinished should be only called when there are multiple viewports.");if(this._viewports.length>1){var i=z(this._viewports,e.rendererId);if(i>=0){var g=this._viewports[i].canvas,m=g.getContext("2d"),A=g.width,B=g.height;m.drawImage(this._canvas,0,this._canvas.height-B,A,B,0,0,A,B);}}};v.prototype.createViewStateManager=function(e,g){var i=new V();i._setNodeHierarchy(e).setShouldTrackVisibilityChanges(g);this._viewStateManagers.push(i);return i;};v.prototype.destroyViewStateManager=function(e){var i=this._viewStateManagers.indexOf(e);if(i>=0){this._viewStateManagers.splice(i,1)[0].destroy();}return this;};v.prototype.showDebugInfo=function(e){this._viewports.forEach(function(g){g.control.setShowDebugInfo(e);});return this;};v.prototype.getApi=function(e){switch(e){case G.LegacyDvl:return this._dvl;default:return null;}};v.prototype.collectGarbage=function(){this._cleanupDvlSceneData();this._cleanupSourceData();return this;};v.prototype._onlocalizationChanged=function(e){if(e.getParameter("changes").language){c(this._dvl.Core.SetLocale(l.getConfiguration().getLanguageTag()));}};v.prototype.getDecryptionHandler=function(){return this._dvl.Client.getDecryptionHandler();};v.prototype.setDecryptionHandler=function(e){this._dvl.Client.setDecryptionHandler(e);return this;};v.prototype.setAuthorizationHandler=function(e){this._authorizationHandler=e;return this;};v.prototype.setRetryCount=function(e){this._retryCount=Math.max(e,0);return this;};v.prototype.attachSceneLoadingFinished=function(e,g,i){return this.attachEvent("sceneLoadingFinished",e,g,i);};v.prototype.detachSceneLoadingFinished=function(e,g){return this.detachEvent("sceneLoadingFinished",e,g);};v.prototype.fireSceneLoadingFinished=function(e,g,i){return this.fireEvent("sceneLoadingFinished",e,g,i);};v.prototype.attachSceneLoadingProgress=function(e,g,i){return this.attachEvent("sceneLoadingProgress",e,g,i);};v.prototype.detachSceneLoadingProgress=function(e,g){return this.detachEvent("sceneLoadingProgress",e,g);};v.prototype.fireSceneLoadingProgress=function(e,g,i){return this.fireEvent("sceneLoadingProgress",e,g,i);};v.prototype.attachSceneLoadingStarted=function(e,g,i){return this.attachEvent("sceneLoadingStarted",e,g,i);};v.prototype.detachSceneLoadingStarted=function(e,g){return this.detachEvent("sceneLoadingStarted",e,g);};v.prototype.fireSceneLoadingStarted=function(e,g,i){return this.fireEvent("sceneLoadingStarted",e,g,i);};return v;});
