/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/Element","./Core","sap/ui/vk/tools/RedlineTool","./RedlineConversation","sap/ui/vk/uuidv4","sap/ui/vk/RedlineUpgradeManager","sap/ui/core/Core"],function(E,v,R,a,u,b,c){"use strict";var d=E.extend("sap.ui.vk.RedlineCollaboration",{metadata:{library:"sap.ui.vk",aggregations:{conversations:{singularName:"conversation",type:"sap.ui.vk.RedlineConversation",multiple:true}},associations:{viewport:{type:"sap.ui.vk.Viewport",multiple:false},activeConversation:{type:"sap.ui.vk.RedlineConversation",multiple:false},activeComment:{type:"sap.ui.vk.RedlineComment",multiple:false}},events:{elementCreated:{parameters:{element:"object"}},elementClicked:{parameters:{elementId:"string"}},elementHovered:{parameters:{elementId:"string"}},conversationActivating:{parameters:{conversation:"sap.ui.vk.RedlineConversation"}},conversationActivated:{parameters:{conversation:"sap.ui.vk.RedlineConversation",viewportLocked:"boolean"}}}},constructor:function(i,p){E.apply(this,arguments);if(typeof i==="object"){p=i;i=undefined;}this._elementId=p&&p.elementId?p.elementId:u();}});d.prototype.init=function(){this._header=new Map();};d.prototype.exit=function(){if(this._tool){this._tool.destroy();}};d.prototype.getElementId=function(){return this._elementId;};d.prototype.setViewport=function(e){this.setAssociation("viewport",e);if(!this._tool){this._tool=new R();this._tool.attachElementCreated(this._onElementCreated,this);this._tool.attachElementClicked(this._onElementClicked,this);this._tool.attachElementHovered(this._onElementHovered,this);}else{this._tool.setActive(false,e);}e.addTool(this._tool);return this;};d.prototype._onElementHovered=function(e){this.fireElementHovered({elementId:e.getParameter("elementId")});};d.prototype._onElementCreated=function(e){var f=e.getParameter("element");if(this.getActiveConversation()){var g=c.byId(this.getActiveConversation());g.addContent(f);this._tool.destroyRedlineElements();g._activate(this._tool);}if(this.getActiveComment()){var h=c.byId(this.getActiveComment());h.addContent(f);}this.fireElementCreated({element:f});};d.prototype._onElementClicked=function(e){this.fireElementClicked({elementId:e.getParameter("elementId")});};d.prototype.setHeaderProperty=function(k,e){this._header.set(k,e);return this;};d.prototype.getHeaderProperty=function(k){return this._header.get(k);};d.prototype.removeHeaderProperty=function(k){this._header.delete(k);return this;};d.prototype.createConversation=function(n){var e=new a({conversationName:n});this.addConversation(e);this.setActiveConversation(e);return e;};d.prototype.setActiveConversation=function(e){var f=c.byId(this.getActiveConversation());if(f){if(f.getViewInfo()){var r=this._updateViewInfo();f.setViewInfo(r);}f._deactivate();}this.setAssociation("activeConversation",e);var g=c.byId(this.getViewport());if(!e){this._tool.setActive(false,g);return this;}this.fireConversationActivating({conversation:e});this._tool.destroyRedlineElements();if(e.getViewInfo()){var s=c.byId(g.getContentConnector()).getContent();var h=s.getViews();var i;for(var j=0;j<h.length;j++){if(h[j].getViewId()===e.getViewId()){i=h[j];}}if(i){v.getEventBus().subscribe("sap.ui.vk","readyForAnimation",this._readyForAnimation,this);var k=c.byId(g.getViewStateManager());var l=c.byId(k.getViewManager());l.setAutoPlayAnimation(false);l.activateView(i);}if(!this._tool.getActive()){this._tool.setActive(true,g);}}else if(this._tool.getActive()){this._tool.setActive(false,g);}if(e.getContent()){e._activate(this._tool);}this.fireConversationActivated({conversation:e,viewportLocked:this._tool.getActive()});return this;};d.prototype._readyForAnimation=function(){var e=c.byId(this.getViewport());var f=c.byId(this.getActiveConversation());if(f){var g=c.byId(e.getViewStateManager()).getAnimationPlayer();g.setTime(f.getAnimationOffset());var h=f.getViewInfo();if(e.getCamera()&&e.getCamera().getCameraRef()){var i=e.getCamera().getCameraRef();if(h.camera.view&&i&&!i.view){i.view=h.camera.view;i.view.enabled=true;}}e.setViewInfo(h);}v.getEventBus().unsubscribe("sap.ui.vk","readyForAnimation",this._readyForAnimation,this);var j=c.byId(e.getViewStateManager());var k=c.byId(j.getViewManager());k.setAutoPlayAnimation(true);};d.prototype.createElement=function(r){var e=c.byId(this.getActiveConversation());var f=c.byId(this.getViewport());if(e&&!e.getViewInfo()){var g=this._updateViewInfo();e.setViewId(f.getCurrentView().getViewId());e.setViewInfo(g);e.setAnimationOffset(c.byId(f.getViewStateManager()).getAnimationPlayer().getTime());}if(!this._tool.getActive()){this._tool.setActive(true,f);}this._tool.startAdding(r);return r;};d.prototype.deactivateRedlineDrawing=function(){if(this._tool){this._tool.stopAdding();}return this;};d.prototype.removeElement=function(r){var e=c.byId(this.getActiveConversation());if(e){e.removeContent(r);this._tool.destroyRedlineElements();e._activate(this._tool);}return this;};d.prototype._normalizeElementsArray=function(e){var n=[];var f=this.getActiveRedlineElements();if(Array.isArray(e)){for(var i=0;i<e.length;i++){if(e[i]instanceof sap.ui.vk.RedlineElement){n.push(e[i]);}else{for(var j=0;j<f.length;j++){if(e[i]===f[j].getElementId()){n.push(f[j]);}}}}}else if(e instanceof sap.ui.vk.RedlineElement){n.push(e);}else{for(var k=0;k<f.length;k++){if(e===f[k].getElementId()){n.push(f[k]);}}}return n;};d.prototype.setHighlight=function(e,f){if(!e){return this;}var n=this._normalizeElementsArray(e);for(var i=0;i<n.length;i++){var g=n[i];g.setHalo(true);if(f){g.setHaloColor(f);}else if(this._tool._haloColor){g.setHaloColor(this._tool._haloColor);}else{g.setHaloColor("rgba(255, 0, 0, 1)");}}var h=c.byId(this.getActiveConversation());if(h){this._tool.destroyRedlineElements();h._activate(this._tool);}return this;};d.prototype.setDefaultHighlightColor=function(e){if(e){this._tool._haloColor=e;}return this;};d.prototype.clearHighlight=function(e){if(!e){return this;}var n=this._normalizeElementsArray(e);for(var i=0;i<n.length;i++){n[i].setHalo(false);}var f=c.byId(this.getActiveConversation());if(f){this._tool.destroyRedlineElements();f._activate(this._tool);}return this;};d.prototype.addStyleClass=function(e){if(e&&this._tool){this._tool.getGizmo().addStyleClass(e);}return this;};d.prototype.removeStyleClass=function(e){if(e&&this._tool){this._tool.getGizmo().removeStyleClass(e);}return this;};d.prototype.toggleStyleClass=function(e){if(e&&this._tool){this._tool.getGizmo().toggleStyleClass(e);}return this;};d.prototype._updateViewInfo=function(){var e=c.byId(this.getViewport());var q={camera:{matrices:true},visibility:true,selection:true};var r=e.getViewInfo(q);return r;};d.prototype.freezeView=function(){var e=c.byId(this.getActiveConversation());var f=c.byId(this.getViewport());if(e&&!e.getViewInfo()){var r=this._updateViewInfo();e.setViewId(f.getCurrentView().getViewId());e.setViewInfo(r);e.setAnimationOffset(c.byId(f.getViewStateManager()).getAnimationPlayer().getTime());}if(!this._tool.getActive()){this._tool.setActive(true,f);}return this;};d.prototype.unfreezeView=function(){var e=c.byId(this.getActiveConversation());if(e){var f=e.getComments();if(this._tool.getActive()&&this._tool.getRedlineElements().length===0&&(f.length===0||(f.length===1&&!f[0].getText()))){this._tool.setActive(false);e.setViewInfo(null);}}return this;};d.prototype.getActiveRedlineElements=function(){if(this._tool){var e=this._tool.getRedlineElements();return e;}};d.prototype._createConversationFromJSON=function(j){var e=new a();var f=e.importJSON(j);this.addConversation(e);return f;};d.prototype.importJSON=function(e){e=b.upgrade(e);var f=new Set();this.setActiveConversation(null);this.destroyConversations();this.setActiveComment(null);var h=Object.entries(e.header);for(var i=0;i<h.length;i++){this.setHeaderProperty(h[i][0],h[i][1]);}this._elementId=this.getHeaderProperty("elementId");var g=e.conversations;if(g){for(var j=0;j<g.length;j++){var l=this._createConversationFromJSON(g[j]);l.forEach(f.add,f);}}var m=this.getHeaderProperty("initialConversation");var n=this.getConversations();var o;if(n){for(var k=0;k<n.length;k++){if(n[k].getElementId()===m){o=n[k];break;}}}this.setActiveConversation(o);return f;};d.prototype.exportJSON=function(){var e="";if(this.getActiveConversation()){var f=c.byId(this.getActiveConversation());if(f.getViewInfo()){var r=this._updateViewInfo();f.setViewInfo(r);}e=f.getElementId();}this.setHeaderProperty("initialConversation",e);if(!this.getHeaderProperty("elementId")){this.setHeaderProperty("elementId",this._elementId);}var h=Object.fromEntries(this._header);var j={schemaVersion:"1.0",header:h,conversations:this.getConversations().map(function(g){return g.exportJSON();})};return j;};d.prototype.destroy=function(){if(this._tool.getActive()){this._tool.setActive(false);}};return d;});
