/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./library","sap/ui/core/Control","sap/ui/vbm/library","sap/ui/vbm/lib/sapvbi","sap/ui/unified/Menu","./Messages","./OverlayRenderer","./getResourceBundle","./OverlayArea","sap/base/Log"],function(v,C,a,b,M,c,O,g,d,L){"use strict";var f=C.extend("sap.ui.vk.Overlay",{metadata:{library:"sap.ui.vk",properties:{zoomOnResize:{type:"boolean",group:"Behavior",defaultValue:true}},aggregations:{areas:{type:"sap.ui.vk.OverlayArea",multiple:true,singularName:"area"}},associations:{target:{type:"sap.ui.core.Control",cardinality:"0..1"}},events:{click:{parameters:{clientX:{type:"int"},clientY:{type:"int"},pos:{type:"string"}}},contextMenu:{parameters:{pos:{type:"string"},menu:{type:"sap.ui.unified.Menu"}}}}}});f.prototype.getPositionInteractive=function(p,e){if(!this.mIACreateCB&&e&&typeof(e)==="function"){this.mIACreateCB=e;var t="POS";if(p){t+="ARRAY";}var l={"SAPVB":{"Automation":{"Call":{"handler":"OBJECTCREATIONHANDLER","name":"CreateObject","object":"MainScene","scene":"MainScene","instance":"","Param":{"name":"data","#":"{"+t+"}"}}}}};this._load(l);return true;}else{return false;}};f.prototype.openContextMenu=function(m){this._openContextMenu("Overlay",this,m);};f.prototype.setPanAndZoom=function(n,e,z){if(n===0&&e===0&&z===1){return;}var s=this.mVBIContext.GetMainScene();this.totalCenterOffset.dx+=n;this.totalCenterOffset.dy+=e;if(z===1){s.MoveMap(n,e);}else{var h=s.m_Canvas[0];var i=h.m_nExactLOD+Math.log(z)*Math.LOG2E;s.ZoomToGeoPosition(VBI.MathLib.DegToRad([0.5,0.5]),i);s.MoveMap(this.totalCenterOffset.dx,this.totalCenterOffset.dy);}};f.prototype.reset=function(){this.totalCenterOffset.dx=this.totalCenterOffset.dy=0;var s=this.mVBIContext.GetMainScene();if(s){s.ZoomToGeoPosition(VBI.MathLib.DegToRad([0.5,0.5]),this.initialZoom);}return this;};f.prototype.init=function(){this.aLoadQueue=null;this.oTargetDomRef=null;this.mVBIContext=new VBI.VBIContext(this);this.resizeID="";this.resizeIDTarget="";this.bVosDirty=true;this.bWindowsDirty=true;this.bSceneDirty=true;this.bDataDeltaUpdate=false;this.bHandleDataChangeActive=false;this.bForceDataUpdate=false;this.mAddMenuItems=[];this.totalCenterOffset={dx:0,dy:0};this.initialZoom=10;};f.prototype.exit=function(){if(this.mVBIContext){this.mVBIContext.clear();}if(this.resizeID!=""){sap.ui.core.ResizeHandler.deregister(this.resizeID);this.resizeID="";}if(this.resizeIDTarget!=""){sap.ui.core.ResizeHandler.deregister(this.resizeIDTarget);this.resizeIDTarget="";}};f.prototype.resize=function(e){var h=(this.oControl!=undefined)?this.oControl:this;var i=h.mVBIContext;if(i){var s=i.GetMainScene();if(s){if(h.getZoomOnResize()&&e&&e.oldSize.width>0){var z=Math.log(e.size.width/e.oldSize.width)*Math.LOG2E;s.ZoomToGeoPosition(s.GetCenterPos(),s.GetCurrentZoomlevel()+z,false,true,true);}s.resizeCanvas(e,true,true);}}};f.prototype.setTarget=function(t){if(!t){return;}this.setAssociation("target",t);this.reset();if(t instanceof sap.m.Image){t.addDelegate({onAfterRendering:function(e){this.oTargetDomRef=t.getDomRef();this.oTargetDomRef.addEventListener("load",jQuery.proxy(this._adaptSizeOfTarget,this));}.bind(this)});}else{t.addDelegate({onAfterRendering:function(e){this.oTargetDomRef=t.getDomRef();this._adaptSizeOfTarget();}.bind(this)});}if(this.resizeIDTarget!=""){sap.ui.core.ResizeHandler.deregister(this.resizeIDTarget);this.resizeIDTarget="";}this.resizeIDTarget=sap.ui.core.ResizeHandler.register(t,this._adaptSizeOfTarget.bind(this));};f.prototype._adaptSizeOfTarget=function(){var t=this.oTargetDomRef;var h=this.getDomRef();if(t){try{var T=jQuery(t);var p={top:T.offset().top,left:T.offset().left,width:T.outerWidth(),height:T.outerHeight()};jQuery(h).width(p.width).height(p.height).css("position","absolute");jQuery(h).css("top","0px").css("left","0px").css("visibility","");}catch(e){L.error(e);}}else{jQuery(h).css("position","fixed").width("0px").height("0px").css("top","0px").css("left","0px").css("visibility","hidden");}};f.prototype.onAfterRendering=function(){if(this.$oldContent.length>0){this.$().append(this.$oldContent);}this._adaptSizeOfTarget();if(this.aLoadQueue){var n;for(n=0;n<this.aLoadQueue.length;++n){this._load(this.aLoadQueue[n]);}this.aLoadQueue=null;}if(this.resizeID==""){this.resize();this.resizeID=sap.ui.core.ResizeHandler.register(this,this.resize);}var o=this.getId();if(this.mVBIContext.m_Windows){this.mVBIContext.m_Windows.Awake(o);}};f.prototype.onBeforeRendering=function(){this.$oldContent=sap.ui.core.RenderManager.findPreservedContent(this.getId());};f.prototype.invalidate=function(s){this.bSceneDirty=true;if(s instanceof d){this.bVosDirty=true;this.bDataDeltaUpdate=this.bHandleDataChangeActive;}sap.ui.core.Control.prototype.invalidate.apply(this,arguments);};f.prototype._load=function(e){if(!this.isRendered()){if(!this.aLoadQueue){this.aLoadQueue=[];}this.aLoadQueue.push(e);return;}this._loadHtml(e);};f.prototype._loadHtml=function(e){var o=this.getId();var h=null;if(typeof e=="string"){h=JSON.parse(e.indexOf("{")?e.substr(e.indexOf("{")):e);}else if(typeof e=="object"){h=e;}if(!h){return;}if(!h["SAPVB"]){var m;if(this.mVBIContext&&(m=(new VBI.Adaptor(this.mVBIContext)).CreateLoadData(h))){this.loadHtml(m);return;}else{return;}}var i=false;var j=false;var k=false;if(jQuery.type(h)=="object"){if(h.SAPVB){if(h.SAPVB.Config){this.mVBIContext.GetConfig().load(h.SAPVB.Config,this.mVBIContext);}if(h.SAPVB.Resources){this.mVBIContext.GetResources().load(h.SAPVB.Resources,this.mVBIContext);}if(h.SAPVB.DataTypes){if(!this.mVBIContext["m_DataTypeProvider"]){this.mVBIContext["m_DataTypeProvider"]=new VBI.DataTypeProvider();}this.mVBIContext["m_DataTypeProvider"].load(h.SAPVB.DataTypes,this.mVBIContext);}if(h.SAPVB.Data){if(!this.mVBIContext["m_DataProvider"]){this.mVBIContext["m_DataProvider"]=new VBI.DataProvider();}this.mVBIContext["m_DataProvider"].load(h.SAPVB.Data,this.mVBIContext);i=true;}if(h.SAPVB.Windows){if(!this.mVBIContext["m_Windows"]){this.mVBIContext["m_Windows"]=new VBI.Windows();}this.mVBIContext["m_Windows"].load(h.SAPVB.Windows,this.mVBIContext);k=true;}if(h.SAPVB.Actions){if(!this.mVBIContext["m_Actions"]){this.mVBIContext["m_Actions"]=new VBI.Actions();}this.mVBIContext["m_Actions"].load(h.SAPVB.Actions,this.mVBIContext);}if(h.SAPVB.Automation){if(!this.mVBIContext["m_Automations"]){this.mVBIContext["m_Automations"]=new VBI.Automations();}this.mVBIContext["m_Automations"].load(h.SAPVB.Automation,this.mVBIContext);}if(h.SAPVB.Menus){if(!this.mVBIContext["m_Menus"]){this.mVBIContext["m_Menus"]=new VBI.Menus();}this.mVBIContext["m_Menus"].load(h.SAPVB.Menus,this.mVBIContext);}if(h.SAPVB.Scenes){if(!this.mVBIContext["m_SceneManager"]){this.mVBIContext["m_SceneManager"]=new VBI.SceneManager();}this.mVBIContext["m_SceneManager"].load(h.SAPVB.Scenes,this.mVBIContext);j=true;}}if(i){if(this.mVBIContext["m_Windows"]){this.mVBIContext["m_Windows"].NotifyDataChange();}}if(j||k){if(this.mVBIContext["m_Windows"]){this.mVBIContext["m_Windows"].Awake(o);}}if(j||i){if(this.mVBIContext["m_Windows"]){this.mVBIContext["m_Windows"].RenderAsync();}}}};f.prototype._openContextMenu=function(t,i,m){if(m&&m.vbi_data&&m.vbi_data.VBIName=="DynContextMenu"){if(!this.mVBIContext["m_Menus"]){this.mVBIContext["m_Menus"]=new window.VBI.Menus();}for(var n=0;n<this.mAddMenuItems.length;++n){m.addItem(this.mAddMenuItems[n]);}this.mVBIContext.m_Menus.m_menus.push(m);this._loadHtml({"SAPVB":{"version":"2.0","Automation":{"Call":{"earliest":"0","handler":"CONTEXTMENUHANDLER","instance":i.sId,"name":"SHOW","object":t,"refID":"CTM","Param":[{"name":"x","#":i.mClickPos[0]},{"name":"y","#":i.mClickPos[1]},{"name":"scene","#":"MainScene"}]}}}});}this.mAddMenuItems=[];};f.prototype._update=function(){var A={SAPVB:{}};if(this.bSceneDirty){this._updateScene(A);}this._updateWindows(A);if(A.SAPVB.Actions){Array.prototype.push.apply(A.SAPVB.Actions.Set.Action,this._getActionArray());}return this._minimizeApp(A);};f.prototype._minimizeApp=function(A){var t,s;var e;s=null;if(!this.bWindowsDirty){e=(t=A)&&(t=t.SAPVB)&&(t=t.Windows)&&(s=JSON.stringify(t))&&(s==this.mCurWindows)&&(delete A.SAPVB.Windows);if(!e){this.mCurWindows=s?s:this.mCurWindows;}}else{this.bWindowsDirty=false;}s=null;e=(t=A)&&(t=t.SAPVB)&&(t=t.Scenes)&&(s=JSON.stringify(t))&&(s==this.mCurScenes)&&(delete A.SAPVB.Scenes);if(!e){this.mCurScenes=s?s:this.mCurScenes;}s=null;e=(t=A)&&(t=t.SAPVB)&&(t=t.Actions)&&(s=JSON.stringify(t))&&(s==this.mCurActions)&&(delete A.SAPVB.Actions);if(!e){this.mCurActions=s?s:this.mCurActions;}s=null;e=(t=A)&&(t=t.SAPVB)&&(t=t.DataTypes)&&(s=JSON.stringify(t))&&(s==this.mCurDataTypes)&&(delete A.SAPVB.DataTypes);if(!e){this.mCurDataTypes=s?s:this.mCurDataTypes;}if(!this.bForceDataUpdate){s=null;e=(t=A)&&(t=t.SAPVB)&&(t=t.Data)&&(s=JSON.stringify(t))&&(s==this.mCurData)&&(delete A.SAPVB.Data);if(!e){this.mCurData=s?s:this.mCurData;}}else{this.bForceDataUpdate=false;}return A;};f.prototype._updateWindows=function(A){A.SAPVB.Windows={"Set":[{"name":"Main","Window":{"id":"Main","caption":"MainWindow","type":"geo","refParent":"","refScene":"MainScene","modal":"true"}}]};};f.prototype._updateScene=function(A){var s=[];var e=[];var h=[];var i=[];this._updateVOData(s,e,h,i);var _=JSON.stringify(s);var m=true;if(!this.saVO){((((A.SAPVB.Scenes={}).Set={}).SceneGeo={id:"MainScene",scaleVisible:"false",navControlVisible:"false",VisualFrame:{minLOD:5},NavigationDisablement:{move:"true",zoom:"true"},initialZoom:this.initialZoom.toString(),initialStartPosition:"0.5;0.5;0"}).VO=s);}else if(this.bRefMapLayerStackDirty||!(this.saVO===_)){(A.SAPVB.Scenes=this._getSceneVOdelta(JSON.parse(this.m_saVO),s));}else{m=false;}this.saVO=_;if(this.bDataDeltaUpdate){A.SAPVB.Data=[];for(var n=0;n<e.length;++n){A.SAPVB.Data.push({Set:{name:e[n].name,type:"N",N:e[n]}});}}else{((A.SAPVB.Data={}).Set={}).N=e;}if(m){(((A.SAPVB.DataTypes={}).Set={}).N=h);}(((A.SAPVB.Actions={}).Set={}).Action=i);this.bSceneDirty=this.bVosDirty=this.bDataDeltaUpdate=false;};f.prototype._isEventRegistered=function(A,e){var h=this.getAggregation(A);if(!h){return false;}for(var n=0;n<h.length;++n){var i=h[n];if(i.hasListeners(e)){return true;}}return false;};f.prototype._getTemplateBindingInfo=function(A){var B=this.getBindingInfo(A);if(B&&B.template){return B.template.mBindingInfos;}};f.prototype._getBindInfo=function(A){var B={};var t=this._getTemplateBindingInfo(A);B.C=(t)?t.hasOwnProperty("color"):true;B.CB=(t)?t.hasOwnProperty("colorBorder"):true;B.DCH=(t)?t.hasOwnProperty("deltaColorHot"):true;B.CS=(t)?t.hasOwnProperty("colorSelect"):true;B.CNS=(t)?t.hasOwnProperty("colorNonSelect"):true;B.TT=(t)?t.hasOwnProperty("tooltip"):true;B.M=(t)?t.hasOwnProperty("changeable"):true;B.hasTemplate=(t)?true:false;return B;};f.prototype._updateVOData=function(s,e,h,i){var B,V;this.AreaBindInfo=B=(this.AreaBindInfo)?this.AreaBindInfo:this._getBindInfo("areas");V=(B.hasTemplate)?this.getBindingInfo("areas").template:null;var o={id:"OverlayArea",datasource:"OverlayArea",type:"{00100000-2012-0004-B001-F311DE491C77}"};o["posarray.bind"]=o.id+".P";if(B.C){o["color.bind"]=o.id+".C";}else{o.color=V.getColor();}if(B.CB){o["colorBorder.bind"]=o.id+".C";}else{o.colorBorder=V.getColorBorder();}if(B.DCH){o["hotDeltaColor.bind"]=o.id+".DCH";}else{o.hotDeltaColor=V.getDeltaColorHot();}if(B.CS){o["colorSelect.bind"]=o.id+".C";}else{o.colorSelect=V.getColorSelect();}if(B.CNS){o["colorNonSelect.bind"]=o.id+".C";}else{o.colorNonSelect=V.getColorNonSelect();}if(!B.M){o["VB:c"]=V.getChangeable();}s.push(o);var j={name:o.id,key:"K"};j.A=[{"name":"K","alias":"K","type":"string"},{"name":"VB:s","alias":"VB:s","type":"boolean"},{"name":"P","alias":"P","type":"vectorarray","changeable":"true"}];if(B.C){j.A.push({"name":"C","alias":"C","type":"color"});}if(B.CB){j.A.push({"name":"CB","alias":"CB","type":"string"});}if(B.DCH){j.A.push({"name":"DCH","alias":"DCH","type":"string"});}if(B.CS){j.A.push({"name":"CS","alias":"CS","type":"string"});}if(B.CNS){j.A.push({"name":"CNS","alias":"CNS","type":"string"});}if(B.TT){j.A.push({"name":"TT","alias":"TT","type":"string"});}h.push(j);var k=o.id;if(this._isEventRegistered("areas","click")){i.push({"id":k+"1","name":"click","refScene":"MainScene","refVO":k,"refEvent":"Click","AddActionProperty":[{"name":"pos"}]});}if(this._isEventRegistered("areas","contextMenu")){i.push({"id":k+"2","name":"contextMenu","refScene":"MainScene","refVO":k,"refEvent":"ContextMenu"});}if(this._isEventRegistered("areas","edgeClick")){i.push({"id":k+"7","name":"edgeClick","refScene":"MainScene","refVO":k,"refEvent":"EdgeClick"});}i.push({"id":k+"4","name":"handleMoved","refScene":"MainScene","refVO":k,"refEvent":"HandleMoved"});i.push({"id":k+"5","name":"handleContextMenu","refScene":"MainScene","refVO":k,"refEvent":"HandleContextMenu"});i.push({"id":k+"8","name":"edgeContextMenu","refScene":"MainScene","refVO":k,"refEvent":"EdgeContextMenu"});if(this._isEventRegistered("areas","handleClick")){i.push({"id":k+"6","name":"handleClick","refScene":"MainScene","refVO":k,"refEvent":"HandleClick"});}var l={name:o.id,E:[]};var m=this.getAreas();for(var n=0;n<m.length;++n){l.E.push(m[n].getDataElement());}e.push(l);};f.prototype._getSceneVOdelta=function(o,n){var V=[];var r=[];var e={};for(var h=0,l=o.length;h<l;++h){e[o[h].id]=o[h];}for(var i=0;i<n.length;++i){if(e[n[i].id]){if(JSON.stringify(n[i])!=JSON.stringify(e[n[i].id])){r.push({"id":n[i].id,"type":"VO"});V.push(n[i]);}}else{V.push(n[i]);}delete e[n[i].id];}for(var j in e){r.push({"id":j,"type":"VO"});}var k={"Merge":{"name":"MainScene","type":"SceneGeo","SceneGeo":{"id":"MainScene"}}};if(r.length){k.Merge.SceneGeo.Remove=r;}if(V.length){k.Merge.SceneGeo.VO=V;}return k;};f.prototype._getActionArray=function(){var A=[];if(this.mEventRegistry["click"]){A.push({"id":"Overlay1","name":"click","refScene":"MainScene","refVO":"Map","refEvent":"Click","AddActionProperty":[{"name":"pos"}]});}if(this.mEventRegistry["contextMenu"]){A.push({"id":"Overlay2","name":"contextMenu","refScene":"MainScene","refVO":"Map","refEvent":"ContextMenu","AddActionProperty":[{"name":"pos"}]});}A.push({"id":"Overlay3","name":"GetPosComplete","refScene":"MainScene","refVO":"General","refEvent":"CreateComplete"});return A;};f.prototype._handleChangedData=function(n){try{this.bHandleDataChangeActive=true;if(n&&n.length){for(var e=0,N;e<n.length;++e){N=n[e];if(N.E&&N.E.length){for(var h=0,E,i;h<N.E.length;++h){E=N.E[h];i=this._findInstance(E.K);if(i){i.handleChangedData(E);}}}}}this.bHandleDataChangeActive=false;}catch(j){this.bHandleDataChangeActive=false;throw j;}};f.prototype._findInstance=function(i){var I=(i.indexOf(".")!==-1)?i.split(".")[1]:i;var A=this.getAreas();for(var n=0;n<A.length;++n){var e=A[n];if(e.getId()===I){return e;}}return null;};f.prototype._handleAggregationEvent=function(e){var E;if((E=this._findInstance(e.Action.instance))){try{E.handleEvent(e);}catch(h){L.error(g().getText(c.VIT11.summary),c.VIT11.code,"sap.ui.vk.Overlay");}}};f.prototype.isRendered=function(){return this.getDomRef()?true:false;};f.prototype.fireSubmit=function(e){var h=JSON.parse(e.data);if(h.Data&&h.Data.Merge){this._handleChangedData(h.Data.Merge.N);}if(h.Action.object==="OverlayArea"){this._handleAggregationEvent(h);}else{var A=h.Action.name,i;if(A==="click"||A==="contextMenu"){i=[h.Action.Params.Param[0]["#"],h.Action.Params.Param[1]["#"]];}switch(A){case"GetPosComplete":if(this.mIACreateCB){try{this.mIACreateCB(h.Action.Params.Param[0]["#"]);this.mIACreateCB=null;}catch(j){this.mIACreateCB=null;throw j;}}break;case"click":this.fireClick({clientX:i[0],clientY:i[1],pos:h.Action.AddActionProperties.AddActionProperty[0]["#"]});break;case"contextMenu":if(this.mVBIContext.m_Menus){this.mVBIContext.m_Menus.deleteMenu("DynContextMenu");}var m=new M();m["vbi_data"]={};m["vbi_data"].menuRef="CTM";m["vbi_data"].VBIName="DynContextMenu";this.mClickPos=i;this.fireContextMenu({pos:h.Action.AddActionProperties.AddActionProperty[0]["#"],menu:m});break;default:break;}}};f.prototype.fireRender=function(e){};f.prototype.fireMove=function(e){};f.prototype.fireZoom=function(e){};f.prototype.fireOpenWindow=function(e){};f.prototype.fireCloseWindow=function(e){};return f;});
