/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./CreateParametricGizmo","../svg/Element","../svg/Path","sap/ui/events/KeyCodes"],function(G,E,P,K){"use strict";var C=G.extend("sap.ui.vk.tools.CreatePathToolGizmo",{metadata:{library:"sap.ui.vk"}});C.prototype.hasDomElement=function(){return false;};C.prototype.show=function(v,t){this._viewport=v;this._tool=t;this._activeElement=null;this.updateParentNode();this._onKeyPressListener=this._onKeyPress.bind(this);document.addEventListener("keydown",this._onKeyPressListener);};C.prototype.hide=function(){document.removeEventListener("keydown",this._onKeyPressListener);if(this._gizmo){this._gizmo.parent.remove(this._gizmo);this._gizmo=null;}if(this._activeElement){this._activeElement.parent.remove(this._activeElement);this._activeElement=null;}this._viewport=null;this._tool=null;this._root=null;};var M=4;var a=16;C.prototype._getDistance=function(d,b){return Math.sqrt(d*d+b*b)*this._viewport._camera.zoom;};C.prototype._getGizmoSegments=function(p){var l=5/this._viewport._camera.zoom;return[{type:"move",points:[p.x-l,p.y]},{type:"line",points:[p.x+l,p.y]},{type:"move",points:[p.x,p.y-l]},{type:"line",points:[p.x,p.y+l]}];};C.prototype._addPoint=function(p,f,c){var b=this._activeElement;if(!b){this._activeElement=b=new P({subelement:true,material:this._tool._material,lineStyle:this._tool._lineStyle,fillStyle:null,segments:[{type:"move",points:[p.x,p.y]}]});if(b.stroke[3]===0){b.stroke.set([1,0,0,0.5]);b.strokeDashArray=[5,5];}if(this._tool.getClosePath()){b.segments.push({type:"close"});b.setFillStyle(this._tool._fillStyle);}this._pointCount=2;this._canClosePath=false;this._gizmo=new P({subelement:true,lineStyle:{colour:"#000",width:2},segments:this._getGizmoSegments(p)});var n=new E({name:"Path"});n.add(b);n.add(this._gizmo);this._root.add(n);}else{var d=b.segments[0].points;if(this._pointCount>=d.length){d.push(p.x,p.y);}else{d[d.length-2]=p.x;d[d.length-1]=p.y;}b.invalidate();if(f){if(c&&this._checkClosure(p)){return;}if(this._getDistance(p.x-d[this._pointCount-2],p.y-d[this._pointCount-1])>=M){this._canClosePath=this._canClosePath||this._getDistance(p.x-d[0],p.y-d[1])>=a;this._pointCount=d.length;if(this._gizmo){this._gizmo.segments=this._getGizmoSegments(p);this._gizmo.invalidate();}}}}};C.prototype._checkClosure=function(p){var b=this._activeElement;if(b){var c=b.segments[0].points;if(this._getDistance(p.x-c[0],p.y-c[1])<a){if(this._canClosePath&&this._pointCount>=6){this._finishPath(true);return true;}}}return false;};C.prototype._finishPath=function(c){if(this._gizmo){this._gizmo.parent.remove(this._gizmo);this._gizmo=null;}var b=this._activeElement;if(b){if(this._pointCount<4){b.parent.remove(b);this._activeElement=null;this._tool.fireCompleted({});}else{var p=b.segments[0].points;p.length=this._pointCount;b.setLineStyle(this._tool._lineStyle);if(c&&b.segments.length===1){b.segments.push({type:"close"});b.setFillStyle(this._tool._fillStyle);}b.invalidate();this._tool.fireCompleted({node:b.parent,request:this._createRequest(b.parent),closed:c});}this._activeElement=null;}};C.prototype._onKeyPress=function(e){switch(e.keyCode){case K.ESCAPE:case K.ENTER:if(this._activeElement){this._finishPath(false);}break;default:break;}};return C;});
