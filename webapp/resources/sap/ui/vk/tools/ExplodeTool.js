/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./Tool","./ExplodeAxis","./ExplodeDirection","./ExplodeItemGroup","./ExplodeType","./ExplodeToolHandler","./ExplodeToolGizmo","../AnimationPlayback","../AnimationTrackType","../AnimationTrackValueType","../OrthographicCamera","sap/ui/base/ManagedObjectObserver","../getResourceBundle"],function(T,E,a,b,c,d,e,A,f,g,O,M,h){"use strict";var i=T.extend("sap.ui.vk.tools.ExplodeTool",{metadata:{properties:{type:{type:"sap.ui.vk.tools.ExplodeType",defaultValue:c.Linear},axis:{type:"sap.ui.vk.tools.ExplodeAxis"},direction:{type:"sap.ui.vk.tools.ExplodeDirection"},magnitude:{type:"float",defaultValue:0.0},anchor:{type:"float[]",defaultValue:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}},aggregations:{items:{type:"sap.ui.vk.tools.ExplodeItemGroup",multiple:true}},associations:{selectedItem:{type:"sap.ui.vk.tools.ExplodeItemGroup",multiple:false}},events:{axisSelected:{parameters:{axis:{type:"sap.ui.vk.tools.ExplodeAxis"},direction:{type:"sap.ui.vk.tools.ExplodeDirection"}}},magnitudeChanging:{parameters:{type:{type:"sap.ui.vk.tools.ExplodeType"},axis:{type:"sap.ui.vk.tools.ExplodeAxis"},direction:{type:"sap.ui.vk.tools.ExplodeDirection"},magnitude:{type:"float"}}},magnitudeChanged:{parameters:{type:{type:"sap.ui.vk.tools.ExplodeType"},axis:{type:"sap.ui.vk.tools.ExplodeAxis"},direction:{type:"sap.ui.vk.tools.ExplodeDirection"},magnitude:{type:"float"}}},itemSequenceChangePressed:{parameters:{item:{type:"sap.ui.vk.tools.ExplodeItemGroup"},moveUp:{type:"boolean"}}},itemPositionAdjusting:{parameters:{item:{type:"sap.ui.vk.tools.ExplodeItemGroup"},magnitudeAdjustmentMultiplier:{type:"float"}}},itemPositionAdjusted:{parameters:{item:{type:"sap.ui.vk.tools.ExplodeItemGroup"},magnitudeAdjustmentMultiplier:{type:"float"}}}}},constructor:function(I,s){T.apply(this,arguments);this._viewport=null;this._handler=new d(this);this._gizmo=null;}});i.prototype.init=function(){if(T.prototype.init){T.prototype.init.call(this);}this.setFootprint(["sap.ui.vk.threejs.Viewport"]);this.setAggregation("gizmo",new e());this._groupObserver=new M(this._onGroupChanged.bind(this));this._groupsObserver=new M(this._onGroupsChanged.bind(this));this._groupsObserver.observe(this,{aggregations:["items"]});};i.prototype.destroy=function(){i._cleanAssociatedLoaders();this._groupsObserver.disconnect();this._groupsObserver=null;this._groupObserver.disconnect();this._groupObserver=null;};i.prototype.setActive=function(v,j,k){T.prototype.setActive.call(this,v,j,k);if(this._viewport){if(v){this._gizmo=this.getGizmo();this._gizmo.show(this._viewport,this);this._addLocoHandler();}else{this._removeLocoHandler();if(this._gizmo){this._gizmo.hide();this._gizmo=null;}}}return this;};i.prototype.queueCommand=function(j){if(this._addLocoHandler()){if(this.isViewportType("sap.ui.vk.threejs.Viewport")){j();}}return this;};i.prototype.setType=function(v){this.setProperty("type",v,true);if(this._gizmo){this._gizmo._recalculateOffsets();}};i.prototype.setAxis=function(v){this.setProperty("axis",v,true);if(this._gizmo){this._gizmo._updateAxis();}};i.prototype.setDirection=function(v){this.setProperty("direction",v,true);if(this._gizmo){this._gizmo._updateAxis();}};i.prototype.setAnchor=function(v){this.setProperty("anchor",v,true);if(this._gizmo){this._gizmo._updateAxis();}};i.prototype.pickAnchorFromNodesList=function(n){var t=null;var m=-1;var j=new THREE.Vector3();(Array.isArray(n)?n:[n]).forEach(function(k){var l=new THREE.Box3();k._expandBoundingBox(l,false,true,true);var s=l.getSize(new THREE.Vector3()).manhattanLength();if(m<s){m=s;t=k;l.getCenter(j);}});if(t!==null){this.setAnchor(t.matrixWorld.clone().setPosition(j).elements);}return t;};i.prototype.setMagnitude=function(v){v=Math.max(v,0);this.setProperty("magnitude",v,true);if(this._gizmo){this._gizmo._setMagnitude(v);}};i.prototype.setSelectedItem=function(v){this.setAssociation("selectedItem",v);if(this._gizmo){this._gizmo._handleSelectedItemChanged();}};i.prototype._onGroupsChanged=function(j){this._groupObserver.disconnect();this.getItems().forEach(function(k){this._groupObserver.observe(k,{aggregations:["items"]});}.bind(this));if(this._gizmo){this._gizmo._handleGroupsChanged(j);}};i.prototype._onGroupChanged=function(j){if(this._gizmo){this._gizmo._handleGroupsChanged(j);}};i.prototype.reset=function(){this.getItems().forEach(function(j){j.setMagnitudeAdjustmentMultiplier(0);});this.setMagnitude(0);this.setType(c.Linear);this.setAxis(undefined);this.setDirection(undefined);};i.prototype._activateView=function(j){var s=this._viewport.getScene();var v=s.getViewStateManager();var k=s.getViews()[j];v.activateView(k);var l=this._viewport._viewStateManager.getAnimationPlayer();if(l){setTimeout(function(){l.play();},100);}};i.prototype._createView=function(j,n,v,o,k,l,s){var m=this._viewport.getScene();var p=m.getViewStateManager();var q=m.createView({name:n});var t=[];if(j){var r=j.getNodeInfos();r.forEach(function(D){var F={target:D.target,transform:D.transform?D.transform.slice():null,meshId:D.meshId,materialId:D.materialId,visible:D.visible,opacity:D.opacity};t.push(F);});}else{var u=p.getNodeHierarchy();var w=function(D){if(D.visible){t.push({target:D,visible:D.visible});}u.enumerateChildren(D,w,false,true);};u.enumerateChildren(null,w,false,true);}q.setNodeInfos(t);var x={name:n,nodes:[]};if(j){x.sourceId=j.getViewId();var y=this._viewport.getCamera();var z={origin:y.getPosition(),target:y.getTargetDirection(),up:y.getUpDirection(),ortho:y instanceof O};if(z.ortho){z.zoom=y.getZoomFactor();}else{z.fov=y.getFov()/180*Math.PI;}x.camera=z;var B=this._viewport._viewStateManager.getAnimationPlayer();if(B){x.time=B.getTime();}}t=[];this._gizmo._nodes.forEach(function(D){var F=D.node;var G=F.matrix.elements;var H=[D.local.x,D.local.y,D.local.z];if(k){var I=k.get(D.node);if(I!=null){H=I;}}if(G[12]!=H[0]||G[13]!=H[1]||G[14]!=H[2]){var J=[G[0],G[4],G[8],G[1],G[5],G[9],G[2],G[6],G[10],H[0],H[1],H[2]];x.nodes.push({sid:m.nodeRefToPersistentId(F),transform:J});t.push({target:F,transform:J});}});q.updateNodeInfos(t);var C=m.findViewGroupByView(j);x.groupIds=C?[C.getViewGroupId()]:[l];if(s!==null){x.sequence=s;}if(v){v.push(x);}return q;};i.prototype.generateRequestData=function(o,j){var p=o?o.viewPrefix:null;var k=[];var l=1.0;var s=this._viewport.getScene();var m=this._viewport.getCurrentView();var n=new Map();var q=new Map();var t=[];var r=[];var u=[];var w=[];var x=null;var y=[];var z=null;if(j){if(Array.isArray(j.views)){var B=j.views.findIndex(function(v){return v.id===m.getViewId();});if(B>=0){x=j.views[B].sequence+1;}y=j.views.slice(B+1);}z=j.id;}if(o&&o.animation&&o.animation.enabled){this.getItems().forEach(function(j){j.getItems().forEach(function(v){var Q=v.getNodeRef();Q.updateMatrixWorld();var R=(new THREE.Vector3()).setFromMatrixPosition(Q.matrixWorld);q.set(Q.uuid,R);});});this._gizmo._nodes.forEach(function(v){var Q=v.node;Q.matrix.elements[12]=v.local.x;Q.matrix.elements[13]=v.local.y;Q.matrix.elements[14]=v.local.z;Q.position.setFromMatrixPosition(Q.matrix);Q.updateMatrixWorld(true);n.set(Q,[v.local.x,v.local.y,v.local.z]);});}var C=this._createView(m,p?p:h().getText("EXPLODETOOL_VIEW"),k,n,null,z,x);var D=k[k.length-1];if(o&&o.animation&&o.animation.enabled){if(!o.animation.separateAnimations){o.animation.separateViews=false;}var F=o.animation.sequencePrefix;var G=1;var H=new Map();var I=null;var J=[];var K=[];var L="";this.getItems().forEach(function(j){u.push({name:j.getName()?j.getName():h().getText("EXPLODETOOL_GROUP_NODE",G),contentType:"REFERENCE",transform:[1,0,0,0,1,0,0,0,1,0,0,0]});D=k[k.length-1];if(o.animation.separateAnimations||o.animation.separateViews||G==1){if(J.length>0){r.push({name:L,endTime:l,joints:K,nodes:J});J=[];K=[];}if(o.animation.separateViews){L=h().getText("EXPLODETOOL_SEQUENCE_NAME",[D.name,1]);}else{L=h().getText("EXPLODETOOL_SEQUENCE_NAME",[D.name,G]);}L=F?h().getText("EXPLODETOOL_PREFIX_n",[F,G]):L;I=s.createSequence(C.getId()+"_seq"+G,{name:L,duration:l});var v=new A({sequence:I});C.addPlayback(v);C.resetPlaybacksStartTimes();if(!D.playbacks){D.playbacks=[];}D.playbacks.push({start:o.animation.separateViews?0:(G-1)*l,sequence:r.length});}var Q=s.createTrack(null,{trackValueType:g.Vector3,isAbsoluteValue:false});this._gizmo._nodes.forEach(function(R){if(R.group==j){var S=s.nodeRefToPersistentId(R.node);K.push(w.length);w.push({parent:G-1,childSid:S});var U=q.get(R.node.uuid);if(Q.getKeysCount()==0){var V=(new THREE.Vector3()).setFromMatrixPosition(R.node.matrixWorld);var W=[U.x-V.x,U.y-V.y,U.z-V.z];Q.insertKey(0,[0,0,0]);Q.insertKey(l,W);t.push({time:[0,l],vector3:[0,0,0,W[0],W[1],W[2]]});}I.setNodeAnimation(R.node,f.Translate,Q);H.set(R.node,[U.x,U.y,U.z]);}});J.push({node:G-1,rtranslate:{track:t.length-1}});G++;if(o.animation.separateViews&&G<=this.getItems().length){C=this._createView(m,p?h().getText("EXPLODETOOL_PREFIX_n",[p,G]):h().getText("EXPLODETOOL_VIEW_n",G),k,n,H,z,x?++x:x);}}.bind(this));if(J.length>0){r.push({name:L,endTime:l,joints:K,nodes:J});}}else{var N=[];D.nodes=[];this.getItems().forEach(function(j){j.getItems().forEach(function(v){var Q=v.getNodeRef();var R=Q.matrix.elements;var S=[R[0],R[4],R[8],R[1],R[5],R[9],R[2],R[6],R[10],R[12],R[13],R[14]];N.push({target:Q,transform:S});D.nodes.push({sid:s.nodeRefToPersistentId(Q),transform:S});});});C.updateNodeInfos(N);}var P=function(){var Q={data:{views:k}};y.forEach(function(v){Q.data.views.push({id:v.id,sequence:++x});});if(r.length>0){Q.data.tree={nodes:u};Q.data.animation={sequences:r,tracks:t,joints:w};}return Q;};return P();};return i;});
