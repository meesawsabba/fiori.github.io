/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./Gizmo","./TransformSvgElementToolGizmoRenderer","../svg/Element","./ToolNodeSet"],function(G,c,E,T){"use strict";var d=G.extend("sap.ui.vk.tools.TransformSvgElementToolGizmo",{metadata:{library:"sap.ui.vk"}});d.prototype.show=function(v,t){this._viewport=v;this._tool=t;this._nodes=[];this._cursor=null;this.handleSelectionChanged();v.attachCameraChanged(this._handleChanged,this);v._viewStateManager.attachTransformationChanged(this._handleChanged,this);};d.prototype.hide=function(){if(this._cursor){this._viewport.removeStyleClass(this._cursor);this._cursor=null;}this._viewport._viewStateManager.detachTransformationChanged(this._handleChanged,this);this._viewport.detachCameraChanged(this._handleChanged,this);this._viewport=null;this._tool=null;this._nodes=[];};d.prototype._handleChanged=function(){if(this.getDomRef()){this.rerender();}};d.prototype._getHandleLocalPositions=function(a,m){var b=a.bbox;var x=b.x;var i=b.x+b.width;var o=(x+i)*0.5;var y=b.y+b.height*0.5;var p=b.height*0.5*a.ySign;var q=y-p;var r=y+p;var s=q-48*a.ySign/(this._viewport._camera.zoom*Math.sqrt(m[2]*m[2]+m[3]*m[3]));return[o,q,i,q,i,y,i,r,o,r,x,r,x,y,x,q,o,s,o,y];};d.prototype._selectHandle=function(a,b){this._gizmoIndex=a;this._handleIndex=b;var i=null;if(a>=0){if(b>=0){if(b<8){var m=this._nodes[a];var o=m.node._matrixWorld();var p=Math.round(Math.atan2(o[2],o[3])*4/Math.PI);i=["NSResize","NESWResize","EWResize","NWSEResize"][(16-p+b*m.xSign*m.ySign)%4];}else{i="Rotate";}}else{i="Move";}i="sapUiVkTransformationToolCursor"+i;}if(this._cursor!=i){if(this._cursor){this._viewport.removeStyleClass(this._cursor);}if(i){this._viewport.addStyleClass(i);}this._cursor=i;}};function g(m){return{x:m[4],y:m[5]};}function e(m){return{x:Math.sqrt(m[0]*m[0]+m[1]*m[1]),y:Math.sqrt(m[2]*m[2]+m[3]*m[3])};}function f(m){return Math.atan2(m[0],m[1]);}function n(a){if(a<-Math.PI){return a+Math.PI*2;}else if(a>Math.PI){return a-Math.PI*2;}return a;}function h(a){var r=null;while(a.parent){r=a;a=a.parent;}return r&&r.matrix[3]<0?-1:1;}function j(v,a,b,i){return v*b+a*i;}function k(m){return m[0]*m[3]-m[1]*m[2];}d.prototype.handleSelectionChanged=function(){var a=this._viewport?this._viewport._viewStateManager:null;if(a===null){return;}var b=[];if(this._tool){a[this._tool.getNodeSet()===T.Highlight?"enumerateSelection":"enumerateOutlinedNodes"](function(i){var m=i._matrixWorld();var x=k(m)<0?-1:1;if(i.parent){m=E._multiplyMatrices(E._invertMatrix(i.parent._matrixWorld()),m);}b.push({node:i,bbox:i._getBBox(),position:g(m),scale:e(m),angle:f(m),xSign:x,ySign:h(i)});});}if(this._nodes.length===b.length&&this._nodes.every(function(v,i){return b[i].node===v.node;})){return;}this._nodes=b;if(this.getDomRef()){this.rerender();}};d.prototype._beginGesture=function(){this._nodes.forEach(function(a){var b=a.node;a.beginWorldMatrix=b._matrixWorld();a.bbox=b._getBBox();});this._eventParameters=null;};function l(i,m,o,p,q,r){var a=j(i,m,o+q,p+r);var b=j(i,m,o,p);return b!==0?a/b:1;}d.prototype._update=function(a,b,i){var o=this._handleIndex;var p=o>=0&&o<8?(o+4)%8:9;var s=1,q=1,r=1,t=0;var u=[];var v;var w={nodesProperties:u};if(o<0){v="moving";w.x=a;w.y=b;}else{var x=this._nodes[this._gizmoIndex];var m=x.beginWorldMatrix;var y=this._getHandleLocalPositions(x,m);if(o<8){v="scaling";var z=y[p*2];var A=y[p*2+1];var B=y[o*2];var C=y[o*2+1];var D=j(B-z,C-A,m[0],m[2]);var F=j(B-z,C-A,m[1],m[3]);s=o===0||o===4?1:l(m[0],m[1],D,F,a,b);q=o===2||o===6?1:l(m[2],m[3],D,F,a,b);if(this._tool.getUniformScaleEnabled()^i){if(o===0||o===4){s=q;}else if(o===2||o===6){q=s;}else{s=q=Math.max(s,q);}}w.x=s;w.y=q;}else{v="rotating";var H=E._transformPoint(y[18],y[19],m);var I=E._transformPoint(y[16],y[17],m);var J=Math.atan2(I.x-H.x,I.y-H.y);var K=Math.atan2(I.x-H.x+a,I.y-H.y+b);var L=n(K-J);w.angle=L;r=Math.cos(L);t=Math.sin(L);}}this._nodes.forEach(function(M){var N=M.node;var O=M.beginWorldMatrix.slice();var P={node:N};if(o<0){O[4]+=a;O[5]+=b;}else{var y=this._getHandleLocalPositions(M,O);if(o<8){var Q=y[p*2];var R=y[p*2+1];O[4]+=(Q*O[0]+R*O[2]);O[5]+=(Q*O[1]+R*O[3]);O[0]*=s;O[1]*=s;O[2]*=q;O[3]*=q;O[4]-=(Q*O[0]+R*O[2]);O[5]-=(Q*O[1]+R*O[3]);}else{var H=E._transformPoint(y[18],y[19],O);var S=new Float32Array([r,-t,t,r,H.x-(H.x*r+H.y*t),H.y-(H.x*-t+H.y*r)]);O=E._multiplyMatrices(S,O);}}M.xSign=k(O)<0?-1:1;if(N.parent){O=E._multiplyMatrices(E._invertMatrix(N.parent._matrixWorld()),O);}if(o<0){var U=g(O);P.x=U.x-M.position.x;P.y=U.y-M.position.y;}else if(o<8){var V=e(O);P.x=V.x/M.scale.x;P.y=V.y/M.scale.y;}else{P.angle=n(f(O)-M.angle);}N.setMatrix(O);u.push(P);}.bind(this));this.rerender();this._eventParameters=w;this._tool.fireEvent(v,w,true);};d.prototype._endGesture=function(){if(this._eventParameters){var a=this._handleIndex;var b;if(a<0){b="moved";}else if(a<8){b="scaled";}else{b="rotated";}this._tool.fireEvent(b,this._eventParameters,true);}};return d;});
