/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../getResourceBundle","../thirdparty/three","./Gizmo","./AxisColours","./ExplodeAxis","./ExplodeDirection","./ExplodeType","../AnimationTrackType","sap/base/assert","sap/base/Log","sap/ui/core/Core"],function(g,t,G,A,E,c,e,f,h,L,j){"use strict";var k=G.extend("sap.ui.vk.tools.ExplodeToolGizmo",{metadata:{library:"sap.ui.vk"}});var l=96;var T=48;var H={PositiveX:0,PositiveY:1,PositiveZ:2,NegativeX:3,NegativeY:4,NegativeZ:5,ResetAdjustment:6,AdjustUp:7,AdjustDown:8,MoveUp:9,MoveDown:10};k.prototype.init=function(){if(G.prototype.init){G.prototype.init.apply(this);}this._createEditingForm(g().getText("TOOL_UNITS_MM"),84);this._moveDelta=new THREE.Vector3();this._anchorPosition=new THREE.Vector3();this._axisDirection=new THREE.Vector3();this._axisColor=0;this._magnitude=0;this._viewport=null;this._tool=null;this._groups=[];this._nodes=[];this._groupsMap=new Map();this._sceneGizmo=new THREE.Scene();var i=new THREE.AmbientLight(0xFFFFFF,0.5);i.layers.enableAll();this._sceneGizmo.add(i);var n=new THREE.DirectionalLight(0xFFFFFF,0.5);n.position.set(1,3,2);n.layers.enableAll();this._sceneGizmo.add(n);this._gizmo=new THREE.Group();this._touchAreas=new THREE.Group();this._touchAreas2=new THREE.Group();this._sceneGizmo.add(this._gizmo);this._matViewProj=new THREE.Matrix4();var o=new THREE.MeshLambertMaterial({color:0x0080FF,transparent:true,opacity:0.2});function p(a,b,y,z){var B=1,C=4,D=24;var F=new THREE.MeshLambertMaterial({color:y});var I=new THREE.CylinderBufferGeometry(B,B,a-D,4);var J=new THREE.Vector3(b.y,b.z,b.x);var q=new THREE.Vector3(b.z,b.x,b.y);var m=b.x<0||b.y<0||b.z<0?new THREE.Matrix4().makeBasis(q,b,J):new THREE.Matrix4().makeBasis(J,b,q);m.setPosition(b.clone().multiplyScalar((a-D)*0.5));I.applyMatrix4(m);var K=new THREE.Mesh(I,F);K.matrixAutoUpdate=false;K.userData.color=y;var M=new THREE.CylinderBufferGeometry(0,C,D,12,1);m.setPosition(b.clone().multiplyScalar(a-D*0.5));M.applyMatrix4(m);var N=new THREE.Mesh(M,F);N.matrixAutoUpdate=false;K.add(N);if(z){var O=new THREE.CylinderGeometry(T*0.5,T*0.5,a-T+D*0.5,12,1);m.setPosition(b.clone().multiplyScalar(T+O.parameters.height*0.5));O.applyMatrix4(m);var P=new THREE.CylinderGeometry(T*0.5,0,T,12,1);m.setPosition(b.clone().multiplyScalar(T*0.5));O.merge(P,m);z.add(new THREE.Mesh(O,o));}return K;}this._gizmo.add(p(l,new THREE.Vector3(1,0,0),A.x,this._touchAreas));this._gizmo.add(p(l,new THREE.Vector3(0,1,0),A.y,this._touchAreas));this._gizmo.add(p(l,new THREE.Vector3(0,0,1),A.z,this._touchAreas));this._gizmo.add(p(l,new THREE.Vector3(-1,0,0),A.x,this._touchAreas));this._gizmo.add(p(l,new THREE.Vector3(0,-1,0),A.y,this._touchAreas));this._gizmo.add(p(l,new THREE.Vector3(0,0,-1),A.z,this._touchAreas));this._axisTitles=this._createAxisTitles(undefined,undefined,false,true);this._sceneGizmo.add(this._axisTitles);var d=32;var q=d*1.75;this._groupGizmo=new THREE.Group();this._sceneGizmo.add(this._groupGizmo);var s=new THREE.Mesh(new THREE.IcosahedronBufferGeometry(8,1),new THREE.MeshLambertMaterial());this._groupGizmo.add(s);this._groupGizmo.add(p(d*1.5,new THREE.Vector3(0,1,0),0xFFFFFF));this._groupGizmo.add(p(d*1.5,new THREE.Vector3(0,-1,0),0xFFFFFF));var r=16;var u=new THREE.CylinderGeometry(0,6,r,16).applyMatrix4(new THREE.Matrix4().setPosition(0,q+r*0.5,0));u.merge(new THREE.CylinderGeometry(0,6,r,16),new THREE.Matrix4().setPosition(0,q+r*1.5,0));this._groupGizmo.add(new THREE.Mesh(new THREE.BufferGeometry().fromGeometry(u),new THREE.MeshLambertMaterial()));this._groupGizmo.add(new THREE.Mesh(new THREE.BufferGeometry().fromGeometry(u.rotateX(Math.PI)),new THREE.MeshLambertMaterial()));this._groupGizmo.add(new THREE.Mesh(new THREE.CylinderGeometry(16,16,d*6,12,1),new THREE.MeshBasicMaterial({color:0xFFFFFF,transparent:true,opacity:0.5,side:THREE.BackSide})));function v(a,b,m){var y=new THREE.IcosahedronGeometry(T*0.5,1);y.applyMatrix4(new THREE.Matrix4().setPosition(0,(a+b)*0.5,0));m.add(new THREE.Mesh(y,o));}v(d*-0.5,d*0.5,this._touchAreas2);v(d*0.5,d*1.5,this._touchAreas2);v(d*-1.5,d*-0.5,this._touchAreas2);v(q,q+d,this._touchAreas2);v(-q-d,-q,this._touchAreas2);function w(a){a.traverse(function(b){b.layers.enableAll();});}function x(a){a.children.forEach(function(b,m){b.traverse(function(y){y.layers.enable(Math.min(m,6)+1);});});}x(this._gizmo);x(this._axisTitles);x(this._touchAreas);w(this._groupGizmo);w(this._touchAreas2);};k.prototype.hasDomElement=function(){return false;};k.prototype.show=function(v,a){this._viewport=v;this._tool=a;this._nodes.length=0;this._handleGroupsChanged();};k.prototype.hide=function(){this._cleanTempData();this._viewport=null;this._tool=null;this._updateEditingForm(false);};k.prototype.getGizmoCount=function(){if(!this._groups.length){return 0;}return this._getActiveAxisIndex()>=0&&this._magnitude>0&&this._getSelectedItem()?2:1;};k.prototype.getTouchObject=function(i){if(i===0){this._updateGizmoObjectTransformation(this._touchAreas);return this._touchAreas;}else{this._updateGroupGizmoTransformation(this._touchAreas2);return this._touchAreas2;}};k.prototype._handleGroupsChanged=function(a){this._setMagnitude(0);var b=this._groupsMap;b.clear();this._groups=this._tool.getItems().slice();var n=this._nodes=[];this._groups.forEach(function(d){var m=d.getItems();for(var i=0;i<m.length;i++){var o=m[i].getNodeRef();b.set(o,d);var p=new THREE.Box3();o._expandBoundingBox(p,false,true,true);n.push({node:o,center:p.getCenter(new THREE.Vector3()),group:d,local:new THREE.Vector3().setFromMatrixPosition(o.matrix),origin:new THREE.Vector3().setFromMatrixPosition(o.matrixWorld),matParentInv:o.parent?new THREE.Matrix4().getInverse(o.parent.matrixWorld):new THREE.Matrix4()});}});this._calculateGroupOffsets();this._setMagnitude(this._tool.getMagnitude());};k.prototype._getSelectedItem=function(){return j.byId(this._tool.getSelectedItem());};k.prototype._handleSelectedItemChanged=function(){var v=this._viewport._viewStateManager;var o=new Set();var s=this._getSelectedItem();if(s){s.getItems().forEach(function(i){o.add(i.getNodeRef());});}var u=[];v.enumerateOutlinedNodes(function(n){if(!o.has(n)){u.push(n);}});v.setOutliningStates(Array.from(o),u,false);};k.prototype.highlightHandle=function(a,b){this._handleIndex=a;this._gizmo.children.forEach(function(d,i){var m=a===i;var n=m?0xFFFF00:d.userData.color;d.material.color.setHex(n);this._axisTitles.children[i].material.color.setHex(n);}.bind(this));for(var i=0;i<5;i++){this._groupGizmo.children[i].material.color.setHex(i+6===a?0xFFFF00:this._axisColor);}};k.prototype._calculateGroupOffsets=function(){var a=this._axisDirection;if(this._tool.getType()===e.Linear){var d=new THREE.Vector3(Math.abs(a.x),Math.abs(a.y),Math.abs(a.z));var s=new THREE.Vector3();var b=0,m=0;this._groups.forEach(function(i,p){var q=i.getBoundingBox();q.getCenter(i._center);q.getSize(s);b=d.dot(s);if(p>0){m+=b*0.5;}i._offset=m;i._deltaOffset=b*0.5;m+=b*0.5;});m+=b*0.5;var o=m>0?1/m:1;this._groups.forEach(function(i){i._offset=1-i._offset*o;i._deltaOffset*=o;});}else{var n=1/this._groups.length;this._groups.forEach(function(p,q){var r=p.getBoundingBox();r.getCenter(p._center);p._offset=1-q*n;p._deltaOffset=n*0.5;var u=-1;var v=new THREE.Vector3();var w=p.getItems();for(var i=0;i<w.length;i++){var x=w[i].getNodeRef();var y=new THREE.Box3();x._expandBoundingBox(y,false,true,true);var s=y.getSize(new THREE.Vector3()).manhattanLength();if(u<s){u=s;y.getCenter(v);}}});}};k.prototype._getActiveAxisIndex=function(){var a=this._tool.getAxis();var d=this._tool.getDirection();var i=a&&d?[E.X,E.Y,E.Z].indexOf(a):-1;if(i>=0&&d===c.Negative){i+=3;}return i;};k.prototype._recalculateOffsets=function(){this._setMagnitude(0);this._calculateGroupOffsets();this._setMagnitude(this._tool.getMagnitude());this._viewport.setShouldRenderFrame();};k.prototype._updateAxis=function(){var a=this._getActiveAxisIndex();if(a>=0){this._updateGizmoObjectTransformation(this._gizmo);this._axisDirection.setFromMatrixColumn(this._gizmo.matrixWorld,a%3).normalize().multiplyScalar(a<3?1:-1);this._anchorPosition.setFromMatrixPosition(this._gizmo.matrixWorld);this._axisColor=this._gizmo.children[a].userData.color;for(var i=0;i<5;i++){this._groupGizmo.children[i].material.color.setHex(this._axisColor);}this._recalculateOffsets();}else{this._setMagnitude(0);this._viewport.setShouldRenderFrame();}};k.prototype._moveSelectedGroup=function(d){var a=this._tool;var s=this._getSelectedItem();var i=a.getItems();var b=i.indexOf(s);if(b>=0&&b+d>=0&&b+d<i.length){a.removeItem(s);a.insertItem(s,b+d);a.fireItemSequenceChangePressed({item:s,moveUp:d<0});}};k.prototype._setMagnitudeAdjustmentMultiplier=function(v,a){var s=this._getSelectedItem();if(s){s.setMagnitudeAdjustmentMultiplier(v);this._updatePositions();this._tool[a?"fireItemPositionAdjusted":"fireItemPositionAdjusting"]({item:s,magnitudeAdjustmentMultiplier:s.getMagnitudeAdjustmentMultiplier()});}};k.prototype._beginGesture=function(){this._moveDelta.setScalar(0);this._beginMagnitude=this._magnitude;var a=this._tool;switch(this._handleIndex){case H.ResetAdjustment:this._setMagnitudeAdjustmentMultiplier(0,true);break;case H.AdjustUp:case H.AdjustDown:var s=this._getSelectedItem();this._magnitudeAdjustmentMultiplier=s?s.getMagnitudeAdjustmentMultiplier():0;break;case H.MoveUp:this._moveSelectedGroup(-1);break;case H.MoveDown:this._moveSelectedGroup(+1);break;default:if(this._handleIndex<6&&(!a.getAxis()||!a.getDirection())){a.setAxis([E.X,E.Y,E.Z][this._handleIndex%3]);a.setDirection(this._handleIndex<3?c.Positive:c.Negative);a.fireAxisSelected({axis:a.getAxis(),direction:a.getDirection()});}break;}};k.prototype._setMagnitude=function(m){this._magnitude=m;this._groups.forEach(function(a){a._magnitude=m;});this._updatePositions();};k.prototype._setOffset=function(o){var a=this._tool;if(this._handleIndex<6){a.setMagnitude(this._beginMagnitude+o);a.fireMagnitudeChanging({type:a.getType(),axis:a.getAxis(),direction:a.getDirection(),magnitude:a.getMagnitude()});}else if(this._handleIndex===H.AdjustUp||this._handleIndex===H.AdjustDown){var s=this._magnitude>0?this._getSelectedItem():null;if(s){this._setMagnitudeAdjustmentMultiplier(this._magnitudeAdjustmentMultiplier+o/(this._magnitude*s._deltaOffset));}}};k.prototype._updatePositions=function(){var a=this._tool.getType()===e.Linear;var p=new THREE.Vector3();var d=new THREE.Vector3();var b=new THREE.Vector3();this._nodes.forEach(function(n){var i=n.node;if(a){d.copy(this._axisDirection);}else{d.copy(n.center).sub(this._anchorPosition);b.copy(this._axisDirection).multiplyScalar(d.dot(b));d.sub(b).normalize();}d.multiplyScalar(n.group.getMagnitude());p.copy(n.origin).add(d);i.matrixWorld.setPosition(p);i.matrix.multiplyMatrices(n.matParentInv,i.matrixWorld);i.position.setFromMatrixPosition(i.matrix);i.updateMatrixWorld(true);}.bind(this));this._viewport.setShouldRenderFrame();};k.prototype._endGesture=function(){var a=this._tool;if(this._handleIndex<6){a.fireMagnitudeChanged({type:a.getType(),axis:a.getAxis(),direction:a.getDirection(),magnitude:a.getMagnitude()});}else if(this._handleIndex===H.AdjustUp||this._handleIndex===H.AdjustDown){var s=this._magnitude>0?this._getSelectedItem():null;if(s){a.fireItemPositionAdjusted({item:s,magnitudeAdjustmentMultiplier:s.getMagnitudeAdjustmentMultiplier()});}}};k.prototype.expandBoundingBox=function(b){if(this._viewport){this._expandBoundingBox(b,this._viewport.getCamera().getCameraRef(),true);}};k.prototype._updateGizmoObjectTransformation=function(o){o.matrix.fromArray(this._tool.getAnchor());o.matrix.decompose(o.position,o.quaternion,o.scale);var s=this._getGizmoScale(o.position);o.scale.setScalar(s);o.matrixAutoUpdate=true;o.updateMatrixWorld(true);return s;};k.prototype._updateGroupGizmoTransformation=function(o){var a=this._getActiveAxisIndex();var s=a>=0&&this._magnitude>0?this._getSelectedItem():null;o.visible=!!s;if(s){if(this._tool.getType()===e.Linear){o.position.copy(this._axisDirection).multiplyScalar(s.getMagnitude()).add(s._center);}else{o.position.copy(s._center);}o.quaternion.setFromUnitVectors(new THREE.Vector3(0,1,0),this._axisDirection);o.scale.setScalar(this._getGizmoScale(o.position));o.updateMatrix();o.updateMatrixWorld();}};k.prototype._updateGizmoTransformation=function(i,a){this._updateGizmoObjectTransformation(this._gizmo);};k.prototype._getCameraLayersMask=function(){var m=0|0;var a=this._getActiveAxisIndex();m=1<<(a+1);if(a>=0&&this._magnitude>0&&this._getSelectedItem()){m|=1<<7;}return m;};k.prototype.render=function(){h(this._viewport&&this._viewport.getMetadata().getName()==="sap.ui.vk.threejs.Viewport","Can't render gizmo without sap.ui.vk.threejs.Viewport");if(this._tool&&this._groups.length>0){var r=this._viewport.getRenderer(),a=this._viewport.getCamera().getCameraRef();this._matViewProj.multiplyMatrices(a.projectionMatrix,a.matrixWorldInverse);r.clearDepth();var s=this._updateGizmoObjectTransformation(this._gizmo);this._updateAxisTitles(this._axisTitles,this._gizmo,a,l+18,s);this._updateGroupGizmoTransformation(this._groupGizmo);var m=a.layers.mask;a.layers.mask=this._getCameraLayersMask();r.render(this._sceneGizmo,a);a.layers.mask=m;}};return k;});
