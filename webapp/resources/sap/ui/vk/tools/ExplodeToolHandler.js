sap.ui.define(["sap/ui/base/EventProvider","./ExplodeToolGizmo","../thirdparty/three"],function(E,a,t){"use strict";var b=E.extend("sap.ui.vk.tools.ExplodeToolHandler",{metadata:{},constructor:function(c){this._priority=13;this._tool=c;this._gizmo=c.getGizmo();this._rect=null;this._rayCaster=new THREE.Raycaster();this._handleIndex=-1;this._handleAxis=new THREE.Vector3();this._gizmoOrigin=new THREE.Vector3();this._mouse=new THREE.Vector2();}});b.prototype._updateMouse=function(e){var s=this.getViewport().getRenderer().getSize(new THREE.Vector2());this._mouse.x=((e.x-this._rect.x)/s.width)*2-1;this._mouse.y=((e.y-this._rect.y)/s.height)*-2+1;this._rayCaster.setFromCamera(this._mouse,this.getViewport().getCamera().getCameraRef());this._rayCaster.far=Infinity;};b.prototype._updateHandles=function(e,h){var p=this._handleIndex;this._handleIndex=-1;if(e.n===1||(e.event&&e.event.type==="contextmenu")){this._rayCaster.layers.mask=this._gizmo._getCameraLayersMask();for(var i=0,l=this._gizmo.getGizmoCount();i<l;i++){var c=this._gizmo.getTouchObject(i);var f=this._rayCaster.intersectObject(c,true);if(f.length>0){this._handleIndex=c.children.indexOf(f[0].object);if(this._handleIndex>=0){this._rayCaster.far=f[0].distance;this._gizmoOrigin.setFromMatrixPosition(c.matrixWorld);if(i===0){this._handleAxis.setFromMatrixColumn(c.matrixWorld,this._handleIndex%3).normalize().multiplyScalar(this._handleIndex<3?1:-1);}else{this._handleAxis.copy(this._gizmo._axisDirection);this._handleIndex+=6;}}}}}this._gizmo.highlightHandle(this._handleIndex,h||this._handleIndex===-1);if(p!==this._handleIndex){this.getViewport().setShouldRenderFrame();}};b.prototype.hover=function(e){if(this._inside(e)&&!this._gesture){this._updateMouse(e);this._updateHandles(e,true);e.handled|=this._handleIndex>=0;}};b.prototype.click=function(e){if(this._inside(e)&&!this._gesture){if(this._handleIndex<0){var h=this.getViewport().hitTest(e.x-this._rect.x,e.y-this._rect.y);if(!h){this._tool.setSelectedItem(null);return;}var n=h.object;var g=this._tool.getGizmo()._groupsMap;var c=null;while(n){c=g.get(n);if(c){this._tool.setSelectedItem(c);e.handled=true;break;}n=n.parent;}}else{e.handled=this._handleIndex>=0;}}};var d=new THREE.Vector3();b.prototype._getAxisOffset=function(){var r=this._rayCaster.ray;var c=this._handleAxis.clone().cross(r.direction).cross(r.direction).normalize();d.copy(r.origin).sub(this._gizmoOrigin);return c.dot(d)/c.dot(this._handleAxis);};b.prototype._getPlaneOffset=function(){var r=this._rayCaster.ray;d.copy(this._gizmoOrigin).sub(r.origin);var c=this._handleAxis.dot(d)/this._handleAxis.dot(r.direction);return r.direction.clone().multiplyScalar(c).sub(d);};b.prototype.beginGesture=function(e){if(this._inside(e)&&!this._gesture){this._updateMouse(e);this._updateHandles(e,false);if(this._handleIndex>=0){this._gesture=true;e.handled=true;this._gizmo._beginGesture(this._handleIndex);this._dragOrigin=this._getAxisOffset();}}};b.prototype.move=function(e){if(this._gesture){e.handled=true;this._updateMouse(e);var o=this._getAxisOffset()-this._dragOrigin;if(isFinite(o)){this._gizmo._setOffset(o);}}};b.prototype.endGesture=function(e){if(this._gesture){this._gesture=false;e.handled=true;this._updateMouse(e);this._gizmo._endGesture();this._dragOrigin=undefined;this._updateHandles(e,true);this.getViewport().setShouldRenderFrame();}};b.prototype.contextMenu=function(e){};b.prototype.getViewport=function(){return this._tool._viewport;};b.prototype._getOffset=function(o){var r=o.getBoundingClientRect();var p={x:r.left+window.pageXOffset,y:r.top+window.pageYOffset};return p;};b.prototype._inside=function(e){if(this._rect===null||true){var i=this._tool._viewport.getIdForLabel();var c=document.getElementById(i);if(c===null){return false;}var o=this._getOffset(c);this._rect={x:o.x,y:o.y,w:c.offsetWidth,h:c.offsetHeight};}return(e.x>=this._rect.x&&e.x<=this._rect.x+this._rect.w&&e.y>=this._rect.y&&e.y<=this._rect.y+this._rect.h);};return b;});
