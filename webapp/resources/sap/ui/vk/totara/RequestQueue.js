sap.ui.define(["./TotaraUtils","./Command","../IncludeUsageIdType","sap/base/Log"],function(T,C,I,L){"use strict";function R(g){this.getBatchSize=g;this.globalList=new Set();this.requestedList=[];this.waitingList=new Map();}R.prototype.push=function(i,r){if(!this.globalList.has(i)){this.globalList.add(i);this.requestedList.push(r||i);this.waitingList.set(i,r);}};R.prototype.setBatchSizeInfo=function(b){this.batchSizeInfo=b;};R.prototype.fetchBatch=function(){var b=this.getBatchSize?this.getBatchSize:1;if(typeof this.getBatchSize==="function"){b=this.getBatchSize();}var a=0;var d=[];for(var i=0;i<b&&this.requestedList.length>0;i++){var r=this.requestedList.pop();var e=r.id?r.id:r;a+=e.toString().length+(i==0||!this.batchSizeInfo?0:this.batchSizeInfo.separatorLength);if(this.batchSizeInfo&&a>this.batchSizeInfo.maxBatchStringLength){this.requestedList.push(e);break;}d.push(e);}return d;};R.prototype.pop=function(i){var a=this.requestedList.indexOf(i);if(a>-1){this.requestedList.splice(a,1);}return this.waitingList.delete(i);};R.prototype.isReady=function(i){return this.globalList.has(i)&&!this.waitingList.has(i);};R.prototype.clear=function(i){this.globalList.clear();this.requestedList=[];this.waitingList.clear();};R.prototype.isEmpty=function(){return this.requestedList.length===0;};R.prototype.isWaiting=function(){return this.waitingList.size>0;};R.prototype.isInitialViewCompleted=function(){var i=this.requestedList.filter(function(l){return l.isInitial;});var a=[];this.waitingList.forEach(function(v,k){if(v&&v.isInitial){a.push(k);}});return(i.length===0&&a.length===0);};function P(g,a){R.call(this,g);this.getMaxBatchDataSize=a;this.priorityMap=new Map();}P.prototype=Object.create(R.prototype);P.prototype.constructor=P;P.prototype.push=function(i,p,s,r){if(!this.globalList.has(i)){s=s||1;this.globalList.add(i);this.requestedList.push(r||i);this.waitingList.set(i,r);this.priorityMap.set(i,{p:p,s:s});}};P.prototype.clear=function(){R.prototype.clear.call(this);this.priorityMap.clear();};P.prototype.setBatchSizeInfo=function(b){this.batchSizeInfo=b;};P.prototype.fetchBatch=function(){var p=this.priorityMap;this.requestedList.sort(function(a,b){return p.get(a.id?a.id:a).p-p.get(b.id?b.id:b).p;});var d=[];var s=0;var e=this.getBatchSize?this.getBatchSize():1;var f=0;var m=this.getMaxBatchDataSize?this.getMaxBatchDataSize():1024*1024;var g=m>>1;for(var i=0;i<e&&this.requestedList.length>0;i++){var r=this.requestedList.pop();var h=r.id?r.id:r;f+=h.toString().length+(i==0||!this.batchSizeInfo?0:this.batchSizeInfo.separatorLength);var j=p.get(h).s;if(this.batchSizeInfo&&f>this.batchSizeInfo.maxBatchStringLength||s>g&&s+j>m){this.requestedList.push(h);break;}s+=j;p.delete(h);d.push(h);}return d;};var c=function(a,s){this.context=a;this.sceneId=s;this.token=a.token||T.generateToken();var l=a.loader;this.meshes=new R(l.getMeshesBatchSize.bind(l));this.materials=new R(l.getMaterialsBatchSize.bind(l));this.textures=new R();this.geometries=new P(l.getGeometriesBatchSize.bind(l),l.getGeometriesMaxBatchDataSize.bind(l));this.geomMeshes=new P(l.getGeomMeshesBatchSize.bind(l),l.getGeomMeshesMaxBatchDataSize.bind(l));this.annotations=new R(l.getAnnotationsBatchSize.bind(l));this.parametric=new R(l.getParametricsBatchSize.bind(l));this.views=new R();this.thumbnails=new R();this.tracks=new R(l.getTracksBatchSize.bind(l));this.sequences=new R(l.getSequencesBatchSize.bind(l));this.highlights=new R();};c.prototype.isEmpty=function(){return this.meshes.isEmpty()&&this.annotations.isEmpty()&&this.parametric.isEmpty()&&this.materials.isEmpty()&&this.textures.isEmpty()&&this.geometries.isEmpty()&&this.geomMeshes.isEmpty()&&this.views.isEmpty()&&this.thumbnails.isEmpty()&&this.tracks.isEmpty()&&this.sequences.isEmpty()&&this.highlights.isEmpty();};c.prototype.isWaitingForContent=function(){return this.meshes.isWaiting()||this.textures.isWaiting()||this.materials.isWaiting()||this.geometries.isWaiting()||this.geomMeshes.isWaiting()||this.annotations.isWaiting()||this.parametric.isWaiting()||this.views.isWaiting()||this.thumbnails.isWaiting()||this.tracks.isWaiting()||this.sequences.isWaiting()||this.highlights.isWaiting();};c.prototype.clearContent=function(){this.meshes.clear();this.annotations.clear();this.parametric.clear();this.materials.clear();this.textures.clear();this.geometries.clear();this.geomMeshes.clear();this.views.clear();this.thumbnails.clear();this.tracks.clear();this.sequences.clear();this.highlights.clear();};c.prototype.createGetContentCommand=function(a,i,e){var o={sceneId:this.sceneId,ids:i.map(function(b){return parseInt(b,10);}),token:this.token};return T.createRequestCommand(a,e?Object.assign(o,e):o);};c.prototype.generateRequestCommand=function(){var a;var b=null;if(!this.meshes.isEmpty()){a=this.meshes.fetchBatch();throw new Error("Command "+C.getMesh+" is not implemented");}else if(!this.annotations.isEmpty()){a=this.annotations.fetchBatch();b={method:C.getAnnotation,parameters:{sceneId:this.sceneId,annotationIds:a}};}else if(!this.parametric.isEmpty()){a=this.parametric.fetchBatch();throw new Error("Command "+C.getParametric+" is not implemented");}else if(!this.materials.isEmpty()){a=this.materials.fetchBatch();b={method:C.getMaterial,parameters:{sceneId:this.sceneId,materialIds:a}};}else if(!this.geometries.isEmpty()){a=this.geometries.fetchBatch();throw new Error("Command "+C.getGeometry+" is not implemented");}else if(!this.geomMeshes.isEmpty()){a=this.geomMeshes.fetchBatch();var g=a.map(function(i){return(i.id?i.id:i);});b=this.createGetContentCommand(C.getGeomMesh,g);b.sceneId=this.sceneId;b.meshIds=g;}else if(!this.textures.isEmpty()){a=this.textures.requestedList.splice(0,1);L.info("Requesting texture: "+a[0].imageId);b=this.createGetContentCommand(C.getImage,[a[0].imageId]);b.sceneId=this.sceneId;b=Object.assign(b,a[0]);}else if(!this.sequences.isEmpty()){a=this.sequences.fetchBatch();throw new Error("Command "+C.getSequence+" is not implemented");}else if(!this.tracks.isEmpty()){a=this.tracks.fetchBatch();throw new Error("Command "+C.getTrack+" is not implemented");}else if(!this.views.isEmpty()){a=this.views.requestedList.splice(0,1);var e=["nodes","bounds","highlight","annotation"];if(this.context.includeAnimation){e.push("animation");}if(this.context.includeParametric){e.push("parametric");}if(this.context.includeUsageId){e=e.concat(I.to$expandQueryParameter(this.context.includeUsageId));}if(this.context.pushPMI){e.push("pmi");}var s="name,transform,meshId,annotationId,materialId,contentType,visible,opacity,renderOrder,entityId,highlightStyleId,closed";b={method:C.getView,parameters:{sceneId:this.sceneId,viewId:a[0].viewId,query:{hidden:this.context.includeHidden,$select:s,$expand:e.join(",")}}};}else if(!this.highlights.isEmpty()){a=this.highlights.requestedList.splice(0,1);throw new Error("Command "+C.getHighlightStyle+" is not implemented");}else if(!this.thumbnails.isEmpty()){a=this.thumbnails.requestedList.splice(0,1);b=this.createGetContentCommand(C.getImage,[a[0].imageId]);b.sceneId=this.sceneId;b=Object.assign(b,a[0]);}return b;};return c;});
