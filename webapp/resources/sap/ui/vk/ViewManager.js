/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/Element","./Core","./Scene","sap/ui/core/Core"],function(E,v,S,c){"use strict";var V=E.extend("sap.ui.vk.ViewManager",{metadata:{interfaces:["sap.ui.vk.IViewManager"],properties:{autoPlayAnimation:{type:"boolean",defaultValue:true},autoAdvanceViewTimeout:{type:"int",defaultValue:1000}},associations:{contentConnector:{type:"sap.ui.vk.ContentConnector"},animationPlayer:{type:"sap.ui.vk.AnimationPlayer"}}},constructor:function(i,s){E.apply(this,arguments);v.observeLifetime(this);v.observeAssociations(this);}});V.prototype._setScene=function(s){if(this._scene!==s){this._scene=s;if(this._scene){var i=s.getInitialView();if(i){this.activateView(i);}}}return this;};V.prototype.getScene=function(){return this._scene;};V.prototype.getActiveView=function(){return this._activeView;};V.prototype.getNextView=function(a,b){var s=this.getScene();if(!b){b=s.findViewGroupByView(a);}var d;var i=-1;if(!b){d=s.getViews();i=d.indexOf(a);}else{d=b.getViews();i=b.indexOfView(a);}if(i<0){return undefined;}else if(i>=d.length-1){return undefined;}i++;return d[i];};V.prototype._setContent=function(a){var s=null;if(a&&a instanceof S){s=a;}this._setScene(s);};V.prototype.onSetContentConnector=function(a){a.attachContentReplaced(this._onContentReplaced,this);this._setContent(a.getContent());};V.prototype.onUnsetContentConnector=function(a){this._setContent(null);a.detachContentReplaced(this._onContentReplaced,this);};V.prototype._onContentReplaced=function(e){this._setContent(e.getParameter("newContent"));};V.prototype.activateView=function(a,n){return this._activateView(a,null,!this.getAutoPlayAnimation(),false,n);};V.prototype.playViewGroup=function(a,b){this._cancelPlayingViewGroup=false;if(a===this.getActiveView()){var d=c.byId(this.getAnimationPlayer());if(d){if(d.getTime()>=d.getTotalDuration()){d.setTime(0);}}return this._autoPlay(a,b,false,true);}this._activateView(a,b,false,true);return this;};V.prototype.stopPlayingViewGroup=function(){this._cancelPlayingViewGroup=true;var a=c.byId(this.getAnimationPlayer());if(a){a.stop();}};V.prototype._autoPlay=function(a,b,s,d){var e=v.getEventBus();var f=c.byId(this.getAnimationPlayer());var g=function(){if(this._cancelPlayingViewGroup){return;}var n=this.getNextView(a,b);if(n){this._activateView(n,b,s,d);}else{e.publish("sap.ui.vk","procedureFinished");}}.bind(this);var o=function(i,j,k){if(k.source!==f){return;}if(k.stopped){e.unsubscribe("sap.ui.vk","animationPlayStateChanged",o,this);if(k.endOfAnimation){g();}}};var h=function(){if(d){if(f&&a.hasAnimation()){e.subscribe("sap.ui.vk","animationPlayStateChanged",o,this);}else{setTimeout(function(){g();},this.getAutoAdvanceViewTimeout());}}if((!s||d)&&a.hasAnimation()){if(f){f.play();}else{}}}.bind(this);h();};V.prototype._activateView=function(a,b,s,d,n){var e=c.byId(this.getAnimationPlayer());if(e){e.stop();}this._cancelPlayingViewGroup=false;var t=this;return new Promise(function(r,f){var g=v.getEventBus();t._activeView=a;var o=function(h,i,j){g.unsubscribe("sap.ui.vk","readyForAnimation",o,t);if(j.view!==a){return;}if(t._cancelPlayingViewGroup){return;}t._autoPlay(a,b,s,d,true);r({view:j.view});return;};g.subscribe("sap.ui.vk","readyForAnimation",o,t);g.publish("sap.ui.vk","activateView",{source:t,view:a,notAnimateCameraChange:n,playViewGroup:d});});};return V;});
