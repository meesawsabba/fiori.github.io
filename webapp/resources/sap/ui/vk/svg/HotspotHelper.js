/*!
* SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
*/
sap.ui.define(["../NodeContentType","./Element","./Rectangle","sap/base/util/uid","../TransformationMatrix","../uuidv4"],function(N,E,R,u,T,a){"use strict";var H=function(){};H.prototype.createHotspot=function(s,p,j,n,b){var h=s.getDefaultNodeHierarchy().createNode(p,n,null,N.Hotspot,b);this.updateHotspot(h,j);return h;};H.prototype.removeHotspot=function(s,h){s.getDefaultNodeHierarchy().removeNode(h);};H.prototype.duplicateHotspot=function(h,p,t,v){h=Array.isArray(h)?h:[h];var m;if(t){m=E._multiplyMatrices(E._invertMatrix(h[0]._matrixWorld()),t);}else if(v){var r=v._camera._transformRect({x1:0,y1:0,x2:30,y2:30});m=[1,0,0,1,r.x2-r.x1,r.y2-r.y1];}var b=E._invertMatrix(p._matrixWorld());var n=[];h.forEach(function(c){var d=c.clone();d.userData.duplicatedFrom=c.sid;var e=E._multiplyMatrices(m,c._matrixWorld());var f=E._multiplyMatrices(b,e);d.matrix.set(f);p.add(d);n.push(d);});return n.length===1?n[0]:n;};H.prototype.updateHotspot=function(h,j,f){var i=h.children.length;while(i-->0){var c=h.children[i];if(c.userData.sourceJointNode!==undefined){h.remove(c);}}if(j){h.userData.jointNodes=Array.from(j);}var p=E._invertMatrix(h._matrixWorld());function b(d){d.traverse(function(c){if(c.nodeContentType===N.Hotspot||c.parent===h){return;}var e;if(c.type==="Image"){e=new R({x:c.x,y:c.y,width:c.width,height:c.height});}else if(c.type!=="Group"){e=new c.constructor().copy(c,false);}if(e){e.matrix=E._multiplyMatrices(p,c._matrixWorld());e.userData.sourceJointNode=c;h.add(e);}});}j=h.userData.jointNodes;if(j){j.forEach(function(d){if(d.nodeContentType!==N.Hotspot&&d.parent!==h){b(d);}});}h._initAsHotspot(f);};H.prototype.getHotspotRelatedNodes=function(h){if(h&&h.userData&&h.userData.jointNodes){return h.userData.jointNodes;}return[];};H.prototype.mergeHotspots=function(s,b){var c=s.getDefaultNodeHierarchy();var t=c.createNode(null,b[0].name,null,N.Hotspot,{sid:u()});var d=[],n=[];var e=E._invertMatrix(t._matrixWorld());var f=function(h,i){return i._vkGetNodeContentType()===h;};b.forEach(function(h){if(h.children.every(f.bind(null,N.Hotspot))){var i=h.children.length;while(i--){var q=h.children[0];var r=E._multiplyMatrices(e,q._matrixWorld());h.remove(q);t.add(q);q.matrix=r;d.push(q);}n.push(h);}else if(h.children.every(f.bind(null,N.Regular))){h.parent.remove(h);h.setOpacity();t.add(h);h.matrix=E._multiplyMatrices(e,h._matrixWorld());d.push(h);}});if(d){t.userData.jointNodes=Array.from(d);}c.removeNode(n);var g=[],p=[],j=[],l=[],k=[];var m={name:t.name,contentType:N.Hotspot,joints:[],children:[]};t.userData.jointNodes.forEach(function(h,i){var q=h.getParametricContent(j,l,k);p.push(q);g.push({name:h.name,transform:T.convert3x2To4x3(h.matrix),parametric:i,contentType:N.Hotspot});m.joints.push({child:i,type:"LINK",action:"bubble"});m.children.push(i);});g.push(m);b.forEach(function(h){g.push({suppressed:true,sid:h.sid});});var o=s.getViewStateManager().getCurrentView();return{nodeRef:t,request:{views:[{id:o.getViewId(),name:o.getName(),nodes:g}],parametrics:p,fillstyles:j,linestyles:l,textStyles:k}};};H.prototype.createRequest=function(e,v){if(!e||!v){return null;}var n=[];var p=[];var f=[];var l=[];var t=[];var b=v&&v._currentView;function c(d,s){s.setNodePersistentId(d,a());var g={name:d.name,transform:T.convert3x2To4x3(d.matrix),veId:d.sid};if(d.nodeContentType===N.Hotspot){g.contentType="HOTSPOT";}if(d.userData.duplicatedFrom){g.duplicatedFrom=d.userData.duplicatedFrom;delete d.userData.duplicatedFrom;}var h=d.getParametricContent(f,l,t);if(h){g.parametric=p.length;p.push(h);}var j=n.length;n.push(g);var k=d.children;if(k.length>0){var m=[];for(var i=0;i<k.length;i++){if(k[i].type==="Group"){m.push(c(k[i],s));}}if(m.length>0){g.children=m;}}return j;}var s=v.getScene();(Array.isArray(e)?e:[e]).forEach(function(d){c(d,s);});var r={views:[{id:b&&b.getViewId(),nodes:n}],parametrics:p};if(f.length>0){r.fillstyles=f;}if(l.length>0){r.linestyles=l;}if(t.length>0){r.textStyles=t;}return r;};return H;});
