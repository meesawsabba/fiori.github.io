/*!
* SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
*/
sap.ui.define(["sap/base/Log","../Core","../ViewStateManagerBase","../cssColorToColor","../colorToCSSColor","../abgrToColor","../colorToABGR","../AnimationTrackType","./Scene","./Element","sap/ui/core/Core"],function(L,v,V,c,a,b,d,A,S,E,e){"use strict";var f;var g=V.extend("sap.ui.vk.svg.ViewStateManager",{metadata:{}});var h=g.getMetadata().getParent().getClass().prototype;g.prototype.init=function(){if(h.init){h.init.call(this);}this._mask=(1|0);this._nodeHierarchy=null;this._selectedNodes=new Set();this._visibilityTracker=new f();this.setHighlightColor(0xBF0000BB);v.getEventBus().subscribe("sap.ui.vk","activateView",this._onActivateView,this);};g.prototype.exit=function(){v.getEventBus().unsubscribe("sap.ui.vk","activateView",this._onActivateView,this);};g.prototype._setContent=function(i){var s=null;if(i&&i instanceof S){s=i;}this._setScene(s);if(s){var l=s.getInitialView();if(l){this._currentView=l;this._resetNodesStatusByCurrentView(this._currentView);}}return this;};g.prototype._setScene=function(s){this._setNodeHierarchy(s?s.getDefaultNodeHierarchy():null);if(s){s.setViewStateManager(this);}this._scene=s;return this;};g.prototype._setNodeHierarchy=function(n){var o=this._nodeHierarchy;if(this._nodeHierarchy){this._nodeHierarchy=null;this._selectedNodes.clear();this._visibilityTracker.clear();}if(n){this._nodeHierarchy=n;this._nodeHierarchy.attachNodeReplaced(this._handleNodeReplaced,this);this._nodeHierarchy.attachNodeUpdated(this._handleNodeUpdated,this);this._nodeHierarchy.attachNodeRemoving(this._handleNodeRemoving,this);this._initialState={visible:[],hidden:[]};var t=this;var i=n.findNodesByName();i.forEach(function(l){(l.isVisible(t._mask)?t._initialState.visible:t._initialState.hidden).push(l);});this.fireVisibilityChanged({visible:this._initialState.visible,hidden:this._initialState.hidden});}if(n!==o){this.fireNodeHierarchyReplaced({oldNodeHierarchy:o,newNodeHierarchy:n});}return this;};g.prototype._handleNodeReplaced=function(i){var r=i.getParameter("ReplacedNodeRef");var l=i.getParameter("ReplacementNodeRef");if(this.getSelectionState(r)){this.setSelectionState(l,true);this.setSelectionState(r,false);}};g.prototype._handleNodeUpdated=function(i){var n=i.getParameter("nodeRef");if(this.getSelectionState(n)){this.setSelectionState(n,false);this.setSelectionState(n,true);}};g.prototype._handleNodeRemoving=function(i){var n=i.getParameter("nodeRef");if(this.getSelectionState(n)){this.setSelectionState(n,false,true,true);}};g.prototype.getNodeHierarchy=function(){return this._nodeHierarchy;};g.prototype.getVisibilityChanges=function(){return this.getShouldTrackVisibilityChanges()?this._visibilityTracker.getInfo(this.getNodeHierarchy()):null;};g.prototype.getCurrentView=function(){var i=e.byId(this.getViewManager());if(!i){return null;}var l=i.getActiveView();return l;};g.prototype.getVisibilityComplete=function(){var n=this.getNodeHierarchy(),i=n.findNodesByName(),l=[],m=[];i.forEach(function(o){var p=n.createNodeProxy(o);var q=p.getVeId();n.destroyNodeProxy(p);if(q){if(this.getVisibilityState(o)){l.push(q);}else{m.push(q);}}},this);return{visible:l,hidden:m};};g.prototype.resetVisibility=function(){this.setVisibilityState(this._initialState.visible,true,false);this.setVisibilityState(this._initialState.hidden,false,false);this._visibilityTracker.clear();};g.prototype.getVisibilityState=function(n){var m=this._mask;if(Array.isArray(n)){return n.map(function(i){return i?i.isVisible(m):false;});}return n?n.isVisible(m):false;};g.prototype.setVisibilityState=function(n,i,r,l){if(!Array.isArray(n)){n=[n];}var m=Array.isArray(i);var o=[];var p=n;if(r){p=[];n.forEach(function(x,y){var z=this._collectNodesRecursively(x);p=p.concat(z);var B=o.length;o.length=B+z.length;o.fill(m?i[y]:i,B);},this);}else if(!m){o.length=p.length;o.fill(i);}else{o=i;}var q=[];var u=new Set();var s=this._mask;var t=p.filter(function(x,y){if(u.has(x)){return false;}u.add(x);var t=x?x.isVisible(s)!=o[y]:false;if(t){q.push(o[y]);}return t;},this);if(t.length>0){var w={visible:[],hidden:[]};t.forEach(function(x,y){if(q[y]){x.setVisible(s,true);w.visible.push(x);if(l){var z=x.parent;while(z){z.visible=true;z=z.parent;}}}else{x.setVisible(s,false);w.hidden.push(x);}},this);if(this.getShouldTrackVisibilityChanges()){t.forEach(this._visibilityTracker.trackNodeRef,this._visibilityTracker);}this.fireVisibilityChanged(w);}return this;};g.prototype.enumerateSelection=function(i){this._selectedNodes.forEach(i);return this;};g.prototype.getSelectionState=function(n){var s=this._selectedNodes;function i(l){return s.has(l);}return Array.isArray(n)?n.map(i):i(n);};g.prototype._getSelectionComplete=function(){var n=this.getNodeHierarchy(),s=[];function i(l){var m=n.createNodeProxy(l);var o=m.getVeId();n.destroyNodeProxy(m);return o;}this._selectedNodes.forEach(function(l){var m=i(l);if(m){s.push(m);}});return{selected:s};};g.prototype._isAncestorSelected=function(n){n=n.parent;while(n){if(this._selectedNodes.has(n)){return true;}n=n.parent;}return false;};g.prototype._updateHighlightColor=function(n,p){var s=p||this._selectedNodes.has(n);n.setSelected(this._mask,s,this._highlightColorABGR);var m=n.children;for(var i=0,l=m.length;i<l;i++){this._updateHighlightColor(m[i],s);}};g.prototype.setSelectionState=function(n,s,r,i){if(!Array.isArray(n)){n=[n];}n=(r||this.getRecursiveSelection()?this._collectNodesRecursively(n):n).filter(function(m,o,p){return p.indexOf(m)===o;});if(this.getRecursiveSelection()&&!s){n=this._nodeHierarchy._appendAncestors(n);}var l=n.filter(function(m){return this._selectedNodes.has(m)!==s;},this);if(l.length>0){l.forEach(function(m){if(m){this._selectedNodes[s?"add":"delete"](m);}},this);l.forEach(function(m){if(m){this._updateHighlightColor(m,s||this._isAncestorSelected(m));}},this);if(!i){this.fireSelectionChanged({selected:s?l:[],unselected:s?[]:l});}}return this;};g.prototype.setSelectionStates=function(s,u,r,i){if(!Array.isArray(s)){s=[s];}if(!Array.isArray(u)){u=[u];}s=(r||this.getRecursiveSelection()?this._collectNodesRecursively(s):s);u=(r||this.getRecursiveSelection()?this._collectNodesRecursively(u):u);if(this.getRecursiveSelection()){u=this._nodeHierarchy._appendAncestors(u,s);}var l=s.filter(function(n){return n&&(this._selectedNodes.has(n)===false);},this);var m=u.filter(function(n){return n&&(this._selectedNodes.has(n)===true);},this);if(l.length>0||m.length>0){l.forEach(function(n){this._selectedNodes.add(n);this._updateHighlightColor(n,true);},this);m.forEach(function(n){this._selectedNodes.delete(n);},this);m.forEach(function(n){this._updateHighlightColor(n,this._isAncestorSelected(n));},this);if(!i){this.fireSelectionChanged({selected:l,unselected:m});}}return this;};g.prototype._collectNodesRecursively=function(n){var r=[],t=this;if(!Array.isArray(n)){n=[n];}n.forEach(function l(i){r.push(i);t._nodeHierarchy.enumerateChildren(i,l,false,true);});return r;};g.prototype._getOpacity=function(n){return n.opacity!==undefined?n.opacity:null;};g.prototype.getOpacity=function(n){if(Array.isArray(n)){return n.map(this._getOpacity,this);}else{return this._getOpacity(n);}};g.prototype.setTotalOpacity=function(n,t){this.setOpacity(n,t);return{opacity:t,totalOpacity:t};};g.prototype.setOpacity=function(n,o,r){if(!Array.isArray(n)){n=[n];}var i=Array.isArray(o);if(o===null){o=undefined;}else if(i){o.forEach(function(s,t){if(s===null){o[t]=undefined;}});}var l=[];var m=n;if(!i){l.length=m.length;l.fill(o);}else{l=o;}var p=[];var u=new Set();var q=m.filter(function(s,t){if(u.has(s)){return false;}u.add(s);var q=s?s.opacity!==l[t]:false;if(q){p.push(l[t]);}return q;},this);if(q.length>0){q.forEach(function(s,t){s.setOpacity(p[t]);},this);this.fireOpacityChanged({changed:q,opacity:i?p:p[0]});}return this;};g.prototype._getTintColorABGR=function(n){return n.tintColor!==undefined?n.tintColor:null;};g.prototype._getTintColor=function(n){return n.tintColor!==undefined?a(b(n.tintColor)):null;};g.prototype.getTintColor=function(n,i){var l=i?"_getTintColorABGR":"_getTintColor";if(Array.isArray(n)){return n.map(this[l],this);}else{return this[l](n);}};function j(i){switch(typeof i){case"number":return i>>>0;case"string":return sap.ui.core.CSSColor.isValid(i)?d(c(i)):undefined;default:return undefined;}}g.prototype.setTintColor=function(n,t,r){if(!Array.isArray(n)){n=[n];}var i=Array.isArray(t);var l=[];var m=n;if(r){m=[];n.forEach(function(x,y){var z=this._collectNodesRecursively(x);m=m.concat(z);var B=l.length;l.length=B+z.length;l.fill(i?t[y]:t,B);},this);}else if(!i){l.length=m.length;l.fill(t);}else{l=t;}var o=[];var u=new Set();var p=m.filter(function(x,y){if(u.has(x)){return false;}u.add(x);var p=x?x.tintColor!==j(l[y]):false;if(p){o.push(l[y]);}return p;},this);if(p.length>0){var q=this._mask;var s=[];p.forEach(function(x,y){var z=j(o[y]);x.setTintColor(q,z);s.push(z);},this);var w={changed:p,tintColor:i?o:o[0],tintColorABGR:i?s:s[0]};this.fireTintColorChanged(w);}return this;};g.prototype.setHighlightColor=function(i){i=j(i);if(i===undefined){return this;}this._highlightColorABGR=i;if(this._selectedNodes.size>0){this._selectedNodes.forEach(function(n){this._updateHighlightColor(n,true);},this);}this.fireHighlightColorChanged({highlightColor:a(b(i)),highlightColorABGR:i});return this;};g.prototype.getHighlightColor=function(i){return i?this._highlightColorABGR:a(b(this._highlightColorABGR));};g.prototype.getTransformationWorld=function(n){function i(l){return E._decompose(l._matrixWorld());}if(!Array.isArray(n)){return i(n);}var r=[];n.forEach(function(l){r.push(i(l));});return r;};g.prototype.getTransformation=function(n){function i(l){var t=E._decompose(l.matrix);return{translation:t.position,quaternion:t.quaternion,scale:t.scale};}if(!Array.isArray(n)){return i(n);}var r=[];n.forEach(function(l){r.push(i(l));});return r;};function k(i){return new Float32Array([i[0],i[4],i[1],i[5],i[3],i[7]]);}g.prototype.setTransformation=function(n,t){var i=Array.isArray(n);if(!Array.isArray(n)){n=[n];}var l={changed:[],transformation:[]};var m=function(o){return E._decompose(o.matrix);};if(!t){n.forEach(function(o){if(o.userData.matrix){o.setMatrix(o.userData.matrix);delete o.userData.matrix;}l.changed.push(o);l.transformation.push(m(o));},this);}else{if(!Array.isArray(t)){t=[t];}n.forEach(function(o,p){if(!o.userData.matrix){o.userData.matrix=o.matrix.slice();}var q=t[p];if(q.transform){o.setMatrix(k(q.transform));}else{var r;if(q.quaternion){r=q.quaternion;}else if(q.angleAxis){var u=q.angleAxis;var w=u[3]/2,s=Math.sin(w);r=[u[0]*s,u[1]*s,u[2]*s,Math.cos(w)];}else if(q.euler){L.warning("svg.ViewStateManager.setTransformation: Euler angles are not yet supported");r=[0,0,0,1];}var x=E._compose(q.translation,r,q.scale);o.setMatrix(x);}l.changed.push(o);l.transformation.push(m(o));},this);}if(!i){l.changed=l.changed[0];l.transformation=l.transformation[0];}this.fireTransformationChanged(l);return this;};g.prototype._resetNodesStatusByCurrentView=function(i){var n=this.getNodeHierarchy();var l=i.getNodeInfos();if(!n||!l){return;}var m=[];var t=[];l.forEach(function(q){if(q.target){if(q.transform){m.push(q.target);t.push({transform:q.transform});}else if(q[A.Translate]&&q[A.Rotate]&&q[A.Scale]){m.push(q.target);t.push({translation:q[A.Translate].slice(),quaternion:q[A.Rotate].slice(),scale:q[A.Scale].slice()});}}});if(i.userData&&i.userData.nodeStartDataByAnimation){i.userData.nodeStartDataByAnimation.forEach(function(q,r){if(q[A.Translate]&&q[A.Rotate]&&q[A.Scale]){m.push(r);t.push({translation:q[A.Translate].slice(),quaternion:q[A.Rotate].slice(),scale:q[A.Scale].slice()});}});}if(m.length){this.setTransformation(m,t);}var o=[];var p=[];l.forEach(function(q){if(!q.target.userData.skipIt){(q.visible?o:p).push(q.target);}});this.setVisibilityState(n.getChildren()[0].children,false,true);this.setVisibilityState(o,true,false);this.setVisibilityState(p,false,false);};g.prototype._onActivateView=function(i,l,m){var n=this.getViewManager();if(n&&m.source.getId()===n){this.activateView(m.view);}};g.prototype.activateView=function(i){this.fireViewStateApplying({view:i});this._resetNodesStatusByCurrentView(i);this.fireViewStateApplied({view:i});v.getEventBus().publish("sap.ui.vk","viewStateApplied",{source:this,view:i});return this;};g.prototype.setJoints=function(i,p){return this;};g.prototype._propagateOpacityToJointChildren=function(n,o){return this;};g.prototype._setJointNodeMatrix=function(){return this;};f=function(){this._visibilityChanges=new Set();};f.prototype.getInfo=function(n){var i=[];this._visibilityChanges.forEach(function(l){var m=n.createNodeProxy(l);var o=m.getVeId();n.destroyNodeProxy(m);if(o){i.push(o);}else{i.push(n.getScene().nodeRefToPersistentId(l));}});return i;};f.prototype.clear=function(){this._visibilityChanges.clear();};f.prototype.trackNodeRef=function(n){if(this._visibilityChanges.has(n)){this._visibilityChanges.delete(n);}else{this._visibilityChanges.add(n);}};return g;});
