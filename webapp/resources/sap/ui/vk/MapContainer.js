/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./ContainerBase","sap/ui/core/IconPool","sap/ui/vbm/lib/sapvbi","sap/ui/Device","./MapContainerRenderer","./MapContainerButtonType","./getResourceBundle"],function(C,I,s,D,M,a,g){"use strict";var b=C.extend("sap.ui.vk.MapContainer",{metadata:{library:"sap.ui.vk",properties:{"showNavbar":{type:"boolean",group:"Misc",defaultValue:true},"showHome":{type:"boolean",group:"Misc",defaultValue:true},"showMapLayer":{type:"boolean",group:"Misc",defaultValue:true},"showRectangularZoom":{type:"boolean",group:"Misc",defaultValue:true},"showZoom":{type:"boolean",group:"Misc",defaultValue:true}},aggregations:{"listPanelStack":{type:"sap.ui.vk.ListPanelStack",multiple:false},"scrollCont":{type:"sap.m.ScrollContainer",multiple:false,visibility:"hidden"}},associations:{},events:{}}});b.prototype.init=function(){C.prototype.init.apply(this,arguments);var m=new sap.ui.model.json.JSONModel();m.setData({rectZoom:false});this.setModel(m,"rectZoom");this._oNavbar=new sap.m.Toolbar({width:"auto"});this._oScrollCont=new sap.m.ScrollContainer({horizontal:false,vertical:true,focusable:false});this.setAggregation("scrollCont",this._oScrollCont,true);this._oHomeButton=new sap.m.Button({icon:"sap-icon://home",type:sap.m.ButtonType.Transparent,tooltip:g().getText("MAPCONTAINER_HOME"),press:this._onNavbarHome.bind(this)});this._oRectZoomButton=new sap.m.ToggleButton({icon:"sap-icon://draw-rectangle",type:sap.m.ButtonType.Transparent,pressed:"{rectZoom>/rectZoom}",tooltip:g().getText("MAPCONTAINER_RECT_ZOOM")}).setModel(m,"rectZoom");this._oZoomInButton=new sap.m.Button({icon:"sap-icon://add",type:sap.m.ButtonType.Transparent,tooltip:g().getText("MAPCONTAINER_ZOOMIN"),press:this._onNavbarZoomIn.bind(this)});this._oZoomOutButton=new sap.m.Button({icon:"sap-icon://less",type:sap.m.ButtonType.Transparent,tooltip:g().getText("MAPCONTAINER_ZOOMOUT"),press:this._onNavbarZoomOut.bind(this)});if(D.system.phone){this._oMenuOpenButton=new sap.m.Button({layoutData:new sap.m.OverflowToolbarLayoutData({priority:sap.m.OverflowToolbarPriority.NeverOverflow}),icon:"sap-icon://menu2",type:sap.m.ButtonType.Transparent,tooltip:g().getText("CONTAINERBASE_MENU"),press:function(){this._bSegmentedButtonSaveSelectState=true;this._showListPanelStack();}.bind(this)});this._oMenuCloseButton=new sap.m.Button({type:sap.m.ButtonType.Transparent,icon:"sap-icon://nav-back",press:function(){this._bSegmentedButtonSaveSelectState=true;this._hideListPanelStack();}.bind(this)});}};b.prototype.exit=function(){if(this._oNavbar){this._oNavbar.destroy();this._oNavbar=undefined;}if(this._oScrollCont){this._oScrollCont.destroy();this._oScrollCont=undefined;}C.prototype.exit.apply(this,arguments);};b.prototype.getListPanelStack=function(){return this._oScrollCont.getContent()[0];};b.prototype.setListPanelStack=function(p){if(D.system.phone){p.setCollapsible(false);p.setWidth("100%");}this._oScrollCont.removeAllContent();return this._oScrollCont.addContent(p);};b.prototype.onBeforeRendering=function(){C.prototype.onBeforeRendering.apply(this,arguments);this._oNavbar.removeAllContent();this._shouldRenderMapLayerSwitch=false;var c=this.getSelectedContent();if(c!==null){var d=c.getContent();this._isInstanceGeoAnalytic=d instanceof sap.ui.vbm.GeoMap||d instanceof sap.ui.vbm.AnalyticMap;if(this._isInstanceGeoAnalytic){if(this.getShowHome()){this._oNavbar.addContent(this._oHomeButton);}if(!D.system.phone&&this.getShowRectangularZoom()){this._oNavbar.addContent(this._oRectZoomButton);}if(this.getShowZoom()){this._oNavbar.addContent(this._oZoomInButton);this._oNavbar.addContent(this._oZoomOutButton);}this._shouldRenderListPanel=true;}else{this._shouldRenderListPanel=false;}this._isSupportingMapLayerSwitch=d instanceof sap.ui.vbm.GeoMap&&!(d instanceof sap.ui.vbm.AnalyticMap);if(this._isSupportingMapLayerSwitch&&d.getMapConfiguration()!==null&&this.getShowMapLayer()){var e=d.getMapConfiguration();var l=[].concat(e.MapLayerStacks);if(l.length>1){this._currentText=new sap.m.Text().addStyleClass("mapLayerSelectedText");this.addDependent(this._currentText);this._box=new sap.m.HBox().addStyleClass("mapContainerHboxPopover");this._popover=new sap.m.Popover({enableScrolling:false,placement:sap.m.PlacementType.Horizontal,content:this._box,showHeader:false});this._selectionMap=new sap.m.Image({press:function(f){if(this._popover.isOpen()){this._popover.close();}else{this._popover.openBy(this._selectionMap);}}.bind(this)}).addStyleClass("mapLayerPopoverItem");this.addDependent(this._selectionMap);this._shouldRenderMapLayerSwitch=true;}}}};b.prototype.onAfterRendering=function(){if(D.system.phone){var l=document.getElementById(this.getId()+"-LPW");this.getDomRef().appendChild(l);}C.prototype.onAfterRendering.apply(this,arguments);if(this._shouldRenderMapLayerSwitch){var c=this.getSelectedContent().getContent();var d=c.getMapConfiguration();var e=[].concat(d.MapLayerStacks);var f=c.mVBIContext.GetMainScene();e.forEach(function(v){var h=c.mVBIContext.m_MapLayerStackManager.GetMapLayerStack(v.name);var i=new sap.m.Image({alt:v.name,press:function(m){this._popover.close();this._currentText.setText(v.name);this._selectionMap.setAlt(v.name);c.setRefMapLayerStack(v.name);if(i.getSrc()){this._selectionMap.setSrc(i.getSrc());}else{f.GetPreviewImage(h,function(n){this._selectionMap.setSrc(n.src);}.bind(this));}}.bind(this)}).addStyleClass("layerType");f.GetPreviewImage(h,function(m){i.setSrc(m.src);});var j=new sap.m.Text({text:v.name}).addStyleClass("mapLayerPopoverItemText");var k=new sap.ui.layout.VerticalLayout();k.addContent(i);k.addContent(j);this._box.addItem(k);},this);this._currentText.setText(c.getRefMapLayerStack());this._selectionMap.setAlt(c.getRefMapLayerStack());f.GetPreviewImage(f.m_MapLayerStack,function(i){this._selectionMap.setSrc(i.src);}.bind(this));}};b.prototype.setToolbarItem=function(c){if(!c||!c.id){return null;}var o;for(var i=0;i<this._customButtons.length;++i){if(c.id===this._customButtons[i].id){o=this._customButtons[i];o.index=i;this._customButtons.splice(i,1);break;}}if(!o){o={id:c.id,visible:true,active:true,index:this._customButtons.length,type:a.Click};}if("index"in c){o.index=c.index;}if("visible"in c){o.visible=c.visible;}if("overflow"in c){o.overflow=c.overflow;}if("active"in c){o.active=c.active;}if("text"in c){o.text=c.text;}if("tooltip"in c){o.tooltip=c.tooltip;}if("icon"in c){o.icon=c.icon;}if("activeIcon"in c){o.activeIcon=c.activeIcon;}if("press"in c){o.press=c.press;}if("toggled"in c){o.toggled=c.toggled;if(o.button){o.button.setPressed(c.toggled);}}if("type"in c){o.type=c.type;}if(o.index>this._customButtons.length){o.index=this._customButtons.length;}else if(o.index<0){o.index=0;}this._customButtons.splice(o.index,0,o);this.invalidate();return o;};b.prototype.setSelectedContent=function(c){var o;if(this._oSelectedContent){if((o=this._oSelectedContent.getContent())instanceof sap.ui.vbm.GeoMap){o.unbindProperty("rectZoom","rectZoom>/rectZoom");}}C.prototype.setSelectedContent.apply(this,arguments);var n=this._oSelectedContent.getContent();if(n instanceof sap.ui.vbm.GeoMap){n.bindProperty("rectZoom","rectZoom>/rectZoom");}};b.prototype._addToolbarContent=function(){if(D.system.phone){this._oToolbar.addContent(this._oMenuOpenButton);}C.prototype._addToolbarContent.apply(this,arguments);};b.prototype._onNavbarZoomIn=function(e){var c=this.getSelectedContent().getContent();if(c.getZoomlevel&&c.setZoomlevel&&c.setEnableAnimation){c.setEnableAnimation(true);c.setZoomlevel(c.getZoomlevel()+1);}};b.prototype._onNavbarZoomOut=function(e){var c=this.getSelectedContent().getContent();if(c.getZoomlevel&&c.setZoomlevel&&c.setEnableAnimation){c.setEnableAnimation(true);c.setZoomlevel(c.getZoomlevel()-1);}};b.prototype._onNavbarHome=function(e){var c=this.getSelectedContent().getContent();if(c.goToStartPosition){c.goToStartPosition();}};b.prototype._showListPanelStack=function(){jQuery("#"+this.getId()+"-LPW").addClass("sapUiVkMapContainerLPWIn");jQuery("#"+this.getId()+"-wrapper").addClass("sapUiVkMapContainerMapOut");};b.prototype._hideListPanelStack=function(){jQuery("#"+this.getId()+"-LPW").removeClass("sapUiVkMapContainerLPWIn");jQuery("#"+this.getId()+"-wrapper").removeClass("sapUiVkMapContainerMapOut");};return b;});
