/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/Element","./Core","./AnimationMath","./AnimationTrackType","./AnimationTrackValueType","./glMatrix","sap/ui/core/Core"],function(E,v,A,a,b,g,c){"use strict";var d=E.extend("sap.ui.vk.AnimationPlayer",{metadata:{associations:{viewStateManager:{type:"sap.ui.vk.ViewStateManagerBase",multiple:false}},events:{viewActivated:{type:"sap.ui.vk.View"},beforeTimeChanged:{time:{type:"float"},nextTime:{type:"float"},currentPlayback:{type:"sap.ui.vk.AnimationPlayback"},nextPlayback:{type:"sap.ui.vk.AnimationPlayback"}},timeChanged:{time:{type:"float"},previousTime:{type:"float"},currentPlayback:{type:"sap.ui.vk.AnimationPlayback"},previousPlayback:{type:"sap.ui.vk.AnimationPlayback"}},stateChanged:{playing:{type:"boolean"},stopped:{type:"boolean"},endOfAnimation:{type:"boolean"}}}},constructor:function(i,s){E.apply(this,arguments);v.observeLifetime(this);}});d.prototype._getViewStateManager=function(){var e=this.getViewStateManager();return e?c.byId(e):undefined;};d.prototype.init=function(){this._step=this._step.bind(this);this._playbackCollection=null;this._currentPlayback=null;this._time=0;this._nodeChanges=new Map();v.getEventBus().subscribe("sap.ui.vk","readyForAnimation",this._onViewApplied,this);v.getEventBus().subscribe("sap.ui.vk","sequenceChanged",this._onSequenceChanged,this);v.getEventBus().subscribe("sap.ui.vk","playbacksChanged",this._onPlaybacksChanged,this);v.getEventBus().subscribe("sap.ui.vk","trackChanged",this._onTrackChanged,this);v.getEventBus().subscribe("sap.ui.vk","nodeAnimationRemoved",this._onNodeAnimationRemoved,this);};d.prototype.exit=function(){this._playbackCollection=null;this._currentPlayback=null;v.getEventBus().unsubscribe("sap.ui.vk","readyForAnimation",this._onViewApplied,this);v.getEventBus().unsubscribe("sap.ui.vk","sequenceChanged",this._onSequenceChanged,this);v.getEventBus().unsubscribe("sap.ui.vk","playbacksChanged",this._onPlaybacksChanged,this);v.getEventBus().unsubscribe("sap.ui.vk","trackChanged",this._onTrackChanged,this);v.getEventBus().unsubscribe("sap.ui.vk","nodeAnimationRemoved",this._onNodeAnimationRemoved,this);};d.prototype._onViewApplied=function(e,f,h){if(h.source.getId()!=this.getViewStateManager()){return;}var i=h.view;var j=h.ignoreAnimationPosition;this.activateView(i,j);};d.prototype._onSequenceChanged=function(e,f,h){if(this._currentPlayback){var i=this._getViewStateManager();var s=this._currentPlayback.getSequence();if(i&&s){if(s.getId()===h.sequenceId){i.setJoints(s.getJoint(),this._currentPlayback);}}}this._clearPlaybackBoundaryProperties();this._setPlaybackBoundaryProperties();};d.prototype._resetNodesAnimation=function(n,p){if(!Array.isArray(n)){n=[n];}var e=this._getViewStateManager();n.forEach(function(f){if(p){e.resetNodeProperty(f,p);}else{e.resetNodeProperty(f);e.resetNodeProperty(f,a.Opacity);}});};d.prototype._onPlaybacksChanged=function(e,f,h){if(h.operation==="playbackRemoved"&&this._currentPlayback&&this._currentPlayback===h.playback&&this._currentPlayback.getSequence()){var i=this._currentPlayback.getSequence().getNodeAnimation();var j=i.map(function(k){return k.nodeRef;});this._resetNodesAnimation(j);}this._clearPlaybackBoundaryProperties();};d.prototype._onTrackChanged=function(e,f,h){if(h.emptyTrack&&this._currentPlayback){var i=this._getViewStateManager();var s=this._currentPlayback.getSequence();if(i&&s){var j=s.getNodeAnimation();j.forEach(function(k){for(var t in a){var l=a[t];var m=k[l];if(m&&m.getId()===h.trackId){i.resetNodeProperty(k.nodeRef,l);return;}}});}this._setPlaybackBoundaryProperties();}};d.prototype._onNodeAnimationRemoved=function(e,f,h){if(this._currentPlayback){var i=this._getViewStateManager();var s=this._currentPlayback.getSequence();if(i&&s){if(s.getId()===h.sequenceId){i.setJoints(s.getJoint(),this._currentPlayback);this._resetNodesAnimation(h.nodeRefs,h.property);}}}this._clearPlaybackBoundaryProperties();};d.prototype.getAnimatedProperty=function(n,p){var r={};var e=this._getViewStateManager();if(!e){return null;}if(p!==a.Opacity){var w=e.getTransformationWorld(n);if(p===a.Rotate){r.world=w.quaternion;}else if(p===a.Translate){r.world=w.translation;}else{r.world=w.scale;}}var f=this._nodeChanges.get(n);if(!f||f[p]===undefined){r.offsetToPrevious=null;r.offsetToRest=null;if(p===a.Opacity){r.absolute=e.getOpacity(n);r.totalOpacity=e.getTotalOpacity(n);}else{var t=e.getTransformation(n);if(p===a.Rotate){r.absolute=t.quaternion;}else if(p===a.Translate){r.absolute=t.translation;}else{r.absolute=t.scale;}}return r;}if(p===a.Opacity){var o=f[p];r.offsetToRest=o;r.offsetToPrevious=f.offsetToPrevious[p];r.opacity=f.absolute.opacity;r.totalOpacity=f["totalOpacity"];return r;}var h=f[p];r.offset=h;if(p===a.Rotate){r.absolute=f.absolute.quaternion;}else if(p===a.Translate){r.absolute=f.absolute.translate;}else{r.absolute=f.absolute.scale;}r.offsetToPrevious=f.offsetToPrevious[p];r.offsetToRest=f[p];return r;};d.prototype.setTime=function(t,p,e){this._setPlaybackBoundaryProperties();this._setTime(t,p,e);return this;};d.prototype._setTime=function(t,p,e){var f=this._time;var h=this._currentPlayback;if(!this._playbackCollection||!Array.isArray(this._playbackCollection.getPlaybacks())){this._currentPlayback=undefined;this._time=0;}else{if(p!=null){t=this._getAbsoluteTime(t,p);}var i=this._getViewStateManager();var j=this._currentPlayback;var n;if(t<0||t>this.getTotalDuration()){n=undefined;}else if(p!=null){n=this._playbackCollection.getPlayback(p);}else{n=this._findPlaybackByAbsoluteTime(t);}var k=false;if(n&&n.getReversed()){if(this._currentPlayback&&n.getJSONData().startTime>this._currentPlayback.getJSONData().startTime){k=true;}}else if(n&&this._currentPlayback&&n.getJSONData().startTime<this._currentPlayback.getJSONData().startTime){k=true;}if(!e&&(t!==this._time||n!==this._currentPlayback)){this.fireBeforeTimeChanged({time:this._time,nextTime:t,currentPlayback:this._currentPlayback,nextPlayback:n});}this._time=t;this._currentPlayback=n;if(i&&this._currentPlayback&&j!==this._currentPlayback){var s=this._currentPlayback.getSequence();if(s){i.setJoints(s.getJoint(),this._currentPlayback);}}else if(!this._currentPlayback||!this._currentPlayback.getSequence()){i.setJoints(undefined);}if(i){var l={nodeRefs:[],positions:[]};var o={nodeRefs:[],opacities:[]};this._collectNodeChanges();this._nodeChanges.forEach(function(m,q){var r={rtranslate:m.rtranslate,rscale:m.rscale,rrotate:m.rrotate,Euler:m.Euler,ropacity:m.offsetToPrevious&&m.offsetToPrevious.ropacity?m.offsetToPrevious.ropacity:m.ropacity};i.setInterpolatedRelativeValues(q,r);var u=i.getRestTransformation(q);var w=i._addToTransformation(u,m.rtranslate,m.rrotate,m.rscale,m.originalRotationType,m.Euler);if(w){l.nodeRefs.push(q);l.positions.push(w);m.absolute={};m.absolute.translate=w.translation;m.absolute.scale=w.scale;m.absolute.quaternion=w.quaternion;}if(k&&m[a.Opacity]===undefined){m[a.Opacity]=1.0;q.userData.opacity=undefined;}if(m[a.Opacity]!==undefined){var x=i.getRestOpacity(q);if(x===0){x=1;}var y=m[a.Opacity]*x;q.userData.animatedOpacity=true;m.absolute={};m.absolute.opacity=y;o.nodeRefs.push(q);o.opacities.push(y);}},this);i.setTransformation(l.nodeRefs,l.positions);i.setOpacity(o.nodeRefs,o.opacities);i._propagateOpacityToJointChildren(o.nodeRefs,o.opacities);i._setJointNodeMatrix();this._nodeChanges.forEach(function(m,q){if(m[a.Opacity]!==undefined){m.totalOpacity=i.getTotalOpacity(q);}},this);}}if(!e&&(this._time!==f||this._currentPlayback!==h)){this.fireTimeChanged({time:this._time,previousTime:f,currentPlayback:this._currentPlayback,previousPlayback:h});}};d.prototype.getTime=function(){return this._time;};d.prototype.getCurrentPlayback=function(){return this._currentPlayback;};d.prototype.getCurrentPlaybackTime=function(){var t=this._time;var p=this._playbackCollection.getPlaybacks();if(!Array.isArray(p)||!this.getCurrentPlayback()){return-1;}var i=0;while(p[i]!=this.getCurrentPlayback()){t-=p[i].getDuration();i++;}return t;};d.prototype.getStartTime=function(p){if(!this._playbackCollection){return undefined;}if(typeof p==="number"){p=this._playbackCollection.getPlayback(p);}return p?p.getStartTime():undefined;};d.prototype.getTotalDuration=function(){if(!this._playbackCollection){return 0;}var t=0;this._playbackCollection.getPlaybacks().forEach(function(p){t+=p.getDuration();});return t;};d.prototype._step=function(t){if(!this._lastFrameTimestamp){this._lastFrameTimestamp=t;}var p=t-this._lastFrameTimestamp;this._lastFrameTimestamp=t;var n=this.getTime()+p/1000;var r=n>=0&&n<=this.getTotalDuration();if(n>this.getTotalDuration()){n=this.getTotalDuration();}this.setTime(n);if(r){this._frameId=window.requestAnimationFrame(this._step);}else{this.stop();}};d.prototype._interpolate=function(e,f,t,h,i){if(!f.before&&!f.after){return undefined;}if(!f.before){f.before=f.after;}if(!f.after){if(e===b.AngleAxis){f.after={value:[0,0,1,0],time:f.before.time};}else{f.after=f.before;}}var k;if(f.before.time===f.after.time){k=1;}else{k=(f.time-f.before.time)/(f.after.time-f.before.time);}return A.interpolate(e,f.before,f.after,k,t,h,i);};d.getBoundaryKey=function(t,i){var e=t.getKeysCount();if(!e){return null;}var f;if(i){f=t.getKey(0);}else{f=t.getKey(e-1);}var h=t.getKeysType();var q,r={};if(h===b.Euler){r[h]=f.value;q=A.neutralEulerToGlMatrixQuat(f.value);r.value=A.glMatrixQuatToNeutral(q);r.time=f.time;}else if(h===b.Quaternion){q=A.neutralQuatToGlMatrixQuat(f.value);r.value=A.glMatrixQuatToNeutral(q);r.time=f.time;}else if(h!==b.AngleAxis){r.value=f.value;r.time=f.time;}else{var j;var k=1;if(i){j=f;if(e>1){j=t.getKey(1);k=0;}}else{j=f;if(e>1){f=t.getKey(e-2);}}r=A.interpolate(h,f,j,k,t);r.time=i?f.time:j.time;}return r;};d.prototype._getKeyFramesBracket=function(t,e){var k=e.getKeysCount();if(k===0){return null;}var r={time:t,before:undefined,after:undefined};for(var i=0;i<k;i++){var f=e.getKey(i);if(f.time===t){r.before=r.after=f;break;}else if(f.time>t){r.before=(i===0?undefined:e.getKey(i-1));r.after=f;break;}}if(!r.before&&!r.after&&k>0){r.before=e.getKey(k-1);}if(k>1&&(!r.after&&e.isCycleForward()||!r.before&&e.isCycleBackward())){var h=e.getKey(0).time;var j=e.getKey(k-1).time-h;var l=Math.floor((t-h)/j);var m=t-j*l;return this._getKeyFramesBracket(m,e);}return r;};d.prototype._collectNodeChangesFromPlaybackBoundaryKeys=function(n,p,i){var s=p.getSequence();if(!s){return;}var e=s.getNodeAnimation();if(!e){return;}var f=this._getViewStateManager();var t=this;var h=function(l,m,o){if(!l||!m||o===undefined||o===null){return;}var q=n.get(l);if(q&&q.hasOwnProperty(m)){return;}if(!q){q={};n.set(l,q);}if(!q.offsetToPrevious){q.offsetToPrevious={};}if(m===a.Opacity){q[m]=o;if(!q.offsetToPrevious[m]){var r=f.getOpacity(l);var u=f.getRestOpacity(l);if(u===0){u=1;}if(u>0&&(r!==undefined||r!==null)){var w=f._getEndPropertyInPreviousPlayback(l,m,t._currentPlayback);if(w){r/=w;}q.offsetToPrevious[m]=r/u;}else{q.offsetToPrevious[m]=1;}}}else{q[m]=o.slice();var x=f.getRelativeTransformation(l);if(m===a.Scale){if(!q.offsetToPrevious[m]){q.offsetToPrevious[m]=x.scale.slice();var y=f._getEndPropertyInPreviousPlayback(l,m,t._currentPlayback);if(y){q.offsetToPrevious[m][0]/=y[0];q.offsetToPrevious[m][1]/=y[1];q.offsetToPrevious[m][2]/=y[2];}}}if(m===a.Translate){if(!q.offsetToPrevious[m]){q.offsetToPrevious[m]=x.translation.slice();var z=f._getEndPropertyInPreviousPlayback(l,m,t._currentPlayback);if(z){q.offsetToPrevious[m][0]-=z[0];q.offsetToPrevious[m][1]-=z[1];q.offsetToPrevious[m][2]-=z[2];}}}if(m===a.Rotate){q.offsetToPrevious[m]=[0,0,1,0];}else if(!q.offsetToPrevious[m]){q.offsetToPrevious[m]=[0,0,0];}}};var j;if(i){j=p._getNodeEndPropertiesMap();}else{j=p._getNodeStartPropertiesMap();}if(!j){return;}if(this._currentPlayback){var k=this._currentPlayback.getSequence();j.forEach(function(l,m){for(var o in l){if(k._isNodePropertyDefined(m,o)){continue;}h(m,o,l[o]);}},this);}};d.prototype._collectSequenceNodeChanges=function(t,n,p,i){var s=p.getSequence();var e=s.getNodeAnimation();if(!e){return;}var f=this._getViewStateManager();var h=function(l,m,r,o){if(!l||!m||!r||r.value===undefined||r.value===null){return;}var u=n.get(l);if(!u){u={};n.set(l,u);}if(!u.animationProperties){u.animationProperties={};}u.animationProperties[m]=true;if(o){u.originalRotationType=o;}if(!u.offsetToPrevious){u.offsetToPrevious={};}var w;if(m===a.Opacity){u[m]=r.value;u.offsetToPrevious[m]=r.value;w=f._getEndPropertyInPreviousPlayback(l,m,p,true);if(w){u[m]*=w;}}else{u[m]=r.value.slice();u.offsetToPrevious[m]=r.value.slice();w=f._getEndPropertyInPreviousPlayback(l,m,p);if(w){if(m===a.Translate){u[m][0]+=w[0];u[m][1]+=w[1];u[m][2]+=w[2];}else if(m===a.Scale){u[m][0]*=w[0];u[m][1]*=w[1];u[m][2]*=w[2];}}}if(o===b.Euler||o===b.AngleAxis){u[o]=r[o].slice();u.offsetToPrevious[m]=r[o].slice();if(w){var x=A.neutralQuatToGlMatrixQuat(w);var y=A.neutralQuatToGlMatrixQuat(u[m]);var q=g.quat.multiply(g.quat.create(),y,x);u[m]=A.glMatrixQuatToNeutral(q);}}};var j=p.getReversed();var k=s.getDuration();e.forEach(function(l){var m;for(var o in a){var q=a[o];var r=l[q];if(r&&r.getKeysCount()&&(!i||(i&&r.isInfinite()))){m=this._getKeyFramesBracket(t,r);if(!m){return;}var u=r.getKeysType();var w=null;if(j){if(u===b.AngleAxis){w=this._interpolate(u,m,r,q,true);}else{var x=this._getKeyFramesBracket(k,r);var y=this._interpolate(u,x,r,q);w=this._interpolate(u,m,r,q,y.value);}}else{w=this._interpolate(u,m,r,q);}if(q===a.Rotate){h(l.nodeRef,q,w,u);}else{h(l.nodeRef,q,w);}}}},this);};d.prototype._collectPlaybackNodeChanges=function(e,n,p){var s=p.getSequence();if(!s){return;}var t=e-p.getStartTime();if(t<0){return;}var f=s.getDuration()*p.getTimeScale()*p.getRepeats();var h=(t-p.getPreDelay())/p.getTimeScale();var i=0.0001;if(h>0&&h%s.getDuration()===0){h=s.getDuration();}else if(h>s.getDuration()+i){h=h%s.getDuration();}else if(h>s.getDuration()){h=s.getDuration();}h=p.getReversed()?p.getSequence().getDuration()-h:h;if(t<p.getPreDelay()){if(t===0){this._collectSequenceNodeChanges(h,n,p,false);}}else if(t>p.getPreDelay()+f+i){this._collectSequenceNodeChanges(h,n,p,true);}else{this._collectSequenceNodeChanges(h,n,p,false);}};d.prototype._collectNodeChanges=function(){this._nodeChanges.clear();if(!this._currentPlayback){return;}var p=this._playbackCollection.getPlaybacks();var e=this.getTime();var i;var f=0;for(i=0;i<p.length;i++){if(this._currentPlayback&&this._currentPlayback!==p[i]){continue;}this._collectPlaybackNodeChanges(e,this._nodeChanges,p[i]);f=i;}if(!this._currentPlayback.getReversed()){for(i=f-1;i>=0;i--){this._collectNodeChangesFromPlaybackBoundaryKeys(this._nodeChanges,p[i],true);}for(i=f+1;i<p.length;i++){this._collectNodeChangesFromPlaybackBoundaryKeys(this._nodeChanges,p[i],false);}}else{for(i=f+1;i<p.length;i++){this._collectNodeChangesFromPlaybackBoundaryKeys(this._nodeChanges,p[i],false);}for(i=f-1;i>=0;i--){this._collectNodeChangesFromPlaybackBoundaryKeys(this._nodeChanges,p[i],true);}}};d.prototype._clearPlaybackBoundaryProperties=function(){if(!this._playbackCollection){return;}var p=this._playbackCollection.getPlaybacks();for(var i=0;p&&i<p.length;i++){var e=p[i];if(!e){continue;}e._clearNodesBoundaryProperties();}};d.prototype._setPlaybackBoundaryProperties=function(f){if(!this._playbackCollection){return;}var e=this._time;var h=this._currentPlayback;var n=false;var p=this._playbackCollection.getPlaybacks();var i;var t=0;var j,s;if(f){this._clearPlaybackBoundaryProperties();}for(i=0;i<p.length;i++){j=p[i];if(!j){continue;}var k=this._getViewStateManager();s=j.getSequence();if(k&&s){if(!f&&j._hasCompleteNodesBoundaryProperties()){continue;}t=j.getPreDelay();this._setTime(t,i,true);j._setCurrentNodesPropertiesAsBoundary(k,false,f);t+=s.getDuration();this._setTime(t,i,true);j._setCurrentNodesPropertiesAsBoundary(k,true,f);n=true;}}if(n){if(!h){this._time=e;this._setTime(this._time,null,true);this._currentPlayback=h;}else{var l=-1;var m=0;for(i=0;i<p.length;i++){j=p[i];if(j===h){l=i;break;}var o=0;s=j.getSequence();if(s){o=s.getDuration()*j.getTimeScale()*j.getRepeats();}m+=j.getPreDelay()+o+j.getPostDelay();}if(l!==-1){var q=e-m;this._setTime(q,l,true);}}}};d.prototype.play=function(){this._lastFrameTimestamp=undefined;this._frameId=window.requestAnimationFrame(this._step);v.getEventBus().publish("sap.ui.vk","animationPlayStateChanged",{source:this,view:this._playbackCollection,playing:true,stopped:false,endOfAnimation:false});this.fireStateChanged({playing:true,stopped:false});return this;};d.prototype.stop=function(){if(this._frameId){window.cancelAnimationFrame(this._frameId);this._frameId=undefined;}this._lastFrameTimestamp=undefined;this.fireStateChanged({playing:false,stopped:true,endOfAnimation:this.getTime()>=this.getTotalDuration()});v.getEventBus().publish("sap.ui.vk","animationPlayStateChanged",{source:this,view:this._playbackCollection,playing:false,stopped:true,endOfAnimation:this.getTime()>=this.getTotalDuration()});return this;};d.prototype.activateView=function(e,p){this.stop();var f=this._getViewStateManager();var h=e.getPlaybacks();if(h&&h.length>0){for(var i=0;i<h.length;i++){var j=h[i];var s=j.getSequence();if(s){f._convertTracksToRelative(s,j.getReversed());}}}if(!p){this._playbackCollection=e;}else{this._playbackCollection=undefined;}this._currentPlayback=undefined;this.setTime(0);if(p){this._playbackCollection=e;}this.fireViewActivated({view:e});return this;};d.prototype._getAbsoluteTime=function(t,p){if(!this._playbackCollection||!Array.isArray(this._playbackCollection.getPlaybacks())){return-1;}var e=this._playbackCollection.getPlaybacks();if(p<0||p>=e.length){return-1;}var f=this._playbackCollection.getPlayback(p);if(!f||f.getDuration()<t||t<0){return-1;}var h=t;var i=0;while(i<p){var j=e[i].getDuration();h+=j;i++;}return h;};d.prototype._findPlaybackByAbsoluteTime=function(t){if(!this._playbackCollection||!Array.isArray(this._playbackCollection.getPlaybacks())){return undefined;}var p=this._playbackCollection.getPlaybacks();var l=-1;var e=-1;p.forEach(function(h,j){if(h.getStartTime()>e){l=j;e=h.getStartTime();}});var i=0;while(i<p.length){var f=p[i].getDuration();var s=p[i].getStartTime();if((i!==l&&t>=s&&t<(s+f))||(i===l&&t>=s&&t<=(s+f))){return p[i];}i++;}return undefined;};return d;});
