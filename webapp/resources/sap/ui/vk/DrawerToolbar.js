/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./library","./DrawerToolbarRenderer","sap/ui/core/Control","sap/m/VBox","sap/m/FlexItemData","sap/m/OverflowToolbar","sap/ui/core/Icon","sap/m/Button","sap/m/ToolbarSeparator","sap/m/ToggleButton","sap/m/MenuButton","./tools/Tool","./tools/RectSelectTool","./tools/CrossSectionTool","sap/m/Menu","sap/m/MenuItem","./ZoomTo","./getResourceBundle","./Viewport","./DrawerToolbarButton","sap/ui/base/ManagedObjectObserver","sap/ui/core/Core"],function(v,D,C,V,F,O,I,B,T,a,M,b,R,c,d,e,Z,g,f,h,j,k){"use strict";var l=C.extend("sap.ui.vk.DrawerToolbar",{metadata:{properties:{expanded:{type:"boolean",defaultValue:true}},aggregations:{content:{type:"sap.ui.core.Control",multiple:true,forwarding:{getter:"_getToolbar",aggregation:"content",forwardBinding:true}}},associations:{viewport:{type:"sap.ui.vk.Viewport",multiple:false}},events:{expanded:{parameters:{expand:{type:"boolean"}}}}},constructor:function(i,S){C.apply(this,arguments);}});var m=[{name:"show",unicode:"e000"},{name:"hide",unicode:"e001"},{name:"turntable",unicode:"e002"},{name:"orbit",unicode:"e003"},{name:"pan",unicode:"e004"},{name:"zoom",unicode:"e005"},{name:"fit-to-view",unicode:"e006"},{name:"rectangular-selection",unicode:"e007"},{name:"structure-browser",unicode:"e008"},{name:"configuration",unicode:"e009"},{name:"setting",unicode:"e00a"},{name:"full-screen",unicode:"e00b"},{name:"predefined-views",unicode:"e00c"},{name:"authoring-app",unicode:"e00d"},{name:"dot",unicode:"e00e"},{name:"empty",unicode:"e00f"},{name:"right-panel-menu",unicode:"e010"},{name:"viewer-app",unicode:"e011"},{name:"hide-association",unicode:"e012"},{name:"cross-section",unicode:"e013"},{name:"cross-section-x",unicode:"e014"},{name:"cross-section-z",unicode:"e015"},{name:"cross-section-y",unicode:"e016"},{name:"reverse-direction",unicode:"e017"},{name:"create-editable-visualisation",unicode:"e018"},{name:"cross-section-z-",unicode:"e019"}],n="vk-icons",o="vk-icons";m.forEach(function(i){sap.ui.core.IconPool.addIcon(i.name,n,o,i.unicode);});var q="sap-icon://vk-icons/";l.prototype.init=function(){if(C.prototype.init){C.prototype.init.apply(this);}this._itemsVisibility=new Map();this._itemsVisibilityObserver=new j(this._itemVisibilityChanged.bind(this));this._toolbar=new O({width:"auto",design:sap.m.ToolbarDesign.Solid,layoutData:new F({growFactor:0,shrinkFactor:0}),content:this.createButtons()});this._toolbar.ontouchstart=function(i){i.setMarked();};this._toolbarObserver=new j(this._toolbarContentChanged.bind(this));this._toolbarObserver.observe(this._toolbar,{aggregations:["content"]});this._container=new V({renderType:sap.m.FlexRendertype.Bare,alignContent:sap.m.FlexAlignContent.Center,alignItems:sap.m.FlexAlignItems.Center,items:[this._toolbar,new I({src:"sap-icon://navigation-up-arrow",noTabStop:true,press:function(i){this._toggleExpanded();}.bind(this),layoutData:new F({growFactor:0,shrinkFactor:0})}).addStyleClass("drawerToolbarIcon")]});this._rectSelectTool=new R();};l.prototype.exit=function(){this._toolbarObserver.disconnect();this._toolbarObserver=null;this._toolbar.destroy();this._toolbar=null;};l.prototype._toolbarContentChanged=function(){var p=this._toolbar.getContent();for(var i=0;i<p.length;i++){if(p[i].getMetadata().getName()=="sap.m.ToolbarSeparator"){if(p[i-1]==undefined||p[i+1]==undefined||p[i-1].getMetadata().getName()=="sap.m.ToolbarSeparator"){this._toolbar.removeContent(i);}}}};l.prototype._itemVisibilityChanged=function(i){if(!this._ignoreVisiblityChange){this._itemsVisibility.set(i.object,i.current);}};function r(i){return i?i.getMetadata().getName()==="sap.ui.vk.threejs.Viewport":false;}function s(i){return i?i.getMetadata().getName()==="sap.ui.vk.svg.Viewport":false;}function t(i){return i?i.getMetadata().getName()==="sap.ui.vk.NativeViewport":false;}l.prototype._getViewport=function(){var i=k.byId(this.getViewport());i=i instanceof f&&i.getImplementation()||i;return i&&(r(i)||s(i))?i:null;};l.prototype._getViewStateManager=function(){var i=k.byId(this.getViewport());var p=i.getViewStateManager();if(p){return k.byId(p);}return null;};var u=[null,new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0),0),new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0),Math.PI),new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0),-Math.PI/2),new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0),Math.PI/2),new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(1,0,0),-Math.PI/2),new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(1,0,0),Math.PI/2)];l.prototype.createButtons=function(){var i=this;var p,A;function E(_,a1,b1){p.setPressed(true);if(i._crossSectionTool){i._crossSectionTool.setActive(true,_);if(a1!==undefined){i._crossSectionTool.setAxis(a1);A.setIcon(q+"cross-section-"+["x","y","z"][a1]);}}}p=new a({icon:q+"cross-section",type:sap.m.ButtonType.Transparent,tooltip:g().getText("CROSS_SECTION_TOOLTIP"),press:function(_){var a1=i._getViewport();if(a1){if(this.getPressed()){E(a1);}else if(i._crossSectionTool){i._crossSectionTool.setActive(false,a1);}}}});p.vitId=h.CrossSection;A=new M({type:sap.m.ButtonType.Transparent,tooltip:g().getText("CROSS_SECTION_AXIS_TOOLTIP"),icon:q+"cross-section-x",menu:new d({items:[new e({icon:q+"cross-section-x",text:g().getText("CROSS_SECTION_X"),press:function(_){var a1=i._getViewport();if(a1){E(a1,0,false);}}}),new e({icon:q+"cross-section-y",text:g().getText("CROSS_SECTION_Y"),press:function(_){var a1=i._getViewport();if(a1){E(a1,1,false);}}}),new e({icon:q+"cross-section-z",text:g().getText("CROSS_SECTION_Z"),press:function(_){var a1=i._getViewport();if(a1){E(a1,2,false);}}}),new e({icon:q+"reverse-direction",text:g().getText("CROSS_SECTION_REVERSE"),startsSection:true,press:function(_){var a1=i._getViewport();if(a1&&i._crossSectionTool&&i._crossSectionTool.getActive()){i._crossSectionTool.setFlip(!i._crossSectionTool.getFlip());}}})]})});A.vitId=h.CrossSectionAxis;var G=new a({icon:q+"turntable",type:sap.m.ButtonType.Transparent,tooltip:g().getText("TURNTABLE_TOOLTIP"),press:function(_){var a1=i._getViewport();if(a1){i._activateGesture(a1,0);}}});G.vitId=h.Turntable;var H=new a({icon:q+"orbit",type:sap.m.ButtonType.Transparent,tooltip:g().getText("ORBIT_TOOLTIP"),pressed:false,press:function(_){var a1=i._getViewport();if(a1){i._activateGesture(a1,1);}}});H.vitId=h.Orbit;var J=new a({icon:q+"pan",type:sap.m.ButtonType.Transparent,tooltip:g().getText("PAN_TOOLTIP"),press:function(_){var a1=i._getViewport();if(a1){i._activateGesture(a1,2);}}});J.vitId=h.Pan;var K=new a({icon:q+"zoom",type:sap.m.ButtonType.Transparent,tooltip:g().getText("ZOOM_TOOLTIP"),press:function(){var _=i._getViewport();if(_){i._activateGesture(_,3);}}});K.vitId=h.Zoom;this._activeGesture=-1;this._gestureButtons=[G,H,J,K];var L=new B({icon:q+"show",type:sap.m.ButtonType.Transparent,tooltip:g().getText("SHOW_TOOLTIP"),press:function(){var _=i._getViewStateManager();if(_){var a1=[];_.enumerateSelection(function(b1){a1.push(b1);});_.setVisibilityState(a1,true,false);}}});L.vitId=h.Show;var N=new B({icon:q+"hide",type:sap.m.ButtonType.Transparent,tooltip:g().getText("HIDE_TOOLTIP"),press:function(){var _=i._getViewStateManager();if(_){var a1=[];_.enumerateSelection(function(b1){a1.push(b1);});_.setVisibilityState(a1,false,false);}}});N.vitId=h.Hide;var P=new B({icon:q+"fit-to-view",type:sap.m.ButtonType.Transparent,tooltip:g().getText("FIT_TO_VIEW"),press:function(){var _=k.byId(i.getViewport());_=_ instanceof f&&_.getImplementation()||_;if(_){if(t(_)){_._bestFit();}else{_.zoomTo(Z.All,null,0.5,0);}}}});P.vitId=h.FitToView;this._rectSelectionButton=new a({icon:q+"rectangular-selection",type:sap.m.ButtonType.Transparent,tooltip:g().getText("RECTANGULAR_SELECTION_TOOLTIP")});this._rectSelectionButton.vitId=h.RectangularSelection;var Q=new M({icon:q+"predefined-views",activeIcon:q+"predefined-views",type:sap.m.ButtonType.Transparent,tooltip:g().getText("PREDEFINED_VIEW_MENUBUTTONTOOLTIP"),menu:new d({items:[new e({text:g().getText("PREDEFINED_VIEW_INITIAL")}),new e({text:g().getText("PREDEFINED_VIEW_FRONT"),startsSection:true}),new e({text:g().getText("PREDEFINED_VIEW_BACK")}),new e({text:g().getText("PREDEFINED_VIEW_LEFT")}),new e({text:g().getText("PREDEFINED_VIEW_RIGHT")}),new e({text:g().getText("PREDEFINED_VIEW_TOP")}),new e({text:g().getText("PREDEFINED_VIEW_BOTTOM")})]}).attachItemSelected(function(_){var a1=i._getViewport();if(a1){var b1=_.getParameters("item").item;var c1=this.indexOfItem(b1);a1._viewportGestureHandler.setView(u[c1],1000);}})});Q.vitId=h.PredefinedViews;var S=new a({icon:q+"full-screen",type:sap.m.ButtonType.Transparent,tooltip:g().getText("VIEWER_FULLSCREENBUTTONTOOLTIP"),press:function(_){var a1=i._getViewport();var b1=function(d1){return!!(d1.fullScreen||d1.webkitIsFullScreen||d1.mozFullScreen||d1.msFullscreenElement);};if(this.getPressed()){if(!b1(document)){if(!i._fullScreenHandler){i._fullScreenHandler=function(_){var d1=b1(document);if(!d1){document.removeEventListener("fullscreenchange",i._fullScreenHandler);document.removeEventListener("mozfullscreenchange",i._fullScreenHandler);document.removeEventListener("webkitfullscreenchange",i._fullScreenHandler);document.removeEventListener("MSFullscreenChange",i._fullScreenHandler);this.setPressed(false);a1.removeStyleClass("sapVizKitViewerFullScreen");}}.bind(this);}var c1=document.getElementsByTagName("body")[0];if(c1.requestFullscreen){document.addEventListener("fullscreenchange",i._fullScreenHandler);c1.requestFullscreen();}else if(c1.webkitRequestFullScreen){document.addEventListener("webkitfullscreenchange",i._fullScreenHandler);c1.webkitRequestFullscreen();}else if(c1.mozRequestFullScreen){document.addEventListener("mozfullscreenchange",i._fullScreenHandler);c1.mozRequestFullScreen();}else if(c1.msRequestFullscreen){document.addEventListener("MSFullscreenChange",i._fullScreenHandler);c1.msRequestFullscreen();}}a1.addStyleClass("sapVizKitViewerFullScreen");}else{if(b1(document)){if(document.cancelFullScreen){document.cancelFullScreen();}else if(document.msExitFullscreen){document.msExitFullscreen();}else if(document.mozCancelFullScreen){document.mozCancelFullScreen();}else if(document.webkitCancelFullScreen){document.webkitCancelFullScreen();}}a1.removeStyleClass("sapVizKitViewerFullScreen");}}});S.vitId=h.FullScreen;var U=new T();var W=new T();var X=new T();var Y=new T();this._itemsShowHideSelect=[L,N,X,this._rectSelectionButton,Y];this._items3D=[this._gestureButtons[0],this._gestureButtons[1],p,A,U,Q,W];var $=[L,N,X,this._gestureButtons[0],this._gestureButtons[1],this._gestureButtons[2],this._gestureButtons[3],new T(),P,new T(),this._rectSelectionButton,Y,p,A,U,Q,W,S];$.forEach(function(_){this._itemsVisibility.set(_,true);this._itemsVisibilityObserver.observe(_,{properties:["visible"]});}.bind(this));return $;};var w=["drawerToolbarIconTurntable","drawerToolbarIconOrbit","drawerToolbarIconPan","drawerToolbarIconZoom"];var x=function(i,p){this.viewport=i;this._toolbar=p;this._mode=1;this._gesture=false;this._x=0;this._y=0;};function y(p,A){w.forEach(function(E,i){if(p.hasStyleClass(E)&&i!==A){p.removeStyleClass(E);}else if(i===A){p.addStyleClass(E);}});}function z(i){var p=i.viewport;var A=i._mode;var E=p.hasStyleClass(w[A])?A:-1;i._isScrolling=true;if(E!==3){y(p,3);setTimeout(function(){i._isScrolling=false;y(p,E);},500);}}x.prototype.beginGesture=function(i){this._gesture=true;if(this._mode<3){this._x=i.points[0].x;this._y=i.points[0].y;}else{this._x=i.x;this._y=i.y;}if(i.scroll){z(this);}if(this._toolbar._rectSelectionButton.getPressed()||(i.event&&(sap.ui.Device.os.macintosh?i.event.metaKey:i.event.ctrlKey))){var p=this.viewport.getDomRef().getBoundingClientRect();this._selectionRect={x1:this._x-p.left,y1:this._y-p.top,x2:this._x-p.left,y2:this._y-p.top};}};x.prototype.endGesture=function(){this._gesture=false;if(this._selectionRect&&(this._selectionRect.x1!==this._selectionRect.x2||this._selectionRect.y1!==this._selectionRect.y2)){this._toolbar._rectSelectTool._select(this._selectionRect.x1,this._selectionRect.y1,this._selectionRect.x2,this._selectionRect.y2,this.viewport,this.viewport.getScene(),this.viewport.getCamera());this._selectionRect=null;this.viewport.setSelectionRect(null);}else if(!this._isScrolling){y(this.viewport,-1);}};x.prototype.move=function(i){if(this._gesture){if(i.n==1){var p=i.points[0];if(this._selectionRect){var A=this.viewport.getDomRef().getBoundingClientRect();this._selectionRect.x2=p.x-A.left;this._selectionRect.y2=p.y-A.top;this.viewport.setSelectionRect(this._selectionRect);}else{y(this.viewport,this._mode);var E=p.x-this._x;var G=p.y-this._y;var H=r(this.viewport)?this.viewport._viewportGestureHandler._cameraController:this.viewport;switch(this._mode){case 0:H.rotate(E,G,true);break;case 1:H.rotate(E,G,false);break;case 2:H.pan(E,G);break;case 3:H.zoom(1+G*0.005);break;default:break;}this._x=p.x;this._y=p.y;}i.handled=true;}else if(i.n==2&&!this._isScrolling){y(this.viewport,2);}}};x.prototype.hover=function(){};x.prototype.getViewport=function(){return this.viewport;};l.prototype._activateGesture=function(i,p){this._activeGesture=p;this._gestureButtons.forEach(function(A,E){A.setPressed(E===p);});if(!this._cameraHandler||this._cameraHandler.getViewport()!=i){this._cameraHandler=new x(i,this);i._loco.addHandler(this._cameraHandler,0);}this._cameraHandler._mode=p;};l.prototype._getToolbar=function(){return this._toolbar;};l.prototype._toggleExpanded=function(){var i=!this.getExpanded();this.setExpanded(i);this.fireExpanded({expand:i});};l.prototype.setExpanded=function(E){this.setProperty("expanded",E,true);var i=this.getDomRef();if(i){if(!E){i.classList.add("drawerToolbarCollapsed");i.classList.remove("drawerToolbarExpanded");this._container.addStyleClass("vboxCollapsed");}else{i.classList.add("drawerToolbarExpanded");i.classList.remove("drawerToolbarCollapsed");this._container.removeStyleClass("vboxCollapsed");}}return this;};l.prototype.onBeforeRendering=function(){var i=this._getViewport();this.setVisible(!!i);if(i){var p=r(i);var A=t(i);this._ignoreVisiblityChange=true;this._itemsShowHideSelect.forEach(function(E){E.setVisible(!A&&this._itemsVisibility.get(E));}.bind(this));this._items3D.forEach(function(E){E.setVisible(p&&this._itemsVisibility.get(E));}.bind(this));this._ignoreVisiblityChange=false;if(p){this._crossSectionTool=this._crossSectionTool||new c();i.addTool(this._crossSectionTool);}this._activateGesture(i,Math.max(this._activeGesture,p?0:2));}};return l;});
