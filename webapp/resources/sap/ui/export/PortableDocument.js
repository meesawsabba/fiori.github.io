/*!
 * SAPUI5
 * (c) Copyright 2009-2021 SAP SE. All rights reserved.
 */
sap.ui.define(['sap/base/Log','sap/ui/core/Core','sap/ui/export/ExportBase','sap/ui/export/ExportUtils','sap/ui/model/odata/v4/ODataModel'],function(L,C,E,a,O){'use strict';var P=E.extend('sap.ui.export.PortableDocument',{constructor:function(s){E.call(this,s);}});P.prototype.processDataSource=function(d){var D=null;var s=typeof d;if(!d){return null;}if(s!='object'){L.error('Spreadsheet#processDataSource: Unable to apply data source of type '+s);return null;}if(d.dataUrl&&d.serviceUrl){D=d;}if(d.isA&&d.isA(['sap.ui.model.ListBinding','sap.ui.model.TreeBinding'])){D=this.createDataSourceFromBinding(d);}return D;};P.prototype.createDataSourceFromBinding=function(b){var d=null;if(b.isA('sap.ui.model.ClientListBinding')){L.error('Unable to create dataSource configuration due to not supported Binding: '+b.getMetadata().getName());}if(b.isA('sap.ui.model.ClientTreeBinding')){L.error('Unable to create dataSource configuration due to not supported Binding: '+b.getMetadata().getName());}if(typeof b.getDownloadUrl==='function'){var m=b.getModel(),D=a.interceptUrl(b.getDownloadUrl('json')),s=a.interceptUrl(m.sServiceUrl),v=m.isA('sap.ui.model.odata.v4.ODataModel');var o=new URL(D,document.baseURI);o.hash='';o.search='';d={type:'odata',version:v?4:2,dataUrl:o.toString(),serviceUrl:s.split('/').slice(0,-4).join("/")+"/iwbep/common/0001/",headers:v?m.getHttpHeaders(true):m.getHeaders()};}return d;};P.prototype._createDocumentDescription=function(w){var d,m;d={"Title":w.context.title,"Format":{"PaperSize":"DIN_A4","Orientation":"LANDSCAPE","FontSize":12},"CoverPage":[],"TableColumns":[]};m=w.context.metaInfo;if(m instanceof Array){m.forEach(function(g){var c={"Title":g.name,"Content":[]};g.items.forEach(function(i){c["Content"].push({"Name":i.key,"Value":i.value});});d["CoverPage"].push(c);});}w.columns.forEach(function(c){d["TableColumns"].push({"Name":c.property,"Header":c.label});});return d;};P.prototype.setDefaultExportSettings=function(s){var c=s&&s.workbook&&s.workbook.context;if(!(c instanceof Object)){c=s.workbook.context={};}if(typeof c.title==='string'){return Promise.resolve();}return C.getLibraryResourceBundle('sap.ui.export',true).then(function(r){c.title=r.getText('XLSX_DEFAULT_TITLE');});};P.prototype.createBuildPromise=function(s){var t=this;return new Promise(function(r,R){var b,d,m;d=t._createDocumentDescription(s.workbook);m=new O({serviceUrl:s.dataSource.serviceUrl,synchronizationMode:'None'});b=m.bindList('/MyDocumentDescriptions');b.attachCreateCompleted(function(e){var c=e.getParameter('success');if(c){r(e.getParameter('context').getObject()['Id']);}else{R();}});b.create(d);}).then(function(d){return t.sendRequest(s.dataSource.dataUrl,d).then(function(r){a.saveAsFile(r,s.fileName);});});};P.prototype.sendRequest=function(u,d){return new Promise(function(r,R){var x=this.request=new XMLHttpRequest();x.open('GET',u);x.responseType='blob';x.setRequestHeader("Accept","application/pdf");x.setRequestHeader("SAP-Document-Description-Id",d);x.addEventListener('abort',function(){R('Request aborted');});x.addEventListener('error',function(){R('Error occured while requesting data');});x.addEventListener('load',function(){var s=x.status;if(s>=200&&s<=400){r(x.response);}else{R(x.response);}});x.send();}.bind(this));};P.prototype.cancel=function(){if(this.request&&this.request.readyState!=XMLHttpRequest.DONE){this.request.abort();this.request=null;}};return P;});
