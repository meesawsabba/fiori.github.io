/*!
 * SAPUI5
 * (c) Copyright 2009-2021 SAP SE. All rights reserved.
 */
sap.ui.define(['sap/ui/core/Core','./ExportDialog','sap/ui/export/ExportBase','sap/ui/Device','sap/ui/export/SpreadsheetExport','sap/base/Log','sap/ui/export/ExportUtils'],function(C,E,a,D,S,L,b){'use strict';var c='sap.ui.export.Spreadsheet';var d=a.extend(c,{constructor:function(s){a.call(this,s);this._mSettings.customizing={};this._mSettings.showProgress=true;this._mSettings.worker=true;['showProgress','worker'].forEach(function(p){if(typeof s[p]!=='undefined'){this._mSettings[p]=s[p];}}.bind(this));this.codeListsPromise=this.codeListsPromise instanceof Promise?this.codeListsPromise:Promise.resolve();}});function e(s,o,m){if(!(m[s]instanceof Object)){m[s]={};}if(!isNaN(o.digits)){m[s].scale=o.digits;}if(!isNaN(o.UnitSpecificScale)){m[s].scale=o.UnitSpecificScale;}if(isNaN(m[s].scale)){delete m[s];}}d.prototype.setDefaultExportSettings=function(p){var s,m,u;m=p.customizing.currency={};var o=C.getConfiguration().getFormatSettings().getCustomCurrencies();if(o){for(s in o){e(s,o[s],m);}}return this.codeListsPromise.then(function(f){var g,U,h;if(!Array.isArray(f)){return;}u=p.customizing.unit={};g=f[0];U=f[1];for(h in g){e(h,g[h],m);}for(h in U){e(h,U[h],u);}}).then(function(){return C.getLibraryResourceBundle('sap.ui.export',true);}).then(function(r){var w=p.workbook.context;if(!(w instanceof Object)){w=p.workbook.context={};}if(!w.title){w.title=r.getText('XLSX_DEFAULT_TITLE');}if(!w.sheetName){w.sheetName=r.getText('XLSX_DEFAULT_SHEETNAME');}});};d.requestCodeLists=function(m){if(!m.isA(['sap.ui.model.odata.ODataMetaModel','sap.ui.model.odata.v4.ODataMetaModel'])){return Promise.resolve([null,null]);}return Promise.all([m.requestCurrencyCodes(),m.requestUnitsOfMeasure()]).catch(function(o){L.warning(c+': Code lists cannot be processed due to the following error - '+o);return Promise.resolve([null,null]);});};d.prototype.attachBeforeSave=function(o,h,l){return this.attachEvent('beforeSave',o,h,l);};d.prototype.detachBeforeSave=function(h,l){return this.detachEvent('beforeSave',h,l);};d.prototype.cancel=function(){if(this.process){this.process.cancel();this.process=null;}return this;};d.prototype.onprogress=function(f,t){var p;if(isNaN(f)||isNaN(t)){return;}p=Math.round(f/t*100);L.debug('Spreadsheet export: '+p+'% loaded.');};d.prototype.createDataSourceFromBinding=function(B){var o=[];if(B.isA('sap.ui.model.ClientListBinding')){var f=B.getModel().getProperty(B.getPath());o={data:(f instanceof Array)?f:[],type:'array'};}if(B.isA('sap.ui.model.ClientTreeBinding')){L.error('Unable to create dataSource configuration due to not supported Binding: '+B.getMetadata().getName());}if(typeof B.getDownloadUrl==='function'){var m=B.getModel(),s=B.getDownloadUrl('json'),g=m.sServiceUrl,v=m.isA('sap.ui.model.odata.v4.ODataModel');s=b.interceptUrl(s);g=b.interceptUrl(g);o={type:'odata',dataUrl:s,serviceUrl:g,headers:v?m.getHttpHeaders(true):m.getHeaders(),count:b.getCountFromBinding(B),useBatch:v||m.bUseBatch};if(m.getMetaModel()&&typeof m.getMetaModel().requestCurrencyCodes==='function'&&typeof m.getMetaModel().requestUnitsOfMeasure==='function'){this.codeListsPromise=d.requestCodeLists(m.getMetaModel(),this._mSettings);}}return o;};d.prototype.processDataSource=function(o){var m=null;var s=typeof o;if(!o){return null;}if(s=='string'){return{count:this._mSettings.count,dataUrl:o,type:'odata',useBatch:false};}if(s!='object'){L.error('Spreadsheet#processDataSource: Unable to apply data source of type '+s);return null;}if(o instanceof Array){m={data:o,type:'array'};}if(o.dataUrl){m=o;}if(o.isA&&o.isA(['sap.ui.model.ListBinding','sap.ui.model.TreeBinding'])){m=this.createDataSourceFromBinding(o);}return m;};d.prototype.createBuildPromise=function(p){var t=this;return new Promise(function(r,R){var f;var M=1048576;var n=D.system.desktop?2000000:100000;var g=p.dataSource.type=='array'?p.dataSource.data.length:p.dataSource.count;var h=p.workbook.columns.length;function o(m){if(m.progress){if(f){f.updateStatus(m.fetched,m.total);}t.onprogress(m.fetched,m.total);}if(m.finished&&t.process!==null){t.process=null;if(!m.spreadsheet){R('Spreadsheet export: The process was canceled');return;}var j=t.fireEvent('beforeSave',{data:m.spreadsheet},true,true);if(f){window.setTimeout(f.finish,1000);}if(j){b.saveAsFile(new Blob([m.spreadsheet],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}),p.fileName);}r();}if(typeof m.error!='undefined'){var k=m.error.message||m.error;t.process=null;if(f){f.finish();}R(k);E.showErrorMessage(k);}}function s(){if(!p.showProgress){if(t.process){R('Cannot start export: the process is already running');return;}t.process=S.execute(p,o);return;}E.getProgressDialog().then(function(j){f=j;if(t.process){R('Cannot start export: the process is already running');return;}f.oncancel=function(){return t.process&&t.process.cancel();};f.open();f.updateStatus(0,p.dataSource.count);t.process=S.execute(p,o);});}if(h<=0){R('No columns to export.');}else if(g*h>n||!g||g>=M){var i={rows:g,columns:h,sizeLimit:g*h>n,cutOff:g>=M};E.showWarningDialog(i).then(s).catch(function(){R('Export cancelled by the user.');});}else{s();}});};return d;});
