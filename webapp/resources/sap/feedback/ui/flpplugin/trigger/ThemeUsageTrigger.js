/*!
 * SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/base/Object","sap/base/Log","../utils/Constants","../utils/Utils"],function(O,L,C,U){"use strict";return O.extend("sap.feedback.ui.flpplugin.trigger.ThemeUsageTrigger",{_oLocalStorage:null,_fnShowSurveyCallback:null,constructor:function(s,l){this._fnShowSurveyCallback=s;this._oLocalStorage=l;},evaluateOnThemeChanged:function(a){var l=this._getLastTheme();if(U.isHorizonTheme(a)){this._updateThemeTimestamp();}else if(U.isHorizonTheme(l)){if(this._isOptOutSurveyAllowed()){var c=this._getFollowUpCountOptOutForContext();this._fnShowSurveyCallback(C.E_CLIENT_ACTION.themeChangedOptOut,c);}this._deleteThemeTimestamp();this._oLocalStorage.updateFollowUpOptOut();}},evaluateThemeUsageDuration:function(){var a=sap.ui.getCore().getConfiguration().getTheme();if(U.isHorizonTheme(a)){if(this._hasDurationPassedOptIn()){var c=this._getFollowUpCountOptInForContext();this._fnShowSurveyCallback(C.E_CLIENT_ACTION.themeChangedOptIn,c);this._updateThemeTimestamp();this._oLocalStorage.updateFollowUpOptIn();}}},_getFollowUpCountOptInForContext:function(){var c=this._oLocalStorage.getFollowUpOptIn();if(c!==null){return c+1;}return 0;},_getFollowUpCountOptOutForContext:function(){var c=this._oLocalStorage.getFollowUpOptOut();if(c!==null){return c+1;}return 0;},_getLastTheme:function(){if(this._oLocalStorage){return this._oLocalStorage.getLastTheme();}return null;},_deleteThemeTimestamp:function(){if(this._oLocalStorage){this._oLocalStorage.deleteKey(C.S_STOR_THEME_START);}},_updateThemeTimestamp:function(){if(this._oLocalStorage){this._oLocalStorage.updateValue(C.S_STOR_THEME_START,Date.now().toString(10));}},_readThemeTimestamp:function(){if(this._oLocalStorage){return this._oLocalStorage.getNumberForKey(C.S_STOR_THEME_START);}return null;},_isOptOutSurveyAllowed:function(){var c=this._oLocalStorage.getFollowUpOptOut();if(c<C.I_MAX_COUNT_SURVEY_FOLLOWUP_OPTOUT){return true;}return false;},_hasDurationPassedOptIn:function(){var c=this._oLocalStorage.getFollowUpOptIn();if(c<C.I_MAX_COUNT_SURVEY_FOLLOWUP_OPTIN){var t=this._readThemeTimestamp();if(t){var T=this._calculateThresholdOptIn(c,t);if(T&&T<Date.now()){return true;}}else{this._updateThemeTimestamp();}}return false;},_calculateThresholdOptIn:function(c,t){switch(c){case 0:return this._addMinutes(t,C.I_MINUTES_WAIT_SURVEY_FOLLOWUP_1);case 1:return this._addMinutes(t,C.I_MINUTES_WAIT_SURVEY_FOLLOWUP_2);case 2:return this._addMinutes(t,C.I_MINUTES_WAIT_SURVEY_FOLLOWUP_3);default:return null;}},_addMinutes:function(t,m){if(t&&m){return new Date(t+m*60000).getTime();}return null;}});});
