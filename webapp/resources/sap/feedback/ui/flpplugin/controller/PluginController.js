/*!
 * SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/base/Object","sap/base/Log","../utils/Constants","../utils/Utils","./ContextDataController","./PushClient","../ui/ShellBarButton","../ui/PopOverVisual","../ui/IFrameVisual","./WebAppFeedbackLoader","../trigger/ThemeUsageTrigger","../utils/Storage"],function(O,L,C,U,a,P,S,b,I,W,T,c){"use strict";return O.extend("sap.feedback.ui.flpplugin.controller.PluginController",{_oConfig:null,_oContextDataController:null,_oPushClient:null,_oShellButton:null,_oWebAppFeedbackLoader:null,_fnRendererPromise:null,_oResourceBundle:null,_oThemeUsageTrigger:null,_oLocalStorage:null,_sLastThemeId:null,_sCurrentThemeId:null,constructor:function(o,r,R){this._oConfig=o;this._fnRendererPromise=r;this._oResourceBundle=R;},init:function(){this._initStorage();this._initLastTheme();return new Promise(function(r,d){if(this._oConfig){this._initContextData();this._initPushChannel();this._initUI();this._initWebAppFeedback();this._updateInitialContextData().then(function(){r();}).catch(function(e){L.error("Fiori Feedback Plug-in error occured on updating context data on init.",null,C.S_PLUGIN_PLGCTRL_NAME);r();});}else{d();}}.bind(this));},_initStorage:function(){if(U.isLocalStorageAvailable()){this._oLocalStorage=new c();this._oLocalStorage.init();}},_initLastTheme:function(){this._sCurrentThemeId=sap.ui.getCore().getConfiguration().getTheme();if(this._oLocalStorage){var s=this._oLocalStorage.getLastTheme();if(!s){this._oLocalStorage.updateLastTheme(this._sCurrentThemeId);this._sLastThemeId=this._sCurrentThemeId;}else{this._sLastThemeId=s;}}},_initContextData:function(){this._oContextDataController=new a(this._oConfig);return this._oContextDataController.init();},_initPushChannel:function(){if(this._oConfig.getIsPushEnabled()){this._oPushClient=new P(this._oConfig);this._oPushClient.init(this._onPushCallback.bind(this));}},_initUI:function(){var d=this._oConfig.getDisplayFormat();if(d){if(d===C.E_DISPLAY_FORMAT.popover){this._oVisual=new b();}else if(d===C.E_DISPLAY_FORMAT.iframe){this._oVisual=new I(this._oConfig,this._oResourceBundle);}if(this._oVisual){this._oShellButton=new S(this._fnRendererPromise,this._onSurveyShow.bind(this),this._oResourceBundle);this._oShellButton.init();}}},_initWebAppFeedback:function(){this._oWebAppFeedbackLoader=new W(this._oConfig);this._oWebAppFeedbackLoader.init(this._onAPILoadedCallback.bind(this));this._oWebAppFeedbackLoader.loadAPI();},_initTriggers:function(){if(U.isFioriNextBeta1FeatureAvailable(this._oConfig)){this._oThemeUsageTrigger=new T(this._openSurvey.bind(this),this._oLocalStorage);sap.ui.getCore().attachThemeChanged(function(e){this._onThemeChanged(e);}.bind(this));}},_updateInitialContextData:function(){return this._oContextDataController.updateContextData(C.E_CLIENT_ACTION.init);},_onAPILoadedCallback:function(){return this._oContextDataController.updateContextData(C.E_CLIENT_ACTION.init).then(function(){this._getAppLifeCycleService().attachAppLoaded({},this._onAppLoaded,this);this._initTriggers();}.bind(this)).catch(function(e){L.error("Fiori Feedback Plug-in error occured on updating context data on load.",null,C.S_PLUGIN_PLGCTRL_NAME);});},_getAppLifeCycleService:function(){return sap.ushell.Container.getService("AppLifeCycle");},_onPushCallback:function(e){return new Promise(function(r){if(this._oWebAppFeedbackLoader.getIsAPILoaded()){this._oContextDataController.updateContextData(C.E_CLIENT_ACTION.backendPush,e).then(function(){this._openSurvey(C.E_CLIENT_ACTION.backendPush,null);r();}.bind(this)).catch(function(E){L.error("Fiori Feedback Plug-in error occured on updating push context data.",null,C.S_PLUGIN_PLGCTRL_NAME);});}else{r();}}.bind(this));},_openSurvey:function(s,f){if(this._oContextDataController){this._oContextDataController.setClientAction(s);this._oContextDataController.setLastTheme(this._sLastThemeId);this._oContextDataController.setFollowUpCount(f);}QSI.API.unload();QSI.API.load().then(function(){QSI.API.run();});},_onSurveyShow:function(){return new Promise(function(r){if(this._oWebAppFeedbackLoader.getIsAPILoaded()){this._oContextDataController.updateContextData(C.E_CLIENT_ACTION.navBarClick,null).then(function(){var d=this._oConfig.getDisplayFormat();if(d===C.E_DISPLAY_FORMAT.iframe){var u=this._oContextDataController.getContextDataAsUrlParameter();this._oVisual.show(u);r();}else{this._oVisual.show();r();}}.bind(this)).catch(function(e){L.error("Fiori Feedback Plug-in error occured on updating context data on show.",null,C.S_PLUGIN_PLGCTRL_NAME);});}}.bind(this));},_onAppLoaded:function(){return this._oContextDataController.updateContextData(C.E_CLIENT_ACTION.appLoaded).then(function(){if(U.isFioriNextBeta1FeatureAvailable(this._oConfig)){if(this._oThemeUsageTrigger){this._oThemeUsageTrigger.evaluateThemeUsageDuration();}}}.bind(this)).catch(function(e){L.error("Fiori Feedback Plug-in error occured on updating context data.",null,C.S_PLUGIN_PLGCTRL_NAME);});},_onThemeChanged:function(e){var n=e.getParameters().theme;if(this._sCurrentThemeId!==n){this._updateLastTheme(this._sCurrentThemeId);this._sCurrentThemeId=n;return this._oContextDataController.updateContextData(C.E_CLIENT_ACTION.themeChanged).then(function(){if(this._oThemeUsageTrigger){this._oThemeUsageTrigger.evaluateOnThemeChanged(n);}}.bind(this)).catch(function(E){L.error("Fiori Feedback Plug-in error occured on updating context data.",null,C.S_PLUGIN_PLGCTRL_NAME);});}},_updateLastTheme:function(n){if(this._oLocalStorage){this._oLocalStorage.updateLastTheme(n);this._sLastThemeId=n;}}});});
