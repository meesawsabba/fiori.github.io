/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/core/utils/filter","sap/apf/utils/hashtable","sap/apf/core/messageHandler","sap/apf/core/messageDefinition","sap/apf/core/odataProxy","sap/apf/core/layeredRepositoryProxy","sap/apf/cloudFoundry/runtimeProxy","sap/apf/core/constants","sap/apf/utils/startParameter","sap/apf/utils/utils","sap/ui/thirdparty/jquery"],function(f,h,m,a,o,l,r,c,s,u,q){'use strict';sap.apf.core.ResourcePathHandler=function(i){var t=this;var b=i.instances.coreApi;var m=i.instances.messageHandler;var H=new sap.apf.utils.Hashtable(m);var C;var p;var S=null;var d=q.Deferred();var e=false;var P;this.loadConfigFromFilePath=function(F){if(e){return;}e=true;var G=b.getStartParameterFacade().getAnalyticalConfigurationId();var U=F;b.ajax({url:U,dataType:"json",success:I,error:function(J,K,L){var M=m.createMessageObject({code:"5068",aParameters:[U,K,L]});D(M);},async:true,suppressSapSystem:true});function I(J,K,L){var T=i.functions.checkForTimeout(L);var M;if(T){M=m.createMessageObject({code:"5054",aParameters:[F]});M.setPrevious(T);D(M);}if(!J||!J.applicationConfiguration){D(m.createMessageObject({code:"5055",aParameters:[F]}));}if(J.applicationConfiguration.textResourceLocations===undefined){D(m.createMessageObject({code:"5056",aParameters:[F]}));return;}B(J,G);v().done(function(){if(G){j(G);}else{n();}});}};function g(){return b.getStartParameterFacade().isLrepActive();}function j(F){var G=F.applicationId;var I=F.configurationId;if(g()&&!G){D(m.createMessageObject({code:"5024"}));}var o=new P({serviceRoot:p&&p.path&&p.path.service,entityTypes:{configuration:sap.apf.core.constants.entitySets.configuration,texts:sap.apf.core.constants.entitySets.texts}},{instances:{coreApi:b,messageHandler:m},manifests:i.manifests});if(g()){var J=[];var K=q.Deferred();J.push(K);J.push(k(G,o));}o.readEntity("configuration",function(L,M,N){if(N){D(m.createMessageObject({code:"5022",aParameters:[I]}));d.resolve();}else{var O=JSON.parse(L.SerializedAnalyticalConfiguration);b.loadAnalyticalConfiguration(O);if(O.applicationTitle){C.appName=O.applicationTitle.key;C.appTitle=O.applicationTitle.key;}if(g()){K.resolve();}else{G=G||L.Application;k(G,o).then(function(){d.resolve();});}}},[{name:"AnalyticalConfiguration",value:I}],undefined,G,{layer:'ALL'},{'noMetadata':true});if(g()){q.when.apply(q,J).then(function(){d.resolve();});}}function k(F,o){var G=q.Deferred();var I=new sap.apf.core.utils.Filter(m,'Application','eq',F);var f=new sap.apf.core.utils.Filter(m,'Language','eq',sap.apf.core.constants.developmentLanguage);f.addAnd(I);var J=["TextElement","TextElementDescription"];o.readCollection('texts',function(K,L,M){if(M){D(m.createMessageObject({code:"5023",aParameters:[b.getStartParameterFacade().getAnalyticalConfigurationId()]}));}else{b.loadTextElements(K);}G.resolve();},undefined,J,f,{layer:'ALL'});return G.promise();}function n(){var U=t.getResourceLocation(sap.apf.core.constants.resourceLocation.analyticalConfigurationLocation);var M;if(U!==""){b.ajax({url:U,dataType:"json",success:function(F,G,J){if(F){b.loadAnalyticalConfiguration(F);if(F.applicationTitle){C.appName=F.applicationTitle.key;C.appTitle=F.applicationTitle.key;}d.resolve();}else{M=m.createMessageObject({code:"5057",aParameters:[U]});D(M);}},error:function(J,F,G,I){M=m.createMessageObject({code:"5057",aParameters:[U]});if(I){M.setPrevious(I);}D(M);},async:true,suppressSapSystem:true});}else{M=m.createMessageObject({code:"5060"});D(M);}}function v(){b.loadMessageConfiguration(sap.apf.core.messageDefinition,true);return w(sap.apf.core.constants.resourceLocation.applicationMessageDefinitionLocation,false);}function w(R,F){var G=q.Deferred();var U=t.getResourceLocation(R);if(U!==""){b.ajax({url:U,dataType:"json",success:I,error:function(J,K,L,M){var N=m.createMessageObject({code:"5058",aParameters:[K,L,U]});if(M){N.setPrevious(M);}D(N);},async:true,suppressSapSystem:true});}else{G.resolve();}return G.promise();function I(J,K,L){var M;var T=i.functions.checkForTimeout(L);if(!T){if(J.messageConfiguration){b.loadMessageConfiguration(J.messageConfiguration.definitions,F);}}else{M=m.createMessageObject({code:"5067"});M.setPrevious(T);D(M);}G.resolve();}}function x(F){var M;if(!F||!F.path){M=m.createMessageObject({code:"5066"});D(M);}if(!F.path.service){M=m.createMessageObject({code:"5067"});D(M);}if(F.analyticalConfiguration){if(!F.analyticalConfiguration.service){M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorInAnalyticalConfig,rawText:"service or entity set are missing in analytical configuration in the application configuration"});D(M);}}}function y(F){var M;if(F.evaluations&&!F.evaluations.service){M=m.createMessageObject({code:"5063"});D(M);}if(F.evaluations&&(!F.evaluations.type||F.evaluations.type!=="smartBusinessRequest")){M=m.createMessageObject({code:"5062",rawText:"type in Smart Business configuration is not smartBusinessRequest"});D(M);}if(F.evaluations&&!F.evaluations.entityType){M=m.createMessageObject({code:"5061"});D(M);}}this.getResourceLocation=function(R){return H.getItem(R);};this.getPersistenceConfiguration=function(){var F=q.Deferred();d.done(function(){F.resolve(p);});return F;};this.getConfigurationProperties=function(){var F=q.Deferred();i.corePromise.done(function(){F.resolve(C);});return F;};function z(){var F=sap.apf.core.utils.uriGenerator;var G,I,J;var K=i.manifests.manifest;var L=i.manifests.baseManifest;var M;if(d.state()==='resolved'){return;}var N=F.getBaseURLOfComponent(sap.apf.utils.getComponentNameFromManifest(i.manifests.baseManifest));var O=F.getBaseURLOfComponent(sap.apf.utils.getComponentNameFromManifest(i.manifests.manifest));if(K["sap.app"].dataSources&&K["sap.app"].dataSources.PathPersistenceServiceRoot){J=K["sap.app"].dataSources.PathPersistenceServiceRoot.uri;}else if(i.functions.isUsingCloudFoundryProxy()){J="";}else{M=m.createMessageObject({code:"5064"});D(M);}var Q=L["sap.app"].i18n;if(typeof Q==="string"){Q=F.addRelativeToAbsoluteURL(N,Q);}else if(typeof Q==="object"){Q=F.addRelativeToAbsoluteURL(N,Q.bundleUrl);}var R=K["sap.app"].i18n;if(typeof R==="string"){R=F.addRelativeToAbsoluteURL(O,R);}else if(typeof R==="object"){R=F.addRelativeToAbsoluteURL(O,R.bundleUrl);}var T=K["sap.app"].title;var U=sap.apf.utils.createPseudoGuid();b.registerTextWithKey(U,T);var V=b.getStartParameterFacade().getAnalyticalConfigurationId();var W="";if(K["sap.app"].dataSources&&K["sap.app"].dataSources.AnalyticalConfigurationLocation&&K["sap.app"].dataSources.AnalyticalConfigurationLocation.uri){W=K["sap.app"].dataSources.AnalyticalConfigurationLocation.uri;W=F.addRelativeToAbsoluteURL(O,W);}if(!V&&!W){M=m.createMessageObject({code:"5065"});D(M);}var X={"appName":U,"appTitle":U,"analyticalConfigurationLocation":W,"textResourceLocations":{"apfUiTextBundle":Q,"applicationUiTextBundle":R},"persistence":{"path":{"service":J}}};if(K["sap.apf"]&&K["sap.apf"].appSpecificParameters){for(G in K["sap.apf"].appSpecificParameters){X[G]=K["sap.apf"].appSpecificParameters[G];}}if(K["sap.app"].dataSources&&K["sap.app"].dataSources.SmartBusiness){I=K["sap.app"].dataSources.SmartBusiness.uri;X.smartBusiness={runtime:{service:I}};}if(K["sap.app"].dataSources&&K["sap.app"].dataSources.LogicalSystem){X.persistence.logicalSystem={service:K["sap.app"].dataSources.LogicalSystem.uri};}B({applicationConfiguration:X},V);v().done(function(){if(V){j(V);}else{n();}});}function A(){var F=b.getUriGenerator().getApfLocation();H.setItem(sap.apf.core.constants.resourceLocation.apfUiTextBundle,F+"resources/i18n/apfUi.properties");H.setItem(sap.apf.core.constants.resourceLocation.applicationMessageDefinitionLocation,"");H.setItem(sap.apf.core.constants.resourceLocation.applicationMessageTextBundle,"");H.setItem(sap.apf.core.constants.resourceLocation.applicationUiTextBundle,"");H.setItem(sap.apf.core.constants.resourceLocation.analyticalConfigurationLocation,"");}function B(F,G){function I(J){C=q.extend(true,{},J);delete C.type;delete C.analyticalConfigurationLocation;delete C.applicationMessageDefinitionLocation;delete C.textResourceLocations;delete C.persistence;}var J=F.applicationConfiguration;I(J);var T=F.applicationConfiguration.textResourceLocations;p=F.applicationConfiguration.persistence;if(!i.functions.isUsingCloudFoundryProxy()){x(p);if(!p.path.entitySet){p.path.entitySet=sap.apf.core.constants.entitySets.analysisPath;}}if(F.applicationConfiguration.smartBusiness){S=F.applicationConfiguration.smartBusiness;y(S);}var M;var U;var K;for(K in sap.apf.core.constants.resourceLocation){if(!sap.apf.core.constants.resourceLocation.hasOwnProperty(K)){continue;}if(K===sap.apf.core.constants.resourceLocation.analyticalConfigurationLocation&&G){continue;}if(J[K]!==undefined){U=J[K];}else if(T[K]!==undefined){U=T[K];}else{continue;}if(i.manifests){H.setItem(K,U);}else if(K===sap.apf.core.constants.resourceLocation.apfUiTextBundle||i.instances.fileExists.check(U,true)){H.setItem(K,U);}else if(!G){M=m.createMessageObject({code:"5059",aParameters:[U,K]});D(M);}}}function D(F){m.putMessage(F);}function E(){var F;var G;var I;q.when(d).done(function(){F=t.getResourceLocation(sap.apf.core.constants.resourceLocation.apfUiTextBundle);G=t.getResourceLocation(sap.apf.core.constants.resourceLocation.applicationUiTextBundle);I=t.getResourceLocation(sap.apf.core.constants.resourceLocation.applicationMessageTextBundle);i.functions.initTextResourceHandlerAsPromise(F,G,I).done(function(){i.corePromise.resolve();});});}A();if(i.constructors&&i.constructors.ProxyForAnalyticalConfiguration){P=i.constructors.ProxyForAnalyticalConfiguration;}else if(i.functions.isUsingCloudFoundryProxy()){P=sap.apf.cloudFoundry.RuntimeProxy;}else if(g()){P=sap.apf.core.LayeredRepositoryProxy;}else{P=sap.apf.core.OdataProxy;}if(i.manifests&&i.manifests.manifest){z();}if(i.corePromise){E();}};});
