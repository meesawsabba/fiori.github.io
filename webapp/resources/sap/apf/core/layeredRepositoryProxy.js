/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2018 SAP SE. All rights reserved
 */
sap.ui.define(["sap/apf/utils/utils","sap/apf/core/constants","sap/apf/utils/hashtable","sap/apf/abap/LrepConnector","sap/apf/utils/parseTextPropertyFile","sap/ui/thirdparty/jquery"],function(u,c,h,L,p,q){"use strict";sap.apf.core.LayeredRepositoryProxy=function(s,a){var b=a.instances.coreApi;var d;var m=a.instances.messageHandler;var n='sap/apf/dt';var t='text.properties';var e=new sap.apf.utils.Hashtable(a.instances.messageHandler);var f=new sap.apf.utils.Hashtable(a.instances.messageHandler);var g;var j=false;this.getConnector=function(){return d;};this.readEntity=function(T,U,V,W,X,Y,Z){var $=V[0].value;var _=A(X);var a1=[];var b1=false;var c1=1;var d1=0;var e1;var f1;var g1;var i;var h1;var i1;var j1;var k1;var l1=x(Y);var m1;m.check(T==='configuration',"layered repository proxy - only read entity of configuration supported");if(Z&&Z.noMetadata){d.getStaticResource(_,$,'apfconfiguration').then(function(r1){g1={Application:X};k1=r1.response;if(typeof k1==='string'){g1.SerializedAnalyticalConfiguration=k1;}else{g1.SerializedAnalyticalConfiguration=JSON.stringify(k1);}g1.AnalyticalConfiguration=$;U(g1,z());},function(r1){U(undefined,z(),y({code:'5221',aParameters:[X,$]},r1&&r1.messages));});return;}if(W===undefined||W.indexOf("SerializedAnalyticalConfiguration")>=0){b1=true;if(l1==='VENDOR'){var n1={contentType:'application/json'};var o1=[];o1.push({name:"layer",value:l1});o1.push({name:"dt",value:"true"});var p1="/sap/bc/lrep/content/"+_+"/"+$+'.apfconfiguration';p1+=d._buildParams(o1);m1=d.send(p1,'GET',undefined,n1);}else{m1=d.getStaticResource(_,$,'apfconfiguration');}a1.push(m1);}else{c1=0;}e1=v(X,$);if(e1===undefined){var q1=d.getFileAttributes(_,$,'apfconfiguration',l1);a1.push(q1);}f1=Promise.all(a1);f1.then(function(r1){e1=v(X,$);if(e1===undefined){e1=r1[c1].response;}w(X,$,e1);g1=N(X,e1);if(b1){k1=r1[d1].response;if(typeof k1==='string'){g1.SerializedAnalyticalConfiguration=k1;}else{g1.SerializedAnalyticalConfiguration=JSON.stringify(k1);}}g1.AnalyticalConfiguration=$;if(W&&W.length!==0){h1=W.length;i1={};for(i=0;i<h1;i++){j1=W[i];i1[j1]=g1[j1];}g1=i1;}U(g1,z());},function(r1){U(undefined,z(),y({code:'5221',aParameters:[X,$]},r1&&r1.messages));});};this.doChangeOperationsInBatch=function(T,U,V){function W(Z,$){U($);}var i,X;function Y(){}D(V).then(function(){for(i=0;i<T.length;i++){X=T[i];X.application=V;if(X.method==='DELETE'&&X.entitySetName==='texts'){B(X,Y);}else if(X.method==='POST'&&sap.apf.utils.isValidPseudoGuid(X.data.TextElement)){E(X.data,Y);}else{E(X.data,Y);}}F(V,W,true);}).fail(function(Z){U(Z);});};this.readCollectionsInBatch=function(T,U){var V=T.length;var W=[];var X=0;function Y($){function _(a1,b1,c1){if(c1){U(undefined,c1);}else{X++;W[$]=a1;if(X===V){U(W);}}}return _;}for(var i=0;i<V;i++){var Z=T[i];this.readCollection(Z.entitySetName,Y(i),Z.inputParameters,Z.selectList,Z.filter);}};this.readCollection=function(i,T,U,V,W,X){var Y,Z;var $;var _;if(X&&X.layer){_=X.layer;}else{_="CUSTOMER";}var a1=function(b1,c1){if(c1&&(c1==="error"||c1==="timeout"||c1==="abort"||c1==="parsererror")){T(undefined,z(),y({code:'5222',aParameters:[Z]},[c1]));return;}var d1=new sap.apf.utils.Hashtable(m);var e1=[];var f1=(b1&&b1.response)||(b1&&b1.responseText)||"";var g1=sap.apf.utils.parseTextPropertyFile(f1,{instances:{messageHandler:m}});var h1,i1;if(g1.Messages.length>0){h1=m.createMessageObject({code:'5416'});i1=h1;g1.Messages.forEach(function(j1){i1.setPrevious(j1);i1=j1;});}d1=new sap.apf.utils.Hashtable(m);g1.TextElements.forEach(function(j1){if(j1.TextElement){d1.setItem(j1.TextElement,j1);e1.push(j1);}});e.setItem(Z,d1);T(e1,z(),h1);};if(i==='application'){m.check(!U&&!V&&!W,"unsupported parameters when calling readCollection for application");S(T,_);}else if(i==='texts'){Y=W.getFilterTermsForProperty('Application');Z=Y[0].getValue();$=C(Z,X);$.then(function(b1){a1(b1);},function(b1){T(undefined,z(),y({code:'5222',aParameters:[Z]},b1&&b1.messages));});}else if(i==='configuration'){Y=W.getFilterTermsForProperty('Application');Z=Y[0].getValue();G(Z,T,V);}};this.remove=function(i,T,U,V,W,X){if(!X){X="CUSTOMER";}if(i==='application'){Q(T,U,X);}else if(i==='configuration'){M(T,U,W,X);}else{m.check(false,'the remove operation on entity set '+i+' is currently not supported by the lrep proxy');}};this.create=function(i,T,U,V){if(i==='application'){O(T,U,V);}else if(i==='configuration'){K(T,U,V);}else if(i==='texts'){E(T,U);}else{m.check(false,'the create operation on entity set '+i+' is currently not supported by the lrep proxy');}};this.update=function(i,T,U){if(i==='configuration'){J(T,U);}else if(i==='application'){P(T,U);}else{m.check(false,'the update operation on entity set '+i+' is currently not supported by the lrep proxy');}};function k(i,T){var U={async:true,contentType:'application/json'};var V=[];V.push({name:"layer",value:i});V.push({name:"deep-read",value:true});V.push({name:"metadata",value:true});V.push({name:"type",value:T});var W="/sap/bc/lrep/content/"+n+"/";W+=d._buildParams(V);return d.send(W,'GET',undefined,U);}function l(i){var n=i.ns.split('/');return n[n.length-2];}function o(i,T){var U=undefined;i.metadata.forEach(function(V){if(V.name===T){U=V.value;}});return U;}this.readAllConfigurationsFromVendorLayer=function(){var i=q.Deferred();var T=[];k('VENDOR','apf*').then(function(U){var V={};U.response.forEach(function(W){if(W.fileType&&W.fileType==='apfapplication'){V[l(W)]=o(W,'apfdt-applname');}});U.response.forEach(function(W){var X;var Y;var Z;if(W.fileType&&W.fileType==="apfconfiguration"){X=l(W);Y=W.name;if(!(sap.apf.utils.isValidPseudoGuid(X)&&sap.apf.utils.isValidPseudoGuid(Y))){return;}Z=o(W,'apfdt-configname');T.push({configurationText:Z,applicationText:V[X],value:X+'.'+Y});}});i.resolve(T);},function(U){i.reject(y({code:'5231'},U&&U.messages));});return i.promise();};r();function r(){if(a.constructors&&a.constructors.LrepConnector){d=a.constructors.LrepConnector.createConnector();}else{d=sap.apf.abap.LrepConnector.createConnector();}if(!d._sClient){d._sClient=b.getStartParameterFacade().getSapClient();}}function v(i,T){var U=f.getItem(i);if(U===undefined){return undefined;}T=U.getItem(T);return T;}function w(i,T,U){var V=f.getItem(i);if(V===undefined){V=new sap.apf.utils.Hashtable(m);}V.setItem(T,U);f.setItem(i,V);}function x(i){var T=(i&&i.layer)||"CUSTOMER";if(T==="ALL"){return undefined;}return T;}function y(i,T){var U=m.createMessageObject(i);var V="";if(T){T.forEach(function(W){V=V+W+' ';});U.setPrevious(m.createMessageObject({code:5220,aParameters:[V]}));}return U;}function z(){return{};}function A(i){return n+'/'+i;}function B(i,T){var U=i.application;var V=i.inputParameters[0].value;var W;D(U).done(function(){W=e.getItem(U);W.removeItem(V);T(i,z());}).fail(function(X){T(undefined,z(),X);});}function C(i,T){var U;var V=[];var W="/sap/bc/lrep/content/";var X=x(T);W+=n+"/"+i+'/'+t;if(X){V.push({name:"layer",value:X});}U={contentType:'text/plain'};W+=d._buildParams(V);return d.send(W,'GET',undefined,U);}function D(i){var T=q.Deferred();var U;var V=e.getItem(i);var W=function(X){var Y=(X&&X.response)||(X&&X.responseText)||"";var Z=sap.apf.utils.parseTextPropertyFile(Y,{instances:{messageHandler:m}});V=new sap.apf.utils.Hashtable(m);Z.TextElements.forEach(function($){if($.TextElement){V.setItem($.TextElement,$);}});e.setItem(i,V);T.resolve({});};if(V===undefined){U=C(i);U.then(function(X){W(X);},function(X){T.reject(y({code:'5222',aParameters:[i]},X&&X.messages));});}else{T.resolve({});}return T.promise();}function E(i,T){var U=i.Application;if(i.TextElement===undefined||!sap.apf.utils.isValidGuid(i.TextElement)){i.TextElement=sap.apf.utils.createPseudoGuid();}D(U).done(function(){var V=e.getItem(U);V.setItem(i.TextElement,i);T(i,z());}).fail(function(V){T(undefined,z(),V);});}function F(i,T,U){var V=A(i);var W;function X(){var Z=sap.apf.utils.renderHeaderOfTextPropertyFile(i,m);Z=Z+sap.apf.utils.renderTextEntries(W,m);var $=d.upsert(V,'text','properties',"CUSTOMER",Z,'text/plain');$.then(function(){T(z());},function(_){T(z(),y({code:'5230',aParameters:[i]},_&&_.messages));});}W=e.getItem(i);if(!W){T(z());return;}if(U){X();}else{var Y=C(i);Y.then(function(Z){var $=(Z&&Z.response)||"";var _=sap.apf.utils.parseTextPropertyFile($,{instances:{messageHandler:m}});_.TextElements.forEach(function(a1){if(a1.TextElement){W.setItem(a1.TextElement,a1);}});X();},function(Z){T(z(),y({code:'5222',aParameters:[i]},Z&&Z.messages));});}}function G(i,T,U){var V=[];var W=A(i);var X=d._buildParams([{name:"layer",value:"CUSTOMER"},{name:"metadata",value:"true"},{name:"type",value:"apfconfiguration"}]);var Y=d.send("/sap/bc/lrep/content/"+W+X);Y.then(function(Z){var $=Z.response;$.forEach(function(a1){if(a1.fileType==="apfconfiguration"){a1.metadata.forEach(function(b1){if(b1.name==="apfdt-configname"){V.push({AnalyticalConfiguration:a1.name,Application:i,AnalyticalConfigurationName:b1.value});}});}});if(U&&U.indexOf("SerializedAnalyticalConfiguration")>=0){var _=[];V.forEach(function(a1){var b1=q.Deferred();_.push(b1);d.getStaticResource(W,a1.AnalyticalConfiguration,'apfconfiguration').then(function(c1){if(c1.response){a1.SerializedAnalyticalConfiguration=JSON.stringify(c1.response);b1.resolve();}else{b1.reject();}},function(c1){b1.reject(c1);});});q.when.apply(q,_).then(function(){T(V,z());},function(a1){T([],z(),y({code:'5223',aParameters:[i]},a1&&a1.messages));});}else{T(V,z());}},function(Z){T([],z(),y({code:'5223',aParameters:[i]},Z&&Z.messages));});}function H(){var i=q.Deferred();var T=[];if(j){i.resolve(g);}else{T.push({name:"dt",value:false});var U="/sap/bc/lrep/content/sap/ui/fl/settings/main.flsettings";U+=d._buildParams(T);var V=d.send(U,'GET',undefined);V.then(function(W){var X=W&&W.response||{};j=true;if(X.isAtoEnabled===true){g="ATO_NOTIFICATION";}i.resolve(g);},function(W){i.reject(W);});}return i.promise();}function I(i,T,U,V){var W=V||'CUSTOMER';var X=A(i);var Y=d.getFileAttributes(X,T,'apfconfiguration',W);Y.then(function(Z){var $=Z.response;if(W==='CUSTOMER'){w(i,T,$);F(i,U);}else{U(z());}},function(Z){U(z(),y({code:'5232',aParameters:[i,T]},Z&&Z.messages));});}function J(i,T,U){if(!U){U="CUSTOMER";}var V=i.Application;var W=i.AnalyticalConfiguration;var X=JSON.parse(i.SerializedAnalyticalConfiguration);var Y=A(V);var Z=H();Z.then(function(g){var $=d.getStaticResource(Y,"metadata","apfapplication");$.then(function(_){var a1={Application:V,ApplicationName:_.response.ApplicationName,SemanticObject:_.response.SemanticObject,AnalyticalConfiguration:W,AnalyticalConfigurationName:i.AnalyticalConfigurationName,CreationUTCDateTime:i.CreationUTCDateTime,LastChangeUTCDateTime:i.LastChangeUTCDateTime};X=q.extend(true,X,{configHeader:a1});X=JSON.stringify(X);var b1=d.upsert(Y,W,'apfconfiguration',U,X,'application/json',g);return b1;},function(_){T(z(),y({code:'5233',aParameters:[V,W]},_&&_.messages));}).then(function(){I(V,W,T,U);},function(_){T(z(),y({code:'5233',aParameters:[V,W]},_&&_.messages));});},function($){T(z(),y({code:'5224'},$&&$.messages));});}function K(i,T,U){var V=x(U);var W=i.Application;var X=i.AnalyticalConfiguration;if(X===undefined||!sap.apf.utils.isValidGuid(X)){X=sap.apf.utils.createPseudoGuid(32);}var Y=JSON.parse(i.SerializedAnalyticalConfiguration);var Z=A(W);var $=d.getStaticResource(Z,"metadata","apfapplication");$.then(function(a1){var b1={Application:W,ApplicationName:a1.response.ApplicationName,SemanticObject:a1.response.SemanticObject,AnalyticalConfiguration:X,AnalyticalConfigurationName:Y.analyticalConfigurationName,CreationUTCDateTime:i.CreationUTCDateTime,LastChangeUTCDateTime:i.LastChangeUTCDateTime};Y=q.extend(true,Y,{configHeader:b1});Y=JSON.stringify(Y);_(W,X,i.AnalyticalConfigurationName,Y,T);},function(a1){T(undefined,z(),y({code:'5223',aParameters:[W]},a1&&a1.messages));});function _(W,X,a1,Y,T){var Z=A(W);var b1=H();b1.then(function(g){var c1=d.upsert(Z,X,'apfconfiguration',V,Y,'application/json',g);c1.then(function(){I(W,X,function(d1,e1){if(!e1){T({AnalyticalConfiguration:X,AnalyticalConfigurationName:i.AnalyticalConfigurationName},z());}else{T(undefined,z(),e1);}},V);},function(d1){T(undefined,z(),y({code:'5226',aParameters:[W,X]},d1&&d1.messages));});},function(c1){T(undefined,z(),y({code:'5224'},c1&&c1.messages));});}}function M(i,T,U,V){var W=i[0].value;m.check(W!==undefined,"configuration may not be undefined");m.check(U!==undefined,"application of configuration not found");var X=A(U);H().then(function(g){var Y=d.deleteFile(X,W,'apfconfiguration',V,g);Y.then(function(){T(z());},function(Z){T(z(),y({code:'5225',aParameters:[U,W]},Z&&Z.messages));});},function(Y){T(z(),y({code:'5224'},Y&&Y.messages));});}function N(T,U){var i;var V={Application:T};var W,X;for(i=0;i<U.length;i++){W=U[i].name;X=U[i].value;if(W==="apfdt-applname"){W="ApplicationName";}else if(W==='createdAt'){W="CreationUTCDateTime";}else if(W==='createdBy'){W="CreatedByUser";}else if(W==='lastChangedAt'){W="LastChangeUTCDateTime";}else if(W==='lastChangedBy'){W="LastChangedByUser";}else if(W==="apfdt-configname"){W='AnalyticalConfigurationName';}else if(W==='size'||W==='layer'){continue;}V[W]=X;}return V;}function O(i,T,U){m.check(i.ApplicationName!==undefined&&i.ApplicationName!=="","Valid application name is required");var V=i.Application;if(V===undefined||!sap.apf.utils.isValidGuid(V)){V=sap.apf.utils.createPseudoGuid(32);}var W=JSON.stringify({ApplicationName:i.ApplicationName,SemanticObject:i.SemanticObject,Application:V});var X=sap.apf.utils.renderHeaderOfTextPropertyFile(V,m);var Y=x(U);function Z(a1){T(undefined,z(),y({code:'5227'},a1&&a1.messages));}var $=A(V);var _=d.upsert($,'metadata','apfapplication',Y,W,'application/json');_.then(function(){var a1=d.upsert($,'text','properties',Y,X,'text/plain');a1.then(function(){e.setItem(V,new sap.apf.utils.Hashtable(m));T({Application:V,ApplicationName:i.ApplicationName,SemanticObject:i.SemanticObject},z());},Z);},Z);}function P(i,T){m.check(i.ApplicationName!==undefined&&i.ApplicationName!=="","Valid application name is required");var U=i.Application;var V=JSON.stringify({ApplicationName:i.ApplicationName,SemanticObject:i.SemanticObject,Application:U});function W(Z){T(undefined,y({code:'5228',aParameters:[U]},Z&&Z.messages));}var X=A(U);var Y=d.upsert(X,'metadata','apfapplication','CUSTOMER',V,'application/json');Y.then(function(){T({Application:U,ApplicationName:i.ApplicationName,SemanticObject:i.SemanticObject});},W);}function Q(i,T,U){var V=i[0].value;function W(Z){var $=R(Z);T(z(),$);}var X=A(V);var Y=d.listContent(X,U);Y.then(function(Z){var $=Z.response;var _=[];$.forEach(function(b1){if(b1.fileType==="apfconfiguration"){H().then(function(g){_.push(d.deleteFile(X,b1.name,b1.fileType,b1.layer,g));},function(c1){T(z(),y({code:'5224'},c1&&c1.messages));});}else{_.push(d.deleteFile(X,b1.name,b1.fileType,b1.layer));}});var a1=Promise.all(_);return a1;},W).then(function(){T(z());},W);}function R(i){var T;if(i&&i.messageObject&&i.messageObject.getCode){T=i.messageObject;}else if(i&&i.response&&i.response.statusCode&&i.response.statusCode>=400){T=m.createMessageObject({code:'11005',aParameters:[i.response.statusCode.toString(),i.response.statusText]});}else{T=m.createMessageObject({code:'5201',aParameters:(i&&i.messages)||[]});}return T;}function S(i,T){var U=[];k(T,"apfapplication").then(function(W){var X=W.response;X.forEach(function(X){var Y;var Z;if(X.fileType&&X.fileType==="apfapplication"){Y=l(X);if(!sap.apf.utils.isValidPseudoGuid(Y)){return;}var $="";Z=o(X,'apfdt-applname');U.push({Application:Y,ApplicationName:Z,SemanticObject:$});}});i(U,z());},V);function V(W){i(undefined,z(),y({code:'5229'},W&&W.messages));}}};});
