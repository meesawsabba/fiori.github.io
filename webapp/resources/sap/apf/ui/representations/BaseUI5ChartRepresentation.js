sap.ui.define(["sap/m/Text","sap/apf/core/constants","sap/ui/layout/HorizontalLayout","sap/apf/ui/representations/utils/vizFrameSelectionHandler","sap/apf/ui/utils/formatter","sap/apf/ui/representations/utils/chartDataSetHelper","sap/apf/ui/representations/utils/representationFilterHandler","sap/apf/ui/representations/utils/timeAxisDateConverter","sap/apf/utils/utils","sap/ui/thirdparty/jquery"],function(T,c,H,V,f,a,r,t,u,q){'use strict';var i=0;function _(R,b){if(!b){return undefined;}var m=R.getMetaData();if(!m){return null;}var p=m.getPropertyMetadata(b);if(!p){return null;}var F=p.label||p.name;return F!==undefined?F:null;}var B=function(A,p){this.oMessageObject="";this.aDataResponse=undefined;this.dataset={};this.parameter=p;this.orderby=p.orderby;this.measures=p.measures;this.alternateRepresentation=p.alternateRepresentationType;this.requiredFilters=p.requiredFilters;this.oVizFrameSelectionHandler=new V.constructor(this.parameter,A);this.oTimeAxisDateConverter=new sap.apf.ui.representations.utils.TimeAxisDateConverter();this.oRepresentationFilterHandler=new sap.apf.ui.representations.utils.RepresentationFilterHandler(A,this.parameter,this.oTimeAxisDateConverter);this.chartInstance={};this.chartParam="";this.thumbnailChartParam="";this.oApi=A;this.axisType=sap.apf.ui.utils.CONSTANTS.axisTypes.AXIS;this.topN=p.top;this.apfId=++i;};B.prototype={getParameter:function(){return this.parameter;},setData:function(d,m){if(this.bIsAlternateView&&this.toggleInstance&&q.isFunction(this.toggleInstance.setData)){this.toggleInstance.setData(d,m);}else{this.formatter=new sap.apf.ui.utils.formatter({getEventCallback:this.oApi.getEventCallback.bind(this.oApi),getTextNotHtmlEncoded:this.oApi.getTextNotHtmlEncoded,getExits:this.oApi.getExits()},m,d);this.oRepresentationFilterHandler.setMetadataAndDataResponse(m,d);this.oRepresentationFilterHandler.validateFiltersWithDataset();this.oChartDataSetHelper=new sap.apf.ui.representations.utils.ChartDataSetHelper(this.formatter,this.oTimeAxisDateConverter);this.oChartDataSetHelper.createFlattenDataSet(this.parameter,m,d,this.oApi);if(this.chartType===sap.apf.ui.utils.CONSTANTS.vizFrameChartTypes.SCATTERPLOT||this.chartType===sap.apf.ui.utils.CONSTANTS.vizFrameChartTypes.BUBBLE){this.oChartDataSetHelper.addUnusedDimensionsToChartContext(m,d);}this.aDataResponse=d||[];this.metadata=m;if(!this.metadata){this.oMessageObject=this.oApi.createMessageObject({code:"6004",aParameters:[this.oApi.getTextNotHtmlEncoded("step")]});this.oApi.putMessage(this.oMessageObject);}}},attachSelectionAndFormatValue:function(s){var b=this;if(!s){this.oMessageObject=this.oApi.createMessageObject({code:"6002",aParameters:["title",this.oApi.getTextNotHtmlEncoded("step")]});this.oApi.putMessage(this.oMessageObject);}if(!this.aDataResponse||this.aDataResponse.length===0){this.oMessageObject=this.oApi.createMessageObject({code:"6000",aParameters:[s]});this.oApi.putMessage(this.oMessageObject);}this.fnHandleSelection=this.handleSelection.bind(b);this.chart.attachSelectData(this.fnHandleSelection);this.fnHandleDeselection=this.handleDeselection.bind(b);this.chart.attachDeselectData(this.fnHandleDeselection);},getFormatStringForMeasure:function(m){var F=this.formatter.getFormatString(m);return F;},getFormatStringForMeasureTooltip:function(m){var F=this.formatter.getFormatStringTooltip(m);return F;},getSelectionFilterLabel:function(){var R=this.getParameter().requiredFilters[0];var s=this.getSelectedFilterPropertyLabel(R);if(this.getParameter().requiredFilterOptions&&this.getParameter().requiredFilterOptions.fieldDesc){s=this.oApi.getTextNotHtmlEncoded(this.getParameter().requiredFilterOptions.fieldDesc);}return s;},getSelectedFilterPropertyLabel:function(R){return _(this,R);},getIsAllMeasureSameUnit:function(){var A=true;var s=this;var b=this.metadata.getPropertyMetadata(this.measures[0].fieldName).unit?this.metadata.getPropertyMetadata(this.metadata.getPropertyMetadata(this.measures[0].fieldName).unit).semantics:undefined;var m;this.measures.forEach(function(d,e){m=s.metadata.getPropertyMetadata(s.measures[e].fieldName).unit?s.metadata.getPropertyMetadata(s.metadata.getPropertyMetadata(d.fieldName).unit).semantics:undefined;if(A&&b!==undefined&&m&&(b!==m)){A=false;}});return A;},createThumbnailLayout:function(){if(!this.thumbnailChart){return;}this.thumbnailLayout=new H().addStyleClass('thumbnailLayout');this.thumbnailLayout.removeAllContent();if(this.aDataResponse!==undefined&&this.aDataResponse.length!==0){this.thumbnailChart.setModel(this.oModel);this.thumbnailLayout.addContent(this.thumbnailChart);this.thumbnailChart.removeStyleClass('thumbnailNoData');}else{var n=new T({text:this.oApi.getTextNotHtmlEncoded("noDataText")}).addStyleClass('noDataText');this.thumbnailLayout.addContent(n);this.thumbnailLayout.addContent(this.thumbnailChart);this.thumbnailChart.addStyleClass('thumbnailNoData');}},getAlternateRepresentation:function(){return this.alternateRepresentation;},getMetaData:function(){return this.metadata;},getData:function(){return this.aDataResponse;},getRequestOptions:function(F){if(this.bIsAlternateView&&this.toggleInstance&&q.isFunction(this.toggleInstance.getRequestOptions)){return this.toggleInstance.getRequestOptions(F,this.bIsAlternateView);}var o={paging:{},orderby:[]};if(this.orderby&&this.orderby.length){var O=this.orderby.map(function(b){return{property:b.property,ascending:b.ascending};});o.orderby=O;}if(this.topN&&this.topN>0){o.paging.top=this.topN;}return o;},createDataset:function(){this.dataset=this.oChartDataSetHelper.getFlattenDataSet();this.oModel=this.oChartDataSetHelper.getModel();},drawSelectionOnMainChart:function(){var F=this.oRepresentationFilterHandler.getFilterValues();if(F.length>0){var s=this.oVizFrameSelectionHandler.getSelectionInfoFromFilter(F,this.aDataResponse);this.setSelectionOnMainChart(s);}},drawSelectionOnThumbnailChart:function(){var F=this.oRepresentationFilterHandler.getFilterValues();if(F.length>0){var s=this.oVizFrameSelectionHandler.getSelectionInfoFromFilter(F,this.aDataResponse);this.setSelectionOnThumbnailChart(s,false);}},handleSelection:function(e){this.manageSelectionsOnChart(e,false,this.parameter);this.chart.attachEvent("setFocusOnSelectedLinkEvent",this.chart.setFocusOnSelectLink);},handleDeselection:function(e){this.manageSelectionsOnChart(e,true,this.parameter);this.chart.attachEvent("setFocusOnSelectedLinkEvent",this.chart.setFocusOnSelectLink);},getSelections:function(){return this.oRepresentationFilterHandler.getDisplayInfoForFilters(this.metadata,this.oModel.getData().data);},getSortedSelections:function(){var l;var s=this.getSelections();if(!s||s.length===0){return[];}var p=this.getParameter();if(p.requiredFilterOptions&&p.requiredFilterOptions.labelDisplayOption){l=p.requiredFilterOptions.labelDisplayOption;}var b=this.getParameter().requiredFilters[0];var d=this.metadata.getPropertyMetadata(b);switch(l){case c.representationMetadata.labelDisplayOptions.TEXT:return sap.apf.utils.sortByProperty(s,"text",this.metadata.getPropertyMetadata(d.text));case c.representationMetadata.labelDisplayOptions.KEY_AND_TEXT:return sap.apf.utils.sortByProperty(s,"text");default:return sap.apf.utils.sortByProperty(s,"id",d);}},getSelectionCount:function(){return this.oRepresentationFilterHandler.getFilterValues().length;},removeAllSelection:function(){this.setSelectionOnThumbnailChart([],false);this.setSelectionOnMainChart([],true);},getFilterMethodType:function(){return sap.apf.core.constants.filterMethodTypes.filter;},getFilter:function(){this.filter=this.oRepresentationFilterHandler.createFilterFromSelectedValues();return this.filter;},setFilter:function(F){this.filter=F;},adoptSelection:function(s){if(s&&s.getFilter){var b=s.getFilter().getInternalFilter().getFilterTerms().map(function(d){return d.getValue();});this.oRepresentationFilterHandler.updateFilterFromSelection(b);}},serialize:function(){var o=this.parameter.orderby;if(this.toggleInstance){o=this.toggleInstance.orderby;}return{oFilter:this.oRepresentationFilterHandler.getFilterValues(),bIsAlternateView:this.bIsAlternateView,orderby:o};},deserialize:function(s){this.oRepresentationFilterHandler.updateFilterFromSelection(s.oFilter);this.bIsAlternateView=s.bIsAlternateView;if(this.bIsAlternateView){this.toggleInstance=this.oApi.getUiApi().getStepContainer().getController().createToggleRepresentationInstance(this,s.orderby);}},getPrintContent:function(){},onChartSwitch:function(){},destroy:function(){this.dataset=null;if(this.formatter){this.formatter=null;}if(this.oRepresentationFilterHandler){this.oRepresentationFilterHandler.aFilterValues=[];this.oRepresentationFilterHandler=null;}if(this.chart){this.chart.detachSelectData(this.fnHandleSelection);this.fnHandleSelection=null;this.chart.detachDeselectData(this.fnHandleDeselection);this.fnHandleDeselection=null;this.chart.destroy();this.chart=null;}if(this.thumbnailChart){this.thumbnailChart.destroy();this.thumbnailChart=null;}if(this.thumbnailLayout){this.thumbnailLayout.removeAllContent();}}};return B;},true);
