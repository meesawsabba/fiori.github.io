/* SAP APF Analysis Path Framework
* 
* (c) Copyright 2012-2014 SAP SE. All rights reserved
*/
sap.ui.define(["sap/apf/core/constants","sap/apf/ui/utils/formatter","sap/apf/ui/representations/utils/paginationHandler","sap/apf/ui/representations/BaseUI5ChartRepresentation","sap/apf/ui/representations/utils/paginationDisplayOptionHandler","sap/ui/model/Sorter","sap/ui/table/Table","sap/ui/table/Column","sap/ui/core/CustomData","sap/ui/model/json/JSONModel","sap/ui/core/Icon","sap/ui/layout/VerticalLayout","sap/m/Text","sap/m/Label","sap/m/Button","sap/m/HBox","sap/m/VBox","sap/m/ScrollContainer","sap/ui/export/Spreadsheet","sap/apf/ui/utils/determineColumnSettingsForSpreadSheetExport","sap/ui/export/EdmType","sap/m/Dialog","sap/ui/thirdparty/jquery"],function(c,f,p,B,a,S,T,C,b,J,I,V,d,L,e,H,g,h,j,k,E,D,q){"use strict";function _(i,y){y.forEach(function(z){i.addSelectionInterval(z,z);});}function l(i){i.loadAllButton.attachEvent("setFocusOnLoadAllButtonEvent",i.loadAllButton.setFocusOnLoadAllButton);}function m(i,R){if(i.bIsAlternateRepresentation&&i.oApi.getActiveStep()){i.oApi.getActiveStep().getSelectedRepresentation().oRepresentationFilterHandler.getFilterValues().forEach(function(F){if(i.aFiltersInTable.indexOf(F)===-1){i.aFiltersInTable.push(F);}});}if((R&&i.oParameter.top)||i.oParameter.isAlternateRepresentation){i.aFiltersInTable=n(i,R);}}function n(i,R){var F=[];i.aFiltersInTable.forEach(function(y){i.aDataResponse.forEach(function(z){var A=z[R];if(A==y&&F.indexOf(y)===-1){F.push(y);}});});return F;}function o(i,R,y){var z=i.tableControl.getContextByIndex(y[0]).getProperty(R);if((i.tableControl.isIndexSelected(y[0]))&&(i.aFiltersInTable.indexOf(z))===-1){i.aFiltersInTable.push(z);}else{var A=i.aFiltersInTable.indexOf(z);if(A!==-1){i.aFiltersInTable.splice(A,1);}}}function r(i,y){s(i);i.aFiltersInTable=y;i.oApi.getActiveStep().getSelectedRepresentation().oRepresentationFilterHandler.updateFilterFromSelection(y);i.oApi.selectionChanged();}function s(i){i.oRepresentationFilterHandler.clearFilters();i.oApi.getActiveStep().getSelectedRepresentation().oRepresentationFilterHandler.clearFilters();i.aValidatedFilter=[];i.aFiltersInTable=[];}function t(i,y,z,N,A){var F=i.nDataResponseCount||0;var G,K;var M=i.oApi.getTextNotHtmlEncoded("buttonTextExport");var O=new sap.m.Button({text:M,press:function(){if(i.aDataResponse.length>10000){var Q=i;Q.newOpenDialog=new sap.m.Dialog({type:sap.m.DialogType.Message,title:i.oApi.getTextNotHtmlEncoded("warningTitle"),state:'Warning',content:new sap.m.Text({text:i.oApi.getTextNotHtmlEncoded("exportWarning")}),beginButton:new sap.m.Button({text:i.oApi.getTextNotHtmlEncoded("warningExport"),press:function(){i.exportExcel(y);Q.newOpenDialog.close();}}),endButton:new sap.m.Button({text:i.oApi.getTextNotHtmlEncoded("warningCancel"),press:function(){Q.newOpenDialog.close();}}),afterClose:function(){Q.oUiApi.getLayoutView().setBusy(false);Q.newOpenDialog.destroy();}});Q.newOpenDialog.open();}else{i.exportExcel(y);}}}).addStyleClass("sapUiTinyMarginBeginEnd");i.titleControl=new sap.m.Title({level:sap.ui.core.TitleLevel.H1}).addStyleClass("sapUiTinyMarginBegin").addStyleClass("sapUiTinyMarginTop");if(i.aDataResponse.length===0){O.setEnabled(false);}if(A){K=i.title;}else if(i.oParameter.top){G=new sap.m.HBox({items:[O]});K=i.title;}else if(N){G=new sap.m.HBox({items:[O]});K=i.oApi.getTextNotHtmlEncoded("stepTitleWithNumberOfRecords",[i.title,z,z]);}else{M=i.oApi.getTextNotHtmlEncoded("buttonTextLoadAll");if(i.loadAllButton===undefined){i.loadAllButton=new sap.m.Button({text:M,press:i.loadAll.bind(i)});i.loadAllButton.setFocusOnLoadAllButton=function(){this.focus();this.detachEvent("setFocusOnLoadAllButtonEvent",this.setFocusOnLoadAllButton);};}G=new sap.m.HBox({items:[i.loadAllButton,O]});K=i.oApi.getTextNotHtmlEncoded("stepTitleWithNumberOfRecords",[i.title,z,F]);i.loadAllButton.addAriaLabelledBy(i.titleControl);}O.addAriaLabelledBy(i.titleControl);i.titleControl.setText(K);var P=new sap.m.HBox({alignItems:"Start",wrap:"Wrap",justifyContent:"SpaceBetween",items:[i.titleControl,G]});return P;}function u(i,y,z,A){var F=function(a1){return function(b1){if(z.metadata!==undefined){var c1;if(i.value[a1]&&b1){c1=z.oFormatter.getFormattedValueAsString(i.value[a1],b1);if(c1!==undefined){return c1;}}}return b1;};};var G=new sap.ui.table.Table({title:y,showNoData:false,enableSelectAll:false,visibleRowCountMode:sap.ui.table.VisibleRowCountMode.Auto});if(A){G.setWidth(A+"px");}G.setLayoutData(new sap.m.FlexItemData({growFactor:1}));if(sap.ui.Device.system.desktop){G.addStyleClass("sapUiSizeCompact");}var R=z.oParameter.requiredFilters;var K=(R&&(R.length>0))?"MultiToggle":"None";G.setSelectionMode(K);var M=[],N,O,P;for(var Q=0;Q<i.name.length;Q++){N=new sap.m.Text({wrapping:false});N.bindText(i.value[Q],F(Q),sap.ui.model.BindingMode.OneWay);N.bindProperty("tooltip",i.value[Q],F(Q));O=new sap.ui.table.Column({label:new sap.m.Label({text:i.name[Q],tooltip:i.name[Q]}),template:N});P=new sap.ui.core.CustomData({value:{text:i.name[Q],key:i.value[Q]}});if(A){O.setMinWidth(125);}O.addCustomData(P);M.push(O);}var U;U=M;U.forEach(function(a1){G.addColumn(a1);});if(M.length>10){G.getColumns().forEach(function(O){O.setWidth("125px");});}var W=new sap.ui.model.json.JSONModel();W.setSizeLimit(10000);var X=z.getData();W.setData({tableData:X});G.setModel(W);G.bindRows("/tableData");if(z.metadata!==undefined){for(var Y=0;Y<i.name.length;Y++){var Z=z.metadata.getPropertyMetadata(i.value[Y]);if(Z["aggregation-role"]==="measure"){var $=G.getColumns()[Y];$.setHAlign(sap.ui.core.HorizontalAlign.End);}}}return G;}function v(y){var z=y.getData();var P=[],A;var F={name:[],value:[]};P=y.oParameter.dimensions.concat(y.oParameter.measures).length?y.oParameter.dimensions.concat(y.oParameter.measures):y.parameter.properties;if(z.length!==0){for(var i=0;i<P.length;i++){F.value[i]=P[i].fieldName;var G=y.metadata.getPropertyMetadata(P[i].fieldName).label||y.metadata.getPropertyMetadata(P[i].fieldName).name;var U="";if(y.metadata!==undefined&&y.metadata.getPropertyMetadata(P[i].fieldName).unit!==undefined){var K=y.metadata.getPropertyMetadata(P[i].fieldName).unit;U=y.getData()[0][K];for(A=0;A<y.getData().length;A++){if(U!==y.getData()[A][K]){U=undefined;break;}}F.name[i]=P[i].fieldDesc===undefined||!y.oApi.getTextNotHtmlEncoded(P[i].fieldDesc).length?G:y.oApi.getTextNotHtmlEncoded(P[i].fieldDesc);if(U!==undefined&&U!==""){F.name[i]=y.oApi.getTextNotHtmlEncoded("displayUnit",[F.name[i],U]);}}else{F.name[i]=P[i].fieldDesc===undefined||!y.oApi.getTextNotHtmlEncoded(P[i].fieldDesc).length?G:y.oApi.getTextNotHtmlEncoded(P[i].fieldDesc);}}}return F;}function w(i){var y;var z=i.getSelectedSortItem();i.getSortItems().forEach(function(A){if(A.getId()===z){y=A.getKey();}});return y;}var x=function(A,P){this.oViewSettingDialog=undefined;this.aDataResponse=[];this.aValidatedFilter=[];this.aFiltersInTable=[];this.oParameter=P;this.orderby=P.orderby;this.omitTopAndSkipOptionsForNextPathUpdate=false;sap.apf.ui.representations.BaseUI5ChartRepresentation.apply(this,[A,P]);this.alternateRepresentation=P.alternateRepresentationType;this.type=sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION;this.oPaginationHandler=new sap.apf.ui.representations.utils.PaginationHandler(this);this.oPaginationDisplayOptionHandler=new sap.apf.ui.representations.utils.PaginationDisplayOptionHandler();this._drawSelection=function(i){var R=this.oParameter.requiredFilters;var y=R&&(R.length>0)?R[0]:undefined;var z=i.getParameter("userInteraction");var F=i.getParameter("rowIndices");if(!z||F.length===0){return;}if(i.getSource().getFocusDomRef()&&i.getSource().getFocusDomRef().offsetTop!==0){this.nFirstVisibleRow=this.tableControl.getFirstVisibleRow();}o(this,y,F);var G=q.unique(this.aFiltersInTable);r(this,G);};this._handleSelectionEvent=function(i){this._drawSelection(i);};this._getSelectedIndicesInTable=function(R){var i=this;var y=[];i.aDataResponse.forEach(function(z,F){var G=z[R];if(i.aFiltersInTable.indexOf(G)!==-1){y.push(F);}});return y;};};x.prototype=Object.create(sap.apf.ui.representations.BaseUI5ChartRepresentation.prototype);x.prototype.constructor=x;x.prototype.setData=function(i,y,z,A){var F=this;var R,G;if(!y){var M=this.oApi.createMessageObject({code:"6004",aParameters:[this.oApi.getTextNotHtmlEncoded("step")]});this.oApi.putMessage(M);}this.metadata=y;this.oFormatter=new sap.apf.ui.utils.formatter({getEventCallback:this.oApi.getEventCallback.bind(this.oApi),getTextNotHtmlEncoded:this.oApi.getTextNotHtmlEncoded,getExits:this.oApi.getExits()},this.metadata,this.aDataResponse);if(this.oParameter.requiredFilters.length>0){R=this.oParameter.requiredFilters[0];G=y.getPropertyMetadata(R).text;}if(!this.oParameter.isAlternateRepresentation){if(R){this.aValidatedFilter=[];if(A&&A.length>0){A.forEach(function(Q){F.aValidatedFilter.push(Q[R]);F.oPaginationDisplayOptionHandler.createDisplayValueLookupForPaginatedFilter(Q[R],Q[G]);});F.aFiltersInTable=F.aValidatedFilter;}else{F.aFiltersInTable=[];}}var K=this.getRequestOptions();var N=K.paging&&K.paging.skip;this.nDataResponseCount=z;if(N===undefined||N===0){this.aDataResponse=i;}else{i.map(function(Q){F.aDataResponse.push(Q);});}if(!this.oParameter.top&&this.titleControl){var O=(this.aDataResponse&&this.aDataResponse.length)||0;var P=this.oApi.getTextNotHtmlEncoded("stepTitleWithNumberOfRecords",[this.title,O,z]);this.titleControl.setText(P);}}else{this.aDataResponse=i;}if(G){this.aDataResponse.forEach(function(Q){F.oPaginationDisplayOptionHandler.createDisplayValueLookupForPaginatedFilter(Q[R],Q[G]);});}};x.prototype.getFilter=function(){this.filter=this.oRepresentationFilterHandler.createFilterFromSelectedValues(this.aFiltersInTable);return this.filter;};x.prototype.getSelections=function(){var i=this,y=[],z;var R=i.parameter.requiredFilters[0];m(i,R);i.aFiltersInTable.forEach(function(A){z=i.oPaginationDisplayOptionHandler.getDisplayNameForPaginatedFilter(A,i.parameter.requiredFilterOptions,R,i.oFormatter,i.metadata);y.push({id:A,text:z});});return y;};x.prototype.markSelectionInTable=function(i){var R=this.oParameter.requiredFilters?this.oParameter.requiredFilters[0]:undefined;if(R){var y=this._getSelectedIndicesInTable(R);if(this.oParameter.isAlternateRepresentation){var z=[];var A=this.tableControl.getBinding().aIndices;y.forEach(function(F){z.push(A.indexOf(F));});y=z;}this.tableControl.clearSelection();if(y.length>0){_(this.tableControl,y);}}};x.prototype.getRequestOptions=function(F,i){this.bIsAlternateRepresentation=i;if(F){this.oPaginationHandler.resetPaginationOption();}var y={paging:{},orderby:[]};if(F){this.omitTopAndSkipOptionsForNextPathUpdate=false;}if(this.omitTopAndSkipOptionsForNextPathUpdate){y.paging={inlineCount:true};}else if(!this.bIsAlternateRepresentation){y.paging=this.oPaginationHandler.getPagingOption(this.oParameter.top);}if(this.orderby){y.orderby=this.orderby;}if(this.oViewSettingDialog){var z=w(this.oViewSettingDialog);if(z){var A={property:w(this.oViewSettingDialog),ascending:!this.oViewSettingDialog.getSortDescending()};this.orderby=[A];y.orderby=[A];}}return y;};x.prototype.resetPaginationForTable=function(){this.omitTopAndSkipOptionsForNextPathUpdate=false;this.oPaginationHandler.resetPaginationOption();};x.prototype.getMainContent=function(i,y,z){var A=this;var F=this.getData();this.title=i;var G=this.oParameter.dimensions.concat(this.oParameter.measures).length?this.oParameter.dimensions.concat(this.oParameter.measures):this.oParameter.properties;var K=v(this);var M;if(!i){M=this.oApi.createMessageObject({code:"6002",aParameters:["title",this.oApi.getTextNotHtmlEncoded("step")]});this.oApi.putMessage(M);}if(G.length===0){M=this.oApi.createMessageObject({code:"6002",aParameters:["dimensions",i]});this.oApi.putMessage(M);}if(!F||F.length===0){M=this.oApi.createMessageObject({code:"6000",aParameters:[i]});this.oApi.putMessage(M);}var N;if(this.oParameter.isAlternateRepresentation){N=t(this,i,F.length,true,y);}else{N=t(this,i,F.length,false,y);}this.tableControl=u(K,N,this,y);this.tableControl.addAriaLabelledBy(N.getItems()[0]);this.tableControl.addEventDelegate({onAfterRendering:function(){if(A.oParameter){A.markSelectionInTable(true);if(A.loadAllButton){A.loadAllButton.fireEvent("setFocusOnLoadAllButtonEvent");}if(!A.oParameter.top&&!A.oParameter.isAlternateRepresentation&&A.nDataResponseCount>100){A.oPaginationHandler.attachPaginationOnTable(A);}}}});this.tableControl.attachRowSelectionChange(this._handleSelectionEvent.bind(this));this.oLoadMoreLink=new sap.m.Link({text:this.oApi.getTextNotHtmlEncoded("moreIcon"),visible:false});var O=new sap.m.VBox({fitContainer:true,items:[this.tableControl,this.oLoadMoreLink]}).addStyleClass("tableRepresentation");if(z){O.setHeight(z+"px");}return O;};x.prototype.getThumbnailContent=function(){var i;var y=this.getData();var z=this.oParameter.isAlternateRepresentation?"sap-icon://table-view":"sap-icon://table-chart";if(y!==undefined&&y.length!==0){var A=new sap.ui.core.Icon({src:z,size:"70px"}).addStyleClass('thumbnailTableImage');i=A;}else{var F=new sap.m.Text({text:this.oApi.getTextNotHtmlEncoded("noDataText")}).addStyleClass('noDataText');i=new sap.ui.layout.VerticalLayout({content:F});}return i;};x.prototype.removeAllSelection=function(){s(this);this.tableControl.clearSelection();this.oApi.selectionChanged();};x.prototype.getPrintContent=function(i){var P=this.tableControl.clone();P.getColumns().forEach(function(A){A.setWidth("auto");A.getTemplate().setWrapping(true);});var y=this.tableControl.getSelectedIndices();P.setVisibleRowCountMode(sap.ui.table.VisibleRowCountMode.Fixed);P.setVisibleRowCount(P.getModel().getData().tableData.length);P.onAfterRendering=function(){y.forEach(function(A){P.getRows()[A].getDomRef().classList.add('sapTableSelectionForPrint');});};var z={oRepresentation:P};return z;};x.prototype.getViewSettingDialog=function(){if(!this.oViewSettingDialog){var i={oTableInstance:this};var y=new sap.ui.view({type:sap.ui.core.mvc.ViewType.JS,viewName:"sap.apf.ui.reuse.view.viewSetting",viewData:i});this.oViewSettingDialog=y.getContent()[0];this.oViewSettingDialog.addStyleClass("sapUiSizeCompact");}return this.oViewSettingDialog;};x.prototype.loadAll=function(){this.omitTopAndSkipOptionsForNextPathUpdate=true;if(this.loadAllButton){l(this);}this.oApi.selectionChanged();};x.prototype.exportExcel=function(y){var z=this;function A(){var N=v(z);var G=[];var i,O;for(i=0;i<N.value.length;i++){O=sap.apf.ui.utils.determineColumnSettingsForSpreadSheetExport(N.value[i],z.metadata);O.property=N.value[i];O.label=N.name[i];G.push(O);}return G;}var F=this.getData();var G=A();var K={workbook:{columns:G},dataSource:F,fileName:y+".xlsx"};var M=new sap.ui.export.Spreadsheet(K);M.build();};x.prototype.onChartSwitch=function(){this.resetPaginationForTable();};x.prototype.destroy=function(){if(this.orderby){this.orderby=null;}if(this.oParameter){this.oParameter=null;}if(this.oViewSettingDialog){this.oViewSettingDialog.destroy();}if(this.aDataResponse){this.aDataResponse=null;}if(this.aValidatedFilter){this.aValidatedFilter=[];}if(this.aFiltersInTable){this.aFiltersInTable=[];}sap.apf.ui.representations.BaseUI5ChartRepresentation.prototype.destroy.call(this);};return x;},true);
