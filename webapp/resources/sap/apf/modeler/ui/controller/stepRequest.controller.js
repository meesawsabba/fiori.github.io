sap.ui.define(["sap/apf/modeler/ui/controller/requestOptions","sap/apf/modeler/ui/utils/textManipulator","sap/apf/modeler/ui/utils/displayOptionsValueBuilder","sap/apf/modeler/ui/utils/textPoolHelper","sap/ui/thirdparty/jquery"],function(B,t,d,a,q){"use strict";var o=sap.apf.modeler.ui.utils.optionsValueModelBuilder;var n=sap.apf.modeler.ui.utils.nullObjectChecker;var T=sap.apf.modeler.ui.utils.TranslationFormatMap.STEPFILTERPROPERTY_LABEL;function _(C){var e=C.getView().getViewData().oTextReader;var s=C.oParentObject.getFilterPropertyLabelKey()?e("label"):e("label")+" ("+e("default")+")";C.byId("idOptionalSelectedPropertyLabel").setText(s);C.byId("idOptionalSelectedPropertyLabel").setTooltip(s);}function b(C){var e=q.Deferred();var p;var P=C.oParentObject.getFilterPropertyLabelKey();if(!C.getSource()||!C.getEntity()){return e.resolve();}if(n.checkIsNotUndefined(P)){p=C.getView().getViewData().oConfigurationHandler.getTextPool().get(P).TextElementDescription;C.byId("idOptionalSelectedPropertyLabelText").setValue(p);return e.resolve();}C.oStepPropertyMetadataHandler.getEntityTypeMetadataAsPromise().done(function(f){var s=C.oParentObject.getFilterProperties()[0];if(C.oParentObject.getType()==="hierarchicalStep"&&s){s=C.oStepPropertyMetadataHandler.getPropertyMetadata(f,s)["hierarchy-node-for"];}if(s){p=C.oStepPropertyMetadataHandler.getDefaultLabel(f,s);}C.byId("idOptionalSelectedPropertyLabelText").setValue(p);e.resolve();});return e;}function c(C){C.byId("idOptionalRequestFieldLabel").addStyleClass("filterPropertyLable");C.byId("idOptionalRequestField").addStyleClass("filterProperty");C.byId("idOptionalLabelDisplayOptionType").addStyleClass("filterProperty");}return B.extend("sap.apf.modeler.ui.controller.stepRequest",{setLabelDisplayOptionTypeAsPromise:function(o){var e=q.Deferred();var d,l,m,p,L,C=this,f=[];var g=C.getView().getViewData().oTextReader;d=new sap.apf.modeler.ui.utils.DisplayOptionsValueBuilder(g,o);m=d.getLabelDisplayOptions();l=sap.apf.core.constants.representationMetadata.labelDisplayOptions;p=t.removePrefixText(C.byId("idOptionalRequestField").getSelectedKey(),g(sap.apf.modeler.ui.utils.CONSTANTS.texts.NOTAVAILABLE));_(C);b(C).done(function(){C.byId("idOptionalLabelDisplayOptionType").setEnabled(true);if(p===g("none")){C.byId("idOptionalLabelDisplayOptionType").setModel(m);C.byId("idOptionalLabelDisplayOptionType").setEnabled(false);return e.promise();}L=C.oParentObject.getFilterPropertyLabelDisplayOption();C.oStepPropertyMetadataHandler.getEntityTypeMetadataAsPromise().done(function(E){if((L===l.KEY_AND_TEXT||L===l.TEXT)&&!C.oStepPropertyMetadataHandler.hasTextPropertyOfDimension(E,p)){m=d.getValidatedLabelDisplayOptions();f=t.addPrefixText([L],g);L=f[0];}C.byId("idOptionalLabelDisplayOptionType").setModel(m);C.byId("idOptionalLabelDisplayOptionType").setSelectedKey(L);e.resolve();});});return e.promise();},enableDisableLabelDisplayOptionTypeAsPromise:function(){var i,C=this;var e=q.Deferred();var f=C.getView().getViewData().oTextReader;var D=C.byId("idOptionalLabelDisplayOptionType");var p=t.removePrefixText(C.byId("idOptionalRequestField").getSelectedKey(),f(sap.apf.modeler.ui.utils.CONSTANTS.texts.NOTAVAILABLE));C.oStepPropertyMetadataHandler.getEntityTypeMetadataAsPromise().done(function(g){var I=C.oStepPropertyMetadataHandler.hasTextPropertyOfDimension(g,p);for(i=0;i<D.getItems().length;i++){D.getItems()[i].setEnabled(true);if(i>0&&!I){D.getItems()[i].setEnabled(false);}}e.resolve();});return e.promise();},onBeforeRendering:function(){var C=this;C.byId("idOptionalRequestFieldLabel").setVisible(true);C.byId("idOptionalRequestField").setVisible(true);C.byId("idOptionalLabelDisplayOptionType").setVisible(true);C.byId("idOptionalSelectedPropertyLabel").setVisible(true);C.byId("idOptionalSelectedPropertyLabelText").setVisible(true);},onAfterRendering:function(){var C=this;C.addOrRemoveMandatoryFieldsAndRequiredFlag(true);c(C);},setDisplayText:function(){var C=this;var e=C.getView().getViewData().oTextReader;C.byId("idSourceLabel").setText(e("source"));C.byId("idEntityLabel").setText(e("entity"));C.byId("idSelectPropertiesLabel").setText(e("selectProperties"));C.byId("idOptionalRequestFieldLabel").setText(e("requiredFilters"));},setOptionalRequestFieldProperty:function(){var C=this;var p,s,i,m,N,v=[];var f=C.oParentObject.getFilterProperties();N=[C.getView().getViewData().oTextReader("none")];p=C.byId("idSelectProperties").getSelectedKeys();s=C.oParentObject.getSelectProperties();s.forEach(function(e){if(e===f[0]){i=true;}});if(!i&&f.length>0){C.removeOptionalRequestFieldProperty(f);f=C.oParentObject.getFilterProperties();}m=o.convert(N.concat(p));C.byId("idOptionalRequestField").setModel(m);C.byId("idOptionalRequestField").setSelectedKey(N[0]);if(n.checkIsNotNullOrUndefinedOrBlank(f)){v=C.validateSelectedValues(C,f,p);f=v.aSelectedValues;C.byId("idOptionalRequestField").setSelectedKey(f[0]);}},addOrRemoveMandatoryFieldsAndRequiredFlag:function(r){var C=this;if(r===false){return;}C.byId("idSourceLabel").setRequired(r);C.byId("idEntityLabel").setRequired(r);C.byId("idSelectPropertiesLabel").setRequired(r);C.viewValidator.addFields(["idSource","idEntity","idSelectProperties"]);},fireRelevantEvents:function(e){var C=this,f,s;if(e.getSource()!==C.byId("idOptionalRequestField")){f=[t.removePrefixText(C.byId("idOptionalRequestField").getSelectedKey(),C.getView().getViewData().oTextReader(sap.apf.modeler.ui.utils.CONSTANTS.texts.NOTAVAILABLE))];if(n.checkIsNotNullOrUndefinedOrBlank(f)){C.updateOptionalRequestFieldProperty(f);}if(C.getSelectProperties().length===0){C.oParentObject.resetTopN();}C.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETDATAREDUCTIONSECTION);}if(e.getSource()===C.byId("idOptionalProperty")){C.setOptionalRequestFieldProperty();}s=(C.byId("idOptionalRequestField").getSelectedKey()!==C.getView().getViewData().oTextReader("none"))?true:false;C.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETVISIBILITYOFFILTERMAPPINGFIELDS,{"bShowFilterMappingLayout":s});C.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.UPDATEFILTERMAPPINGFIELDS);},getSource:function(){return this.oParentObject.getService();},getAllEntitiesAsPromise:function(s){return this.oConfigurationEditor.getAllEntitySetsOfServiceAsPromise(s);},getEntity:function(){return this.oParentObject.getEntitySet();},getAllEntitySetPropertiesAsPromise:function(s,e){return this.oConfigurationEditor.getAllPropertiesOfEntitySetAsPromise(s,e);},changeLabelDisplayOption:function(l){var C=this;C.oParentObject.setFilterPropertyLabelDisplayOption(l);},changeOptionalSelectedPropertyLabelText:function(l){var C=this;if(l.trim().length===0){C.oParentObject.setFilterPropertyLabelKey(undefined);_(C);b(C);return;}C.getView().getViewData().oConfigurationHandler.getTextPool().setTextAsPromise(l,T).done(function(L){C.oParentObject.setFilterPropertyLabelKey(L);_(C);b(C);});},resetEntityAndProperties:function(){var C=this;C.clearEntity();C.byId("idEntity").setModel(null);C.byId("idEntity").setSelectedKey(undefined);C.clearSelectProperties();C.byId("idSelectProperties").setModel(null);C.byId("idSelectProperties").setSelectedKeys([]);C.byId("idOptionalRequestField").setModel(null);C.byId("idOptionalRequestField").setSelectedKey(undefined);},clearSource:function(){var C=this;C.oParentObject.setService(undefined);C.clearEntity();},clearEntity:function(){var C=this;C.oParentObject.setEntitySet(undefined);C.clearSelectProperties();},clearSelectProperties:function(){var C=this;var O=C.oParentObject.getSelectProperties();O.forEach(function(p){C.oParentObject.removeSelectProperty(p);});C.clearOptionalRequestFieldProperty();},clearOptionalRequestFieldProperty:function(){var C=this;var O=C.oParentObject.getFilterProperties();O.forEach(function(p){C.oParentObject.removeFilterProperty(p);});},removeSelectProperties:function(p){var C=this;p.forEach(function(e){C.oParentObject.removeSelectProperty(e);});},removeOptionalRequestFieldProperty:function(p){var C=this;p.forEach(function(e){C.oParentObject.removeFilterProperty(e);});},updateSource:function(s){var C=this;C.oParentObject.setService(s);},updateEntity:function(e){var C=this;C.oParentObject.setEntitySet(e);},updateSelectProperties:function(s){var C=this;C.removeSelectProperties(C.oParentObject.getSelectProperties());s.forEach(function(p){C.oParentObject.addSelectProperty(p);});},updateOptionalRequestFieldProperty:function(f){var C=this;var l=C.oParentObject.getFilterPropertyLabelKey();var D=C.oParentObject.getFilterPropertyLabelDisplayOption();var F=C.oParentObject.getFilterProperties();C.removeOptionalRequestFieldProperty(C.oParentObject.getFilterProperties());f.forEach(function(p){if(p!==C.getView().getViewData().oTextReader("none")){C.oParentObject.addFilterProperty(p);if(p===F[0]){C.oParentObject.setFilterPropertyLabelKey(l);C.oParentObject.setFilterPropertyLabelDisplayOption(D);}}});},getSelectProperties:function(){var C=this;return C.oParentObject.getSelectProperties();},getOptionalRequestFieldProperty:function(){var C=this;return C.oParentObject.getFilterProperties();},getValidationState:function(){var C=this;return C.viewValidator.getValidationState();}});});
