/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/modeler/ui/utils/textPoolHelper","sap/apf/modeler/ui/utils/nullObjectChecker","sap/apf/modeler/ui/utils/optionsValueModelBuilder","sap/apf/modeler/ui/utils/viewValidator","sap/apf/modeler/ui/utils/textManipulator"],function(t,n,o,v,a){"use strict";var p,T,c,C,b,f,d;var n=sap.apf.modeler.ui.utils.nullObjectChecker;var o=sap.apf.modeler.ui.utils.optionsValueModelBuilder;var a=sap.apf.modeler.ui.utils.textManipulator;var e=sap.apf.modeler.ui.utils.TranslationFormatMap.FACETFILTER_LABEL;function _(i){i.byId("idFacetFilterBasicData").setText(T("basicData"));i.byId("idFFLabel").setText(T("ffLabel"));i.byId("idLabel").setPlaceholder(T("newFacetFilter"));i.byId("idFFPropertyLabel").setText(T("ffProperty"));i.byId("idDoNotShowAtRuntimeLabel").setText(T("doNotShowAtRuntime"));i.byId("idSelectionModeLabel").setText(T("ffSelectionMode"));i.byId("idValueHelpLabel").setText(T("valueHelpMode"));i.byId("idVHNone").setText(T("none"));i.byId("idValueHelpRequest").setText(T("valueHelpRequest"));i.byId("idConfigListOfValues").setText(T("configListOfValues"));i.byId("idConfigListOfValuesLabel").setText(T("configListOfValuesLabel"));i.byId("idSingleSelectionMode").setText(T("singleSelection"));i.byId("idMultiSelectionMode").setText(T("multipleSelection"));i.byId("idDefaultValuesTitle").setText(T("vhDefaultValues"));i.byId("idPreselectionModeLabel").setText(T("vhDefaultValueMode"));i.byId("idNoneSelection").setText(T("none"));i.byId("idAutomaticSelection").setText(T("automaticValue"));i.byId("idFixedValue").setText(T("fixedValues"));i.byId("idFunction").setText(T("function"));i.byId("idPreselectionDefaultsLabel").setText(T("vhDefaultValues"));i.byId("idPreselectionFunctionLabel").setText(T("function"));i.byId("idValueHelpTitle").setText(T("valueHelp"));i.byId("idFilterResolutionTitle").setText(T("contextResolution"));i.byId("idUseVHRAsFRRCheckBoxLabel").setText(T("vhCheckBoxLabel"));i.byId("idAriaPropertyForSelection").setText(T("ffSelectionMode"));i.byId("idAriaPropertyForDefaultMode").setText(T("vhDefaultValueMode"));i.byId("idAriaPropertyForVHR").setText(T("valueHelpMode"));}function g(i,J){var K=f.isVisible()?"sap-icon://filter":"sap-icon://hide";var L={id:f.getId(),icon:K};if(J){delete L.icon;L.name=J;}i.getView().getViewData().updateSelectedNode(L);}function h(i,J){var K=T("facetFilter")+": "+J;i.getView().getViewData().updateTitleAndBreadCrumb(K);}function j(i){var J;if(p&&p.arguments&&p.arguments.facetFilterId){f=C.getFacetFilter(p.arguments.facetFilterId);}if(!n.checkIsNotUndefined(f)){J=C.createFacetFilter();f=C.getFacetFilter(J);g(i);}}function k(i){var J,K,V,L;var M={oTextReader:T,oConfigurationHandler:c,oConfigurationEditor:C,oParentObject:f,getCalatogServiceUri:i.getView().getViewData().getCalatogServiceUri,oCoreApi:i.getView().getViewData().oCoreApi};J=new sap.ui.controller("sap.apf.modeler.ui.controller.facetFilterVHR");V=new sap.ui.view({viewName:"sap.apf.modeler.ui.view.requestOptions",type:sap.ui.core.mvc.ViewType.XML,id:i.createId("idVHRView"),viewData:M,controller:J});K=new sap.ui.controller("sap.apf.modeler.ui.controller.facetFilterFRR");L=new sap.ui.view({viewName:"sap.apf.modeler.ui.view.requestOptions",type:sap.ui.core.mvc.ViewType.XML,id:i.createId("idFRRView"),viewData:M,controller:K});V.attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.UPDATEPROPERTIES,i.setFFProperty.bind(i));L.attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.UPDATEPROPERTIES,i.setFFProperty.bind(i));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.USESAMEASVHR,L.getController().handleCopy.bind(L.getController()));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.ENABLEDISABLEFRRFIELDS,L.getController().enableOrDisableView.bind(L.getController()));V.attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.USESAMEASVHR,L.getController().handleCopy.bind(L.getController()));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,V.getController().updateSubViewInstancesOnReset.bind(V.getController()));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,L.getController().updateSubViewInstancesOnReset.bind(L.getController()));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.DONOTSHOWATRUNTIME,V.getController().clearVHRFields.bind(V.getController()));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.CLEARVHRFIELDSIFVALUELIST,V.getController().clearVHRFields.bind(V.getController()));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.DONOTSHOWATRUNTIME,L.getController().clearFRRFields.bind(L.getController()));V.addStyleClass("formTopPadding");V.addStyleClass("formBottomPadding");L.addStyleClass("formTopPadding");}function l(i,V){i.byId("idSelectionMode").setVisible(V);i.byId("idSelectionModeLabel").setVisible(V);i.byId("idSelectionModeRadioGroup").setSelectedButton(i.byId("idMultiSelectionMode"));i.byId("idValueHelp").setVisible(V);i.byId("idValueHelpLabel").setVisible(V);i.byId("idValueHelpRadioGroup").setSelectedButton(i.byId("idVHNone"));i.byId("idFFForm1").setVisible(V);if(V){i.byId("idValueHelpTitle").setText(T("valueHelp"));i.byId("idFRRVBox").insertItem(i.byId("idFRRView"));i.byId("idDoNotShowAtRuntimeCheckBox").setSelected(false);}else{i.byId("idValueHelpTitle").setText("");B(i,V);A(i,V);i.byId("idFRRVBox").removeItem(i.byId("idFRRView"));}}function m(i){if(!f.isVisible()){i.byId("idDoNotShowAtRuntimeCheckBox").setSelected(true);}l(i,f.isVisible());}function q(i){if(!n.checkIsNotNullOrUndefinedOrBlank(C.getFacetFilter(p.arguments.facetFilterId))){return;}if(n.checkIsNotNullOrUndefinedOrBlank(f.getLabelKey())&&b.get(f.getLabelKey())){i.byId("idLabel").setValue(b.get(f.getLabelKey()).TextElementDescription);}else{i.byId("idLabel").setValue(f.getId());}}function r(i){if(!n.checkIsNotNullOrUndefinedOrBlank(C.getFacetFilter(p.arguments.facetFilterId))){f.setMultiSelection(true);}if(f.isMultiSelection()){i.byId("idSelectionModeRadioGroup").setSelectedButton(i.byId("idMultiSelectionMode"));}else{i.byId("idSelectionModeRadioGroup").setSelectedButton(i.byId("idSingleSelectionMode"));}}function s(i){i.byId("idPreselectionFunction").setValue("");if(n.checkIsNotNullOrUndefinedOrBlank(f.getPreselectionFunction())){i.byId("idPreselectionFunction").setValue(f.getPreselectionFunction());}}function u(i){var J=false,K=false;if(f.getNoneSelection()){i.byId("idPreselectionModeRadioGroup").setSelectedButton(i.byId("idNoneSelection"));}else if(n.checkIsNotNullOrUndefinedOrBlank(f.getPreselectionFunction())){i.byId("idPreselectionModeRadioGroup").setSelectedButton(i.byId("idFunction"));s(i);J=true;}else if(n.checkIsNotNullOrUndefinedOrBlank(f.getPreselectionDefaults())){i.byId("idPreselectionModeRadioGroup").setSelectedButton(i.byId("idFixedValue"));y(i);K=true;}else if(f.getAutomaticSelection()){i.byId("idPreselectionModeRadioGroup").setSelectedButton(i.byId("idAutomaticSelection"));}w(i,J);x(i,K);}function w(i,V){i.byId("idPreselectionFunctionLabel").setVisible(V);i.byId("idPreselectionFunction").setVisible(V);if(V){d.addField("idPreselectionFunction");}else{i.byId("idPreselectionFunction").setValue("");d.removeField("idPreselectionFunction");}}function x(i,V){i.byId("idPreselectionDefaultsLabel").setVisible(V);i.byId("idPreselectionDefaults").setVisible(V);if(V){d.addField("idPreselectionDefaults");}else{d.removeField("idPreselectionDefaults");}}function y(i){i.byId("idPreselectionDefaults").setTokens([]);var J=f.getPreselectionDefaults();if(n.checkIsNotNullOrUndefinedOrBlank(J)){J.forEach(function(K){i.byId("idPreselectionDefaults").addToken(new sap.m.Token({text:K}));});}}function z(i){i.byId("idConfigListOfValuesMultiInput").setTokens([]);var J=f.getValueList();if(n.checkIsNotNullOrUndefinedOrBlank(J)){J.forEach(function(K){i.byId("idConfigListOfValuesMultiInput").addToken(new sap.m.Token({text:K}));});}}function A(i,J){i.byId("idConfigListOfValuesLabel").setVisible(J);i.byId("idConfigListOfValuesMultiInput").setVisible(J);if(J){d.addField("idConfigListOfValuesMultiInput");}else{d.removeField("idConfigListOfValuesMultiInput");}}function B(i,J){i.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.ENABLEDISABLEFRRFIELDS);F(i,J);if(J){i.byId("idVHRVBox").insertItem(i.byId("idVHRView"));}else{i.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.CLEARVHRFIELDSIFVALUELIST);i.byId("idVHRVBox").removeItem(i.byId("idVHRView"));}}function D(i){if(f.getUseSameRequestForValueHelpAndFilterResolution()){i.byId("idUseVHRAsFRRCheckBox").setSelected(true);i.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.ENABLEDISABLEFRRFIELDS);}}function E(i){var J=false,K=false;if(n.checkIsNotNullOrUndefinedOrBlank(f.getServiceOfValueHelp())){J=true;i.byId("idValueHelpRadioGroup").setSelectedButton(i.byId("idValueHelpRequest"));}else if(n.checkIsNotNullOrUndefinedOrBlank(f.getValueList())){z(i);K=true;i.byId("idValueHelpRadioGroup").setSelectedButton(i.byId("idConfigListOfValues"));}else{i.byId("idValueHelpRadioGroup").setSelectedButton(i.byId("idVHNone"));}A(i,K);B(i,J);}function F(i,J){if(J===false){i.byId("idUseVHRAsFRRCheckBox").setSelected(false);}i.byId("idUseVHRAsFRRCheckBox").setVisible(J);i.byId("idUseVHRAsFRRCheckBoxLabel").setVisible(J);}function G(i,J){J.byId("idPreselectionDefaults").setValueState(sap.ui.core.ValueState.Warning);J.byId("idPreselectionDefaults").setValueStateText(T(i));J.byId('idPreselectionDefaults').focus();}function H(i,M){var P=new sap.m.Token({text:i});M.addToken(P);C.setIsUnsaved();}function I(M,i){if(M.mEventRegistry.tokenChange===undefined){M.attachTokenChange(i);}}sap.ui.controller("sap.apf.modeler.ui.controller.facetFilter",{onInit:function(){var i=this;var V=i.getView().getViewData();T=V.getText;p=V.oParams;c=V.oConfigurationHandler;b=c.getTextPool();C=V.oConfigurationEditor;if(!C){c.loadConfiguration(p.arguments.configId,function(J){C=J;});}d=new sap.apf.modeler.ui.utils.ViewValidator(i.getView());_(i);j(i);k(i);i.setDetailData();d.addFields(["idFFProperty","idLabel"]);},onAfterRendering:function(){var i=this;if(i.byId("idLabel").getValue().length===0){i.byId("idLabel").focus();}I(i.byId("idConfigListOfValuesMultiInput"),i.handleTokenChangeForConfigListOfValues.bind(i));I(i.byId("idPreselectionDefaults"),i.handleTokenChangeForPreselectionDefaults.bind(i));},setDetailData:function(){var i=this;m(i);i.setFFProperty();q(i);r(i);u(i);E(i);D(i);},updateSubViewInstancesOnReset:function(i){var J=this;C=i;f=C.getFacetFilter(f.getId());J.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,{"oConfigurationEditor":C,"oParentObject":f});},validateSelectedValues:function(i,S,J){var V={},K=[],L=[],M=[],N=[],O;V=sap.apf.utils.validateSelectedValues(S,J);K=V.invalid;L=V.valid;M=a.addPrefixText(K,T);N=M.concat(J).length!==0?M.concat(J):J;O=M.concat(L).length!==0?M.concat(L):S;return{aValues:N,aSelectedValues:O};},setFFProperty:function(){var i=this;var J=[],V,K;C.getFilterablePropertiesAndParametersAsPromise().done(function(L){J=L;K=f.getProperty();if(n.checkIsNotNullOrUndefinedOrBlank(K)){V=i.validateSelectedValues(i,[K],J);J=V.aValues;K=V.aSelectedValues[0];}var M=o.convert(J);i.byId("idFFProperty").setModel(M);i.byId("idFFProperty").setSelectedKey(K);});},handleChangeForVisibilityAtRuntime:function(){var i=this,V=true;if(i.byId("idDoNotShowAtRuntimeCheckBox").getSelected()){V=false;f.setInvisible();f.setUseSameRequestForValueHelpAndFilterResolution(false);i.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.ENABLEDISABLEFRRFIELDS);i.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.DONOTSHOWATRUNTIME);f.setValueList([]);z(i);}else{f.setVisible();}f.setMultiSelection(true);C.setIsUnsaved();g(i);l(i,V);},handleChangeForProperty:function(){var i=this;var J=i.byId("idFFProperty").getSelectedKey().trim();J=a.removePrefixText(J,T(sap.apf.modeler.ui.utils.CONSTANTS.texts.NOTAVAILABLE));if(n.checkIsNotNullOrUndefinedOrBlank(J)){f.setProperty(J);}C.setIsUnsaved();},handleChangeForLabel:function(){var i=this;var J=i.byId("idLabel").getValue().trim();if(n.checkIsNotNullOrUndefinedOrBlank(J)){b.setTextAsPromise(J,e).done(function(K){f.setLabelKey(K);g(i,J);h(i,J);C.setIsUnsaved();});}else{C.setIsUnsaved();}},handleSuggestions:function(i){var S=new sap.apf.modeler.ui.utils.SuggestionTextHandler(b);S.manageSuggestionTexts(i,e);},handleChangeForSelectionMode:function(){var i=this,P,J;var S=i.byId("idSelectionModeRadioGroup").getSelectedButton();if(S===i.byId("idSingleSelectionMode")){f.setMultiSelection(false);if(i.byId("idPreselectionDefaultsLabel").getVisible()){P=f.getPreselectionDefaults();if(P&&P.length>1){f.setPreselectionDefaults([P[0]]);J=new sap.m.Token({text:P[0]});i.byId("idPreselectionDefaults").setTokens([J]);G("singleToMultipleSelectionWarningMessage",i);}}}else{i.byId("idPreselectionDefaults").setValueState(sap.ui.core.ValueState.None);f.setMultiSelection(true);}C.setIsUnsaved();},handleChangeForPreselectionMode:function(){var i=this,J=false,P=false,K=false,N=false;switch(i.byId("idPreselectionModeRadioGroup").getSelectedButton()){case i.byId("idAutomaticSelection"):J=true;break;case i.byId("idFunction"):P=true;f.removePreselectionDefaults();break;case i.byId("idFixedValue"):K=true;f.removePreselectionFunction();break;default:N=true;}f.setAutomaticSelection(J);f.setNoneSelection(N);y(i);s(i);x(i,K);w(i,P);C.setIsUnsaved();},handleChangeForPreselectionDefaults:function(i){var J=this;J.byId("idPreselectionDefaults").setValue("");J.byId("idPreselectionDefaults").setValueState(sap.ui.core.ValueState.None);if(!f.isMultiSelection()){if(J.byId("idPreselectionDefaults").getTokens().length<1){J.byId("idPreselectionDefaults").setValueState(sap.ui.core.ValueState.None);H(i.getParameter("value"),J.byId("idPreselectionDefaults"));}else{G("singleSelectionWarningMessage",J);}}else{H(i.getParameter("value"),J.byId("idPreselectionDefaults"));}},handleTokenChangeForPreselectionDefaults:function(J){var K=this;var i,L=[];var M=K.byId("idPreselectionDefaults").getTokens();K.byId("idPreselectionDefaults").setValueState(sap.ui.core.ValueState.None);if(J.getParameters().type==="removed"||J.getParameters().type==="added"){for(i=0;i<M.length;i++){L[i]=M[i].getText();}if(f.isMultiSelection()){f.setPreselectionDefaults(L);}else{f.setPreselectionDefaults([L[0]]);}if(J.getParameters().type==="removed"){C.setIsUnsaved();}}},handleChangeForPreselectionFunction:function(){var i=this;var P=i.byId("idPreselectionFunction").getValue().trim();f.removePreselectionFunction();if(n.checkIsNotNullOrUndefinedOrBlank(P)){f.setPreselectionFunction(P);}C.setIsUnsaved();},handleChangeForUseVHRAsFRRCheckBox:function(){var i=this;if(i.byId("idUseVHRAsFRRCheckBox").getSelected()){f.setUseSameRequestForValueHelpAndFilterResolution(true);}else{f.setUseSameRequestForValueHelpAndFilterResolution(false);}i.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.ENABLEDISABLEFRRFIELDS);i.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.USESAMEASVHR);C.setIsUnsaved();},handleChangeForValueHelpOption:function(){var i=this,V=false,J=false;switch(i.byId("idValueHelpRadioGroup").getSelectedButton()){case i.byId("idValueHelpRequest"):V=true;f.setValueList([]);break;case i.byId("idConfigListOfValues"):J=true;f.setAlias(undefined);break;default:f.setAlias(undefined);f.setValueList([]);}if(f.getUseSameRequestForValueHelpAndFilterResolution()===true){f.setUseSameRequestForValueHelpAndFilterResolution(false);i.byId("idUseVHRAsFRRCheckBox").setSelected(false);}z(i);A(i,J);B(i,V);C.setIsUnsaved();},handleChangeForConfigListOfValues:function(i){var J=this;J.byId("idConfigListOfValuesMultiInput").setValue("");H(i.getParameter("value"),J.byId("idConfigListOfValuesMultiInput"));},handleTokenChangeForConfigListOfValues:function(J){var K=this;var i,L=[];var M=K.byId("idConfigListOfValuesMultiInput").getTokens();if(J.getParameters().type==="removed"||J.getParameters().type==="added"){for(i=0;i<M.length;i++){L[i]=M[i].getText();}f.setValueList(L);if(J.getParameters().type==="removed"){C.setIsUnsaved();}}},getValidationState:function(){var i=this;return d.getValidationState()&&i.byId("idVHRView").getController().getValidationState()&&i.byId("idFRRView").getController().getValidationState();},onExit:function(){var i=this;i.byId("idVHRView").destroy();i.byId("idFRRView").destroy();}});});
