sap.ui.define(["sap/apf/modeler/ui/utils/sortDataHandler","sap/apf/modeler/ui/utils/nullObjectChecker","sap/apf/modeler/ui/utils/optionsValueModelBuilder","sap/apf/modeler/ui/utils/viewValidator","sap/apf/modeler/ui/utils/stepPropertyMetadataHandler","sap/apf/modeler/ui/utils/textPoolHelper"],function(S,n,o,V,a,t){"use strict";var p,T,c,C,b,g,s,v,d,e,I,f;var h=sap.apf.modeler.ui.utils.TranslationFormatMap.STEP_TITLE;var k=sap.apf.modeler.ui.utils.TranslationFormatMap.STEP_LONG_TITLE;function _(i){i.byId("idStepBasicData").setText(T("stepBasicData"));i.byId("idStepTitleLabel").setText(T("stepTitle"));i.byId("idStepTitle").setPlaceholder(T("newStep"));i.byId("idStepLongTitleLabel").setText(T("stepLongTitle"));i.byId("idStepLongTitle").setPlaceholder(T("stepLongTitle"));i.byId("idCategoryTitleLabel").setText(T("categoryAssignments"));i.byId("idGlobalLabel").setText(T("globalNavigationTarget"));i.byId("idStepSpecificLabel").setText(T("stepSpecificNavTargets"));i.byId("idDataRequest").setText(T("dataRequest"));i.byId("idFilterMapping").setText(T("filterMap"));i.byId("idFilterMapKeepSourceLabel").setText(T("filterMapKeepSource"));i.byId("idNavigationTarget").setText(T("navigationTargetAssignments"));i.byId("idDataReduction").setText(T("dataReduction"));i.byId("idDataReductionLabel").setText(T("dataReductionType"));i.byId("idNoDataReduction").setText(T("noDataReduction"));i.byId("idTopN").setText(T("topN"));i.byId("idNumberOfRecordsLabel").setText(T("recordNumber"));i.byId("idAriaPropertyForDataReduction").setText(T("dataReductionType"));}function l(i,j){var O=T(I?"hierarchicalStepTitle":"step")+": "+j;i.getView().getViewData().updateTitleAndBreadCrumb(O);m(i,j);}function m(i,j){var O=T(I?"hierarchicalStepTitle":"step")+": "+j;i.getView().getViewData().oTitleBreadCrumbController.byId("IdFormTitle").setText(O);}function q(i,j){var O={id:s.getId(),icon:s.getType()==="hierarchicalStep"?"sap-icon://drill-down":"sap-icon://step"};if(j){O.name=j;}i.getView().getViewData().updateSelectedNode(O);}function r(i){var j,O;if(p&&p.arguments&&p.arguments.stepId){s=C.getStep(p.arguments.stepId);I=(s&&s.getType()==="hierarchicalStep")?true:false;}if(!n.checkIsNotUndefined(s)){O=p.arguments.categoryId;I=p.bIsHierarchicalStep;if(I){j=C.createHierarchicalStep(O);}else{j=C.createStep(O);}s=C.getStep(j);q(i);}}function u(i){var j=this;var O=i.getParameter("bShowFilterMappingLayout");j.byId("idStepFilterMappingVBox").setVisible(O);j.byId("idFilterMapKeepSourceLabel").setVisible(O);j.byId("idFilterKeepSourceCheckBox").setVisible(O);if(!O){j.byId("idFilterMapping").setText("");j.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.RESETFILTERMAPPINGFIELDS);}else{j.byId("idFilterMapping").setText(T("filterMap"));}}function w(i){i.byId("idDataReductionForm").setVisible(!I);}function x(i,j,O,P,U){sap.ui.view({viewName:P,type:sap.ui.core.mvc.ViewType.XML,id:i.createId(U),viewData:O,controller:j});}function y(i){var j,O,P,Q,R,U,W;j={oTextReader:T,oConfigurationEditor:C,oTextPool:b,oParentObject:s,oStepPropertyMetadataHandler:f,oCoreApi:i.getView().getViewData().oCoreApi};O=new sap.ui.controller("sap.apf.modeler.ui.controller.stepCornerTexts");x(i,O,j,"sap.apf.modeler.ui.view.cornerTexts","idStepCornerTextView");R=i.byId("idStepCornerTextView");i.byId("idStepCornerTextVBox").insertItem(R);j.oConfigurationHandler=c;j.getCalatogServiceUri=i.getView().getViewData().getCalatogServiceUri;if(I){P=new sap.ui.controller("sap.apf.modeler.ui.controller.hierarchicalStepRequest");}else{P=new sap.ui.controller("sap.apf.modeler.ui.controller.stepRequest");}x(i,P,j,"sap.apf.modeler.ui.view.requestOptions","idStepRequestView");U=i.byId("idStepRequestView");i.byId("idStepRequestVBox").insertItem(U);Q=new sap.ui.controller("sap.apf.modeler.ui.controller.stepFilterMapping");x(i,Q,j,"sap.apf.modeler.ui.view.requestOptions","idStepFilterMappingView");W=i.byId("idStepFilterMappingView");i.byId("idStepFilterMappingVBox").insertItem(W);U.attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETDATAREDUCTIONSECTION,i.setDataReductionSection.bind(i));U.attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETVISIBILITYOFFILTERMAPPINGFIELDS,u.bind(i));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETVISIBILITYOFFILTERMAPPINGFIELDS,u.bind(i));U.attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.UPDATEFILTERMAPPINGFIELDS,W.getController().updateFilterMappingFields.bind(W.getController()));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.RESETFILTERMAPPINGFIELDS,W.getController().resetFilterMappingFields.bind(W.getController()));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,R.getController().updateSubViewInstancesOnReset.bind(R.getController()));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,U.getController().updateSubViewInstancesOnReset.bind(U.getController()));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,W.getController().updateSubViewInstancesOnReset.bind(W.getController()));U.addStyleClass("formTopPadding");U.addStyleClass("formBottomPadding");W.addStyleClass("formTopPadding");W.addStyleClass("formBottomPadding");}function z(i){if(!n.checkIsNotNullOrUndefinedOrBlank(C.getStep(p.arguments.stepId))){return;}i.byId("idStepTitle").setValue(s.getId());if(n.checkIsNotNullOrUndefinedOrBlank(s.getTitleId())&&b.get(s.getTitleId())){i.byId("idStepTitle").setValue(b.get(s.getTitleId()).TextElementDescription);}}function A(i){if(!n.checkIsNotNullOrUndefinedOrBlank(C.getStep(p.arguments.stepId))){return;}i.byId("idStepLongTitle").setValue("");if(n.checkIsNotNullOrUndefinedOrBlank(s.getLongTitleId())&&b.get(s.getLongTitleId())){i.byId("idStepLongTitle").setValue(b.get(s.getLongTitleId()).TextElementDescription);}}function B(i){var j=[];var O=C.getCategories();O.forEach(function(R){var U={};U.CategoryId=R.getId();U.CategoryTitle=b.get(R.labelKey)?b.get(R.labelKey).TextElementDescription:R.labelKey;j.push(U);});var P=o.prepareModel(j,j.length);i.byId("idCategorySelect").setModel(P);var Q=C.getCategoriesForStep(s.getId());if(n.checkIsNotNullOrUndefinedOrBlank(Q)){i.byId("idCategorySelect").setSelectedKeys(Q);}}function D(i){i.byId("idNumberOfRecordsValue").setValue("");i.byId("idNumberOfRecordsValue").setValueState("None");if(s.getTopN()){i.byId("idNumberOfRecordsValue").setValue(s.getTopN().top);}F(i);}function E(i){i.byId("idDataReductionRadioGroup").setSelectedButton(i.byId("idNoDataReduction"));H(i);if(s.getTopN()){i.byId("idDataReductionRadioGroup").setSelectedButton(i.byId("idTopN"));}}function F(i){var j=i.byId("idDataReductionRadioGroup").getSelectedButton()===i.byId("idTopN")?true:false;i.byId("idNumberOfRecordsLabel").setVisible(j);i.byId("idNumberOfRecordsValue").setVisible(j);if(j){v.addField("idNumberOfRecordsValue");}else{v.removeField("idNumberOfRecordsValue");}}function G(i){if(s.getTopN()){d.instantiateStepSortData();if(s.getTopN().orderby.length===0){i.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETTOPNPROPERTIES);var j=e.createMessageObject({code:"11523"});e.putMessage(j);}}else{d.destroySortData();}}function H(i){var j=(s.getSelectProperties().length!==0)?true:false;i.byId("idDataReductionRadioGroup").setEnabled(j);}function J(i){var j=(s.getFilterProperties().length!==0)?true:false;i.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETVISIBILITYOFFILTERMAPPINGFIELDS,{"bShowFilterMappingLayout":j});}function K(i){if(n.checkIsNotNullOrUndefinedOrBlank(s.getFilterMappingKeepSource())){i.byId("idFilterKeepSourceCheckBox").setSelected(s.getFilterMappingKeepSource());}}function L(i,j,O,P){var Q=[];if(j.length!==0){O.setBusy(true);}j.forEach(function(R){var U={};U.navTargetKey=R.getId();g(R.getId()).then(function(W){U.navTargetName=W;Q.push(U);if(Q.length===j.length){var X=o.prepareModel(Q,Q.length);O.setModel(X);O.setSelectedKeys(P);O.setBusy(false);}});});}function M(i){var j=C.getNavigationTargets();var O=s.getNavigationTargets();var P=j.filter(function(Q){return Q.isStepSpecific();});L(i,P,i.byId("idStepSpecificCombo"),O);}function N(i){var j=C.getNavigationTargets();var O=j.filter(function(Q){return Q.isGlobal();});var P=O.map(function(Q){return Q.getId();});L(i,O,i.byId("idGlobalCombo"),P);}sap.ui.controller("sap.apf.modeler.ui.controller.step",{onInit:function(){var i=this,j;var O=i.getView().getViewData();e=O.oCoreApi;T=e.getText;p=O.oParams;c=O.oConfigurationHandler;b=c.getTextPool();C=O.oConfigurationEditor;g=O.getNavigationTargetName;v=new V(i.getView());_(i);r(i);f=new sap.apf.modeler.ui.utils.StepPropertyMetadataHandler(e,s);d=new S(i.getView(),s,f,T);y(i);i.setDetailData();j=i.byId("idStepTitle").getValue().trim();if(j===""){j="< "+T("newStep")+" >";}m(i,j);v.addFields(["idStepTitle","idCategorySelect"]);},setDetailData:function(){var i=this;z(i);A(i);B(i);i.setDataReductionSection();w(i);J(i);K(i);M(i);N(i);},onAfterRendering:function(){var i=this;if(i.byId("idStepTitle").getValue().length===0){i.byId("idStepTitle").focus();}},updateSubViewInstancesOnReset:function(i){var j=this;C=i;s=C.getStep(s.getId());j.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,{"oConfigurationEditor":C,"oParentObject":s});},setDataReductionSection:function(){var i=this;E(i);D(i);G(i);},handleChangeForStepTitle:function(){var i=this;var j=C.getCategoriesForStep(s.getId());var O=i.byId("idStepTitle").getValue().trim();if(n.checkIsNotNullOrUndefinedOrBlank(O)){b.setTextAsPromise(O,h).done(function(P){s.setTitleId(P);if(j.length>1){i.getView().getViewData().updateTree();}else{q(i,O);}l(i,O);C.setIsUnsaved();});}else{C.setIsUnsaved();}},handleSuggestionsForStepTitle:function(i){var j=new sap.apf.modeler.ui.utils.SuggestionTextHandler(b);j.manageSuggestionTexts(i,h);},handleChangeForStepLongTitle:function(){var i=this;var j=i.byId("idStepLongTitle").getValue().trim();if(n.checkIsNotNullOrUndefined(j)){b.setTextAsPromise(j,k).done(function(O){s.setLongTitleId(O);C.setIsUnsaved();});}else{C.setIsUnsaved();}},handleSuggestionsForStepLongTitle:function(i){var j=new sap.apf.modeler.ui.utils.SuggestionTextHandler(b);j.manageSuggestionTexts(i,k);},handleChangeForCategory:function(){var O=this;var P=s.getId();var Q=p.arguments.categoryId;var R=C.getCategoriesForStep(s.getId());var U=O.byId("idCategorySelect").getSelectedKeys();var W=U.indexOf(Q);var X=[];var Y=[];var i,j;for(i=0;i<R.length;i++){var Z=false;for(j=0;j<U.length;j++){if(R[i]===U[j]){Z=true;break;}}if(!Z){Y.push(R[i]);}}if(U.length!==0){U.forEach(function($){C.addCategoryStepAssignment($,P);var a1={oldContext:{name:p.name,arguments:{configId:p.arguments.configId,categoryId:Q,stepId:P}},newContext:{arguments:{configId:p.arguments.configId,categoryId:$}}};if($!==Q){X.push(a1);}});R.forEach(function($){if(U.indexOf($)===-1){C.removeCategoryStepAssignment($,s.getId());}});if(Y.length!==0){Y.forEach(function($){var a1={oldContext:{name:p.name,arguments:{configId:p.arguments.configId,categoryId:Q,stepId:P}},newContext:{arguments:{configId:p.arguments.configId,categoryId:$}},removeStep:true};if(W===-1&&$===Q){var b1={arguments:{appId:p.arguments.appId,configId:p.arguments.configId,categoryId:U[0],stepId:P}};a1.categoryChangeContext=b1;a1.changeCategory=true;}X.push(a1);});}}if(X.length!==0){O.getView().getViewData().updateTree(X);}C.setIsUnsaved();},handleChangeForDataReductionType:function(){var i=this;if(i.byId("idDataReductionRadioGroup").getSelectedButton()===i.byId("idNoDataReduction")){s.resetTopN();i.setDataReductionSection();}else{d.instantiateStepSortData();}F(i);C.setIsUnsaved();},handleValidationForNumberOfRecords:function(i){var j=i.getSource();var O=j.getValue().trim();var P=(O.indexOf("E")!==-1||O.indexOf("e")!==-1||O.indexOf(".")!==-1||O<=0||O>10000)?sap.ui.core.ValueState.Error:sap.ui.core.ValueState.None;j.setValueState(P);C.setIsUnsaved();},handleChangeForNoOfRecords:function(i){var j=this;var O=i.getSource().getValue().trim();if(i.getSource().getValueState()===sap.ui.core.ValueState.Error){return;}if(n.checkIsNotNullOrUndefinedOrBlank(O)){if(s.getTopN()===undefined){j.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETTOPNPROPERTIES);}s.setTopNValue(O);}C.setIsUnsaved();},handleFilterMapKeepSource:function(){var i=this;var j=i.byId("idFilterKeepSourceCheckBox").getSelected();s.setFilterMappingKeepSource(j);C.setIsUnsaved();},handleChangeForStepSpecificNavTargets:function(){var i=this;var j=i.byId("idStepSpecificCombo").getSelectedKeys();var O=s.getNavigationTargets();O.forEach(function(P){if(j.indexOf(P)===-1){s.removeNavigationTarget(P);}});j.forEach(function(P){if(O.indexOf(P)===-1){s.addNavigationTarget(P);}});C.setIsUnsaved();},getValidationState:function(){var i=this;return v.getValidationState()&&i.byId("idStepRequestView").getController().getValidationState()&&i.byId("idStepFilterMappingView").getController().getValidationState();},onExit:function(){var i=this;i.byId("idStepCornerTextView").destroy();i.byId("idStepRequestView").destroy();i.byId("idStepFilterMappingView").destroy();}});});
