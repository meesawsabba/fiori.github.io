sap.ui.define(['sap/apf/modeler/ui/utils/constants','sap/apf/modeler/ui/utils/optionsValueModelBuilder','sap/apf/modeler/ui/utils/nullObjectChecker',"sap/apf/modeler/ui/utils/textPoolHelper","sap/apf/modeler/ui/utils/textManipulator","sap/apf/utils/utils","sap/ui/thirdparty/jquery"],function(M,o,n,t,a,u,q){"use strict";var T=sap.apf.modeler.ui.utils.textManipulator;var c=M.events;var b=sap.apf.modeler.ui.utils.TranslationFormatMap.REPRESENTATION_LABEL;function _(C){var r=C.oRepresentation.getRepresentationType();var K=C.getView().getViewData().oPropertyTypeData.sContext;var p=C.getView().getViewData().oRepresentationTypeHandler.getLabelsForChartType(C.oTextReader,r,K);C.byId("idPropertyTypeLabel").setText(p);C.byId("idPropertyTypeLabel").setTooltip(p);}function d(C){if(sap.ui.Device.browser.msie&&sap.ui.Device.browser.version>=11){C.byId("idAriaPropertyForBasicDataGroup").setText(C.oTextReader("basicData"));}C.byId("idAriaPropertyForAdd").setText(C.oTextReader("ariaTextForAddIcon"));C.byId("idAriaPropertyForDelete").setText(C.oTextReader("ariaTextForDeleteIcon"));}function e(C){var p;var r=q.Deferred();var v=C.byId("idPropertyType");C.getAllPropertiesAsPromise().then(function(R){p=o.convert(R.aAllProperties);v.setModel(p);v.setSelectedKey(R.sSelectedKey);r.resolve();});return r.promise();}function f(C){var p=T.removePrefixText(C.byId("idPropertyType").getSelectedKey(),C.oTextReader(M.texts.NOTAVAILABLE));var s=C.getPropertyTextLabelKey(p)?C.oTextReader("label"):C.oTextReader("label")+" ("+C.oTextReader("default")+")";C.byId("idPropertyLabel").setText(s);C.byId("idPropertyLabel").setTooltip(s);}function g(C){var p;var P=T.removePrefixText(C.byId("idPropertyType").getSelectedKey(),C.oTextReader(M.texts.NOTAVAILABLE));var s=C.getPropertyTextLabelKey(P);if(n.checkIsNotUndefined(s)){p=C.getView().getViewData().oConfigurationHandler.getTextPool().get(s).TextElementDescription;C.byId("idPropertyLabelText").setValue(p);}else{C.oStepPropertyMetadataHandler.getEntityTypeMetadataAsPromise().then(function(r){var v=C.oStepPropertyMetadataHandler.getDefaultLabel(r,P);C.byId("idPropertyLabelText").setValue(v);});}}function h(C){C.byId("idAddPropertyIcon").setTooltip(C.oTextReader("addButton"));C.byId("idRemovePropertyIcon").setTooltip(C.oTextReader("deleteButton"));}function i(C){var p=C.getView().getViewData().sPropertyType;var K=C.getView().getViewData().oPropertyTypeData.sContext;var s=C.oRepresentationTypeHandler.isAdditionToBeEnabled(C.oRepresentation.getRepresentationType(),p,K);var S=s;var P=C.getView().getViewData().oPropertyTypeState;var r=P.indexOfPropertyTypeViewId(C.getView().getId());if(r===0){S=false;}else if(r>0){var v=P.getViewAt(r-1);var w=v.getViewData().oPropertyTypeData.sContext;if(K!==w){S=false;}}C.byId("idAddPropertyIcon").setVisible(s);C.byId("idRemovePropertyIcon").setVisible(S);if(r>0){v.oController.byId("idAddPropertyIcon").setVisible(false);}}function j(C){var p=C.getView().getViewData().oPropertyTypeState;var r=p.indexOfPropertyTypeViewId(C.getView().getId());if(r>0){var s=p.aProperties.length-1;var P=p.getViewAt(r-1);var v=p.getViewAt(r);var w=C.oConfigurationEditor.isSaved();}if(r>0&&r==s&&w==false){P.oController.byId("idAddPropertyIcon").setVisible(false);v.oController.byId("idAddPropertyIcon").setVisible(true);v.oController.byId("idRemovePropertyIcon").setVisible(true);}}function k(C,p){var P=C.getView().getViewData().oPropertyTypeState;var r=P.aProperties.length;var s=P.getViewAt(p-1);var v=C.oConfigurationEditor.isSaved();if(p>1&&p==r&&v==false){s.oController.byId("idAddPropertyIcon").setVisible(true);s.oController.byId("idRemovePropertyIcon").setVisible(true);}if(p===1&&p==r&&v==false){s.oController.byId("idAddPropertyIcon").setVisible(true);}}function l(C){C.byId("idAddPropertyIcon").attachEvent(c.SETFOCUSONADDICON,C.setFocusOnAddRemoveIcons.bind(C));}var m=sap.ui.core.mvc.Controller.extend("sap.apf.modeler.ui.controller.propertyType",{_apfName:"propertyType",oConfigurationEditor:{},oRepresentation:{},oStepPropertyMetadataHandler:{},oRepresentationTypeHandler:{},oTextReader:{},oTextPool:{},initPromise:null,onInit:function(){var C=this;C.initPromise=new q.Deferred();C.oConfigurationEditor=C.getView().getViewData().oConfigurationEditor;C.oRepresentation=C.getView().getViewData().oParentObject;C.oStepPropertyMetadataHandler=C.getView().getViewData().oStepPropertyMetadataHandler;C.oRepresentationTypeHandler=C.getView().getViewData().oRepresentationTypeHandler;C.oTextReader=C.getView().getViewData().oCoreApi.getText;C.oTextPool=C.getView().getViewData().oTextPool;if(C.getView().getViewData().oPropertyTypeData.bMandatory){C.getView().getViewData().oViewValidator.addField(C.byId("idPropertyType").getId());C.byId("idPropertyTypeLabel").setRequired(true);}e(C).then(function(){C.setDetailData().then(function(){C.initPromise.resolve();});i(C);});},onAfterRendering:function(){var C=this;C.initPromise.then(function(){C.enableDisableLabelDisplayOptionTypeAsPromise().then(function(){C.byId("idAddPropertyIcon").fireEvent(c.SETFOCUSONADDICON);});});},setDetailData:function(){var p=q.Deferred();var C=this;C.setLabelDisplayOptionTypeAsPromise(o).then(function(){if(!C.byId("idPropertyType")){p.resolve();return;}g(C);d(C);f(C);_(C);h(C);p.resolve();});return p.promise();},handleChangeForPropertyTypeAsPromise:function(p){var C=this;var r=q.Deferred();var s=T.removePrefixText(C.byId("idPropertyType").getSelectedKey(),C.oTextReader(M.texts.NOTAVAILABLE));var P=C.getView().getViewData().oPropertyOrchestration;var v=C.getView().getId();var w;var x=null;if(P){w=P.isSwapCase(v,s);x=P.getPropertyTypeRowByPropertyName(s);P.updateAllSelectControlsForPropertyType(v,s).then(function(){var y;C.updateRepresentationAndView().then(function(){if(w){y=x.oView.getController();y.updateRepresentationAndView().then(function(){C.oConfigurationEditor.setIsUnsaved();r.resolve();});}else{C.oConfigurationEditor.setIsUnsaved();r.resolve();}});});}else{C.forceFailSinceOrchestrationIsMissing();r.resolve()}return r.promise();},updateRepresentationAndView:function(){var C=this;return new Promise(function(r){C.updateOfConfigurationObjectAsPromise().then(function(){C.setDetailData();C.enableDisableLabelDisplayOptionTypeAsPromise().then(function(){r();});});});},handleChangeForLabelDisplayOptionType:function(){var C=this;var L=C.byId("idLabelDisplayOptionType").getSelectedKey();C.changeLabelDisplayOption(L);C.oConfigurationEditor.setIsUnsaved();},handleChangeForLabelText:function(){var C=this,L;var s=C.byId("idPropertyLabelText").getValue();var p=T.removePrefixText(C.byId("idPropertyType").getSelectedKey(),C.oTextReader(M.texts.NOTAVAILABLE));if(s.trim().length===0){L=undefined;C.setPropertyTextLabelKey(p,L);f(C);g(C);C.oConfigurationEditor.setIsUnsaved();}else{C.getView().getViewData().oConfigurationHandler.getTextPool().setTextAsPromise(s,b).then(function(L){C.setPropertyTextLabelKey(p,L);f(C);g(C);C.oConfigurationEditor.setIsUnsaved();});}},setFocusOnAddRemoveIcons:function(){var C=this;C.byId("idAddPropertyIcon").focus();},handlePressOfAddPropertyIcon:function(){var C=this;var v=C.getView();var p=v.getViewData().oPropertyOrchestration;var r=C.byId("idPropertyType").getItems();var s=C.byId("idPropertyType").getSelectedKey();var w=C.oTextReader("none");if(this._shallAddPropertyBeHandled(r,s,w,p)){l(C);C.getView().fireEvent(M.events.ADDPROPERTY,{"oSourceView":v});C.oConfigurationEditor.setIsUnsaved();j(C);}},handlePressOfRemovePropertyIcon:function(){var C=this;var v=C.getView().getViewData();var p=v.oPropertyTypeState;var r=p.indexOfPropertyTypeViewId(C.getView().getId());if(r>0){var P=p.getViewAt(r-1);l(P.getController());}var s=v.oPropertyOrchestration;s.removePropertyTypeReference(C.getView().getId());return C.updateRepresentationAndView().then(function(){s.updateAllSelectControlsForPropertyType();v.oPropertyTypeHandlerBackLink.handlePressOfRemove({oSourceView:C.getView()});C.oConfigurationEditor.setIsUnsaved();if(r!==0){k(C,r);}C.getView().destroy();});},updateOfConfigurationObjectAsPromise:function(){var C=this;return new Promise(function(r){var p=[];if(C.getView().getViewData().oPropertyOrchestration){p=C.getView().getViewData().oPropertyOrchestration.getPropertyInformationList();C.updatePropertiesInConfiguration(p);}else{C.forceFailSinceOrchestrationIsMissing();}r();});},handleSuggestions:function(E){var C=this;var s=new sap.apf.modeler.ui.utils.SuggestionTextHandler(C.oTextPool);s.manageSuggestionTexts(E,b);},getSelectedProperty:function(){var C=this;var p=C.getView().getViewData().oPropertyTypeState;var r=p.getPropertyValueState();var s=p.indexOfPropertyTypeViewId(C.getView().getId());return r[s];},removeAllItemsFromDropDownList:function(){var C=this;var v=C.byId("idPropertyType");v.getItems().forEach(function(I){v.removeItem(I);});},setItemsOfDropDownList:function(C,A,s,p,r){function v(B,D){return B.indexOf(D)!==-1;}var w=this;var x=w.byId("idPropertyType");var y=[];var z=(s===w.oTextReader("none"));if(!p&&r===M.aggregationRoles.DIMENSION){x.addItem(new sap.ui.core.Item({key:w.oTextReader("none"),text:w.oTextReader("none")}));}if(r===M.aggregationRoles.MEASURE){y=JSON.parse(JSON.stringify(A));}else{y=JSON.parse(JSON.stringify(C));}if(!v(y,s)&&!z){y.unshift(s);}y.forEach(function(V){var B=V;if(!v(A,V)&&!z&&V!==""){V=T.addPrefixText([V],w.oTextReader)[0];}var I=new sap.ui.core.Item({key:V,text:V});x.addItem(I);if(B===s){s=V;}});x.setSelectedKey(s);},updatePropertiesInConfiguration:function(p){},createNewPropertyInfoAsPromise:function(s){return sap.apf.utils.createPromise();},setPropertyInParentObject:function(){},setLabelDisplayOptionTypeAsPromise:function(o){return sap.apf.utils.createPromise();},getAllPropertiesAsPromise:function(){return sap.apf.utils.createPromise();},getPropertyTextLabelKey:function(p){},setPropertyTextLabelKey:function(p,L){},enableDisableLabelDisplayOptionTypeAsPromise:function(){return sap.apf.utils.createPromise();},removePropertyFromParentObject:function(){},addPropertyAsPromise:function(){return sap.apf.utils.createPromise();},changeLabelDisplayOption:function(L){},_shallAddPropertyBeHandled:function(p,s,r,v){var w=p.filter(function(A){return A.mProperties.key!==r;});if(v&&v.getAggregationRole()===M.aggregationRoles.MEASURE){var x=v._getPropertyTypeRows().length;return(x<w.length);}if(p.length===0||!s){return false;}var y=w.filter(function(A){return A.mProperties.key!==s;});var z=(s===r);if(y.length<2&&z){return false;}else if(y.length<1&&!z){return false;}return true;}});return m;});
