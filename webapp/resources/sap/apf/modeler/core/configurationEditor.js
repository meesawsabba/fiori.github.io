/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP SE. All rights reserved
 */
sap.ui.define(["sap/apf/utils/utils","sap/ui/thirdparty/jquery"],function(u,q){"use strict";sap.apf.modeler.core.ConfigurationEditor=function(c,a,b,d){var t=this;var f;var e;var g=a.instances.configurationHandler;var p=a.instances.persistenceProxy;var m=a.instances.messageHandler;var h=a.instances.metadataFactory;var j=true;var s,k,l,n,o,r;var v;var w=new a.constructors.ConfigurationObjects(a);var x=new a.constructors.ConfigurationFactory({instances:{messageHandler:m},constructors:{RegistryProbe:a.constructors.RegistryProbe}});if(!d){s=new a.constructors.ElementContainer("Step",a.constructors.Step,a);k=new a.constructors.ElementContainer("Category",undefined,a);l=new a.constructors.ElementContainer("FacetFilter",a.constructors.FacetFilter,a);n=new a.constructors.ElementContainer("NavigationTarget",a.constructors.NavigationTarget,a);o=new a.constructors.ElementContainer("CategoryStepAssignment",a.constructors.ElementContainer,a);r=[];f={smartFilterBar:true};}else{s=d.stepContainer;k=d.categoryContainer;v=d.smartFilterBar;l=d.facetFilterContainer;n=d.navigationTargetContainer;o=d.categoryStepAssignmentContainer;r=d.serviceList;e=d.applicationTitle;f=d.filterOption;}this.registerServiceAsPromise=function(i){var A=q.Deferred();var B;if(r.indexOf(i)===-1){B=h.getMetadata(i);B.done(function(){if(r.indexOf(i)===-1){r.push(i);}A.resolve(true);});B.fail(function(){A.resolve(false);});}else{A.resolve(true);}return A.promise();};this.getAllServices=function(){return r;};this.getAllEntitySetsOfServiceAsPromise=function(i){return h.getEntitySets(i);};this.getAllHierarchicalEntitySetsOfServiceAsPromise=function(i){var A=q.Deferred();h.getMetadata(i).done(function(B){if(B){A.resolve(B.getHierarchicalEntitySets());}A.resolve([]);}).fail(function(){A.resolve([]);});return A.promise();};this.checkIfHierarchicalEntitySetIsAvailableAsPromise=function(i){var A=q.Deferred();this.getAllHierarchicalEntitySetsOfServiceAsPromise(i).done(function(B){if(B.length>0){A.resolve(true);}else{A.resolve(false);}});return A;};this.getHierarchicalPropertiesOfEntitySetAsPromise=function(i,A){var B=q.Deferred();h.getMetadata(i).done(function(C){if(C){B.resolve(C.getHierarchicalPropertiesOfEntitySet(A));}else{B.resolve([]);}}).fail(function(){B.resolve([]);});return B;};this.getHierarchyNodeIdAsPromise=function(i,A,B){var C;var D=q.Deferred();h.getMetadata(i).done(function(E){if(E){C=E.getHierarchyAnnotationsForProperty(A,B);if(C&&C.hierarchyNodeFor){D.resolve(C.hierarchyNodeFor);}else{D.resolve(null);}}else{D.resolve(null);}}).fail(function(){D.resolve(null);});return D;};this.getNonHierarchicalPropertiesOfEntitySet=function(i,A){var B;var C=q.Deferred();h.getMetadata(i).then(function(D){B=D.getNonHierarchicalPropertiesOfEntitySet(A);C.resolve(B);},function(){C.resolve([]);});return C;};this.getAllEntitySetsExceptParameterEntitySets=function(i){return h.getAllEntitySetsExceptParameterEntitySets(i);};this.getAllEntitySetsOfServiceWithGivenPropertiesAsPromise=function(A,B){var C=[];var D=q.Deferred();this.getAllEntitySetsOfServiceAsPromise(A).done(function(E){if(!B||B.length===0){D.resolve(E);return;}h.getMetadata(A).done(function(F){E.forEach(function(G){var H=F.getFilterableProperties(G);var I=true;for(var i=0;i<B.length;i++){if(H.indexOf(B[i])<=-1){I=false;break;}}if(I){C.push(G);}});D.resolve(C);});});return D.promise();};this.getAllPropertiesOfEntitySetAsPromise=function(i,A){var B=q.Deferred();h.getMetadata(i).done(function(C){B.resolve(C.getAllPropertiesOfEntitySet(A));}).fail(function(){B.resolve([]);});return B.promise();};this.getAllKnownPropertiesAsPromise=function(){var i=q.Deferred();var A=[];var B=r.length;r.forEach(function(C){h.getMetadata(C).done(function(D){A=A.concat(D.getAllProperties());B--;if(B===0){A=sap.apf.utils.eliminateDuplicatesInArray(m,A);i.resolve(A);}});});return i.promise();};this.getFilterablePropertiesAndParametersAsPromise=function(){var i=q.Deferred();var A=[];var B=r.length;r.forEach(function(C){h.getMetadata(C).done(function(D){A=A.concat(D.getFilterablePropertiesAndParameters());if(--B===0){i.resolve(sap.apf.utils.eliminateDuplicatesInArray(m,A));}});});if(B===0){i.resolve([]);}return i.promise();};this.setApplicationTitle=function(i){j=false;e=i;};this.getApplicationTitle=function(){return e;};this.getConfigurationName=function(){return g.getConfiguration(c.id||c).AnalyticalConfigurationName;};this.getCategoryStepAssignments=function(i){var A=[];if(!this.getCategory(i)){return false;}var B=o.getElement(i);if(B){B.getElements().forEach(function(C){A.push(C.stepId);});}return A;};this.addCategoryStepAssignment=function(i,A){if(!this.getCategory(i)||!this.getStep(A)){return false;}var B=o.getElement(i);if(!B){o.createElementWithProposedId({},i);B=o.getElement(i);}if(!B.getElement(A)){B.createElementWithProposedId({stepId:A},A);return true;}return false;};this.removeCategoryStepAssignment=function(i,A){var B;if(!A){var C=this.getCategoryStepAssignments(i);B=o.removeElement(i);if(B){y(C);}return!!B;}var D=o.getElement(i);if(!D){return false;}B=D.removeElement(A);if(D.getElements().length===0){o.removeElement(i);}if(B){y([A]);}return!!B;};function y(i){if(!i){return;}i.forEach(function(A){if(t.getCategoriesForStep(A).length===0){s.removeElement(A);}});}this.moveCategoryStepAssignmentBefore=function(i,A,B){var C=o.getElement(i);if(!C){return null;}return C.moveBefore(A,B);};this.moveCategoryStepAssignmentToEnd=function(i,A){var B=o.getElement(i);if(!B){return null;}return B.moveToEnd(A);};this.moveCategoryStepAssignmentUpOrDown=function(i,A,B){var C=o.getElement(i);if(!C){return null;}return C.moveUpOrDown(A,B);};this.getCategory=k.getElement;this.setCategory=function(i,A){j=false;return k.setElement(i,A);};this.createCategoryWithId=function(i,A){j=false;return k.createElementWithProposedId(i,A).getId();};this.removeCategory=function(i){var A=t.getCategoryStepAssignments(i);if(A){A.forEach(function(B){var C=t.getCategoriesForStep(B);if(!C||C.length<2){s.removeElement(B);}});}k.removeElement(i);};this.getCategories=k.getElements;this.copyCategory=function(i){var A=k.copyElement(i);if(!A){return;}t.getCategoryStepAssignments(i).forEach(function(B){_(B,A);});return A;};this.moveCategoryBefore=function(i,A){return k.moveBefore(i,A);};this.moveCategoryToEnd=function(i){return k.moveToEnd(i);};this.moveCategoryUpOrDown=function(i,A){return k.moveUpOrDown(i,A);};this.serialize=function(){return w.serializeConfiguration(t);};this.isSaved=function(){return j;};this.setIsUnsaved=function(){j=false;};this.save=function(i){var A;function B(E,F,G){if(!G){j=true;g.replaceConfigurationId(c.id||c,E.AnalyticalConfiguration);g.updateConfigurationName(c.id||c,A);c=E.AnalyticalConfiguration;}i(c,F,G);}function C(E,F){if(!F){j=true;}g.updateConfigurationName(c.id||c,A);i(c.id||c,E,F);}A=g.getConfiguration(c.id||c).AnalyticalConfigurationName;var D={AnalyticalConfiguration:"",AnalyticalConfigurationName:A,Application:g.getApplicationId(),SerializedAnalyticalConfiguration:JSON.stringify(this.serialize()),CreatedByUser:"",CreationUTCDateTime:null,LastChangeUTCDateTime:null,LastChangedByUser:""};if(typeof c==='string'){if(c.indexOf("apf1972-")===0){p.create("configuration",D,B);}else{D.AnalyticalConfiguration=c;p.update("configuration",D,C,[{name:"AnalyticalConfiguration",value:c}]);}}else{if(c.id.indexOf("apf1972-")===0){D.AnalyticalConfiguration="";D.CreationUTCDateTime=null;D.LastChangeUTCDateTime=null;}else{D.AnalyticalConfiguration=c.id;D.CreationUTCDateTime=c.creationDate;D.LastChangeUTCDateTime=c.lastChangeDate;}if(c.updateExisting){p.update("configuration",D,C,[{name:"AnalyticalConfiguration",value:c.id}]);}else{p.create("configuration",D,B);}}};this.getFilterOption=function(){return Object.assign({},f);};this.setFilterOption=function(i){if(i.none===true){v=null;A.call(this);B();}if(i.smartFilterBar===true){A.call(this);C();}if(i.facetFilter===true){v=null;D();}function A(){this.getFacetFilters().forEach(function(E){this.removeFacetFilter(E.getId());}.bind(this));}function B(){delete f.smartFilterBar;delete f.facetFilter;f.none=true;}function C(){f.smartFilterBar=true;delete f.facetFilter;delete f.none;}function D(){delete f.smartFilterBar;f.facetFilter=true;delete f.none;}};this.isDataLostByFilterOptionChange=function(){if(f.smartFilterBar===true){if(v&&(v.getService()||v.getEntitySet())){return true;}}if(f.facetFilter===true){if(l.getElements().length>0){return true;}}return false;};this.getSmartFilterBar=function(){if(f.smartFilterBar===true){if(!v){v=new a.constructors.SmartFilterBar("SmartFilterBar-1");}return v;}return null;};this.createFacetFilterWithId=function(i){if(f.facetFilter===true){return l.createElementWithProposedId(undefined,i).getId();}return null;};this.createFacetFilter=function(){if(f.facetFilter===true){return l.createElement().getId();}return null;};this.removeFacetFilter=l.removeElement;this.getFacetFilter=l.getElement;this.getFacetFilters=l.getElements;this.copyFacetFilter=l.copyElement;this.moveFacetFilterBefore=function(i,A){return l.moveBefore(i,A);};this.moveFacetFilterToEnd=function(i){return l.moveToEnd(i);};this.moveFacetFilterUpOrDown=function(i,A){return l.moveUpOrDown(i,A);};this.createNavigationTargetWithId=function(i){return n.createElementWithProposedId(undefined,i).getId();};this.createNavigationTarget=function(){return n.createElement().getId();};this.removeNavigationTarget=function(i){var A=n.getElement(i);if(!A){return;}n.removeElement(i);if(A.isStepSpecific()){var B=this.getStepsAssignedToNavigationTarget(i);var C,S;for(C=0;C<B.length;C++){S=this.getStep(B[C]);S.removeNavigationTarget(i);}}};this.getNavigationTarget=n.getElement;this.getNavigationTargets=n.getElements;this.copyNavigationTarget=function(i){var A=n.copyElement(i);var B=n.getElement(A);if(B.isStepSpecific()){var C=this.getStepsAssignedToNavigationTarget(i);var D,S;for(D=0;D<C.length;D++){S=this.getStep(C[D]);S.addNavigationTarget(A);}}return A;};this.moveNavigationTargetBefore=function(i,A){return n.moveBefore(i,A);};this.moveNavigationTargetToEnd=function(i){return n.moveToEnd(i);};this.moveNavigationTargetUpOrDown=function(i,A){return n.moveUpOrDown(i,A);};this.createStepWithId=function(i){return s.createElementWithProposedId(undefined,i).getId();};this.createStep=function(i){if(!this.getCategory(i)){return;}var A=s.createElement().getId();this.addCategoryStepAssignment(i,A);return A;};this.createHierarchicalStepWithId=function(i){return s.createElementWithProposedId(undefined,i,a.constructors.HierarchicalStep).getId();};this.createHierarchicalStep=function(i){if(!this.getCategory(i)){return;}var A=s.createElement(undefined,a.constructors.HierarchicalStep).getId();this.addCategoryStepAssignment(i,A);return A;};this.getStep=s.getElement;this.getSteps=s.getElements;this.getStepsNotAssignedToCategory=function(i){var A=this.getCategoryStepAssignments(i);var B=[];t.getSteps().forEach(function(C){var D=C.getId();if(A.indexOf(D)===-1){B.push(D);}});return B;};this.copyStep=function(i){var A=_(i);var B=this.getCategoriesForStep(i);if(!A){return false;}if(B){B.forEach(function(C){t.addCategoryStepAssignment(C,A);});}return A;};function _(i,A){if(A&&!t.getCategory(A)){return false;}var B=s.copyElement(i);if(!B){return false;}if(A){t.addCategoryStepAssignment(A,B);}return B;}this.getCategoriesForStep=function C(i){var A=[];var B=t.getCategories();if(B){B.forEach(function(D){var E=D.getId();var F=t.getCategoryStepAssignments(E);if(F&&F.indexOf(i)>-1){A.push(E);}});}return A;};this.getAssignableStepsForNavigationTarget=function(i){var A=[];t.getSteps().forEach(function(B){var C=false;B.getNavigationTargets().forEach(function(D){if(i===D){C=true;}});if(!C){A.push(B.getId());}});return A;};this.getStepsAssignedToNavigationTarget=function(i){var A=[];t.getSteps().forEach(function(B){var C=false;B.getNavigationTargets().forEach(function(D){if(i===D){C=true;}});if(C){A.push(B.getId());}});return A;};this.copy=function(i){var A={stepContainer:s,categoryContainer:k,facetFilterContainer:l,navigationTargetContainer:n,categoryStepAssignmentContainer:o,applicationTitle:e,serviceList:r,filterOption:f};var d=sap.apf.modeler.core.ConfigurationObjects.deepDataCopy(A);if(f.smartFilterBar===true&&v){d.smartFilterBar=B();}return new sap.apf.modeler.core.ConfigurationEditor(i,a,undefined,d);function B(){var C=new a.constructors.SmartFilterBar(v.getId());C.setService(v.getService());C.setEntitySet(v.getEntitySet(),!v.isEntityTypeConverted());return C;}};if(typeof c==='string'){if(c.indexOf("apf1972-")===0){j=false;if(b){b(t,undefined);}}else if(!d){z(c,p,function(i,A){if(!A){var B=JSON.parse(i.SerializedAnalyticalConfiguration);t.setApplicationTitle(B.applicationTitle);x.loadConfig(B,true);w.mapToDesignTimeAsPromise(x.getRegistry(),t).then(function(){j=true;b(t,undefined);});}else{b(undefined,A);}});}}else{x.loadConfig(c.content,true);w.mapToDesignTimeAsPromise(x.getRegistry(),this).then(function(){if(b){b(t,undefined);}});}function z(i,A,b){A.readEntity("configuration",function(B,C,D){b(B,D);},[{name:"AnalyticalConfiguration",value:i}],undefined,g.getApplicationId());}};});
