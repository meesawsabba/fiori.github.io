/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2017 SAP SE. All rights reserved
 */
sap.ui.define(['sap/ui/core/util/MockServer','sap/apf/utils/utils','sap/base/Log','sap/ui/util/Storage',"sap/ui/thirdparty/jquery",'sap/apf/utils/parseTextPropertyFile'],function(U,A,L,S,q){'use strict';var S=new S();return c;function c(b){var m=[];var l=S;var s={setupConstants:function(_){this.constants={LOCAL_STORAGE_CONFIGURATION:"ApfConfiguration",LOCAL_STORAGE_TEXTS:"ApfTexts",CONFIGURATION_ENTITYSET:"AnalyticalConfigurationQueryResults",TEXTS_ENTITYSET:"TextElementQueryResults",RUNTIME_DATA_PATH:_+"model/apf/",RUNTIME_SERVICE_URL:"/sap/hba/r/apf/core/odata/apf.xsodata/",RUNTIME_SERVICE_METADATA:_+"model/apf/AnalysisPath.xml",PATH_ENTITYSET:"AnalysisPathQueryResults",MODELER_DATA_PATH:_+"model/apf/",CONFIGURATION_SERVICE:"/sap/hba/r/apf/core/odata/modeler/AnalyticalConfiguration.xsodata/",CONFIGURATION_SERVICE_METADATA:_+"model/apf/AnalyticalConfiguration.xml",DEMOKIT_SERVICE_URL:"/tmp/demokit/demokit.xsodata/",DEMOKIT_METADATA:_+"model/data/Demokit.xml",DEMOKIT_DATA_PATH:_+"model/data/",DEMOKIT_HIERARCHY_SERVICE_URL:"/tmp/demokit/hierarchy.xsodata/",DEMOKIT_HIERARCHY_METADATA:_+"model/data/hierarchyMetadata.xml",HIERARCHY_SERVICE_SPEC:{levelProperty:"Customer_Level",hierarchyNode:"Customer_NodeID",parentNode:"Customer_ParentID",measureName:"Revenue"}};},teardownMockserver:function(){m.forEach(function(_){_.stop();_.destroy();});},_getStorage:function(){return l;},getConfigurationId:function(n){var i;var a=n.indexOf(s.constants.LOCAL_STORAGE_CONFIGURATION);if(a!==-1){i=n.slice(a+s.constants.LOCAL_STORAGE_CONFIGURATION.length);}return i;},getAllConfigurationIdsInStorage:function(){var i=[];Object.keys(sessionStorage).forEach(function(n){var a=s.getConfigurationId(n);if(a){i.push(a);}});return i;},getConfigurationFromLocalStorage:function(a){return l.get(s.constants.LOCAL_STORAGE_CONFIGURATION+a);},idIsContained:function(e,i){return e.reduce(function(a,C){return a||C.AnalyticalConfiguration===i;},false);},importTextsFromFile:function(f,a,o){o=o||function(){};q.ajax({url:f,method:"GET",dataType:"text"}).done(function(d){var t=sap.apf.utils.parseTextPropertyFile(d,{instances:{messageHandler:function(){}}});var e=[];t.TextElements.forEach(function(i){e.push(i);});a.setEntitySetData(s.constants.TEXTS_ENTITYSET,e);o(e);}).fail(function(j,t,e){var d="while importing \""+f+"\" jQuery.ajax fails with "+t+",  "+e;L.error(e);o({errorText:d,filePath:f});});},mockDemokitService:function(){var a=new sap.ui.core.util.MockServer({rootUri:s.constants.DEMOKIT_SERVICE_URL});a.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.GET,s._postProcessDemokitData);a.simulate(s.constants.DEMOKIT_METADATA,s.constants.DEMOKIT_DATA_PATH);a.start();m.push(a);return a;},_loadAnalyticalConfiguration:function(r){function a(C){var d=C.AnalyticalConfiguration;C.SerializedAnalyticalConfiguration=s.getConfigurationFromLocalStorage(d);C.AnalyticalConfigurationName=JSON.parse(C.SerializedAnalyticalConfiguration).analyticalConfigurationName;}var C=r.mParameters.oEntry;if(C){if(C.SerializedAnalyticalConfiguration&&C.AnalyticalConfigurationName){a(C);}}else if(Array.isArray(r.mParameters.oFilteredData.results)){var e=r.mParameters.oFilteredData.results;e.forEach(function(C){a(C);});}},_initialLoadConfigurationsToMockServer:function(a,d){function i(_,g){for(var h in _){if(_.hasOwnProperty(h)){g(_[h]);}}}var r=[];s.getAllConfigurationIdsInStorage().forEach(function(g){var h=s.getConfigurationFromLocalStorage(g);var C=JSON.parse(h);f(C);});i(d,f);i(d,e);a.setEntitySetData("AnalyticalConfigurationQueryResults",r);function e(C){var g=C.configHeader.AnalyticalConfiguration;if(!s.getConfigurationFromLocalStorage(g)){var h=JSON.stringify(C);l.put(s.constants.LOCAL_STORAGE_CONFIGURATION+g,h);}}function f(C){var g=C.configHeader.AnalyticalConfiguration;if(s.idIsContained(r,g)){return;}var h=JSON.stringify(C);var j={AnalyticalConfiguration:g,Application:C.configHeader.Application,AnalyticalConfigurationName:C.configHeader.AnalyticalConfigurationName,SerializedAnalyticalConfiguration:h,CreationUTCDateTime:"/Date(1478533989544)/",LastChangeUTCDateTime:"/Date(1478533989544)/",CreatedByUser:"demokit engine",LastChangedByUser:null};r.push(j);}},savePath:function(r){var B=r.mParameters.oXhr.requestBody;var o=JSON.parse(B);if(!o.AnalysisPath){o.AnalysisPath=sap.apf.utils.createPseudoGuid();}if(!o.CreationUTCDateTime){o.CreationUTCDateTime="/Date("+new Date().getTime()+")/";}if(!o.LastChangeUTCDateTime){o.LastChangeUTCDateTime="/Date("+new Date().getTime()+")/";}r.mParameters.oXhr.requestBody=JSON.stringify(o);},mockRuntimeService:function(a){var d=new U({rootUri:s.constants.RUNTIME_SERVICE_URL});d.attachBefore(sap.ui.core.util.MockServer.HTTPMETHOD.PUT,s.savePath,s.constants.PATH_ENTITYSET);d.attachBefore(sap.ui.core.util.MockServer.HTTPMETHOD.POST,s.savePath,s.constants.PATH_ENTITYSET);d.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.GET,s._loadAnalyticalConfiguration,s.constants.CONFIGURATION_ENTITYSET);d.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.GET,s.loadTexts,s.constants.TEXTS_ENTITYSET);d.simulate(s.constants.RUNTIME_SERVICE_METADATA,s.constants.RUNTIME_DATA_PATH);m.push(d);d.start();s._initialLoadConfigurationsToMockServer(d,a);return d;},mockConfigurationService:function(a){var d=new U({rootUri:s.constants.CONFIGURATION_SERVICE});d.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.GET,s._loadAnalyticalConfiguration,s.constants.CONFIGURATION_ENTITYSET);d.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.PUT,s.saveAnalyticalConfiguration.bind(null,"PUT"),s.constants.CONFIGURATION_ENTITYSET);d.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.POST,s.saveAnalyticalConfiguration.bind(null,"POST"),s.constants.CONFIGURATION_ENTITYSET);d.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.POST,s.saveText,s.constants.TEXTS_ENTITYSET);d.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.PUT,s.saveText,s.constants.TEXTS_ENTITYSET);d.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.GET,s.loadTexts,s.constants.TEXTS_ENTITYSET);d.simulate(s.constants.CONFIGURATION_SERVICE_METADATA,s.constants.MODELER_DATA_PATH);m.push(d);d.start();s._initialLoadConfigurationsToMockServer(d,a);return d;},saveAnalyticalConfiguration:function(a,r){var d=r.mParameters.oEntity.SerializedAnalyticalConfiguration;var C;var e=r.mParameters.oEntity.AnalyticalConfiguration;if(a==="POST"){e=sap.apf.utils.createPseudoGuid();r.mParameters.oEntity.AnalyticalConfiguration=e;C=JSON.parse(d);C.configHeader.AnalyticalConfiguration=e;d=JSON.stringify(C);r.mParameters.oEntity.SerializedAnalyticalConfiguration=d;}l.put(s.constants.LOCAL_STORAGE_CONFIGURATION+e,d);},saveText:function(r){r.mParameters.oEntity=r.mParameters.oEntity||{};if(!sap.apf.utils.isValidGuid(r.mParameters.oEntity.TextElement)){r.mParameters.oEntity.TextElement=sap.apf.utils.createPseudoGuid();}var t=l.get(s.constants.LOCAL_STORAGE_TEXTS);if(!t){t=[];}else{t=JSON.parse(t);}t.push({TextElement:r.mParameters.oEntity.TextElement,TextElementDescription:r.mParameters.oEntity.TextElementDescription,MaximumLength:r.mParameters.oEntity.MaximumLength,TextElementType:r.mParameters.oEntity.TextElementType});l.put(s.constants.LOCAL_STORAGE_TEXTS,JSON.stringify(t));},loadTexts:function(r){var t=l.get(s.constants.LOCAL_STORAGE_TEXTS);if(t){r.mParameters.oFilteredData=r.mParameters.oFilteredData||{};r.mParameters.oFilteredData.results=r.mParameters.oFilteredData.results||[];t=JSON.parse(t);t.forEach(function(a){r.mParameters.oFilteredData.results.push(a);});}},mockHierarchyService:function(){var h=q.sap.sjax({url:s.constants.DEMOKIT_DATA_PATH+"RevenueHryQueryResults.json",dataType:"json"}).data;var a=new sap.ui.core.util.MockServer({rootUri:s.constants.DEMOKIT_HIERARCHY_SERVICE_URL});a.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.GET,r);a.simulate(s.constants.DEMOKIT_HIERARCHY_METADATA,s.constants.DEMOKIT_DATA_PATH);a.start();m.push(a);return a;function r(t){var u;var v=t.getParameters().oFilteredData;var w=t.getParameters().oXhr.url;var x=w.indexOf("P_Currency")+14;var y=w.indexOf("%27",x);var z=w.slice(x,y);var B=o(JSON.parse(JSON.stringify(h)),"Currency",[z],true);B=o(B,"Country",i(w,"Country"),true);B=o(B,"Customer",i(w,"Customer"),true);u=B;var C=i(w,"Customer_NodeID");if(C.length>0){B=f(B,C);}var D=w.indexOf("Customer_ParentID%20eq")+28;if(D>=28){var E=w.indexOf("%27",D);var F=w.slice(D,E);B=o(B,"Customer_ParentID",[n(F)],false);}if(w.indexOf("Customer_Level%20eq%200")>-1){B=g(B);}j(B,u);p(B);B=d(B);e(B,w);var G=s._parseUrl(w);v.results=s._sortData(s._aggregateData(B),G.parameters.$orderby);}function d(t){var u=[];t.forEach(function(v){if(v.Revenue===undefined||v.Revenue>0){u.push(v);}});return u;}function g(t){var u=[];var v=[];t.forEach(function(w){v.push(w.Customer_NodeID);});t.forEach(function(w){if(v.indexOf(w.Customer_ParentID)===-1){u.push(w);}});return u;}function f(t,u){var v=[];var w=false;var x=[];u.forEach(function(z){x.push(n(z));});t.forEach(function(z){if(x.indexOf(z.Customer_NodeID)>-1){v.push(z);w=true;}});function y(z){if(x.indexOf(z.Customer_ParentID)>-1&&x.indexOf(z.Customer_NodeID)===-1){v.push(z);x.push(z.Customer_NodeID);w=true;}}while(w){w=false;t.forEach(y);}return v;}function e(t,u){u=n(u);var v=u.indexOf("$select");if(v>-1&&t.length>0){var w=u.indexOf("$",v+1);Object.keys(t[0]).forEach(function(x){if(x!=="__metadata"){var y=u.indexOf(x+"&",v);var z=u.indexOf(x+",",v);var B=y===-1?z:y;if(B<0||(w>-1&&B>w)){t.forEach(function(C){delete C[x];});}}});}}function i(u,t){var v=0;var w=[];w[v]=[];var x=u.indexOf(t+"%20eq%20%27")+t.length+11;while(x>=t.length+11){if(z&&z>-1&&z<x){v++;w[v]=[];}var y=u.indexOf("%27",x);w[v].push(u.slice(x,y));var z=u.indexOf("%20and%20",y);x=u.indexOf(t+"%20eq%20%27",y)+t.length+11;}if(v>0){var B=w[0];var C=[];w.forEach(function(D){B.forEach(function(E){if(D.indexOf(E)>=0){C.push(E);}});B=C;});return C;}return w[v];}function j(t,u){t.forEach(function(v){if(v.Revenue===null){v.Revenue=k(v,u);}});}function k(t,u){var v=t.Customer_NodeID;var w=0;u.forEach(function(x){if(x.Customer_ParentID===v){if(x.Revenue===null){w+=k(x,u);}else{w+=x.Revenue;}}});return w;}function n(t){return t.replace(new RegExp("%3a","g"),":").replace(new RegExp("%20","g")," ").replace(new RegExp("%2c","g"),",");}function o(t,u,v,E){if(v.length===0){return t;}var w=[];t.forEach(function(x){if((x[u]===null&&E)||v.indexOf(x[u])>=0){w.push(x);}});return w;}function p(t){t.forEach(function(u){u.__metadata={"id":"/tmp/demokit/hierarchy.xsodata/RevenueHryQueryResults('"+u.GenID+"')","type":"tmp.demokit.demokit.RevenueHryQueryResultsType","uri":"/tmp/demokit/hierarchy.xsodata/RevenueHryQueryResults('"+u.GenID+"')"};});}},_postProcessDemokitData:function(e){var x=e.getParameter("oXhr");var f=e.getParameter("oFilteredData");if(x&&f){var p=s._parseUrl(x.url);var a=p.couldParse&&(p.parameters.$top!==undefined||p.parameters.$skip!==undefined);if(a){var u=q.extend({},p.parameters);delete u.$top;delete u.$skip;var d=s._generateUrlString(p.path,u);var r=q.sap.sjax({url:d,dataType:"json"}).data.d;var $=p.parameters.$skip||0;var g=p.parameters.$top;var h;if(g){h=r.results.slice($,Number($)+Number(g));}else{h=r.results.slice($);}f.results=h;f.__count=r.__count;}else{f.results=s._attachGUIDs(s._sortData(s._aggregateData(f.results||[]),p.parameters.$orderby));f.__count=f.results.length;}}},_aggregateData:function(r){var a=["Revenue","ShippingCosts","Discount","NumberOfOrders"];var d=[];if(r.length>0){var h={};var p=Object.getOwnPropertyNames(r[0]);var e=[];var f=[];p.forEach(function(i){if(i!=="__metadata"){if(a.indexOf(i)>-1){f.push(i);}else{e.push(i);}}});if(f.length>0){r.forEach(function(i){var j="";var n=false;e.forEach(function(k){if(i[k]===null){n=true;}j=j+i[k];});if(n){return;}if(!h[j]){h[j]=q.extend(true,{},i);f.forEach(function(k){h[j][k]=Number(i[k]);});}else{f.forEach(function(k){h[j][k]=Number(h[j][k])+Number(i[k]);});}});d=q.map(h,function(v){return v;});if(d.length>0){return d;}}else if(e.length===1||e.length===2){var g=[];r.forEach(function(i){if(g&&Array.prototype.indexOf.call(g,i[e[0]])===-1){g.push(i[e[0]]);d.push(i);}});if(d.length>0){return d;}}}return r;},_sortData:function(a,$){var d=s._parseOrderBy($);if(d.length===0){return a;}var e=a.slice().sort(function(r,f){var g=d.filter(function(o){return r[o.attr]!==f[o.attr];})[0];if(!g){return 0;}if(r[g.attr]>f[g.attr]){return g.direction;}return-g.direction;});return e;},_parseOrderBy:function(o){if(typeof o!=="string"||o.trim()===""){return[];}var O=o.split(",").map(function(i){var I=i.trim().split("%20");if(I[1]&&I[1].toLowerCase().trim()==="desc"){return{attr:I[0].trim(),direction:-1};}return{attr:I[0].trim(),direction:1};});return O;},_parseUrl:function(u){if(typeof u!=="string"){return{couldParse:false};}var a=u.split("?");if(a.length<1||a.length>2){return{couldParse:false};}else if(a.length==1){return{couldParse:true,path:a[0],parameters:{}};}var p={};a[1].split("&").map(function(d){var e=d.split("=");var f=e[0];var r=e[1];return{lhs:f,rhs:r};}).forEach(function(d){p[d.lhs]=d.rhs;});return{couldParse:true,path:a[0],parameters:p};},_generateUrlString:function(p,a){var d=Object.keys(a).map(function(k){return k+"="+a[k];}).join("&");return p+"?"+d;},_attachGUIDs:function(r){return r.map(function(d){if(d.__metadata){var g="('"+sap.apf.utils.createPseudoGuid()+"')";var n=q.extend(true,{},d);n.__metadata.uri=d.__metadata.uri.replace("('undefined')",g);n.__metadata.id=d.__metadata.id.replace("('undefined')",g);return n;}return d;});}};s.setupConstants(b);return s;}});
