/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/base/Log","sap/ui/core/Core","sap/gantt/misc/Utility","sap/ui/core/format/DateFormat","sap/ui/core/Locale","sap/m/OverflowToolbar","sap/ui/core/theming/Parameters","sap/ui/Device","./CoordinateUtils","sap/gantt/misc/Format","sap/gantt/library"],function(q,L,C,U,D,d,O,P,e,f,F,g){"use strict";var o={};var h={};var m=false;var n=false;var G={SHAPE_ID_DATASET_KEY:"data-sap-gantt-shape-id",ROW_ID_DATASET_KEY:"data-sap-gantt-row-id",CONNECTABLE_DATASET_KEY:"data-sap-gantt-connectable",SELECT_FOR_DATASET_KEY:"sap-gantt-select-for",SHAPE_CONNECT_FOR_DATASET_KEY:"sap-gantt-shape-connect-for",SHAPE_CONNECT_INDICATOR_WIDTH:10,shapeElementById:function(s,a){var b=window.document.getElementById(a),S=b.querySelector("g.sapGanttChartShapes");var N=S.querySelectorAll("["+G.SHAPE_ID_DATASET_KEY+"='"+s+"']");var E=N[0];if(E){return q(E).control(0);}return null;},getValueX:function(s){var a;var p=s.getMetadata().getProperty("x");if(p){a=s.getProperty(p.name);if(a!==null&&a!==undefined){return a;}}var r=C.getConfiguration().getRTL(),t=r?(s.getEndTime()||s.getTime()):s.getTime();if(t){var S=this.isShapeLargerThanTotalHorizon(s);if(!r){t=S.startTime?S.startTime:t;}else{t=S.endTime?S.endTime:t;}a=s.getXByTime(t);}if(!q.isNumeric(a)){L.warning("couldn't convert timestamp to x with value: "+t);}return a;},getRowInstance:function(E,t){var r=q(E.target).closest("rect.sapGanttBackgroundSVGRow").data("sapUiIndex");if(r!=null){return t.getRows()[r];}},getRowInstancefromShape:function(s){var r=s.getParentRowSettings();if(r!=null){return r.getParentRow();}},_get2dContext:function(i,s){if(!o.context){o.context=document.createElement('canvas').getContext("2d");}if(o.fontSize!==i||o.fontFamily!==s){o.context.font=i+"px "+s;o.fontSize=i;o.fontFamily=s;}return o.context;},getShapeTextWidth:function(t,i,s){return this._get2dContext(i,s).measureText(t).width;},getSelectedTableRowSettings:function(t,s){var a=t.getRows(),i=t.getFirstVisibleRow();if(a.length===0){return null;}var b=a[0].getIndex();var I=s-i;if(b!==i){I+=Math.abs(b-i);}if(!a[I]){return null;}return a[I].getAggregation("_settings");},updateGanttRows:function(a,r,i){var b=a.getParent().getParent();var $=q(document.getElementById(b.getId()+"-svg")),c=$.find("rect.sapGanttBackgroundSVGRow");if(b.getEnableChartSelectionState()){c.eq(i).toggleClass("sapGanttBackgroundSVGRowSelected",!!r[i].selected);}if(b.getEnableChartHoverState()){c.eq(i).toggleClass("sapGanttBackgroundSVGRowHovered",!!r[i].hovered);}},getShapesWithUid:function(c,s){var E=function(S){var p=U.parseUid(S),a=p.shapeId;var b=["[id='",c,"']"," ["+G.SHAPE_ID_DATASET_KEY+"='",a,"']"].join("");return q(b).control().filter(function(i){return i.getShapeUid()===S;})[0];};return s.map(E);},getShapeByShapeId:function(c,s){var E=[];s.forEach(function(S){var a=["[id='",c,"']"," ["+G.SHAPE_ID_DATASET_KEY+"='",S,"']"].join("");var b=document.querySelector(a);if(b){var i=sap.ui.getCore().byId(b.id);E.push(i);}});return E;},getShapesInRowsById:function(s,r){var S=document.getElementById(s);var a=[];r.forEach(function(R){var b=S.querySelector("[data-sap-gantt-row-id='"+R+"']");if(b){a=Array.from(b.children).filter(function(c){return c.id!=="";}).reduce(function(c,i){return c.concat(sap.ui.getCore().byId(i.id));},a);}});return a;},getShapeIdFromShapeUid:function(S){return S.map(function(s){var p=U.parseUid(s);return p.shapeId;});},getTimeFormaterBySmallInterval:function(a){var A=a.getAxisTimeStrategy(),s=A.getTimeLineOption().smallInterval,u=s.unit;var c=A.getCalendarType(),b=A.getLocale()?A.getLocale():new d(C.getConfiguration().getLanguage().toLowerCase());var i="yyyyMMMddhhms";if(!(u===sap.gantt.config.TimeUnit.minute||u===sap.gantt.config.TimeUnit.hour)){i="yyyyMMMdd";}return D.getDateTimeInstance({format:i,style:s.style,calendarType:c},s.locale?new d(s.locale):b);},resetStrokeDasharray:function(a){var s=a.getSimpleAdhocLines().find(function(x){return x._getSelected();});if(s){s._setSelected(false);var b=document.getElementById(s._getHeaderLine().sId);var c=document.getElementById(s._getLine().sId);var i=document.getElementById(s._getMarker().getId());i.style.cursor="pointer";if(c&&b){c.style.strokeDasharray=s.getStrokeDasharray();b.style.strokeDasharray=s.getStrokeDasharray();c.style.strokeWidth=s._getStrokeWidth();b.style.strokeWidth=s._getStrokeWidth();}}var S=a.getDeltaLines().find(function(x){return x._getIsSelected();});if(S){var j=S._getChartDeltaArea();if(j){var $=document.getElementById(j.sId);if(S._getEnableChartDeltaAreaHighlight()===true){$.style.opacity=0.0;}}var k=document.getElementById(S._getStartLine().sId);var E=document.getElementById(S._getEndLine().sId);var H=document.getElementById(S._getHeaderStartLine().sId);var l=document.getElementById(S._getHeaderEndLine().sId);var p=document.getElementById(S._getForwardMarker().sId);var B=document.getElementById(S._getBackwardMarker().sId);var r=document.getElementById(S._getHeaderDeltaArea().sId);var t=P.get("sapUiChartDataPointBorderColor");k.style.strokeDasharray=S.getStrokeDasharray();E.style.strokeDasharray=S.getStrokeDasharray();H.style.strokeDasharray=S.getStrokeDasharray();l.style.strokeDasharray=S.getStrokeDasharray();k.style.strokeWidth=S._getStrokeWidth();E.style.strokeWidth=S._getStrokeWidth();H.style.strokeWidth=S._getStrokeWidth();l.style.strokeWidth=S._getStrokeWidth();p.style.fillOpacity=0;B.style.fillOpacity=0;r.style.opacity=1;r.style.cursor="pointer";p.style.stroke=null;B.style.stroke=null;if(S._getVisibleMarker()===true){p.style.fillOpacity=1;B.style.fillOpacity=1;p.style.stroke=t;B.style.stroke=t;}var R=a._getResizeExtension();R.clearAllDeltaOutline();S._setIsSelected(false);}},adhocLinesPresentAndEnabled:function(a){return a.getSimpleAdhocLines().filter(function(A){return A.MarkerType!=sap.gantt.simple.MarkerType.None;}).length>0&&a.getEnableAdhocLine();},addToolbarToTable:function(s,t,i){if(i){if(t.getExtension().length==0){var a=new O();a.addContent(s.oExportTableToExcelButton);t.addExtension(a);}else{t.getExtension()[0].addContent(s.oExportTableToExcelButton);}}},findSpaceInLevel:function(l,s,a,b){for(var j=0;j<h[l].length;j++){if(n){return;}if(h[l].length>1){if(j===0&&s[b]()<h[l][j][a]()){h[l].push(s);m=true;}else if(h[l][j+1]!==undefined&&s[a]()>h[l][j][b]()&&s[b]()<h[l][j+1][a]()){h[l].push(s);m=true;}else if(j===h[l].length-1&&s[a]()>h[l][j][b]()){h[l].push(s);m=true;}else if(s[a]().getTime()===h[l][j][a]().getTime()&&s[b]().getTime()===h[l][j][b]().getTime()){if(parseInt(l,10)===Object.keys(h).length-1){h[parseInt(l,10)+1]=[s];m=true;}else{m=false;}}else{if(j===h[l].length-1&&parseInt(l,10)===Object.keys(h).length-1){h[parseInt(l,10)+1]=[s];m=true;}else{m=false;}}}else{if(s[a]()>h[l][j][b]()||s[b]()<h[l][j][a]()){h[l].push(s);m=true;}else if(s[a]().getTime()===h[l][j][a]().getTime()&&s[b]().getTime()===h[l][j][b]().getTime()){if(parseInt(l,10)===Object.keys(h).length-1){h[parseInt(l,10)+1]=[s];m=true;}else{m=false;}}else{if(parseInt(l,10)===Object.keys(h).length-1){h[parseInt(l,10)+1]=[s];m=true;}else{m=false;}}}if(m){j=h[l].length;n=true;h=this.sortShapesByTime(h,l,a);}}},sortShapesByTime:function(s,l,a){var b=s[l].length;var c;do{c=false;for(var i=0;i<b;i++){if(s[l][i+1]!==undefined){if(s[l][i][a]()>s[l][i+1][a]()){var t=s[l][i];s[l][i]=s[l][i+1];s[l][i+1]=t;c=true;}}}}while(c);return s;},_partitionShapesIntoOverlappingRanges:function(s,a,b){h={};var c="get"+a.charAt(0).toUpperCase()+a.slice(1);var j="get"+b.charAt(0).toUpperCase()+b.slice(1);if(s.length>0){h[0]=[s[0]];}for(var i=1,l=s.length;i<l;i++){n=false;for(var k in h){this.findSpaceInLevel(k,s[i],c,j);}}return h;},calculateLevelForShapes:function(a,s,b){var c=function(j){return j.reduce(function(k,t){return k.concat(Array.isArray(t)?c(t):t);},[]);};var r=this._partitionShapesIntoOverlappingRanges(a,s,b);var M=0;var R=Object.values(r).map(function(j,k){j.map(function(l){var p=k+1;if(l._setLevel){l._setLevel(p);}l._level=p;if(M<p){M=p;}return l;});return j;});var S=c(R);var i={shapes:S,maxLevel:M};return i;},_partitionLinesIntoOverlappingRanges:function(c){c.sort(function(a,b){if(a.getTimeStamp()<b.getTimeStamp()){return-1;}if(a.getTimeStamp()>b.getTimeStamp()){return 1;}return 0;});var j=function(k){if(k.length==0){return false;}k.sort(function(a,b){var M;if(a instanceof sap.gantt.simple.AdhocLine){M=a.getTimeStamp();}else{M=a.getEndTimeStamp();}var N;if(b instanceof sap.gantt.simple.AdhocLine){N=b.getTimeStamp();}else{N=b.getEndTimeStamp();}if(M<N){return 1;}if(M>N){return-1;}return 0;});if(k[0]instanceof sap.gantt.simple.AdhocLine){return k[0].getTimeStamp();}else{return k[0].getEndTimeStamp();}};var r=[];var I=0;if(c.length>0){r[I]=[c[0]];}for(var i=1,l=c.length;i<l;i++){if(c[i].getTimeStamp()>=c[i-1].getTimeStamp()&&c[i].getTimeStamp()<j(r[I])){r[I].push(c[i]);}else{I++;r[I]=[c[i]];}}return r;},calculateLevelForMarkers:function(a,b){var c=function(k){return k.reduce(function(l,t){return l.concat(Array.isArray(t)?c(t):t);},[]);};var A=a.concat(b);var r=this._partitionLinesIntoOverlappingRanges(A);var M=0;var R=r.map(function(s){s.map(function(k,l){var p=l+1;k._setLevel(p);if(M<p){M=p;}return k;});return s;});var i=c(R);var j={adhocLines:i.filter(function(l){if(sap.gantt.simple.AdhocLine){return l instanceof sap.gantt.simple.AdhocLine;}}),deltaLines:i.filter(function(l){if(sap.gantt.simple.DeltaLine){return l instanceof sap.gantt.simple.DeltaLine;}}),maxLevel:M};return j;},getShapeSuccessors:function(s,a){var S=[];if(s.getEnableChainSelection()){var v=this._getVisibleRelationships(a);var A=v.filter(function(x){return x.getPredecessor()===s.getShapeId();});A.forEach(function(r){var b=r.getRelatedInRowShapes(a.getId());if(b.successor){S.push(b.successor);}});S=Array.from(new Set(S));}return S;},getShapePredeccessors:function(s,a){var S=[];if(s.getEnableChainSelection()){var v=this._getVisibleRelationships(a);var A=v.filter(function(x){return x.getSuccessor()===s.getShapeId();});A.forEach(function(r){var b=r.getRelatedInRowShapes(a.getId());if(b.predecessor){S.push(b.predecessor);}});S=Array.from(new Set(S));}return S;},selectAssociatedShapes:function(p,a){var s=p.shape;var b=a._getDragDropExtension();var N=!s.getSelected();if(b.shapeSelectedOnMouseDown&&!b.initiallySelected&&!a.getEnableSelectAndDrag()){N=b.shapeSelectedOnMouseDown;}var S=[s];if(s.getEnableChainSelection()){S=this._getShapesToSelect(s,a);S.forEach(function(c){this.oSelection.updateShape(c.getShapeUid(),{selected:N,ctrl:true,draggable:c.getDraggable(),time:c.getTime(),endTime:c.getEndTime()});}.bind(a));}return S;},_getShapesToSelect:function(s,a){var S=[s];var v=this._getVisibleRelationships(a);var A=v.filter(function(x){return x.getPredecessor()===s.getShapeId()||x.getSuccessor()===s.getShapeId();});A.forEach(function(r){var b=r.getRelatedInRowShapes(a.getId());if(b.predecessor&&b.predecessor.getSelectableInChainSelection()){S.push(b.predecessor);}if(b.successor&&b.successor.getSelectableInChainSelection()){S.push(b.successor);}});S=Array.from(new Set(S));return S;},_getVisibleRelationships:function(a){var r=[];a.getTable().getRows().forEach(function(b){var R=b.getAggregation('_settings').getRelationships();r=r.concat(R);});r=Array.from(new Set(r));return r;},rerenderAssociatedRelationships:function(a,s){var r=C.createRenderManager();var b=[];var v=this._getVisibleRelationships(a);v.forEach(function(x){if(x.getSuccessor()===s.getShapeId()||x.getPredecessor()===s.getShapeId()){b.push(x);}});b.forEach(function(R){R.renderElement(r,R,a.getId());});},getFilteredShapeType:function(s){s=Array.from(new Set(s));return s.filter(function(v){return v!=="None";});},getPathCorners:function(p,r){var t=p.replace(/([A-Z])/g,' $1');var R=[],b;var i=t.split(/[,\s]/).reduce(function(c,s){var a=s.match("([a-zA-Z])(.+)");if(a){c.push(a[1]);c.push(a[2]);}else{c.push(s);}return c;},[]);var S=i.reduce(function(S,a){if(parseFloat(a)==a&&S.length){S[S.length-1].push(a);}else{S.push([a]);}return S;},[]);function j(a,c,s){var Y=c.x-a.x;var Z=c.y-a.y;var $=Math.sqrt(Y*Y+Z*Z);return k(a,c,Math.min(1,s/$));}function k(a,c,s){return{x:a.x+(c.x-a.x)*s,y:a.y+(c.y-a.y)*s};}function A(s,a){if(s.length>2){s[s.length-2]=a.x;s[s.length-1]=a.y;}}function l(s){return{x:parseFloat(s[s.length-2]),y:parseFloat(s[s.length-1])};}if(S.length>1){var u=l(S[0]),v=null;if(S[S.length-1][0]=="Z"&&S[0].length>2){v=["L",u.x,u.y];S[S.length-1]=v;}R.push(S[0]);for(var w=1;w<S.length;w++){var x=R[R.length-1],y=S[w],N=y==v?S[1]:S[w+1],z=r;if(N&&x&&x.length>2&&y[0]=="L"&&N.length>2&&N[0]=="L"){var B=l(x),E=l(y),H=l(N),I,J,K=Math.abs(B.x-E.x)+Math.abs(B.y-E.y),M=Math.abs(H.x-E.x)+Math.abs(H.y-E.y),Q=Math.max(Math.min(z,K,M/2),1);I=j(E,B,Q);J=j(E,H,Q);A(y,I);y.origPoint=E;R.push(y);var T=k(I,E,0.5),V=k(E,J,0.5),W=["C",T.x,T.y,V.x,V.y,J.x,J.y];W.origPoint=E;R.push(W);}else{R.push(y);}}if(v){var X=l(R[R.length-1]);R.push(["Z"]);A(R[0],X);}}else{R=S;}b=R.reduce(function(s,c){return s+c.join(" ")+" ";},"");return b;},arrayMove:function(a,b,c){if(c>=a.length){var k=c-a.length+1;while(k--){a.push(undefined);}}a.splice(c,0,a.splice(b,1)[0]);return a;},getEdgePoint:function(a){var b=2;var c=["Arrow","None"];var v=this._getVisibleRelationships(a);v.forEach(function(x){if(x.getPredecessor()!==undefined&&x.getSuccessor()!==undefined&&(x.getShapeTypeStart()!=="None"||c.indexOf(x.getShapeTypeEnd())==-1)||a.getRelationshipShapeSize()==sap.gantt.simple.relationshipShapeSize.Large){b=3;}});return b;},getTimeLabel:function(E,a,l,s){var p=f.getEventSVGPoint(s,E),t=F.dateToAbapTimestamp(a.viewToTime(p.x)),b=F._convertUTCToLocalTime(t,l),z=a.getZoomStrategy();return z.getLowerRowFormatter().format(b);},getVisibleElements:function(s,p,a){return Array.from(s.querySelectorAll(p)).reduce(function(b,i){return b.concat(Array.from(i.querySelectorAll(a)));},[]);},isShapeLargerThanTotalHorizon:function(s){var a=s.getGanttChartBase();var b=F.abapTimestampToDate(s.getTime()),c=F.abapTimestampToDate(s.getEndTime());if(a){var t=a.getAxisTimeStrategy().getTotalHorizon();var i=F.abapTimestampToDate(t.getStartTime());if(b<i){b=i;}var j=F.abapTimestampToDate(t.getEndTime());if(c>j){c=j;}}return{startTime:b,endTime:c};},isDynamicText:function(){var a=g.simple.horizontalTextAlignment;var b=false;var s=Array.from(document.querySelectorAll(".sapGanttChartSvg .sapGanttChartShapes .baseShapeSelection")).filter(function(i){if(!i.classList.contains("sapGanttTextNoPointerEvents")&&i.tagName!="text"){return i;}});s.forEach(function(H){var u=H.closest("[data-sap-ui]").getAttribute("data-sap-ui");var S=C.byId(u);if(!b){if(S instanceof sap.gantt.simple.BaseConditionalShape){if(S._getActiveShapeElement()instanceof sap.gantt.simple.BaseGroup){var A=S._getActiveShapeElement();A.getShapes().forEach(function(S){if(S.getHorizontalTextAlignment()===a.Dynamic){b=true;}});}else{if(S.getHorizontalTextAlignment()===a.Dynamic){b=true;}}}else if(S instanceof sap.gantt.simple.MultiActivityGroup){if(S.getTask().getHorizontalTextAlignment()===a.Dynamic){b=true;}}else if(S instanceof sap.gantt.simple.BaseGroup){S.getShapes().forEach(function(S){if(S.getHorizontalTextAlignment()===a.Dynamic){b=true;}});}else{if(S.getHorizontalTextAlignment()===a.Dynamic){b=true;}}}});if(!b){var c=Array.from(document.querySelectorAll(".sapGanttChartSvg .sapGanttChartCalendar .baseShapeSelection")).filter(function(i){if(!i.classList.contains("sapGanttTextNoPointerEvents")&&i.tagName!="text"){return i;}});c.forEach(function(H){if(!b){var u=H.closest("[data-sap-ui]").getAttribute("data-sap-ui");var i=C.byId(u);if(i.getHorizontalTextAlignment()===a.Dynamic){b=true;}}});}return b;}};return G;},true);
