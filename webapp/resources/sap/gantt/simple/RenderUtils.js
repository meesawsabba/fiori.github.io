/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["./BaseText","./AggregationUtils","./GanttUtils","sap/ui/core/Core","sap/gantt/library","sap/ui/Device","sap/gantt/misc/Utility","sap/gantt/misc/Format"],function(B,A,G,C,l,D,U,F){"use strict";var d=12;var h=l.simple.horizontalTextAlignment;var R={apiVersion:2,RENDER_EXTEND_FACTOR:0.382,getGanttRenderWidth:function(g){var v=jQuery(document.getElementById(g.getId()+"-gantt")).width();return v*(1+2*R.RENDER_EXTEND_FACTOR);},renderAttributes:function(r,e,a){var p=a.map(function(b){var P=b.split("-").reduce(function(c,n){return c+n.charAt(0).toUpperCase()+n.slice(1);},"get");return{name:b,value:e[P]()};});p.forEach(function(o){if(o.value||o.value===0){if(o.name==="style"){var s=o.value.split(";");s.forEach(function(S){S=S.trim();if(S!=""){var b=S.split(/:(.*)/);if(b[0]==="fill"&&(b[1].indexOf(" ")!=-1)){b[1]=encodeURI(b[1]);}r.style(b[0],b[1]);}});}else{r.attr(o.name,o.value);}}});},renderTooltip:function(r,e){if(e.getTooltip()){r.openStart("title").openEnd();r.text(e.getTooltip());r.close("title");}},updateShapeSelections:function(g,s,a){if(g._getResizeExtension==null){return;}var r=g._getResizeExtension();var b=g.getId();G.getShapesWithUid(b,a).forEach(function(e){if(e){if(e.isA("sap.gantt.simple.shapes.Shape")){e.setSelected(false);}else if(e.getParent().isA("sap.gantt.simple.BaseConditionalShape")){e.getParent().setProperty("selected",false,true);}else{e.setProperty("selected",false,true);}}});r.clearAllOutline(b);G.getShapesWithUid(b,s).forEach(function(e){if(e){if(e.getProperty("selectable")){if(e.isA("sap.gantt.simple.shapes.Shape")){e.setSelected(true);}else if(e.getParent().isA("sap.gantt.simple.BaseConditionalShape")){e.getParent().setProperty("selected",true,true);r.toggleOutline(e);}else{e.setProperty("selected",true,true);r.toggleOutline(e);}}g.getSelection().updateProperties(e.getShapeUid(),{draggable:e.getDraggable(),time:e.getTime(),endTime:e.getEndTime()});}});},updateShapeSelectionByShapeID:function(g,a){if(g._getResizeExtension==null){return;}var s=g.getSelection().getSelectedShapeIDS();var b=g.getSelection().getDeSelectedShapeIDS();var S=g.getSelection().getSelectedRowIDS();var c=g.getSelection().getDeSelectedRowIDS();if(s&&s.length>0){this._updateShapeSelection(g,s,true);}if(S&&S.length>0){this._updateRowSelection(g,S,true);}if(b&&b.length>0){this._updateShapeSelection(g,b,false);}if(c&&c.length>0){this._updateRowSelection(g,c,false,a);}},_updateShapeSelection:function(g,s,a){var b=g.getId();if(!a){s.forEach(function(i){g.oSelection.mSelected.deSelectShapeId[i]={selected:a};});}G.getShapeByShapeId(b,s).forEach(function(e){this._updateShapes(e,a,g);}.bind(this));},_updateRowSelection:function(g,s,a,b){var c=g.getId();var e=g.searchTxt;if(!a){e=g.deSelectTxt;}if(b){G.getShapesInRowsById(c,s).forEach(function(E){if(!a||E.getProperty("selectable")){if(E.mProperties.shapeId){g.getSelection().updateShapeId(E.getShapeId(),a);}this._updateShapes(E,a,g);}}.bind(this));}else if(e!==null&&e!==undefined){G.getShapesInRowsById(c,s).forEach(function(E){var i=this._selectShapeBySearchText(g,E,a);if(i&&(!a||E.getProperty("selectable"))){if(E.mProperties.shapeId){g.getSelection().updateShapeId(E.getShapeId(),a);}this._updateShapes(E,a,g);if(!a){g.getSelection().clearSelectionByUid(E.getShapeUid());}}}.bind(this));}},_updateShapes:function(e,s,g){e.setProperty("selected",s,true);if(s){g.getSelection().updateProperties(e.getShapeUid(),{draggable:e.getDraggable(),time:e.getTime(),endTime:e.getEndTime()},true);}else{g.getSelection().clearSelectionByUid(e.getShapeUid());}},_selectShapeBySearchText:function(g,s,a){var p=false;var m=g.getTable().getBindingInfo("rows").model;var b=g.searchProperty;if(!a){b=g.deSelectProperty;}function i(c){if(a){g.searchTxt.forEach(function(e){if(c!==undefined&&c!==null&&c.toString().toLowerCase().indexOf(e.toString().toLowerCase())!==-1){p=true;}});}else{if(c!==undefined&&c!==null&&c.toString().toLowerCase().indexOf(g.deSelectTxt.toString().toLowerCase())!==-1){p=true;}}}if(Array.isArray(b)&&b.length>0){b.forEach(function(b){if(p){return;}var v=s.getBindingContext(m).getProperty(b);i(v);});}else if(typeof b==="string"){var v=s.getBindingContext(m).getProperty(b);i(v);}else{var o=s.getBindingContext(m).getObject();if(o){Object.keys(o).forEach(function(c){if(p){return;}i(o[c]);});}}return p;},getShapeElementByTarget:function(t){return jQuery(this.getDraggableDOMElement(t)).control(0,true);},getDraggableDOMElement:function(t){return jQuery(t).closest("["+G.SHAPE_ID_DATASET_KEY+"]").get(0);},addTitleSpacing:function(t,r){if(t.titleSpacing){t.x=r?t.x-t.titleSpacing:t.x+t.titleSpacing;}},renderElementTitle:function(r,e){if(e.getShowTitle==null||!e.getShowTitle()){return;}var t=e.getTitle();if(t){var H=0,E=0,s=0;if(e.getWidth){E=e.getWidth();s=e.getWidth();}if(e.getHeadWidth){H=e.getHeadWidth();E-=H;}if(e.getTailWidth){E-=e.getTailWidth();}var c=2+H;var T={text:t,fill:e.getTitleColor()||"#000",showEllipsis:true,truncateWidth:E-e.getTitleSpacing(),textAnchor:e.getHorizontalTextAlignment().toLowerCase(),verticalTextAlignment:e.getVerticalTextAlignment(),fontFamily:e.getFontFamily()};var b=C.getConfiguration().getRTL();if(e.getTitleSpacing()){if(T.textAnchor===h.End.toLowerCase()){T.titleSpacing=-e.getTitleSpacing();}else{T.titleSpacing=e.getTitleSpacing();}}if(T.textAnchor===h.Start.toLowerCase()){T.x=b?e.getX()+e.getWidth()-c:e.getX()+c;this.setVerticalAlignment(e,T);}else if(T.textAnchor===h.End.toLowerCase()){T.x=b?e.getX()+c:e.getX()+e.getWidth()-c;this.setVerticalAlignment(e,T);}else if(T.textAnchor===h.Middle.toLowerCase()){T.x=e.getX()+e.getWidth()/2;this.setVerticalAlignment(e,T);}else if(T.textAnchor===h.Dynamic.toLowerCase()){this.renderDynamicText(e,T,c);this.setVerticalAlignment(e,T);}var m=U.getShapeBias(e);T.x=T.x+m.x;T.y=T.y+m.y;this.addTitleSpacing(T,b);var o=new B(T).addStyleClass("sapGanttTextNoPointerEvents");o.setProperty("childElement",true,true);o.renderElement(r,o);}},renderCalenderTitle:function(r,n,t){var T=n.title;var b=n.baseCalender;if(T){var e=0,s=0;if(t.width){e=t.width;s=t.width;}var m={text:T,fill:b.getTitleColor()||"#000",showEllipsis:true,truncateWidth:e-b.getTitleSpacing(),textAnchor:b.getHorizontalTextAlignment(),verticalTextAlignment:b.getVerticalTextAlignment(),fontFamily:b.getFontFamily()};var a=C.getConfiguration().getRTL();if(b.getTitleSpacing()){if(m.textAnchor.toLowerCase()===h.End.toLowerCase()){m.titleSpacing=-b.getTitleSpacing();}else{m.titleSpacing=b.getTitleSpacing();}}if(m.textAnchor.toLowerCase()===h.Start.toLowerCase()){m.x=a?t.x+t.width:t.x;}else if(m.textAnchor.toLowerCase()===h.End.toLowerCase()){m.x=a?t.x:t.x+t.width;}else if(m.textAnchor.toLowerCase()===h.Middle.toLowerCase()){m.x=t.x+t.width/2;}else if(m.textAnchor.toLowerCase()===h.Dynamic.toLowerCase()){this.renderDynamicText(b,m,0,t);}if(m.verticalTextAlignment==="Top"){m.y=(t.height/2)-1;}else if(m.verticalTextAlignment==="Bottom"){m.y=(t.height/2)+d-1;}else{m.y=(t.height/2)+(d/2)-1;}this.addTitleSpacing(m,a);var o=new B(m).addStyleClass("sapGanttTextNoPointerEvents");o.setProperty("childElement",true,true);o.renderElement(r,o);}},setVerticalAlignment:function(e,t){if(t.verticalTextAlignment==="Top"){t.y=e.getY()+d-1;}else if(t.verticalTextAlignment==="Bottom"){t.y=e.getY()+parseInt(e.getHeight(),10)-1;}else{t.y=e.getY()+(parseInt(e.getHeight()/2,10))+(d/2.5);}},renderDynamicText:function(e,t,c,a){var r=C.getConfiguration().getRTL();var v=F.abapTimestampToDate(e.getAxisTime()._oZoomStrategy.getVisibleHorizon().getStartTime());var x;if(a){t.x=r?a.x+a.width-c:a.x+c;x=t.x;if(a.x<e.getAxisTime().timeToView(v)&&(a.x+a.width)>e.getAxisTime().timeToView(v)){t.x=r?e.getAxisTime().timeToView(v)-c:e.getAxisTime().timeToView(v)+c;t._shapeCropped=true;t._xBiassed=t.x-x;}}else{t.x=r?e.getX()+e.getWidth()-c:e.getX()+c;x=t.x;if((e.getTime()<v)&&e.getEndTime()>v){t.x=r?e.getAxisTime().timeToView(v)-c:e.getAxisTime().timeToView(v)+c;t._shapeCropped=true;t._xBiassed=t.x-x;}}},renderInlineShapes:function(r,o,g){var t=o.getId()+"-top";var s=o.getId()+"-row";r.openStart("g",o);r.class(t);r.openEnd();r.openStart("g");r.attr(G.ROW_ID_DATASET_KEY,o.getRowId()||"");r.class(s);r.openEnd();this.renderMainRowAllShapes(r,o,g);r.close("g");r.close("g");},renderMainRowAllShapes:function(r,o,g){var a=g.getSyncedControl().getRowStates();var p=this.calcRowDomPosition(o,a),m=p.rowYCenter,i=p.rowHeight;var b=A.getAllNonLazyAggregations(o);var s=Object.keys(b).filter(function(n){return(n.indexOf("calendars")===-1)&&n!=="relationships";}).map(function(n){return o.getAggregation(n)||[];}.bind(o));var c=o.getRowUid(),S=g.oSelection,e=g._oExpandModel,f=g.getAxisTime(),H=e.isRowExpanded(c);s.forEach(function(j,I){j.forEach(function(k){if(g.isShapeVisible(k)){R.renderMainRowShape(r,k,{expandModel:e,selectionModel:S,axisTime:f,rowSetting:o,rowUid:c,rowExpanded:H,mainRowYCenter:m,rowHeight:i},g.getShowParentRowOnExpand());}});});},renderMainRowShape:function(r,s,o,S){this.setSpecialProperties(s,o);if((Object.keys(o.expandModel.mExpanded).indexOf(o.rowUid)==-1&&!o.rowExpanded)||S){s.renderElement(r,s,null);}if(o.rowExpanded){this.renderExpandShapesIfNecessary(r,s,o,S);}},setSpecialProperties:function(s,o){var e=o.expandModel,r=o.rowUid,S=o.rowSetting.getShapeUid(s),t=s.getParentRowSettings().getParent().getParent(),g=t.getParent();if(!s._iBaseRowHeight){s._iBaseRowHeight=o.rowHeight;var a=A.getNonLazyAggregations(s);Object.keys(a).filter(function(n){var b=a[n];if(b.appData!==null){return b.appData.sapGanttOrder===1;}}).map(function(n){if(n==="utilizationBar"||n==="utilizationLine"){s._iBaseRowHeight=s._iBaseRowHeight-1;}});}s.mAxisTime=o.axisTime;s.setProperty("shapeUid",S,true);if(s.getProperty("selectable")){s.setProperty("selected",o.selectionModel.existed(S),true);}s.setProperty("rowYCenter",e.getRowYCenterByUid(r,o.mainRowYCenter,s.getScheme(),0,g),true);},isValidD:function(s){return!!s&&s.indexOf("NaN")===-1&&s.indexOf("undefined")===-1&&s.indexOf("null")===-1;},renderExpandShapesIfNecessary:function(r,m,o,s){var a;var t=m.getParentRowSettings().getParent().getParent(),g=t.getParent();var f=function(j){if(!j||j.length===0){return;}var k=j;if(jQuery.isArray(j)===false){k=[j];}G.calculateLevelForShapes(k,"time","endTime");k.forEach(function(n,I){if(n._level){I=n._level-1;}var p=s?o.expandModel.getRowYCenterByUid(o.rowUid,null,n.getScheme(),I,g):o.expandModel.getRowYCenterByUid(o.rowUid,null,n.getScheme(),I,g)-o.expandModel.getBaseRowHeight();n.setProperty("rowYCenter",p,true);n._iBaseRowHeight=o.expandModel.getExpandShapeHeightByUid(o.rowUid,n.getScheme(),o.iRowHeight);n.setProperty("shapeUid",o.rowSetting.getShapeUid(n),true);n.renderElement(r,n);});};m._isSubTasks=m.mBindingInfos.hasOwnProperty("subTasks")||(typeof m.getSubTasks==="function"&&m.getSubTasks());if(m._isSubTasks){var e=m.getParent().getAllExpandableShapes();var S;var E;e.forEach(function(j,k){if(g.isShapeVisible(j)){a=k;}});var b=e[a];if(m===b){var c=[];e.forEach(function(M){var j=A.getLazyElementsByScheme(M,m.getParent().getParentGantt().getShapeSchemes()[1].getKey());j.forEach(function(k){if(k instanceof sap.gantt.simple.BaseConditionalShape){if(k._getActiveShapeElement()instanceof sap.gantt.simple.BaseGroup){S=null;E=null;k._getActiveShapeElement().getShapes().forEach(function(n){if(!S&&!E){S=n.getTime();E=n.getEndTime();}else{if(n.getTime()>=S){S=S;}else{S=n.getTime();}if(n.getEndTime()>=E){E=n.getEndTime();}else{E=E;}}});k._getActiveShapeElement().setTime(S);k._getActiveShapeElement().setEndTime(E);c=c.concat(k._getActiveShapeElement());}else{c=c.concat(k._getActiveShapeElement());}}else if(k instanceof sap.gantt.simple.BaseGroup){S=null;E=null;k.getShapes().forEach(function(n){if(!S&&!E){S=n.getTime();E=n.getEndTime();}else{if(n.getTime()>=S){S=S;}else{S=n.getTime();}if(n.getEndTime()>=E){E=n.getEndTime();}else{E=E;}}});k.setTime(S);k.setEndTime(E);c=c.concat(k);}else{c=c.concat(k);}});});f(c);}}else if(!m._isSubTasks){var i=A.getLazyAggregations(m);Object.keys(i).forEach(function(n){var j=m.getAggregation(n);f(j);});}},calcRowDomPosition:function(r,a){var o=r._getRow(),t=o.getParent(),i=t.indexOfRow(o);var b=a[i].height;var c=0;for(var I=0;I<=i;I++){c+=a[I].height;}c-=b/2;return{rowYCenter:c,rowHeight:b};},pushOrUnshift:function(a,i,u){if(u===true){a.splice(0,0,i);}else{a.push(i);}},createOrderedListOfRenderFunctionsFromTemplate:function(t){var o=[];for(var i=0;i<t.length;i++){this.pushOrUnshift(o,t[i].fnCallback,t[i].bUnshift);}return o;},renderElementAnimation:function(r,e){var a=e.getAnimationProperties(e.getAnimationSettings());if(a){r.openStart("animate");r.attr("attributeName","fill");r.attr("values",a.values);r.attr("dur",a.duration);r.attr("repeatCount",a.repeatCount);r.openEnd().close();}}};return R;},true);
