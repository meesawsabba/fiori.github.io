/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/Device","sap/ui/core/Core","sap/gantt/simple/BaseLine","sap/gantt/simple/RenderUtils","sap/gantt/simple/GanttExtension","sap/gantt/simple/Relationship","sap/gantt/misc/Format","sap/gantt/misc/Utility","sap/gantt/library","sap/m/Toolbar",'./GanttUtils',"./AdhocLineRenderer","sap/gantt/simple/DeltaLineRenderer","sap/gantt/simple/AggregationUtils"],function(D,C,B,R,G,a,F,U,l,T,b,A,c,e){"use strict";var I={apiVersion:2};var o=l.AdhocLineLayer;var f=l.DeltaLineLayer;I.render=function(r,d){var g=d.getParent(),t=g.getParent()._bToolbarSettingsItemChanged;if(t){g.getParent()._bToolbarSettingsItemChanged=false;g._getScrollExtension().needRerenderGantt(function(){this.renderImmediately(g);}.bind(this),'initialRender',t);}else{this.renderGanttChart(r,g);g.getSyncedControl().scrollContentIfNecessary();}};I.renderGanttChart=function(r,g){var _=C.getLibraryResourceBundle("sap.gantt");r.openStart("div",g.getId()+"-cnt");r.class("sapGanttChartCnt");r.style("height","100%");r.style("width","100%");r.attr("aria-label",_.getText("ARIA_GANTT_CHART"));r.openEnd();this.rerenderAllShapes(r,g);r.close("div");};I.renderImmediately=function(g){var r=C.createRenderManager();this.renderGanttChart(r,g);var d=window.document.getElementById(g.getId()+"-cnt");if(d){r.flush(d,true,false);}this.renderRelationships(r,g);g._updateShapeSelections(g.getSelectedShapeUid(),[]);G.attachEvents(g);r.destroy();};I.rerenderAllShapes=function(r,g){var d=g.getSyncedControl().getRowStates();if(d.length===0){return;}g.getAggregation("_header").renderElement();if(g._getScrollExtension&&g._getScrollExtension.mOffsetWidth){g._getScrollExtension().scrollGanttChartToVisibleHorizon();}var s=g.getSimpleAdhocLines().filter(function(m){return m.MarkerType!=sap.gantt.simple.MarkerType.None;});var h=g.getDeltaLines();if((s.length>0||h.length>0)&&g.getShowGanttHeader()){var t=g.getAggregation("table");b.addToolbarToTable(this,t,false);}var i=d.reduce(function(m,n){return m+n.height;},0);r.openStart("svg",g.getId()+"-svg");r.class("sapGanttChartSvg");r.attr("height",i+"px");var j=R.getGanttRenderWidth(g);r.attr("width",j+"px");r.openEnd();this.renderHelperDefs(r,g.getId(),g);if(g.getEnableDeltaLine()){this.renderChartAreaOfDeltaLines(r,g);}this.renderGanttBackgrounds(r,g,d);this.renderGanttRowBorders(r,g,d);this.renderCalendarPattern(r,g);this.renderCalendarShapes(r,g);this.renderExpandedRowBackground(r,g);this.renderVerticalLines(r,g);this.renderNowLineBody(r,g);var k=R.createOrderedListOfRenderFunctionsFromTemplate(this.createTemplateForOrderedListOfRenderFunctions(g));k.forEach(function(m){m.apply(I,[r,g]);});r.close("svg");if(!g._bPreventInitialRender){g._bPreventInitialRender=true;}};I.createTemplateForOrderedListOfRenderFunctions=function(g){var t=[{fnCallback:this.renderAllShapesInRows},{fnCallback:this.renderRlsContainer,bUnshift:g.getShapeOverRelationship()},{fnCallback:this.renderAssistedContainer}];if(g.getEnableAdhocLine()){t.push({fnCallback:this.renderAdhocLines,bUnshift:g.getAdhocLineLayer()===o.Bottom});}if(g.getEnableDeltaLine()){t.push({fnCallback:this.renderDeltaLines,bUnshift:g.getDeltaLineLayer()===f.Bottom});}return t;};I.renderHelperDefs=function(r,i,g){r.openStart("defs").openEnd();var L=i+"-helperDef-linePattern";r.openStart("pattern",L);r.attr("width",2);r.attr("height",2);r.attr("x",0);r.attr("y",0);r.attr("patternUnits","userSpaceOnUse");r.openEnd();r.openStart("line");r.attr("x1",1);r.attr("x2",1);r.attr("y1",0);r.attr("y2",2);r.attr("stroke-width",1);r.attr("stroke","white");r.attr("shape-rendering","crispEdges");r.openEnd();r.close("line");r.close("pattern");r.close("defs");if(g&&g.getSvgDefs()){r.unsafeHtml(g.getSvgDefs()._getDefString(g._bClonedGantt));}};I.renderGanttRowBorders=function(r,g,d){r.openStart("g",g.getId()+"-ganttRowBorder");r.openEnd();this.renderRowBorders(r,g,d);r.close("g");};I.renderGanttBackgrounds=function(r,g,d){r.openStart("g",g.getId()+"-bg");r.openEnd();this.renderRowBackgrounds(r,g,d);r.close("g");};I.renderRowBackgrounds=function(r,g,d){var n=0;var v=g.getTable().getVisibleRowCount();r.openStart("g",g.getId()+"-rowBackgrounds");r.class("rowBackgrounds");r.openEnd();d.forEach(function(i,j){r.openStart("rect",g.getId()+"-bgRow-"+j);r.attr("y",n);r.attr("width","100%");r.attr("height",i.height);r.attr("data-sap-ui-index",j);r.class("sapGanttBackgroundSVGRow");if(i.selected&&g.getEnableChartSelectionState()){r.class("sapGanttBackgroundSVGRowSelected");}if(i.hovered&&g.getEnableChartHoverState()){r.class("sapGanttBackgroundSVGRowHovered");}r.openEnd().close("rect");if(j<v){n+=i.height;}});r.close("g");if(g.getDisplayType()===l.simple.GanttChartWithTableDisplayType.Chart){document.getElementById(g.getId()+"-sapGanttBackgroundTableContent").style.height=n+"px";var s=document.getElementById(g.getId()+"-sapUiTableCnt");var h=document.getElementsByClassName("sapUiTableColHdrCnt");var t=s&&s.offsetTop;var H=h&&h[0].getBoundingClientRect().height;document.getElementById(g.getId()+"-ganttHeader").style.height=t+H+"px";}};I.renderRowBorders=function(r,g,d){r.openStart("g",g.getId()+"-rowBorders");r.class("rowBorders");r.openEnd();var n=0;d.forEach(function(h,i){var j=(n+h.height)-0.5;r.openStart("line",g.getId()+"-bgRowBorder-"+i);r.attr("x1",0);r.attr("x2","100%");r.attr("y1",j);r.attr("y2",j);r.style("pointer-events","none");r.class("sapGanttBackgroundSVGRowBorder");r.openEnd().close("line");n+=h.height;});r.close("g");};I.renderAdhocLines=function(r,g){var d=g.getSimpleAdhocLines();var t=g.getRenderedTimeRange(),m=t[0],M=t[1];d=d.filter(function(v){var j=F.abapTimestampToDate(v.getTimeStamp());return j>=m&&j<=M&&v.getProperty("visible");});var h=g.getAdhocLines();h=h.filter(function(v){var j=sap.gantt.misc.Format.abapTimestampToDate(v.getTimeStamp());return j>=m&&j<=M;});if(h.length===0&&d.length===0){return;}var i=g.getAxisTime();r.openStart("g");r.class("sapGanttChartAdhocLine");r.openEnd();d.forEach(function(j){A.renderLine(r,j,g);});h.map(function(j){var x=i.timeToView(F.abapTimestampToDate(j.getTimeStamp()));return new B({x1:x,y1:0,x2:x,y2:"100%",stroke:j.getStroke(),strokeWidth:j.getStrokeWidth(),strokeDasharray:j.getStrokeDasharray(),strokeOpacity:j.getStrokeOpacity(),tooltip:j.getDescription()}).setProperty("childElement",true);}).forEach(function(L){L.renderElement(r,L);});r.close("g");};I.renderDeltaLines=function(r,g){var d=g.getDeltaLines();d=d.filter(function(v){return v.getVisible();});if(d.length===0){return;}r.openStart("g");r.class("sapGanttChartDeltaLine");r.openEnd();d.forEach(function(h){c.renderDeltaLines(r,h,g);});r.close("g");};I.renderChartAreaOfDeltaLines=function(r,g){var d=g.getDeltaLines();d=d.filter(function(v){return v.getVisible();});if(d.length===0){return;}r.openStart("g");r.class("sapGanttChartAreaDeltaLine");r.openEnd();d.forEach(function(h){c.renderChartAreaOfDeltaLines(r,h,g);});r.close("g");};I.renderVerticalLines=function(r,g){if(g.getEnableVerticalLine()){var d=R.getGanttRenderWidth(g),h=jQuery(document.getElementById(g.getId())).height(),j=g.getAxisTime();var z=j.getZoomStrategy();var t=j.getTickTimeIntervalLabel(z.getTimeLineOption(),null,[0,d]);var k=t[1];var p="";for(var i=0;i<k.length;i++){p+=" M"+" "+(k[i].value-1/2)+" 0"+" v "+h;}if(p){r.openStart("path");r.class("sapGanttChartVerticalLine");r.attr("d",p);r.openEnd().close("path");}}};I.renderAssistedContainer=function(r,g){r.openStart("g");r.class("sapGanttChartSelection");r.openEnd().close("g");r.openStart("g");r.class("sapGanttChartShapeConnect");r.openEnd().close("g");r.openStart("g");r.class("sapGanttChartLasso");r.openEnd().close("g");};I.renderNowLineBody=function(r,g){var n=g.getAxisTime().getNowLabel(g.getNowLineInUTC())[0].value;if(g.getEnableNowLine()===false||isNaN(n)){return;}r.openStart("g");r.class("sapGanttNowLineBodySvgLine");r.openEnd();var s=new B({x1:n,y1:0,x2:n,y2:"100%",strokeWidth:1}).setProperty("childElement",true);s.renderElement(r,s);r.close("g");};I.renderRlsContainer=function(r,g){r.openStart("g");r.class("sapGanttChartRls");r.openEnd().close("g");};I.renderAllShapesInRows=function(r,g){if(!jQuery(document.getElementById(g.getId()+"-gantt"))){return;}r.openStart("g",g.getId()+"-shapes");r.class("sapGanttChartShapes");r.openEnd();this._eachVisibleRowSettings(g,function(d){d.renderElement(r,g);});r.close("g");};I._eachVisibleRowSettings=function(g,d){var h=g.getTable().getRows();var i=g.getTable().getBindingInfo("rows"),m=i&&i.model;for(var j=0;j<h.length;j++){var r=h[j];var k=r.getBindingContext(m);if(k&&r.getIndex()!==-1){var n=r.getAggregation("_settings");if(d){d(n);}}}};I.renderRelationships=function(r,g){var d=window.document.getElementById(g.getId()+"-svg");var h=jQuery(d).children("g.sapGanttChartRls").get(0);if(d==null||h==null){return;}var s=Object.create(null);this._eachVisibleRowSettings(g,this._renderVisibleRowRelationships.bind(this,r,g,s));this._renderNonVisibleRowRelationships(r,g,s);r.flush(h,true,false);};I._renderVisibleRowRelationships=function(r,g,s,d){d.getRelationships().forEach(function(h){var S=h.getShapeId();var i=d.getShapeUid(h);if(!s[S]){s[S]=true;h.setProperty("shapeUid",i,true);h.renderElement(r,h,g.getId());}});};I._renderNonVisibleRowRelationships=function(r,g,s){var d=U.safeCall(g,["getTable","getRowSettingsTemplate","getBindingInfo"],null,["relationships"]);if(!d){return;}var S=d.template.getBindingInfo("shapeId");if(!S){return;}var h=S.parts[0].path,m=g.getTable().getModel(d.model);var i=function(j,k){if(!s[j]){s[j]=true;var n=d.factory();n.setModel(m,d.model);n.bindObject({path:k,model:d.model});n.renderElement(r,n,g.getId());n.destroy();}};if(m.isA("sap.ui.model.json.JSONModel")){var E=m.mContexts;Object.keys(E).forEach(function(j){if(j.indexOf(d.path)>0){i(E[j].getProperty(h),j[0]==="/"?j:"/"+j);}});}else{var E=m.getProperty("/");Object.keys(E).forEach(function(j){if(j.startsWith(d.path)){i(E[j][h],j[0]==="/"?j:"/"+j);}});}};I.renderSvgDefs=function(r,g){var s=g.getSvgDefs();if(s){r.openStart("svg",g.getId()+"-svg-psdef");r.attr("aria-hidden","true");r.style("float","left");r.style("width","0px");r.style("height","0px");r.openEnd();r.unsafeHtml(s.getDefString());r.close("svg");}};I.renderCalendarPattern=function(r,g){if(g.getEnableNonWorkingTime()===false){return;}var p=g.getCalendarDef(),s=g.getId(),i=g.iGanttRenderedWidth;var d=g.getSyncedControl().getRowStates();if(p){var m=e.getAllNonLazyAggregations(p);var h=Object.keys(m).filter(function(n){return(n.indexOf("defs")===0);}).map(function(n){return p.getAggregation(n)||[];}.bind(p));h.forEach(function(j,k){if(j.length>0){var n=p.getDefNode(j);if(n&&n.defNodes&&i>0){var q=s+"-calendardefs-"+k;r.openStart("defs",q);r.openEnd();for(var t=0;t<n.defNodes.length;t++){var N=n.defNodes[t];r.openStart("pattern",N.id);r.class("calendarPattern");r.attr("patternUnits","userSpaceOnUse");r.attr("x",0);r.attr("y",0);r.attr("width",i);r.attr("height",d[0].height);r.openEnd();for(var u=0;u<N.timeIntervals.length;u++){var v=N.timeIntervals[u];v.height=d[0].height;r.openStart("rect");r.attr("x",v.x);r.attr("y",v.y);r.attr("width",v.width);r.attr("height",d[0].height);r.attr("fill",v.fill);r.openEnd().close("rect");if(N.title!==null){R.renderCalenderTitle(r,N,v);}}r.close("pattern");}r.close("defs");}}});}};I.renderCalendarShapes=function(r,g){r.openStart("g");r.class("sapGanttChartCalendar");r.openEnd();var d=g.getSyncedControl().getRowStates();this._eachVisibleRowSettings(g,function(h){var p=R.calcRowDomPosition(h,d);var m=e.getAllNonLazyAggregations(h);var i=Object.keys(m).filter(function(n){return(n.indexOf("calendars")===0);}).map(function(n){return h.getAggregation(n)||[];}.bind(h));i.forEach(function(j){j.forEach(function(k){k.setProperty("rowYCenter",p.rowYCenter,true);k._iBaseRowHeight=p.rowHeight;if(k.getVisible()){k.renderElement(r,k);}});});});r.close("g");};I.renderExpandedRowBackground=function(r,g){var h=g.getExpandedBackgroundData();if(jQuery.isEmptyObject(h)){return;}var i=g._oExpandModel.refreshRowYAxis(g.getTable());var E=Array.prototype.concat.apply([],h);var w=g.iGanttRenderedWidth;r.openStart("g");r.class("sapGanttChartRowBackground");r.openEnd();for(var j=0;j<E.length;j++){var d=E[j];var s;var k;if(g.getEnableExpandedRowBackground()===true){s="sapGanttExpandChartCntBG";}else{s="sapGanttExpandedRowBackground";}k=d.rowHeight;r.openStart("g");r.class("expandedRow");r.openEnd();var y;if(g.getShowParentRowOnExpand()){y=d.y;}else{y=d.y-(i);}r.openStart("rect");r.attr("x",d.x);r.attr("y",y);r.attr("height",k);r.attr("width","100%");r.class(s);r.openEnd();r.close("rect");r.openStart("path");if(g.getEnableExpandedRowBorders()===true){r.class("sapGanttExpandChartLine");}r.attr("d","M0 "+(y)+" H"+(w-1));r.openEnd().close("path");r.close("g");}r.close("g");};return I;},true);
