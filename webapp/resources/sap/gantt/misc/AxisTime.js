/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/base/util/ObjectPath","sap/ui/core/Core","sap/gantt/misc/Utility","sap/gantt/misc/Format"],function(O,C,U,F){"use strict";var c={};var A=function(t,v,z,a,b,l,Z){this.scale=d3.time.scale().domain(t).range(v).clamp(false);this.timeRange=t;this.viewRange=v;this.zoomRate=U.assign(z,1);this.zoomOrigin=U.assign(a,0);this.viewOffset=U.assign(b,0);this.locale=l;if(l&&l.getUtcdiff()){var f=F.getTimeStampFormatter();this.timeZoneOffset=Math.round((f.parse("20000101"+l.getUtcdiff()).getTime()-f.parse("20000101000000").getTime())/1000);if(l.getUtcsign()==="-"){this.timeZoneOffset=-this.timeZoneOffset;}}this._oZoomStrategy=Z;};A.prototype.CONSTANT={C_SEPARATOR:"_@@_",C_MESSAGE:{ARGUMENT_ERROR:"AxisOrdinal: Argument Error!"}};A.prototype.timeToView=function(t,i){if(C.getConfiguration().getRTL()!==true){return(this.scale(t)-this.zoomOrigin)*this.zoomRate-(i?0:this.viewOffset);}else{return this.viewRange[1]*this.zoomRate-(((this.scale(t)+this.zoomOrigin)*this.zoomRate)+(i?0:this.viewOffset));}};A.prototype.viewToTime=function(v,i){if(C.getConfiguration().getRTL()!==true){return this.scale.invert((v+(i?0:this.viewOffset))/this.zoomRate+this.zoomOrigin);}else{return this.scale.invert(this.viewRange[1]-(v+(i?0:this.viewOffset))/this.zoomRate-this.zoomOrigin);}};A.prototype.setTimeRange=function(t){this.timeRange=t;this.scale.domain(t);return this;};A.prototype.getTimeRange=function(){return this.scale.domain();};A.prototype.getTimeRangeSlice=function(s,e){var a=this.timeZoneOffset?d3.time.second.offset(this.viewToTime(s),this.timeZoneOffset):this.viewToTime(s);var b=this.timeZoneOffset?d3.time.second.offset(this.viewToTime(e),this.timeZoneOffset):this.viewToTime(e);if(C.getConfiguration().getRTL()!==true){return[a,b];}else{return[b,a];}};A.prototype.setViewRange=function(v){this.viewRange=v;this.scale.range(v);return this;};A.prototype.getViewRange=function(){var r=this.scale.range();return[Math.round((r[0]-this.zoomOrigin)*this.zoomRate-this.viewOffset),Math.round((r[1]-this.zoomOrigin)*this.zoomRate-this.viewOffset)];};A.prototype.getZoomStrategy=function(){return this._oZoomStrategy;};A.prototype.setZoomRate=function(z){this.zoomRate=U.assign(z,1);return this;};A.prototype.getZoomRate=function(){return this.zoomRate;};A.prototype.setZoomOrigin=function(z){this.zoomOrigin=U.assign(z,0);return this;};A.prototype.getZoomOrigin=function(){return this.zoomOrigin;};A.prototype.setViewOffset=function(v){this.viewOffset=U.assign(v,0);return this;};A.prototype.getViewOffset=function(){return this.viewOffset;};A.prototype.setLocale=function(l){this.locale=l;if(l&&l.getUtcdiff()){var f=F.getTimeStampFormatter();this.timeZoneOffset=Math.round((f.parse("20000101"+l.getUtcdiff()).getTime()-f.parse("20000101000000").getTime())/1000);if(l.getUtcsign()==="-"){this.timeZoneOffset=-this.timeZoneOffset;}}return this;};A.prototype.getLocale=function(){return this.locale;};A.prototype.clone=function(){return new A([new Date(this.timeRange[0].valueOf()),new Date(this.timeRange[1].valueOf())],this.viewRange.slice(0),this.zoomRate,this.zoomOrigin,this.viewOffset,this.locale,this._oZoomStrategy);};A.prototype._get2dContext=function(f,s){if(!c.context){c.context=document.createElement('canvas').getContext("2d");}if(c.fontSize!==f||c.fontFamily!==s){c.context.font=f+"px "+s;c.fontSize=f;c.fontFamily=s;}return c.context;};A.prototype._getShapeTextWidth=function(t,f,s){return this._get2dContext(f,s).measureText(t).width;};A.prototype.getCurrentTickTimeIntervalLevel=function(){var t=this._oZoomStrategy.getTimeLineOption(),T=this._oZoomStrategy.getTimeLineOptions(),i=0;for(var a in T){if(T[a]===t){return i;}i++;}};A.prototype.getCurrentTickTimeIntervalKey=function(){var t=this._oZoomStrategy.getTimeLineOption(),T=this._oZoomStrategy.getTimeLineOptions();for(var a in T){if(T[a]===t){return a;}}};A.prototype.getNowLabel=function(t){var d=new Date();if(t===undefined||t){d=new Date(d.getTime()+(d.getTimezoneOffset()*60000));}var v=this.timeToView(d);var l=d3.time.second.offset(d,this.timeZoneOffset);return[{"date":l,"value":Math.round(v)}];};A.prototype.getFirstSmallIntervalIndex=function(s,a){for(var i=0;i<s.length;i++){var d=F.dateToAbapTimestamp(s[i].date);if(d>=a){return i;}}};A.prototype.getTickTimeIntervalLabel=function(l,t,v){var i,p,a,b=null;if(this.locale&&this.locale.getDstHorizons().length>0){b=this.locale.getDstHorizons();}var f=F.getTimeStampFormatter();var e=[];if(b){for(i=0;i<b.length;i++){e[i]={};p=b[i].getStartTime();a=b[i].getEndTime();e[i].startDate=f.parse(p);e[i].endDate=f.parse(a);}}var g=this.timeZoneOffset?[d3.time.second.offset(this.timeRange[0],this.timeZoneOffset),d3.time.second.offset(this.timeRange[1],this.timeZoneOffset)]:this.timeRange;var h=new A(g,this.viewRange,this.zoomRate,this.zoomOrigin,this.viewOffset,null,this._oZoomStrategy);var j=null;var k=null;var m=null;var n=null;var o=null;var q=null;var r=null;var u=[];var w=[];var x=null;if(t){q=this.timeZoneOffset?d3.time.second.offset(t[0],this.timeZoneOffset):t[0];r=this.timeZoneOffset?d3.time.second.offset(t[1],this.timeZoneOffset):t[1];j=this.timeZoneOffset?[d3.time.second.offset(t[0],this.timeZoneOffset),d3.time.second.offset(t[1],this.timeZoneOffset)]:t;k=[this.timeToView(t[0]),this.timeToView(t[1])];if(e&&e.length){this._calculateTimeRange(e,q,r,u);}x=this._calculateScale(u,w,j,k,false);}else if(v){q=this.timeZoneOffset?d3.time.second.offset(this.viewToTime(v[0]),this.timeZoneOffset):this.viewToTime(v[0]);r=this.timeZoneOffset?d3.time.second.offset(this.viewToTime(v[1]),this.timeZoneOffset):this.viewToTime(v[1]);j=[q,r];k=v;if(e.length){this._calculateTimeRange(e,q,r,u);}x=this._calculateScale(u,w,j,k,false);}else{q=g[0];r=g[1];j=g;k=this.viewRange;if(e.length){this._calculateTimeRange(e,q,r,u);}x=this._calculateScale(u,w,j,k,g);}w=x.viewRangeSet;m=x.visibleScale;n=x.dstScale;o=x.normalScale;var y=[];var z,B,D,E;var G={unit:this._oZoomStrategy.getTimeLineOption().largeInterval.unit,span:this._oZoomStrategy.getTimeLineOption().largeInterval.span};var H={unit:this._oZoomStrategy.getTimeLineOption().smallInterval.unit,span:this._oZoomStrategy.getTimeLineOption().smallInterval.span};var I,J;if(G){var K=[];var L=[];var M=[];if(!(m instanceof Array)){K[0]=this._getTimeIntervalTicks(G,m);}else{for(I=0;I<n.length;I++){L[I]=n[I].ticks(O.get(G.unit).range,G.span);M[I]=o[I].ticks(O.get(G.unit).range,G.span);}for(I=0;I<m.length;I++){K[I]=m[I].ticks(O.get(G.unit).range,G.span);}}var N=[];if(K[0]!==null){for(I=0;I<K.length;I++){for(J=0;J<K[I].length;J++){z=K[I][J];D=h.timeToView(z);E=this._oZoomStrategy.getUpperRowFormatter().format(z);N.push({"date":z,"value":Math.round(D),"label":E});}}}if(L[0]!==null){for(I=0;I<L.length;I++){for(J=0;J<L[I].length;J++){z=L[I][J];B=M[I][J];D=h.timeToView(d3.time.second.offset(z.getTime(),-60*60));E=this._oZoomStrategy.getUpperRowFormatter().format(z);N.push({"date":z,"value":Math.round(D),"label":E});}}}y.push(N);}else{y.push([]);}if(H){var P=[];var Q=[];var R=[];if(!(m instanceof Array)){R[0]=this._getTimeIntervalTicks(H,m);}else{for(I=0;I<n.length;I++){P[I]=n[I].ticks(O.get(H.unit).range,H.span);Q[I]=o[I].ticks(O.get(H.unit).range,H.span);}for(I=0;I<m.length;I++){R[I]=m[I].ticks(O.get(H.unit).range,H.span);}}var S=[];if(R[0]){for(I=0;I<R.length;I++){for(J=0;J<R[I].length;J++){z=R[I][J];var T;var V=false;if(e.length){for(var d=0;d<e.length;d++){if(z.getTime()===e[d].startDate.getTime()){T=d3.time.second.offset(z.getTime(),60*60);if((J===R[I].length-1)&&this._oZoomStrategy.isLowerRowTickHourSensitive()){V=true;}}if((J===R[I].length-1)&&(z.getTime()===d3.time.second.offset(e[d].endDate.getTime(),60*60).getTime())){T=d3.time.second.offset(z.getTime(),-60*60);}}}D=h.timeToView(z);var W;if(V){break;}else if(T){W=this._oZoomStrategy.getUpperRowFormatter().format(T);E=this._oZoomStrategy.getLowerRowFormatter().format(T);T=null;}else{W=this._oZoomStrategy.getUpperRowFormatter().format(z);E=this._oZoomStrategy.getLowerRowFormatter().format(z);}S.push({"date":z,"value":Math.round(D),"label":E,"largeLabel":W});}}}if(P[0]){for(I=0;I<P.length;I++){for(J=0;J<P[I].length;J++){z=P[I][J];B=Q[I][J];var X;var Y=false;if((J===P[I].length-1)&&this._oZoomStrategy.isLowerRowTickHourSensitive()){if(u.length>0){for(var Z=0;Z<u.length;Z++){if((!u[Z].haveDST)&&(B.getTime()===u[Z].range[0].getTime())){Y=true;}}}}if(e.length){for(var s=0;s<e.length;s++){if(z.getTime()===e[s].startDate.getTime()){X=d3.time.second.offset(z.getTime(),60*60);}if((J===P[I].length-1)&&(z.getTime()===d3.time.second.offset(e[s].endDate.getTime(),60*60).getTime())){X=d3.time.second.offset(z.getTime(),-60*60);}}}if(!this._oZoomStrategy.isLowerRowTickHourSensitive()){D=h.timeToView(d3.time.second.offset(z.getTime(),-60*60));}else{D=h.timeToView(B);}if(Y){break;}else if(X){E=this._oZoomStrategy.getLowerRowFormatter().format(X);X=null;}else{E=this._oZoomStrategy.getLowerRowFormatter().format(z);}S.push({"date":z,"value":Math.round(D),"label":E});}}}y.push(S);}else{y.push([]);}var $=y[0];var _=y[1];var a1=this.getZoomStrategy().getVisibleHorizon().getStartTime();this.largeIntervalLabel=true;this.largeIntervalPath=false;var b1=this.getFirstSmallIntervalIndex(_,a1);var c1,d1,e1=30;var f1,g1,h1=0;var i1=C.getConfiguration().getRTL();if(_[b1]){var j1=_[b1].largeLabel;this.firstTickPosition=_[b1].value;var k1=false;var l1=document.querySelector(".sapGanttTimeHeaderSvgText")||document.querySelector(".sapGanttTimeHeaderSvgText0");if(l1){var m1=getComputedStyle(l1);f1=m1.fontSize;g1=m1.fontFamily;h1=Math.ceil(this._getShapeTextWidth(j1,f1,g1))+e1;}c1=i1?(this.firstTickPosition-h1):(this.firstTickPosition+h1);for(i=0;i<$.length;i++){h1=l1?Math.ceil(this._getShapeTextWidth($[i].label,f1,g1))+e1:0;d1=i1?($[i].value-h1):($[i].value+h1);var n1=i1?($[i].value<this.firstTickPosition&&$[i].value>=c1):($[i].value>this.firstTickPosition&&$[i].value<=c1);var o1=i1?(this.firstTickPosition<$[i].value&&this.firstTickPosition>=d1):(this.firstTickPosition>$[i].value&&this.firstTickPosition<=d1);var p1=$[i].label!==j1;if(n1||(o1&&p1)){this.largeIntervalLabel=false;break;}}if(this.largeIntervalLabel){for(i=0;i<$.length;i++){if($[i].label===j1){if($[i].value===this.firstTickPosition){this.largeIntervalPath=true;}$[i].value=this.firstTickPosition;k1=true;break;}}if(!k1){var q1={value:this.firstTickPosition,label:j1};y[0].push(q1);}}}return y;};A.prototype._getTimeIntervalTicks=function(t,v){if(t.unit!==sap.gantt.config.TimeUnit.week){return v.ticks(O.get(t.unit).range,t.span);}var w=["d3.time.sunday","d3.time.monday","d3.time.tuesday","d3.time.wednesday","d3.time.thursday","d3.time.friday","d3.time.saturday"];return v.ticks(O.get(w[this.getZoomStrategy().getFirstDayOfWeek()]).range,t.span);};A.prototype._calculateScale=function(a,v,b,d,l){var e=null;var f=[];var n=[];if(a.length){e=[];var g=0;var h=0;for(var t=0;t<a.length;t++){v[t]=[this.timeToView(a[t].range[0]),this.timeToView(a[t].range[1])];if(a[t].haveDST){f[g]=new A(a[t].dstRange,v[t],this.zoomRate,this.zoomOrigin,this.viewOffset,null,this._oZoomStrategy).scale;n[g]=new A(a[t].range,v[t],this.zoomRate,this.zoomOrigin,this.viewOffset,null,this._oZoomStrategy).scale;g++;}else{e[h]=new A(a[t].range,v[t],this.zoomRate,this.zoomOrigin,this.viewOffset,null,this._oZoomStrategy).scale;h++;}}}else if(l){e=new A(l,this.viewRange,this.zoomRate,this.zoomOrigin,this.viewOffset,null).scale;}else{e=new A(b,d,this.zoomRate,this.zoomOrigin,this.viewOffset,null,this._oZoomStrategy).scale;}var r={"viewRangeSet":v,"visibleScale":e,"dstScale":f,"normalScale":n};return r;};A.prototype._calculateTimeRange=function(d,s,e,a){if(d.length){var b=s;var f=e;var g=[];var h=[];var i,k;i=d[0].startDate;k=d[0].endDate;this._calculateRangeItem(i,k,b,f,g,h);if(d.length>1){for(var j=1;j<d.length;j++){if(g.length){var r=[];for(var l in g){r.push(g[l]);}g=[];for(var t=0;t<r.length;t++){i=d[j].startDate;k=d[j].endDate;b=r[t].range[0];f=r[t].range[1];this._calculateRangeItem(i,k,b,f,g,h);}}}}for(var m in h){a.push(h[m]);}for(var n in g){a.push(g[n]);}}};A.prototype._calculateRangeItem=function(d,a,s,e,t,b){var r=null;if(s<d){if(e<a){if(e>d){r={};r.haveDST=false;r.range=[s,d];t.push(r);r={};r.haveDST=true;r.range=[d,e];r.dstRange=[d3.time.second.offset(d.getTime(),60*60),d3.time.second.offset(e,60*60)];b.push(r);}else{r={};r.haveDST=false;r.range=[s,e];t.push(r);}}else{r={};r.haveDST=false;r.range=[s,d];t.push(r);r={};r.haveDST=true;r.range=[d,a];r.dstRange=[d3.time.second.offset(d.getTime(),60*60),d3.time.second.offset(a.getTime(),60*60)];b.push(r);r={};r.haveDST=false;r.range=[a,e];t.push(r);}}else if(s>=d){if(s<a){if(e<=a){r={};r.haveDST=true;r.range=[s,e];r.dstRange=[d3.time.second.offset(s,60*60),d3.time.second.offset(e,60*60)];b.push(r);}else{r={};r.haveDST=true;r.range=[s,a];r.dstRange=[d3.time.second.offset(s,60*60),d3.time.second.offset(a.getTime(),60*60)];b.push(r);r={};r.haveDST=false;r.range=[a,e];t.push(r);}}else{r={};r.haveDST=false;r.range=[s,e];t.push(r);}}};return A;},true);
