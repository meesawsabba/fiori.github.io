sap.ui.define(["sap/ovp/ui/DashboardLayoutRearrange","sap/ovp/ui/DashboardLayoutModel","sap/ovp/cards/CommonUtils","sap/ui/Device","sap/ui/thirdparty/jquery","sap/base/util/merge","sap/ovp/cards/ovpLogger","sap/ovp/cards/jUtils","sap/ovp/ui/cardPositionHelper"],function(R,D,C,a,q,m,o,u,c){"use strict";var l=new o("OVP.ui.DashboardLayoutUtil");var b=function(d){this.aCards=null;this.ROW_HEIGHT_PX=16;this.MIN_COL_WIDTH_PX=320;this.CARD_BORDER_PX=8;this.EXTRA_MARGIN=8;this.oLayoutData={layoutWidthPx:1680,contentWidthPx:1600,colCount:5,previousColCount:0,colWidthPx:this.MIN_COL_WIDTH_PX,rowHeightPx:this.ROW_HEIGHT_PX,marginPx:this.convertRemToPx(3)-this.CARD_BORDER_PX};this.dashboardLayoutModel=new D(d,this.oLayoutData.colCount,this.ROW_HEIGHT_PX,this.CARD_BORDER_PX);this.layoutDomId="";this.oLayoutCtrl={};this.componentDomId="";this.lastTriggeredColWidth=0.0;this.changedCards={};this.isRTLEnabled=sap.ui.getCore().getConfiguration().getRTL();switch(true){case a.browser.webkit:this.cssVendorTransition="-webkit-transition";this.cssVendorTransform="-webkit-transform";break;case a.browser.msie:this.cssVendorTransition="-ms-transition";this.cssVendorTransform="-ms-transform";break;case a.browser.mozilla:this.cssVendorTransition="-moz-transition";this.cssVendorTransform="-moz-transform";break;default:this.cssVendorTransition="transition";this.cssVendorTransform="transform";}};b.prototype.setLayout=function(d){this.oLayoutCtrl=d;this.layoutDomId=d.getId();var M=this.layoutDomId.indexOf("---")+3;var s=this.layoutDomId.substring(0,M);var e=this.layoutDomId.substring(M);this.componentDomId=s+e.split("--")[0];};b.prototype.getDashboardLayoutModel=function(){return this.dashboardLayoutModel;};b.prototype.updateCardVisibility=function(d){this.dashboardLayoutModel.updateCardVisibility(d);this.aCards=this.dashboardLayoutModel.getCards(this.oLayoutData.colCount);this.dashboardLayoutModel._removeSpaceBeforeCard();this._setCardsCssValues(this.aCards);this._positionCards(this.aCards);};b.prototype.updateLayoutData=function(d){var i=this.oLayoutData.marginPx,e=0,s=320,M=1024,f=this.CARD_BORDER_PX,g=this.EXTRA_MARGIN,n=d+i,h,j;this.oLayoutData.layoutWidthPx=d;if(n<=s){i=this.convertRemToPx(0.5)-f;e=a.system.desktop?16:0;}else if(n<=M){i=this.convertRemToPx(1)-f;e=a.system.desktop?8:0;}else{i=this.convertRemToPx(3)-f;}if(i!==this.oLayoutData.marginPx){this.oLayoutData.marginPx=i;q(".sapUshellEasyScanLayout").css({"margin-left":i+"px"});}this.oLayoutData.contentWidthPx=d-i-e;this.oLayoutData.previousColCount=this.oLayoutData.colCount;this.oLayoutData.colCount=Math.round(this.oLayoutData.contentWidthPx/this.MIN_COL_WIDTH_PX);if(this.oLayoutData.colCount===0){this.oLayoutData.colCount=1;}this.oLayoutData.colWidthPx=this.oLayoutData.contentWidthPx/this.oLayoutData.colCount;if(q(".sapOvpDashboardDragAndDrop").length>0&&q(".easyScanLayoutItemWrapper").length>0){h=q(".sapOvpDashboardDragAndDrop")[0].offsetLeft+g;if(q(".sapOvpDashboardDragAndDrop")[0].offsetLeft<40){j=h+8;}else{j=h;}}else{h=i+g;j=i+e+g;}q('.sapFDynamicPageTitle').css({"margin-left":h+"px","margin-right":j+"px","visibility":"visible"});q('.sapFDynamicPageHeader').css({"margin-left":h+"px","margin-right":j+"px"});return this.oLayoutData;};b.prototype.getRearrange=function(s){var d={containerSelector:".sapUshellEasyScanLayoutInner",wrapper:".sapUshellEasyScanLayout",draggableSelector:".easyScanLayoutItemWrapper",placeHolderClass:"dashboardLayoutItemWrapper-placeHolder",cloneClass:"easyScanLayoutItemWrapperClone",moveTolerance:10,switchModeDelay:500,isTouch:!a.system.desktop,debug:false,aCards:this.aCards,layoutUtil:this,rowHeight:this.oLayoutData.rowHeightPx,colWidth:this.oLayoutData.colWidthPx};return new R(m(d,s));};b.prototype.resizeLayout=function(w){var B=this.oLayoutData.colCount;var t=false;if(this.oLayoutData.layoutWidthPx!==w&&w!==0){this.updateLayoutData(w);t=Math.abs(this.lastTriggeredColWidth-this.oLayoutData.colWidthPx)>this.convertRemToPx(0.5);this.aCards=this.dashboardLayoutModel.getCards(this.oLayoutData.colCount);for(var i=0;i<this.aCards.length;i++){var d=this.aCards[i];this.setCardCssValues(d);var e=document.getElementById(this.getCardDomId(d.id));if(e){e.style.width=d.dashboardLayout.width;e.style.height=d.dashboardLayout.height;if(B!==this.oLayoutData.colCount){e.style[this.cssVendorTransition]='all 0.25s ease';}else{e.style[this.cssVendorTransition]='';}e.style[this.cssVendorTransform]='translate3d('+d.dashboardLayout.left+' ,'+d.dashboardLayout.top+', 0px)';this.setKpiNumericContentWidth(e);}if(B!==this.oLayoutData.colCount&&t){this._triggerCardResize(d);}}this.dashboardLayoutModel._removeSpaceBeforeCard();this.oLayoutCtrl.fireAfterDragEnds();if(t){this.lastTriggeredColWidth=this.oLayoutData.colWidthPx;}this.setAriaPos();}};b.prototype.getCards=function(i){if(this.aCards&&this.oLayoutData.previousColCount===i){return this.aCards;}this._setColCount(i);this.aCards=this.dashboardLayoutModel.getCards(i);this._setCardsCssValues(this.aCards);return this.aCards;};b.prototype.resetToManifest=function(){this.aCards=[];this.dashboardLayoutModel.resetToManifest();};b.prototype.getCardDomId=function(d){return this.layoutDomId+"--"+d;};b.prototype.getCardId=function(s){var d=s.indexOf("---")+3;var M=s.substring(d);return M?M.split("--")[2]:'';};b.prototype.getCardIdFromComponent=function(s){var d=s.indexOf("---")+3;var L=s.substring(d);return L?L.split("--")[1]:'';};b.prototype.isCardAutoSpan=function(d){return this.dashboardLayoutModel.getCardById(d).dashboardLayout.autoSpan;};b.prototype.setAutoCardSpanHeight=function(e,d,h){var r,f,g;if(!d&&e&&e.target.parentElement){var s=e.target.parentElement.parentElement.id;var i=s.indexOf("---")+3;var M=s.substring(i);d=M.split("--")[1];}var H=h;if(!H&&e){H=e.size.height;}if(this.isCardAutoSpan(d)){g=this.dashboardLayoutModel.getCardById(d);if(g.dashboardLayout.showOnlyHeader){r=Math.ceil((H+2*this.CARD_BORDER_PX)/this.getRowHeightPx());}else{r=Math.round((H+2*this.CARD_BORDER_PX)/this.getRowHeightPx());}f=this.dashboardLayoutModel.resizeCard(d,{rowSpan:r,colSpan:1},false);this._sizeCard(f.resizeCard);this._positionCards(f.affectedCards);this.setAriaPos();}};b.prototype.calculateCardProperties=function(s){var g=this._getCardController(s);var d=this.dashboardLayoutModel.getCardById(s);var i=250,h,e,L,f,H;if(g){H=g.getItemHeight(g,'ovpCardHeader');h=H===0?d.dashboardLayout.headerHeight:H;e=g.getItemHeight(g,'toolbar');if(d.template==='sap.ovp.cards.list'||d.template==='sap.ovp.cards.v4.list'){H=g.getItemHeight(g,'ovpList',true);L=H===0?d.dashboardLayout.itemHeight:H;f=h+e+L;}else if(d.template==='sap.ovp.cards.table'||d.template==='sap.ovp.cards.v4.table'){L=d.dashboardLayout.itemHeight;f=h+e+2*L;}else if(d.template==='sap.ovp.cards.linklist'||d.template==='sap.ovp.cards.v4.linklist'){if(d.settings.listFlavor==='carousel'){f=h+u.getOuterHeight(document.querySelector('.sapOvpCarouselContentHeader'))+240+u.getOuterHeight(document.querySelector('.sapMCrslControlsBottom.sapMCrslControls'));}else{L=g.getItemHeight(g,'ovpLinkList',true);var j=g.getView().getModel('ovpCardProperties').getProperty('/densityStyle');if(j==='cozy'){f=h+e+L+8;}else{f=h+e+L+4;}}}else if(d.template==='sap.ovp.cards.charts.analytical'){var B=g.getView().byId('bubbleText')?43:0;f=h+e+i+B+50;}else{f=h+e;}return{headerHeight:h,dropDownHeight:e,itemHeight:L,minCardHeight:f,leastHeight:h};}};b.prototype._sizeCard=function(d){if(!d){return;}var $=document.getElementById(this.getCardDomId(d.id));d.dashboardLayout.width=d.dashboardLayout.colSpan*this.oLayoutData.colWidthPx+"px";d.dashboardLayout.height=d.dashboardLayout.rowSpan*this.oLayoutData.rowHeightPx+"px";if($){$.style.height=d.dashboardLayout.height;$.style.width=d.dashboardLayout.width;this._triggerCardResize(d);}this.dashboardLayoutModel._removeSpaceBeforeCard();var i=(this.dashboardLayoutModel._findHighestOccupiedRow())+32;q(".sapUshellEasyScanLayoutInner").css({"height":i+"px"});q(".sapUshellEasyScanLayout").css({"height":i+"px"});};b.prototype._triggerCardResize=function(d){var e=d.dashboardLayout,f=d.id,g=this._getCardComponentDomId(f),$=document.getElementById(g),G=this._getCardController(f),h,i,j;try{if((e.autoSpan||!e.visible)&&G){i=G.getCardItemsBinding();h=this.calculateCardProperties(f);if(i&&h){var n=i.getLength();var k=n?Math.min(n,d.dashboardLayout.noOfItems):d.dashboardLayout.noOfItems;var A=(n===0)?d.dashboardLayout.noOfItems:k;var p=e.rowSpan*this.ROW_HEIGHT_PX;var r=p-(h.headerHeight+2*this.CARD_BORDER_PX);if(d.template==='sap.ovp.cards.table'||d.template==='sap.ovp.cards.v4.table'){G.addColumnInTable($,e);}else if(d.template==='sap.ovp.cards.list'||d.template==='sap.ovp.cards.v4.list'){j=A*h.itemHeight+h.dropDownHeight;$.style.height=Math.min(j,r)+d.dashboardLayout.headerHeight+"px";}}return;}}catch(s){l.warning("Card auto span failed for card "+f+" and error is  "+s.toString());}e.iRowHeightPx=this.getRowHeightPx();e.iCardBorderPx=this.CARD_BORDER_PX;try{if(G){h=this.calculateCardProperties(f);G.resizeCard(e,h);}else{l.warning("OVP resize: no controller found for "+f);}}catch(t){l.warning("OVP resize: "+f+" catch "+t.toString());}};b.prototype._positionCards=function(d){if(!d){return;}var p={},s=false;d.forEach(function(e){if(!e.dashboardLayout.visible){return;}p=this._mapGridToPositionPx(e.dashboardLayout);e.dashboardLayout.top=p.top;e.dashboardLayout.left=p.left;var f=document.getElementById(this.getCardDomId(e.id));if(f){f.classList.remove('sapOvpNotResizableLeftRight','sapOvpNotResizableRight','sapOvpNotResizableDown');f.style[this.cssVendorTransition]='all 0.15s ease';f.style[this.cssVendorTransform]='translate3d('+p.left+' ,'+p.top+', 0px)';s=e.dashboardLayout.column+e.dashboardLayout.colSpan===this.oLayoutData.colCount+1;if(s){if(e.dashboardLayout.colSpan===1){f.classList.add('sapOvpNotResizableLeftRight');}else{f.classList.add('sapOvpNotResizableRight');}}if(((e.template==="sap.ovp.cards.list"||e.template==="sap.ovp.cards.v4.list")&&e.dashboardLayout.colSpan===2)||((e.template==="sap.ovp.cards.linklist"||e.template==="sap.ovp.cards.v4.linklist")&&e.settings.listFlavor==='carousel'&&e.dashboardLayout.colSpan===3)){f.classList.add('sapOvpNotResizableRight');}if((e.template==="sap.ovp.cards.linklist"||e.template==="sap.ovp.cards.v4.linklist")&&e.settings.listFlavor==='carousel'&&e.dashboardLayout.rowSpan===45){f.classList.add('sapOvpNotResizableDown');}}}.bind(this));};b.prototype.updateCardSize=function(s,g,d){var e=this.dashboardLayoutModel.getCardById(s);var f=this._getCardController(s);var $=document.getElementById(this.getCardDomId(s));$.style.height=g+'px';$.style.width=d+'px';$.style[this.cssVendorTransition]='none';$.style.zIndex=10;if((e.template==='sap.ovp.cards.linklist'||e.template==='sap.ovp.cards.v4.linklist')&&e.settings.listFlavor==='carousel'){f.getView().byId('pictureCarousel').$().css('height',g-(e.dashboardLayout.headerHeight+2*this.CARD_BORDER_PX)+'px');}};b.prototype.resizeCard=function(d,s,e){this.changedCards=this.dashboardLayoutModel.resizeCard(this.getCardId(d),s,true,e);this._positionCards(this.changedCards.affectedCards);};b.prototype._mapGridToPositionPx=function(g){var L=(g.column-1)*this.getColWidthPx();var p={top:(g.row-1)*this.getRowHeightPx()+"px",left:(this.isRTLEnabled?-L:L)+"px"};return p;};b.prototype._getCardComponentDomId=function(d){return this.componentDomId+"--"+d;};b.prototype._getCardController=function(d){var e=null;var f=sap.ui.getCore().byId(this._getCardComponentDomId(d));if(f){var g=f.getComponentInstance();if(g){e=g.getAggregation("rootControl").getController();}}return e;};b.prototype._setCardsCssValues=function(d){var i=0;for(i=0;i<d.length;i++){this.setCardCssValues(d[i]);}};b.prototype.setCardCssValues=function(d){var L=(d.dashboardLayout.column-1)*this.oLayoutData.colWidthPx;d.dashboardLayout.top=((d.dashboardLayout.row-1)*this.oLayoutData.rowHeightPx)+'px';d.dashboardLayout.width=(d.dashboardLayout.colSpan*this.oLayoutData.colWidthPx)+'px';d.dashboardLayout.height=(d.dashboardLayout.rowSpan*this.oLayoutData.rowHeightPx)+'px';d.dashboardLayout.left=(this.isRTLEnabled?-L:L)+'px';};b.prototype.convertRemToPx=function(v){var d=v;if(typeof v==="string"||v instanceof String){d=v.length>0?parseInt(v.split("rem")[0],10):0;}return d*C.getPixelPerRem();};b.prototype.convertPxToRem=function(v){var d=v;if(typeof v==="string"||v instanceof String){d=v.length>0?parseFloat(v.split("px")[0],10):0;}return d/C.getPixelPerRem();};b.prototype.setKpiNumericContentWidth=function($){var O=$.getElementsByClassName("sapOvpKpiContent");if(!!O&&O.length>0){var d=O[0];var i=8;var p=16;d.style.width=(this.getColWidthPx()-(2*i+2*p))+"px";}};b.prototype.getLayoutWidthPx=function(){return this.oLayoutData.colCount*this.oLayoutData.colWidthPx;};b.prototype.getColWidthPx=function(){return this.oLayoutData.colWidthPx;};b.prototype.getRowHeightPx=function(){return this.oLayoutData.rowHeightPx;};b.prototype._setColCount=function(i){this.oLayoutData.colCount=i;};b.prototype.setAriaPos=function(){var d=[];this.ariaPos={};this.aCards.forEach(function(e){if(e.dashboardLayout.visible===true){e.visited=false;if(d[e.dashboardLayout.column-1]){d[e.dashboardLayout.column-1].push(e);}else{d[e.dashboardLayout.column-1]=[e];}}});d.forEach(function(e){e.sort(function(f,g){if(f.dashboardLayout.row<g.dashboardLayout.row){return-1;}else if(f.dashboardLayout.row>g.dashboardLayout.row){return 1;}else{return 0;}});});c.setAriaPosition(d,this);};return b;},true);
