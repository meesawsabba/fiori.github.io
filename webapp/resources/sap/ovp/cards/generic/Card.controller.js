sap.ui.define(["sap/ui/core/mvc/Controller","sap/ovp/cards/ActionUtils","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/generic/app/navigation/service/PresentationVariant","sap/ovp/cards/CommonUtils","sap/ovp/cards/OVPCardAsAPIUtils","sap/ui/core/ResizeHandler","sap/ui/core/format/NumberFormat","sap/ovp/cards/AnnotationHelper","sap/ui/model/odata/AnnotationHelper","sap/m/MessageBox","sap/ui/generic/app/navigation/service/NavError","sap/ui/core/CustomData","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Button","sap/m/MessageToast","sap/ui/core/TextDirection","sap/ui/generic/app/library","sap/ui/thirdparty/jquery","sap/ovp/app/resources","sap/ovp/app/OVPUtils","sap/ui/events/KeyCodes","sap/base/util/isPlainObject","sap/base/util/merge","sap/ovp/cards/ovpLogger","sap/ovp/cards/jUtils","sap/base/util/isEmptyObject","sap/ui/util/openWindow","sap/ovp/placeholder/placeholderHelper"],function(C,A,S,P,a,O,R,N,b,c,M,d,e,F,J,D,B,f,T,G,q,g,h,K,k,m,o,u,l,n,p){"use strict";var L=new o("OVP.generic.Card");return C.extend("sap.ovp.cards.generic.Card",{initKeyboardNavigation:function(){var j=function(i){this.init(i);};j.prototype.layoutItemFocusHandler=function(){var r=q(document.activeElement);if(r){var s=r.find("[aria-label]");var i,t="";if(r.find('.valueStateText').length==1){var v=r.find('.valueStateText').find('.sapMObjectNumberText').text();var V=r.find('.valueStateText').find('.sapUiInvisibleText').text();r.find('.valueStateText').attr('aria-label',v+" "+V);r.find('.valueStateText').attr('aria-labelledby',"");}r.find("[role='listitem']").attr('aria-label',"");if(r.hasClass('sapOvpCardHeader')&&!r.hasClass('sapOvpStackCardContent')){var w="";var x=r.find('.cardHeaderType');if(x.length===0){var y=g.getText("CardHeaderType");w="cardHeaderType_"+new Date().getTime();var z='<div id="'+w+'" class="cardHeaderType" aria-label="'+y+'" hidden></div>';r.append(z);}else{w=x[0].id;}t+=w+" ";}for(i=0;i<s.length;i++){if(s[i].getAttribute("role")==="heading"){t+=s[i].id+" ";}}if(r.hasClass('sapOvpCardHeader')){var E=r.find('.cardHeaderText');if(E.length!==0){for(var i=0;i<E.length;i++){if(t.indexOf(E[i].id)===-1){t+=E[i].id+" ";}}}}if(t.length){r.attr("aria-labelledby",t);}if(r.prop('nodeName')==="LI"&&r.find('.linkListHasPopover').length!==0){if(r.find('#hasDetails').length===0){r.append("<div id='hasDetails' hidden>"+g.getText("HAS_DETAILS")+"</div>");r.attr('aria-describedby',"hasDetails");}}var H=r.attr("id");if((H&&H.indexOf("ovpTable")!=-1)&&r.find("[role='Link']")&&!r.hasClass('sapUiCompSmartLink')){var I=r.closest("td").attr("data-sap-ui-column"),Q=r.closest("tbody").siblings().children().filter("tr").children();for(var i=0;i<Q.length;i++){if(Q[i].getAttribute("data-sap-ui")==I&&Q[i].hasChildNodes("span")){var U=Q[i].firstElementChild.getAttribute("id");r.attr("aria-labelledby",U);}}}}};j.prototype.init=function(i){this.cardLayout=i;this.keyCodes=K;this.jqElement=q(i.getView().$());this.jqElement=this.jqElement.parent().parent().parent();this.jqElement.on("focus.keyboardNavigation",this.layoutItemFocusHandler.bind(this));};this.keyboardNavigation=new j(this);},onInit:function(){this.oCardComponent=this.getOwnerComponent();this.oCardComponentData=this.oCardComponent&&this.oCardComponent.getComponentData();this.oMainComponent=this.oCardComponentData&&this.oCardComponentData.mainComponent;this.sCardId=this.oCardComponentData.cardId;var s=this.getView().mPreprocessors.xml[0].ovpCardProperties.oData.state;if(s!=="Error"){var H=this.getView().byId("ovpCardHeader");if(!!H){H.attachBrowserEvent("click",this.onHeaderClick.bind(this));H.addEventDelegate({onkeydown:function(E){if(!E.shiftKey&&E.keyCode==13){E.preventDefault();this.onHeaderClick(E);}else if(!E.shiftKey&&E.keyCode==32){E.preventDefault();}}.bind(this)});H.addEventDelegate({onkeyup:function(E){if(!E.shiftKey&&E.keyCode==32){E.preventDefault();this.onHeaderClick(E);}}.bind(this)});}}var i=this.getView().byId("kpiNumberValue");if(i){i.addEventDelegate({onAfterRendering:function(){var $=i.$();var j=$.find(".sapMNCValueScr");var r=$.find(".sapMNCScale");j.attr("aria-label",j.text());r.attr("aria-label",r.text());var t=this.getView().byId("ovpCardHeader").getDomRef();var v=this.getOwnerComponent().getComponentData();if(!!v&&!!v.appComponent){var w=v.appComponent;if(!!w.getModel("ui")){var U=w.getModel("ui");if(!!U.getProperty("/containerLayout")&&U.getProperty("/containerLayout")==="resizable"){var x=v.appComponent.getDashboardLayoutUtil();if(!!x){x.setKpiNumericContentWidth(t);}}}}}.bind(this)});}},exit:function(){if(this.resizeHandlerId){R.deregister(this.resizeHandlerId);}},onAfterRendering:function(){var i=this.getView().byId('ovpCardHeader');var j=i&&i.getDomRef();var H=this.getView().byId('ovpHeaderTitle'),Q=this.getView().byId('ovpQuickviewCardHeader');if(j&&!j.getAttribute("ariaLabelledBy")){if(H&&H.getText()){var s=H.getDomRef().getAttribute("id");j.setAttribute("arialabelledby",s);}else if(Q&&Q.getText()){var r=Q.getDomRef().getAttribute("id");j.setAttribute("arialabelledby",r);}}var t=this.getCardPropertiesModel();this.enableClick=true;var v=t.getProperty("/contentFragment"),w=this.getOwnerComponent().getComponentData(),I=this.getCardItemsBinding();if(!I&&p.hidePlaceholderNeeded()){p.hidePlaceholder();}this._handleCountHeader();this._handleKPIHeader();var x=t.getProperty("/selectedKey");if(x&&t.getProperty("/state")!=='Loading'){var y=this.getView().byId("ovp_card_dropdown");if(y){y.setSelectedKey(x);}}try{var w=this.getOwnerComponent().getComponentData();if(w&&w.appComponent){var z=w.appComponent;if(z.getModel('ui')){var U=z.getModel('ui');if(U.getProperty('/containerLayout')==='resizable'){var E=z.getDashboardLayoutUtil();if(E){this.oDashboardLayoutUtil=E;this.cardId=w.cardId;if(E.isCardAutoSpan(w.cardId)){this.resizeHandlerId=R.register(this.getView(),function(j1){L.info('DashboardLayout autoSize:'+j1.target.id+' -> '+j1.size.height);E.setAutoCardSpanHeight(j1);});}}}}}}catch(V){L.error("DashboardLayout autoSpan check failed.");}if(this.oDashboardLayoutUtil&&this.oDashboardLayoutUtil.isCardAutoSpan(this.cardId)){var $=q("#"+this.oDashboardLayoutUtil.getCardDomId(this.cardId));if(this.oView.$().outerHeight()>$.innerHeight()){this.oDashboardLayoutUtil.setAutoCardSpanHeight(null,this.cardId,this.oView.$().height());}}var W=0;if(w&&w.mainComponent){var X=w.mainComponent;if(X.bGlobalFilterLoaded){W=this.checkNavigation();}}else if(O.checkIfAPIIsUsed(this)){W=this.checkAPINavigation();}var Y=this.getCardPropertiesModel();var Z=Y.getProperty("/state");if(Z!=="Loading"&&Z!=="Error"){var _=Y.getProperty("/template");if(_==="sap.ovp.cards.stack"){if(!W){var a1=this.getView().byId('ViewAll');if(a1){a1=a1.getDomRef();a1.parentNode.removeChild(a1);}}}}if(v==="sap.ovp.cards.stack.Stack"){var b1=this.getView().getDomRef();var c1=b1&&b1.querySelector('.sapOvpCardContentContainer');if(c1){c1.style.borderTop="none";}}if(W){if(v?v!=="sap.ovp.cards.quickview.Quickview":true){if(v==="sap.ovp.cards.stack.Stack"){var b1=this.getView().getDomRef();var d1=b1.querySelectorAll('.sapOvpCardContentRightHeader');if(d1.length!==0){u.addClassToAllElements(d1,'sapOvpCardNavigable');}}else{this.getView().addStyleClass("sapOvpCardNavigable");}}if(v&&v==="sap.ovp.cards.quickview.Quickview"){var e1=this.byId("ovpCardHeader");if(e1){e1.addStyleClass("sapOvpCardNavigable");}}}else{if(v){this.getView().addStyleClass("ovpNonNavigableItem");var e1=this.byId("ovpCardHeader");if(e1){e1.$().removeAttr('role');e1.addStyleClass('ovpNonNavigableItem');}var f1=this.checkLineItemNavigation();if(!f1){switch(v){case"sap.ovp.cards.list.List":var g1=this.getView().byId("listItem");if(g1){g1.setType("Inactive");}break;case"sap.ovp.cards.table.Table":var g1=this.getView().byId("tableItem");if(g1){g1.setType("Inactive");}break;case"sap.ovp.cards.linklist.LinkList":if(!this.checkNavigationForLinkedList()){var g1=this.getView().byId("ovpCLI");if(g1){g1.setType("Inactive");}}break;}}}}var h1=this.getView().byId("ovp_card_dropdown");var i1=this.getView().byId("ovp_card_dropdown_label");if(h1){h1.addAriaLabelledBy(i1.getId());}if(O.checkIfAPIIsUsed(this)){this.initKeyboardNavigation();}},checkNavigation:function(){var i=this.getCardPropertiesModel();if(this.checkHeaderNavForChart()){return 0;}var E=this.getEntityType();if(E){if(i){var I=i.getProperty("/identificationAnnotationPath");var s=I;var j=i.getProperty("/contentFragment");if(j&&(j==="sap.ovp.cards.stack.Stack"||j==="sap.ovp.cards.quickview.Quickview")){var r=(I)?I.split(","):[];if(r&&r.length>1){if(j==="sap.ovp.cards.stack.Stack"){s=r[0];}else{s=r[1];}}}var t=E[s];if(this.isNavigationInAnnotation(t)){return 1;}if(i&&i.getProperty("/template")==="sap.ovp.cards.charts.analytical"){var v=i.getProperty("/kpiAnnotationPath");if(E&&v){var w=E[v];if(w&&w.Detail){var x=w.Detail.SemanticObject&&w.Detail.SemanticObject.String;var y=w.Detail.Action&&w.Detail.Action.String;if(x&&y){return 1;}}}}}}else if(i&&i.getProperty("/template")==="sap.ovp.cards.linklist"&&i.getProperty("/staticContent")&&i.getProperty("/targetUri")){return 1;}return 0;},checkNavigationForLinkedList:function(){if(this.getEntityType()){var E=this.getEntityType();var i=E['com.sap.vocabularies.UI.v1.LineItem'];if(i&&(i[0].RecordType==="com.sap.vocabularies.UI.v1.DataFieldForAction"||i[0].RecordType==="com.sap.vocabularies.UI.v1.DataFieldWithUrl")){return true;}}return false;},checkLineItemNavigation:function(){if(this.getEntityType()){var E=this.getEntityType();var i=this.getCardPropertiesModel();if(i){var s=i.getProperty("/annotationPath");var r=E[s];return this.isNavigationInAnnotation(r);}}},isNavigationInAnnotation:function(r){if(r&&r.length){for(var i=0;i<r.length;i++){var I=r[i];if(I.RecordType==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"||I.RecordType==="com.sap.vocabularies.UI.v1.DataFieldForAction"||I.RecordType==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"){return 1;}}}return 0;},checkAPINavigation:function(){var i=this.getOwnerComponent().getComponentData(),j=i.fnCheckNavigation&&typeof i.fnCheckNavigation==="function",r=j?i.fnCheckNavigation:null;if(r){if(r()){return true;}}else{if(this.checkNavigation()){return true;}}return false;},onHeaderClick:function(E){var s=E.ctrlKey||E.metaKey?h.constants.explace:h.constants.inplace;if(O.checkIfAPIIsUsed(this)){if(this.checkAPINavigation()){a.onHeaderClicked();}}else{var i=this.getCardPropertiesModel();var t=i.getProperty("/template");var j=i.getProperty("/targetUri");if(t=="sap.ovp.cards.linklist"&&i.getProperty("/staticContent")!==undefined&&j){window.location.href=j;}else if(i.getProperty("/staticContent")!==undefined&&j===""){return;}else if(this.checkHeaderNavForChart()){return;}else{this.doNavigation(this.getView().getBindingContext(),null,s);}}},checkHeaderNavForChart:function(){var i=this.getCardPropertiesModel();var t=i.getProperty("/template");var j=i.getProperty("/navigation");if(j=="noHeaderNav"&&(t=="sap.ovp.cards.charts.analytical"||"sap.ovp.cards.charts.smart.chart")){return true;}else{return false;}},resizeCard:function(i){L.info(i);if(this.resizeHandlerId){R.deregister(this.resizeHandlerId);this.resizeHandlerId=null;}},_handleCountHeader:function(){var i=this.getView().byId("ovpCountHeader");if(i){var I=this.getCardItemsBinding();if(I){if(I.isLengthFinal()&&I.getLength()>0){this.setHeaderCounter(I,i);}I.attachDataReceived(function(E){if(p.hidePlaceholderNeeded()){p.hidePlaceholder();}this.setHeaderCounter(I,i,E);}.bind(this));I.attachChange(function(E){this.setHeaderCounter(I,i,E);}.bind(this));}}else{var I=this.getCardItemsBinding();if(I){I.attachDataReceived(function(){if(p.hidePlaceholderNeeded()){p.hidePlaceholder();}});}}},setHeaderCounter:function(i,j,E){var t;if(i.isLengthFinal()){t=i.getLength();}else{if(E&&E.getParameters().data&&E.getParameters().data.results){t=E.getParameters().data.results.length;}}var r=i.getCurrentContexts().length;var s,v="";var w=N.getIntegerInstance({minFractionDigits:0,maxFractionDigits:1,decimalSeparator:".",style:"short"});r=parseFloat(r,10);var x=this.getOwnerComponent().getComponentData();if(x&&x.appComponent){var y=x.appComponent;if(y.getModel('ui')){var U=y.getModel('ui');if(U.getProperty('/containerLayout')!=='resizable'){if(t!==0){t=w.format(Number(t));}if(r!==0){r=w.format(Number(r));}}else{s=y.getDashboardLayoutUtil().dashboardLayoutModel.getCardById(x.cardId);}}}if(r===0){v="";}else if(s&&s.dashboardLayout.showOnlyHeader){v=g.getText("Count_Header_Total",[t]);}else if(t!=r){v=g.getText("Count_Header",[r,t]);}j.setText(v);j.addEventDelegate({onAfterRendering:function(){var $=j.$();$.attr("aria-label",v);}});},_handleKPIHeader:function(){var i,s;if(this.getView()&&this.getView().getDomRef()){i=this.getView().getDomRef().getElementsByClassName("numericContentHbox");s=this.getView().getDomRef().getElementsByClassName("noDataSubtitle");}else{return;}if(i||s){var j=this.getKPIBinding();if(j){j.attachDataReceived(function(E){var U=E.getParameter("data")&&E.getParameter("data").results&&E.getParameter("data").results[0];var t=j.getLength();if(i[0]){i[0].style.visibility=null;if(t===0){i[0].style.visibility='hidden';}else{this._setSubTitleWithUnitOfMeasure(U);i[0].style.visibility='visible';}}if(s.length!==0){s[0].style.display="none";if(t===0){s[0].style.display="flex";}}}.bind(this));}}},getKPIBinding:function(){var i=this.byId("kpiHBoxNumeric"),j=i&&i.getBindingInfo("items")&&i.getBindingInfo("items").binding;return j;},_setSubTitleWithUnitOfMeasure:function(U){var i=this.getCardPropertiesModel();if(!!i){var j=i.getData();var s=this.getView().byId("SubTitle-Text");if(!!s){s.setText(j.subTitle);if(!!j&&!!j.entityType&&!!j.dataPointAnnotationPath){var E=i.getData().entityType;var r=j.dataPointAnnotationPath.split("/");var t=r.length===1?E[j.dataPointAnnotationPath]:E[r[0]][r[1]];var v;if(t&&t.Value&&t.Value.Path){v=t.Value.Path;}else if(t&&t.Description&&t.Description.Value&&t.Description.Value.Path){v=t.Description.Value.Path;}if(!!v){var w=a.getUnitColumn(v,E);var x;if(!!w&&!!U){x=U[w];}else{x=a.getUnitColumn(v,E,true);}var y=g.getText("SubTitle_IN");if(!!j.subTitle&&!!y&&!!x){s.setText(j.subTitle+" "+y+" "+x);var z=s.getAggregation("customData");if(z){var H;for(H in z){var I=z[H];if(I.getKey()==="aria-label"){I.setValue(j.subTitle+" "+y+" "+x);break;}}}}}}}}},getCardItemsBinding:function(){},onActionPress:function(E){var s=E.getSource(),i=this._getActionObject(s),j=s.getBindingContext();if(i.type.indexOf("DataFieldForAction")!==-1){this.doAction(j,i);}else{this.doNavigation(j,i);}},_getActionObject:function(s){var j=s.getCustomData();var r={};for(var i=0;i<j.length;i++){r[j[i].getKey()]=j[i].getValue();}return r;},doNavigation:function(i,j,s){if(!s){s=h.constants.inplace;}if(!this.enableClick){return;}this.enableClick=false;setTimeout(function(){this.enableClick=true;}.bind(this),1000);if(!this.oMainComponent){return;}if(!j){j=this.getEntityNavigationEntries(i)[0];}var r=m({},i);var t=m({},j);var v=this.oMainComponent.doCustomNavigation&&this.oMainComponent.doCustomNavigation(this.sCardId,r,t);var E=this.oMainComponent.templateBaseExtension&&this.oMainComponent.templateBaseExtension.provideExtensionNavigation&&this.oMainComponent.templateBaseExtension.provideExtensionNavigation(this.sCardId,r,t);var w;if(v){w=v;}if(E){w=E;}if(w){var x=w.type;if(x&&typeof x==="string"&&x.length>0){x=x.split(".").pop().split("/").pop().toLowerCase();switch(x){case"datafieldwithurl":w.type="com.sap.vocabularies.UI.v1.DataFieldWithUrl";break;case"datafieldforintentbasednavigation":w.type="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation";break;}j=w;}}function y(s){if(!s){s=h.constants.inplace;}if(j){switch(j.type){case"com.sap.vocabularies.UI.v1.DataFieldWithUrl":this.doNavigationWithUrl(i,j,s);break;case"com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation":this.doIntentBasedNavigation(i,j,false,s);break;case"com.sap.vocabularies.UI.v1.KPIDetailType":this.doIntentBasedNavigation(i,j,false,s);break;}}}if(!this.oMainComponent.oAppStatePromise){y.call(this,s);}else{this.oMainComponent.oAppStatePromise.then(y.bind(this,s));}},doNavigationWithUrl:function(i,j,s){if(!s){s=h.constants.inplace;}if(!sap.ushell.Container){return;}var r=sap.ushell.Container.getService("URLParsing");if(!(r.isIntentUrl(j.url))){n(j.url,"newWindow");}else{var t=r.parseShellHash(j.url);var w=t.appSpecificRoute?true:false;this.doIntentBasedNavigation(i,t,w,s);}},fnHandleError:function(E){if(E instanceof d){if(E.getErrorCode()==="NavigationHandler.isIntentSupported.notSupported"){M.show(g.getText("OVP_NAV_ERROR_NOT_AUTHORIZED_DESC"),{title:g.getText("OVP_GENERIC_ERROR_TITLE")});}else{M.show(E.getErrorCode(),{title:g.getText("OVP_GENERIC_ERROR_TITLE")});}}},doCrossApplicationNavigation:function(I,r){var s="#"+I.semanticObject+'-'+I.action;if(I.params){var t=this.oCardComponent&&this.oCardComponent.getComponentData();var v=t&&t.appComponent;if(v){var w=v._formParamString(I.params);s=s+w;}}var x=this;if(!sap.ushell.Container){return;}sap.ushell.Container.getService("CrossApplicationNavigation").isIntentSupported([s]).done(function(y){if(y[s].supported===true){if(!!r.params){if(typeof r.params=='string'){try{r.params=JSON.parse(r.params);}catch(z){L.error("Could not parse the Navigation parameters");return;}}}var t=x.getOwnerComponent().getComponentData();var E=t?t.globalFilter:undefined;var U=E&&E.getUiState({allFilters:false});var H=U?JSON.stringify(U.getSelectionVariant()):"{}";E=JSON.parse(H);var Q=x._getFilterPreference();E=x._removeFilterFromGlobalFilters(Q,E);if(!r.params){r.params={};}if(!!E&&!!E.SelectOptions){for(var i=0;i<E.SelectOptions.length;i++){var V=E.SelectOptions[i].Ranges;if(!!V){var W=[];for(var j=0;j<V.length;j++){if(V[j].Sign==="I"&&V[j].Option==="EQ"){W.push(V[j].Low);}}r.params[E.SelectOptions[i].PropertyName]=W;}}}sap.ushell.Container.getService("CrossApplicationNavigation").toExternal(r);}else{var X=new d("NavigationHandler.isIntentSupported.notSupported");x.fnHandleError(X);}}).then(function(){L.error("Could not get authorization from isIntentSupported");});},doIntentBasedNavigation:function(i,I,U,s){if(!s){s=h.constants.inplace;}if(sap.ushell&&!sap.ushell.Container){return;}var j,r,t,E=i?i.getObject():null;var v=this.getCardPropertiesModel(),w=v.getProperty("/customParams");if(i&&typeof i.getAllData==="function"&&w){t=i.getAllData();}else if(v.getProperty("/staticContent")){t={iStaticLinkListIndex:I.iStaticLinkListIndex,bStaticLinkListIndex:true};}if(E&&E.__metadata){delete E.__metadata;}var x=a.getNavigationHandler();if(x){if(I){j=this._getEntityNavigationParameters(E,t,i);r={target:{semanticObject:I.semanticObject,action:I.action},appSpecificRoute:I.appSpecificRoute,params:j.sNavSelectionVariant};var y={};if(j.sNavPresentationVariant){y.presentationVariant=j.sNavPresentationVariant;}if(U){if(I&&I.semanticObject&&I.action){var z=this.getCardPropertiesModel().getProperty("/staticParameters");r.params=(!!z)?z:{};this.doCrossApplicationNavigation(I,r);}}else{x.navigate(r.target.semanticObject,r.target.action,r.params,null,this.fnHandleError,y,s);}}}},doAction:function(i,j){this.actionData=A.getActionInfo(i,j,this.getEntityType());if(this.actionData.allParameters.length>0){this._loadParametersForm();}else{this._callFunction();}},getEntityNavigationEntries:function(j,s){var r=[];var E=this.getEntityType();var t=this.getCardPropertiesModel();var v=t.getProperty("/template");if(!E){return r;}if(!s&&!j){if(!this.oCardComponentData.settings.identificationAnnotationPath){var w=t.getProperty("/kpiAnnotationPath");if(w&&v==="sap.ovp.cards.charts.analytical"){s=w;var x=E[s];var y=x&&x.Detail;var z=y.SemanticObject&&y.SemanticObject.String;var H=y.Action&&y.Action.String;if(y.RecordType==="com.sap.vocabularies.UI.v1.KPIDetailType"){if(z&&H){r.push({type:y.RecordType,semanticObject:z,action:H,label:""});}else{L.error("Invalid Semantic object and action configured for annotation "+y.RecordType);}}}}}if(!s){var I=t.getProperty("/identificationAnnotationPath");var Q=(I)?I.split(","):[];if(Q&&Q.length>1){s=Q[0];}else{s=I;}}var U=E[s];if(Array.isArray(U)){U=b.sortCollectionByImportance(U);for(var i=0;i<U.length;i++){if(U[i].RecordType==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"){r.push({type:U[i].RecordType,semanticObject:U[i].SemanticObject.String,action:U[i].Action.String,label:U[i].Label?U[i].Label.String:null});}if(U[i].RecordType==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"&&!U[i].Url.UrlRef){var V=this.getView().getModel();var W=V.oMetaModel;var X=W.createBindingContext(E.$path);var Y=c.format(X,U[i].Url);var Z=new e({key:"url",value:Y});if(j&&v==="sap.ovp.cards.charts.analytical"){V=j.getModel();}Z.setModel(V);Z.setBindingContext(j);var $=Z.getValue();r.push({type:U[i].RecordType,url:$,value:U[i].Value.String,label:U[i].Label?U[i].Label.String:null});}}}return r;},getModel:function(){return this.getView().getModel();},getMetaModel:function(){if(this.getModel()){return this.getModel().getMetaModel();}},getCardPropertiesModel:function(){if(!this.oCardPropertiesModel||l(this.oCardPropertiesModel)){this.oCardPropertiesModel=this.getView().getModel("ovpCardProperties");}return this.oCardPropertiesModel;},getEntitySet:function(){if(!this.entitySet){var E=this.getCardPropertiesModel().getProperty("/entitySet");this.entitySet=this.getMetaModel().getODataEntitySet&&this.getMetaModel().getODataEntitySet(E);}return this.entitySet;},getEntityType:function(){if(!this.entityType){if(this.getMetaModel()&&this.getEntitySet()){this.entityType=this.getMetaModel().getODataEntityType(this.getEntitySet().entityType);}}return this.entityType;},getCardContentContainer:function(){if(!this.cardContentContainer){this.cardContentContainer=this.getView().byId("ovpCardContentContainer");}return this.cardContentContainer;},_processCustomParameters:function(j,s,r){var t=this.getCardPropertiesModel();if(!this.oMainComponent||!t){return;}var v;if(j&&j.bStaticLinkListIndex){var w=t.getProperty("/staticContent");v=w[j.iStaticLinkListIndex]["customParams"];j=null;}else{v=t.getProperty("/customParams");}if(!v||!this.oMainComponent.templateBaseExtension.provideCustomParameter||!this.oMainComponent.onCustomParams){return;}var x=this.oMainComponent.templateBaseExtension.provideCustomParameter(v)?this.oMainComponent.templateBaseExtension.provideCustomParameter(v):this.oMainComponent.onCustomParams(v);if(!x||!u.checkIfFunction(x)){return;}var y=m({},j);var z=m({},s);var E=x(y,z);if(!E||(!Array.isArray(E)&&!k(E))){return;}var I=k(E);if(I&&l(E)){return;}var H=I&&(E.bIgnoreEmptyString||E.ignoreEmptyString);var Q=I?(E.aSelectionVariant||E.selectionVariant):E;if(!Array.isArray(Q)){return;}var i,U,V,W,X,Y;U=Q.length;for(i=0;i<U;i++){V=Q[i];if(!V){continue;}W=V.path;X=V.value1;Y=V.value2;if(!W||typeof W!=="string"||W===""){L.error("Custom Variant property path '"+W+"' should be valid string");continue;}if(!(X||X===0||(X===""&&H))){continue;}X=X.toString();Y=Y&&Y.toString();if(X===""&&H){s.removeSelectOption(W);}if(j){delete j[W];}if(r){delete r[W];}s.addSelectOption(W,V.sign,V.operator,X,Y);}if(H){this._removeEmptyStringsFromSelectionVariant(s);}return H;},_getEntityNavigationParameters:function(E,j,r){var s={};var t,v,w;var x=this.getOwnerComponent().getComponentData();var y=x?x.globalFilter:undefined;var z=this.getCardPropertiesModel();var H=z&&z.getProperty("/staticContent");if(!H){var I=b.getCardSelections(this.getCardPropertiesModel());var Q=I.filters;var U=I.parameters;var V=this.getEntityType();Q&&Q.forEach(function(k1){k1.path=k1.path.replace("/",".");switch(k1.operator){case F.NE:k1.operator=F.EQ;k1.sign="E";break;case F.Contains:k1.operator="CP";var l1=k1.value1;k1.value1="*"+l1+"*";break;case F.EndsWith:k1.operator="CP";var l1=k1.value1;k1.value1="*"+l1;break;case F.StartsWith:k1.operator="CP";var l1=k1.value1;k1.value1=l1+"*";}});I.filters=Q;if(r&&E&&E.hasOwnProperty("$isOthers")){var W=r.getOtherNavigationDimensions();for(var X in W){var Y=W[X];for(var i=0;i<Y.length;i++){I.filters.push({path:X,operator:"EQ",value1:Y[i],sign:"E"});}}}U&&U.forEach(function(k1){k1.path=k1.path.replace("/",".");});I.parameters=U;var Z=b.getCardSorters(this.getCardPropertiesModel());if(E){var X;for(var i=0;V.property&&i<V.property.length;i++){X=V.property[i].name;var $=E[X];if(E.hasOwnProperty(X)){if(Array.isArray(E[X])&&E[X].length===1){s[X]=E[X][0];}else if(q.type($)!=="object"){s[X]=$;}}}}var _=z&&z.getProperty("/kpiAnnotationPath");var a1=z&&z.getProperty("/template");if(_&&a1==="sap.ovp.cards.charts.analytical"){var b1=V[_];var c1=b1&&b1.Detail;if(c1&&c1.RecordType==="com.sap.vocabularies.UI.v1.KPIDetailType"){s["kpiID"]=b1.ID.String;}}v=Z&&new P(Z);t=this._buildSelectionVariant(y,I);w=z&&z.getProperty("/staticParameters");}else{var d1=y&&y.getUiState({allFilters:false});var e1=d1?JSON.stringify(d1.getSelectionVariant()):"{}";t=new S(e1);var f1=this._getFilterPreference();t=this._removeFilterFromGlobalFilters(f1,t);if(H[j.iStaticLinkListIndex].params){w=H[j.iStaticLinkListIndex].params;}else if(H[j.iStaticLinkListIndex].staticParameters){w=H[j.iStaticLinkListIndex].staticParameters;}}var g1;if(j&&!j.bStaticLinkListIndex){g1=this._processCustomParameters(j,t,s);}else if(j&&j.bStaticLinkListIndex){g1=this._processCustomParameters(j,t);}else{g1=this._processCustomParameters(s,t);}var h1=g1?G.navigation.service.SuppressionBehavior.ignoreEmptyString:undefined;if(w){for(var X in w){if(!s.hasOwnProperty(X)){s[X]=w[X];}}}var i1=a.getNavigationHandler();var j1=i1&&i1.mixAttributesAndSelectionVariant(s,t.toJSONString(),h1);if(!H){this._removeSensitiveAttributesFromNavSelectionVariant(V,j1);}return{sNavSelectionVariant:j1?j1.toJSONString():null,sNavPresentationVariant:v?v.toJSONString():null};},_removeSensitiveAttributesFromNavSelectionVariant:function(E,j){for(var i=0;i<E.property.length;i++){if(E.property[i]["com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"]&&E.property[i]["com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"].Bool){delete j._mSelectOptions[E.property[i].name];}}},_removeEmptyStringsFromSelectionVariant:function(s){var r=s.getParameterNames();for(var i=0;i<r.length;i++){if(s.getParameter(r[i])===""){s.removeParameter(r[i]);}}var t=s.getSelectOptionsPropertyNames();for(i=0;i<t.length;i++){var v=s.getSelectOption(t[i]);for(var j=0;j<v.length;j++){if(v[j].Low===""&&!v[j].High){v.splice(j,1);j--;}}if(v.length===0){s.removeSelectOption(t[i]);}}return s;},_checkIfCardFiltersAreValid:function(i,s){var j=true;if(i&&i.filterAll==="global"){j=false;}else if(i&&i.globalFilter){if(i.globalFilter.indexOf(s)>=0){j=false;}}return j;},_getFilterPreference:function(){var i=this.getOwnerComponent()?this.getOwnerComponent().getComponentData():null;var j;if(i&&i.mainComponent){j=i.mainComponent._getFilterPreference(i.cardId);}return j;},_removeFilterFromGlobalFilters:function(i,s){var j=[];if(i&&i.filterAll==="card"){j=s.getSelectOptionsPropertyNames();}else if(i&&i.cardFilter){j=i.cardFilter;}j.forEach(function(r){if(r!=="$.basicSearch"){s.removeSelectOption(r);}});return s;},_buildSelectionVariant:function(r,s){var U=r&&r.getUiState({allFilters:false});var t=U?JSON.stringify(U.getSelectionVariant()):"{}";var v=new S(t);var w,V,x,y;var z=this._getFilterPreference();v=this._removeFilterFromGlobalFilters(z,v);var E=s.filters;var H=s.parameters;for(var i=0;i<E.length;i++){w=E[i];if(w.path&&w.operator&&typeof w.value1!=="undefined"){V=w.value1.toString();x=(typeof w.value2!=="undefined")?w.value2.toString():undefined;if(this._checkIfCardFiltersAreValid(z,w.path)){v.addSelectOption(w.path,w.sign,w.operator,V,x);}}}var I,Q,W;for(var j=0;j<H.length;j++){y=H[j];if(!y.path||!y.value){continue;}I=y.path.split("/").pop();I=I.split(".").pop();if(I.indexOf("P_")===0){Q=I;W=I.substr(2);}else{Q="P_"+I;W=I;}if(v.getParameter(Q)){continue;}if(v.getParameter(W)){continue;}v.addParameter(I,y.value);}return v;},_loadParametersForm:function(){var i=new J();i.setData(this.actionData.parameterData);var t=this;var j=new D('ovpCardActionDialog',{title:this.actionData.sFunctionLabel,afterClose:function(){j.destroy();}}).addStyleClass("sapUiNoContentPadding");var r=new B({text:this.actionData.sFunctionLabel,press:function(E){var x=A.getParameters(E.getSource().getModel(),t.actionData.oFunctionImport);j.close();t._callFunction(x,t.actionData.sFunctionLabel);}});var s=new B({text:"Cancel",press:function(){j.close();}});j.setBeginButton(r);j.setEndButton(s);var v=function(E){var x=A.mandatoryParamsMissing(E.getSource().getModel(),t.actionData.oFunctionImport);r.setEnabled(!x);};var w=A.buildParametersForm(this.actionData,v);j.addContent(w);j.setModel(i);j.open();},_callFunction:function(U,i){var j={batchGroupId:"Changes",changeSetId:"Changes",urlParameters:U,forceSubmit:true,context:this.actionData.oContext,functionImport:this.actionData.oFunctionImport};var t=this;var r=new Promise(function(s,v){var w=t.actionData.oContext.getModel();var x;x="/"+j.functionImport.name;w.callFunction(x,{method:j.functionImport.httpMethod,urlParameters:j.urlParameters,batchGroupId:j.batchGroupId,changeSetId:j.changeSetId,headers:j.headers,success:function(y,z){s(z);},error:function(y){y.actionText=i;v(y);}});});r.then(function(s){return f.show(g.getText("Toast_Action_Success"),{duration:1000});},function(E){var s=a.showODataErrorMessages(E);if(s===""&&E.actionText){s=g.getText("Toast_Action_Error")+' "'+E.actionText+'"'+".";}return M.error(s,{title:g.getText("OVP_GENERIC_ERROR_TITLE"),onClose:null,styleClass:"",initialFocus:null,textDirection:T.Inherit});});},setErrorState:function(){var i=this.getOwnerComponent();if(!i||!i.oContainer){return;}var j=i.oContainer;var r=this.getCardPropertiesModel();var s={name:"sap.ovp.cards.loading",componentData:{model:this.getView().getModel(),settings:{category:r.getProperty("/category"),title:r.getProperty("/title"),description:r.getProperty("/description"),entitySet:r.getProperty("/entitySet"),state:h.loadingState.ERROR,template:r.getProperty("/template")}}};sap.ui.core.Component.create(s).then(function(t){j.setComponent(t);setTimeout(function(){i.destroy();},0);});},changeSelection:function(s,i,j){if(!i){var r=this.getView().byId("ovp_card_dropdown");s=parseInt(r.getSelectedKey(),10);}var t={};if(!i){t=this.getCardPropertiesModel().getProperty("/tabs")[s-1];}else{t=j.tabs[s-1];}var U={cardId:this.getOwnerComponent().getComponentData().cardId,selectedKey:s};for(var v in t){U[v]=t[v];}if(O.checkIfAPIIsUsed(this)){O.recreateCard(U,this.getOwnerComponent().getComponentData());}else{this.getOwnerComponent().getComponentData().mainComponent.recreateCard(U);this.getOwnerComponent().getComponentData().mainComponent.setOrderedCardsSelectedKey(this.getOwnerComponent().getComponentData().cardId,s);}},getItemHeight:function(i,s,j){if(!!i){var r=i.getView().byId(s);var H=0;if(!!r){if(j){if(r.getItems()[0]&&r.getItems()[0].getDomRef()){H=u.getOuterHeight(r.getItems()[0].getDomRef());}}else{if(r.getDomRef()){H=u.getOuterHeight(r.getDomRef());}}}return H;}},getHeaderHeight:function(){var H=this.getItemHeight(this,'ovpCardHeader'),i=this.getOwnerComponent()?this.getOwnerComponent().getComponentData():null;if(i&&i.appComponent){var j=i.appComponent.getDashboardLayoutUtil(),r=j.getDashboardLayoutModel().getCardById(i.cardId);if(H!==0){r.dashboardLayout.headerHeight=H;}}return H;}});});
