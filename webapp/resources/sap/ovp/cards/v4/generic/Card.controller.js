sap.ui.define(["sap/ui/core/mvc/Controller","sap/ovp/cards/ActionUtils","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/generic/app/navigation/service/PresentationVariant","sap/ovp/cards/CommonUtils","sap/ovp/cards/OVPCardAsAPIUtils","sap/ui/core/ResizeHandler","sap/ui/core/format/NumberFormat","sap/ovp/cards/v4/V4AnnotationHelper","sap/ui/model/odata/AnnotationHelper","sap/m/MessageBox","sap/ui/generic/app/navigation/service/NavError","sap/ui/core/CustomData","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Button","sap/m/MessageToast","sap/ui/core/TextDirection","sap/ui/generic/app/library","sap/ui/thirdparty/jquery","sap/ovp/app/resources","sap/ovp/app/OVPUtils","sap/ui/events/KeyCodes","sap/base/util/isPlainObject","sap/base/util/merge","sap/ovp/cards/ovpLogger","sap/ovp/cards/jUtils","sap/base/util/isEmptyObject","sap/ovp/cards/Filterhelper","sap/ui/model/odata/v4/AnnotationHelper","sap/ui/util/openWindow","sap/ui/core/Component","sap/ovp/placeholder/placeholderHelper"],function(C,A,S,P,a,O,R,N,b,c,M,d,e,F,J,D,B,f,T,G,q,g,h,K,k,m,o,u,l,n,p,r,s,t){"use strict";var L=new o("OVP.generic.Card");return C.extend("sap.ovp.cards.v4.generic.Card",{initKeyboardNavigation:function(){var j=function(i){this.init(i);};j.prototype.layoutItemFocusHandler=function(){var v=q(document.activeElement);if(v){var w=v.find("[aria-label]");var i,x="";if(v.find('.valueStateText').length==1){var y=v.find('.valueStateText').find('.sapMObjectNumberText').text();var V=v.find('.valueStateText').find('.sapUiInvisibleText').text();v.find('.valueStateText').attr('aria-label',y+" "+V);v.find('.valueStateText').attr('aria-labelledby',"");}v.find("[role='listitem']").attr('aria-label',"");if(v.hasClass('sapOvpCardHeader')&&!v.hasClass('sapOvpStackCardContent')){var z="";var E=v.find('.cardHeaderType');if(E.length===0){var H=g.getText("CardHeaderType");z="cardHeaderType_"+new Date().getTime();var I='<div id="'+z+'" class="cardHeaderType" aria-label="'+H+'" hidden></div>';v.append(I);}else{z=E[0].id;}x+=z+" ";}for(i=0;i<w.length;i++){if(w[i].getAttribute("role")==="heading"){x+=w[i].id+" ";}}if(v.hasClass('sapOvpCardHeader')){var Q=v.find('.cardHeaderText');if(Q.length!==0){for(var i=0;i<Q.length;i++){if(x.indexOf(Q[i].id)===-1){x+=Q[i].id+" ";}}}}if(x.length){v.attr("aria-labelledby",x);}if(v.prop('nodeName')==="LI"&&v.find('.linkListHasPopover').length!==0){if(v.find('#hasDetails').length===0){v.append("<div id='hasDetails' hidden>"+g.getText("HAS_DETAILS")+"</div>");v.attr('aria-describedby',"hasDetails");}}var U=v.attr("id");if((U&&U.indexOf("ovpTable")!=-1)&&v.find("[role='Link']")&&!v.hasClass('sapUiCompSmartLink')){var W=v.closest("td").attr("data-sap-ui-column"),X=v.closest("tbody").siblings().children().filter("tr").children();for(var i=0;i<X.length;i++){if(X[i].getAttribute("data-sap-ui")==W&&X[i].hasChildNodes("span")){var Y=X[i].firstElementChild.getAttribute("id");v.attr("aria-labelledby",Y);}}}}};j.prototype.init=function(i){this.cardLayout=i;this.keyCodes=K;this.jqElement=q(i.getView().$());this.jqElement=this.jqElement.parent().parent().parent();this.jqElement.on("focus.keyboardNavigation",this.layoutItemFocusHandler.bind(this));};this.keyboardNavigation=new j(this);},onInit:function(){this.oCardComponent=this.getOwnerComponent();this.oCardComponentData=this.oCardComponent&&this.oCardComponent.getComponentData();this.oMainComponent=this.oCardComponentData&&this.oCardComponentData.mainComponent;this.sCardId=this.oCardComponentData.cardId;var i=this.getView().mPreprocessors.xml[0].ovpCardProperties.oData.state;if(i!=="Error"){var H=this.getView().byId("ovpCardHeader");if(!!H){H.attachBrowserEvent("click",this.onHeaderClick.bind(this));H.addEventDelegate({onkeydown:function(E){if(!E.shiftKey&&E.keyCode==13){E.preventDefault();this.onHeaderClick(E);}else if(!E.shiftKey&&E.keyCode==32){E.preventDefault();}}.bind(this)});H.addEventDelegate({onkeyup:function(E){if(!E.shiftKey&&E.keyCode==32){E.preventDefault();this.onHeaderClick(E);}}.bind(this)});}}var j=this.getView().byId("kpiNumberValue");if(j){j.addEventDelegate({onAfterRendering:function(){var $=j.$();var v=$.find(".sapMNCValueScr");var w=$.find(".sapMNCScale");v.attr("aria-label",v.text());w.attr("aria-label",w.text());var x=this.getView().byId("ovpCardHeader").getDomRef();var y=this.getOwnerComponent().getComponentData();if(!!y&&!!y.appComponent){var z=y.appComponent;if(!!z.getModel("ui")){var U=z.getModel("ui");if(!!U.getProperty("/containerLayout")&&U.getProperty("/containerLayout")==="resizable"){var E=y.appComponent.getDashboardLayoutUtil();if(!!E){E.setKpiNumericContentWidth(x);}}}}}.bind(this)});}},exit:function(){if(this.resizeHandlerId){R.deregister(this.resizeHandlerId);}},onExit:function(){var i=this;this.GloabalEventBus.unsubscribe("OVPGlobalfilter","OVPGlobalFilterSeacrhfired",i.eventhandler);},onAfterRendering:function(){var i=this.getView().byId('ovpCardHeader');var j=i&&i.getDomRef();var H=this.getView().byId('ovpHeaderTitle'),Q=this.getView().byId('ovpQuickviewCardHeader');if(j&&!j.getAttribute("ariaLabelledBy")){if(H&&H.getText()){var v=H.getDomRef().getAttribute("id");j.setAttribute("arialabelledby",v);}else if(Q&&Q.getText()){var w=Q.getDomRef().getAttribute("id");j.setAttribute("arialabelledby",w);}}var x=this.getCardPropertiesModel();this.enableClick=true;var y=x.getProperty("/contentFragment");var z=this.getOwnerComponent().getComponentData();var E=x.getProperty("/selectedKey");var I=this.getCardItemsBinding();if(!I&&t.hidePlaceholderNeeded()){t.hidePlaceholder();}if(E&&x.getProperty("/state")!=='Loading'){var U=this.getView().byId("ovp_card_dropdown");if(U){U.setSelectedKey(E);}}try{var z=this.getOwnerComponent().getComponentData();if(z&&z.appComponent){var V=z.appComponent;if(V.getModel('ui')){var W=V.getModel('ui');if(W.getProperty('/containerLayout')==='resizable'){var X=V.getDashboardLayoutUtil();if(X){this.oDashboardLayoutUtil=X;this.cardId=z.cardId;if(X.isCardAutoSpan(z.cardId)){this.resizeHandlerId=R.register(this.getView(),function(l1){L.info('DashboardLayout autoSize:'+l1.target.id+' -> '+l1.size.height);X.setAutoCardSpanHeight(l1);});}}}}}}catch(Y){L.error("DashboardLayout autoSpan check failed.");}if(this.oDashboardLayoutUtil&&this.oDashboardLayoutUtil.isCardAutoSpan(this.cardId)){var $=q("#"+this.oDashboardLayoutUtil.getCardDomId(this.cardId));if(this.oView.$().outerHeight()>$.innerHeight()){this.oDashboardLayoutUtil.setAutoCardSpanHeight(null,this.cardId,this.oView.$().height());}}var Z=0;if(z&&z.mainComponent){var _=z.mainComponent;if(_.bGlobalFilterLoaded){Z=this.checkNavigation();}}else if(O.checkIfAPIIsUsed(this)){Z=this.checkAPINavigation();}var a1=this.getCardPropertiesModel();var b1=a1.getProperty("/state");if(b1!=="Loading"&&b1!=="Error"){var c1=a1.getProperty("/template");if(c1==="sap.ovp.cards.stack"){if(!Z){var d1=this.getView().byId('ViewAll');if(d1){d1=d1.getDomRef();d1.parentNode.removeChild(d1);}}}}if(Z){if(y?y!=="sap.ovp.cards.quickview.Quickview":true){if(y==="sap.ovp.cards.stack.Stack"){var e1=this.getView().getDomRef();var f1=e1.querySelectorAll('.sapOvpCardContentRightHeader');if(f1.length!==0){u.addClassToAllElements(f1,'sapOvpCardNavigable');}}else{this.getView().addStyleClass("sapOvpCardNavigable");}}if(y&&y==="sap.ovp.cards.quickview.Quickview"){var g1=this.byId("ovpCardHeader");if(g1){g1.addStyleClass("sapOvpCardNavigable");}}}else{if(y){this.getView().addStyleClass("ovpNonNavigableItem");var g1=this.byId("ovpCardHeader");if(g1){g1.$().removeAttr('role');g1.addStyleClass('ovpNonNavigableItem');}var h1=this.checkLineItemNavigation();if(!h1){switch(y){case"sap.ovp.cards.v4.list.List":var i1=this.getView().byId("listItem");if(i1){i1.setType("Inactive");}break;case"sap.ovp.cards.v4.table.Table":var i1=this.getView().byId("tableItem");if(i1){i1.setType("Inactive");}break;case"sap.ovp.cards.v4.linklist.LinkList":if(!this.checkNavigationForLinkedList()){var i1=this.getView().byId("ovpCLI");if(i1){i1.setType("Inactive");}}break;}}}}var j1=this.getView().byId("ovp_card_dropdown");var k1=this.getView().byId("ovp_card_dropdown_label");if(j1){j1.addAriaLabelledBy(k1.getId());}if(O.checkIfAPIIsUsed(this)){this.initKeyboardNavigation();}this._handleCountHeader();this._handleKPIHeader();},checkNavigation:function(){var i=this.getCardPropertiesModel();if(this.checkHeaderNavForChart()){return 0;}var E=this.getEntityType();if(E){if(i){var I=i.getProperty("/identificationAnnotationPath");var j=I;var v=i.getProperty("/contentFragment");if(v&&(v==="sap.ovp.cards.stack.Stack"||v==="sap.ovp.cards.quickview.Quickview")){var w=(I)?I.split(","):[];if(w&&w.length>1){if(v==="sap.ovp.cards.stack.Stack"){j=w[0];}else{j=w[1];}}}var x=E["@"+j];if(this.isNavigationInAnnotation(x)){return 1;}if(i&&i.getProperty("/template")==="sap.ovp.cards.charts.analytical"){var y=i.getProperty("/kpiAnnotationPath");if(E&&y){var z=E[y];if(z&&z.Detail){var H=z.Detail.SemanticObject&&z.Detail.SemanticObject.String;var Q=z.Detail.Action&&z.Detail.Action.String;if(H&&Q){return 1;}}}}}}else if(i&&i.getProperty("/template")==="sap.ovp.cards.v4.linklist"&&i.getProperty("/staticContent")&&i.getProperty("/targetUri")){return 1;}return 0;},checkNavigationForLinkedList:function(){if(this.getEntityType()){var E=this.getEntityType();var i=E['com.sap.vocabularies.UI.v1.LineItem'];if(i&&(i[0].RecordType==="com.sap.vocabularies.UI.v1.DataFieldForAction"||i[0].RecordType==="com.sap.vocabularies.UI.v1.DataFieldWithUrl")){return true;}}return false;},checkLineItemNavigation:function(){if(this.getEntityType()){var E=this.getEntityType();var i=this.getCardPropertiesModel();if(i){var j=i.getProperty("/annotationPath");var v=E["@"+j];return this.isNavigationInAnnotation(v);}}},isNavigationInAnnotation:function(j){if(j&&j.length){for(var i=0;i<j.length;i++){var I=j[i];if(I.$Type==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"||I.$Type==="com.sap.vocabularies.UI.v1.DataFieldForAction"||I.$Type==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"){return 1;}}}return 0;},checkAPINavigation:function(){var i=this.getOwnerComponent().getComponentData(),j=i.fnCheckNavigation&&typeof i.fnCheckNavigation==="function",v=j?i.fnCheckNavigation:null;if(v){if(v()){return true;}}else{if(this.checkNavigation()){return true;}}return false;},onHeaderClick:function(E){var i=E.ctrlKey||E.metaKey?h.constants.explace:h.constants.inplace;if(O.checkIfAPIIsUsed(this)){if(this.checkAPINavigation()){a.onHeaderClicked();}}else{var j=this.getCardPropertiesModel();var v=j.getProperty("/template");var w=j.getProperty("/targetUri");if(v=="sap.ovp.cards.v4.linklist"&&j.getProperty("/staticContent")!==undefined&&w){window.location.href=w;}else if(j.getProperty("/staticContent")!==undefined&&w===""){return;}else if(this.checkHeaderNavForChart()){return;}else{this.doNavigation(this.getView().getBindingContext(),null,i);}}},checkHeaderNavForChart:function(){var i=this.getCardPropertiesModel();var j=i.getProperty("/template");var v=i.getProperty("/navigation");if(v=="noHeaderNav"&&(j=="sap.ovp.cards.charts.analytical"||"sap.ovp.cards.charts.smart.chart")){return true;}else{return false;}},resizeCard:function(i){L.info(i);if(this.resizeHandlerId){R.deregister(this.resizeHandlerId);this.resizeHandlerId=null;}},_handleCountHeader:function(){var i=this.getView().byId("ovpCountHeader");if(i){var I=this.getCardItemsBinding();if(I){if(I.getLength()>0){this.setHeaderCounter(I,i);}I.attachDataReceived(function(){if(t.hidePlaceholderNeeded()){t.hidePlaceholder();}this.setHeaderCounter(I,i);}.bind(this));I.attachChange(function(){this.setHeaderCounter(I,i);}.bind(this));}}else{var I=this.getCardItemsBinding();if(I){I.attachDataReceived(function(){if(t.hidePlaceholderNeeded()){t.hidePlaceholder();}});}}},setHeaderCounter:function(i,j){var v=i.getLength();var w=i.getCurrentContexts().length;var x,y="";var z=N.getIntegerInstance({minFractionDigits:0,maxFractionDigits:1,decimalSeparator:".",style:"short"});w=parseFloat(w,10);var E=this.getOwnerComponent().getComponentData();if(E&&E.appComponent){var H=E.appComponent;if(H.getModel('ui')){var U=H.getModel('ui');if(U.getProperty('/containerLayout')!=='resizable'){if(v!==0){v=z.format(Number(v));}if(w!==0){w=z.format(Number(w));}}else{x=H.getDashboardLayoutUtil().dashboardLayoutModel.getCardById(E.cardId);}}}if(w===0){y="";}else if(x&&x.dashboardLayout.showOnlyHeader){y=g.getText("Count_Header_Total",[v]);}else if(v!=w){y=g.getText("Count_Header",[w,v]);}j.setText(y);j.addEventDelegate({onAfterRendering:function(){var $=j.$();$.attr("aria-label",y);}});},_handleKPIHeader:function(){var i,j;if(this.getView()&&this.getView().getDomRef()){i=this.getView().getDomRef().getElementsByClassName("numericContentHbox");j=this.getView().getDomRef().getElementsByClassName("noDataSubtitle");}else{return;}if(i||j){var v=this.getKPIBinding();if(v){v.attachDataReceived(function(E){var U=E.getParameter("data")&&E.getParameter("data").results&&E.getParameter("data").results[0];var w=v.getLength();if(i[0]){i[0].style.visibility=null;if(w===0){i[0].style.visibility='hidden';}else{this._setSubTitleWithUnitOfMeasure(U);i[0].style.visibility='visible';}}if(j.length!==0){j[0].style.display="none";if(w===0){j[0].style.display="flex";}}}.bind(this));}}},getKPIBinding:function(){var i=this.byId("kpiHBoxNumeric"),j=i&&i.getBindingInfo("items")&&i.getBindingInfo("items").binding;return j;},_setSubTitleWithUnitOfMeasure:function(U){var i=this.getCardPropertiesModel();if(!!i){var j=i.getData();var v=this.getView().byId("SubTitle-Text");if(!!v){v.setText(j.subTitle);if(!!j&&!!j.entityType&&!!j.dataPointAnnotationPath){var E=i.getData().entityType;var w=j.dataPointAnnotationPath.split("/");var x=w.length===1?E[j.dataPointAnnotationPath]:E[w[0]][w[1]];var y;if(x&&x.Value&&x.Value.Path){y=x.Value.Path;}else if(x&&x.Description&&x.Description.Value&&x.Description.Value.Path){y=x.Description.Value.Path;}if(!!y){var z=a.getUnitColumn(y,E);var H;if(!!z&&!!U){H=U[z];}else{H=a.getUnitColumn(y,E,true);}var I=g.getText("SubTitle_IN");if(!!j.subTitle&&!!I&&!!H){v.setText(j.subTitle+" "+I+" "+H);var Q=v.getAggregation("customData");if(Q){var V;for(V in Q){var W=Q[V];if(W.getKey()==="aria-label"){W.setValue(j.subTitle+" "+I+" "+H);break;}}}}}}}}},getCardItemsBinding:function(){},onActionPress:function(E){var i=E.getSource(),j=this._getActionObject(i),v=i.getBindingContext();if(j.type.indexOf("DataFieldForAction")!==-1){this.doAction(v,j);}else{this.doNavigation(v,j);}},_getActionObject:function(j){var v=j.getCustomData();var w={};for(var i=0;i<v.length;i++){w[v[i].getKey()]=v[i].getValue();}return w;},doNavigation:function(i,j,v){if(!v){v=h.constants.inplace;}if(!this.enableClick){return;}this.enableClick=false;setTimeout(function(){this.enableClick=true;}.bind(this),1000);if(!this.oMainComponent){return;}if(!j){j=this.getEntityNavigationEntries(i)[0];}var w=m({},i);var x=m({},j);var y=this.oMainComponent.doCustomNavigation&&this.oMainComponent.doCustomNavigation(this.sCardId,w,x);var E=this.oMainComponent.templateBaseExtension&&this.oMainComponent.templateBaseExtension.provideExtensionNavigation&&this.oMainComponent.templateBaseExtension.provideExtensionNavigation(this.sCardId,w,x);var z;if(y){z=y;}if(E){z=E;}if(z){var H=z.type;if(H&&typeof H==="string"&&H.length>0){H=H.split(".").pop().split("/").pop().toLowerCase();switch(H){case"datafieldwithurl":z.type="com.sap.vocabularies.UI.v1.DataFieldWithUrl";break;case"datafieldforintentbasednavigation":z.type="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation";break;}j=z;}}function I(v){if(!v){v=h.constants.inplace;}if(j){switch(j.type){case"com.sap.vocabularies.UI.v1.DataFieldWithUrl":this.doNavigationWithUrl(i,j,v);break;case"com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation":this.doIntentBasedNavigation(i,j,false,v);break;case"com.sap.vocabularies.UI.v1.KPIDetailType":this.doIntentBasedNavigation(i,j,false,v);break;}}}if(!this.oMainComponent.oAppStatePromise){I.call(this,v);}else{this.oMainComponent.oAppStatePromise.then(I.bind(this,v));}},doNavigationWithUrl:function(i,j,v){if(!v){v=h.constants.inplace;}if(!sap.ushell.Container){return;}var w=sap.ushell.Container.getService("URLParsing");if(!(w.isIntentUrl(j.url))){r(j.url,"newWindow");}else{var x=w.parseShellHash(j.url);var W=x.appSpecificRoute?true:false;this.doIntentBasedNavigation(i,x,W,v);}},fnHandleError:function(E){if(E instanceof d){if(E.getErrorCode()==="NavigationHandler.isIntentSupported.notSupported"){M.show(g.getText("OVP_NAV_ERROR_NOT_AUTHORIZED_DESC"),{title:g.getText("OVP_GENERIC_ERROR_TITLE")});}else{M.show(E.getErrorCode(),{title:g.getText("OVP_GENERIC_ERROR_TITLE")});}}},doCrossApplicationNavigation:function(I,v){var w="#"+I.semanticObject+'-'+I.action;if(I.params){var x=this.oCardComponent&&this.oCardComponent.getComponentData();var y=x&&x.appComponent;if(y){var z=y._formParamString(I.params);w=w+z;}}var E=this;if(!sap.ushell.Container){return;}sap.ushell.Container.getService("CrossApplicationNavigation").isIntentSupported([w]).done(function(H){if(H[w].supported===true){if(!!v.params){if(typeof v.params=='string'){try{v.params=JSON.parse(v.params);}catch(Q){L.error("Could not parse the Navigation parameters");return;}}}var x=E.getOwnerComponent().getComponentData();var U=x?x.globalFilter:undefined;var V=U&&U.getUiState({allFilters:false});var W=V?JSON.stringify(V.getSelectionVariant()):"{}";U=JSON.parse(W);var X=E._getFilterPreference();U=E._removeFilterFromGlobalFilters(X,U);if(!v.params){v.params={};}if(!!U&&!!U.SelectOptions){for(var i=0;i<U.SelectOptions.length;i++){var Y=U.SelectOptions[i].Ranges;if(!!Y){var Z=[];for(var j=0;j<Y.length;j++){if(Y[j].Sign==="I"&&Y[j].Option==="EQ"){Z.push(Y[j].Low);}}v.params[U.SelectOptions[i].PropertyName]=Z;}}}sap.ushell.Container.getService("CrossApplicationNavigation").toExternal(v);}else{var $=new d("NavigationHandler.isIntentSupported.notSupported");E.fnHandleError($);}}).then(function(){L.error("Could not get authorization from isIntentSupported");});},doIntentBasedNavigation:function(i,I,U,j){if(!j){j=h.constants.inplace;}if(sap.ushell&&!sap.ushell.Container){return;}var v,w,x,E=i?i.getObject():null;var y=this.getCardPropertiesModel(),z=y.getProperty("/customParams");if(i&&typeof i.getAllData==="function"&&z){x=i.getAllData();}else if(y.getProperty("/staticContent")){x={iStaticLinkListIndex:I.iStaticLinkListIndex,bStaticLinkListIndex:true};}if(E&&E.__metadata){delete E.__metadata;}var H=a.getNavigationHandler();if(H){if(I){v=this._getEntityNavigationParameters(E,x,i);w={target:{semanticObject:I.semanticObject,action:I.action},appSpecificRoute:I.appSpecificRoute,params:v.sNavSelectionVariant};var Q={};if(v.sNavPresentationVariant){Q.presentationVariant=v.sNavPresentationVariant;}if(U){if(I&&I.semanticObject&&I.action){var V=this.getCardPropertiesModel().getProperty("/staticParameters");w.params=(!!V)?V:{};this.doCrossApplicationNavigation(I,w);}}else{H.navigate(w.target.semanticObject,w.target.action,w.params,null,this.fnHandleError,Q,j);}}}},doAction:function(i,j){this.actionData=A.getActionInfo(i,j,this.getEntityType());if(this.actionData.allParameters.length>0){this._loadParametersForm();}else{this._callFunction();}},getEntityNavigationEntries:function(j,v){var w=[];var E=this.getEntityType();var x=this.getCardPropertiesModel();var y=x.getProperty("/template");if(!E){return w;}if(!v&&!j){if(!this.oCardComponentData.settings.identificationAnnotationPath){var z=x.getProperty("/kpiAnnotationPath");if(z&&y==="sap.ovp.cards.charts.analytical"){v=z;var H=E[v];var I=H&&H.Detail;var Q=I.SemanticObject&&I.SemanticObject.String;var U=I.Action&&I.Action.String;if(I.RecordType==="com.sap.vocabularies.UI.v1.KPIDetailType"){if(Q&&U){w.push({type:I.RecordType,semanticObject:Q,action:U,label:""});}else{L.error("Invalid Semantic object and action configured for annotation "+I.RecordType);}}}}}if(!v){var V=x.getProperty("/identificationAnnotationPath");var W=(V)?V.split(","):[];if(W&&W.length>1){v=W[0];}else{v=V;}}var X=E["@"+v];if(Array.isArray(X)){X=b.sortCollectionByImportance(X);for(var i=0;i<X.length;i++){if(X[i].$Type==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"){w.push({type:X[i].$Type,semanticObject:X[i].SemanticObject,action:X[i].Action,label:X[i].Label?X[i].Label:null});}if(X[i].$Type==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"&&!X[i].Url.UrlRef){var Y=this.getView().getModel();var Z=Y.getMetaModel();var $;if(j){$=j.getInterface(0).getPath();}else{$="/"+x.getInterface().getData().entitySet;}var _=Z.createBindingContext($);var a1=p.format(X[i].Url,{context:_});var b1=new e({key:"url",value:a1});if(j&&y==="sap.ovp.cards.charts.analytical"){Y=j.getModel();}b1.setModel(Y);b1.setBindingContext(j);var c1=b1.getValue();w.push({type:X[i].$Type,url:c1,value:X[i].Value,label:X[i].Label?X[i].Label:null});}}}return w;},getModel:function(){return this.getView().getModel();},getMetaModel:function(){if(this.getModel()){return this.getModel().getMetaModel();}},getCardPropertiesModel:function(){if(!this.oCardPropertiesModel||l(this.oCardPropertiesModel)){this.oCardPropertiesModel=this.getView().getModel("ovpCardProperties");}return this.oCardPropertiesModel;},getEntitySet:function(){if(!this.entitySet){var E=this.getCardPropertiesModel().getProperty("/entitySet");this.entitySet=this.getMetaModel()&&this.getMetaModel().getObject("/"+E);}return this.entitySet;},getEntityType:function(){if(!this.entityType){var i=this.getMetaModel();var E=this.getEntitySet();if(i&&E){var j=i.getData().$Annotations[E.$Type];var v={"property":i.getObject("/"+E.$Type+"/")};this.entityType=h.merge(true,{},j,v);}}return this.entityType;},getCardContentContainer:function(){if(!this.cardContentContainer){this.cardContentContainer=this.getView().byId("ovpCardContentContainer");}return this.cardContentContainer;},_processCustomParameters:function(j,v,w){var x=this.getCardPropertiesModel();if(!this.oMainComponent||!x){return;}var y;if(j&&j.bStaticLinkListIndex){var z=x.getProperty("/staticContent");y=z[j.iStaticLinkListIndex]["customParams"];j=null;}else{y=x.getProperty("/customParams");}if(!y||!this.oMainComponent.templateBaseExtension.provideCustomParameter||!this.oMainComponent.onCustomParams){return;}var E=this.oMainComponent.templateBaseExtension.provideCustomParameter(y)?this.oMainComponent.templateBaseExtension.provideCustomParameter(y):this.oMainComponent.onCustomParams(y);if(!E||!u.checkIfFunction(E)){return;}var H=m({},j);var I=m({},v);var Q=E(H,I);if(!Q||(!Array.isArray(Q)&&!k(Q))){return;}var U=k(Q);if(U&&l(Q)){return;}var V=U&&(Q.bIgnoreEmptyString||Q.ignoreEmptyString);var W=U?(Q.aSelectionVariant||Q.selectionVariant):Q;if(!Array.isArray(W)){return;}var i,X,Y,Z,$,_;X=W.length;for(i=0;i<X;i++){Y=W[i];if(!Y){continue;}Z=Y.path;$=Y.value1;_=Y.value2;if(!Z||typeof Z!=="string"||Z===""){L.error("Custom Variant property path '"+Z+"' should be valid string");continue;}if(!($||$===0||($===""&&V))){continue;}$=$.toString();_=_&&_.toString();if($===""&&V){v.removeSelectOption(Z);}if(j){delete j[Z];}if(w){delete w[Z];}v.addSelectOption(Z,Y.sign,Y.operator,$,_);}if(V){this._removeEmptyStringsFromSelectionVariant(v);}return V;},_getEntityNavigationParameters:function(E,j,v){var w={};var x,y,z;var H=this.getOwnerComponent().getComponentData();var I=H?H.globalFilter:undefined;var Q=this.getCardPropertiesModel();var U=Q&&Q.getProperty("/staticContent");if(!U){var V=b.getCardSelections(this.getCardPropertiesModel());var W=V.filters;var X=V.parameters;var Y=this.getEntityType();W&&W.forEach(function(o1){o1.path=o1.path.replace("/",".");switch(o1.operator){case F.NE:o1.operator=F.EQ;o1.sign="E";break;case F.Contains:o1.operator="CP";var p1=o1.value1;o1.value1="*"+p1+"*";break;case F.EndsWith:o1.operator="CP";var p1=o1.value1;o1.value1="*"+p1;break;case F.StartsWith:o1.operator="CP";var p1=o1.value1;o1.value1=p1+"*";}});V.filters=W;if(v&&E&&E.hasOwnProperty("$isOthers")){var Z=v.getOtherNavigationDimensions();for(var $ in Z){var _=Z[$];for(var i=0;i<_.length;i++){V.filters.push({path:$,operator:"EQ",value1:_[i],sign:"E"});}}}X&&X.forEach(function(o1){o1.path=o1.path.replace("/",".");});V.parameters=X;var a1=b.getCardSorters(this.getCardPropertiesModel());if(E){var $,b1=Y&&Y.property&&Object.keys(Y.property);for(var i=0;i<b1.length;i++){if(b1[i].startsWith("$")){continue;}$=b1[i];var c1=E[$];if(E.hasOwnProperty($)){if(Array.isArray(E[$])&&E[$].length===1){w[$]=E[$][0];}else if(q.type(c1)!=="object"){w[$]=c1;}}}}var d1=Q&&Q.getProperty("/kpiAnnotationPath");var e1=Q&&Q.getProperty("/template");if(d1&&e1==="sap.ovp.cards.charts.analytical"){var f1=Y[d1];var g1=f1&&f1.Detail;if(g1&&g1.RecordType==="com.sap.vocabularies.UI.v1.KPIDetailType"){w["kpiID"]=f1.ID.String;}}y=a1&&new P(a1);x=this._buildSelectionVariant(I,V);z=Q&&Q.getProperty("/staticParameters");}else{var h1=I&&I.getUiState({allFilters:false});var i1=h1?JSON.stringify(h1.getSelectionVariant()):"{}";x=new S(i1);var j1=this._getFilterPreference();x=this._removeFilterFromGlobalFilters(j1,x);if(U[j.iStaticLinkListIndex].params){z=U[j.iStaticLinkListIndex].params;}else if(U[j.iStaticLinkListIndex].staticParameters){z=U[j.iStaticLinkListIndex].staticParameters;}}var k1;if(j&&!j.bStaticLinkListIndex){k1=this._processCustomParameters(j,x,w);}else if(j&&j.bStaticLinkListIndex){k1=this._processCustomParameters(j,x);}else{k1=this._processCustomParameters(w,x);}var l1=k1?G.navigation.service.SuppressionBehavior.ignoreEmptyString:undefined;if(z){for(var $ in z){if(!w.hasOwnProperty($)){w[$]=z[$];}}}var m1=a.getNavigationHandler();var n1=m1&&m1.mixAttributesAndSelectionVariant(w,x.toJSONString(),l1);if(!U){this._removeSensitiveAttributesFromNavSelectionVariant(Y,n1);}return{sNavSelectionVariant:n1?n1.toJSONString():null,sNavPresentationVariant:y?y.toJSONString():null};},_removeSensitiveAttributesFromNavSelectionVariant:function(E,j){for(var i=0;i<E.property.length;i++){if(E.property[i]["com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"]&&E.property[i]["com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"]){delete j._mSelectOptions[E.property[i].name];}}},_removeEmptyStringsFromSelectionVariant:function(v){var w=v.getParameterNames();for(var i=0;i<w.length;i++){if(v.getParameter(w[i])===""){v.removeParameter(w[i]);}}var x=v.getSelectOptionsPropertyNames();for(i=0;i<x.length;i++){var y=v.getSelectOption(x[i]);for(var j=0;j<y.length;j++){if(y[j].Low===""&&!y[j].High){y.splice(j,1);j--;}}if(y.length===0){v.removeSelectOption(x[i]);}}return v;},_checkIfCardFiltersAreValid:function(i,j){var v=true;if(i&&i.filterAll==="global"){v=false;}else if(i&&i.globalFilter){if(i.globalFilter.indexOf(j)>=0){v=false;}}return v;},_getFilterPreference:function(){var i=this.getOwnerComponent()?this.getOwnerComponent().getComponentData():null;var j;if(i&&i.mainComponent){j=i.mainComponent._getFilterPreference(i.cardId);}return j;},_removeFilterFromGlobalFilters:function(i,j){var v=[];if(i&&i.filterAll==="card"){v=j.getSelectOptionsPropertyNames();}else if(i&&i.cardFilter){v=i.cardFilter;}v.forEach(function(w){if(w!=="$.basicSearch"){j.removeSelectOption(w);}});return j;},_buildSelectionVariant:function(v,w){var U=v&&v.getUiState({allFilters:false});var x=U?JSON.stringify(U.getSelectionVariant()):"{}";var y=new S(x);var z,V,E,H;var I=this._getFilterPreference();y=this._removeFilterFromGlobalFilters(I,y);var Q=w.filters;var W=w.parameters;for(var i=0;i<Q.length;i++){z=Q[i];if(z.path&&z.operator&&typeof z.value1!=="undefined"){V=z.value1.toString();E=(typeof z.value2!=="undefined")?z.value2.toString():undefined;if(this._checkIfCardFiltersAreValid(I,z.path)){y.addSelectOption(z.path,z.sign,z.operator,V,E);}}}var X,Y,Z;for(var j=0;j<W.length;j++){H=W[j];if(!H.path||!H.value){continue;}X=H.path.split("/").pop();X=X.split(".").pop();if(X.indexOf("P_")===0){Y=X;Z=X.substr(2);}else{Y="P_"+X;Z=X;}if(y.getParameter(Y)){continue;}if(y.getParameter(Z)){continue;}y.addParameter(X,H.value);}return y;},_loadParametersForm:function(){var i=new J();i.setData(this.actionData.parameterData);var j=this;var v=new D('ovpCardActionDialog',{title:this.actionData.sFunctionLabel,afterClose:function(){v.destroy();}}).addStyleClass("sapUiNoContentPadding");var w=new B({text:this.actionData.sFunctionLabel,press:function(E){var H=A.getParameters(E.getSource().getModel(),j.actionData.oFunctionImport);v.close();j._callFunction(H,j.actionData.sFunctionLabel);}});var x=new B({text:"Cancel",press:function(){v.close();}});v.setBeginButton(w);v.setEndButton(x);var y=function(E){var H=A.mandatoryParamsMissing(E.getSource().getModel(),j.actionData.oFunctionImport);w.setEnabled(!H);};var z=A.buildParametersForm(this.actionData,y);v.addContent(z);v.setModel(i);v.open();},_callFunction:function(U,i){var j={batchGroupId:"Changes",changeSetId:"Changes",urlParameters:U,forceSubmit:true,context:this.actionData.oContext,functionImport:this.actionData.oFunctionImport};var v=this;var w=new Promise(function(x,y){var z=v.actionData.oContext.getModel();var E;E="/"+j.functionImport.name;z.callFunction(E,{method:j.functionImport.httpMethod,urlParameters:j.urlParameters,batchGroupId:j.batchGroupId,changeSetId:j.changeSetId,headers:j.headers,success:function(H,I){x(I);},error:function(H){H.actionText=i;y(H);}});});w.then(function(x){return f.show(g.getText("Toast_Action_Success"),{duration:1000});},function(E){var x=a.showODataErrorMessages(E);if(x===""&&E.actionText){x=g.getText("Toast_Action_Error")+' "'+E.actionText+'"'+".";}return M.error(x,{title:g.getText("OVP_GENERIC_ERROR_TITLE"),onClose:null,styleClass:"",initialFocus:null,textDirection:T.Inherit});});},setErrorState:function(){var i=this.getOwnerComponent();if(!i||!i.oContainer){return;}var j=i.oContainer;var v=this.getCardPropertiesModel();var w={name:"sap.ovp.cards.loading",componentData:{model:this.getView().getModel(),settings:{category:v.getProperty("/category"),title:v.getProperty("/title"),description:v.getProperty("/description"),entitySet:v.getProperty("/entitySet"),state:h.loadingState.ERROR,template:v.getProperty("/template")}}};s.create(w).then(function(x){j.setComponent(x);setTimeout(function(){i.destroy();},0);});},changeSelection:function(i,j,v){if(!j){var w=this.getView().byId("ovp_card_dropdown");i=parseInt(w.getSelectedKey(),10);}var x={};if(!j){x=this.getCardPropertiesModel().getProperty("/tabs")[i-1];}else{x=v.tabs[i-1];}var U={cardId:this.getOwnerComponent().getComponentData().cardId,selectedKey:i};for(var y in x){U[y]=x[y];}if(O.checkIfAPIIsUsed(this)){O.recreateCard(U,this.getOwnerComponent().getComponentData());}else{this.getOwnerComponent().getComponentData().mainComponent.recreateCard(U);this.getOwnerComponent().getComponentData().mainComponent.setOrderedCardsSelectedKey(this.getOwnerComponent().getComponentData().cardId,i);}},getItemHeight:function(i,j,v){if(!!i){var w=i.getView().byId(j);var H=0;if(!!w){if(v){if(w.getItems()[0]&&w.getItems()[0].getDomRef()){H=u.getOuterHeight(w.getItems()[0].getDomRef());}}else{if(w.getDomRef()){H=u.getOuterHeight(w.getDomRef());}}}return H;}},getHeaderHeight:function(){var H=this.getItemHeight(this,'ovpCardHeader'),i=this.getOwnerComponent()?this.getOwnerComponent().getComponentData():null;if(i&&i.appComponent){var j=i.appComponent.getDashboardLayoutUtil(),v=j.getDashboardLayoutModel().getCardById(i.cardId);if(H!==0){v.dashboardLayout.headerHeight=H;}}return H;}});});
