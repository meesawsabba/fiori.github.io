sap.ui.define(["sap/ovp/cards/v4/generic/Card.controller","sap/ovp/cards/v4/charts/VizAnnotationManager","sap/viz/ui5/data/FlattenedDataset","sap/ovp/cards/OVPCardAsAPIUtils","sap/ovp/app/resources","sap/base/util/each","sap/ovp/cards/ovpLogger","sap/ovp/cards/Filterhelper","sap/ui/model/FilterOperator","sap/ui/base/SyncPromise","sap/ovp/cards/v4/charts/Utils"],function(C,V,F,O,a,e,o,b,c,S,U){"use strict";var l=new o("OVP.v4.analytical.analyticalChart");return C.extend("sap.ovp.cards.charts.v4.analytical.analyticalChart",{onInit:function(){C.prototype.onInit.apply(this,arguments);var t=this;this.eventhandler=function(d,h,i){if(t.getView().getModel().getMetaModel().getData){var m=t.getView().getModel().getMetaModel().getData();var j=t.getView().getModel('ovpCardProperties').getData().entityType.$Type;var k=b._getEntityRelevantFilters(m[j],i);k=b.mergeFilters(k,t.selectionVaraintFilter);var n=t.getCardItemsBinding();try{if(k&&k.aFilters){f(k,n,{}).then(function(q){var s=n.mParameters.$apply.split("/").length>1?t.getCardItemsBinding().mParameters.$apply.split("/")[1]:t.getCardItemsBinding().mParameters.$apply.split("/")[0];n.mParameters.$apply="filter("+q+")/"+s;n.setAggregation();}).catch(function(p){l.error(p);});}else{if(n.mParameters.$apply.split("/").length>1){n.mParameters.$apply=n.mParameters.$apply.split("/")[1];n.setAggregation();}}if(t.getKPIBinding()){t.getKPIBinding().filter(k);}}catch(p){l.error(p);}}};this.GloabalEventBus=sap.ui.getCore().getEventBus();if(this.oCardComponentData&&this.oCardComponentData.mainComponent){this.GloabalEventBus.subscribe("OVPGlobalfilter","OVPGlobalFilterSeacrhfired",t.eventhandler);}V.formatChartAxes();function f(d,h,L,W){var R;var m=h.oModel.getMetaModel();var M=m.getMetaContext(h.oModel.resolve(h.sPath,h.oContext));if(!d){return S.resolve();}if(d.aFilters){return S.all(d.aFilters.map(function(s){return f(s,h,L,d.bAnd);})).then(function(i){return w(i.join(d.bAnd?" and ":" or "),W&&!d.bAnd);});}R=m.resolve(r(d.sPath,L),M);return m.fetchObject(R).then(function(p){var i,s,j;if(!p){throw new Error("Type cannot be determined, no metadata for path: "+R);}j=d.sOperator;if(j===c.All||j===c.Any){i=d.oCondition;s=d.sVariable;if(j===c.Any&&!i){return d.sPath+"/any()";}L=Object.create(L);L[s]=r(d.sPath,L);return f(i,L).then(function(k){return d.sPath+"/"+d.sOperator.toLowerCase()+"("+s+":"+k+")";});}return g(d,p.$Type,W);});}function g(d,E,W){var s,h,T,v;function i(j){return T?"tolower("+j+")":j;}T=E==="Edm.String"&&d.bCaseSensitive===false;h=i(decodeURIComponent(d.sPath));v=i(b.formatLiteral(d.oValue1,E));switch(d.sOperator){case c.BT:s=h+" ge "+v+" and "+h+" le "+i(b.formatLiteral(d.oValue2,E));break;case c.NB:s=w(h+" lt "+v+" or "+h+" gt "+i(b.formatLiteral(d.oValue2,E)),W);break;case c.EQ:case c.GE:case c.GT:case c.LE:case c.LT:case c.NE:s=h+" "+d.sOperator.toLowerCase()+" "+v;break;case c.Contains:case c.EndsWith:case c.NotContains:case c.NotEndsWith:case c.NotStartsWith:case c.StartsWith:s=d.sOperator.toLowerCase().replace("not","not ")+"("+h+","+v+")";break;default:throw new Error("Unsupported operator: "+d.sOperator);}return s;}function w(s,W){return W?"("+s+")":s;}function r(p,L){var s=p.split("/");s[0]=L[s[0]];return s[0]?s.join("/"):p;}},onBeforeRendering:function(){if(this.bCardProcessed){return;}V.validateCardConfiguration(this);var v=this.getView().byId("analyticalChart");var d=this.getOwnerComponent().getComponentData();if(v){v.setHeight("21rem");}if(this.getCardPropertiesModel().getProperty("/layoutDetail")==="resizable"&&d&&d.appComponent){var D=d.appComponent.getDashboardLayoutUtil();var f=D.dashboardLayoutModel.getCardById(d.cardId);if(f.dashboardLayout.autoSpan&&v){v.setHeight("21rem");}}var g=this.getView().byId("vbLayout");var n;var i=false;var h=new F({data:{path:"/"}});this.isVizPropSet=i;this.oDataSet=h;this.vizFrame=v;this.vbLayout=g;if(!v){l.error(V.constants.ERROR_NO_CHART+": ("+this.getView().getId()+")");}else{this.vbLayout.setBusy(true);n=v.getModel('ovpCardProperties').getProperty("/navigation");if(n===undefined||n=="datapointNav"||n!="headerNav"){V.getSelectedDataPoint(v,this);}v.destroyDataset();var j=v.getParent().getBinding("data");this._handleKPIHeader();if(j&&j.getPath()){j.attachDataReceived(this.onDataReceived.bind(this));j.attachDataRequested(this.onDataRequested.bind(this));}else{sap.ui.core.Fragment.load("sap.ovp.cards.charts.generic.noData").then(function(k){var m=this.getCardContentContainer();m.removeAllItems();m.addItem(k);}.bind(this));}v.addEventDelegate({onmouseover:function(){var k=v._oOvpVizFrameTooltip;if(k){k._oPopup.close();}}});}this.bCardProcessed=true;},onAfterRendering:function(){C.prototype.onAfterRendering.apply(this,arguments);if(!O.checkIfAPIIsUsed(this)&&this.getCardPropertiesModel().getProperty("/layoutDetail")==="resizable"){var d=this.oDashboardLayoutUtil.dashboardLayoutModel.getCardById(this.cardId);var s=this.oDashboardLayoutUtil.getCardDomId(this.cardId);var f=document.getElementById(s);var h=this.getHeaderHeight();if(!d.dashboardLayout.autoSpan){if(f){var g=f.getElementsByClassName('sapOvpWrapper')[0];if(g){g.style.height=d.dashboardLayout.rowSpan*this.oDashboardLayoutUtil.ROW_HEIGHT_PX+2-(h+2*this.oDashboardLayoutUtil.CARD_BORDER_PX)+"px";}}}if(d.dashboardLayout.showOnlyHeader){f.classList.add("sapOvpMinHeightContainer");}var v=this.getView().byId("analyticalChart");if(v){v.setHeight(this._calculateVizFrameHeight()+"px");}}if(!O.checkIfAPIIsUsed(this)){var i=this.getCardPropertiesModel();var j=this.getOwnerComponent().getModel("ui").getData().cards;var r=[];if(this.getMetaModel().getData){var k=this.getMetaModel().getData()[this.getEntitySet().$Type];this.selectionVaraintFilter=b.getSelectionVariantFilters(j,i,this.getEntityType());}var m=this.oCardComponentData.mainComponent;if(m.getGlobalFilter()){r=b._getEntityRelevantFilters(k,m.oGlobalFilter.getFilters());}if(m.getMacroFilterBar()){var n=m.aFilters;r=b._getEntityRelevantFilters(k,n);}r=b.mergeFilters(r,this.selectionVaraintFilter);if(this.getCardItemsBinding()){this.getCardItemsBinding().filter(r);}if(this.getKPIBinding()){this.getKPIBinding().filter(r);}}},onDataReceived:function(E){if(U.checkIfDataExistInEvent(E)){var t=this;var d=this.getView().byId("analyticalChart");var f=this.getView().byId("bubbleText");var g=this.getView().byId("ovpCT");var h=a.getText("BUBBLESIZE");var j=t.getMetaModel().getData()["$Annotations"];this.oDataSet.bindData("analyticalmodel>/","");d.setDataset(this.oDataSet);var k=d.getParent();if(!this.isVizPropSet){V.buildVizAttributes(d,k,g,this);this.isVizPropSet=true;if(f!=undefined){var p=d.getFeeds();e(p,function(i,v){if(p[i].getUid()=="bubbleWidth"){f.setText(h+" "+p[i].getValues());}});}V.hideDateTimeAxis(d);}if(this.getCardPropertiesModel()&&this.getCardPropertiesModel().getData()&&this.getCardPropertiesModel().getData().colorPalette&&(d.getVizType()==="stacked_column")){var q=d.getDataset().getDimensions(),r=d.getFeeds(),s,u;for(var m=0;m<r.length;m++){if(r[m].getUid()==="color"){s=r[m].getValues()[0];break;}}for(var n=0;n<q.length;n++){if(q[n].getName()===s){u=q[n];break;}}if(s&&u){var w={};w["bDescending"]=true;u.setSorter(w);}}var x=this.getView().byId("ovpUoMTitle");var y=E?E.getSource().getCurrentContexts().map(function(i){return i&&i.getObject();}):null;V.setChartUoMTitle(d,y,x,j);if(this.bFlag==true){this.bFlag=false;this.vbLayout.setBusy(false);}else{setTimeout(function(){t.vbLayout.setBusy(false);},0);}V.checkNoData(E,this.getCardContentContainer(),d);}},onDataRequested:function(){this.vbLayout.setBusy(true);},getCardItemsBinding:function(){var v=this.getView().byId("analyticalChart");if(v&&v.getDataset()&&v.getDataset().getBinding("data")&&this.vbLayout){this.vbLayout.setBusy(false);}if(v&&v.getParent()){return v.getParent().getBinding("data");}return null;},resizeCard:function(n){var d=this.getCardPropertiesModel();this.newCardLayout=n;d.setProperty("/cardLayout/rowSpan",n.rowSpan);d.setProperty("/cardLayout/colSpan",n.colSpan);var f=this.getCardPropertiesModel().getProperty("/cardLayout");var h=this.getHeaderHeight();var s=this.getView().getDomRef().querySelectorAll(".sapOvpWrapper");for(var i=0;i<s.length;i++){s[i].style.height=(n.rowSpan*f.iRowHeightPx+2)-(h+2*f.iCardBorderPx)+"px";}var g=this.getView().byId("analyticalChart");var j=this.getView().byId("bubbleText");var k=this.getView().byId("ovpCT");if(g){if(g.getVizType()==='timeseries_bubble'||g.getVizType()==='bubble'){if(f.colSpan>1){j.setVisible(false);}else{j.setVisible(true);}}g.setHeight(this._calculateVizFrameHeight()+"px");}var m=this.getView().byId('ovpCardContentContainer').getDomRef();if(m){if(!n.showOnlyHeader){m.classList.remove('sapOvpContentHidden');}else{m.classList.add('sapOvpContentHidden');}}var p=a.getText("BUBBLESIZE");this.oDataSet.bindData("analyticalmodel>/","");this.vizFrame.setDataset(this.oDataSet);var q=g.getParent();if(!this.isVizPropSet){V.buildVizAttributes(g,q,k,this);this.isVizPropSet=true;if(j!=undefined){var r=g.getFeeds();e(r,function(i,v){if(r[i].getUid()=="bubbleWidth"){j.setText(p+" "+r[i].getValues());}});}V.hideDateTimeAxis(g);}V.reprioritizeContent(this.newCardLayout,g);},_calculateVizFrameHeight:function(){var v;var d=this.oDashboardLayoutUtil.dashboardLayoutModel.getCardById(this.cardId);var f=this.getView().byId("analyticalChart");if(d){var g=this.getView().getController();var D=this.getItemHeight(g,'toolbar');var h=this.getHeaderHeight();var i=this.getView().byId("ovpCT")?24:0;var B=(f.getVizType()==='timeseries_bubble'||f.getVizType()==="bubble")&&d.dashboardLayout.colSpan===1?43:0;v=d.dashboardLayout.rowSpan*this.oDashboardLayoutUtil.ROW_HEIGHT_PX+2-(h+2*this.oDashboardLayoutUtil.CARD_BORDER_PX+D+i+B+30);}return v;},refreshCard:function(){this.getView().rerender();}});});
