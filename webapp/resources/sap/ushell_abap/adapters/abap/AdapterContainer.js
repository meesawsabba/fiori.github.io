// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/util/ObjectPath","sap/base/Log","sap/ui/thirdparty/jquery","sap/ui/core/format/DateFormat","sap/ushell_abap/pbServices/ui2/ODataService"],function(O,L,q,D,a){"use strict";var c="PersContainers",A="yyyyMMddHHmmss",I=new Date(9999,1,1,0,0,0),s=new Date(9999,1,1,0,0,0,0),b="ADMIN#sap-ushell-container-expireUTCTimestamp",d="ADMIN#sap-ushell-container-storageUTCTimestamp",f="ADMIN#sap-ushell-container-scope";function r(C){var e="sap.ushell.personalization#";if(C.substring(0,e.length)!==e){L.error("Unexpected ContainerKey "+C);return C;}return C.substring(e.length,e.length+40);}var g=function(C,S,o,e){this._oService=S;this._oScope=o;this["sap-cache-id"]=O.get("_oService._oConfig.services.personalization.cacheId",this);this._sContainerKey=r(C);this._sAppName=e||"";var P=sap.ui.require("sap/ushell_abap/adapters/abap/PersonalizationAdapter");if(P){this._category=P.prototype._determineCategory(o);}this._oJSONContainer={"category":this._category,"clientExpirationTime":s,"appName":this._sAppName,"component":"","id":this._sContainerKey,PersContainerItems:[]};this._oPropertyBag={};this._aOperationQueue=[];};g.prototype._reset=function(){this._oJSONContainer.PersContainerItems=[];};g.prototype._obtainODataWrapper=function(){return this._oService._oWrapper;};g.prototype.load=function(){var o=new q.Deferred(),t=this,e=this._obtainODataWrapper(),R=c+"(category='"+this._category+"',id='"+encodeURIComponent(this._sContainerKey)+"')?$expand=PersContainerItems";if(this._category&&this._category==="P"&&this["sap-cache-id"]){R=R+"&sap-cache-id="+this["sap-cache-id"];}a.call(this,e,function(){return false;});e.read(R,function(i){t._oJSONContainer=i;t._oJSONContainer.category=t._category;t._oJSONContainer.id=t._sContainerKey;t._oJSONContainer.appName=t._sAppName;t._oJSONContainer.PersContainerItems=(t._oJSONContainer.PersContainerItems&&t._oJSONContainer.PersContainerItems.results)||[];o.resolve(t);},function(i){L.warning(i);t._reset();o.resolve(t);});return o.promise();};g.prototype.save=function(){var o=new q.Deferred(),t=this,e=this._obtainODataWrapper(),R=c;a.call(this,e,function(){return false;});e.create(R,this._oJSONContainer,function(){o.resolve(t);},function(i){o.reject(i);});return o.promise();};g.prototype.del=function(){var o=new q.Deferred(),t=this,e=this._obtainODataWrapper(),R=c+"(category='"+this._category+"',id='"+encodeURIComponent(this._sContainerKey)+"')";a.call(this,e,function(){return false;});e.del(R,function(i){o.resolve(t);},function(i){o.reject(i);});this._reset();return o.promise();};g.prototype.getItemKeys=function(){var e=[];this._oJSONContainer.PersContainerItems.forEach(function(m){if(m.category==="V"){e.push("VARIANTSET#"+m.id);}else if(m.category==="I"){e.push("ITEM#"+m.id);}});if(this._oJSONContainer.validity>=0){e.push(d);e.push(b);e.push(f);}return e;};g.prototype.containsItem=function(i){return this.getItemKeys().indexOf(i)>=0;};function h(e){if(e===undefined||e===null){return null;}var F=D.getDateInstance({pattern:A});return F.parse(JSON.parse(e),true);}function E(o){var F=D.getDateInstance({pattern:A});if(o===null){o=s;}if(typeof o==="string"){if(/\/Date\(([0-9]+)\)\//.exec(o)){o=new Date(parseInt(/\/Date\(([0-9]+)\)\//.exec(o)[1],10));}else{L.error("Expected Date format "+o);}}if(+o===+s){return undefined;}return F.format(o,true);}g.prototype._findItemIndex=function(e,C){var i;for(i=0;i<this._oJSONContainer.PersContainerItems.length;i=i+1){if(this._oJSONContainer.PersContainerItems[i].id===e&&this._oJSONContainer.PersContainerItems[i].category===C){return i;}}return undefined;};g.prototype._locateItem=function(i){var e={index:-1};if(i===b){return{containerProperty:"clientExpirationTime",initialValue:s,convToABAP:h,convFromABAP:E};}if(i===f){return{containerProperty:"validity",initialValue:0,convToABAP:function(o){if(!o){return null;}return JSON.parse(o).validity;},convFromABAP:function(v,o){if(v<=0){return undefined;}o=o||{};o.validity=v;return o;}};}if(i===d){return{containerProperty:" ignore",initialValue:I,convToABAP:h,convFromABAP:E};}if(i.indexOf("ITEM#")===0){e.trueItemKey=i.substring("ITEM#".length,"ITEM#".length+40);e.category="I";}else if(i.indexOf("VARIANTSET#")===0){e.trueItemKey=i.substring("VARIANTSET#".length,"VARIANTSET#".length+40);e.category="V";}else if(i.indexOf("ADMIN#")!==0){L.error("Unknown itemkey prefix"+i);}e.index=this._findItemIndex(e.trueItemKey,e.category);return e;};g.prototype.getItemValue=function(i){var j="",o,k=this._locateItem(i);if(k.containerProperty===" ignore"){return undefined;}if(k.index>=0){j=this._oJSONContainer.PersContainerItems[k.index].value;try{o=JSON.parse(j);}catch(e){if(j==="X"){o=true;}else{o=undefined;}}}if(k.containerProperty){if(typeof k.convFromABAP==="function"){return k.convFromABAP(this._oJSONContainer[k.containerProperty],o);}return this._oJSONContainer[k.containerProperty];}return o;};g.prototype.setItemValue=function(i,o){var e=JSON.stringify(o),j=this._locateItem(i);if(j.containerProperty===" ignore"){return;}if(j.containerProperty){if(typeof j.convToABAP==="function"){this._oJSONContainer[j.containerProperty]=j.convToABAP(e);}else{this._oJSONContainer[j.containerProperty]=e;}if(!j.trueItemKey){return;}}if(j.index>=0){this._oJSONContainer.PersContainerItems[j.index].value=e;return;}this._oJSONContainer.PersContainerItems.push({"value":e,"id":j.trueItemKey,"category":j.category,"containerId":this._sContainerKey,"containerCategory":this._category});};g.prototype.delItem=function(i){var o=this._locateItem(i);if(o.containerProperty===" ignore"){return;}if(o.containerProperty){this._oJSONContainer[o.containerProperty]=o.initialValue;return;}if(o.index>=0){this._oJSONContainer.PersContainerItems.splice(o.index,1);return;}};return g;},true);
