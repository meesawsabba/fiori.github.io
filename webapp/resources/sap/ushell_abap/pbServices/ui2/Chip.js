// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell_abap/pbServices/ui2/Bag","sap/ushell_abap/pbServices/ui2/Utils","sap/ushell_abap/pbServices/ui2/Error","sap/ushell_abap/pbServices/ui2/ChipDefinition","sap/base/Log","sap/ui/thirdparty/jquery"],function(B,U,S,C,L,q){"use strict";var c={};function g(n){return Object.prototype.hasOwnProperty.call(c,n)?c[n]:null;}var a=function(A,f){var t=this,b,s,o,d,E,h,l,r,w;function j(){if(!d){throw new S(t+": CHIP is just a stub","sap.ushell_abap.pbServices.ui2.Chip");}}function k(R){var i;b=new U.Map();if(!R){return;}for(i=0;i<R.length;i+=1){b.put(R[i].id,new B(f,R[i]));}}function m(i){var e=i.basePath,n,M,N,v=i.viewName;if(i.componentName){i.$Namespace=i.componentName;}else{M=/^(?:([^\/]+)\/)?(.*)\.view\.(.*)$/.exec(v);if(!M){throw new S(t+": Illegal view name: "+v,"Chip");}N=M[1];v=M[2];i.$ViewType=M[3].toUpperCase();if(N){v=N+"."+v;}else{n=v.lastIndexOf(".");if(n<1){throw new S(t+": Missing namespace: "+v,"Chip");}N=v.substring(0,n);}i.$Namespace=N;i.$ViewName=v;}var V=i.virtualNamespace;if(V){i.$VirtualNamespace=V;}i.$UrlPrefix=i.$Namespace.replace(/\./g,"/");if(e!=="."){e=e.replace(/\/?$/,"/");i.$UrlPrefix=e+i.$UrlPrefix;}i.$UrlPrefix=t.toAbsoluteUrl(i.$UrlPrefix);}function p(){o={};if(d.contracts.configuration&&d.contracts.configuration.parameters){o=JSON.parse(JSON.stringify(d.contracts.configuration.parameters));}t.updateConfiguration(o,A.configuration);}function u(n){var i,e;if(d){throw new S(t+": cannot initialize twice",null,"Chip");}d=n;d.contracts=d.contracts||{};if(!d.implementation||!d.implementation.sapui5){throw new S(t+": Missing SAPUI5 implementation","Chip");}m(d.implementation.sapui5);p();L.debug("Initialized: "+t,null,"Chip");if(l){for(i=0,e=l.length;i<e;i+=2){l[i]();}l=null;}}this.updateBags=function(R){var i,K,e=b.keys();for(i=0;i<R.length;i+=1){K=R[i].id;if(b.containsKey(K)){b.get(K).update(R[i]);e.splice(e.indexOf(K),1);}else{b.put(K,new B(f,R[i]));}}for(i=0;i<e.length;i+=1){b.remove(e[i]);}};this.createApi=function(e,i){var n={},v,I,N,R;j();R=d.contracts;if(R){for(N in R){if(Object.prototype.hasOwnProperty.call(R,N)){I=g(N);if(!I){throw new S(this+": Contract '"+N+"' is not supported","Chip");}n[N]={};v=I.call(n[N],e);if(i){i.put(N,v);}}}}return n;};this.getAvailableTypes=function(){var T;j();if(d.contracts.types&&d.contracts.types.parameters&&typeof d.contracts.types.parameters.supportedTypes==="string"&&d.contracts.types.parameters.supportedTypes!==""){T=d.contracts.types.parameters.supportedTypes.toLowerCase();return T.split(",");}return[];};this.getDefaultType=function(){var e=this.getAvailableTypes();if(d.contracts.types&&d.contracts.types.parameters&&typeof d.contracts.types.parameters.defaultType==="string"&&d.contracts.types.parameters.defaultType!==""){var D=d.contracts.types.parameters.defaultType;D=D.toLowerCase();if(e.indexOf(D)>-1){return D;}throw new S("The chip has the default type: "+D+" which is not supported");}if(e.indexOf("tile")>-1){return"tile";}if(e.length>0){return e[0];}return"";};this.getBag=function(e){if(!e){throw new S("Missing bag ID","Chip");}return b.get(e);};this.getBagIds=function(){return b.keys();};this.getBaseChipId=function(){return A.baseChipId;};this.getCatalog=function(){if(r){return r;}return A.$proxy?undefined:f.createCatalog(A.catalogId);};this.getConfigurationParameter=function(K){j();return o[K];};this._getChipRawConfigurationString=function(){return A.configuration;};this.getDescription=function(){return A.description;};this.getId=function(){return A.id;};this.getImplementationAsSapui5=function(e){var D,i,n;j();D={chip:e};i=d.implementation.sapui5;n=this.getBaseChipId();if((n!=="X-SAP-UI2-CHIP:/UI2/STATIC_APPLAUNCHER")&&(n!=="X-SAP-UI2-CHIP:/UI2/DYNAMIC_APPLAUNCHER")){if(i.$VirtualNamespace){i.$absolutePath=this.toAbsoluteUrl(i.basePath);q.sap.registerModulePath(i.$Namespace,i.$absolutePath);}else{q.sap.registerModulePath(i.$Namespace,i.$UrlPrefix);}}if(i.componentName){return new sap.ui.core.ComponentContainer({component:sap.ui.getCore().createComponent({componentData:D,name:i.componentName})});}return sap.ui.view({type:i.$ViewType,viewName:i.$ViewName,viewData:D});};this.getRemoteCatalog=function(){return r;};this.getTitle=function(){return A.title||(d&&d.appearance&&d.appearance.title);};this.isBasedOn=function(e){var i="X-SAP-UI2-PAGE:"+e.getPage().getId()+":"+e.getId();function n(v){return v===i||v.indexOf(i+":")===0;}return(A.referenceChipId&&n(A.referenceChipId))||n(A.id);};this.isReference=function(){return!!A.referenceChipId;};this.isBrokenReference=function(){return A.referenceChipId==="O";};this.isStub=function(){return!d;};this.load=function(e,F){function v(z,D){E=z;h=D;var i,n;if(l){for(i=1,n=l.length;i<n;i+=2){l[i](z,D);}l=null;}}function x(){if(f){f.createChipDefinition(A.url,u,v);return;}U.get(A.url,true,function(X){L.debug("Loaded: "+t,null,"Chip");u(new C(X));},v);}function y(){if(!A.url){if(w){throw new S("Remote catalog did not deliver CHIP '"+A.id+"'","Chip");}throw new S("Missing module URL","Chip");}w=false;s=U.absoluteUrl(A.url);x();}if(!this.isStub()){throw new S("Chip is not a stub anymore","Chip");}if(typeof e!=="function"){throw new S("Missing success handler","Chip");}F=F||f.getPageBuildingService().getDefaultErrorHandler();if(E){U.callHandler(F.bind(null,E,h),null,true);return;}if(l){l.push(e,F);return;}if(A.url){x();}else if(A.remoteCatalogId){this.getRemoteCatalog().readRegisteredChips(y,v);w=true;}else{f.getPageBuildingService().readChip(A.id,function(R){A=R;y();},v);}l=[e,F];};this.refresh=function(e,F){function i(N){A.title=N.title;A.configuration=N.configuration;A.referenceChipId=N.referenceChipId;k(N.ChipBags&&N.ChipBags.results);if(!t.isStub()){t.updateConfiguration(o,A.configuration);}e();}function n(R){if(R.results[0]){i(R.results[0]);}else{F=F||f.getPageBuildingService().getDefaultErrorHandler();F("Could not refresh CHIP. No update received from catalog "+A.remoteCatalogId);}}if(typeof e!=="function"){throw new S("Missing success handler","Chip");}if(!A.url){throw new S(t+": CHIP is just a stub","Chip");}if(A.remoteCatalogId){this.getRemoteCatalog().readChips([A.id],n,F);}else{f.getPageBuildingService().readChip(A.id,i,F);}};this.update=function(n){if(typeof n!=="object"||n.id!==this.getId()){throw new S("Invalid update data: "+this,"Chip");}if(n.ChipBags&&n.ChipBags.results){this.updateBags(n.ChipBags&&n.ChipBags.results);}if(A.url){return;}if(!n.url){return;}A=n;s=U.absoluteUrl(A.url);L.debug("Updated: "+this,null,"Chip");};this.updateConfiguration=function(P,v){var i,K,V;if(!v){return;}if(typeof v==="string"){try{i=JSON.parse(v);}catch(e){L.warning(this+': ignoring invalid configuration "'+v+'"',null,"Chip");return;}}else{i=v;}for(K in i){if(Object.prototype.hasOwnProperty.call(i,K)){if(Object.prototype.hasOwnProperty.call(o,K)){V=i[K];if(V===undefined){delete P[K];}else if(typeof V!=="string"){throw new S("Value for '"+K+"' must be a string","Chip");}else{P[K]=V;}}else{L.warning(this+": ignoring unknown configuration parameter "+K,null,"Chip");}}}};this.toAbsoluteUrl=function(e){return U.absoluteUrl(e,s);};this.toString=function(v){var R=['Chip({sChipUrl:"',s,'"'];if(v){R.push(",oAlterEgo:",JSON.stringify(A),",oBags:",b.toString(),",oDefinition:",JSON.stringify(d));}R.push("})");return R.join("");};this.isInitiallyDefined=function(D){return D;}.bind(null,A&&!A.hasOwnProperty("$proxy"));if(!A){throw new S("Missing CHIP description","Chip");}s=U.absoluteUrl(A.url);if(A.remoteCatalogId){r=f.createCatalog(A.remoteCatalogId);if(!A.url){r.registerChip(this);}}k(A.ChipBags&&A.ChipBags.results);L.debug("Created: "+this,null,"Chip");};a.addContract=function(n,i){if(g(n)){throw new S("Cannot register contract '"+n+"' twice","Chip");}c[n]=i;};a.removeContract=function(n){delete c[n];};if(q&&q.sap){q.sap.declare("sap.ui2.srvc.chip");q.sap.declare("sap.ui2.srvc.Chip");sap.ui2.srvc.Chip=sap.ui2.srvc.chip=a;}return a;},true);
