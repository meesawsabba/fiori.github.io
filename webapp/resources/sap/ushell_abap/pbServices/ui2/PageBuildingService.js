// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell_abap/pbServices/ui2/Utils","sap/ushell_abap/pbServices/ui2/ODataService","sap/ushell_abap/pbServices/ui2/ODataWrapper","sap/ushell_abap/pbServices/ui2/Error"],function(U,O,a,S){"use strict";var P=function(o,d,I){var w,t=this;function e(s){return s.replace(/'/g,"''").replace(/&/g,"%26");}function g(p,b,E){var s;if(typeof p==="string"){s=p;}else{if(p.instanceId){return"ChipInstanceBags(pageId='"+encodeURIComponent(p.pageId)+"',instanceId='"+encodeURIComponent(p.instanceId)+"',id='"+encodeURIComponent(b)+"')"+(E?"?$expand=ChipInstanceProperties":"");}s=p.id;}return"Bags(pageId='"+encodeURIComponent(s)+"',id='"+encodeURIComponent(b)+"')"+(E?"?$expand=Properties":"");}P.extractBatchResponseEntry=function(E){if(E.statusCode==="201"){return E.data;}if(E.statusCode==="204"){return undefined;}return E.message||"";};this.batch=function(c,G,s,f){var r=[];function b(R){var i,h=[];for(i=0;i<R.length;i+=1){h[i]=P.extractBatchResponseEntry(R[i]);}return h;}s=s||function(){};f=f||t.getDefaultErrorHandler();w.check(s,f);c=c||[];G=G||[];if(c.length>0){r.push({__changeRequests:c});}r=r.concat(G);if(r.length===0){U.callHandler(s.bind(null,[],[]),f,true);return;}w.batch({__batchRequests:r},function(D){var B=D.__batchResponses,C=B[0].__changeResponses;if(B[0].response&&B[0].message){w.onError("POST",w.getBaseUrl()+"$batch",f,undefined,D.__batchResponses[0]);return;}if((C&&(C.length!==c.length))||(B.length!==r.length)){f("Number of requests differs from number of responses in $batch");return;}if(C){U.callHandler(s.bind(null,b(C),b(B.slice(1))),f,false);}else{U.callHandler(s.bind(null,[],b(B)),f,false);}},f);};this.isPersonalization=function(){return!!I;};this.readMetadata=function(s,f,n){var r=w.getBaseUrl()+"$metadata"+(n?"?"+Date.now():"");f=f||this.getDefaultErrorHandler();w.check(s,f);OData.read(r,function(D){U.callHandler(s.bind(null,D),f);},w.onError.bind(w,"GET",r,f,undefined),OData.metadataHandler);};this.deleteBag=function(p,b,s,f){if(!p){throw new S("Missing parent ID or object","PageBuildingService");}if(!b){throw new S("Missing bag ID","PageBuildingService");}w.del(g(p,b,false),s,f);};this.readBag=function(p,b,s,f){if(!p){throw new S("Missing parent ID or object","PageBuildingService");}if(!b){throw new S("Missing bag ID","PageBuildingService");}w.read(g(p,b,true),s,f);};this.readAllCatalogs=function(p,s,f,F,b,c){var h="id";c=c===undefined?true:c;if(b&&typeof b==="string"){h=b;}var u="Pages('"+encodeURIComponent(p)+"')/allCatalogs?$expand=Chips/ChipBags/ChipProperties&"+"$orderby="+h;if(F&&typeof F==="string"){u=u+"&$filter="+encodeURIComponent(F);}if(this.readAllCatalogs.cacheBusterTokens&&this.readAllCatalogs.cacheBusterTokens.get(p)){u+="&sap-cache-id="+this.readAllCatalogs.cacheBusterTokens.get(p);}w.read(u,s,f,c);};this.readCatalogs=function(s,f,F){var u="Catalogs?$orderby=id";if(F&&typeof F==="string"){u=u+"&$filter="+encodeURIComponent(F);}w.read(u,s,f);};this.readAllCatalogsForUser=function(f,s,F){var u=f?"?$filter="+encodeURIComponent(f):"";w.read("Pages('unused')/allCatalogs"+u,s,F);};this.getReferencingCatalogIds=function(r,s,f){if(typeof s!=="function"){s=f;f=arguments[3];}function b(R){var c=[],h=R.results||[];h.forEach(function(C){if(C.referenceChipId===r){if(c.indexOf(C.catalogId)===-1){c.push(C.catalogId);}}});s(c);}if(typeof r!=="string"){throw new S("sReferencedChipId must be a string","PageBuildingService");}if(typeof s!=="function"){throw new S("fnSuccess is mandatory","PageBuildingService");}w.read("Chips?$filter="+encodeURIComponent("referenceChipId eq '"+e(r)+"'"),b,function(m){new S(m,"PageBuildingService");f.apply(null,arguments);});};this.createPageBasedCatalog=function(D,T,s,f){if(!D){throw new S("Missing domain ID","PageBuildingService");}w.create("Catalogs",{domainId:D,title:T,type:"CATALOG_PAGE"},s,f);};this.createCatalog=function(c,s,f){w.create("Catalogs",c,s,f);};this.deleteCatalog=function(c,s,f){w.del(c,s,f);};this.cloneCatalog=function(c,n,N,s,f){if(!c){throw new S("Missing source catalog ID","PageBuildingService");}if(!n){throw new S("Missing new domain ID","PageBuildingService");}if(n.indexOf(":")>=0){throw new S("Illegal domain ID: "+n,"PageBuildingService");}w.create("CloneCatalog?sourceId='"+encodeURIComponent(c)+"'&targetId='"+encodeURIComponent(n)+(N!==undefined?"'&title='"+encodeURIComponent(N)+"'":"'"),{},s,f);};this.clonePageChipInstance=function(s,b,T,f,F){if(!s){throw new S("Missing source page ID","PageBuildingService");}if(!b){throw new S("Missing source CHIP instance ID","PageBuildingService");}if(!T){throw new S("Missing target page ID","PageBuildingService");}w.create("ClonePageChipInstance?sourcePageId='"+encodeURIComponent(s)+"'&sourceChipInstanceId='"+encodeURIComponent(b)+"'&targetPageId='"+encodeURIComponent(T)+"'",{},function(r){w.read("PageChipInstances(pageId='"+encodeURIComponent(r.pageId)+"',instanceId='"+encodeURIComponent(r.instanceId)+"')"+"?$expand=ChipInstanceBags/ChipInstanceProperties",f,F);},F);};this.readCatalog=function(c,s,f,n,N){var u;if(!c){throw new S("Missing catalog ID","PageBuildingService");}u="Catalogs('"+encodeURIComponent(c)+"')";if(!n){u+="?$expand=Chips";if(!N){u+="/ChipBags/ChipProperties";}}w.read(u,s,f);};this.updateCatalog=function(c,s,f){w.update(c,s,f);};this.readCatalogChips=function(c,C,s,f){var u,F="",p="?$filter=";if(!c){throw new S("Missing catalog ID","PageBuildingService");}u="Catalogs('"+encodeURIComponent(c)+"')/Chips";if(C){if(!C.length){throw new S("No CHIP IDs given","PageBuildingService");}C.forEach(function(i){F=F+p+"id%20eq%20'"+encodeURIComponent(i)+"'";p="%20or%20";});if(w.getBaseUrl().length+u.length+F.length>2000){F="";}}w.read(u+F,s,f);};this.createPage=function(i,c,l,T,s,f){if(!i){throw new S("Missing page ID","PageBuildingService");}w.create("Pages",{id:i,catalogId:c,layout:l,title:T},s,f);};this.readPages=function(s,f,n){var u="Pages?";if(!n){u+="$expand=Catalog&";}w.read(u+"$orderby=id",s,f);};this.readPage=function(i,s,f,c){var u="Pages('"+encodeURIComponent(i)+"')";if(!i){throw new S("Missing page ID","PageBuildingService");}if(c===undefined){u+="?$expand=Bags/Properties,PageChipInstances/Chip/ChipBags/ChipProperties,"+"PageChipInstances/RemoteCatalog,"+"PageChipInstances/ChipInstanceBags/ChipInstanceProperties";}else if(c!==""){u+="?$expand="+c;}w.read(u,s,f);};this.readPageSet=function(i,s,f,c){var u;var t=this;var b;c=c===undefined?true:c;if(!i){throw new S("Missing page set ID","PageBuildingService");}u="PageSets('"+encodeURIComponent(i)+"')?$expand="+"Pages/PageChipInstances/Chip/ChipBags/ChipProperties,"+"Pages/PageChipInstances/RemoteCatalog,"+"Pages/PageChipInstances/ChipInstanceBags/ChipInstanceProperties,"+"AssignedPages,"+"DefaultPage";if(this.readPageSet.cacheBusterTokens&&this.readPageSet.cacheBusterTokens.get(i)){u+="&sap-cache-id="+this.readPageSet.cacheBusterTokens.get(i);}if(this.readPageSet.appendedParameters){b=Object.keys(this.readPageSet.appendedParameters);if(b.length>0){b.sort();b.forEach(function(k){u+="&"+encodeURIComponent(k)+"="+encodeURIComponent(t.readPageSet.appendedParameters[k]);});}}w.read(u,s,f,c);};this.updatePageSet=function(p,s,f){w.update(p,s,f);};this.createPageInPageSet=function(p,s,c,f,F){if(!p){throw new S("Missing page set ID","PageBuildingService");}w.create("PageSets('"+encodeURIComponent(p)+"')/Pages",{catalogId:c||"",layout:"",title:s||""},f,F);};this.updatePage=function(p,s,f){w.update(p,s,f);};this.deletePage=function(i,s,f){if(!i){throw new S("Missing page ID","PageBuildingService");}w.del("Pages('"+encodeURIComponent(i)+"')",s,f);};this.createPageChipInstance=function(p,i,c,T,C,l,s,f){this.createPageChipInstanceFromRawData({pageId:p,instanceId:i,chipId:c,title:T,configuration:C,layoutData:l},s,f);};this.createPageChipInstanceFromRawData=function(c,s,f){if(typeof c!=="object"){throw new S("Invalid raw data","PageBuildingService");}if(!c.pageId){throw new S("Missing page ID","PageBuildingService");}if(!c.chipId){throw new S("Missing CHIP ID","PageBuildingService");}c.instanceId=c.instanceId||"";c.title=c.title||"";c.configuration=c.configuration||"";c.layoutData=c.layoutData||"";w.create("PageChipInstances",c,s,f);};this.updatePageChipInstance=function(c,s,f){w.update(c,s,f);};this.deletePageChipInstance=function(p,i,s,f){if(!p){throw new S("Missing page ID","PageBuildingService");}if(!i){throw new S("Missing instance ID","PageBuildingService");}w.del("PageChipInstances(pageId='"+encodeURIComponent(p)+"',instanceId='"+encodeURIComponent(i)+"')",s,f);};this.updateBagProperties=function(p,b,c,n,r,s,f){var C=[],G=[],i,h,j,R,m="__metadata";function k(E){var l={__metadata:{type:E[m].type,uri:E[m].uri}},q;for(q in E){if(Object.prototype.hasOwnProperty.call(E,q)&&q!==m&&q.indexOf("$")!==0&&typeof E[q]!=="object"){l[q]=E[q];}}return l;}if(!p){throw new S("Missing parent object","PageBuildingService");}if(!b){throw new S("Missing bag ID","PageBuildingService");}if(typeof r==="function"){this.updateBagProperties(p,b,c,n,[],r,s);return;}c=c||[];n=n||[];r=r||[];if(c.length===0&&n.length===0&&r.length===0){throw new S("No properties to update, create or reset","PageBuildingService");}for(i=0;i<c.length;i+=1){j=c[i];R=j[m].uri;h=R.indexOf(w.getBaseUrl());if(h>=0){R=R.slice(h+w.getBaseUrl().length);}C.push({requestUri:R,method:"PUT",data:k(j)});}R=p.instanceId?"ChipInstanceProperties":"Properties";for(i=0;i<n.length;i+=1){j=n[i];if(!j.name){throw new S("Missing property name","PageBuildingService");}if(p.instanceId){j.instanceId=p.instanceId;j.pageId=p.pageId;}else{j.pageId=p.id;}j.bagId=b;C.push({requestUri:R,method:"POST",data:j});}for(i=0;i<r.length;i+=1){j=r[i];R=j[m].uri;h=R.indexOf(w.getBaseUrl());if(h>=0){R=R.slice(h+w.getBaseUrl().length);}C.push({requestUri:R,method:"DELETE"});G.push({requestUri:R,method:"GET"});}this.batch(C,G,function(l,q){var u=l.slice(n.length+c.length),i;for(i=0;i<u.length;i+=1){if(u[i]===undefined){if(typeof q[i]==="object"){u[i]=q[i];}}}if(s){s(l.slice(0,c.length),l.slice(c.length,n.length+c.length),u);}},f);};this.createProperty=function(p,b,s,v,T,f,F){var c;if(!p){throw new S("Missing parent ID or object","PageBuildingService");}if(!b){throw new S("Missing bag ID","PageBuildingService");}if(!s){throw new S("Missing property name","PageBuildingService");}if(typeof T==="function"){this.createProperty(p,b,s,v,undefined,T,f);return;}c={bagId:b,name:s,pageId:p,translatable:T,value:v};if(typeof p!=="string"){if(p.instanceId){c.instanceId=p.instanceId;c.pageId=p.pageId;}else{c.pageId=p.id;}}w.create((c.instanceId?"ChipInstanceProperties":"Properties"),c,f,F);};this.updateProperty=function(p,s,f){w.update(p,s,f);};this.deleteProperty=function(p,s,f){w.del(p,s,f);};this.readChip=function(c,s,f){if(!c){throw new S("Missing CHIP ID","PageBuildingService");}w.read("Chips('"+encodeURIComponent(c)+"')"+"?$expand=ChipBags/ChipProperties",s,f);};if(typeof o==="string"){w=P._createODataWrapper(o,this);}else{w=o;}this.readAllCatalogs.cacheBusterTokens=new U.Map();this.readPageSet.cacheBusterTokens=new U.Map();if(!w.isStickySessionEnabled()&&!I){w.enableStickySession();}O.call(this,w,d);};P._createODataWrapper=function(o,b){return new a(o,b,true);};P.createPageBuildingService=function(b,d,i){return new P(b,d,i);};return P;},true);
