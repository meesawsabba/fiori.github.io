// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell_abap/pbServices/ui2/Utils","sap/ushell_abap/pbServices/ui2/Error","sap/base/Log"],function(U,S,L){"use strict";var B=function(f,a,p,c){var P,r=false,s=false,t=this;function e(){if(r){throw new S("The previous reset operation is not finished yet","Bag");}}function b(){if(s){throw new S("The previous save operation is not finished yet","Bag");}}function d(o,A){var j=(o.Properties&&o.Properties.results)||(o.ChipInstanceProperties&&o.ChipInstanceProperties.results)||(o.ChipProperties&&o.ChipProperties.results)||[];P=P||new U.Map();j.forEach(function(k){var n=k.name,O;if(!A||A.containsKey(n)){O=P.put(n,k);k.$currentValue=O?O.$currentValue:k.value;}});delete o.ChipInstanceProperties;delete o.ChipProperties;delete o.Properties;}function g(n,T){var N;if(n.length===0){P.keys().forEach(function(k){if(T===(P.get(k).translatable==="X")){n.push(k);}});return n;}N=new U.Map();n.forEach(function(k){N.put(k);});P.keys().forEach(function(k){if(T===(P.get(k).translatable==="X")){N.put(k);}});return N.keys();}function h(){if(a.instanceId){return{pageId:a.pageId,instanceId:a.instanceId};}return{id:a.pageId};}function i(j,v,T){var o;if(!j){throw new S("Property name must not be empty","sap.ushell_abap.pbServices.ui2.Bag");}if(typeof j!=="string"){throw new S("Property name must be a string","sap.ushell_abap.pbServices.ui2.Bag");}o=P.get(j);if(o&&((o.translatable==="X")!==T)){throw new S("'"+j+"' already exists as a "+(T?"non-translatable":"translatable text")+" property","sap.ushell_abap.pbServices.ui2.Bag");}if(typeof v!=="string"){throw new S("Property value must be a string","sap.ushell_abap.pbServices.ui2.Bag");}e();if(!o){o={name:j,translatable:(T?"X":" ")};P.put(j,o);}o.$currentValue=v;return t;}this.getId=function(){return a.id;};this.getOwnPropertyNames=function(){return g([],false);};this.getOwnTextNames=function(){return g([],true);};this.getProperty=function(j,D){var o=P.get(j);if(o&&(o.translatable==="X")){throw new S("'"+j+"' is a translatable text property","sap.ushell_abap.pbServices.ui2.Bag");}if(o){return o.$currentValue;}if(p){return p.getProperty(j,D);}return D;};this.getPropertyNames=function(){var j=p?p.getPropertyNames():[];return g(j,false);};this.getText=function(T){var o=P.get(T);if(o&&(o.translatable!=="X")){throw new S("'"+T+"' is a non-translatable property","sap.ushell_abap.pbServices.ui2.Bag");}if(o){return o.$currentValue;}if(p){return p.getText(T);}return T;};this.getTextNames=function(){var T=p?p.getTextNames():[];return g(T,true);};this.reset=function(j,E){var o=h(),k=f.getPageBuildingService();function l(m){r=false;a=m;P=undefined;d(a);if(c){c(t);}j();}if(typeof j!=="function"){throw new S("Missing success handler","sap.ushell_abap.pbServices.ui2.Bag");}b();e();r=true;E=E||k.getDefaultErrorHandler();if(a.$tmp){U.callHandler(l.bind(null,a),E,true);return;}k.deleteBag(o,a.id,function(){a.$tmp=true;k.readBag(o,a.id,l,l.bind(null,a));},function(){r=false;E.apply(null,arguments);});};this.resetProperty=function(j){var o;o=P.get(j);if(o){o.$currentValue=undefined;if(!Object.prototype.hasOwnProperty.call(o,"value")){P.remove(j);}}return this;};this.save=function(j,E){var n=0,R=new U.Map(),m={},k={},o=h(),l=f.getPageBuildingService();if(typeof j!=="function"){throw new S("Missing success handler","sap.ushell_abap.pbServices.ui2.Bag");}if(typeof E!=="function"){throw new S("Missing error handler","sap.ushell_abap.pbServices.ui2.Bag");}b();e();l.openBatchQueue();P.keys().forEach(function(N){var u,q=P.get(N);function v(M,w){m[N]=M;k[N]=w;}if(q.$currentValue!==q.value){n+=1;if(Object.prototype.hasOwnProperty.call(q,"value")){if(q.$currentValue===undefined){R.put(N);l.deleteProperty(q,function(){if(q.$currentValue===undefined){P.remove(N);}else{delete q.value;}},v);}else{u=JSON.parse(JSON.stringify(q));u.value=q.$currentValue;l.updateProperty(u,function(){q.value=u.value;},v);}}else{l.createProperty(o,a.id,N,q.$currentValue,q.translatable,function(w){w.$currentValue=q.$currentValue;P.put(N,w);},v);}}});if(R.keys().length){l.readBag(o,a.id,function(q){d(q,R);});}s=true;l.submitBatchQueue(function(){s=false;if(c&&n>Object.keys(m).length){c(t);}if(Object.keys(m).length>0){E(m,k);}else{a.$tmp=false;j();}});};this.setProperty=function(j,v){return i(j,v,false);};this.setText=function(T,j){return i(T,j,true);};this.toString=function(v){var R=['Bag({id:"',a.id,'",pageId:"',a.pageId];if(a.instanceId){R.push('",instanceId:"',a.instanceId);}R.push('"');if(v){R.push(",oAlterEgo:",JSON.stringify(a));R.push(",oPropertiesByName:",P.toString());R.push(",bResetting:",r);R.push(",bSaving:",s);}R.push("})");return R.join("");};this.update=function(o){if(!o||a.id!==o.id){throw new S("Bag data belongs to another bag","sap.ushell_abap.pbServices.ui2.Bag");}P=undefined;d(o);};d(a);L.debug("Created: "+this,null,"sap.ushell_abap.pbServices.ui2.Bag");};sap.ui2=sap.ui2||{};sap.ui2.srvc=sap.ui2.srvc||{};sap.ui2.srvc.bag=B;return B;},true);
