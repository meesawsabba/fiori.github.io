// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/datajs","sap/ushell_abap/pbServices/ui2/Utils","sap/ushell_abap/pbServices/ui2/ODataService","sap/ushell_abap/pbServices/ui2/Error","sap/base/Log"],function(d,U,O,S,L){"use strict";function n(){}function r(D,R){if(U.isArray(D)){D.forEach(function(o){o.reject(R);});}else{D.reject(R);}}var a;a=function(s,o){var b="saplb",B,C,D,t=this,e,f;function g(A){var s={};s.baseUrl=A[0];if(typeof A[2]==="boolean"){s.supportsChangeSets=A[2];}return s;}this.getBatchQueue=function(){return B;};a.headerValue=function(K,H){K=K.toLowerCase();for(var i in H){if(Object.prototype.hasOwnProperty.call(H,i)&&i.toLowerCase()===K){return H[i];}}return undefined;};function k(H){var i=s["sap-language"]||a["sap-language"],j=s["sap-statistics"]||a["sap-statistics"],m=s["sap-client"]||a["sap-client"];H=H||{};if(i){H["sap-language"]=i;}if(j||(j==="false")){H["sap-statistics"]=""+j;}if(m){H["sap-client"]=m;}return H;}function l(H){H=H||{};var i=a.oStickySessionConfiguration[e];if(typeof i==="undefined"){return H;}if(i&&i.enabled&&typeof i.value!=="undefined"){H[b]=i.value;}return H;}this.detectStickySession=function(R){var H,i=a.oStickySessionConfiguration[e];if(!i||!i.enabled){return;}H=a.headerValue(b,R);if(typeof H==="undefined"){return;}if(i.value!==H){i.value=H;}};a.csrfTokenValue=function(H){var i=a.headerValue("x-csrf-token",H);if(i==="Required"){return i;}var j=a.headerValue("cache-control",H);if(j===undefined||j.indexOf("max-age=0")>-1||j.indexOf("no-cache")>-1){return i||"";}return"";};this.doRequest=function(R,m,p,i,F,H,I){var j;i=i||n;F=F||o.getDefaultErrorHandler();t.check(i,F);j={Accept:"application/json","Accept-Language":(sap.ui&&sap.ui.getCore().getConfiguration().getLanguage())||"","X-CSRF-Token":o.getCsrfToken()};k(j);l(j);OData.request({requestUri:R,method:m,data:p,headers:j},function(q,u){this.detectStickySession((u||{}).headers);L.debug("Received OData response for "+m+' "'+R+'"',null,"ODataWrapper");U.callHandler(i.bind(null,q),F);}.bind(this),function(E){function q(){F.apply(null,arguments);}function u(){i.apply(null,arguments);}if(!I&&E.response.statusCode===403&&a.csrfTokenValue(E.response.headers).toLowerCase()==="required"){L.debug("CSRF token required for "+m+' "'+R+'", refreshing it',JSON.stringify(E.response),"ODataWrapper");o.refreshCsrfToken(this.doRequest.bind(t,R,m,p,u,q,H,true),q);}else{t.onError(m,R,F,null,E);}}.bind(this),H);L.debug("Sent OData request for "+m+' "'+R+'"',null,"ODataWrapper");};this.toRelativeUrl=function(R){var i=R.indexOf(e);if(i<0){throw new S('Not relative to base URL "'+e+'": '+R,"ODataWrapper");}return R.slice(i+e.length);};this.toRequestUrl=function(R){if(/^\//.test(R)){throw new S("Not a relative URL: "+R,"ODataWrapper");}return e+R;};this.readOrBatch=function(R,i,j){var m,p=this.toRequestUrl(R),H=l(k());if(B){L.debug('Queued OData request for GET "'+R+'"',null,"ODataWrapper");B.push({method:"GET",requestUri:R,headers:H});m=(new jQuery.Deferred()).done(i).fail(j);D.push(m);C=false;return;}H.Accept="application/json";H["Accept-Language"]=(sap.ui&&sap.ui.getCore().getConfiguration().getLanguage())||"";H["X-CSRF-Token"]="Fetch";OData.read({requestUri:p,headers:H},i,j);L.debug('Sent OData request for GET "'+p+'"',null,"ODataWrapper");};this.requestOrBatch=function(R,m,p,i,F){var j,q={data:p,method:m,requestUri:R,headers:l(k())},u=this.toRequestUrl(R);if(B){i=i||n;F=F||o.getDefaultErrorHandler();t.check(i,F);L.debug("Queued OData request for "+m+' "'+R+'"',null,"ODataWrapper");if(!C){B.push({__changeRequests:[]});D.push([]);C=f;}B[B.length-1].__changeRequests.push(q);j=(new jQuery.Deferred()).done(function(v,w){L.debug("Received OData response for "+m+' "'+u+'"',null,"ODataWrapper");U.callHandler(i.bind(null,v),F);}).fail(t.onError.bind(t,m,u,F,null));D[D.length-1].push(j);return;}this.doRequest(u,m,p,i,F);};this.isStickySessionEnabled=function(){return(a.oStickySessionConfiguration[e]||{}).enabled||false;};this.enableStickySession=function(){a.oStickySessionConfiguration[e].enabled=true;};this.check=function(i,F){if(!i){throw new S("Missing success callback","ODataWrapper");}if(typeof i!=="function"){throw new S("Success callback is not a function","ODataWrapper");}if(!F){throw new S("Missing error callback","ODataWrapper");}if(typeof F!=="function"){throw new S("Error callback is not a function","ODataWrapper");}};this.create=function(R,p,i,F){this.requestOrBatch(R,"POST",p,i,F);};this.del=function(E,i,F){var R=E;if(typeof R!=="string"){R=this.toRelativeUrl(E.__metadata.uri);}this.requestOrBatch(R,"DELETE",null,function(j){if(i){i();}},F);};this.getBaseUrl=function(){return e;};this.getODataService=function(){return o;};this.onError=function(m,R,F,i,E){var p,M="Error ";if(E.response&&E.response.statusCode){M+="("+E.response.statusCode+", "+E.response.statusText+") ";}M+="in OData response for "+m+' "'+R+'": '+E.message;if(E.response&&E.response.body){try{p=JSON.parse(E.response.body).error;if(p){if(p.hasOwnProperty("message")&&p.message.hasOwnProperty("value")){M+="\nDetails: "+p.message.value;}if(E.response.statusCode&&!p.httpStatus){p.httpStatus=E.response.statusCode;}}}catch(j){}}L.error(M,JSON.stringify(E.response),"ODataWrapper");if(i){i.reject(M,p);}F(M,p);};this.openBatchQueue=function(){if(B){throw new S("Batch queue already open","ODataWrapper");}B=[];D=[];C=false;};this.isBatchQueueOpen=function(){return!!B;};this.read=function(R,i,F,j){var m,p=this.toRequestUrl(R),q;function u(v,w){this.detectStickySession(w.headers);o.setCsrfToken(a.csrfTokenValue(w.headers)||o.getCsrfToken());L.debug('Received OData response for GET "'+p+'"',null,"ODataWrapper");q=a.headerValue("sap-message",w.headers);if(q){L.warning("SAP message for GET "+p,q,"ODataWrapper");}if(m){m.resolve(JSON.parse(JSON.stringify(v)),o.getCsrfToken());}U.callHandler(i.bind(null,v),F);}F=F||o.getDefaultErrorHandler();this.check(i,F);if(j){OData.read.$cache=OData.read.$cache||new U.Map();m=OData.read.$cache.get(p);if(m){L.debug('Using cached response for GET "'+p+'"',null,"ODataWrapper");m.done(function(v,w){o.setCsrfToken(o.getCsrfToken()||w);U.callHandler(i.bind(null,JSON.parse(JSON.stringify(v))),F);}).fail(F);return;}m=new jQuery.Deferred();OData.read.$cache.put(p,m.promise());}this.readOrBatch(R,u.bind(this),this.onError.bind(this,"GET",p,F,m));};this.batch=function(p,i,F){var R=this.toRequestUrl("$batch");this.doRequest(R,"POST",p,i,F,OData.batchHandler);};this.submitBatchQueue=function(m,p){var M=D;function q(u){var A=u.__batchResponses.length,E=M.length;if(E!==A){t.onError("POST",this.toRequestUrl("$batch"),p,null,{message:"Protocol error! Expected "+E+" responses, but received "+A});return;}u.__batchResponses.forEach(function(R,i){var v=M[i];if(R.response){r(v,R);}else if(R.__changeResponses){R.__changeResponses.forEach(function(w,j){v[j].resolve(w.data,w);});}else{v.resolve(R.data,R);}});if(m){U.callHandler(m,o.getDefaultErrorHandler());}}if(!B){throw new S("No open batch queue to submit","ODataWrapper");}if(B.length>0){this.batch({__batchRequests:B},q.bind(this),p);}else if(m){U.callHandler(m,o.getDefaultErrorHandler(),true);}B=undefined;D=undefined;};this.toString=function(v){var R=['ODataWrapper({sBaseUrl:"',e,'"'];R.push("})");return R.join("");};this.put=function(R,p,i,F){this.requestOrBatch(R,"PUT",p,function(j){if(i){i();}},F);};this.update=function(E,i,F){var p={__metadata:{type:E.__metadata&&E.__metadata.type}},P,R=this.toRelativeUrl(E.__metadata.uri);for(P in E){if(Object.prototype.hasOwnProperty.call(E,P)&&P.indexOf("$")!==0&&typeof E[P]!=="object"){p[P]=E[P];}}this.put(R,p,i,F);};if(typeof s==="string"){s=g(arguments);}else if(typeof s==="object"){s=c(s);}if(!s||!s.baseUrl||typeof s.baseUrl!=="string"){throw new S("Missing base URL","ODataWrapper");}if(!o||typeof o!=="object"){throw new S("Missing OData service facade","ODataWrapper");}s.baseUrl=s.baseUrl.replace(/\/$/,"")+"/";e=s.baseUrl;f=s.supportsChangeSets;if(typeof a.oStickySessionConfiguration==="undefined"){L.error("ODataWrapper.oStickySessionConfiguration is not defined!","the ODataWrapper constructor was called before the static property was defined","ODataWrapper");}else if(typeof a.oStickySessionConfiguration[e]==="undefined"){a.oStickySessionConfiguration[e]={enabled:false,value:undefined};}};function h(A){var s={};var t={};s.baseUrl=A[0];if(typeof A[1]==="boolean"){s.supportsChangeSets=A[1];}if(typeof A[2]==="function"){t.defaultFailure=A[2];}t.settings=s;return t;}function c(i){if(i===undefined){return undefined;}try{return JSON.parse(JSON.stringify(i));}catch(e){return undefined;}}if(typeof a.oStickySessionConfiguration==="undefined"){a.oStickySessionConfiguration={};}a.checkSapStatisticsSetting=function(w){try{a["sap-statistics"]=sap.ui.getCore().getConfiguration().getStatistics();}catch(e){a["sap-statistics"]=/sap-statistics=(true|x|X)/.test(w);}};a.checkSapStatisticsSetting(window.location.search);a._Service=function b(s,D){var w=new a(s,this);O.call(this,w,D);return w;};a.createODataWrapper=function(s,D){if(typeof arguments[0]==="string"){var t=h(arguments);s=t.settings;if(t.defaultFailure){D=t.defaultFailure;}}else if(typeof arguments[0]==="object"){s=c(s);}return new a._Service(s,D);};return a;},true);
