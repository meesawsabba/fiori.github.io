// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/URI","sap/base/Log","sap/ushell_abap/pbServices/ui2/Error"],function(U,L,S){"use strict";var a=function(){};if(!Function.prototype.bind){Function.prototype.bind=function(t){if(typeof this!=="function"){throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");}var A=Array.prototype.slice.call(arguments,1),b=this,N=function(){},B=function(){return b.apply(this instanceof N?this:t,A.concat(Array.prototype.slice.call(arguments)));};N.prototype=this.prototype;B.prototype=new N();return B;};}var c;a.absoluteUrl=function(u,b){b=b||location.href;if(b.indexOf("://")<0&&b.charAt(0)!=="/"){throw new S("Illegal base URL: "+b);}if(!u||u.indexOf("://")>=0||u.charAt(0)==="/"){return a.addCacheBusterTokenUsingUshellConfig(u);}if(b.search(/^([^:]*:)?\/\/[^/]+$/)<0){b=b.replace(/\/[^/]*$/,"");}return a.addCacheBusterTokenUsingUshellConfig(b+"/"+u);};a.callHandler=function(s,f,A){var m;if(A){setTimeout(function(){a.callHandler(s,f,false);},0);return;}try{s();}catch(e){m=e.message||e.toString();L.error("Call to success handler failed: "+m,e.stack);if(f){f(m);}}};a.get=function(u,x,s,f,X,C){if(typeof s!=="function"){throw new S("Missing success handler");}if(typeof f!=="function"){throw new S("Missing error handler");}if(x&&C){throw new S("Caching of XML responses not supported");}if(typeof a.addCacheBusterTokenUsingUshellConfig==="function"){u=a.addCacheBusterTokenUsingUshellConfig(u);}X=X||new XMLHttpRequest();X.onreadystatechange=function(){var r,o;if(this.readyState!==4){return;}if(this.status!==200){L.error("Error "+this.status+" in response for URL "+u,null);f(u+": "+this.status+" "+this.statusText,this.responseText);return;}L.debug("Received response for URL "+u,null);if(x){o=this.responseXML;if(o===null||!o.documentElement){f(u+": no valid XML");return;}r=o;}else{r=this.responseText;if(C){c.put(u,r);}}a.callHandler(s.bind(null,r),f);};if(!x&&c.containsKey(u)){L.debug("Return cached response for URL "+u,null);a.callHandler(s.bind(null,c.get(u)),f);}else{try{if(X.readyState<XMLHttpRequest.OPENED){X.open("GET",u,true);}else{L.debug("XHR Request was already opened for "+u,null);}X.send();L.debug("Sent request to URL "+u,null);}catch(e){L.error("Error '"+(e.message||e)+"' in request to URL "+u,null);throw e;}}};a.addCacheBusterToken=function(u,p,r,t){if(p.test(u)){u=u.replace(p,r);u=u.replace(/\[CacheBusterToken\]/g,t);}return u;};a.removeCBAndNormalizeUrl=function(u){var m,s,C,b;if(typeof u!=="string"||u===""||d(u)){return u;}function d(f){var o=new U(f),p=o.path();if(o.is("absolute")){return false;}if(p&&p.charAt(0)==="/"){return false;}return true;}m=u.match(/(.*)(\/~[\w-]+~[A-Z0-9]?)(.*)/);if(m){s=m[1];C=m[2];b=m[3];}function n(f){return new U(f).normalizePathname().toString();}function e(p){var f=new U(p).segment(),i,P=0;for(i=0;i<f.length&&P>=0;i+=1){if(f[i]===".."){P=P-1;}else{P=P+1;}}return P<0;}if(C){if(b&&e(b)){u=s+b;}}return n(u);};a.addCacheBusterTokenUsingUshellConfig=function(u){var C=window["sap-ushell-config"]&&window["sap-ushell-config"].cacheBusting,p=C&&C.patterns,s=u,P=[],b,r=[];P=a.getParameterMap();b=P["sap-ushell-nocb"]&&P["sap-ushell-nocb"][0];if((b==="true"||b==="X")&&typeof u==="string"){u=u.replace(/\/~[\w-]+~[A-Z0-9]?/,"");return u;}if(!C||typeof u!=="string"||u===""||/[/=]~[\w-]+~[A-Z0-9]?[/#?&]/.test(u)||/[/=]~[\w-]+~[A-Z0-9]?$/.test(u)){return u;}if(C&&C.urls){if(u.charAt(u.length-1)==="/"){u=u.substr(0,u.length-1);}if(C.urls.hasOwnProperty(u)){return u+"/"+C.urls[u].cacheBusterToken;}if(C.urls.hasOwnProperty(u+"/")){return u+"/"+C.urls[u+"/"].cacheBusterToken;}}if(!p){return u;}Object.keys(p).forEach(function(d){if(p.hasOwnProperty(d)){var R=p[d];R.pattern=new RegExp(d);r.push(R);}});r.sort(function(R,o){return R.order-o.order;});r.every(function(R){if(R.pattern.test(u)){if(!R.cacheBusterToken){R.cacheBusterToken=C.cacheBusterToken;}s=a.addCacheBusterToken(u,R.pattern,R.replacement,R.cacheBusterToken);return false;}return true;});return s;};a.clearCache=function(){c=new a.Map();};a.getFormFactor=function(){var s=sap.ui.Device.system;if(s.desktop){return s.SYSTEMTYPE.DESKTOP;}if(s.tablet){return s.SYSTEMTYPE.TABLET;}if(s.phone){return s.SYSTEMTYPE.PHONE;}};a.getParameterMap=function(s){var i,n,r={},k,v,I,K,b=arguments.length>0?s:location.search;if(b&&b.charAt(0)!=="?"){throw new S("Illegal search string "+b);}if(!b||b==="?"){return{};}K=b.substring(1).replace(/\+/g," ").split(/[&;]/);for(i=0,n=K.length;i<n;i+=1){k=K[i];v="";I=k.indexOf("=");if(I>=0){v=k.slice(I+1);v=decodeURIComponent(v);k=k.slice(0,I);}k=decodeURIComponent(k);if(!Object.prototype.hasOwnProperty.call(r,k)){r[k]=[];}r[k].push(v);}return r;};a.getParameterValue=function(u,n){var p,q;if(typeof n!=="string"){throw new S("Missing parameter name");}u=u.split("#")[0];q=u.indexOf("?");if(q>=0){p=a.getParameterMap(u.slice(q));if(p[n]){return p[n][0];}}return"";};a.isArray=function(o){return Object.prototype.toString.apply(o)==="[object Array]";};a.isString=function n(o){return/String/.test(Object.prototype.toString.call(o));};a.parseXml=function(x){var X;if(!x||typeof x!=="string"){return null;}X=new DOMParser().parseFromString(x,"text/xml");if(X.getElementsByTagName("parsererror").length){throw new S("Invalid XML: "+x);}return X;};a.Map=function(){this.entries={};};a.Map.prototype.put=function(k,v){var o=this.get(k);this.entries[k]=v;return o;};a.Map.prototype.containsKey=function(k){if(typeof k!=="string"){throw new S("Not a string key: "+k);}return Object.prototype.hasOwnProperty.call(this.entries,k);};a.Map.prototype.get=function(k){if(this.containsKey(k)){return this.entries[k];}return undefined;};a.Map.prototype.keys=function(){return Object.keys(this.entries);};a.Map.prototype.remove=function(k){delete this.entries[k];};a.Map.prototype.toString=function(){var r=["Map("];r.push(JSON.stringify(this.entries));r.push(")");return r.join("");};a.clearCache();sap.ui2=sap.ui2||{};sap.ui2.srvc=sap.ui2.srvc||{};sap.ui2.srvc.removeCBAndNormalizeUrl=a.removeCBAndNormalizeUrl;sap.ui2.srvc.addCacheBusterTokenUsingUshellConfig=a.addCacheBusterTokenUsingUshellConfig;return a;});
