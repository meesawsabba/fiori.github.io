// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/bootstrap/common/common.load.xhrlogon","sap/ushell/utils","./abap.bootstrap.utils","./abap.request.server.config","./abap.request.startup","./abap.request.pageset","./abap.xhr.handler","./abap.theme.handler","sap/ushell/EventHub","sap/ui/performance/trace/initTraces","sap/base/util/ObjectPath","sap/base/Log","sap/ushell/services/Container","sap/ui/Device","sap/ushell_abap/pbServices/ui2/Utils","sap/ushell_abap/pbServices/ui2/Chip"],function(x,u,a,r,s,p,X,t,E,i,O,L,C,D,U,b){"use strict";var B={};sap.ushell_abap.getShellType=function(){return u.hasNativeNavigationCapability()?"NWBC":"FLP";};sap.ushell_abap.bootstrap.addPostParametersToNavTargetResultUrl=function(e,Q){if(e){Q+=(Q.indexOf("?")<0)?"?":"&";Q+=e;}return Q;};sap.ushell_abap.bootstrap.adjustNavTargetResult=function(R){if(R){var e=R.url,Q,T={applicationType:R.applicationType,additionalInformation:R.applicationData},V,W,Y,Z;if(R.text){T.text=R.text;}if((R.applicationType==="URL"||R.applicationType==="SAPUI5")){W=/^SAPUI5\.Component=(.*)/.exec(R.applicationData);V=W&&W[1];if(V||R.applicationDependencies){if(V){T.ui5ComponentName=V;}if(R.applicationDependencies){try{Y=JSON.parse(R.applicationDependencies);Z=Y.self;if(!T.ui5ComponentName&&Z.name){T.ui5ComponentName=Z.name;T.additionalInformation="SAPUI5.Component="+T.ui5ComponentName;}if(Z&&Z.url&&typeof Z.url==="string"){var $=sap.ui.require("sap/ui/thirdparty/URI");Q=e&&new $(e);if(Q){if(Z.url.toUpperCase().indexOf(Q.path().toUpperCase())!==0){L.debug("Component URL defined in target mapping "+"does not match the URL retrieved from application index. "+"The URL of the application index is used for further processing.","Target mapping URL: "+R.url+"\nApplication index URL: "+Z.url,"sap.ushell_abap.bootstrap.abap");}Q.path(Z.url);e=Q.toString();L.debug("ResolveLink result's component url has been replaced with the url specified "+"in Application Dependencies, which includes cache buster token");}else{e=Z.url;}}T.applicationDependencies=Y;}catch(a1){L.error("Parsing of applicationDependencies attribute in resolveLink result failed for SAPUI5 component '"+V+"'",a1,"sap.ushell_abap.bootstrap.abap");}}e=U.addCacheBusterTokenUsingUshellConfig(e);}}T.url=e;return T;}};var c=new RegExp("^(#)?([A-Za-z0-9_]+)-([A-Za-z0-9_]+)"),S,o;function d(e){function Q(e){if(!e){return false;}return e.indexOf("Shell-home")===0||e.indexOf("Launchpad-openFLPPage")===0||e.indexOf("Shell-appfinder")===0||e.indexOf("Shell-catalog")===0||e.indexOf("shell-catalog")===0||e.indexOf("Action-search")===0;}function R(){return window["sap-ushell_abap-bootstrap-abap-noInitialTarget"]!==undefined;}var T=e.match(c);var V=T&&T[2];var W=T&&T[3];var Y=e&&!Q(e)&&!R()&&V&&W;return Y;}function g(){var e,Q=a.getLocationHref(),R=Q.indexOf("#");if(R<0){return"";}e=decodeURI(Q.slice(R+1));return e;}function f(){var e=g(),Q=e.indexOf("&/");return Q<0?e:e.slice(0,Q);}function h(e){var Q=e.match(c);return Q?{semanticObject:Q[2],action:Q[3]}:undefined;}function j(e){if(!e||e==="#"){return true;}return(e.indexOf("Shell-home")===0)||(e.indexOf("Launchpad-openFLPPage")===0)||(e.indexOf("Shell-appfinder")===0)||(e.indexOf("Shell-catalog")===0)||(e.indexOf("shell-catalog")===0);}function k(Q){if(Q===undefined){return undefined;}try{return JSON.parse(JSON.stringify(Q));}catch(e){L.error("Could not clone object",null,"sap.ushell_abap.bootstrap");return undefined;}}function l(T){return T.indexOf("sap_")===0;}function m(e,Q){var R=sap.ui.getCore(),T=R.getConfiguration(),V=T.getFormatSettings();L.debug("setSapui5Settings()",JSON.stringify(e),"sap.ushell_abap.bootstrap.abap");if(e.language){T.setLanguage(e.language,e.ABAPLanguage);}if(e.legacyDateFormat){V.setLegacyDateFormat(e.legacyDateFormat);}if(e.legacyDateCalendarCustomizing){V.setLegacyDateCalendarCustomizing(e.legacyDateCalendarCustomizing);}if(e.legacyNumberFormat){V.setLegacyNumberFormat(e.legacyNumberFormat);}if(e.legacyTimeFormat){V.setLegacyTimeFormat(e.legacyTimeFormat);}if(typeof Q==="object"){V.addCustomCurrencies(Q);}}function n(e){(O.get("sap-ushell-config.services.Container.adapter.config")||O.create("sap-ushell-config.services.Container.adapter.config")).bootTheme=k(e);}function q(e){if(!e){L.error("extractSystemThemeRoot: mandatory parameter oStartupServiceResult not supplied");}if(e.themeRoot){return e.themeRoot;}if(e.client){L.warning("Theme root was not contained in startup service result. A fallback to /sap/public/bc/themes/~client-<client number> is used",null,"sap.ushell_abap.bootstrap");return"/sap/public/bc/themes/~client-"+e.client;}L.error("extractSystemThemeRoot: Could not determine system theme root");}function v(e){var Q,T;if(e&&e.userProfile&&e.userProfile.filter){Q=e.userProfile.filter(function(R){return R.id==="THEME";});T=Q.length?Q[0]:{};if(T.value){return T.value;}}if(e&&e.theme){return e.theme;}return"";}function w(T,S){if(T&&l(T)){return"";}return S;}function y(e,S){var T;T=v(e);return{theme:T,root:w(T,S)};}function z(S){var T,e;T=a.getUrlParameterValue("sap-theme");if(T){if(T.indexOf("@")>0){e=T.split("@",2);return{theme:e[0],root:e[1]};}return{theme:T,root:w(T,S)};}return undefined;}function A(){var e=U.getParameterMap()["sap-theme"]&&U.getParameterMap()["sap-theme"][0];if(e){return e;}return undefined;}function F(e){var T=e;var Q=e.indexOf("@");if(Q>=0){var R=T.slice(Q+1);return t.isThemeRootSafe(R);}return true;}function G(o,S){var e,Q={},R,T=A();if(T&&F(T)){e=z(S);R=e;L.debug("theme: URL theme = '"+R.theme+"' theme root = '"+R.root+"'",null,"sap.ushell_abap.bootstrap");if(R.root){sap.ui.getCore().setThemeRoot(R.theme,R.root.replace(/\/?$/,"/UI5/"));}}else if(o){R=o;L.debug("theme: startup service theme = '"+R.theme+"' theme root = '"+R.root+"'",null,"sap.ushell_abap.bootstrap");if(R.root){sap.ui.getCore().applyTheme(R.theme,R.root+"/UI5/");}else{sap.ui.getCore().applyTheme(R.theme);}}else{Q.theme=O.get("sap-ui-config.theme");if(Q.theme){Q.root=O.get("sap-ui-config.themeRoots."+Q.theme||"");if(!Q.root){Q.root=w(Q.theme,S);}R={theme:Q.theme,root:Q.root};L.debug("theme: html file theme = '"+R.theme+"' theme root = '"+R.root+"'",null,"sap.ushell_abap.bootstrap");}else{R={theme:"",root:""};L.error("Could not determine theme",null,"sap.ushell_abap.bootstrap");}}n(R);return R;}function H(e){var Q=U.getParameterMap(),R=a.getUrlParameterValue("sap-locale",Q),T={},V;V=O.get("sap-ushell-config.services.SupportTicket.config")||O.create("sap-ushell-config.services.SupportTicket.config");if(V.enabled!==false){V.enabled=(e.isEmbReportingActive===true);}V=O.get("sap-ushell-config.services.ClientSideTargetResolution.adapter.config.services")||O.create("sap-ushell-config.services.ClientSideTargetResolution.adapter.config.services");V.targetMappings=e.services&&e.services.targetMappings;V=O.get("sap-ushell-config.services.LaunchPage.adapter.config.services")||O.create("sap-ushell-config.services.LaunchPage.adapter.config.services");V.targetMappings=e.services&&e.services.targetMappings;V.launchPage=e.services&&e.services.pbFioriHome;V=O.get("sap-ushell-config.services.VisualizationDataProvider.adapter")||O.create("sap-ushell-config.services.VisualizationDataProvider.adapter");V.module="sap.ushell_abap.adapters.abap.LaunchPageAdapter";V=O.get("sap-ushell-config.services.VisualizationDataProvider.adapter.config.services")||O.create("sap-ushell-config.services.VisualizationDataProvider.adapter.config.services");V.targetMappings=e.services&&e.services.targetMappings;V.launchPage=e.services&&e.services.pbFioriHome;V=O.get("sap-ushell-config.services.PageBuilding.adapter.config.services")||O.create("sap-ushell-config.services.PageBuilding.adapter.config.services");V.pageBuilding=e.services&&e.services.pbFioriHome;V=O.get("sap-ushell-config.services.Personalization.adapter.config.services")||O.create("sap-ushell-config.services.Personalization.adapter.config.services");V.personalization=e.services&&e.services.personalization;if(!R){T={language:e.languageBcp47||e.language,ABAPLanguage:e.language,legacyDateFormat:e.dateFormat,legacyDateCalendarCustomizing:e.tislcal,legacyNumberFormat:e.numberFormat===""?" ":e.numberFormat,legacyTimeFormat:e.timeFormat};}G(o,S);m(T,e.currencyFormats);}function I(e){var Q=f(),R=g(),T=h(Q),V=[T],W={},Y={},Z;var $=O.get("sap-ushell-config.services.AppState.config")||O.create("sap-ushell-config.services.AppState.config");var a1=O.get("sap-ushell-config.services.ClientSideTargetResolution.adapter.config")||O.create("sap-ushell-config.services.ClientSideTargetResolution.adapter.config");function b1(d1,R){var e1=R.match(d1);var f1=[];if(!e1){return;}f1=(e1[2]).toString().split("=");Y[f1[0]]=f1[1];}function c1(d1,e1,Y,f1,g1){if(e1&&e1[g1]&&Y&&Y[f1]){d1[Y[f1]]=e1[g1];}}if(d(Q)){b1(/(\?|&)(sap-xapp-state=[A-Z0-9]+)/,Q);b1(/(\?|&)(sap-intent-param=[A-Z0-9]+)/,Q);b1(/(\?|&)(sap-system=[A-Z0-9]+)/,Q);b1(/(\?|&|[/])(sap-iapp-state=[A-Z0-9]+)/,R);Z=s.requestDirectStart(e,T,Y);$.initialAppStatesPromise=Z.then(function(d1){c1(W,d1,Y,"sap-intent-param","iparState");c1(W,d1,Y,"sap-iapp-state","iappState");c1(W,d1,Y,"sap-xapp-state","xappState");$.initialAppStates=W;return Promise.resolve(W);});a1.initialSegmentPromise=Z.then(function(d1){if(d1.targetMappings){return Promise.resolve([V,d1.targetMappings,d1.systemAliases,d1.urlTemplates]);}return Promise.resolve(null);});}else{$.initialAppStatesPromise=Promise.resolve({});a1.initialSegmentPromise=Promise.resolve(null);}}function J(){var e=new Promise(function(Q,R){var T,V;V=function(){L.info("Direct application start: resolving component waitFor promise after shell renderer created event fired.");Q();sap.ushell.Container.detachRendererCreatedEvent(V);};E.once("ShellNavigationInitialized").do(function(){T=sap.ushell.Container.getRenderer();if(T){L.info("Direct application start: resolving component waitFor promise immediately (shell renderer already created).");Q();}else{sap.ushell.Container.attachRendererCreatedEvent(V);}});});return e;}function K(e){var Q=a.getUrlParameterValue("sap-ushell-reload"),R;if(Q){if(Q==="X"||Q==="true"){R=true;}else{R=false;}}if(R!==undefined){(O.get("services.ShellNavigation.config",e)||O.create("services.ShellNavigation.config",e)).reload=R;}}function M(e,Q,R){var T=f();i();H(e);Q.forEach(function(V){a.mergeConfig(window["sap-ushell-config"],V,true);});K(window["sap-ushell-config"]);sap.ushell.bootstrap("abap",{abap:"sap.ushell_abap.adapters.abap",hana:"sap.ushell_abap.adapters.hana"}).done(function(){if(j(T)&&window["sap-ushell-config"].ushell&&window["sap-ushell-config"].ushell.spaces&&window["sap-ushell-config"].ushell.spaces.enabled){N(T);}var V=x.FrameLogonManager.getInstance();sap.ushell.Container.oFrameLogonManager=V;}).always(function(){if(d(T)){var V,W;window["sap-ushell-async-libs-promise-directstart"]=new Promise(function(Y,Z){V=Y;W=Z;});window["sap-ushell-async-libs-promise-directstart"].catch(function(Y){});sap.ushell.Container.getServiceAsync("NavTargetResolution").then(function(Y){Y.resolveHashFragment("#"+f()).done(function(Z){var $=sap.ui.require("sap/ushell/services/AppConfiguration");$.setCurrentApplication(Z);if(Z&&Z.ui5ComponentName){sap.ushell.Container.getServiceAsync("Ui5ComponentLoader").then(function(a1){a1.createComponent(Z,h(T),J(),"Application").done(function(b1){V({resolvedHashFragment:b1,dependenciesLoaded:true});}).fail(function(b1){W(b1);});});}else{V({resolvedHashFragment:Z,dependenciesLoaded:false});}}).fail(function(Z){W(Z);});});}R();});}function _(){return sap.ushell.Container.getServiceAsync("Personalization").then(function(e){var Q={container:"sap.ushell.cdm3-1.personalization",item:"data"};var R={validity:"Infinity",keyCategory:e.constants.keyCategory.GENERATED_KEY,writeFrequency:e.constants.writeFrequency.HIGH,clientStorageAllowed:false};return e.getPersonalizer(Q,R).getPersData();});}function N(e){if(e&&e.indexOf("Shell-appfinder")===0){return;}_();sap.ui.require(["sap/ushell/components/pages/controller/PagesAndSpaceId"],function(Q){var R=Q._getPageAndSpaceId(e);var T=sap.ushell.Container.getServiceAsync("PagePersistence");Promise.all([R,T]).then(function(V){var W=V[0];var Y=V[1];Y.getPage(W.pageId);}).catch(function(V){L.error(V);});});}function P(e){var Q,R;X.initXhrLogon(window["sap-ushell-config"]);Q=s.requestStartupConfig().then(function(T){var V=f();(O.get("sap-ushell-config.services.Container.adapter")||O.create("sap-ushell-config.services.Container.adapter")).config=T;var W=O.get("sap-ushell-config.services.LaunchPage.adapter.config")||O.create("sap-ushell-config.services.LaunchPage.adapter.config");var Y=O.get("sap-ushell-config.services.ClientSideTargetResolution.adapter.config")||O.create("sap-ushell-config.services.ClientSideTargetResolution.adapter.config");if(O.get("sap-ushell-config.ushell.spaces.enabled")){O.set("sap-ushell-config.services.VisualizationDataProvider.adapter.config",W);O.set("sap-ushell-config.services.NavigationDataProvider.adapter.config",Y);}I(T);S=q(T);o=y(T,S);if(!A()&&o){L.debug("theme: load theme from startup service via window",null,"sap.ushell_abap.bootstrap");}if(j(V)&&!O.get("sap-ushell-config.ushell.spaces.enabled")){p.requestPageSet(T);}var Z=s.requestFullTM(T);Y.navTargetDataPromise=Z;W.compactTMPromise=Z;return Promise.resolve(T);},function(T){L.error("start_up request failed: "+T,null,"sap.ushell_abap.bootstrap");return Promise.resolve({});});R=r().then(function(T){return Promise.resolve(T);},function(T){L.error("Could not load server configuration: "+T,null,"sap.ushell_abap.bootstrap.abap");return Promise.resolve([]);});Promise.all([Q,R,e]).then(function(T){if(T[1]&&T[1].length>0){L.error("The usage of server side configuration files is deprecated.");}M.apply(null,T);});}B.start=P;B.bootstrap=M;B._getShellHash=f;B._getFullShellHash=g;B._createWaitForRendererCreatedPromise=J;B._loadPage=N;return B;});
