// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/library","sap/ui/Device","./AccessKeysHandler","./History","sap/ushell/components/applicationIntegration/AppLifeCycle","sap/ushell/services/AppConfiguration","sap/ushell/utils","sap/ushell/utils/WindowUtils","sap/ushell/resources","sap/ushell/UserActivityLog","sap/ushell/EventHub","sap/ushell/Config","sap/ui/core/Component","sap/ui/core/routing/History","sap/ui/core/routing/HashChanger","sap/ui/core/mvc/Controller","sap/ushell/components/HeaderManager","sap/ushell/components/_HeaderManager/ControlManager","sap/ushell/bootstrap/SchedulingAgent","sap/ui/core/library","sap/ushell/performance/FesrEnhancer","sap/base/Log","sap/ui/thirdparty/jquery","sap/ui/performance/Measurement","sap/base/util/isPlainObject","sap/base/util/UriParameters","sap/ui/util/Storage","sap/m/InstanceManager","sap/ushell/services/Message","sap/ui/thirdparty/hasher","sap/ushell/renderers/fiori2/LogonFrameProvider","sap/ushell/components/applicationIntegration/relatedServices/RelatedServices"],function(u,D,A,H,a,b,c,W,r,U,E,C,d,f,g,h,j,k,S,l,F,L,q,M,m,n,o,I,p,s,t,R){"use strict";var v=l.routing.HistoryDirection;var w=u.AppType;var x=true,P=false,y,z=a.getElementsModel(),B,G={embedded:0,newWindowThenEmbedded:1,newWindow:1,replace:0},N={embedded:"embedded",newWindowThenEmbedded:"newWindowThenEmbedded",newWindow:"newWindow",replace:"replace"},J={};F.init();return h.extend("sap.ushell.renderers.fiori2.Shell",{_aDoableObjects:[],onComponentTargetDisplay:function(e){var i=e.getParameters();var K=i.control;var O=i.object;if(this.bRestorePreviousHash){this.bRestorePreviousHash=false;}K.navTo("centerViewPort",O.getId(),"show");},onInit:function(){var e=this;var i=d.getOwnerComponentFor(this.getView()).getRouter();i.getTarget("home").attachDisplay(this.onComponentTargetDisplay,this);i.getTarget("appfinder").attachDisplay(this.onComponentTargetDisplay,this);i.getTarget("pages").attachDisplay(this.onComponentTargetDisplay,this);i.oHashChanger=g.getInstance();i.initialize(true);this.bEnableHashChange=true;x=true;var V=this.getView();var K=window.matchMedia("(min-width: 600px)"),O;var J=(V.getViewData()?V.getViewData().config:{})||{};a.parseStatefulContainerConfiguration(J.statefulApplicationContainer);var Q=a.shellElements().model();j.init(J,Q);this.initShellModel(J,Q);var T=this.getView().updateShellAggregation;sap.ui.getCore().byId("shell-header").updateAggregation=T;sap.ui.getCore().byId("shell").updateAggregation=T;sap.ui.getCore().byId("right-floating-container").updateAggregation=T;sap.ui.getCore().byId("shell-split").updateAggregation=T;O=function(Z){C.emit("/core/shell/model/isPhoneWidth",!Z.matches);};if(K.addListener){K.addListener(O);O(K);}V.setModel(r.i18nModel,"i18n");sap.ui.getCore().getEventBus().subscribe("externalSearch",this.externalSearchTriggered,this);sap.ui.getCore().getEventBus().subscribe("sap.ushell","appOpened",this.onAppOpened,this);sap.ui.getCore().getEventBus().subscribe("allSearchFinished",this._logSearchActivity,this);this._setConfigurationToModel();this._aDoableObjects=this._registerAndCreateEventHubDoables();y.addHeaderEndItem(["meAreaHeaderButton"],false,["home","app","minimal","standalone","embedded","embedded-home","lean"],true);var X=[];if(J&&!J.moveContactSupportActionToShellHeader){X.push("ContactSupportBtn");}this.history=new H();this.oViewPortContainer=sap.ui.getCore().byId("viewPortContainer");a.init(J.appState,this.oViewPortContainer,J.rootIntent,J.disableHomeAppCache,{ownerComponent:this.getOwnerComponent()},X,J.cacheConfiguration);var Y=function(Z,$){this.oShellNavigation=Z;this.oShellNavigation.registerPrivateFilters($);this.oShellNavigation.registerExtraRouter(i);this.oShellNavigation.registerNavigationFilter(this._handleEmptyHash.bind(this));this.oShellNavigation.init(this.doHashChange.bind(this));this.oShellNavigation.registerNavigationFilter(this._disableSourceAppRouter.bind(this));this.oShellNavigation.registerNavigationFilter(this.handleDataLoss.bind(this));this.oShellNavigation.hashChanger.attachEvent("hashChanged",function(_){if(window.hasher.disableBlueBoxHashChangeTrigger===true){return;}if(_.mParameters&&e.oShellNavigation.hashChanger.isInnerAppNavigation(_.mParameters.newHash,_.mParameters.oldHash)){a.postMessageToIframeApp("sap.ushell.appRuntime","innerAppRouteChange",{oHash:_.mParameters});}a.postMessageToIframeApp("sap.ushell.appRuntime","hashChange",{sHash:_.mParameters.fullHash});});E.emit("ShellNavigationInitialized");}.bind(this);Promise.all([sap.ushell.Container.getServiceAsync("URLParsing"),sap.ushell.Container.getServiceAsync("ShellNavigation"),sap.ushell.Container.getServiceAsync("AppLifeCycle")]).then(function(Z){this.oURLParsing=Z[0];var $=Z[1];this._oAppLifeCycleService=Z[2];Y($,this._oAppLifeCycleService);}.bind(this));sap.ushell.Container.setLogonFrameProvider(this._getLogonFrameProvider());A.init(B);window.onbeforeunload=function(){if(sap.ushell.Container&&sap.ushell.Container.getDirtyFlag()&&!(D.browser.name===D.browser.BROWSER.INTERNET_EXPLORER&&a.getCurrentApplication().container.getApplicationType()===sap.ushell.ApplicationType.NWBC.type)){if(!r.browserI18n){r.browserI18n=r.getTranslationModel(window.navigator.language).getResourceBundle();}return r.browserI18n.getText("dataLossExternalMessage");}return undefined;};if(C.last("/core/shell/model/contentDensity")){a.getAppMeta()._applyContentDensityClass();}D.media.attachHandler(this.handleNavMenuTitleVisibility,this,D.media.RANGESETS.SAP_STANDARD);this.initShellUIService();if(!J.disableSignOut&&(J.sessionTimeoutTileStopRefreshIntervalInMinutes>0||J.sessionTimeoutReminderInMinutes>0)){this._createSessionHandler(J);}this.oViewPortContainer.onfocusin=function(){A.bFocusOnShell=false;A.bFocusPassedToExternalHandlerFirstTime=false;};this.oViewPortContainer.onfocusout=function(){A.bFocusOnShell=true;A.bFocusPassedToExternalHandlerFirstTime=true;};},shellUpdateAggItem:function(i,e){return sap.ui.getCore().byId(e.getObject());},getViewPortContainer:function(){return sap.ui.getCore().byId("viewPortContainer");},_registerAndCreateEventHubDoables:function(){var e=[E.once("CenterViewPointContentRendered").do(this._loadCoreExt.bind(this)),E.once("PagesRuntimeRendered").do(this._loadCoreExt.bind(this)),E.once("AppRendered").do(this._loadCoreExtNonUI5.bind(this)),E.on("toggleContentDensity").do(this.toggleContentDensity.bind(this)),E.on("ShellFloatingContainerDockedIsResized").do(this._onResizeWithDocking.bind(this)),E.on("LaunchpadCustomRouterRouteMatched").do(this._centerViewPort.bind(this)),E.once("CoreResourcesComplementLoaded").do(this._onCoreResourcesComplementLoaded.bind(this)),E.once("loadRendererExtensions").do(this._loadRendererExtensionPlugins.bind(this)),E.once("loadUsageAnalytics").do(this._loadUsageAnalytics.bind(this)),E.once("loadWarmupPlugins").do(this._loadWarmupPlugins.bind(this)),E.once("loadTrackingActivitiesSetting").do(this._loadTrackingActivitiesSetting.bind(this)),E.on("centerViewPort").do(this._centerViewPort.bind(this))];return e;},initShellModel:function(J,e){y=z;y.init(J,e);B=this.getView().getViewData().shellModel;C.emit("/core/shell/model/personalization",C.last("/core/shell/enablePersonalization"));},initShellUIService:function(){a.initShellUIService({fnOnBackNavigationChange:this.onBackNavigationChange.bind(this)});if(J.enableOnlineStatus){sap.ui.require(["sap/ushell/ui5service/UserStatus"],function(e){this.oUserStatus=new e({scopeObject:this.getOwnerComponent(),scopeType:"component"});}.bind(this));}},onBackNavigationChange:function(e){a.setBackNavigationChanged(true);var i=e.getParameters().data,K=C.last("/core/shell/model/currentState");if(i){a.service().setNavigateBack(i);if(K.stateName==="minimal"||K.stateName==="standalone"||K.stateName==="embedded"){sap.ushell.Container.getRenderer("fiori2").showHeaderItem("backBtn",true);}}else{a.service().resetNavigateBack();}},toggleContentDensity:function(e){var i=e.contentDensity==="compact";a.getAppMeta()._applyContentDensityByPriority(i,true);},_handleEmptyHash:function(e){e=(typeof e==="string")?e:"";e=e.split("?")[0];if(e.length===0){var V=this.getView()?this.getView().getViewData():{};J=V.config||{};if(J.migrationConfig){return this.oShellNavigation.NavigationFilterStatus.Continue;}if(J.rootIntent){window.setTimeout(function(){window.hasher.setHash(J.rootIntent);},0);return this.oShellNavigation.NavigationFilterStatus.Abandon;}}return this.oShellNavigation.NavigationFilterStatus.Continue;},_setConfigurationToModel:function(){var V=this.getView().getViewData();if(V){J=V.config||{};}if(J){if(J.states){z.extendStates(J.states);j.extendStates(J.states);}if(J.enableSetTheme!==undefined){B.setProperty("/setTheme",J.enableSetTheme);}B.setProperty("/contentDensity",J.enableContentDensity===undefined?true:J.enableContentDensity);if(J.migrationConfig!==undefined){B.setProperty("/migrationConfig",J.migrationConfig);}if(J.enableUserDefaultParameters!==undefined){B.setProperty("/userDefaultParameters",J.enableUserDefaultParameters);}if(J.disableHomeAppCache!==undefined){B.setProperty("/disableHomeAppCache",J.disableHomeAppCache);}B.setProperty("/enableHelp",C.last("/core/extension/enableHelp"));B.setProperty("/searchAvailable",(J.enableSearch!==false));}},_loadTrackingActivitiesSetting:function(e){this._getPersData({container:"flp.settings.FlpSettings",item:"userActivitesTracking"}).then(function(i){if(i===undefined){i=true;}B.setProperty("/enableTrackingActivity",i);E.emit("StepDone",e.stepName);}).catch(function(i){E.emit("StepFailed",e.stepName);L.error("Failed to ltracking activities state state from the personalization",i,"sap.ushell.components.flp.settings.FlpSettings");});},_getPreviousPageDirty:function(){return P;},_setPreviousPageDirty:function(e){P=e;},getModelConfiguration:function(){var V=this.getView().getViewData(),e,i;if(V){e=V.config||{};i=q.extend({},e);}delete i.applications;return i;},_getLogonFrameProvider:function(){return t;},onExit:function(){this._aDoableObjects.forEach(function(i){i.off();});sap.ui.getCore().getEventBus().unsubscribe("externalSearch",this.externalSearchTriggered,this);sap.ui.getCore().getEventBus().unsubscribe("allSearchFinished",this._logSearchActivity,this);sap.ui.getCore().getEventBus().unsubscribe("sap.ushell","appOpened",this.onAppOpened,this);D.media.detachHandler(this.handleNavMenuTitleVisibility,this,D.media.RANGESETS.SAP_STANDARD);if(this.oShellNavigation){this.oShellNavigation.hashChanger.destroy();}if(this.getView()&&this.getView().destroyDanglingControls){this.getView().destroyDanglingControls();}var e=sap.ui.getCore().byId("shell-header");if(e&&e.destroy){e.destroy();}j.destroy();k.destroy();U.deactivate();y.destroy();a.shellElements().clean();a.destroy();y=undefined;},_getCurrentAppRouter:function(){var e=this._oAppLifeCycleService,i=e&&e.getCurrentApplication&&e.getCurrentApplication(),K=i&&i.componentInstance;if(K){return K.getRouter();}return null;},_disableSourceAppRouter:function(e,i){if(!this.bEnableHashChange||this.bRestorePreviousHash){return this.oShellNavigation.NavigationFilterStatus.Continue;}var K=this.oShellNavigation.hashChanger.isInnerAppNavigation(e,i);if(!K){var O=this._getCurrentAppRouter();if(O){O.stop();}}return this.oShellNavigation.NavigationFilterStatus.Continue;},_resumeAppRouterIgnoringCurrentHash:function(){var e=this._getCurrentAppRouter();if(e){e.initialize(true);}},handleDataLoss:function(e,i){if(!this.bEnableHashChange&&!this.bRedoNavigation){this.bEnableHashChange=true;return this.oShellNavigation.NavigationFilterStatus.Custom;}var K=sap.ushell.Container.getDirtyFlag();P=K;if(this.bRestorePreviousHash){return this.oShellNavigation.NavigationFilterStatus.Continue;}if(this.bRedoNavigation){this.bRedoNavigation=false;this.bEnableHashChange=true;this.bExplaceNavigation=false;return this.oShellNavigation.NavigationFilterStatus.Continue;}var O=this.oURLParsing.parseShellHash(e);var Q=sap.ushell.Container.getRenderer()._isBuiltInIntent(O);var T=O.params["sap-ushell-navmode"];var V=T&&T[0];if(!D.browser.msie&&!Q&&(this.bExplaceNavigation||V==="explace"||V==="frameless")){this.bExplaceNavigation=false;return this.oShellNavigation.NavigationFilterStatus.Continue;}if(K&&D.browser.msie){if(this._handleDirtyStateUserConfirm()){return this.oShellNavigation.NavigationFilterStatus.Continue;}return this._restoreHashUsingAction(i,"undo");}if(K){var X=f.getInstance().getHistoryStateOffset()<0;Promise.all([this._waitForHash(i),sap.ushell.Container.getServiceAsync("NavTargetResolution")]).then(function(Y){var Z=Y[1];if(Q){if(this._handleDirtyStateUserConfirm()){this.bRedoNavigation=true;this._restoreHashUsingAction(e,"redo");}}else{var $="#"+e;Z.resolveHashFragment($).then(function(_){var a1=_.targetNavigationMode==="explace"||_.targetNavigationMode==="frameless";var b1=X&&_.navigationMode===N.newWindowThenEmbedded;if(a1&&(!b1)){this.bExplaceNavigation=true;this.bRedoNavigation=true;this._restoreHashUsingAction(e,"redo");}else if(this._handleDirtyStateUserConfirm()){this.bRedoNavigation=true;this._restoreHashUsingAction(e,"redo");}}.bind(this)).catch(function(){this.bRedoNavigation=true;this._restoreHashUsingAction(e,"redo");}.bind(this));}}.bind(this));return this._restoreHashUsingAction(i,"undo");}return this.oShellNavigation.NavigationFilterStatus.Continue;},_waitForHash:function(e){var i="#"+e;return new Promise(function(K){var O=function(){var Q=i===decodeURIComponent(window.location.hash);if(Q){window.removeEventListener("hashchange",O);K();}};window.addEventListener("hashchange",O);});},_handleDirtyStateUserConfirm:function(){if(window.confirm(r.i18n.getText("dataLossInternalMessage"))){sap.ushell.Container.setDirtyFlag(false);a.postMessageToIframeApp("sap.ushell.appRuntime","setDirtyFlag",{bIsDirty:false});if(R.isBackNavigation()===true){R.resetBackNavigationFlag();}P=true;return true;}return false;},_restoreHashUsingAction:function(e,i){var K=this.oShellNavigation.wasHistoryEntryReplaced();var O=this._getRestoreHashStrategy(K,i);this._resumeAppRouterIgnoringCurrentHash();return this._restoreHash(O,e);},_getRestoreHashStrategy:function(e,i){if(e){return{strategy:"replaceHash",stepCount:0};}var K;var O=f.getInstance().getHistoryStateOffset();if(O===undefined||O>=0){O=1;}else if(O<0){O=-1;}if(i==="undo"){if(O<0){K="historyForward";}else{K="historyBack";}this.sLastUndoStrategy=K;}else{switch(this.sLastUndoStrategy){case"historyBack":K="historyForward";break;case"historyForward":K="historyBack";break;default:K="replaceHash";}}return{strategy:K,stepCount:1};},_restoreHash:function(e,i){var K={status:this.oShellNavigation.NavigationFilterStatus.Custom,hash:""};switch(e.strategy){case"historyBack":this.bEnableHashChange=false;this._windowHistoryBack(e.stepCount);break;case"historyForward":this.bEnableHashChange=false;this._windowHistoryForward(e.stepCount);break;case"replaceHash":this.bEnableHashChange=false;s.replaceHash(i);break;default:throw new Error("Cannot execute unknown navigation strategy");}return K;},_isColdStart:function(){var e=sap.ushell.Container.getRenderer("fiori2");var i=!e||!e.getCurrentCoreView();if(this.history.getHistoryLength()<=1&&i){return true;}this._isColdStart=function(){return false;};return false;},_setEnableHashChange:function(V){this.bEnableHashChange=V;},_logRecentActivity:function(e){if(!this.oInitialEnableTrackingPromise){if(C.last("/core/shell/model/enableTrackingActivity")!==undefined){this.oInitialEnableTrackingPromise=Promise.resolve();}else{this.oInitialEnableTrackingPromise=new Promise(function(i,K){C.once("/core/shell/model/enableTrackingActivity").do(i);});}}return this.oInitialEnableTrackingPromise.then(function(){if(C.last("/core/shell/model/enableTrackingActivity")){return new Promise(function(i,K){b.addActivity(e).done(i).fail(K);});}L.warning("Tracking is not enabled",null,"sap.ushell.renderers.fiori2.Shell.controller");});},_logApplicationUsage:function(e){if(sap.ushell.Container){sap.ushell.Container.getServiceAsync("UserRecents").then(function(i){i.addAppUsage(e);});}},doHashChange:function(e,i,O,K,Q){M.start("FLP:ShellController.doHashChange","doHashChange","FLP");E.emit("trackHashChange",e);var T=sap.ui.getCore().byId("sapUshellDashboardPage");if(T){T.setBlocked(true);T.setBusy(true);}return this._doHashChange(this,e,i,O,K,Q).then(function(){M.end("FLP:ShellController.doHashChange");},function(V){M.end("FLP:ShellController.doHashChange");E.emit("doHashChangeError",Date.now());if(T){T.setBlocked(false);T.setBusy(false);}});},_doHashChange:function(e,i,K,O,Q,T){this._wasHistoryEntryReplaced=this.oShellNavigation.wasHistoryEntryReplaced();this.oShellNavigation.resetHistoryEntryReplaced();var V,X,Y,Z;if(!this.bEnableHashChange){this.bEnableHashChange=true;return q.when();}if(this.bRestorePreviousHash){this.bRestorePreviousHash=false;return q.when();}if(T){e.hashChangeFailure(e.history.getHistoryLength(),T.message,null,"sap.ushell.renderers.fiori2.Shell.controller",false);return q.when();}Z=new q.Deferred();if(I&&x){I.closeAllDialogs();I.closeAllPopovers();}x=true;X=e.history.getHistoryLength();Y=e.fixShellHash(i);e.history.hashChange(Y,O);e.currentAppBeforeNav=b.getCurrentApplication();e._resolveHashFragment(Y).then(function($,_){var a1=_?_.semanticObject+"-"+_.action:"",J=e._getConfig(),b1=!!($&&$.componentHandle),c1=$&&$.ui5ComponentName;$=e._calculateNavigationMode(_,$);e._handleEarlyNavigation(Y,K,$).then(function(d1){if(d1!==true){if(J&&J.applications&&J.applications[a1]){$.applicationConfiguration=J.applications[a1];}V=a.getInMemoryInstance(a1,Y,K,O);if(V.isInstanceSupported){e._initiateApplication($,Y,_,X,K);Z.resolve();return;}if(b1||!c1){e._initiateApplication($,Y,_,X,K);Z.resolve();return;}a.destroy(V.appId,V.container);a.removeApplication(a1);b.setApplicationInInitMode();sap.ui.getCore().getEventBus().publish("ApplicationContainer","_prior.newUI5ComponentInstantion",{name:c1});M.start("FLP:ShellController.UI5createComponent","UI5 createComponent","FLP");sap.ushell.Container.getServiceAsync("Ui5ComponentLoader").then(function(){a.createComponent($,_).done(function(){M.end("FLP:ShellController.UI5createComponent");e._initiateApplication($,Y,_,X,K);}).fail(function(e1){var f1=r.i18n.getText("cannot_load_ui5_component_details",[Y]),g1="Failed to load UI5 component for navigation intent "+Y;b.setCurrentApplication(e.currentAppBeforeNav);e.hashChangeFailure(X,{title:r.i18n.getText("error"),message:r.i18n.getText("failed_to_open_ui5_component"),technicalMessage:g1},{info:f1,technicalMessage:e1.message+"\n"+e1.stack},"sap.ushell.renderers.fiori2.Shell.controller",false);});});}Z.resolve();});},function($){var _=r.i18n.getText("cannot_resolve_navigation_target_details",[Y]),a1="Failed to resolve navigation target: "+Y+". This is most likely caused by an incorrect SAP Fiori launchpad content configuration or by missing role assignment.";e.hashChangeFailure(X,{title:r.i18n.getText("error"),message:r.i18n.getText("failed_to_open_app_missing_configuration_or_role_assignment"),technicalMessage:a1},{info:_,fixedShellHash:Y,technicalMessage:$},"sap.ushell.renderers.fiori2.Shell.controller",false);Z.reject(a1);});return Z.promise();},_handleEarlyNavigation:function(e,i,K){var O=this,Q;return new Promise(function(T){O._openAppViaNWBC(K).then(function(V){if(V===true){K.sFixedShellHash=e;O.logOpenAppAction(K,i);Q=sap.ui.getCore().byId("sapUshellDashboardPage");if(Q){Q.setBlocked(false);Q.setBusy(false);}T(true);return;}else{var X=K&&K.navigationMode===N.newWindow;if(X){K.sFixedShellHash=e;O.logOpenAppAction(K,i);O._openAppInNewWindowAndRestore(K);Q=sap.ui.getCore().byId("sapUshellDashboardPage");if(Q){Q.setBlocked(false);Q.setBusy(false);}T(true);return;}if(C.last("/core/shell/model/migrationConfig")){J.migrationConfig=false;O.getModel().setProperty("/migrationConfig",false);if(K&&e==="#"){J.rootIntent="";}else if(e==="#"){window.setTimeout(function(){window.hasher.setHash(J.rootIntent);},0);T(true);return;}}T(false);return;}});});},_initiateApplication:function(e,i,K,O){M.start("FLP:ShellController._initiateApplication","_initiateApplication","FLP");var Q=b.getMetadata(e),T=C.last("/core/extension/SupportTicket"),V;if(Q.title){window.document.title=Q.title;}else{L.debug("Shell controller._initiateApplication: the title of the window is not changed because most probably the application was resolved with undefined");}if(T){window.setTimeout(function(){U.activate();},0);}try{V=this.oShellNavigation.isInitialNavigation();this.navigate(K,i,Q,e);}catch(X){if(X.stack){L.error("Application initialization (Intent: \n"+i+"\n failed due to an Exception:\n"+X.stack);}this.oShellNavigation.setIsInitialNavigation(V);this.hashChangeFailure(O,X.name,X.message,Q?Q.title:"",false);}M.end("FLP:ShellController._initiateApplication");},_resolveHashFragment:function(e){M.start("FLP:ShellController._resolveHashFragment","_resolveHashFragment","FLP");var i,K,O=this.oURLParsing.parseShellHash(e),Q=new q.Deferred(),J=this._getConfig();K=O&&O.params||{};if(O&&O.contextRaw&&O.contextRaw==="navResCtx"&&K&&K.additionalInformation&&(K.additionalInformation[0]||K.additionalInformation[0]==="")&&K.applicationType&&K.applicationType[0]&&K.url&&K.url[0]&&K.navigationMode&&(K.navigationMode[0]||K.additionalInformation[0]==="")){K=O.params||{};i={additionalInformation:K.additionalInformation[0],applicationType:K.applicationType[0],url:K.url[0],navigationMode:K.navigationMode[0]};if(K.title){i.text=K.title[0];}Q.resolve(i,O);}else{if(window["sap-ushell-async-libs-promise-directstart"]){window["sap-ushell-async-libs-promise-directstart"].then(function(T){Q.resolve(T.resolvedHashFragment,O);delete window["sap-ushell-async-libs-promise-directstart"];},function(T){Q.reject(T);delete window["sap-ushell-async-libs-promise-directstart"];});return Q.promise();}sap.ushell.Container.getServiceAsync("NavTargetResolution").then(function(T){T.resolveHashFragment(e).done(function(i){b.setCurrentApplication(i);if(O&&(O.semanticObject+"-"+O.action)===J.rootIntent){i.navigationMode="embedded";}M.end("FLP:ShellController._resolveHashFragment");Q.resolve(i,O);}).fail(function(V){Q.reject(V);});});}return Q.promise();},_calculateNavigationMode:function(e,i){if(!i){return undefined;}var K=i.navigationMode;if(K===N.newWindowThenEmbedded){if(this._isColdStart()||(e.contextRaw&&e.contextRaw==="navResCtx")||f.getInstance().getDirection()===v.Backwards){i.navigationMode=N.embedded;}else{i.navigationMode=N.newWindow;if(!c.isNativeWebGuiNavigation(i)){i.url=this._getCurrentLocationHash();}}return i;}if(K===N.newWindow&&this._isColdStart()){if(this._hasAppCapabilitiesNavigationMode(i)&&i.appCapabilities.navigationMode===N.embedded){i.navigationMode=N.embedded;return i;}i.navigationMode=N.replace;return i;}if(K===N.newWindow&&this._hasAppCapabilitiesNavigationMode(i)&&i.appCapabilities.navigationMode===N.embedded){i.url=this._getCurrentLocationHash();}return i;},_hasAppCapabilitiesNavigationMode:function(e){return c.isPlainObject(e.appCapabilities)&&e.appCapabilities.hasOwnProperty("navigationMode");},_usesNavigationRedirect:function(e){if(!e){return new q.Deferred().reject().promise();}var i=this,K=e.getInstance({});if(K&&typeof K.navigationRedirect==="function"){var O=new q.Deferred();var Q=K.navigationRedirect();if(Q&&typeof Q.then==="function"){Q.then(function(T){L.warning("Performing navigation redirect to hash "+T);K.destroy();i.history.pop();sap.ushell.Container.getServiceAsync("ShellNavigation").then(function(V){V.toExternal({target:{shellHash:T}},undefined,false);O.resolve(true);});},function(){O.reject();});return O.promise();}}return new q.Deferred().reject().promise();},navigate:function(e,i,K,O){M.start("FLP:ShellController.navigate","navigate","FLP");var Q=(m(O)?O.navigationMode:null),T=this;if(Q===null){if(this._isColdStart()){window.hasher.setHash("");return;}this.bEnableHashChange=false;this.history.pop();this._windowHistoryBack(1);return Promise.resolve();}O=this._calculateNavigationMode(e,O);Q=(m(O)?O.navigationMode:null);if(Q===N.embedded){if(!this._isColdStart()&&!this._wasHistoryEntryReplaced){this.oShellNavigation.setIsInitialNavigation(false);}var V=this._usesNavigationRedirect(O.componentHandle),X=new Promise(function(Y,Z){V.then(null,function(){T._handleEmbeddedNavMode(i,e,K,O).then(function(){E.emit("CloseFesrRecord",Date.now());Y();});if(e&&e.contextRaw==="navResCtx"){L.error(" This path will no longer be supported in 1.40");T.bEnableHashChange=false;if(e&&e.params&&e.params.original_intent&&e.params.original_intent[0]){window.hasher.replaceHash(e.params.original_intent[0]);T.history._history[0]=e.params.original_intent[0];}}});M.end("FLP:ShellController.navigate");});return X;}if(Q===N.replace){this.oShellNavigation.setIsInitialNavigation(false);this.bEnableHashChange=false;this._changeWindowLocation(O.url);return Promise.resolve();}if(Q===N.newWindow){this._openAppInNewWindowAndRestore(O);return Promise.resolve();}this.hashChangeFailure(this.history.getHistoryLength(),"Navigation mode is not recognized",null,"sap.ushell.renderers.fiori2.Shell.controller",false);return Promise.resolve();},_openAppViaNWBC:function(i){var K=this;return new Promise(function(O){var Q;if(i&&(c.isNativeWebGuiNavigation(i)||i.nativeNWBCNavigation)){Q=true;}else{Q=false;}if(Q===false){O(false);return;}var T=c.getPrivateEpcm(),V=G[i.navigationMode],X,Y,Z;if(c.hasNavigationModeCapability()){Y=V||G[N.embedded];}Z=K._appendUserIdToUrl("sap-user",i.url).then(function($){X=c.appendSapShellParam($);return new Promise(function(_){try{var a1=i.applicationType,b1=(i.appCapabilities&&i.appCapabilities.appFrameworkId),c1={},d1=[],e1,f1=function(){c1["sap-flp-url"]=sap.ushell.Container.getFLPUrl(true);c1["system-alias"]=i.systemAlias;return[{name:"sap-flp-params",value:JSON.stringify(c1)}];},g1=function g1(h1,d1){var i1=[],j1,k1=function(l1,m1){if(h1.indexOf(l1+"=")>0){j1=new RegExp("(?:"+l1+"=)([^&/]+)").exec(h1);if(j1&&j1.length===2){i1.push([j1[1]]);d1.push(m1);}}};k1("sap-iapp-state","sap-iapp-state-data");k1("sap-xapp-state","sap-xapp-state-data");k1("sap-intent-param","sap-intent-param-data");return i1;};if(a1==="GUI"||a1==="TR"||a1==="NWBC"||a1==="WDA"||b1==="GUI"||b1==="WDA"||b1==="NWBC"){sap.ushell.Container.getServiceAsync("CrossApplicationNavigation").then(function(h1){e1=g1(X,d1);if(e1.length>0){h1.getAppStateData(e1).then(function(i1){d1.forEach(function(j1,k1){if(i1[k1][0]){c1[j1]=i1[k1][0];}});_(f1());},function(i1){_();});}else{_(f1());}});}else{_();}}catch(e){_();}});});Z.then(function($){try{sap.ui.getCore().getEventBus().publish("launchpad","appOpening",i);if(!T.doNavigate(X,Y,undefined,undefined,undefined,undefined,undefined,$)){O(false);return;}sap.ui.getCore().getEventBus().publish("sap.ushell","appOpened",i);K._restorePreviousHashAfterOpenNewWindow(i);if(sap.ushell.Container.getRenderer().getCurrentCoreView()==="home"){K._toggleMenu(true);}O(true);}catch(e){if(e.stack){L.error("Application initialization failed due to an Exception:\n"+e.stack);}K.hashChangeFailure(K.history.getHistoryLength(),e.name,e.message,i.text,false);O(false);}});});},_appendUserIdToUrl:function(e,i){return sap.ushell.Container.getServiceAsync("UserInfo").then(function(K){var O=K.getUser().getId(),Q=i.indexOf("?")>=0?"&":"?";return i+Q+e+"="+O;});},_restorePreviousHashAfterOpenNewWindow:function(e){this.history.pop();var V=e.componentHandle&&e.componentHandle.getInstance&&e.componentHandle.getInstance({});if(V){V.destroy();}this._resumeAppRouterIgnoringCurrentHash();this.bRestorePreviousHash=true;this._windowHistoryBack(1);b.setCurrentApplication(this.currentAppBeforeNav);E.emit("openedAppInNewWindow",Date.now());},_openAppInNewWindowAndRestore:function(e){sap.ui.getCore().getEventBus().publish("launchpad","appOpening",e);this._openAppNewWindow(e.url);sap.ui.getCore().getEventBus().publish("sap.ushell","appOpened",e);this._restorePreviousHashAfterOpenNewWindow(e);},_handleEmbeddedNavMode:function(e,i,K,O){M.start("FLP:ShellController._handleEmbeddedNavMode","_handleEmbeddedNavMode","FLP");var J=this._getConfig(),Q,T,V,X;this.resetShellUIServiceHandlers();a.getAppMeta().setAppIcons(K);Q="-"+i.semanticObject+"-"+i.action;V=e==="#"||(J.rootIntent&&c.getBasicHash(J.rootIntent)===i.semanticObject+"-"+i.action);X=i?i.semanticObject+"-"+i.action:"";a.switchViewState(a.shellElements().calculateElementsState(V?"home":"app",O.applicationType,J.appState,O.explicitNavMode),undefined,Q);if(V){a.getShellUIService().setBackNavigation();}T=a.handleControl(X,Q,i,O,this.getWrappedApplicationWithMoreStrictnessInIntention.bind(this),e);if(this.currentAppBeforeNav){var Y;Y=a.getWebGuiV1StatefulContainer(this.currentAppBeforeNav.url);if(Y){Y.onApplicationOpened(O.applicationType);}}M.end("FLP:ShellController._handleEmbeddedNavMode");return T;},_centerViewPort:function(){this.oViewPortContainer.switchState("Center");},_isShellHomeIntent:function(i){return i==="#"||i===J.rootIntent;},getWrappedApplicationWithMoreStrictnessInIntention:function(i,e,K,O,Q,T,V){var X,Y,Z,$=this;window.setTimeout(function(){window.setTimeout(function(){var _;if(C.last("/core/shell/model/currentState/stateName")==="app"){_=sap.ui.getCore().byId("shellAppTitle").getFocusDomRef().getAttribute("id");}A.sendFocusBackToShell(_);window.setTimeout(function(){$.readNavigationEnd();},500);},100);sap.ui.getCore().getEventBus().publish("launchpad","appOpening",O);L.info("app is being opened");},0);if(J.applications){O.applicationConfiguration=J.applications[i];}X=a.getAppContainer(Q,O,this._isColdStart(),K,V);O.sFixedShellHash=V;a.publishNavigationStateEvents(X,O,this.onAppAfterRendering.bind(this,O));X.addStyleClass("sapUshellApplicationPage");Y=X.getApplicationType();Z=X.getFrameworkId();if(Y==="GUI"||Y==="TR"||Y==="WDA"||Y==="NWBC"||Z==="GUI"||Z==="WDA"||Z==="NWBC"){X.addStyleClass("sapUShellApplicationContainerShiftedIframe");}if(!T){X.addStyleClass("sapUShellApplicationContainerLimitedWidth");}if(this._isDock()&&window.matchMedia("(min-width: 106.4rem)").matches){X.addStyleClass("sapUShellDockingContainer");X.removeStyleClass("sapUShellApplicationContainerLimitedWidth");}else if(this._isDock()){X.removeStyleClass("sapUShellApplicationContainerLimitedWidth");}X.toggleStyleClass("sapUshellDefaultBackground",!e.hideLightBackground);a.getAppMeta()._applyContentDensityByPriority();a.addControl(X);c.setPerformanceMark("FLP - addAppContainer");M.end("FLP:ShellController.getWrappedApplication");return X;},resetShellUIServiceHandlers:function(){a.getAppMeta().resetShellUIServiceHandlers();a.setBackNavigationChanged(false);},onAppAfterRendering:function(e){var i=a.getShellUIService();window.setTimeout(function(){sap.ui.getCore().getEventBus().publish("sap.ushell","appOpened",e);L.info("app was opened");},0);var K=a._publicEventDataFromResolutionResult(e);E.emit("AppRendered",K,true);sap.ushell.renderers.fiori2.utils.publishExternalEvent("appOpened",K);c.setPerformanceMark("FLP.appOpened");if(i){a.initAppMetaParams();}y.updateStateProperty("application/icon",a.getAppMeta().getAppIcon(),true);y.updateStateProperty("application/showNavMenuTitle",this.bNavMenuTitleVisible,true);},_saveHomePageComponent:function(){if(this.oHomeApp){return;}var e=this,i="sap.ushell",K=function(O,Q,T){e.oHomeApp=T.component;sap.ui.getCore().getEventBus().unsubscribe(i,"appComponentLoaded",K);};sap.ui.getCore().getEventBus().subscribe(i,"appComponentLoaded",K);},hashChangeFailure:function(i,e,K,O,Q){var T=sap.ui.getCore().byId("sapUshellDashboardPage");if(T){T.setBlocked(false);T.setBusy(false);}if(c.isPlainObject(e)){this.reportError(e.technicalMessage,K.technicalMessage,O);sap.ushell.Container.getServiceAsync("Message").then(function(V){V.show(p.Type.ERROR,e.message,{title:e.title,details:K});});}else{this.reportError(e,K,O);this.delayedMessageError(r.i18n.getText("fail_to_start_app_try_later"));}x=false;this._resumeAppRouterIgnoringCurrentHash();if(i===0){window.hasher.setHash("");}else if((new n(window.location.href)).get("bFallbackToShellHome")){window.hasher.setHash("");}else{this.bEnableHashChange=Q;sap.ushell.Container.setDirtyFlag(P);a.postMessageToIframeApp("sap.ushell.appRuntime","setDirtyFlag",{bIsDirty:P});this._windowHistoryBack(1);}},reportError:function(e,i,K){L.error(e,i,K);},delayedMessageError:function(e){window.setTimeout(function(){if(sap.ushell.Container!==undefined){sap.ushell.Container.getServiceAsync("Message").then(function(i){i.error(e);});}},0);},fixShellHash:function(e){if(!e){e="#";}else if(e.charAt(0)!=="#"){e="#"+e;}return e;},_openAppNewWindow:function(e){if(e.trim().indexOf("sap-nwbc://")===0&&(D.browser.edge||D.browser.msie)){window.location.href=e;}else{var i=W.openURL(e);if(!i&&(!(D.browser.msie||D.browser.edge)&&!this._checkWindowLocationSearch("workzone-mobile-app=true"))){var K=r.i18n.getText("fail_to_start_app_popup_blocker",[window.location.hostname]);this.delayedMessageError(K);}}},_checkWindowLocationSearch:function(T){return window.location.search.indexOf(T)>-1;},_windowHistoryBack:function(i){window.history.go(-1*i);},_windowHistoryForward:function(i){window.history.go(i);},_changeWindowLocation:function(e){window.location.href=e;},_toggleMenu:function(V){var e=sap.ui.getCore().byId("menuBarComponentContainer");var i=e&&e.getComponentInstance&&e.getComponentInstance();if(i&&i.setVisible){i.setVisible(V);}},onAppOpened:function(e,i,K){if(K.targetNavigationMode!=="explace"&&K.targetNavigationMode!=="frameless"){this._toggleMenu(false);}var O=this.oShellNavigation.hashChanger.getAppHash(),Q=O?"&/"+O:null;this.logOpenAppAction(K,Q);},externalSearchTriggered:function(e,i,K){C.emit("/core/shell/model/searchTerm",K.searchTerm);K.query=K.searchTerm;},onBeforeNavigate:function(e){var T=e.getParameter("to"),O=this.getOwnerComponent(),i=O.byId("Shell-home-component-container"),K=O.byId("pages-component-container"),Q=T===i||T===K;a.onBeforeNavigate(e.getParameter("fromId"),e.getParameter("from"),e.getParameter("toId"),e.getParameter("to"));this._toggleMenu(Q);},onAfterNavigate:function(e){var T=e.mParameters?e.mParameters.toId:undefined;var i=sap.ui.getCore().byId("sapUshellDashboardPage");if(i){i.setBlocked(false);i.setBusy(false);}a.onAfterNavigate(e.getParameter("fromId"),e.getParameter("from"),T,e.getParameter("to"));sap.ui.getCore().getEventBus().publish("sap.ushell","navigated",{});},logOpenAppAction:function(e,i){var K=C.last("/core/shell/enableRecentActivity")&&C.last("/core/shell/enableRecentActivityLogging");if(!K){return;}var O={};var Q=b.getMetadata(e);var T=e.sFixedShellHash;var V=T;if(i){V+=i;}O.title=Q.title;O.appType=w.APP;O.url=V;var X=this.oURLParsing.parseShellHash(T);if(X){O.appId="#"+this.oURLParsing.constructShellHash({semanticObject:X.semanticObject,action:X.action});}else{O.appId=T;}if(T&&T.indexOf("#Action-search")===-1){window.setTimeout(function(){this._logRecentActivity(O);}.bind(this),1500);}},_logSearchActivity:function(){if(C.last("/core/shell/enableRecentActivity")&&C.last("/core/shell/enableRecentActivityLogging")){var T="";try{T=sap.ui.getCore().byId("searchFieldInShell-input").getModel().getLastSearchTerm();}catch(e){L.error("Shell: last search term is not available to log a recent activity");}this._logRecentActivity({appId:"#Action-search",appType:w.SEARCH,title:T,url:"#"+window.hasher.getHash()});}},readNavigationEnd:function(){var e=document.getElementById("sapUshellLoadingAccessibilityHelper-loadingComplete");if(e){e.setAttribute("aria-live","polite");e.innerHTML=r.i18n.getText("loadingComplete");window.setTimeout(function(){e.setAttribute("aria-live","off");e.innerHTML="";},0);}},handleNavMenuTitleVisibility:function(e){this.bNavMenuTitleVisible=false;if(e.name!=="Desktop"){this.bNavMenuTitleVisible=true;}y.updateStateProperty("application/showNavMenuTitle",this.bNavMenuTitleVisible,true);},_loadCoreExtNonUI5:function(e){if(e&&e.applicationType!=="SAPUI5"){this._loadCoreExt();}},_loadUsageAnalytics:function(e){sap.ushell.Container.getServiceAsync("UsageAnalytics").then(function(i){i.init(r.i18n.getText("usageAnalytics"),r.i18n.getText("i_agree"),r.i18n.getText("i_disagree"),r.i18n.getText("remind_me_later"));E.emit("StepDone",e.stepName);},function(){E.emit("StepFailed",e.stepName);});},_onCoreResourcesComplementLoaded:function(){c.setPerformanceMark("SchedulingAgent-StartOfFlow");var V=this.getView();if(V){V.createPostCoreExtControls();}S._initialize();E.emit("startScheduler");},_loadRendererExtensionPlugins:function(e){var i=new n(window.location.href),K=i.get("sap-ushell-xx-pluginmode")==="delayed";function O(Q){function T(){E.emit("StepDone",e.stepName);}function V(){Q.loadPlugins("RendererExtensions").always(T);}if(!J.inHeaderLessOpt){if(K){window.setTimeout(V,5000);}else{V();}}else{T();}}sap.ushell.Container.getServiceAsync("PluginManager").then(O.bind(this));},_loadWarmupPlugins:function(e){sap.ushell.Container.getServiceAsync("PluginManager").then(function(i){i.loadPlugins("AppWarmup").always(function(){L.debug("WARMUP plugins loaded",null,"sap.ushell.renderers.fiori2.Shell");E.emit("StepDone",e.stepName);c.setPerformanceMark("SchedulingAgent-EndOfFlow");c.setPerformanceMeasure("SchedulingAgentTotalTime","SchedulingAgent-StartOfFlow","SchedulingAgent-EndOfFlow");});});},_loadCoreExt:function(){M.end("FLP:Container.InitLoading");sap.ushell.Container.getServiceAsync("Ui5ComponentLoader").then(function(){E.emit("loadCoreResourcesComplement");});},getCurrentViewportState:function(){return C.last("/core/shell/model/currentViewPortState");},_activateFloatingUIActions:function(i){if(i<417){this.oFloatingUIActions.disable();}else{this.oFloatingUIActions.enable();}},setFloatingContainerDragSelector:function(e){q(e).addClass("sapUshellShellFloatingContainerSelector");sap.ui.require(["sap/ushell/UIActions"],function(i){if(!this.oFloatingUIActions){this.oFloatingUIActions=new i({containerSelector:".sapUiBody",wrapperSelector:".sapUshellShellFloatingContainerWrapper",draggableSelector:".sapUshellShellFloatingContainerWrapper",rootSelector:".sapUiBody",cloneClass:"sapUshellFloatingContainer-clone",dragCallback:this._handleFloatingContainerUIStart.bind(this),endCallback:this._handleFloatingContainerDrop.bind(this),moveTolerance:3,onDragStartUIHandler:this._onDragStartUI.bind(this),onDragEndUIHandler:this._setFloatingContainerHeight.bind(this),dragAndScrollCallback:this._doDock.bind(this),switchModeDelay:1000,isLayoutEngine:false,isTouch:false,elementToCapture:e,defaultMouseMoveHandler:function(){},debug:q.sap.debug()});}else{this.oFloatingUIActions.elementsToCapture=q(e);}this._activateFloatingUIActions(q(window).width());var K;q(window).bind("resize",function(){clearTimeout(K);K=window.setTimeout(this._activateFloatingUIActions(q(window).width()),300);}.bind(this));}.bind(this));},_doDock:function(e){M.start("FLP:Shell.controller._doDock","dragging co-pilot element","FLP");var i=D.media.getCurrentRange(D.media.RANGESETS.SAP_STANDARD);if(i.name==="Desktop"){var K=q(window).width();if(e){e.docked={};var O=e.docked;if(e.moveX>=K-64){O.dockPos="right";O.setIsDockingAreaOpen=true;this._openDockingArea(e);}else if(e.moveX<64){O.dockPos="left";O.setIsDockingAreaOpen=true;this._openDockingArea(e);}else{if(this._isDockingAreaOpen()){this._closeDockingArea(e);}if(q("#canvas").hasClass("sapUshellContainerDocked")){this._handleCloseCanvas(e);}}}}M.end("FLP:Shell.controller._doDock");},_finishDoDock:function(e){this._openDockingArea(false);var i=new o(o.Type.local,"com.sap.ushell.adapters.local.CopilotLastState");i.put("lastState","docked:"+e.dockPos);this._handleOpenCanvas(e);var K=q("#sapUshellFloatingContainerWrapper");K.css("height","100%");q("#shell-floatingContainer").addClass("sapUshellShellFloatingContainerFullHeight");sap.ui.getCore().getEventBus().publish("launchpad","shellFloatingContainerIsDocked");},_onResizeWithDocking:function(){this.handleNavMenuTitleVisibility(D.media.getCurrentRange(D.media.RANGESETS.SAP_STANDARD));window.setTimeout(function(){sap.ui.getCore().getEventBus().publish("launchpad","appFinderWithDocking");},300);},_onDragStartUI:function(e){M.start("FLP:Shell.controller._onDragStartUI","start drag","FLP");if(this._isDock()){var i=new o(o.Type.local,"com.sap.ushell.adapters.local.CopilotLastState");i.put("lastState","floating");q("#sapUshellFloatingContainerWrapper").removeClass("sapUshellContainerDocked");q(".sapUshellShellFloatingContainerFullHeight").removeClass("sapUshellShellFloatingContainerFullHeight");sap.ui.getCore().getEventBus().publish("launchpad","shellFloatingContainerIsUnDocked");q("#sapUshellFloatingContainerWrapper").removeClass("sapUshellContainerDockedMinimizeCoPilot sapUshellContainerDockedExtendCoPilot");q("#sapUshellFloatingContainerWrapper").addClass("sapUshellContainerDockedMinimizeCoPilot");q(q(".sapUshellContainerDockedMinimizeCoPilot")).on("webkitAnimationEnd oanimationend msAnimationEnd animationend",this._handleAnimations(false));this._handleCloseCanvas(e);}M.end("FLP:Shell.controller._onDragStartUI");},_handleAnimations:function(i){var e="sapUshellContainerDockedLaunchpad";var K=q("#sapUshellFloatingContainerWrapper");if(i){q("#canvas, #shell-header").addClass(e);K.addClass("sapUshellContainerDockedExtendCoPilot");this._onResizeWithDocking();}else{q("#sapUshellFloatingContainerWrapper").addClass("sapUshellContainerDockedExtendCoPilot");}},_openDockingArea:function(e){var i=e?e.docked:false;var K=i?i.setIsDockingAreaOpen:false;if(K&&q("#DockinaAreaDiv").length==0){var O=sap.ui.getCore().getConfiguration().getRTL();if((i.dockPos==="right"&&e.clone&&!O)||(i.dockPos==="left"&&e.clone&&O)){q("<div id=\"DockinaAreaDiv\"  class=\"sapUshellShellDisplayDockingAreaRight\">").appendTo(e.clone.parentElement);}else if((i.dockPos==="left"&&e.clone&&!O)||(i.dockPos==="right"&&e.clone&&O)){q("<div id=\"DockinaAreaDiv\"  class=\"sapUshellShellDisplayDockingAreaLeft\">").appendTo(e.clone.parentElement);}e.clone.oDockedProp={};e.clone.oDockedProp.dockPos=i.dockPos;}else if(!K){this._closeDockingArea();}},_closeDockingArea:function(){window.setTimeout(function(){q(".sapUshellShellDisplayDockingAreaRight").remove();q(".sapUshellShellDisplayDockingAreaLeft").remove();},150);},_isDock:function(){return q(".sapUshellContainerDocked").length!==0;},_isDockingAreaOpen:function(){return q(".sapUshellShellDisplayDockingAreaRight").length!==0||q(".sapUshellShellDisplayDockingAreaLeft").length!==0;},_handleOpenCanvas:function(e){var i=q("#canvas");var K=q(".sapUshellShellHead");var O=sap.ui.getCore().getConfiguration().getRTL();if((e.dockPos==="right"&&!O)||(e.dockPos==="left"&&O)){i.addClass("sapUshellContainer-Narrow-Right sapUshellContainerDocked ");K.addClass("sapUshellHead-Narrow-Right sapUshellContainerDocked");}if((e.dockPos==="left"&&!O)||(e.dockPos==="right"&&O)){i.addClass("sapUshellContainer-Narrow-Left sapUshellContainerDocked ");K.addClass("sapUshellHead-Narrow-Left sapUshellContainerDocked");}var V=sap.ui.getCore().byId("viewPortContainer");if(V){V._handleSizeChange();}},_handleCloseCanvas:function(e){var i=q("#canvas");var K=q(".sapUshellShellHead");if(e){e.docked.setIsDockingAreaOpen=false;}if(i.hasClass("sapUshellContainer-Narrow-Right")){i.removeClass("sapUshellContainer-Narrow-Right sapUshellContainerDocked sapUshellMoveCanvasRight");K.removeClass("sapUshellHead-Narrow-Right sapUshellContainerDocked");this._openDockingArea(e);this._setFloatingContainerHeight();}if(i.hasClass("sapUshellContainer-Narrow-Left")){i.removeClass("sapUshellContainer-Narrow-Left sapUshellContainerDocked sapUshellMoveCanvasLeft");K.removeClass("sapUshellHead-Narrow-Left sapUshellContainerDocked");this._openDockingArea(e);this._setFloatingContainerHeight();}this._onResizeWithDocking();var V=sap.ui.getCore().byId("viewPortContainer");if(V){V._handleSizeChange();}},_setFloatingContainerHeight:function(e){var i=q(window).width();var K=q("#sapUshellFloatingContainerWrapper");if(this._isDock()){if(e&&(e.clientX>=i-64||e.clientX<64)){K.addClass(" sapUshellContainerDocked");K.addClass("sapUshellContainerDockedMinimizeCoPilot");q(K).on("webkitAnimationEnd oanimationend msAnimationEnd animationend",this._handleAnimations(true));}}else if(!this._isDock()){q("#sapUshellFloatingContainerWrapper").removeClass("sapUshellContainerDockedMinimizeCoPilot sapUshellContainerDockedExtendCoPilot");}},_handleFloatingContainerDrop:function(e,i,K){M.start("FLP:Shell.controller._handleFloatingContainerDrop","drop floating container","FLP");var O=i.firstChild?sap.ui.getCore().byId(i.firstChild.id):undefined,Q=new o(o.Type.local,"com.sap.ushell.adapters.local.FloatingContainer"),T=q(window).width(),V=q(window).height(),X=K.deltaX/T,Y=K.deltaY/V,Z=i.style.visibility,$=i.style.display,_=parseFloat(i.style.left.replace("%","")),a1=parseFloat(i.style.top.replace("%",""));if(typeof(_)==="number"){X=_+100*K.deltaX/T;}if(typeof(a1)==="number"){Y=a1+100*K.deltaY/V;}if(this._isDockingAreaOpen()){Y=0;}i.style.left=X+"%";i.style.top=Y+"%";i.style.position="absolute";i.style.display="block";i.visibility=Z;i.display=$;Q.put("floatingContainerStyle",i.style.cssText);if(O){O.handleDrop();if(!!K.clone.oDockedProp&&this._isDockingAreaOpen()){this._finishDoDock(K.clone.oDockedProp);}}M.end("FLP:Shell.controller.handleFloatingContainerDrop");},_handleFloatingContainerUIStart:function(i,K){M.start("FLP:Shell.controller._handleFloatingContainerUIStart","starts dragging floating container","FLP");var O=K;O.style.display="none";if(window.getSelection){var Q=window.getSelection();try{Q.removeAllRanges();}catch(e){}}M.end("FLP:Shell.controller._handleFloatingContainerUIStart");},getFloatingContainerState:function(){var e=new o(o.Type.local,"com.sap.ushell.adapters.local.CopilotLastState");var i="floating";if(e!=null){i=e.get("lastState");if(i==null){i="floating";}}return i;},setFloatingContainerVisibility:function(V){var e=this.getFloatingContainerState();if(e){if(e=="floating"){this.getView().getOUnifiedShell().setFloatingContainerVisible(V);}else if(e.indexOf("docked")!=-1){var i=sap.ui.getCore().byId("viewPortContainer");if(V==true){var K=D.media.getCurrentRange(D.media.RANGESETS.SAP_STANDARD);if(K.name=="Desktop"){var O=q("#sapUshellFloatingContainerWrapper");O.addClass("sapUshellContainerDocked");q("#canvas, .sapUshellShellHead").addClass("sapUshellContainerDocked");O.css("height","100%");sap.ui.getCore().byId("shell-floatingContainer").addStyleClass("sapUshellShellFloatingContainerFullHeight");if(i){i._handleSizeChange();}if(sap.ui.getCore().getConfiguration().getRTL()){if(e.indexOf("right")!=-1){q("#canvas").addClass("sapUshellContainer-Narrow-Left");q(".sapUshellShellHead").addClass("sapUshellHead-Narrow-Left");this._handleAnimations(true);}else{q("#canvas").addClass("sapUshellContainer-Narrow-Right");q(".sapUshellShellHead").addClass("sapUshellHead-Narrow-Right");this._handleAnimations(true);}}else if(e.indexOf("right")!=-1){q("#canvas").addClass("sapUshellContainer-Narrow-Right");q(".sapUshellShellHead").addClass("sapUshellHead-Narrow-Right");this._handleAnimations(true);}else{q("#canvas").addClass("sapUshellContainer-Narrow-Left");q(".sapUshellShellHead").addClass("sapUshellHead-Narrow-Left");this._handleAnimations(true);}window.setTimeout(function(){this.getView().getOUnifiedShell().setFloatingContainerVisible(V);}.bind(this),400);}else{new o(o.Type.local,"com.sap.ushell.adapters.local.CopilotLastState").put("lastState","floating");this.getView().getOUnifiedShell().setFloatingContainerVisible(V);}}else{this._handleAnimations(false);if(i){i._handleSizeChange();}window.setTimeout(function(){this.getView().getOUnifiedShell().setFloatingContainerVisible(V);}.bind(this),400);q("#canvas, .sapUshellShellHead").removeClass("sapUshellContainerDocked sapUshellContainer-Narrow-Right sapUshellContainer-Narrow-Left");}q("#sapUshellFloatingContainerWrapper").removeClass("sapUshellContainerDockedMinimizeCoPilot sapUshellContainerDockedExtendCoPilot");this._onResizeWithDocking();if(i){i._handleSizeChange();}}}},getFloatingContainerVisibility:function(){return this.getView().getOUnifiedShell().getFloatingContainerVisible();},setFloatingContainerContent:function(e,i,K,O){y.setFloatingContainerContent(e,i,K,O);},getRightFloatingContainerVisibility:function(){var e=this.getView().getOUnifiedShell().getRightFloatingContainer(),i=e&&e.getVisible();return i;},setHeaderTitle:function(T){j.updateStates({propertyName:"title",value:T||"",aStates:["home","app"],bCurrentState:false,bDoNotPropagate:false});},setFooter:function(e){var i=this.getView().getOUnifiedShell();if(typeof e!=="object"||!e.getId){throw new Error("oFooter value is invalid");}if(i.getFooter()!==null){L.warning("You can only set one footer. Replacing existing footer: "+i.getFooter().getId()+", with the new footer: "+e.getId()+".");}i.setFooter(e);},removeFooter:function(){this.getView().getOUnifiedShell().setFooter(null);},addUserPreferencesEntry:function(e){this._validateUserPrefEntryConfiguration(e);this._updateUserPrefModel(e);},addUserProfilingEntry:function(e){this._validateUserPrefEntryConfiguration(e);this._updateProfilingModel(e);},_validateUserPrefEntryConfiguration:function(e){if((!e)||(typeof e!=="object")){throw new Error("object oConfig was not provided");}if(!e.title){throw new Error("title was not provided");}if(!e.value){throw new Error("value was not provided");}if(typeof e.entryHelpID!=="undefined"){if(typeof e.entryHelpID!=="string"){throw new Error("entryHelpID type is invalid");}else if(e.entryHelpID===""){throw new Error("entryHelpID type is invalid");}}if(e.title&&typeof e.title!=="string"){throw new Error("title type is invalid");}if(typeof e.value!=="function"&&typeof e.value!=="string"&&typeof e.value!=="number"){throw new Error("value type is invalid");}if(e.onSave&&typeof e.onSave!=="function"){throw new Error("onSave type is invalid");}if(e.content&&typeof e.content!=="function"){throw new Error("content type is invalid");}if(e.onCancel&&typeof e.onCancel!=="function"){throw new Error("onCancel type is invalid");}},_createSessionHandler:function(J){var e=this,i=20000;sap.ui.require(["sap/ushell/SessionHandler"],function(K){e.oSessionHandler=new K(a);e.oSessionHandler.initLogout();window.setTimeout(function(){e.oSessionHandler.init({sessionTimeoutReminderInMinutes:J.sessionTimeoutReminderInMinutes,sessionTimeoutIntervalInMinutes:J.sessionTimeoutIntervalInMinutes,sessionTimeoutTileStopRefreshIntervalInMinutes:J.sessionTimeoutTileStopRefreshIntervalInMinutes,enableAutomaticSignout:J.enableAutomaticSignout});},i);});},_getSessionHandler:function(){return this.oSessionHandler;},_navBack:function(){this.setMeAreaSelected(false);a.service().navigateBack();},_updateUserPrefModel:function(e){var i=this._getModelEntryFromEntryObject(e),K=C.last("/core/userPreferences/entries");K.push(i);K=this._reorderUserPrefEntries(K);C.emit("/core/userPreferences/entries",K);},_updateProfilingModel:function(e){var i=this._getModelEntryFromEntryObject(e),K=C.last("/core/userPreferences/profiling")||[];K.push(i);C.emit("/core/userPreferences/profiling",K);},_getModelEntryFromEntryObject:function(e){return{entryHelpID:e.entryHelpID,title:e.title,valueArgument:e.value,valueResult:null,onSave:e.onSave,onCancel:e.onCancel,contentFunc:e.content,contentResult:null,icon:e.icon,provideEmptyWrapper:e.provideEmptyWrapper};},_reorderUserPrefEntries:function(e){var K=[],O=["userAccountEntry","themes","homepageEntry","spacesEntry","userActivitiesEntry","userProfiling","language","notificationsEntry","userDefaultEntry"],Q,T={};for(var i=e.length-1;i>=0;i--){if(O.indexOf(e[i].id)!==-1){Q=e.splice(i,1)[0];T[Q.id]=Q;}}O.forEach(function(V){var X=T[V];if(X){K.push(X);}});return K.concat(e);},getModel:function(){return B;},_getConfig:function(){return J||{};},_getPersData:function(e){var i=d.getOwnerComponentFor(this.getView());return new Promise(function(K,O){sap.ushell.Container.getServiceAsync("Personalization").then(function(Q){var T={keyCategory:Q.constants.keyCategory.FIXED_KEY,writeFrequency:Q.constants.writeFrequency.LOW,clientStorageAllowed:true};var V=Q.getPersonalizer(e,T,i);V.getPersData().then(K).fail(O);});});},_getCurrentLocationHash:function(){return window.location.hash;},setMeAreaSelected:function(e){E.emit("showMeArea",e);},getMeAreaSelected:function(){return C.last("/core/shell/model/currentViewPortState")==="LeftCenter";},setNotificationsSelected:function(e){E.emit("showNotifications",e);},getNotificationsSelected:function(){return C.last("/core/shell/model/currentViewPortState")==="RightCenter";}});});
