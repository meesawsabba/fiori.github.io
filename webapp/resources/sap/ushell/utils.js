// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/ObjectPath","sap/base/util/uid","sap/base/util/UriParameters","sap/ui/Device","sap/ui/thirdparty/jquery","sap/ui/thirdparty/URI","sap/ushell/utils/clone","sap/ushell/utils/UrlParsing","sap/ushell/utils/objectOperations","sap/ushell/utils/type"],function(L,O,U,b,D,q,c,u,d,f,g){"use strict";var h={};h.isArray=g.isArray;h.isPlainObject=g.isPlainObject;h.isDefined=g.isDefined;h.clone=u;h.getMember=f.getMember;h.updateProperties=f.updateProperties;h.getNestedObjectProperty=f.getNestedObjectProperty;h.removeDuplicatedActions=function(a){if(Array.isArray(a)){var F=a.reduce(function(r,i){if(r.indexOf(i)<0){r.push(i);}return r;},[]);return F;}return a;};h.storeSapSystemData=function(s,S){var k,l,a,i=[s.id];if(arguments.length>1){i.unshift(S);}try{a=JSON.stringify(s);}catch(e){L.error("Cannot stringify and store expanded system data: "+e);}if(a){l=h.getLocalStorage();k=h.generateLocalStorageKey("sap-system-data",i);l.setItem(k,a);}};h.getLocalSystemInSidFormat=function(){var s=sap.ushell.Container.getLogonSystem(),S=s.getName(),a=s.getClient();return"sid("+S+"."+a+")";};h.matchesLocalSid=function(s){return h.getLocalSystemInSidFormat().toLowerCase()===s.toLowerCase();};h.storeSapSystemToLocalStorage=function(a){var p=(a||{}).params;if(!p||!p.hasOwnProperty("sap-system")){return;}if(h.isPlainObject(p["sap-system"])){var s=p["sap-system"],S=p["sap-system-src"];if(typeof S==="string"){h.storeSapSystemData(s,S);p["sap-system-src"]=S;}else{h.storeSapSystemData(s);}p["sap-system"]=s.id;}else if(h.matchesLocalSid(p["sap-system"])){delete p["sap-system"];}};h.setPerformanceMark=function(m,C){if(performance&&performance.mark){if(!C){C={};}if(C.bUseUniqueMark){if(C.bUseLastMark){performance.clearMarks(m);}else if(performance.getEntriesByName(m,"mark").length>0){return;}}performance.mark(m);}};h.setPerformanceMeasure=function(m,s,e){if(performance&&performance.measure&&s&&e){performance.measure(m,s,e);}};h.Error=function(m,C){this.name="sap.ushell.utils.Error";this.message=m;L.error(m,null,C);};h.Error.prototype=new Error();h.localStorageSetItem=function(k,v,l){var E;try{localStorage.setItem(k,v);if(l){E=document.createEvent("StorageEvent");E.initStorageEvent("storage",false,false,k,"",v,"",localStorage);dispatchEvent(E);}}catch(e){L.warning("Error calling localStorage.setItem(): "+e,null,"sap.ushell.utils");}};h.getLocalStorage=function(){return window.localStorage;};h.getLocalStorageItem=function(k){return window.localStorage.getItem(k);};h.generateUniqueId=function(t){var s,e,i;if(Array.isArray(t)){e=t;i=function(G){return e.indexOf(G)===-1;};}else{i=t;}do{s=h._getUid();}while(!i(s));return s;};h._getUid=function(){return U();};h.reload=function(){location.reload();};h.calculateOrigin=function(o){var a;if(o.origin){return o.origin;}if(o.protocol&&o.hostname){return o.protocol+"//"+o.hostname+(o.port?":"+o.port:"");}if(o.href){a=new c(o.href);return a.protocol()+"://"+a.hostname()+(a.port()?":"+a.port():"");}return undefined;};h.getPrivateEpcm=function(){if(window.external&&window.external&&typeof window.external.getPrivateEpcm!=="undefined"){return window.external.getPrivateEpcm();}return undefined;};h.hasNativeNavigationCapability=function(){return h.isFeatureBitEnabled(1);};h.hasNativeLogoutCapability=function(){return h.isFeatureBitEnabled(2);};h.hasNavigationModeCapability=function(){return h.isFeatureBitEnabled(4);};h.hasFLPReadyNotificationCapability=function(){return h.isFeatureBitEnabled(8);};h.hasFLPReady2NotificationCapability=function(){return h.isFeatureBitEnabled(16);};h.isFeatureBitEnabled=function(F){var s="0",p;p=h.getPrivateEpcm();if(p){try{s=p.getNwbcFeatureBits();L.debug("Detected epcm getNwbcFeatureBits returned feature bits: "+s);}catch(e){L.error("failed to get feature bit vector via call getNwbcFeatureBits on private epcm object",e.stack,"sap.ushell.utils");}}return(parseInt(s,16)&F)>0;};h.isApplicationTypeEmbeddedInIframe=function(a){return a==="NWBC"||a==="TR"||a==="WCF";};h.appendSapShellParam=function(s,a){var e=a==="TR"?"":"-NWBC",v=h.getUi5Version();if(v){s+=s.indexOf("?")>=0?"&":"?";s+="sap-shell="+encodeURIComponent("FLP"+v+e);}return s;};h.getUi5Version=function(){var v,m;try{v=sap.ui.getVersionInfo().version;}catch(e){L.error("sap ui version could not be determined, using sap.ui.version (core version) as fallback "+e);v=window.sap&&sap.ui&&sap.ui.version;}m=/\d+\.\d+\.\d+/.exec(v);if(m&&m[0]){v=m[0];}else{v=undefined;}return v;};h.isNativeWebGuiNavigation=function(r){var a=O.get("applicationType",r);var n=O.get("appCapabilities.nativeNWBCNavigation",r);if(this.hasNativeNavigationCapability()&&(a==="TR"||n)){return true;}return false;};h.Map=function(){this.entries={};};h.Map.prototype.put=function(k,v){var o=this.get(k);this.entries[k]=v;return o;};h.Map.prototype.containsKey=function(k){if(typeof k!=="string"){throw new h.Error("Not a string key: "+k,"sap.ushell.utils.Map");}return Object.prototype.hasOwnProperty.call(this.entries,k);};h.Map.prototype.get=function(k){if(this.containsKey(k)){return this.entries[k];}};h.Map.prototype.keys=function(){return Object.keys(this.entries);};h.Map.prototype.remove=function(k){delete this.entries[k];};h.Map.prototype.toString=function(){var r=["sap.ushell.utils.Map("];r.push(JSON.stringify(this.entries));r.push(")");return r.join("");};h.getParameterValueBoolean=function(p,P){var o=b.fromQuery(P||window.location.search),a=o.getAll(p),t=["true","x"],F=["false",""],v;if(!a||a.length===0){return undefined;}v=a[0].toLowerCase();if(t.indexOf(v)>=0){return true;}if(F.indexOf(v)>=0){return false;}return undefined;};h.call=function(s,F,a){var m;if(a){setTimeout(function(){h.call(s,F,false);},0);return;}try{s();}catch(e){m=e.message||e.toString();L.error("Call to success handler failed: "+m,e.stack,"sap.ushell.utils");if(F){F(m);}}};h.handleTilesVisibility=function(){h.getVisibleTiles();};h.refreshTiles=function(){sap.ui.getCore().getEventBus().publish("launchpad","refreshTiles");};h.setTilesNoVisibility=function(){sap.ui.getCore().getEventBus().publish("launchpad","setTilesNoVisibility");};h.getBasicHash=function(a){if(!h.validHash(a)){L.debug("Utils ; getBasicHash ; Got invalid hash");return false;}var s=d.parseShellHash(a);return s?s.semanticObject+"-"+s.action:a;};h.validHash=function(a){return(a&&a.constructor===String&&q.trim(a)!=="");};h.getFormFactor=function(){var s=sap.ui.Device.system;if(s.desktop){return s.SYSTEMTYPE.DESKTOP;}if(s.tablet){return s.SYSTEMTYPE.TABLET;}if(s.phone){return s.SYSTEMTYPE.PHONE;}return undefined;};h.getVisibleTiles=function(){var n=document.body.clientHeight,C=sap.ui.getCore().byId("dashboardGroups"),N=sap.ui.getCore().byId("viewPortContainer"),a,t,e,i,j,k,T,l,m,o,p,s=q("#shell-hdr").height(),r=[],G,I,v=[],E=sap.ui.getCore().getEventBus(),w,x,y,z;if(window.document.hidden){E.publish("launchpad","onHiddenTab");}if(C&&C.getGroups()&&N){G=q(C.getDomRef());I=G?G.is(":visible"):false;w=C.getGroups();for(a=0;a<w.length;a=a+1){i=w[a];j=i.getTiles();k=i.getLinks();x=[j,k];for(e=0;e<x.length;e++){y=x[e];if(y){for(t=0;t<y.length;t++){T=y[t];if(!I||window.document.hidden){r.push(T);}else{l=q(T.getDomRef());m=l.offset();if(m){o=l.offset().top;p=o+l.height();z=i.getVisible()&&(p>s-300)&&(o<n+300);if(z){v.push({oTile:h.getTileModel(T),iGroup:a,bIsExtanded:!(p>s)||!(o<n)});}else if(v.length>0){E.publish("launchpad","visibleTilesChanged",v);return r;}r.push(T);}}}}}}}if(v.length>0){E.publish("launchpad","visibleTilesChanged",v);}return r;};h.getTileModel=function(a){var e;if(a.isA("sap.ui.integration.widgets.Card")){e=a.getBindingContext("ushellCardModel");}else{e=a.getBindingContext();}return e.getObject()?e.getObject():null;};h.getTileObject=function(a){var e;if(a.isA("sap.ui.integration.widgets.Card")){e=a.getBindingContext("ushellCardModel");}else{e=a.getBindingContext();}return e.getObject()?e.getObject().object:null;};h.recalculateBottomSpace=function(){var j=q("#dashboardGroups").find(".sapUshellTileContainer:visible"),l=j.last(),a=q(".sapUshellShellHead > header").height(),e=l.parent().height(),i=parseInt(l.find(".sapUshellContainerTitle").css("margin-top"),10),k=parseInt(q(".sapUshellDashboardGroupsContainer").css("padding-bottom"),10),n;if(j.length===1){n=0;}else{n=q(window).height()-a-e-i-k;n=(n<0)?0:n;}q(".sapUshellDashboardGroupsContainer").css("margin-bottom",n+"px");};h.calcVisibilityModes=function(G,p){var i=true,I=true,l=G.pendingLinks&&G.pendingLinks.length?G.pendingLinks:G.links,a=h.groupHasVisibleTiles(G.tiles,l);if(!a&&(!p||(G.isGroupLocked)||(G.isDefaultGroup)||D.system.phone||(D.system.tablet&&!D.system.desktop))){i=false;}if(!a&&!p){I=false;}return[i,I];};h.groupHasVisibleTiles=function(a,e){var v=false,t,i,j=!a?[]:a,l=!e?[]:e;j=j.concat(l);if(!j.length){return false;}for(t=0;t<j.length;t=t+1){i=j[t];if(i.isTileIntentSupported){v=true;break;}}return v;};h.invokeUnfoldingArrayArguments=function(F,A){var t=this,e,o,p,r,i;if(!Array.isArray(A[0])){return F.apply(this,A);}e=A[0];if(e.length===0){return new q.Deferred().resolve([]).promise();}o=new q.Deferred();p=[];r=[];i=new q.Deferred().resolve();e.forEach(function(n,I){if(!Array.isArray(n)){var E="Expected Array as nTh Argument of multivalue invocation: "+"first Argument must be array of array of arguments: single valued f(p1,p2), f(p1_2,p2_2), f(p1_3,p2_3) : "+"multivalued : f([[p1,p2],[p1_2,p2_2],[p1_3,p2_3]]";L.error(E);throw new Error(E);}var j=F.apply(t,n),k=new q.Deferred();j.done(function(){var a=Array.prototype.slice.call(arguments);r[I]=a;k.resolve();}).fail(k.reject.bind(k));p.push(k.promise());i=q.when(i,k);});q.when.apply(q,p).done(function(){o.resolve(r);}).fail(function(){o.reject("failure");});return o.promise();};h._getCurrentDate=function(){return new Date();};h._convertToUTC=function(a){return Date.UTC(a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDate(),a.getUTCHours(),a.getUTCMinutes(),a.getUTCSeconds(),a.getUTCMilliseconds());};h.formatDate=function(C){var i,n,t,a,H,m;i=h._convertToUTC(new Date(C));n=h._convertToUTC(h._getCurrentDate());t=n-i;a=parseInt(t/(1000*60*60*24),10);if(a>0){if(a===1){return sap.ushell.resources.i18n.getText("time_day",a);}return sap.ushell.resources.i18n.getText("time_days",a);}H=parseInt(t/(1000*60*60),10);if(H>0){if(H===1){return sap.ushell.resources.i18n.getText("time_hour",H);}return sap.ushell.resources.i18n.getText("time_hours",H);}m=parseInt(t/(1000*60),10);if(m>0){if(m===1){return sap.ushell.resources.i18n.getText("time_minute",m);}return sap.ushell.resources.i18n.getText("time_minutes",m);}return sap.ushell.resources.i18n.getText("just_now");};h.toExternalWithParameters=function(s,a,p){sap.ushell.Container.getServiceAsync("CrossApplicationNavigation").then(function(C){var t={},P={},i,T,e;t.target={semanticObject:s,action:a};if(p&&p.length>0){P={};for(i=0;i<p.length;i++){T=p[i].Key;e=p[i].Value;P[T]=e;}t.params=P;}C.toExternal(t);});};h.moveElementInsideOfArray=function(a,n,e){if(!h.isArray(a)||n===undefined||e===undefined){throw"Incorrect input parameters passed";}if(n>=a.length||e>=a.length||e<0||n<0){throw"Index out of bounds";}var E=a.splice(n,1)[0];a.splice(e,0,E);return a;};h.shallowMergeObject=function(t){return Array.prototype.slice.call(arguments,1,arguments.length).map(function(s){return{sourceObject:s,properties:Object.keys(s)};}).reduce(function(r,s){s.properties.forEach(function(p){r[p]=s.sourceObject[p];});return r;},t);};h.getLocationHref=function(){return window.location.href;};h.generateLocalStorageKey=function(p,i){var n=i.length;if(n===0){throw new Error("At least one id should be provided when generating the local storage key");}var s="$";if(n===2){s="#";}else if(n>2){s="@"+n+"@";}return p+s+i.join(":");};h.urlParametersToString=function(p,a,e){return d.privparamsToString(p,a,e);};h.isRootIntent=function(i){if(typeof i!=="string"){throw new Error("The given intent must be a string");}var r="renderers.fiori2.componentData.config.rootIntent";var C=O.get(r,window["sap-ushell-config"])||"#Shell-home";var R=C.replace("#","");var I=i.replace("#","");return I===""||I===R;};h.isFlpHomeIntent=function(i){if(!i){i=window.location.hash;if(!i){i=O.get("renderers.fiori2.componentData.config.rootIntent",window["sap-ushell-config"])||"Shell-home";}}else if(typeof i!=="string"){throw new Error("The given intent must be a string");}var I=i.replace("#","");return I.indexOf("Shell-home")===0||I.indexOf("Launchpad-openFLPPage")===0;};h.generateRandomKey=function(){var C="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";var r="";var R=new window.Uint32Array(40);window.crypto.getRandomValues(R);var a=function(i){var e=R[i]%C.length;return C[e];};while(r.length<40){r+=a(r.length);}return r;};return h;},true);
