// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/Component","sap/ushell/appRuntime/ui5/plugins/baseRta/AppLifeCycleUtils","sap/ushell/appRuntime/ui5/plugins/baseRta/CheckConditions","sap/ushell/appRuntime/ui5/plugins/baseRta/Trigger","sap/base/Log"],function(C,A,a,T,L){"use strict";var B=C.extend("sap.ushell.plugins.BaseRTAPlugin",{sType:null,init:function(c){this.mConfig=c;this.mConfig.i18n=this.getModel("i18n").getResourceBundle();this.mConfig.loadPlugins=this._loadPlugins.bind(this);this.mConfig.onStartHandler=this._onStartHandler.bind(this);this.mConfig.onErrorHandler=this._onErrorHandler.bind(this);this.mConfig.onStopHandler=this._onStopHandler.bind(this);this.oTrigger=new T(this.mConfig);this._oPluginPromise=this.oTrigger.getInitPromise().then(a.checkUI5App.bind(a)).then(function(i){if(this.mConfig.checkRestartRTA&&i&&a.checkRestartRTA(this.mConfig.layer)){return this.oTrigger.triggerStartRta(this);}return undefined;}.bind(this)).then(function(){return A.getAppLifeCycleService();}).then(function(o){o.attachAppLoaded(this._onAppLoaded,this);}.bind(this));},getPluginPromise:function(){return this._oPluginPromise;},exit:function(){this._oPluginPromise=this._oPluginPromise.then(A.getAppLifeCycleService).then(function(o){o.detachAppLoaded(this._onAppLoaded,this);if(this._onRendererCreated){var c=A.getContainer();c.detachRendererCreatedEvent(this._onRendererCreated,this);}}.bind(this));},_onAppLoaded:function(){return a.checkUI5App().then(function(i){if(i){if(a.checkRestartRTA(this.mConfig.layer)){this.oTrigger.triggerStartRta(this);}this._adaptButtonVisibility(this.mConfig.id,true);}else{this._adaptButtonVisibility(this.mConfig.id,false);}}.bind(this));},_onAdapt:function(){return a.checkFlexEnabledOnStart(this).then(function(f){if(!f){return this.oTrigger.handleFlexDisabledOnStart();}return this.oTrigger.triggerStartRta(this);}.bind(this));},_adaptButtonVisibility:function(c,v){if(typeof c==="string"){c=sap.ui.getCore().byId(c);}if(!c){return;}c.setVisible(v);},_exitAdaptation:function(){if(this._switchToDefaultMode){this._switchToDefaultMode();}this.oTrigger.exitRta();},_onStartHandler:function(){},_onErrorHandler:function(e){this.oTrigger.errorHandler(e);if(e!=="Reload triggered"){this._exitAdaptation();var E;var m;if(e instanceof Error){E=e.stack;m=this.mConfig.i18n.getText("TECHNICAL_ERROR");}else if(typeof e==="string"){E=m=e;}L.error("Cannot start UI Adaptation: ",E);sap.ui.require(["sap/ui/rta/Utils","sap/m/MessageBox"],function(U,M){M.error(m,{title:this.mConfig.i18n.getText("ERROR_TITLE"),onClose:null,styleClass:U.getRtaStyleClassName()});}.bind(this));}},_onStopHandler:function(){this._exitAdaptation();},_loadPlugins:function(){return Promise.resolve();}});return B;},true);
