// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/StandardListItem","sap/ushell/components/applicationIntegration/AppLifeCycle","sap/ushell/Config","sap/ushell/resources","sap/ushell/ui/footerbar/AboutButton","sap/ushell/ui/footerbar/ContactSupportButton","sap/ushell/ui/launchpad/ActionItem","sap/ushell/ui/QuickAccess","sap/ushell/EventHub","sap/m/library","sap/base/Log","sap/ui/performance/Measurement","sap/ui/core/ElementMetadata","sap/ui/core/Fragment"],function(C,J,S,A,a,r,b,c,d,Q,E,l,L,M,e,F){"use strict";var f=l.ListType;var B=l.ButtonType;function i(s){if(!sap.ui.getCore().byId(s)){L.debug("Could not render ActionItem because it was not created: "+s);return false;}return true;}return C.extend("sap.ushell.components.shell.MeArea.MeArea",{_aDanglingControl:[],_aDoables:[],onInit:function(){var o=this.getShellConfig();this._createActionButtons(o);var u=sap.ushell.Container.getUser();var g=a.last("/core/shell/model/currentState/actions").filter(i);this.oModel=new J({actions:g,userName:u.getFullName()||u.getId()});this._aDoables.push(a.on("/core/shell/model/currentState/actions").do(function(h){var j=h.filter(i);this.getModel().setProperty("/actions",j);}.bind(this)));this._aDoables.push(E.on("showMeArea").do(function(s){var p=sap.ui.getCore().byId("sapUshellMeAreaPopover");if(p&&p.isOpen()||!s){this._toggleMeAreaPopover(false);}else{this._toggleMeAreaPopover(true);}}.bind(this)));},onExit:function(){this._destroyDanglingControls();this._aDoables.forEach(function(D){D.off();});this._aDanglingControl=[];this._aDoables=[];var p=sap.ui.getCore().byId("sapUshellMeAreaPopover");if(p){p.destroy();}},getModel:function(){return this.oModel;},_createActionButtons:function(o){var g=a.last("/core/extension/enableHelp");var h=a.last("/core/shell/enableAbout");if(h){this._createAboutButton(g);}if(!o.moveAppFinderActionToShellHeader&&a.last("/core/catalog/enabled")){this._createAppFinderButton(o,g);}if(!o.moveUserSettingsActionToShellHeader){this._createSettingsButton(g);}if(!o.moveContactSupportActionToShellHeader){this._createSupportTicketButton(g);}if(o.enableRecentActivity&&a.last("/core/shell/model/currentState/showRecentActivity")){this._createRecentActivitiesButton();this._createFrequentActivitiesButton();}if(!o.disableSignOut){this._createLogoutButton();}},_createAppFinderButton:function(o,g){if(sap.ui.getCore().byId("openCatalogBtn")){return;}var O=new d("openCatalogBtn",{text:r.i18n.getText("open_appFinderBtn"),icon:"sap-icon://sys-find",visible:!o.disableAppFinder,actionType:"action",press:function(){M.start("FLP:AppFinderLoadingStartToEnd","AppFinderLoadingStartToEnd","FLP");sap.ushell.Container.getServiceAsync("CrossApplicationNavigation").then(function(h){h.toExternal({target:{semanticObject:"Shell",action:"appfinder"}});});}});if(g){O.addStyleClass("help-id-openCatalogActionItem");}this._addDanglingControl(O);},_createAboutButton:function(g){var I="aboutBtn";if(!sap.ui.getCore().byId(I)){var o=new b(I);if(g){o.addStyleClass("help-id-"+I);}this._addDanglingControl(o);this.getRenderer().showActionButton(I,false);}},_createSettingsButton:function(g){var I="userSettingsBtn";if(!sap.ui.getCore().byId(I)){var u=new d(I,{tooltip:r.i18n.getText("ControlKey")+" + "+r.i18n.getText("CommaKey"),text:r.i18n.getText("userSettings"),icon:"sap-icon://action-settings",press:function(){E.emit("openUserSettings",Date.now());}});if(g){u.addStyleClass("help-id-loginDetails");}this._addDanglingControl(u);}},_createSupportTicketButton:function(g){a.on("/core/extension/SupportTicket").do(function(h){var I="ContactSupportBtn";var o=sap.ui.getCore().byId(I);if(h&&!o){o=new c(I);this._addDanglingControl(o);if(g){o.addStyleClass("help-id-contactSupportBtn");}}if(h){this.getRenderer().showActionButton(I);}else{this.getRenderer().hideActionButton(I);}}.bind(this));},_createRecentActivitiesButton:function(){var I="recentActivitiesBtn";a.on("/core/shell/model/enableTrackingActivity").do(function(g){if(g){var R=sap.ui.getCore().byId(I);if(!R){R=new d(I,{text:r.i18n.getText("recentActivities"),icon:"sap-icon://customer-history",press:function(){Q.openQuickAccessDialog("recentActivityFilter","meAreaHeaderButton");}});this._addDanglingControl(R);}this.getRenderer().showActionButton(I,false);}else{this.getRenderer().hideActionButton(I,false);}}.bind(this));},_createFrequentActivitiesButton:function(){var I="frequentActivitiesBtn";a.on("/core/shell/model/enableTrackingActivity").do(function(g){if(g){var o=sap.ui.getCore().byId(I);if(!o){o=new d(I,{text:r.i18n.getText("frequentActivities"),icon:"sap-icon://activity-individual",tooltip:r.i18n.getText("frequentActivitiesTooltip"),press:function(){Q.openQuickAccessDialog("frequentlyUsedFilter","meAreaHeaderButton");}});this._addDanglingControl(o);}this.getRenderer().showActionButton(I,false);}else{this.getRenderer().hideActionButton(I,false);}}.bind(this));},_createLogoutButton:function(){var I="logoutBtn";if(sap.ui.getCore().byId(I)){return;}var o=new d(I,{visible:true,type:B.Transparent,icon:"sap-icon://log",text:r.i18n.getText("signoutBtn_title"),press:this.logout});this._addDanglingControl(o);this.getRenderer().showActionButton(I,false);},logout:function(){sap.ui.require(["sap/m/MessageBox","sap/ushell/ui/launchpad/LoadingDialog"],function(g,h){var o=new h({text:""}),s=true,I=false,j={};sap.ushell.Container.getGlobalDirty().done(function(k){s=false;if(I===true){o.exit();o=new h({text:""});}var _=function(){var R=r.i18n;if(k===sap.ushell.Container.DirtyState.DIRTY){j.message=R.getText("unsaved_data_warning_popup_message");j.icon=g.Icon.WARNING;j.messageTitle=R.getText("unsaved_data_warning_popup_title");}else{j.message=R.getText("signoutConfirmationMsg");j.icon=g.Icon.QUESTION;j.messageTitle=R.getText("signoutMsgTitle");}return j;};j=_(k);g.show(j.message,j.icon,j.messageTitle,[g.Action.OK,g.Action.CANCEL],function(m){if(m===g.Action.OK){o.openLoadingScreen();o.showAppInfo(r.i18n.getText("beforeLogoutMsg"),null);sap.ushell.Container.logout();}else if(window.document.activeElement&&window.document.activeElement.tagName==="BODY"){window.document.getElementById("meAreaHeaderButton").focus();}},e.uid("confirm"));});if(s===true){o.openLoadingScreen();I=true;}});},_addDanglingControl:function(o){this._aDanglingControl.push(o);},_destroyDanglingControls:function(){if(this._aDanglingControl){this._aDanglingControl.forEach(function(o){if(o.destroyContent){o.destroyContent();}o.destroy();});}},_toggleMeAreaPopover:function(s){if(!this.oPopover){F.load({name:"sap.ushell.components.shell.MeArea.MeAreaPopover",controller:this}).then(function(p){this.oPopover=p;this.oPopover.setModel(this.getModel());this._toggleMeAreaPopover(s);}.bind(this));}else if(s){this.oPopover.getModel().refresh(true);this.oPopover.openBy(sap.ui.getCore().byId("meAreaHeaderButton"));}else{this.oPopover.close();}},meAreaPopoverItemFactory:function(I,o){var g=sap.ui.getCore().byId(o.getObject()),h;var j=function(){if(g){g.firePress();E.emit("showMeArea",false);}};h=new S({id:I+"-"+g.getId(),icon:g.getIcon(),tooltip:g.getTooltip(),iconInset:true,title:g.getText(),visible:g.getVisible(),type:f.Active,customData:[{key:"actionItemId",value:g.getId()}],press:j});h.addStyleClass("sapUshellMeAreaActionItem");h.addEventDelegate({onkeyup:function(k){if(k.keyCode===32){j();}}});return h;},getRenderer:function(){if(!this._oRenderer){this._oRenderer=sap.ushell.Container.getRenderer("fiori2");}return this._oRenderer;},getShellConfig:function(){return this.getRenderer().getShellConfig();}});});
