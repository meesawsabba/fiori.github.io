// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/Layout","sap/ui/base/Object","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ushell/ui/launchpad/Tile","sap/ushell/ui/launchpad/DashboardGroupsContainer","sap/ushell/Config","sap/ushell/EventHub","sap/ui/core/Component","sap/ui/core/InvisibleMessage","sap/ui/core/library","sap/m/GenericTile","sap/ui/Device","sap/ushell/ui/launchpad/PlusTile","sap/ushell/resources","sap/ushell/ui/launchpad/TileContainer","sap/ushell/ui/launchpad/LinkTileWrapper","sap/m/Button","sap/ushell/ui/launchpad/AccessibilityCustomData","sap/ushell/ui/launchpad/GroupHeaderActions","sap/base/util/isEmptyObject","sap/ui/thirdparty/jquery","sap/ui/performance/Measurement","sap/ushell/renderers/fiori2/AccessKeysHandler","sap/base/util/restricted/_zipObject","sap/ushell/components/ComponentKeysHandler"],function(L,b,F,a,c,D,C,E,d,I,e,G,f,P,r,T,g,B,A,h,j,q,M,k,_,l){"use strict";var m=e.InvisibleMessageMode;var n=b.extend("sap.ushell.components.homepage.DashboardGroupsBox",{metadata:{publicMethods:["createGroupsBox"]},constructor:function(){if(sap.ushell.components.homepage.getDashboardGroupsBox&&sap.ushell.components.homepage.getDashboardGroupsBox()){return sap.ushell.components.homepage.getDashboardGroupsBox();}sap.ushell.components.homepage.getDashboardGroupsBox=(function(v){return function(){return v;};}(this.getInterface()));this.oController=undefined;this.oGroupsContainer=undefined;this._oInvisibleMessageInstance=I.getInstance();sap.ui.getCore().getEventBus().subscribe("launchpad","actionModeActive",this._handleActionModeChange,this);sap.ui.getCore().getEventBus().subscribe("launchpad","actionModeInactive",this._handleActionModeChange,this);sap.ui.getCore().getEventBus().subscribe("launchpad","GroupHeaderVisibility",this._updateGroupHeaderVisibility,this);return undefined;},destroy:function(){sap.ui.getCore().getEventBus().unsubscribe("launchpad","actionModeActive",this._handleActionModeChange,this);sap.ui.getCore().getEventBus().unsubscribe("launchpad","actionModeInactive",this._handleActionModeChange,this);sap.ui.getCore().getEventBus().unsubscribe("launchpad","GroupHeaderVisibility",this._updateGroupHeaderVisibility,this);if(this.oGroupsContainer){this.oGroupsContainer.destroy();}sap.ushell.components.homepage.getDashboardGroupsBox=undefined;},calculateFilter:function(){var i=[];var o;var s=this.oModel.getProperty("/homePageGroupDisplay"),p=this.oModel.getProperty("/tileActionModeActive");if(!p){if(s&&s==="tabs"){o=new F("isGroupSelected",a.EQ,true);}else{o=new F("isGroupVisible",a.EQ,true);}i.push(o);}return i;},zipPromiseAll:function(p,i){return Promise.all(i).then(function(R){return _(p,R);});},loadCardModuleIfNeeded:function(){var t=this;if(C.last("/core/home/featuredGroup/enable")){return sap.ui.getCore().loadLibrary("sap.ui.integration",{async:true}).then(function(){return new Promise(function(i){sap.ui.require(["sap/ui/integration/widgets/Card"],function(o){t.Card=o;i();});});});}return Promise.resolve();},createGroupsBox:function(o,i){this.oController=o;var t=this,p,s,u=function(x){var y,z;if(x&&(y=x.getDomRef())){z=y.querySelector(".sapUshellPlusTile");if(z){return z;}}return null;},v=function(x){var y=u(x.currentGroup),z=u(x.endGroup),H=(x.tiles[x.tiles.length-2]===x.item)||(x.endGroup.getTiles().length===0);if(H){t._hidePlusTile(z);}else{t._showPlusTile(z);}if(x.currentGroup!==x.endGroup){t._showPlusTile(y);}};p=function(){L.getLayoutEngine().setExcludedControl(P);L.getLayoutEngine().setReorderTilesCallback.call(L.layoutEngine,v);};s=function(){if(!L.isInited){L.init({getGroups:this.getGroups.bind(this),getAllGroups:t.getAllGroupsFromModel.bind(t),isTabBarActive:t.isTabBarActive.bind(t)}).done(p);f.media.attachHandler(function(){if(!this.bIsDestroyed){L.reRenderGroupsLayout(null);}},this,f.media.RANGESETS.SAP_STANDARD);var x=this.getDomRef();o.getView().sDashboardGroupsWrapperId=!j(x)&&x.parentNode?x.parentNode.id:"";}E.emit("CenterViewPointContentRendered");sap.ui.getCore().getEventBus().publish("launchpad","contentRendered");sap.ui.getCore().getEventBus().publish("launchpad","contentRefresh");if(this.getBinding("groups")){this.getBinding("groups").filter(t.calculateFilter());}};this.isTabBarActive=function(){return this.oModel.getProperty("/homePageGroupDisplay")==="tabs";};this.oModel=i;var w=this.calculateFilter(),U=C.last("/core/home/gridContainer");this.oGroupsContainer=new D("dashboardGroups",{displayMode:"{/homePageGroupDisplay}",afterRendering:s});this.zipPromiseAll(["launchpadService",""],[sap.ushell.Container.getServiceAsync("LaunchPage"),t.loadCardModuleIfNeeded()]).then(function(R){this.isLinkPersonalizationSupported=R.launchpadService.isLinkPersonalizationSupported();if(U){sap.ui.require(["sap/ushell/ui/launchpad/GridContainer"],function(){t.oGroupsContainer.bindAggregation("groups",{filters:w,path:"/groups",factory:function(){var S=C.last("/core/home/sizeBehavior");var x=t._createGridContainer(o,i);x.setTileSizeBehavior(S);return x;}});});C.on("/core/home/sizeBehavior").do(function(x){t.oGroupsContainer.getAggregation("groups").forEach(function(y){y.setTileSizeBehavior(x);});});}else{this.oGroupsContainer.bindAggregation("groups",{filters:w,path:"/groups",factory:function(){return t._createTileContainer(o,i);}});}}.bind(this));if(f.system.desktop){l.getInstance().then(function(x){this.ComponentKeysHandlerInstance=x;this.oGroupsContainer.addEventDelegate({onBeforeFastNavigationFocus:this._handleBeforeFastNavigationFocus.bind(this),onsapskipback:this._handleSkip.bind(this,false),onsapskipforward:this._handleSkip.bind(this,true),onsaptabnext:function(y){if(t.oModel.getProperty("/tileActionModeActive")){if(q(document.activeElement).closest(".sapUshellTileContainerHeader").length){var z=q(document.activeElement).closest(".sapUshellTileContainer");var H=q(document.activeElement).hasClass("sapUshellContainerTitle");var J=z.find(".sapUshellHeaderActionButton");if(H&&!J.length||document.activeElement.id===J.last()[0].id){if(z.find(".sapUshellTile, .sapUshellLink, .sapFCard").is(":visible")){y.preventDefault();x.goToLastVisitedTile(z,true);return;}}if(J.length&&document.activeElement.id!==J.last()[0].id){return;}}var K=window.document.getElementById("sapUshellDashboardFooterDoneBtn");if(K){y.preventDefault();K.focus();return;}}y.preventDefault();if(q("#sapUshellFloatingContainerWrapper").is(":visible")&&(y.originalEvent.srcElement.id)!==""){sap.ui.getCore().getEventBus().publish("launchpad","shellFloatingContainerIsAccessible");}else{k.setIsFocusHandledByAnotherHandler(true);k.sendFocusBackToShell(y);}},onsaptabprevious:function(y){k.setIsFocusHandledByAnotherHandler(true);var z=q(":focus");if(t.oModel.getProperty("/tileActionModeActive")&&!z.hasClass("sapUshellTileContainerHeader")){var H=q(document.activeElement);if(H.hasClass("sapUshellTile")||H.hasClass("sapFCard")){y.preventDefault();var J=H.closest(".sapUshellTileContainer");var K=J.find(".sapUshellHeaderActionButton").filter(":visible").last();if(K.length>0){K.focus();}else{J.find(".sapUshellContainerTitle").focus();}}}}});}.bind(this));}return this.oGroupsContainer;},_handleSkip:function(i,o){var p=window.document.getElementById("sapUshellDashboardFooterDoneBtn");if(p){if(p===document.activeElement&&!i){o.preventDefault();this.ComponentKeysHandlerInstance.goToTileContainer();}else if(p!==document.activeElement&&i){o.preventDefault();p.focus();}}},_handleBeforeFastNavigationFocus:function(o){o.preventDefault();var i=window.document.getElementById("sapUshellDashboardFooterDoneBtn");if(i&&!o.forward){i.focus();}else{this.ComponentKeysHandlerInstance.goToTileContainer();}},getAllGroupsFromModel:function(){return this.oModel.getProperty("/groups");},_createTileContainer:function(o){var t=this,i=new F("isTileIntentSupported",a.EQ,true),p=new T({headerText:"{title}",showEmptyLinksArea:{parts:["/tileActionModeActive","links/length","isGroupLocked","/isInDrag","/homePageGroupDisplay"],formatter:function(s,u,v,w,x){if(u){return true;}else if(v){return false;}return s||w&&x==="tabs";}},showMobileActions:{parts:["/tileActionModeActive"],formatter:function(s){return s&&!this.getDefaultGroup();}},showIcon:{parts:["/isInDrag","/tileActionModeActive"],formatter:function(s,u){return(this.getIsGroupLocked()&&(s||u));}},deluminate:{parts:["/isInDrag"],formatter:function(s){return this.getIsGroupLocked()&&s;}},transformationError:{parts:["/isInDrag","/draggedTileLinkPersonalizationSupported"],formatter:function(s,u){return s&&!u;}},showBackground:"{/tileActionModeActive}",tooltip:"{title}",tileActionModeActive:"{/tileActionModeActive}",enableHelp:C.last("/core/extension/enableHelp"),groupId:"{groupId}",defaultGroup:"{isDefaultGroup}",isLastGroup:"{isLastGroup}",isGroupLocked:"{isGroupLocked}",isGroupSelected:"{isGroupSelected}",showHeader:true,showGroupHeader:"{showGroupHeader}",homePageGroupDisplay:"{/homePageGroupDisplay}",editMode:"{editMode}",supportLinkPersonalization:this.isLinkPersonalizationSupported,titleChange:function(s){sap.ui.getCore().getEventBus().publish("launchpad","changeGroupTitle",{groupId:s.getSource().getGroupId(),newTitle:s.getParameter("newTitle")});},showEmptyLinksAreaPlaceHolder:{parts:["links/length","/isInDrag","/homePageGroupDisplay"],formatter:function(s,u,v){return u&&v==="tabs"&&!s;}},showPlaceholder:{parts:["/tileActionModeActive","tiles/length"],formatter:function(s){return s&&!this.getIsGroupLocked();}},visible:{parts:["/tileActionModeActive","isGroupVisible","visibilityModes"],formatter:function(s,u,v){if(!v[s?1:0]){return false;}return u||s;}},hidden:{parts:["/tileActionModeActive","isGroupVisible"],formatter:function(s,u){return s&&!u;}},links:this._getLinkTemplate(),tiles:{path:"tiles",factory:this._itemFactory.bind(this),filters:[i]},add:function(s){t._handleAddTileToGroup(s);}});return p;},_createGridContainer:function(o){var i=sap.ui.require("sap/ushell/ui/launchpad/GridContainer"),p=new F("isTileIntentSupported",a.EQ,true);return new i({groupId:"{groupId}",showHeader:true,defaultGroup:"{isDefaultGroup}",isLastGroup:"{isLastGroup}",headerText:"{title}",showGroupHeader:"{showGroupHeader}",homePageGroupDisplay:"{/homePageGroupDisplay}",visible:{parts:["/tileActionModeActive","isGroupVisible","visibilityModes"],formatter:function(t,s,v){if(!v[t?1:0]){return false;}return s||t;}},isGroupLocked:"{isGroupLocked}",isGroupSelected:"{isGroupSelected}",editMode:"{editMode}",showBackground:"{/tileActionModeActive}",showIcon:{parts:["/isInDrag","/tileActionModeActive"],formatter:function(s,t){return(this.getIsGroupLocked()&&(s||t));}},tileActionModeActive:"{/tileActionModeActive}",supportLinkPersonalization:this.isLinkPersonalizationSupported,enableHelp:C.last("/core/extension/enableHelp"),showEmptyLinksAreaPlaceHolder:{parts:["links/length","/isInDrag","/homePageGroupDisplay"],formatter:function(s,t,u){return t&&u==="tabs"&&!s;}},showEmptyLinksArea:{parts:["/tileActionModeActive","links/length","isGroupLocked","/isInDrag","/homePageGroupDisplay"],formatter:function(t,s,u,v,w){if(s){return true;}else if(u){return false;}return t||v&&w==="tabs";}},titleChange:function(s){sap.ui.getCore().getEventBus().publish("launchpad","changeGroupTitle",{groupId:s.getSource().getGroupId(),newTitle:s.getParameter("newTitle")});},tooltip:"{title}",links:this._getLinkTemplate(),tiles:{path:"tiles",factory:this._itemFactory.bind(this),filters:[p]}});},_getLinkTemplate:function(){var o=new F("isTileIntentSupported",a.EQ,true);if(!this.isLinkPersonalizationSupported){return{path:"links",templateShareable:true,template:new g({uuid:"{uuid}",tileCatalogId:"{tileCatalogId}",target:"{target}",isLocked:"{isLocked}",tileActionModeActive:"{/tileActionModeActive}",debugInfo:"{debugInfo}",tileViews:{path:"content",factory:function(i,p){return p.getObject();}},afterRendering:function(i){var p=q(this.getDomRef().getElementsByTagName("a"));p.attr("tabindex",-1);}}),filters:[o]};}return{path:"links",factory:function(i,p){var s=p.getObject().content[0];if(s&&s.bIsDestroyed){s=s.clone();p.getModel().setProperty(p.getPath()+"/content/0",s);}return s;},filters:[o]};},_createCard:function(o){return new this.Card({manifest:o});},_itemFactory:function(i,o){var t=o.getProperty(o.sPath),p,s,u,v;if(t){if(t.isCard){p=t&&t.content;s=p&&p.length&&p[0];if(s&&s["sap.card"]){v=s;}else if(t.manifest){v={"sap.flp":t.manifest&&t.manifest["sap.flp"],"sap.card":{"type":"List"}};}else{return this._createErrorTile();}u=this._createCard(v);}else{u=this._createTile();}t.controlId=u&&u.getId&&u.getId();}return u;},_createErrorTile:function(){return new c({tileViews:{path:"content",factory:function(){return new G({state:"Failed"});}}});},_createTile:function(){var t=new c({"long":"{long}",isDraggedInTabBarToSourceGroup:"{draggedInTabBarToSourceGroup}",uuid:"{uuid}",tileCatalogId:"{tileCatalogId}",isCustomTile:"{isCustomTile}",target:"{target}",isLocked:"{isLocked}",navigationMode:"{navigationMode}",tileActionModeActive:"{/tileActionModeActive}",showActionsIcon:"{showActionsIcon}",rgba:"{rgba}",debugInfo:"{debugInfo}",tileViews:{path:"content",factory:function(i,o){return o.getObject();}},coverDivPress:function(o){if(!o.oSource.getBindingContext().getObject().tileIsBeingMoved&&sap.ushell.components.homepage.ActionMode){sap.ushell.components.homepage.ActionMode._openActionsMenu(o);}},showActions:function(o){if(sap.ushell.components.homepage.ActionMode){sap.ushell.components.homepage.ActionMode._openActionsMenu(o);}},deletePress:[this.oController._dashboardDeleteTileHandler,this.oController],press:[this.oController.dashboardTilePress,this.oController]});var v=sap.ui.getCore().byId("viewPortContainer");t.addEventDelegate({onclick:function(){M.start("FLP:DashboardGroupsBox.onclick","Click on tile","FLP");M.start("FLP:OpenApplicationonClick","Open Application","FLP");function i(){M.end("FLP:DashboardGroupsBox.onclick");v.detachAfterNavigate(i);}v.attachAfterNavigate(i);}});return t;},_updateGroupHeaderVisibility:function(){var o=this.oGroupsContainer.getGroups(),p=this.oModel.getProperty("/tileActionModeActive"),s=this.oController.getView().oPage.getShowHeader(),t,v=0;for(var i=0;i<o.length;i++){if(o[i].getProperty("visible")){v++;if(t===undefined){t=i;}else{o[i].setShowGroupHeader(true);}}}if(t!==undefined){var V=p||(v===1&&!s);o[t].setShowGroupHeader(V);}},_handleActionModeChange:function(){var i=this.oModel.getProperty("/tileActionModeActive");if(i){this._addTileContainersContent();}else{L.reRenderGroupsLayout(null);}},_addTileContainersContent:function(){var o=this.oGroupsContainer.getGroups();for(var i=0;i<o.length;i++){var p=o[i];if(!p.getBeforeContent().length){p.addBeforeContent(this._getBeforeContent());}if(!p.getAfterContent().length){p.addAfterContent(this._getAfterContent());}if(!p.getHeaderActions().length){p.addHeaderAction(this._getGroupHeaderAction());}}},_handleAddGroupButtonPress:function(o){this.oController._addGroupHandler(o);this._addTileContainersContent();},_getBeforeContent:function(){var o=new B({icon:"sap-icon://add",text:r.i18n.getText("add_group_at"),visible:"{= !${isGroupLocked} && !${isDefaultGroup} && ${/tileActionModeActive}}",enabled:"{= !${/editTitle}}",press:[this._handleAddGroupButtonPress.bind(this)]});o.addStyleClass("sapUshellAddGroupButton");o.addCustomData(new A({key:"tabindex",value:"-1",writeToDom:true}));return o;},_getAfterContent:function(){var o=new B({icon:"sap-icon://add",text:r.i18n.getText("add_group_at"),visible:"{= ${isLastGroup} && ${/tileActionModeActive}}",enabled:"{= !${/editTitle}}",press:[this._handleAddGroupButtonPress.bind(this)]}).addStyleClass("sapUshellAddGroupButton");o.addStyleClass("sapUshellAddGroupButton");o.addCustomData(new A({key:"tabindex",value:"-1",writeToDom:true}));return o;},_getGroupHeaderAction:function(){return new h({content:this._getHeaderActions(),tileActionModeActive:"{/tileActionModeActive}",isOverflow:"{/isPhoneWidth}"}).addStyleClass("sapUshellOverlayGroupActionPanel");},_getHeaderActions:function(){var H=[];if(C.last("/core/home/gridContainer")){var o=new B({text:r.i18n.getText("AddTileBtn"),visible:"{= !${isGroupLocked}}",enabled:"{= !${/editTitle}}",press:this._handleAddTileToGroup.bind(this)}).addStyleClass("sapUshellHeaderActionButton");if(f.system.phone){o.setIcon("sap-icon://add");}H.push(o);}H.push(new B({text:{path:"isGroupVisible",formatter:function(i){return r.i18n.getText(i?"HideGroupBtn":"ShowGroupBtn");}},icon:{path:"isGroupVisible",formatter:function(i){if(f.system.phone){return i?"sap-icon://hide":"sap-icon://show";}return"";}},visible:"{= ${/enableHideGroups} && !${isGroupLocked} && !${isDefaultGroup}}",enabled:"{= !${/editTitle}}",press:function(i){var s=i.getSource(),p=s.getBindingContext(),t=p.getModel(),u=p.getPath(),v=t.getProperty(u+"/isGroupVisible");var w=sap.ui.getCore().getLibraryResourceBundle("sap.m");this._oInvisibleMessageInstance.announce([r.i18n.getText(v?"Group.nowBeingHidden":"Group.nowBeingShown"),r.i18n.getText("Section.ButtonLabelChanged"),r.i18n.getText(v?"ShowGroupBtn":"HideGroupBtn"),w.getText("ACC_CTR_TYPE_BUTTON")].join(" "),m.Polite);this.oController._changeGroupVisibility(p);}.bind(this)}).addStyleClass("sapUshellHeaderActionButton"));H.push(new B({text:{path:"removable",formatter:function(i){return r.i18n.getText(i?"DeleteGroupBtn":"ResetGroupBtn");}},icon:{path:"removable",formatter:function(i){if(f.system.phone){return i?"sap-icon://delete":"sap-icon://refresh";}return"";}},visible:"{= !${isDefaultGroup}}",enabled:"{= !${/editTitle}}",press:function(i){var s=i.getSource(),p=s.getBindingContext();this.oController._handleGroupDeletion(p);}.bind(this)}).addStyleClass("sapUshellHeaderActionButton"));return H;},_handleAddTileToGroup:function(o){if(document.toDetail){document.toDetail();}d.getOwnerComponentFor(this.oController.getView().parentComponent).getRouter().navTo("appfinder",{"innerHash*":"catalog/"+JSON.stringify({targetGroup:encodeURIComponent(o.getSource().getBindingContext().sPath)})});},_hidePlusTile:function(p){if(p){p.classList.add("sapUshellHidePlusTile");}},_showPlusTile:function(p){if(p){p.classList.remove("sapUshellHidePlusTile");}}});return n;});
