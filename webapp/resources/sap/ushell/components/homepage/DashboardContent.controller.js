// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/jquery","./DashboardUIActions","sap/ushell/utils","sap/ushell/EventHub","sap/ui/Device","sap/ushell/resources","sap/ushell/Layout","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/base/Log","sap/ui/core/mvc/Controller","sap/ushell/components/ComponentKeysHandler"],function(q,D,u,E,a,r,L,F,b,c,C,d){"use strict";return C.extend("sap.ushell.components.homepage.DashboardContent",{onInit:function(){var e=sap.ui.getCore().getEventBus();this.handleDashboardScroll=function(){window.setTimeout(this._handleDashboardScroll.bind(this),0);}.bind(this);e.subscribe("sap.ushell","appOpened",this._appOpenedHandler,this);e.subscribe("launchpad","dashboardModelContentLoaded",this._modelLoaded,this);e.subscribe("launchpad","actionModeInactive",this._handleGroupVisibilityChanges,this);e.subscribe("launchpad","switchTabBarItem",this._handleTabBarItemPressEventHandler,this);window.document.addEventListener("visibilitychange",u.handleTilesVisibility,false);},onExit:function(){var e=sap.ui.getCore().getEventBus();e.unsubscribe("launchpad","contentRefresh",this._webkitMobileRenderFix,this);e.unsubscribe("sap.ushell","appOpened",this._appOpenedHandler,this);e.unsubscribe("launchpad","dashboardModelContentLoaded",this._modelLoaded,this);e.unsubscribe("launchpad","switchTabBarItem",this._handleTabBarItemPressEventHandler,this);window.document.removeEventListener("visibilitychange",u.handleTilesVisibility,false);if(this.oDashboardUIActionsModule){this.oDashboardUIActionsModule.destroy();delete this.oDashboardUIActionsModule;}window.removeEventListener("resize",this._resizeHandler.bind(this));},onAfterRendering:function(){u.setPerformanceMark("FLP - dashboard after rendering");var h=sap.ushell.components.getHomepageManager();if(!h.getPreparedGroupModel()){h.loadPersonalizedGroups();}else{E.once("firstSegmentCompleteLoaded").do(h.handleFirstSegmentLoaded.bind(h));}var e=sap.ui.getCore().getEventBus(),m,t,g,i;e.unsubscribe("launchpad","scrollToGroup",this._scrollToGroup,this);e.unsubscribe("launchpad","scrollToGroupByName",this._scrollToGroupByName,this);e.subscribe("launchpad","scrollToGroup",this._scrollToGroup,this);e.subscribe("launchpad","scrollToGroupByName",this._scrollToGroupByName,this);a.orientation.attachHandler(function(){var j=q("#dashboardGroups").find(".sapUshellTileContainer").filter(":visible");if(j.length){m=this.getView().getModel();t=m.getProperty("/topGroupInViewPortIndex");if(j.get(t)){g=sap.ui.getCore().byId(j.get(t).id);i=m.getProperty("/editTitle");this._publishAsync("launchpad","scrollToGroup",{group:g,isInEditTitle:i});}}},this);window.addEventListener("resize",this._resizeHandler.bind(this));this._updateTopGroupInModel();},_resizeHandler:function(){clearTimeout(this._resizeTimer);this._resizeTimer=setTimeout(this.resizeHandler.bind(this),300);},_dashboardDeleteTileHandler:function(e){var t=e.getSource(),T=t.getBindingContext().getObject(),o={tileId:T.uuid};sap.ui.getCore().getEventBus().publish("launchpad","deleteTile",o,this);},dashboardTilePress:function(e){var t=e.getSource();if(!t){return;}var p;if(a.system.desktop){var s=document.activeElement.id.indexOf("feedTile")!==-1;if(document.activeElement.tagName!=="INPUT"&&s!==true){if(sap.ui.getCore().byId(t.getId())){p=d.getInstance().then(function(f){f.setTileFocus(t.$());});}}}else{p=Promise.resolve();}p.then(function(){sap.ui.getCore().getEventBus().publish("launchpad","dashboardTileClick",{uuid:t.getUuid()});});},_updateTopGroupInModel:function(){var m=this.getView().getModel(),t=this._getIndexOfTopGroupInViewPort();var s=this._getModelGroupFromVisibleIndex(t);m.setProperty("/iSelectedGroup",s);m.setProperty("/topGroupInViewPortIndex",t);},_getIndexOfTopGroupInViewPort:function(){var v=this.getView().getDomRef(),s=v.getElementsByTagName("section")[0],j=q(s).find(".sapUshellTileContainer").not(".sapUshellHidden");if(!j){return 0;}for(var i=0;i<j.length;i++){var g=j[i].parentElement;if(s.scrollTop<=(g.offsetTop+g.offsetHeight)){return i;}}return(j.length?(j.length-1):0);},_handleDashboardScroll:function(){var v=this.getView(),m=v.getModel(),n=400;var h=m.getProperty("/homePageGroupDisplay"),e=h!=="tabs",t=m.getProperty("/tileActionModeActive");function H(){u.handleTilesVisibility();}clearTimeout(this.timeoutId);this.timeoutId=setTimeout(H,n);if(!a.system.phone){v.oAnchorNavigationBar.closeOverflowPopup();}if(e||t){this._updateTopGroupInModel();}v.oAnchorNavigationBar.reArrangeNavigationBarElements();},_handleGroupDeletion:function(g){sap.ui.require(["sap/m/MessageBox"],function(M){var e=sap.ui.getCore().getEventBus(),G=g.getObject(),i=G.removable,s=G.title,f=G.groupId,R=r.i18n,A=M.Action,m=(i?A.DELETE:R.getText("ResetGroupBtn"));sap.ushell.Container.getServiceAsync("Message").then(function(o){o.confirm(R.getText(i?"delete_group_msg":"reset_group_msg",s),function(h){if(h===m){e.publish("launchpad",i?"deleteGroup":"resetGroup",{groupId:f});}},R.getText(i?"delete_group":"reset_group"),[m,A.CANCEL]);});});},_modelLoaded:function(){this.bModelInitialized=true;L.getInitPromise().then(function(){this._initializeUIActions();}.bind(this));},_initializeUIActions:function(){if(!this.oDashboardUIActionsModule){this.oDashboardUIActionsModule=new D();}this.oDashboardUIActionsModule.initializeUIActions(this);},resizeHandler:function(){u.recalculateBottomSpace();u.handleTilesVisibility();if(E.last("AppRendered")!==undefined){E.emit("AppRendered",undefined);}if(L&&q("#dashboardGroups").is(":visible")&&this.bModelInitialized){L.reRenderGroupsLayout(null);this._initializeUIActions();}},_appOpenedHandler:function(s,e,o){var p,P,m=this.getView().getModel();p=this.getOwnerComponent();P=p.getMetadata().getComponentName();if(o.additionalInformation&&o.additionalInformation.indexOf(P)===-1){u.setTilesNoVisibility();}if(m.getProperty("/tileActionModeActive")&&sap.ushell.components.homepage.ActionMode){sap.ushell.components.homepage.ActionMode.toggleActionMode(m,"Menu Item");}if(this.oDashboardUIActionsModule){this.oDashboardUIActionsModule.disableAllDashboardUiAction();}},_scrollToGroupByName:function(s,e,o){var g=this.getView().getModel().getProperty("/groups"),G=o.groupName;sap.ushell.Container.getServiceAsync("LaunchPage").then(function(l){g.forEach(function(f){if(l.getGroupTitle(f.object)===G){this._scrollToGroup(s,e,{groupId:f.groupId});}}.bind(this));}.bind(this));},_scrollToGroup:function(s,e,o){var g=o.group?o.group.getGroupId():o.groupId;var G;if(this.oView.oDashboardGroupsBox.getGroups()){G=this.oView.oDashboardGroupsBox.getGroups().reduce(function(i,j){return j&&j.getGroupId()===g?j:i;},null);}var f=G&&G.getDomRef();if(!f){return;}var h=f.querySelector(".sapUshellTileContainerContent");if(!h){return;}h.scrollIntoView();var p;if(a.system.desktop){p=d.getInstance().then(function(i){var j=G.$();if(o.restoreLastFocusedTile){var l=false;if(o.restoreLastFocusedTileContainerById){j=q("#"+o.restoreLastFocusedTileContainerById);l=true;}i.goToLastVisitedTile(j,l);}else if(o.groupChanged){var k=j.find(".sapUshellTile, .sapMGTLineMode, .sapFCard").filter(":visible").eq(0);if(k.length){i.moveScrollDashboard(k);}}});}else{p=Promise.resolve();}p.then(function(){if(o.isInEditTitle){G.setEditMode(true);}u.handleTilesVisibility();});},_handleDrop:function(e,f){var l=L.getLayoutEngine(),t=l.layoutEndCallback(),i=!t.dstArea,o=sap.ui.getCore().getEventBus(),n,g,T,h=q.Deferred(),v=this.getView(),m=v.getModel(),j=m.getProperty("/homePageGroupDisplay")&&m.getProperty("/homePageGroupDisplay")==="tabs",k=m.getProperty("/tileActionModeActive"),I=true,p;if(!t.tile){o.publish("launchpad","sortableStop");return null;}L.getLayoutEngine()._toggleAnchorItemHighlighting(false);if(t.dstGroup){var s=t.dstGroup.getBindingContext(),w=s.getProperty(s.sPath).isGroupLocked;I=i&&w;}p=t.tile.getBindingContext().getObject().isLinkPersonalizationSupported;if(!t.tileMovedFlag||I||(!p&&t.dstArea==="links")){o.publish("launchpad","sortableStop");return null;}if(!k&&!j&&t.dstArea==="links"&&!t.dstGroupData.getLinks().length){o.publish("launchpad","sortableStop");return null;}n=true;g=true;if((t.srcGroup!==t.dstGroup)){n=g=false;}else if(t.tile!==t.dstGroup.getTiles()[t.dstTileIndex]){g=false;}T=this._getTileUuid(t.tile);if(t.srcGroup&&t.srcGroup.removeAggregation&&t.srcArea){t.srcGroup.removeAggregation("tiles",t.tile,n);}var S=t.dstGroupData&&t.dstGroupData.insertAggregation&&t.dstArea===t.srcArea;if(S){t.tile.sParentAggregationName=t.dstArea;t.dstGroupData.insertAggregation(t.dstArea,t.tile,t.dstTileIndex,g);h=this._handleSameTypeDrop(t,T,S);}else if(i){h=this._handleShortDrop(t,T,S);}else{h=this._handleConvertDrop(t,S,f);}if(this.getView().getModel()){this.getView().getModel().setProperty("/draggedTileLinkPersonalizationSupported",true);}o.publish("launchpad","sortableStop");return h.promise();},_handleSameTypeDrop:function(t,T,s){var e=sap.ui.getCore().getEventBus(),o=q.Deferred();t.tile._getBindingContext().oModel.setProperty(t.tile._getBindingContext().sPath+"/draggedInTabBarToSourceGroup",false);e.publish("launchpad","movetile",{sTileId:T,sToItems:t.dstArea?t.dstArea:"tiles",sFromItems:t.srcArea?t.srcArea:"tiles",sTileType:t.dstArea?t.dstArea.substr(0,t.dstArea.length-1):undefined,toGroupId:t.dstGroupData.getGroupId?t.dstGroupData.getGroupId():t.dstGroupData.groupId,toIndex:t.dstTileIndex,longDrop:s,callBack:function(){o.resolve();}});return o.promise();},_handleShortDrop:function(t,T,s){var e=sap.ui.getCore().getEventBus(),o=q.Deferred();e.publish("launchpad","movetile",{sTileId:T,sToItems:t.srcArea||"tiles",sFromItems:t.srcArea||"tiles",sTileType:t.srcArea?t.srcArea.substr(0,t.srcArea.length-1):undefined,toGroupId:t.dstGroupData.getGroupId?t.dstGroupData.getGroupId():t.dstGroupData.groupId,toIndex:t.dstTileIndex,longDrop:s,callBack:function(){o.resolve();}});return o.promise();},_handleConvertDrop:function(t,s,e){var o=sap.ui.getCore().getEventBus(),f=q.Deferred();o.publish("launchpad","convertTile",{toGroupId:t.dstGroupData.getGroupId?t.dstGroupData.getGroupId():t.dstGroupData.groupId,toIndex:t.dstTileIndex,tile:sap.ui.getCore().byId(e.id),srcGroupId:t.srcGroup.getGroupId?t.srcGroup.getGroupId():t.srcGroup.groupId,longDrop:s,callBack:function(){f.resolve();}});return f.promise();},_getTileUuid:function(t){if(t.getUuid){return t.getUuid();}var T=t.getBindingContext().getObject();if(T.getParent){return T.getParent().getUuid();}return T.uuid;},_handleDrag:function(e,f){var t=L.getLayoutEngine().layoutEndCallback(),T=t.tile.getBindingContext().getObject(),m=this.getView().getModel();if(m){m.setProperty("/draggedTileLinkPersonalizationSupported",T.isLinkPersonalizationSupported);}},_handleTabBarItemPressEventHandler:function(s,e,o){var v=this.getView(),m=v.getModel(),g=m.getProperty("/groups"),G=o.iGroupIndex;for(var i=0;i<g.length;i++){m.setProperty("/groups/"+i+"/isGroupSelected",false);}m.setProperty("/groups/"+G+"/isGroupSelected",true);this._handleTabBarItemPress(s,e,G);},_handleTabBarItemPress:function(s,e,g,o){var v=this.getView(),f,h;if(o){f=o.getParameter("group").getIndex();}else{f=g;}sap.ui.getCore().getEventBus().publish("launchpad","tabSelected",{iSelectedGroup:f});h=this._getVisibleGroupIndex(f);v.oDashboardGroupsBox.removeLinksFromUnselectedGroups();v.oDashboardGroupsBox.getBinding("groups").filter([v.oFilterSelectedGroup]);v.oAnchorNavigationBar.setSelectedItemIndex(h);v.oAnchorNavigationBar.reArrangeNavigationBarElements();setTimeout(function(){u.handleTilesVisibility();},0);},_getVisibleGroupIndex:function(s){var g=this.getView().getModel().getProperty("/groups");var h=0;for(var i=0;i<s;i++){if(!g[i].isGroupVisible||!g[i].visibilityModes[0]){h++;}}return s-h;},_getModelGroupFromVisibleIndex:function(s){var g=this.getView().getModel().getProperty("/groups"),v=0;for(var i=0;i<g.length;i++){if(g[i].isGroupVisible&&g[i].visibilityModes[0]){v++;if(v>s){return i;}}}return 0;},_handleAnchorItemPress:function(e){var v=this.getView(),m=v.getModel(),g=m.getProperty("/groups");if(a.system.phone&&e.getParameter("manualPress")){e.oSource.openOverflowPopup();}for(var i=0;i<g.length;i++){if(m.getProperty("/groups/"+i+"/isGroupSelected")===true){m.setProperty("/groups/"+i+"/isGroupSelected",false);}}m.setProperty("/groups/"+e.getParameter("group").getIndex()+"/isGroupSelected",true);m.setProperty("/iSelectedGroup",e.getParameter("group").getIndex());if(m.getProperty("/homePageGroupDisplay")&&m.getProperty("/homePageGroupDisplay")==="tabs"&&!m.getProperty("/tileActionModeActive")){this._handleTabBarItemPress(undefined,undefined,undefined,e);}else{if(!m.getProperty("/tileActionModeActive")){v.oDashboardGroupsBox.getBinding("groups").filter([new F("isGroupVisible",b.EQ,true)]);}else{v.oDashboardGroupsBox.getBinding("groups").filter([]);}this._scrollToGroup("launchpad","scrollToGroup",{group:e.getParameter("group"),groupChanged:true,focus:(e.getParameter("action")==="sapenter")});}},_addGroupHandler:function(o){var i,p=o.getSource().getBindingContext().getPath(),e=p.split("/");i=window.parseInt(e[e.length-1],10);if(o.getSource().sParentAggregationName==="afterContent"){i=i+1;}sap.ui.getCore().getEventBus().publish("launchpad","createGroupAt",{title:"",location:i,isRendered:true});},_publishAsync:function(s,e,o){var B=sap.ui.getCore().getEventBus();window.setTimeout(q.proxy(B.publish,B,s,e,o),1);},_changeGroupVisibility:function(g){var B=g.getPath(),m=g.getModel(),G=m.getProperty(B+"/isGroupVisible");if(m.getProperty(B+"/isDefaultGroup")||m.getProperty(B+"/isGroupLocked")){return;}m.setProperty(B+"/isGroupVisible",!G);},_handleGroupVisibilityChanges:function(s,e,o){var m=this.getView().getModel(),h=sap.ushell.components.getHomepageManager(),f=h.getCurrentHiddenGroupIds(m),S=f.length===o.length,i=S,p;f.some(function(H,I){if(!i){return true;}i=o&&Array.prototype.indexOf.call(o,H)!==-1;return!i;});if(!i){sap.ushell.Container.getServiceAsync("LaunchPage").then(function(l){p=l.hideGroups(f);p.done(function(){m.updateBindings("groups");});p.fail(function(){sap.ushell.Container.getServiceAsync("Message").then(function(g){g.error(r.i18n.getText("hideGroups_error"));});});});}window.setTimeout(function(){u.recalculateBottomSpace();},0);},_updateShellHeader:function(){if(!this.oShellUIService){this._initializeShellUIService();}else{this.oShellUIService.setTitle();this.oShellUIService.setHierarchy();}},_initializeShellUIService:function(){return sap.ui.require(["sap/ushell/ui5service/ShellUIService"],function(S){this.oShellUIService=new S({scopeObject:this.getOwnerComponent(),scopeType:"component"});this.oShellUIService.setTitle();this.oShellUIService.setHierarchy();return this.oShellUIService;}.bind(this));},_deactivateActionModeInTabsState:function(){var v=this.getView(),m=v.getModel(),i;var g=m.getProperty("/groups");for(i=0;i<g.length;i++){m.setProperty("/groups/"+i+"/isGroupSelected",false);}var s=v.oAnchorNavigationBar.getSelectedItemIndex();var h=0;if(!this._isGroupVisible(s)){for(i=0;i<g.length;i++){if(!this._isGroupVisible(i)){h++;}else{s=i;break;}}}else{for(i=0;i<s;i++){if(!this._isGroupVisible(i)){h++;}}}var f=s-h;v.oAnchorNavigationBar.setSelectedItemIndex(f);v.oAnchorNavigationBar.adjustItemSelection();m.setProperty("/groups/"+s+"/isGroupSelected",true);v.oDashboardGroupsBox.removeLinksFromAllGroups();var G=m.getProperty("/homePageGroupDisplay");if(G&&G==="tabs"){v.oDashboardGroupsBox.getBinding("groups").filter([v.oFilterSelectedGroup]);var n=v.oDashboardGroupsBox.getGroups&&v.oDashboardGroupsBox.getGroups();var o=Array.isArray(n)&&n[0];if(o&&o.updateLinks){o.updateLinks();}}},_isGroupVisible:function(g){var G=this.getView().getModel().getProperty("/groups");return(G[g].isGroupVisible&&G[g].visibilityModes[0]);}});});
