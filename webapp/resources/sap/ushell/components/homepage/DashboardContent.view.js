// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/jquery","sap/m/library","sap/m/Page","sap/ui/core/AccessibleLandmarkRole","sap/ui/core/mvc/View","sap/ui/Device","sap/ui/model/Filter","sap/ushell/components/homepage/DashboardGroupsBox","sap/ushell/Config","sap/ushell/EventHub","sap/ushell/resources","sap/ushell/ui/launchpad/AnchorItem","sap/ushell/ui/launchpad/AnchorNavigationBar","sap/ushell/utils","sap/ui/core/Component","sap/ui/model/FilterOperator","sap/ushell/renderers/fiori2/AccessKeysHandler","sap/m/MessageStrip","sap/ushell/components/ComponentKeysHandler"],function(q,m,P,A,V,D,F,a,C,E,r,b,c,u,d,e,f,M,g){"use strict";sap.ui.jsview("sap.ushell.components.homepage.DashboardContent",{createContent:function(o){this.oModel=this.getModel();var h=this.oModel.getProperty("/personalization"),i=this.oModel.getProperty("/enableTileActionsIcon");this.isCombi=D.system.combi;this.isTouch=this.isCombi?false:(D.system.phone||D.system.tablet);this.parentComponent=d.getOwnerComponentFor(this);this.addStyleClass("sapUshellDashboardView");this.oRenderer=sap.ushell.Container.getRenderer("fiori2");this.bIsHomeIntentRootIntent=u.isFlpHomeIntent(this.oRenderer.getShellConfig().rootIntent);sap.ui.getCore().getEventBus().subscribe("launchpad","actionModeInactive",this._handleEditModeChange,this);sap.ui.getCore().getEventBus().subscribe("launchpad","actionModeActive",this._handleEditModeChange,this);sap.ui.getCore().getEventBus().subscribe("launchpad","contentRefresh",this._onDashboardShown,this);sap.ui.getCore().getEventBus().subscribe("launchpad","dashboardModelContentLoaded",this._onDashboardShown,this);this.oDoable=E.once("CoreResourcesComplementLoaded").do(function(){this.oAnchorNavigationBar.setOverflowEnabled(true);if(h||i){sap.ui.require(["sap/ushell/components/homepage/ActionMode"],function(l){l.init(this.oModel);}.bind(this));}if(h){this._createFooter();this._createActionModeButton();}}.bind(this));this.oFilterSelectedGroup=new F("isGroupSelected",e.EQ,true);this.oRenderer.getRouter().getRoute("home").attachMatched(this._onHomeNavigation,this);this.oAnchorNavigationBar=this._getAnchorNavigationBar(o);var p=[];if(C.last("/core/home/gridContainer")){var j=new M({type:"Warning",text:r.i18n.getText("gridModeWarning"),showIcon:true,showCloseButton:true});j.addStyleClass("sapUiMediumMarginBeginEnd");j.addStyleClass("sapUiMediumMarginTopBottom");p.push(j);}var k=new a();this.oDashboardGroupsBox=k.createGroupsBox(o,this.oModel);p.push(this.oDashboardGroupsBox);this.oPage=new P("sapUshellDashboardPage",{customHeader:this.oAnchorNavigationBar,landmarkInfo:{headerRole:A.Navigation,headerLabel:r.i18n.getText("Dashboard.Page.Header.AriaLabel"),contentRole:sap.ui.core.AccessibleLandmarkRole.Region,contentLabel:r.i18n.getText("Dashboard.Page.Content.AriaLabel"),rootRole:A.None},floatingFooter:true,content:p});this.oPage.addEventDelegate({onAfterRendering:function(){var l=this.getDomRef(),s=l.getElementsByTagName("section");q(s[0]).off("scrollstop",o.handleDashboardScroll);q(s[0]).on("scrollstop",o.handleDashboardScroll);}.bind(this)});return this.oPage;},getAnchorItemTemplate:function(){var t=this;var o=new b({index:"{index}",title:"{title}",groupId:"{groupId}",defaultGroup:"{isDefaultGroup}",helpId:"{helpId}",selected:false,isGroupRendered:"{isRendered}",visible:{parts:["/tileActionModeActive","isGroupVisible","visibilityModes"],formatter:function(h,i,v){if(!v[h?1:0]){return false;}return i||h;}},locked:"{isGroupLocked}",isGroupDisabled:{parts:["isGroupLocked","/isInDrag","/homePageGroupDisplay"],formatter:function(i,I,s){return i&&I&&s==="tabs";}},press:function(h){t.oAnchorNavigationBar.handleAnchorItemPress(h);}});o.attachBrowserEvent("focus",function(){this.setNavigationBarItemsVisibility();}.bind(this.oAnchorNavigationBar));return o;},_getAnchorNavigationBar:function(o){var h=new c("anchorNavigationBar",{selectedItemIndex:"{/topGroupInViewPortIndex}",itemPress:[function(i){this._handleAnchorItemPress(i);},o],overflowEnabled:false});if(D.system.desktop){g.getInstance().then(function(i){h.addEventDelegate({onBeforeFastNavigationFocus:function(j){if(q(".sapUshellAnchorItem").is(":visible")){j.preventDefault();i.goToSelectedAnchorNavigationItem();}},onsapenter:function(j){j.srcControl.getDomRef().click();},onsapspace:function(j){j.srcControl.getDomRef().click();}});});}h.addStyleClass("sapContrastPlus");return h;},_actionModeButtonPress:function(){this.oDashboardGroupsBox.getBinding("groups").filter([]);var h=this.oDashboardGroupsBox.getGroups();sap.ushell.components.homepage.ActionMode.toggleActionMode(this.oModel,"Menu Item",h);this._updateAnchorNavigationBarVisibility();if(this.oModel.getProperty("/homePageGroupDisplay")==="tabs"){if(this.oModel.getProperty("/tileActionModeActive")){var G=this.oModel.getProperty("/groups"),s;for(var i=0;i<G.length;i++){if(G[i].isGroupSelected){s=i;break;}}this.getController()._scrollToGroup("launchpad","scrollToGroup",{group:{getGroupId:function(){return G[s].groupId;}},groupChanged:false,focus:true});}else{this.getController()._deactivateActionModeInTabsState();}}},_createActionModeButton:function(){var o={id:"ActionModeBtn",text:r.i18n.getText("activateEditMode"),tooltip:r.i18n.getText("activateEditMode"),icon:"sap-icon://edit",press:this._actionModeButtonPress.bind(this)};var h=this.oRenderer.getShellConfig().moveEditHomePageActionToShellHeader;if(h){this._createActionModeButtonInHeader(o);}else{this._createActionModeButtonInUserMenu(o);}},_createActionModeButtonInHeader:function(o){sap.ui.require(["sap/ushell/ui/shell/ShellHeadItem"],function(S){this.oTileActionsButton=new S(o);if(C.last("/core/extension/enableHelp")){this.oTileActionsButton.addStyleClass("help-id-ActionModeBtn");}if(!this.bIsHomeIntentRootIntent){this.oRenderer.showHeaderEndItem(this.oTileActionsButton.getId(),true);}else{this.oRenderer.showHeaderEndItem(this.oTileActionsButton.getId(),false,["home"]);}}.bind(this));},_createActionModeButtonInUserMenu:function(o){var h={controlType:"sap.ushell.ui.launchpad.ActionItem",oControlProperties:o,bIsVisible:true,aStates:["home"]};if(!this.bIsHomeIntentRootIntent){h.aStates=null;h.bCurrentState=true;}this.oRenderer.addUserAction(h).done(function(i){this.oTileActionsButton=i;if(C.last("/core/extension/enableHelp")){this.oTileActionsButton.addStyleClass("help-id-ActionModeBtn");}}.bind(this));},_handleEditModeChange:function(){if(this.oTileActionsButton){this.oTileActionsButton.toggleStyleClass("sapUshellAcionItemActive");}},_createFooter:function(){sap.ui.require(["sap/m/Bar","sap/m/Button","sap/m/ToolbarSpacer"],function(B,h,T){var o=new B("sapUshellDashboardFooter",{visible:"{/tileActionModeActive}",contentRight:[new T()]});var i=new h("sapUshellDashboardFooterDoneBtn",{type:m.ButtonType.Emphasized,text:r.i18n.getText("closeEditMode"),tooltip:r.i18n.getText("exitEditMode"),press:this._actionModeButtonPress.bind(this)});if(D.system.desktop){g.getInstance().then(function(j){i.addEventDelegate({onsapskipforward:function(k){k.preventDefault();f.setIsFocusHandledByAnotherHandler(true);f.sendFocusBackToShell(k);},onsapskipback:function(k){k.preventDefault();f.setIsFocusHandledByAnotherHandler(true);j.goToFirstVisibleTileContainer();},onsaptabprevious:function(k){k.preventDefault();f.setIsFocusHandledByAnotherHandler(true);j.goToFirstVisibleTileContainer();},onsaptabnext:function(k){k.preventDefault();f.setIsFocusHandledByAnotherHandler(true);f.sendFocusBackToShell(k);}});});}o.addContentRight(i);this.oPage.setFooter(o);}.bind(this));},_onDashboardShown:function(){var i=this.oRenderer&&this.oRenderer.getCurrentCoreView()==="home";if(i){if(!D.system.phone){this.oRenderer.showRightFloatingContainer(false);}this._updateAnchorNavigationBarVisibility();this.getController().resizeHandler();u.refreshTiles();if(D.system.desktop){g.getInstance().then(function(h){h.goToTileContainer();});}if(E.last("firstSegmentCompleteLoaded")){E.emit("CloseFesrRecord",Date.now());}}},_onHomeNavigation:function(){this._onDashboardShown();if(!this.bIsHomeIntentRootIntent){if(this.oRenderer.getShellConfig().moveEditHomePageActionToShellHeader){this.oRenderer.showHeaderEndItem(this.oTileActionsButton.getId(),true);}else{this.oRenderer.showActionButton(this.oTileActionsButton.getId(),true);}}},_updateAnchorNavigationBarVisibility:function(){var o=this.oPage.getShowHeader(),h=this.getModel().getObject("/tileActionModeActive"),v=this.getModel().getProperty("/groups").filter(function(k){if(h){return k.isGroupVisible&&k.visibilityModes[1];}else{return k.isGroupVisible&&k.visibilityModes[0];}}),j=v.length>1;this.oPage.setShowHeader(j);if(j&&!o){var G=this.getModel().getProperty("/groups"),s=this.getModel().getProperty("/iSelectedGroup");for(var i=0;i<v.length;i++){if(v[i].getGroupId&&v[i].getGroupId()===G[s].groupId){this.oAnchorNavigationBar.setSelectedItemIndex(i);break;}}}},getControllerName:function(){return"sap.ushell.components.homepage.DashboardContent";},exit:function(){V.prototype.exit.apply(this,arguments);if(this.oAnchorNavigationBar){this.oAnchorNavigationBar.handleExit();this.oAnchorNavigationBar.destroy();}if(this.oTileActionsButton){this.oTileActionsButton.destroy();}if(this.oDoable){this.oDoable.off();}if(this.oDoneBtnLabel){this.oDoneBtnLabel.destroy();}sap.ui.getCore().getEventBus().unsubscribe("launchpad","actionModeInactive",this._handleEditModeChange,this);sap.ui.getCore().getEventBus().unsubscribe("launchpad","actionModeActive",this._handleEditModeChange,this);sap.ui.getCore().getEventBus().unsubscribe("launchpad","contentRefresh",this._onDashboardShown,this);sap.ui.getCore().getEventBus().unsubscribe("launchpad","dashboardModelContentLoaded",this._onDashboardShown,this);}});},false);
