// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/ushell/components/pages/MyHomeImport","sap/ushell/Config","sap/ushell/library","sap/ushell/resources","sap/ushell/utils/WindowUtils"],function(C,F,J,M,a,u,r,W){"use strict";var D=u.DisplayFormat;var c={"X-SAP-UI2-CHIP:SSB_NUMERIC":"ssuite/smartbusiness/tiles/numeric","X-SAP-UI2-CHIP:SSB_CONTRIBUTION":"ssuite/smartbusiness/tiles/contribution","X-SAP-UI2-CHIP:SSB_TREND":"ssuite/smartbusiness/tiles/trend","X-SAP-UI2-CHIP:SSB_DEVIATION":"ssuite/smartbusiness/tiles/deviation","X-SAP-UI2-CHIP:SSB_COMPARISON":"ssuite/smartbusiness/tiles/comparison","X-SAP-UI2-CHIP:SSB_BLANK":"ssuite/smartbusiness/tiles/blank","X-SAP-UI2-CHIP:SSB_DUAL":"ssuite/smartbusiness/tiles/dual"};return C.extend("sap.ushell.components.pages.controller.ImportDialog",{open:function(){if(!this._pFragmentLoad){this._pFragmentLoad=F.load({name:"sap.ushell.components.pages.view.ImportDialog",controller:this}).then(function(f){this._oDialog=f;this._oDialog.setModel(r.i18nModel,"i18n");this._oDialog.setModel(new J({busy:true,groups:[],PersonalizedGroups:[]}));M.getData().then(function(g){f.getModel().setData({busy:false,groups:g,PersonalizedGroups:g.map(function(b){return{title:b.isDefault?r.i18n.getText("my_group"):b.title,description:b.id,selected:true};})});}).catch(function(e){return sap.ushell.Container.getServiceAsync("Message").then(function(m){m.error(e);});});return this._oDialog;}.bind(this));}return this._pFragmentLoad.then(function(){this._oDialog.open();return this._oDialog;}.bind(this));},close:function(){if(this._oDialog){this._oDialog.close();}},doImport:function(){var m=this._oDialog.getModel();var s=[];m.getProperty("/PersonalizedGroups").forEach(function(b){if(b.selected){s.push(b.description);}});var g=this._prepareImport(s);this._saveImport(g);},_moveVisualization:function(p,g,i,t,d){var T=this._getSectionIndex(p,g,i,d);var b=this._getDefaultSectionIndex(p);var o=this._getDefaultSection(p);var s=0;if(o&&o.visualizations&&o.visualizations.length){s=o.visualizations.length-1;}return p.moveVisualization(this.iPageIndex,b,s,T,t);},_updateVisualization:function(p,g,t,i,v,d){if(t.bUpdateNeeded){var s=this._getSectionIndex(p,g,i,d);return p.updateVisualization(this.iPageIndex,s,v,t);}return Promise.resolve();},_addVisualization:function(g,t,v,i,s,b,d){if(t.isABookmark){if(t.isCustomBookmark){this.aPromiseChain.push(function(){return s.bookmark.addCustomBookmark(t.vizType,t,b).then(this._moveVisualization.bind(this,s.pages,g,i,v,d)).then(this._updateVisualization.bind(this,s.pages,g,t,i,v,d));}.bind(this));}else{this.aPromiseChain.push(function(){return s.bookmark.addBookmark(t,b).then(this._moveVisualization.bind(this,s.pages,g,i,v,d)).then(this._updateVisualization.bind(this,s.pages,g,t,i,v,d));}.bind(this));}}else{this.aPromiseChain.push(function(){var S=this._getSectionIndex(s.pages,g,i,d);var e=s.pages.getModel().getProperty("/pages/"+this.iPageIndex+"/sections/"+S+"/id");return s.pages.addVisualization(this.sPageId,e,t.vizId).then(this._updateVisualization.bind(this,s.pages,g,t,i,v,d));}.bind(this));}},_addToPresetSection:function(g,b,s,d,e){var p=this._getPresetSection(s.pages);var E=p.visualizations.filter(function(v){return v.displayFormatHint!=="compact";}).length;var f=p.visualizations.filter(function(v){return v.displayFormatHint==="compact";}).length;for(var i=0;i<g.tiles.length;++i){this._addVisualization(g,g.tiles[i],i+E,b,s,d,e);}for(var j=0;j<g.links.length;++j){this._addVisualization(g,g.links[j],j+f+E+g.tiles.length,b,s,d,e);}},_addSection:function(g,b,s,d,e){this.aPromiseChain.push(function(){var U=this._getSectionIndex(s.pages,g,b,e);return s.pages.addSection(this.iPageIndex,U,{title:g.title});}.bind(this));for(var i=0,l=g.tiles.length;i<l;++i){this._addVisualization(g,g.tiles[i],i,b,s,d,e);}for(var j=0,f=g.links.length;j<f;++j){this._addVisualization(g,g.links[j],j+g.tiles.length,b,s,d,e);}},_getMyHomeContentNode:function(b){var s=a.last("/core/spaces/myHome/myHomeSpaceId");return b.getContentNodes().then(function(d){var m=d.find(function(e){return e.id===s;});if(!m){return null;}return m.children.find(function(e){return e.id===this.sPageId;}.bind(this));}.bind(this));},_saveImport:function(g){this._oDialog.setBusy(true);var s;this.sPageId=a.last("/core/spaces/myHome/myHomePageId");this.aTilesUpdateNeeded=[];this.aTilesMoveNeeded=[];this.aPromiseChain=[];return Promise.all([sap.ushell.Container.getServiceAsync("Bookmark"),sap.ushell.Container.getServiceAsync("Message"),sap.ushell.Container.getServiceAsync("Pages"),sap.ushell.Container.getServiceAsync("UserInfo")]).then(function(S){s={bookmark:S[0],message:S[1],pages:S[2],userInfo:S[3]};return this._getMyHomeContentNode(s.bookmark);}.bind(this)).then(function(m){this.iPageIndex=s.pages.getPageIndex(this.sPageId);s.pages.enableImplicitSave(false);this._performImportOperations(g,s,m);return this._executeSequentially(this.aPromiseChain);}.bind(this)).then(function(){return this._savePersonalizations(s.pages);}.bind(this)).then(function(){s.message.info(r.i18n.getText("MyHome.InitialPage.Message.ImportSuccessful"));s.userInfo.getUser().setImportBookmarksFlag("done");return s.userInfo.updateUserPreferences();}).then(function(){W.refreshBrowser();}).catch(function(e){s.message.error(e);}).finally(function(){this._oDialog.setBusy(false);this.close();}.bind(this));},_performImportOperations:function(g,s,m){var G;var d=false;for(var i=0,l=g.length;i<l;++i){G=g[i];if(G.isDefault){this._addToPresetSection(G,i,s,m,d);d=true;}else{this._addSection(G,i,s,m,d);}}},_executeSequentially:function(p){return p.reduce(function(b,d){return b.then(function(){return d();});},Promise.resolve());},_getSectionIndex:function(p,g,b,d){var o=this._getPresetSectionIndex(p);if(!g.isDefault&&!g.isLocked&&!d){return o+b+1;}return o+b;},_getPresetSectionIndex:function(p){var s=p.getModel().getProperty("/pages/"+this.iPageIndex+"/sections/");return s.findIndex(function(b){return b.id===a.last("/core/spaces/myHome/presetSectionId");});},_getDefaultSectionIndex:function(p){var s=p.getModel().getProperty("/pages/"+this.iPageIndex+"/sections/");return s.findIndex(function(b){return b.default;});},_getPresetSection:function(p){var s=p.getModel().getProperty("/pages/"+this.iPageIndex+"/sections/");return s.find(function(b){return b.id===a.last("/core/spaces/myHome/presetSectionId");});},_getDefaultSection:function(p){var s=p.getModel().getProperty("/pages/"+this.iPageIndex+"/sections/");return s.find(function(b){return b.default;});},_gatherVizDataObjectFromChipInstance:function(o){var b;var d;var v={vizId:o.chipId,isABookmark:!!o.configuration};if(v.isABookmark){v.isCustomBookmark=["X-SAP-UI2-CHIP:/UI2/STATIC_APPLAUNCHER","X-SAP-UI2-CHIP:/UI2/DYNAMIC_APPLAUNCHER"].indexOf(o.chipId)===-1;b=JSON.parse(JSON.parse(o.configuration).tileConfiguration);v.title=b.display_title_text;v.url=b.navigation_target_url;v.icon=b.display_icon_url;v.info=b.display_info_text;v.subtitle=b.display_subtitle_text;v.serviceUrl=b.service_url;v.serviceRefreshInterval=b.service_refresh_interval;v.numberUnit=b.display_number_unit;v.vizConfig=o.configuration;}d=o.ChipInstanceBags.results;if(d.length){v.bUpdateNeeded=!v.isABookmark;if(v.isCustomBookmark){v.vizConfig={};v.loadManifest=true;v.vizType=c[o.chipId];v.chipConfig={chipId:o.chipId,bags:{},configuration:JSON.parse(o.configuration)};d.forEach(function(B){v.chipConfig.bags[B.id]={properties:{},texts:{}};B.ChipInstanceProperties.results.forEach(function(p){if(p.translatable==="X"){v.chipConfig.bags[B.id].texts[p.name]=p.value;}else{v.chipConfig.bags[B.id].properties[p.name]=p.value;}});});}d.filter(function f(e){return e.id==="tileProperties";}).forEach(function(B){B.ChipInstanceProperties.results.forEach(function(t){switch(t.name){case"display_title_text":v.title=t.value;break;case"display_subtitle_text":v.subtitle=t.value;break;case"display_info_text":v.info=t.value;break;case"display_search_keywords":v.searchKeyword=t.value;break;default:break;}});});d.filter(function f(e){return e.id==="sb_tileProperties";}).forEach(function(B){B.ChipInstanceProperties.results.forEach(function(t){switch(t.name){case"title":v.title=t.value;break;case"description":v.subtitle=t.value;break;default:break;}});});}return v;},_savePersonalizations:function(p){p.enableImplicitSave(true);return p.savePersonalization(this.sPageId).then(function(){p.enableImplicitSave(false);});},_prepareImport:function(g){var G={};var m=this._oDialog.getModel();var b=m.getProperty("/groups");var v;var V;b.forEach(function(o){if(g.indexOf(o.id)===-1){return;}v={};o.chips.forEach(function(e){V=this._gatherVizDataObjectFromChipInstance(e);v[e.instanceId]=V;}.bind(this));o.tiles=[];o.tileOrder.forEach(function(t){V=v[t];if(V){delete v[t];o.tiles.push(V);}});o.links=[];o.linkOrder.forEach(function(t){V=v[t];if(V){delete v[t];V.displayFormatHint=D.Compact;V.bUpdateNeeded=true;o.links.push(V);}});Object.keys(v).map(function(k){o.tiles.push(v[k]);});G[o.id]=o;}.bind(this));var d=[];var o;g.forEach(function(s){o=G[s];if(o){d.push(o);}});return d;}});});
