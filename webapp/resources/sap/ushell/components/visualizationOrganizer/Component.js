// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/m/library","sap/m/GroupHeaderListItem","sap/ushell/library","sap/ui/core/UIComponent","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/base/Log","sap/ushell/Config","sap/ushell/resources","sap/m/MessageBox"],function(m,G,u,U,F,c,J,L,C,r,M){"use strict";var B=m.ButtonType;return U.extend("sap.ushell.components.visualizationOrganizer.Component",{metadata:{version:"1.96.0",library:"sap.ushell",dependencies:{libs:["sap.m"]},properties:{pressed:{type:"boolean",group:"Misc",defaultValue:false}}},init:function(){U.prototype.init.apply(this,arguments);this.aPersonalizablePages=[];this.mVizIdInPages=new Map();this.stVizIdInSection=new Set();},requestData:function(){var o=!C.last("/core/shell/enablePersonalization")&&C.last("/core/spaces/myHome/enabled");var s=C.last("/core/spaces/myHome/myHomePageId");return sap.ushell.Container.getServiceAsync("CommonDataModel").then(function(a){return a.getAllPages();}).then(function(p){if(o){p=p.filter(function(P){return P.identification.id===s;});}this.aPersonalizablePages=p.map(function(P){return{id:P.identification.id,title:P.identification.title};});this._fillVizIdMaps(p);return this.aPersonalizablePages;}.bind(this));},_fillVizIdMaps:function(p){this.mVizIdInPages=new Map();p.forEach(function(P){Object.keys(P.payload.sections).forEach(function(i){Object.keys(P.payload.sections[i].viz).forEach(function(I){var v=P.payload.sections[i].viz[I].vizId;if(this.mVizIdInPages.has(v)){this.mVizIdInPages.get(v).add(P.identification.id);}else{this.mVizIdInPages.set(v,new Set([P.identification.id]));}}.bind(this));}.bind(this));}.bind(this));},isVizIdPresent:function(v,s){if(s){return this.stVizIdInSection.has(v);}var a=this.mVizIdInPages.get(v);return!!(a&&a.size);},formatPinButtonIcon:function(v,s){return(this.isVizIdPresent(decodeURIComponent(v),s)?"sap-icon://accept":"sap-icon://add");},formatPinButtonType:function(v,s){return(this.isVizIdPresent(decodeURIComponent(v),s)?B.Emphasized:B.Default);},formatPinButtonTooltip:function(v,s){var i=this.isVizIdPresent(decodeURIComponent(v),!!s),t,S;if(s){S=s.sectionTitle;if(i){t="VisualizationOrganizer.Button.Tooltip.RemoveFromSection";}else{t="VisualizationOrganizer.Button.Tooltip.AddToSection";}}else if(i){t="EasyAccessMenu_PinButton_Toggled_Tooltip";}else{t="EasyAccessMenu_PinButton_UnToggled_Tooltip";}return r.i18n.getText(t,S);},onTilePinButtonClick:function(e,s){var S=e.getSource();var t=S.getBindingContext().getProperty();if(S.getBusy()){return Promise.resolve();}if(s){S.setBusy(true);return this._applyOrganizationChangeToSection(S,t,s).then(function(){S.setBusy(false);});}if(this.aPersonalizablePages.length===1){S.setBusy(true);return this._applyChangeToPage(S,t,this.aPersonalizablePages[0]).then(function(){S.setBusy(false);});}return this.toggle(S,t);},open:function(o,v){var p=sap.ui.getCore().byId("sapUshellVisualizationOrganizerPopover"),l=Promise.resolve();if(!p){l=new Promise(function(a,b){sap.ui.require(["sap/ui/core/Fragment"],function(d){d.load({name:"sap.ushell.components.visualizationOrganizer.VisualizationOrganizerPopover",type:"XML",controller:this}).then(a).catch(b);}.bind(this));}.bind(this)).then(function(a){p=a;p.setModel(new J({pages:[],searchTerm:""}));p.setModel(r.i18nModel,"i18n");});}return l.then(function(){this.oOpenBy=o;this.sVisualizationId=decodeURIComponent(v.id);this.sVisualizationTitle=v.title;this.oVizInfo=v;this.fnResetPopup=this._resetPopup.bind(this);p.attachAfterClose(this.fnResetPopup);return Promise.all([sap.ushell.Container.getServiceAsync("Menu"),sap.ushell.Container.getServiceAsync("CommonDataModel"),sap.ushell.Container.getServiceAsync("Pages")]).then(function(R){var P;if(v.isBookmark){P=R[2]._findBookmarks({url:v.url}).then(function(a){var b=a.map(function(f){return f.pageId;});return Promise.resolve(new Set(b));});}else{P=this.mVizIdInPages.get(this.sVisualizationId);}return Promise.all([R[0].getSpacesPagesHierarchy(),R[1].getAllPages(),P]);}.bind(this)).then(function(R){var s=R[0].spaces,a=R[1],P=R[2],b={};a.forEach(function(g){b[g.identification.id]=g.identification.title;});var O=!C.last("/core/shell/enablePersonalization")&&C.last("/core/spaces/myHome/enabled");var d=C.last("/core/spaces/myHome/myHomeSpaceId");var e=[];s.forEach(function(g){if(O&&g.id!==d){return;}g.pages.forEach(function(h){var i=b[h.id];if(!i){return;}e.push({id:h.id,title:b[h.id],space:g.title,spaceId:g.id,selected:P&&P.has(h.id)});});});var f=p.getModel();f.setProperty("/pages",e);f.setProperty("/pinnedPages",P);this._updatePagesList();p.openBy(o);}.bind(this));}.bind(this));},cancel:function(){var p=sap.ui.getCore().byId("sapUshellVisualizationOrganizerPopover"),o=this._retrieveChangedPageIds();if(p&&o.deleteFromPageIds.length===0&&o.addToPageIds.length===0){p.close();}else{M.show(r.i18n.getText("VisualizationOrganizer.MessageBox.Description"),{id:"sapUshellVisualizationOrganizerDiscardDialog",title:r.i18n.getText("VisualizationOrganizer.MessageBox.Title"),actions:[r.i18n.getText("VisualizationOrganizer.MessageBox.ActionDiscard"),M.Action.CANCEL],emphasizedAction:r.i18n.getText("VisualizationOrganizer.MessageBox.ActionDiscard"),onClose:function(a){if(a===r.i18n.getText("VisualizationOrganizer.MessageBox.ActionDiscard")){p.close();}}});}},toggle:function(o,v){var p=sap.ui.getCore().byId("sapUshellVisualizationOrganizerPopover");if(p&&p.isOpen()&&p._oOpenBy&&p._oOpenBy.getId()===o.getId()){this.cancel();return Promise.resolve();}return this.open(o,v);},_applyOrganizationChangeToSection:function(o,v,s){var V=decodeURIComponent(v.id),d=v.title,p=s.pageID,S=s.sectionID,P=sap.ushell.Container.getService("Pages"),e,f;if(this.stVizIdInSection.has(V)){f=r.i18n.getText("VisualizationOrganizer.MessageToastSectionContextRemove",[d||V,s.sectionTitle,s.pageTitle]);e=P.findVisualization(p,S,V).then(function(g){if(g.length===0){return Promise.resolve();}var h=g[0],i=P.getPageIndex(p),j=h.sectionIndex,k;var l=h.vizIndexes.sort(function(a,b){return b-a;});l.forEach(function(a){if(!k){k=P.deleteVisualization(i,j,a);}else{k=k.then(function(){return P.deleteVisualization(i,j,a);});}});return k;}).then(function(){this.stVizIdInSection.delete(V);}.bind(this));}else{f=r.i18n.getText("VisualizationOrganizer.MessageToastSectionContextAdd",[d||V,s.sectionTitle,s.pageTitle]);e=P.addVisualization(p,S,V).then(function(){this.stVizIdInSection.add(V);}.bind(this));}return e.then(function(){o.getBinding("icon").refresh(true);o.getBinding("type").refresh(true);o.getBinding("tooltip").refresh(true);sap.ui.require(["sap/m/MessageToast"],function(a){a.show(f,{offset:"0 -50"});});});},_organizeVisualizations:function(){var o=this._retrieveChangedPageIds();if(this.oVizInfo.isBookmark){return this._applyBookmarkOrganizationChange(o,true);}return this._applyOrganizationChange(o,true);},_applyOrganizationChange:function(v,s){var i=(v.addToPageIds.length+v.deleteFromPageIds.length);if(!i){return Promise.resolve();}var V=this.sVisualizationId;var o=this.oOpenBy;var a=new Set();var p;var b=sap.ushell.Container.getServiceAsync("Pages").then(function(P){p=P;});v.deleteFromPageIds.forEach(function(P){if(!a.has(P)){a.add(P);b=b.then(function(){return p.findVisualization(P,null,V).then(function(d){var e=[],f,g,h;for(var n=d.length-1;n>=0;n--){g=d[n];f=p.getPageIndex(g.pageId);for(var N=g.vizIndexes.length-1;N>=0;N--){h=g.vizIndexes[N];e.push(p.deleteVisualization(f,g.sectionIndex,h));}}return Promise.all(e);});});}this.mVizIdInPages.get(V).delete(P);}.bind(this));v.addToPageIds.forEach(function(P){b=b.then(function(){return p.addVisualization(P,null,V);});if(this.mVizIdInPages.has(V)){this.mVizIdInPages.get(V).add(P);}else{this.mVizIdInPages.set(V,new Set([P]));}}.bind(this));return b.then(function(){if(o){o.getBinding("icon").refresh(true);o.getBinding("type").refresh(true);o.getBinding("tooltip").refresh(true);}if(s){sap.ui.require(["sap/m/MessageToast"],function(d){d.show(r.i18n.getText("VisualizationOrganizer.MessageToast"));});}});},_resetPopup:function(e){var p=sap.ui.getCore().byId("sapUshellVisualizationOrganizerPopover"),P=sap.ui.getCore().byId("sapUshellVisualizationOrganizerSpacesList"),s=sap.ui.getCore().byId("sapUshellVisualizationOrganizerSearch"),t=sap.ui.getCore().byId("sapUshellVisualizationOrganizerSelectedPages");p.detachAfterClose(this.fnResetPopup);s.setValue("");t.setType(B.Default);P.getBinding("items").filter(null);P.removeSelections();delete this.fnResetPopup;delete this.sVisualizationId;delete this.sVisualizationTitle;},pagePressed:function(e){this._changeSelectionForAllPagesWithTheSamePageId(e.getSource());},onSelectionChange:function(e){var s=e.getParameter("listItem"),S=e.getParameter("selected");this._changeSelectionForAllPagesWithTheSamePageId(s,S);},_changeSelectionForAllPagesWithTheSamePageId:function(i,s){var o=i.getModel(),a=i.getBindingContext(),I=a.getProperty("id"),S=(s!==undefined)?s:!a.getProperty("selected");var p=o.getProperty("/pages");for(var b=0;b<p.length;b++){var P=p[b];if(P.id===I){P.selected=S;}}o.setProperty("/pages",p);},_onSearch:function(e){var s=sap.ui.getCore().byId("sapUshellVisualizationOrganizerSelectedPages");var p=this.getPressed();if(e.sId==="press"){p=!p;this.setPressed(p);s.setPressed(p);}this._updatePagesList();},_updatePagesList:function(){var p=sap.ui.getCore().byId("sapUshellVisualizationOrganizerSpacesList");var s=sap.ui.getCore().byId("sapUshellVisualizationOrganizerSearch");var b=p.getBinding("items");var S=s.getValue();var t=this.getPressed();if(t){b.filter(new F({filters:[new F({filters:[new F({path:"title",operator:c.Contains,value1:S}),new F({path:"selected",operator:c.EQ,value1:t})],and:true}),new F({filters:[new F({path:"space",operator:c.Contains,value1:S}),new F({path:"selected",operator:c.EQ,value1:t})],and:true})],and:false}));}else{b.filter(new F({filters:[new F({path:"title",operator:c.Contains,value1:S}),new F({path:"space",operator:c.Contains,value1:S})],and:false}));}if(b.getLength()===0){p.setNoDataText(r.i18n.getText(S?"VisualizationOrganizer.PagesList.NoResultsText":"VisualizationOrganizer.PagesList.NoDataText"));}},loadSectionContext:function(o){this.stVizIdInSection.clear();if(!o||!o.pageID||!o.sectionID){return Promise.resolve(null);}return sap.ushell.Container.getServiceAsync("Pages").then(function(p){var P=decodeURIComponent(o.pageID),s=decodeURIComponent(o.sectionID);return p.loadPage(P).then(function(a){var b=p.getModel().getProperty(a),S,d;for(var i=0;i<b.sections.length;i++){if(b.sections[i].id===s){S=b.sections[i];break;}}if(!S){return Promise.resolve(null);}S.visualizations.forEach(function(v){this.stVizIdInSection.add(v.vizId);}.bind(this));d={pageID:P,sectionID:s,pageTitle:b.title,sectionTitle:S.title};return Promise.resolve(d);}.bind(this)).catch(function(){L.warning(P+" cannot be loaded. Please, check the id of the page.");return Promise.resolve(null);});}.bind(this));},getPersonalizablePages:function(){return this.aPersonalizablePages;},_retrieveChangedPageIds:function(){var p=sap.ui.getCore().byId("sapUshellVisualizationOrganizerSpacesList"),s=sap.ui.getCore().byId("sapUshellVisualizationOrganizerSearch"),P=p.getModel(),a=P.getProperty("/pinnedPages")||new Set();p.getBinding("items").filter(null);var i=p.getItems().filter(function(I){return I.isA("sap.m.StandardListItem");});s.fireSearch();var A={},b=[],d=[];i.forEach(function(I){var e=I.getBindingContext().getProperty("id");if(!A[e]){A[e]=true;if(I.getSelected()&&!a.has(e)){b.push(e);}else if(!I.getSelected()&&a.has(e)){d.push(e);}}});return{addToPageIds:b,deleteFromPageIds:d};},okay:function(){var p=sap.ui.getCore().byId("sapUshellVisualizationOrganizerPopover");if(p.getBusy()){return;}p.setBusy(true);this._organizeVisualizations().then(function(){p.setBusy(false);p.close();}).catch(function(){L.error("Could not save the selected pages on the VisualizationOrganizerPopover");});},onHierarchyAppsPinButtonClick:function(e,s){var S=e.getSource();var a=S.getParent().getBinding("title").getContext().getObject();if(S.getBusy()){return Promise.resolve(false);}a.isBookmark=true;a.title=a.text;if(s){S.setBusy(true);return this._applyBookmarkTileChangeToSection(a,s).then(function(){S.setBusy(false);return Promise.resolve(true);});}if(this.aPersonalizablePages.length===1){S.setBusy(true);return this._applyChangeToPage(S,a,this.aPersonalizablePages[0]).then(function(){S.setBusy(false);return Promise.resolve(true);});}return new Promise(function(R){this.toggle(S,a).then(function(){var p=sap.ui.getCore().byId("sapUshellVisualizationOrganizerPopover");if(p&&p.isOpen()){p.attachEventOnce("afterClose",function(){R(true);});}else{R(false);}});}.bind(this));},_applyBookmarkOrganizationChange:function(v,s){var i=(v.addToPageIds.length+v.deleteFromPageIds.length);if(!i){return Promise.resolve();}var V=this.oVizInfo;var a=new Set();var b,p;var o=Promise.all([sap.ushell.Container.getServiceAsync("Bookmark"),sap.ushell.Container.getServiceAsync("Pages")]).then(function(S){b=S[0];p=S[1];return Promise.resolve();});v.deleteFromPageIds.forEach(function(P){if(!a.has(P)){a.add(P);o=o.then(function(){return p.deleteBookmarks({url:V.url},P);});}});v.addToPageIds.forEach(function(P){o=o.then(function(){return new Promise(function(R,f){var d={url:V.url,title:V.text,subtitle:V.subtitle,icon:V.icon};var e={type:u.ContentNodeType.Page,id:P,isContainer:true};b.addBookmark(d,e).done(R).fail(f);});});});return o.then(function(){if(s){sap.ui.require(["sap/m/MessageToast"],function(d){d.show(r.i18n.getText("VisualizationOrganizer.MessageToast"));});}});},_applyBookmarkTileChangeToSection:function(v,s){var a=v.url,V=v.title,p=s.pageID,S=s.sectionID,P=sap.ushell.Container.getService("Pages"),o,b;if(v.bookmarkCount>0){b=r.i18n.getText("VisualizationOrganizer.MessageToastSectionContextRemove",[V,s.sectionTitle,s.pageTitle]);o=P.deleteBookmarks({url:a},p,S);}else{var d={url:a,title:v.text,subtitle:v.subtitle,icon:v.icon};b=r.i18n.getText("VisualizationOrganizer.MessageToastSectionContextAdd",[V,s.sectionTitle,s.pageTitle]);o=P.addBookmarkToPage(p,d,S);}return o.then(function(){sap.ui.require(["sap/m/MessageToast"],function(e){e.show(b,{offset:"0 -50"});});});},updateBookmarkCount:function(a,s){return sap.ushell.Container.getServiceAsync("Pages").then(function(P){var b=a.map(function(A){return P._findBookmarks({url:A.url}).then(function(f){if(s){f=f.filter(function(o){return s.pageID===o.pageId&&s.sectionID===o.sectionId;});}A.bookmarkCount=f.length;return A;});});return Promise.all(b);});},formatBookmarkPinButtonTooltip:function(b,s){var t,S;if(s){S=s.sectionTitle;if(b>0){t="VisualizationOrganizer.Button.Tooltip.RemoveFromSection";}else{t="VisualizationOrganizer.Button.Tooltip.AddToSection";}}else if(b>0){t="EasyAccessMenu_PinButton_Toggled_Tooltip";}else{t="EasyAccessMenu_PinButton_UnToggled_Tooltip";}return r.i18n.getText(t,S);},_applyChangeToPage:function(o,v,p){var V=decodeURIComponent(v.id);var s=v.title;var P=p.id;var i=v.isBookmark?v.bookmarkCount>0:this.isVizIdPresent(V);var a={addToPageIds:i?[]:[P],deleteFromPageIds:i?[P]:[]};var b=r.i18n.getText(i?"VisualizationOrganizer.MessageToastPageRemove":"VisualizationOrganizer.MessageToastPageAdd",[s||V,p.title]);this.oVizInfo=v;this.sVisualizationId=V;var d;if(v.isBookmark){d=this._applyBookmarkOrganizationChange(a,false);}else{d=this._applyOrganizationChange(a,false);}return d.then(function(){o.getBinding("icon").refresh(true);o.getBinding("type").refresh(true);o.getBinding("tooltip").refresh(true);sap.ui.require(["sap/m/MessageToast"],function(e){e.show(b,{offset:"0 -50"});});});},groupBySpace:function(b){return{key:b.getProperty("spaceId"),title:b.getProperty("space")};},getGroupHeader:function(s){return new G({title:s.title});},exit:function(){var p=sap.ui.getCore().byId("sapUshellVisualizationOrganizerPopover");if(p){p.destroy();}}});});
