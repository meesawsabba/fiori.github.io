// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/model/FilterOperator","sap/ui/model/analytics/odata4analytics","sap/ui/core/format/NumberFormat","sap/ui/model/odata/ODataModel","sap/base/Log","sap/ui/thirdparty/jquery","sap/base/util/UriParameters","sap/ushell/utils/UrlParsing"],function(F,o,N,O,L,q,U,a){"use strict";var P=o.ParameterizationRequest;var Q=o.QueryResultRequest;var R=o.Model.ReferenceByModel;var M=o.Model;sap=sap||{};sap.ushell=sap.ushell||{};sap.ushell.components=sap.ushell.components||{};sap.ushell.components.tiles.indicatorTileUtils=sap.ushell.components.tiles.indicatorTileUtils||{};sap.ushell.components.tiles.indicatorTileUtils.util=sap.ushell.components.tiles.indicatorTileUtils.util||{};sap.ushell.components.tiles.indicatorTileUtils.util=(function(g,$){var c={},t={"ANN":"years","WEE":"weeks","DAY":"days","HUR":"hours","MIN":"minutes"},b={},f={};return{getScheduledJob:function(k){return b[k];},setScheduledJob:function(k,d){b[k]=d;},isCallInProgress:function(k){return f[k];},setUnsetCallInProgress:function(k,v){f[k]=v;},getTimeUnitMap:function(){return t;},getHanaUser:function(){return authObject.userName;},addSystemToServiceUrl:function(u,s){L.info("Hana Adapter --> Add System to Service Url");if(sap.ushell&&sap.ushell.Container){if(s){u=new a("URLParsing").addSystemToServiceUrl(u,s);}else{u=new a("URLParsing").addSystemToServiceUrl(u);}}return u;},getODataModelByServiceUri:function(s){s=this.addSystemToServiceUrl(s);if(!c[s]){var m=new O(s,{loadMetadataAsync:true,json:true});c[s]=m;}return c[s];},getEdmType:function(u,p){var d=null;if(u instanceof O){d=u;}else{d=this.getODataModelByServiceUri(u);}if(d&&d.getServiceMetadata()){var s=d.getServiceMetadata();var e=s.dataServices.schema[0].entityType;if(e){for(var i=0;i<e.length;i++){var h=e[i];var k=h.property;for(var j=0;j<k.length;j++){var l=k[j];if(l.name==p){return l.type;}}}}}return null;},getMillisecond:function(d,u){var r;switch(u){case"seconds":r=d*1000;break;case"minutes":r=d*60*1000;break;case"hours":r=d*60*60*1000;break;case"days":r=d*24*60*60*1000;break;case"weeks":r=d*7*24*60*60*1000;break;case"months":r=d*4*7*24*60*60*1000;break;case"years":r=d*12*4*7*24*60*60*1000;break;}return r;},getUTCDate:function(){var n=new Date();return n;},isCacheValid:function(d,e,h,i,j){var k=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(d);if(!k){return false;}else if(!(h&&Number(h))){return true;}var l=this.getMillisecond(h,t[i]),m;if(q.type(k.CachedTime)=="date"){m=k.CachedTime&&k.CachedTime.getTime();}else{m=k.CachedTime&&parseInt(k.CachedTime.substr(6),10);}var n=this.getUTCDate();return(m>=e&&l>=(n-m)&&!j);},getMantissaLength:function(n){var s=n.toString();var i=0;if(n<0){i=1;}if(s.indexOf(".")===-1){return(n<0?s.length-1:s.length);}return s.substring(i,s.indexOf(".")).length;},getLocaleFormattedValue:function(n,s,d,i,e){sap.ui.require("sap.ui.core.format.NumberFormat");i=i||false;e=e||null;if(i){return N.getCurrencyInstance({style:"short",showMeasure:false}).format(n,e);}var D=2;var h={style:"short"};var j;if(!(d==-1||d==null)){h.shortDecimals=Number(d);h.minFractionDigits=Number(d);h.maxFractionDigits=Number(d);}var v=N.getInstance(h);if(s==-2){if(n>9999){j="????";}else if((n>-0.001&&n<0)||(n<0.001&&n>0)){j="0";}else{if(n.toString().indexOf(".")!=-1){j=Number(n).toFixed(4-n.toString().indexOf("."));}else{j=Number(n);}j=v.format(j);}}else if(d==-1||d==null){var m=this.getMantissaLength(n);if(!(m%3)){D=1;}if(m%3===1){D=3;}if(m%3===2){D=2;}if(Math.abs(n)%Math.pow(10,m-1)==0){D=0;}else if((Math.abs(n)%Math.pow(10,m-1))<6*Math.pow(10,m-4)){D=0;}v=N.getInstance({style:"short",shortDecimals:D});j=v.format(n);}else{j=v.format(n);}return j;},getPlatform:function(p){return(new U(window.location.href).get("sb_metadata")||p||"HANA").toUpperCase();},getTileTitleSubtitle:function(C){var d={};if(C.bag&&C.bag.getBagIds()&&C.bag.getBagIds().length){d.title=C.bag.getBag("sb_tileProperties").getText("title")||C.bag.getBag("sb_tileProperties").getProperty("title")||C.preview.getTitle();d.subTitle=C.bag.getBag("sb_tileProperties").getText("description")||C.bag.getBag("sb_tileProperties").getProperty("description")||C.preview.getDescription();}else{d.title=C.preview.getTitle();d.subTitle=C.preview.getDescription();}return d;},scheduleFetchDataJob:function(i){var d;if(this.getView().getViewName().indexOf("DualTile")!==-1){d=this.oKpiTileView.oConfig;}else{d=this.oConfig;}var k=d.TILE_PROPERTIES.id+"data";var r=sap.ushell.components.tiles.indicatorTileUtils.util.getScheduledJob(k);if(r){clearTimeout(r);r=undefined;}var t=sap.ushell.components.tiles.indicatorTileUtils.util.getTimeUnitMap(),e=sap.ushell.components.tiles.indicatorTileUtils.util.getCachingTime(d),h=sap.ushell.components.tiles.indicatorTileUtils.util.getCachingTimeUnit(d),j=sap.ushell.components.tiles.indicatorTileUtils.util.getMillisecond(e,t[h]),l;if(q.type(this.cacheTime)=="date"){l=this.cacheTime;}else{l=new Date(parseInt(this.cacheTime.substr(6),10));}var m=j-(sap.ushell.components.tiles.indicatorTileUtils.util.getUTCDate()-l);if(m<=0){m=0;}else if(m>2147483646){m=2147483646;}if(!i){m=300000;}if(this.getView().getViewName().indexOf("DualTile")!==-1){r=setTimeout(this.refreshPress.bind(this),m);}else{r=setTimeout(this.refreshHandler.bind(this,false,true),m);sap.ushell.components.tiles.indicatorTileUtils.util.setScheduledJob(k,r);}this.updateDatajobScheduled=true;},scheduleTimeStampJob:function(){var k=this.oConfig.TILE_PROPERTIES.id+"time",r=sap.ushell.components.tiles.indicatorTileUtils.util.getScheduledJob(k),d;if(r){clearTimeout(r);r=undefined;}if(q.type(this.cacheTime)=="date"){d=this.cacheTime;}else{d=new Date(parseInt(this.cacheTime.substr(6),10),13);}var e=sap.ushell.components.tiles.indicatorTileUtils.util.getTimeDifference(sap.ushell.components.tiles.indicatorTileUtils.util.getUTCDate()-d);r=setTimeout(this.setTimeStamp.bind(this,this.cacheTime),e.timer);sap.ushell.components.tiles.indicatorTileUtils.util.setScheduledJob(k,r);this.updateTimeStampjobScheduled=true;},getBoolValue:function(v){var r=false;if(typeof v==="boolean"&&v){r=true;}return r;},getSeconds:function(d){return(d/1000);},getMinutes:function(d){return(this.getSeconds(d)/60);},getHours:function(d){return(this.getMinutes(d)/60);},getDays:function(d){return(this.getHours(d)/24);},getWeeks:function(d){return(this.getDays(d)/7);},getMonths:function(d){return(this.getWeeks(d)/4);},getYears:function(d){return(this.getMonths(d)/12);},getTimeDifference:function(d){var r={};if(d){var m=this.getMinutes(d);var h=this.getHours(d);var e=this.getDays(d);if(m<5){r.time=0;r.unit="minutes";r.timer=Math.round(this.getMillisecond(5-m,"minutes"));}else if(m>=5&&m<60){if(m<10){r.time=5;}else{r.time=(m-(m%10));}r.unit="minutes";r.timer=Math.round(this.getMillisecond(10-(m%10),"minutes"));}else if(h>=1&&h<24){r.unit="hours";r.time=(h-(h%1));r.timer=Math.round(this.getMillisecond(1-(h%1),"hours"));}else if(e>=1&&e<2){r.unit="days";r.time=(e-(e%1));r.timer=Math.round(this.getMillisecond(1-(e%1),"days"));}else{r.unit="days";r.time=(e-(e%1));r.timer=this.getMillisecond(2,"days");}}else{r.timer=6000;r.unit="days";r.timer=2000;}return r;},getCachingTime:function(C){return((C.CACHINGTIME&&Number(C.CACHINGTIME))||(C.TILE_PROPERTIES.cachingTime&&Number(C.TILE_PROPERTIES.cachingTime)));},getCachingTimeUnit:function(C){return(C.CACHINGUNIT||C.TILE_PROPERTIES.cachingTimeUnit);},getFrontendCacheQuery:function(d,u,p,T){var e;try{var h=T.url.addSystemToServiceUrl("/sap/opu/odata/SSB/SMART_BUSINESS_RUNTIME_SRV");h=sap.ushell.components.tiles.indicatorTileUtils.util.cacheBustingMechanism(h);e=this.getODataModelByServiceUri(h);h="/CacheParameters(P_CacheType=1)/Results";return{oModel:e,uri:h};}catch(i){L.error("FrontEnd cache Metadata failed");return null;}},isDualTile:function(C){var d=C&&C.TILE_PROPERTIES&&C.TILE_PROPERTIES.tileType;if(d.indexOf("DT-")==-1){return false;}return true;},writeFrontendCacheByChipAndUserId:function(T,d,e,u,h){var s=function(e){L.info("cache write successFully");h(e);};var i=function(){L.error("cache update failed");h(null);};try{var j=T.url.addSystemToServiceUrl("/sap/opu/odata/SSB/SMART_BUSINESS_RUNTIME_SRV/");j=sap.ushell.components.tiles.indicatorTileUtils.util.cacheBustingMechanism(j);var k=this.getODataModelByServiceUri(j);var l="/CacheData";k.create(l,e,{async:true,success:s,error:i});}catch(m){L.error(m);}},getKpiChipsOnPage:function(d,e){var h=[];sap.ushell.Container.getServiceAsync("LaunchPage").then(function(l){l.getGroups().done(function(G){if(G&&G instanceof Array&&G.length){L.info("Group Chip fetch");}e(d,h);});});},getFrontendCache:function(C,T){var d=this;var e=sap.ushell.components.tiles.indicatorTileUtils.cache.getFrontEndCacheDeferredObject(T.url.getApplicationSystem());var h;if(e){h=e;}else{h=q.Deferred();}var i=C&&C.TILE_PROPERTIES&&C.TILE_PROPERTIES.id;var j=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(i);if(j){e.resolve(true);}else if(e){return e.promise();}else{sap.ushell.components.tiles.indicatorTileUtils.cache.setFrontEndCacheDefferedObject(T.url.getApplicationSystem(),h);e=h;this.getKpiChipsOnPage(i,function(i,p){if(p){var k=d.getFrontendCacheQuery(p,sap.ushell.Container.getUser().getId(),p,T);if(k){var l=k.oModel;var m=k.uri;var n=false;l.read(m,null,null,true,function(r){if(r&&r.results&&r.results instanceof Array&&r.results.length){q.each(r.results,function(s,u){sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(u.ChipId,u);});}if(sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(i)){n=true;}e.resolve(n);},function(r){if(r&&r.response){L.error(r.message+" : "+r.request.requestUri);}e.reject();});}else{e.reject();}}else{e.resolve(false);}});}return e.promise();},getModelerRuntimeServiceModel:function(){var u="/sap/hba/r/sb/core/odata/runtime/SMART_BUSINESS.xsodata";u=sap.ushell.components.tiles.indicatorTileUtils.util.cacheBustingMechanism(u);return this.getODataModelByServiceUri(u);},getSapFontErrorCode:function(){return String.fromCharCode(0xe0b1);},getSapFontBusyCode:function(){return String.fromCharCode(0xe1f2);},prepareFilterStructure:function(d,e){var v=[];if(e){d=d.concat(e);}for(var i=0;i<d.length;i++){var p={};p.comparator=d[i].OPERATOR;p.filterPropertyName=d[i].NAME;if(d[i].ID){p.id=d[i].ID;}p.type=d[i].TYPE;p.value=d[i].VALUE_1;p.valueTo=d[i].VALUE_2;v.push(p);}return v;},getODataModelByServiceUriFromChipAPI:function(s,T){s=T.url.addSystemToServiceUrl(s);if(!c[s]){var m=new O(s,true);c[s]=m;}return c[s];},cacheBustingMechanism:function(u){if(window["sap-ushell-config"].cacheBusting.cacheBusterToken){var d=window["sap-ushell-config"].cacheBusting&&window["sap-ushell-config"].cacheBusting.cacheBusterToken;u=u+"?_="+d;}return u;},getRunTimeUri:function(p){var u="/sap/hba/r/sb/core/odata/runtime/SMART_BUSINESS.xsodata";var d="/sap/opu/odata/SSB/SMART_BUSINESS_RUNTIME_SRV";if(p.toUpperCase()=="HANA"){if(window["sap-ushell-config"].cacheBusting){u=sap.ushell.components.tiles.indicatorTileUtils.util.cacheBustingMechanism(u);}return u;}if(window["sap-ushell-config"].cacheBusting){d=sap.ushell.components.tiles.indicatorTileUtils.util.cacheBustingMechanism(d);}return d;},getFilterFromRunTimeService:function(C,T,s,e){var p=C.TILE_PROPERTIES.sb_metadata;var K=this.getODataModelByServiceUriFromChipAPI(this.getRunTimeUri(p),T);var d="ID eq '#EVALUATIONID'".replace("#EVALUATIONID",C.EVALUATION.ID);var k=K.read("/EVALUATION_FILTERS",null,{"$filter":d},true,function(h){var i=[];if(h.results.length){i=h.results;}s.call(this,i);},e);return k;},_getOData4AnalyticsObject:function(u){var m=null;if(u instanceof O){m=u;}else if(typeof u==="string"){m=this.getODataModelByServiceUri(u);}else{throw new Error("Invalid Input to Create ODataModel Object : "+u);}var d=new M(R(m));return d;},findTextPropertyForDimension:function(u,d,h){try{var i=this._getOData4AnalyticsObject(u);var j=i.findQueryResultByName(d);var D=j.findDimensionByName(h);if(D.getTextProperty()){return D.getTextProperty().name;}return h;}catch(e){L.error("Error Fetching Text Property for "+h+" : "+e.toString());}},getEvalValueMeasureName:function(C,d,r){var e=C.EVALUATION_VALUES;for(var i=0;i<e.length;i++){if(e[i].TYPE==d){if(r==="FIXED"){return e[i].FIXED;}return e[i].COLUMN_NAME;}}},getSemanticColorName:function(d){var s="";if(d=="Error"){s="sb.error";}if(d=="Neutral"){s="sb.neutral";}if(d=="Critical"){s="sb.critical";}if(d=="Good"){s="sb.good";}return s;},setTooltipInTile:function(C,d,v){var e="";var r=sap.ushell.components.tiles.utils.getResourceBundleModel().getResourceBundle();if(d=="NT"||d=="DT"){if(v.status){e+=r.getText("sb.status")+": "+r.getText(v.status)+"\n";}if(v.actual){e+=r.getText("sb.actual")+": "+v.actual+"\n";}if(v.target){e+=r.getText("sb.target")+": "+v.target+"\n";}if(v.cH){e+=r.getText("sb.ch")+": "+v.cH+"\n";}if(v.wH){e+=r.getText("sb.wh")+": "+v.wH+"\n";}if(v.wL){e+=r.getText("sb.wl")+": "+v.wL+"\n";}if(v.cL){e+=r.getText("sb.cl")+": "+v.cL+"\n";}}if(d=="CONT"||d=="COMP"){if(v.measure&&d=="CONT"){if(v&&v.contributionTile.contributionTile&&v.contributionTile.contributionTile[1]==="asc"){e+=r.getText("sb.bottomn")+": "+v.contributionTile[0]+"\n";}else if(v&&v.contributionTile.contributionTile&&v.contributionTile.contributionTile.length){e+=r.getText("sb.topn")+": "+v.contributionTile[0]+"\n";}}if(v.m1&&((v.v1==undefined||v.v1==null)?false:v.v1.toString())&&v.c1){e+=v.m1+": "+v.v1+" "+r.getText(v.c1)+"\n";}if(v.m2&&((v.v2==undefined||v.v2==null)?false:v.v2.toString())&&v.c2){e+=v.m2+": "+v.v2+" "+r.getText(v.c2)+"\n";}if(v.m3&&((v.v3==undefined||v.v3==null)?false:v.v3.toString())&&v.c3){e+=v.m3+": "+v.v3+" "+r.getText(v.c3)+"\n";}}if(C&&C.setTooltip){C.setTooltip(e);}},_getFormattedTileProperties:function(d){d=d||{};var p=["sb_metadata","sb_navigation","sb_catalog"];var e=false;for(var i=0;!e&&i<p.length;i++){e=e||new U(window.location.href).get(p[i])||d[p[i]];}d.sb_metadata=(new U(window.location.href).get("sb_metadata")||d.sb_metadata||"HANA").toLowerCase();d.sb_navigation=(new U(window.location.href).get("sb_navigation")||d.sb_navigation||"abap").toLowerCase();d.sb_catalog=(new U(window.location.href).get("sb_catalog")||d.sb_catalog||"HANA").toLowerCase();d.isPlatformInfoPresent=e;return d;},getEvaluationDetailsFromRunTimeService:function(e,p,i,d){var K=this.getODataModelByServiceUri(this.getRunTimeUri(p));var h="ID eq '#EVALUATIONID'".replace("#EVALUATIONID",i);K.read(e,null,{"$filter":h},true,function(j){var k=[];if(j.results.length){k=j.results;}d.call(this,k);});},getParsedChip:function(C,i,d){try{var p={};var e=JSON.parse(C);var h=JSON.parse(e.TILE_PROPERTIES).evaluationId||"";if(e.TILE_PROPERTIES){var j=JSON.parse(e.TILE_PROPERTIES);if(j&&(j.instanceId||j.catalogId)){return false;}}var k=this;if(e.blankTile){p.BLANKTILE=e.blankTile;}if(e.cachingTime){p.CACHINGTIME=e.cachingTime;}if(e.cachingTimeUnit){p.CACHINGUNIT=e.cachingTimeUnit;}if(e.TAGS){p.TAGS=JSON.parse(e.TAGS);}if(e.ADDITIONAL_FILTERS){p.ADDITIONAL_FILTERS=JSON.parse(e.ADDITIONAL_FILTERS);}if(e.ADDITIONAL_APP_PARAMETERS){p.ADDITIONAL_APP_PARAMETERS=JSON.parse(e.ADDITIONAL_APP_PARAMETERS);}p.TILE_PROPERTIES=this._getFormattedTileProperties(JSON.parse(e.TILE_PROPERTIES));var s=p.TILE_PROPERTIES.sb_metadata;if(e.EVALUATION_FILTERS){p.EVALUATION_FILTERS=JSON.parse(e.EVALUATION_FILTERS);if(e.EVALUATION_VALUES){p.EVALUATION_VALUES=JSON.parse(e.EVALUATION_VALUES);if(e.EVALUATION){p.EVALUATION=JSON.parse(e.EVALUATION);if(d){d(p);}else{return p;}}else if(!i){k.getEvaluationDetailsFromRunTimeService("/EVALUATIONS",s,h,function(m){p.EVALUATION=m;if(d){d(p);}else{return p;}});}else if(d){d(p);}else{return p;}}else if(!i){k.getEvaluationDetailsFromRunTimeService("/EVALUATION_VALUES",s,h,function(m){p.EVALUATION_VALUES=m;if(e.EVALUATION){p.EVALUATION=JSON.parse(e.EVALUATION);if(d){d(p);}else{return p;}}else{k.getEvaluationDetailsFromRunTimeService("/EVALUATIONS",s,h,function(m){p.EVALUATION=m;if(d){d(p);}else{return p;}});}});}else if(d){d(p);}else{return p;}}else if(i){if(d){d(p);}else{return p;}}else{k.getEvaluationDetailsFromRunTimeService("/EVALUATION_FILTERS",s,h,function(m){p.EVALUATION_FILTERS=m;if(e.EVALUATION_VALUES){p.EVALUATION_VALUES=JSON.parse(e.EVALUATION_VALUES);if(e.EVALUATION){p.EVALUATION=JSON.parse(e.EVALUATION);if(d){d(p);}else{return p;}}else{k.getEvaluationDetailsFromRunTimeService("/EVALUATIONS",s,h,function(m){p.EVALUATION=m;if(d){d(p);}else{return p;}});}}else{k.getEvaluationDetailsFromRunTimeService("/EVALUATION_VALUES",s,h,function(m){p.EVALUATION_VALUES=m;if(e.EVALUATION){p.EVALUATION=JSON.parse(e.EVALUATION);if(d){d(p);}else{return p;}}else{k.getEvaluationDetailsFromRunTimeService("/EVALUATIONS",s,h,function(m){p.EVALUATION=m;if(d){d(p);}else{return p;}});}});}});}}catch(l){return false;}},getNavigationTarget:function(C,s){var d=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getServiceAsync;var e=d&&d("CrossApplicationNavigation").then(function(){var h;var p={};p.evaluationId=C.EVALUATION.ID;p.chipId=C.TILE_PROPERTIES.id;if(s){p["sap-system"]=s;}p.tileType=C.TILE_PROPERTIES.tileType;if(C.TILE_PROPERTIES.dimension){p.dimension=C.TILE_PROPERTIES.dimension;}if(C.TILE_PROPERTIES.storyId){p.storyId=C.TILE_PROPERTIES.storyId;}if(C.TILE_PROPERTIES.apfConfId){p["sap-apf-configuration-id"]=C.TILE_PROPERTIES.apfConfId;}if(C.TILE_PROPERTIES.isPlatformInfoPresent){p.sb_metadata=C.TILE_PROPERTIES.sb_metadata;p.sb_navigation=C.TILE_PROPERTIES.sb_navigation;p.sb_catalog=C.TILE_PROPERTIES.sb_catalog;}if(C.ADDITIONAL_APP_PARAMETERS){for(h in C.ADDITIONAL_APP_PARAMETERS){if(C.ADDITIONAL_APP_PARAMETERS.hasOwnProperty(h)){if(C.ADDITIONAL_APP_PARAMETERS[h].constructor==Array){var k=C.ADDITIONAL_APP_PARAMETERS[h];for(var i=0;i<k.length;i++){p[h]=k[i];}}else{p[h]=C.ADDITIONAL_APP_PARAMETERS[h];}}}}var l=e&&e.hrefForExternal({target:{semanticObject:C.TILE_PROPERTIES.semanticObject,action:C.TILE_PROPERTIES.semanticAction},params:p})||"";if(C.ADDITIONAL_FILTERS){var m=C.ADDITIONAL_FILTERS;var n="&";for(var j=0;j<m.length;j++){if(m[j].OPERATOR==="EQ"){n=n+"/"+m[j].NAME+"="+m[j].VALUE_1;}}l+=n;}return l;});},getChipTitle:function(C){var d="";if(C){var e=C.EVALUATION||{};d=e.INDICATOR_TITLE||"";}return d;},getstringifyTileConfig:function(C){var s={};s.EVALUATION=JSON.stringify(C.EVALUATION);s.EVALUATION_FILTERS=JSON.stringify(C.EVALUATION_FILTERS);s.EVALUATION_VALUES=JSON.stringify(C.EVALUATION_VALUES);s.TILE_PROPERTIES=JSON.stringify(C.TILE_PROPERTIES);return JSON.stringify(s);},getChipSubTitle:function(C){var T="";if(C){var d=C.EVALUATION||{};T=d.TITLE||"";}return T;},getAllMeasures:function(u,d){var m=[];try{var h=this._getOData4AnalyticsObject(u);var i=h.findQueryResultByName(d);m=i.getAllMeasureNames();}catch(e){L.error("Error Fetching All Measures : "+e.toString());}return m;},getFormattingMetadata:function(u,e,p){var d={};d._hasCurrency=false;d._hasSapText=false;var m=null;if(u instanceof O){m=R(u);}else{var h=this.getODataModelByServiceUri(u);m=R(h);}var j=new M(m);var k=j.findQueryResultByName(e);var l=k.getAllMeasures();if(l[p]){var s=(l[p]._oTextProperty&&l[p]._oTextProperty.name)?l[p]._oTextProperty.name:"";if(s!=""){d._hasSapText=true;d._sapTextColumn=s;}else if(l[p].hasOwnProperty("_oUnitProperty")){var n=l[p]._oUnitProperty.extensions;for(var i=0;i<l[p]._oUnitProperty.extensions.length;i++){if(n[i].name==="semantics"&&n[i].value==="currency-code"){d._hasCurrency=true;d._currencyColumn=l[p]._oUnitProperty.name;}}}}return d;},getAllDimensions:function(u,d){function i(n,p){var r=0,s=0;var v=[];while(r<n.length&&s<p.length){if(n[r]<p[s]){r++;}else if(n[r]>p[s]){s++;}else{v.push(n[r]);r++;s++;}}return v;}var h=[];var j=[];try{var k=this._getOData4AnalyticsObject(u);var l=k.findQueryResultByName(d);var m=l.getEntityType();j=m.getFilterablePropertyNames();h=l.getAllDimensionNames();if(j&&j.length){h=i(j.sort(),h.sort());}}catch(e){L.error("Error Fetching All Dimesions : "+e.toString());}return h;},prepareQueryServiceUri:function(u,d,m,h,v,n,p){function _(e1){return e1.replace(/'/g,"''");}var r=null;var s=function(){};var w=function(){};try{var x=null;if(u instanceof O){x=R(u);}else{var A=this.getODataModelByServiceUri(u);x=R(A);}var B=new M(x);var C=B.findQueryResultByName(d);var D=new Q(C);if(m){D.setMeasures(m.split(","));D.includeMeasureRawFormattedValueUnit(null,true,true,true);}if(h){if(typeof h==="string"){r=h;r=r.split(",");}for(var i=0;i<r.length;i++){D.addToAggregationLevel([r[i]]);var E=C.getAllDimensions();if(E[r[i]].getTextProperty()!=null){D.includeDimensionKeyTextAttributes([r[i]],true,true,null);}}}if(v&&v.length){var G=[];var H=[];var l;for(i=0,l=v.length;i<l;i++){var I=v[i];if(I.type==="PA"){H.push(I);}else if(I.type==="FI"){G.push(I);}}s=function(e1){var f1=e1.toJSON();var g1=f1.charAt(f1.length-1).toUpperCase();if(g1.charCodeAt(0)>=65&&g1.charCodeAt(0)<=90){f1=f1.slice(0,-1);}return f1;};w=function(e1){if(e1){try{if(e1==+e1){e1=window.parseInt(e1);}var f1=new Date(e1);var g1=f1.getTime();if(isNaN(g1)){return e1;}return s(f1);}catch(e){}}return e1;};if(G.length){var J=D.getFilterExpression();for(i=0,l=G.length;i<l;i++){I=G[i];if(this.getEdmType(u,I.filterPropertyName)=="Edm.DateTime"){I.value=w(I.value);I.valueTo=w(I.valueTo);}if(I.comparator==F.BT){J.addCondition(I.filterPropertyName,I.comparator,_(I.value),I.valueTo);}else{var K=I.value.split(",");for(var j=0,k=K.length;j<k;j++){J.addCondition(I.filterPropertyName,I.comparator,_(K[j].replace(/\^\|/g,",")),null);}}}}if(H.length){if(C.getParameterization()){var S=new P(C.getParameterization());var T=C.getParameterization();var V,W,X,Y,Z;for(var y=0,z=H.length;y<z;y++){V=H[y];W=T.findParameterByName(V.filterPropertyName);if(W.isIntervalBoundary()===true&&W.isLowerIntervalBoundary()===true){Z=W.getPeerIntervalBoundaryParameter();for(i=0,l=H.length;i<l;i++){if(H[i].filterPropertyName===Z.getName()){Y=_(H[i].value);break;}}X=_(V.value);if(Y){S.setParameterValue(V.filterPropertyName,X,Y);}}else if(W.isIntervalBoundary()===true&&W.isLowerIntervalBoundary()===false){L.info("Future development");}else{S.setParameterValue(V.filterPropertyName,_(V.value));}}D.setParameterizationRequest(S);}}}var a1=D.getURIToQueryResultEntries();if(n&&n.length){a1=a1+"&$orderby=";for(y=0,z=n.length;y<z;y++){var b1=n[y].sortOrder||"asc";if(b1){a1+=n[y].element+" "+b1+",";}}a1=a1.slice(0,a1.length-1);}if(p){a1=a1+"&$top="+p;}var c1=C.getAllMeasures();var d1=[];for(i=0;i<m.split(",").length;i++){d1.push(c1[m.split(",")[i]].getUnitProperty());}return{uri:a1,model:B.getODataModel(),unit:d1};}catch(e){L.error("Error Preparing Query Service Uri using OData4Analytics Library : "+e.toString());if(arguments.length){L.error("Arguments Passed to this function");L.error(arguments[0]+","+arguments[1]+","+arguments[2]+","+arguments[3]);}else{L.error("NO Arguments passed to this function");}return null;}},getAllEntitySet:function(u){var d=[];try{var h=this._getOData4AnalyticsObject(u);d=h.getAllQueryResultNames();}catch(e){L.error("Error fetching Enity Set : "+e.toString());}return d;},getAllMeasuresWithLabelText:function(u,d){var m=[];try{var h=this._getOData4AnalyticsObject(u);var j=h.findQueryResultByName(d);var k=j.getAllMeasureNames();for(var i=0;i<k.length;i++){var l=k[i];g.oMeasure=j.findMeasureByName(l);m.push({key:l,value:oMeasure.getLabelText()});}}catch(e){L.error("Error Fetching All Measures : "+e.toString());}return m;},getAllDimensionsWithLabelText:function(u,d){var h=[];try{var j=this._getOData4AnalyticsObject(u);var k=j.findQueryResultByName(d);var l=k.getAllDimensionNames();for(var i=0;i<l.length;i++){var m=l[i];var D=k.findDimensionByName(m);var n=null;if(D.getTextProperty()!=null){n=D.getTextProperty().name;}h.push({key:m,value:D.getLabelText(),textProperty:n});}}catch(e){L.error("Error Fetching All Dimesions : "+e.toString());}return h;},getAllInputParams:function(u,d){var i=[];try{var h=this._getOData4AnalyticsObject(u);var j=h.findQueryResultByName(d);if(j.getParameterization()){var p=j.getParameterization();i=p.getAllParameterNames();}}catch(e){L.error("Error Fetching Input Params : "+e.toString());}return i;},getAllInputParamsWithFlag:function(u,d){var h=[];try{var j=this._getOData4AnalyticsObject(u);var k=j.findQueryResultByName(d);if(k.getParameterization()){var p=k.getParameterization();var l=p.getAllParameterNames();for(var i=0;i<l.length;i++){var m=l[i];var n=p.findParameterByName(m);h.push({name:m,optional:n.isOptional()});}}}catch(e){L.error("Error Fetching Input Params : "+e.toString());}return h;},formatOdataObjectToString:function(v){if(v&&v.constructor==Object){if(v.__edmType=="Edm.Time"){var m=v.ms;var s=Math.floor((m/1000)%60);var d=Math.floor((m/60000)%60);var h=Math.floor((m/3600000)%24);return h+"H"+d+"M"+s+"S";}}return v;},generateCombinations:function(d){function e(j,s){while(s.length<j){s="0"+s;}return s;}var m=Math.pow(2,d.length);var r=[];var h=0;while(m>1){var s=(m-1).toString(2);s=e(d.length,s);r[h]=[];for(var i=0;i<s.length;i++){if(Number(s[i])){r[h].push(d[i]);}}m--;h++;}return r;},logError:function(e,C){if(e=="no data"&&C){var r=sap.ushell.components.tiles.utils.getResourceBundleModel().getResourceBundle();C.setFailedText(r.getText("sb.noData"));}L.error(e.toString());},numberOfLeadingZeros:function(n){n=String(n);var d=0;var e=n.indexOf(".");if(e==-1){return 0;}if(Number(n.split(".")[0])!=0){return 0;}var i=e+1;while(n[i++]=="0"){++d;}return d;},formatValue:function(v,s,d){d=d||3;var u={3:"K",6:"M",9:"B",12:"T",0:""};u["-3"]="m";u["-6"]="u";u["-9"]="n";u["-12"]="t";u["-2"]="%";var e,p,h;e=Number(v).toPrecision(d);var z=this.numberOfLeadingZeros(e);if(z>0&&s<0){p=e*Math.pow(10,z+d);h=-(z+d);}else{p=Number(e.split("e")[0]);h=Number(e.split("e")[1])||0;}if(!v&&v!=0){return{value:"",unitPrefix:""};}if(s>=0){if(h%3!=0){if(h%3==2){if(h+1==s){h=h+1;p=p/10;}else{h=h-2;p=p*100;}}else if(h+2==s){h=h+2;p=p/100;}else{h--;p=p*10;}}else if(h==15){p=p*1000;h=12;}}else if(s=="-2"){var x=this.formatValue((v*100),0);}else if(h>=0&&v<10&&s=="-3"){p=v*Math.pow(10,3);h=-3;}else if(h>=0){return this.formatValue(v,0);}else{h=Math.abs(h);s=Math.abs(s);if(s>h){p=p/(Math.pow(10,h%3));h=h-(h%3);}else{var i=h-s;p=p/(Math.pow(10,i));h=h-i;}h=0-h;}p+="";if(s=="-2"){var j=(x.unitPrefix=="")?Number(x.value+"").toFixed(4-(x.value+"").indexOf(".")):Number(x.value+"").toFixed(3-(x.value+"").indexOf("."));return{value:Number(j),unitPrefix:(x.unitPrefix)+u[-2]};}p=Number(p).toFixed(4-p.indexOf("."));return{value:Number(p),unitPrefix:u[h]};},isSmartbusinessChipAndCachable:function(d){var C=this.getParsedChip(d&&d.getConfigurationParameter("tileConfiguration"));return(C&&C.TILE_PROPERTIES&&C.TILE_PROPERTIES.tileType&&this.getCachingTime(C));},getHanaClient:function(){var e;var h=function(d,s,x){e=d.sessionClient;sap.ushell.components.tiles.indicatorTileUtils.cache.setCacheHanaClient(e);sap.ushell.components.tiles.indicatorTileUtils.util.HANA_CLIENT_DEFERRED.resolve(e);};var i=function(d,l,m){L.error(d.responseText);L.error("session client call failed");sap.ushell.components.tiles.indicatorTileUtils.cache.setCacheHanaClient(null);sap.ushell.components.tiles.indicatorTileUtils.util.HANA_CLIENT_DEFERRED.reject();};var j=sap.ushell.components.tiles.indicatorTileUtils.util.HANA_CLIENT_DEFERRED||q.Deferred();var k=sap.ushell.components.tiles.indicatorTileUtils.cache.getCacheHanaClient();if(k!=undefined){e=k;sap.ushell.components.tiles.indicatorTileUtils.util.HANA_CLIENT_DEFERRED.resolve(e);}else if(sap.ushell.components.tiles.indicatorTileUtils.util.HANA_CLIENT_DEFERRED){return sap.ushell.components.tiles.indicatorTileUtils.util.HANA_CLIENT_DEFERRED.promise();}else{sap.ushell.components.tiles.indicatorTileUtils.util.HANA_CLIENT_DEFERRED=j;q.ajax({type:"GET",async:false,dataType:"json",url:"/sap/hba/r/sb/core/logic/GetSessionClient.xsjs",success:h,error:i});}return sap.ushell.components.tiles.indicatorTileUtils.util.HANA_CLIENT_DEFERRED.promise();},abortPendingODataCalls:function(d){try{if(d){d.abort();}}catch(e){this.logError(e);}}};})(window,q);sap.ushell.components.tiles.indicatorTileUtils.cache=(function(){var B={};var K={};var s="HANA_CLIENT";return{getCacheHanaClient:function(){return B[s];},setCacheHanaClient:function(d){B[s]=d;},getEvaluationByChipId:function(k){if(B[k]){return B[k];}return null;},getEvaluationById:function(k){return this.getEvaluationByChipId(k);},setEvaluationById:function(k,d){B[k]=d;},getFrontEndCacheDeferredObject:function(k){if(B[k]){return B[k];}return null;},setFrontEndCacheDefferedObject:function(k,d){B[k]=d;},getKpivalueById:function(k){if(K[k]){return K[k];}return null;},setKpivalueById:function(k,d){K[k]=d;}};})();return{};},true);
