// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ushell/components/tiles/utils","sap/ushell/components/tiles/utilsRT","sap/ushell/components/applicationIntegration/AppLifeCycle","sap/ushell/Config","sap/ushell/utils/WindowUtils","sap/m/library","sap/ushell/library","sap/ui/model/json/JSONModel","sap/base/Log","sap/ui/thirdparty/jquery","sap/ushell/utils/UrlParsing"],function(C,u,a,A,b,W,m,c,J,L,q,U){"use strict";var G=m.GenericTileScope;var d=m.GenericTileMode;var e=c.AppType;C.extend("sap.ushell.components.tiles.applauncher.StaticTile",{_aDoableObject:{},onInit:function(){var s=this.getView(),v=s.getViewData(),t=v.chip,o=a.getConfiguration(t,t.configurationUi.isEnabled(),false),M,k,K,f=this,N=o.navigation_target_url,S,h;this.oShellModel=A.getElementsModel();S=t.url.getApplicationSystem();if(S){if(U.isIntentUrl(N)){h=U.parseShellHash(N);if(!h.params){h.params={};}h.params["sap-system"]=S;N="#"+U.constructShellHash(h);}else{N+=((N.indexOf("?")<0)?"?":"&")+"sap-system="+S;}}this.navigationTargetUrl=N;M=new J({sizeBehavior:b.last("/core/home/sizeBehavior"),wrappingType:b.last("/core/home/wrappingType"),mode:o.display_mode,config:o,nav:{navigation_target_url:(t.configurationUi&&t.configurationUi.isEnabled()?"":N)},search:{display_highlight_terms:[]}});s.setModel(M);this._aDoableObject=b.on("/core/home/sizeBehavior").do(function(j){M.setProperty("/sizeBehavior",j);});if(t.types){t.types.attachSetType(function(T){if(f.tileType!==T){if(T==="link"){M.setProperty("/mode",d.LineMode);}else{M.setProperty("/mode",M.getProperty("/config/display_mode"));}f.tileType=T;}});}if(!this.tileType){this.tileType="tile";}if(t.search){k=s.getModel().getProperty("/config/display_search_keywords");K=k.split(/[, ]+/).filter(function(n){return n&&n!=="";});if(o.display_title_text&&o.display_title_text!==""&&K.indexOf(o.display_title_text)===-1){K.push(o.display_title_text);}if(o.display_subtitle_text&&o.display_subtitle_text!==""&&K.indexOf(o.display_subtitle_text)===-1){K.push(o.display_subtitle_text);}if(o.display_info_text&&o.display_info_text!==""&&K.indexOf(o.display_info_text)===-1){K.push(o.display_info_text);}t.search.setKeywords(K);t.search.attachHighlight(function(H){s.getModel().setProperty("/search/display_highlight_terms",H);});}if(t.bag&&t.bag.attachBagsUpdated){t.bag.attachBagsUpdated(function(j){if(j.indexOf("tileProperties")>-1){u._updateTilePropertiesTexts(s,t.bag.getBag("tileProperties"));}});}if(t.configuration&&t.configuration.attachConfigurationUpdated){t.configuration.attachConfigurationUpdated(function(j){if(j.indexOf("tileConfiguration")>-1){u._updateTileConfiguration(s,t.configuration.getParameterValueAsString("tileConfiguration"));}});}if(t.preview){t.preview.setTargetUrl(N);t.preview.setPreviewIcon(o.display_icon_url);t.preview.setPreviewTitle(o.display_title_text);if(t.preview.setPreviewSubtitle&&typeof t.preview.setPreviewSubtitle==="function"){t.preview.setPreviewSubtitle(o.display_subtitle_text);}}if(t.configurationUi.isEnabled()){t.configurationUi.setUiProvider(function(){var j=u.getConfigurationUi(s,"sap.ushell.components.tiles.applauncher.Configuration");t.configurationUi.attachCancel(f.onCancelConfiguration.bind(null,j));t.configurationUi.attachSave(f.onSaveConfiguration.bind(null,j));return j;});this.getView().getContent()[0].setTooltip(u.getResourceBundleModel().getResourceBundle().getText("edit_configuration.tooltip"));}if(t.actions){var g=o.actions,E;if(g){E=g.slice();}else{E=[];}if(b.last("/core/shell/enablePersonalization")){var T=M.getProperty("/mode")===d.LineMode?"link":"tile",i=a.getTileSettingsAction(M,this.onSaveRuntimeSettings.bind(this),T);E.push(i);}t.actions.setActionsProvider(function(){return E;});}},onExit:function(){this._aDoableObject.off();},onPress:function(E){var s=this.getView(),v=s.getViewData(),t=v.chip,T=s.getModel().getProperty("/config");if(E.getSource().getScope&&E.getSource().getScope()===G.Display){if(t.configurationUi.isEnabled()){t.configurationUi.display();}else if(this.navigationTargetUrl){if(this.navigationTargetUrl[0]==="#"){hasher.setHash(this.navigationTargetUrl);}else{var l=b.last("/core/shell/enableRecentActivity")&&b.last("/core/shell/enableRecentActivityLogging");if(l){var r={title:T.display_title_text,appType:e.URL,url:T.navigation_target_url,appId:T.navigation_target_url};sap.ushell.Container.getRenderer("fiori2").logRecentActivity(r);}W.openURL(this.navigationTargetUrl,"_blank");}}}},onSaveRuntimeSettings:function(s){var v=s.getModel(),t=this.getView().getViewData().chip,o=this.getView().getModel().getProperty("/config");o.display_title_text=v.getProperty("/title")||"";o.display_subtitle_text=v.getProperty("/subtitle")||"";o.display_info_text=v.getProperty("/info")||"";o.display_search_keywords=v.getProperty("/keywords")||"";var f=t.bag.getBag("tileProperties");f.setText("display_title_text",o.display_title_text);f.setText("display_subtitle_text",o.display_subtitle_text);f.setText("display_info_text",o.display_info_text);f.setText("display_search_keywords",o.display_search_keywords);function l(E){L.error(E,null,"sap.ushell.components.tiles.applauncher.StaticTile.controller");}f.save(function(){L.debug("property bag 'tileProperties' saved successfully");this.getView().getModel().setProperty("/config/display_title_text",o.display_title_text);this.getView().getModel().setProperty("/config/display_subtitle_text",o.display_subtitle_text);this.getView().getModel().setProperty("/config/display_info_text",o.display_info_text);this.getView().getModel().setProperty("/config/display_search_keywords",o.display_search_keywords);this.getView().getModel().refresh();}.bind(this),l);},onSaveConfiguration:function(o){var D=new q.Deferred();var M=o.getModel();var t=M.getProperty("/tileModel");var T=o.getViewData().chip;var f=u.tileActionsRows2TileActionsArray(M.getProperty("/config/tile_actions_rows"));var g={display_icon_url:M.getProperty("/config/display_icon_url"),navigation_use_semantic_object:M.getProperty("/config/navigation_use_semantic_object"),navigation_target_url:M.getProperty("/config/navigation_target_url"),navigation_semantic_object:q.trim(M.getProperty("/config/navigation_semantic_object"))||"",navigation_semantic_action:q.trim(M.getProperty("/config/navigation_semantic_action"))||"",navigation_semantic_parameters:q.trim(M.getProperty("/config/navigation_semantic_parameters")),display_search_keywords:M.getProperty("/config/display_search_keywords")};var r=u.checkInputOnSaveConfig(o);if(!r){r=u.checkTileActions(o);}if(r){D.reject("mandatory_fields_missing");return D.promise();}if(g.navigation_use_semantic_object){g.navigation_target_url=a.getSemanticNavigationUrl(g);M.setProperty("/config/navigation_target_url",g.navigation_target_url);}var h=T.bag.getBag("tileProperties");h.setText("display_title_text",M.getProperty("/config/display_title_text"));h.setText("display_subtitle_text",M.getProperty("/config/display_subtitle_text"));h.setText("display_info_text",M.getProperty("/config/display_info_text"));h.setText("display_search_keywords",g.display_search_keywords);var i=T.bag.getBag("tileNavigationActions");u.populateTileNavigationActionsBag(i,f);function l(E,j){L.error(E,null,"sap.ushell.components.tiles.applauncher.StaticTile.controller");D.reject(E,j);}T.writeConfiguration.setParameterValues({tileConfiguration:JSON.stringify(g)},function(){var j=a.getConfiguration(T,false,false),k=a.getConfiguration(T,true,false),M=new J({config:j,nav:{navigation_target_url:""},tileModel:t});o.setModel(M);t.setData({config:k,nav:{navigation_target_url:""}},false);if(T.preview){T.preview.setTargetUrl(j.navigation_target_url);T.preview.setPreviewIcon(j.display_icon_url);T.preview.setPreviewTitle(j.display_title_text);if(T.preview.setPreviewSubtitle&&typeof T.preview.setPreviewSubtitle==="function"){T.preview.setPreviewSubtitle(j.display_subtitle_text);}}h.save(function(){L.debug("property bag 'tileProperties' saved successfully");if(T.title){T.title.setTitle(j.display_title_text,function(){D.resolve();},l);}else{D.resolve();}},l);i.save(function(){L.debug("property bag 'navigationProperties' saved successfully");},l);},l);return D.promise();},onCancelConfiguration:function(o){var v=o.getViewData(),M=o.getModel(),t=M.getProperty("/tileModel"),T=v.chip,f=a.getConfiguration(T,T.configurationUi.isEnabled(),false);o.getModel().setData({config:f,nav:{navigation_target_url:""},tileModel:t},false);},formatters:{leanURL:W.getLeanURL.bind(W)}});},false);
