// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/m/Button","sap/m/library","sap/m/Text","sap/ui/core/Control","sap/ui/core/dnd/DragDropInfo","sap/ui/core/InvisibleMessage","sap/ui/core/library","sap/ushell/library","sap/ushell/resources","sap/ushell/ui/launchpad/ExtendedChangeDetection","./PageRenderer"],function(B,l,T,C,D,I,c,u,r,E,P){"use strict";var a=l.ButtonType;var b=c.TextAlign;var d=c.InvisibleMessageMode;var e=u.DisplayFormat;var f=C.extend("sap.ushell.ui.launchpad.Page",{metadata:{library:"sap.ushell",properties:{edit:{type:"boolean",group:"Misc",defaultValue:false},enableSectionReordering:{type:"boolean",group:"Misc",defaultValue:false},dataHelpId:{type:"string",group:"Misc",defaultValue:""},noSectionsText:{type:"string",group:"Misc",defaultValue:""},showNoSectionsText:{type:"boolean",group:"Misc",defaultValue:true},showTitle:{type:"boolean",group:"Misc",defaultValue:false},title:{type:"string",group:"Misc",defaultValue:""}},defaultAggregation:"sections",aggregations:{sections:{type:"sap.ushell.ui.launchpad.Section",multiple:true,dnd:true},messageStrip:{type:"sap.m.MessageStrip",multiple:false},_addSectionButtons:{type:"sap.m.Button",multiple:true,visibility:"hidden"},_noSectionText:{type:"sap.m.Text",multiple:false,visibility:"hidden"}},events:{addSectionButtonPressed:{parameters:{index:{type:"int"}}},sectionDrop:{parameters:{draggedControl:{type:"sap.ushell.ui.launchpad.Section"},droppedControl:{type:"sap.ushell.ui.launchpad.Section"},dropPosition:{type:"string"}}}}},renderer:P});f.prototype.enhanceAccessibilityState=function(o,A){delete A.readonly;};f.prototype.init=function(){this.setAggregation("_noSectionText",new T({text:r.i18n.getText("Page.NoSectionText"),width:"100%",textAlign:b.Center}));this._oDragDropInfo=new D({sourceAggregation:"sections",targetAggregation:"sections",dropPosition:"Between",dragStart:function(o){if(o.getParameter("target").getDefault()){o.preventDefault();}},dragEnter:function(o){if(o.getParameter("target").getDefault()){o.preventDefault();}},drop:function(i){this.fireSectionDrop(i.getParameters());}.bind(this)});this.addDelegate({onsappageup:this._handleKeyboardPageNavigation.bind(this),onsappagedown:this._handleKeyboardPageNavigation.bind(this),onsapdown:this._handleKeyboardArrowNavigation.bind(this,false),onsapdownmodifiers:this._handleKeyboardArrowNavigation.bind(this,true),onsapup:this._handleKeyboardArrowNavigation.bind(this,false),onsapupmodifiers:this._handleKeyboardArrowNavigation.bind(this,true),onsaphome:this._handleKeyboardHomeEndNavigation.bind(this),onsaphomemodifiers:this._handleKeyboardHomeEndNavigation.bind(this),onsapend:this._handleKeyboardHomeEndNavigation.bind(this),onsapendmodifiers:this._handleKeyboardHomeEndNavigation.bind(this),onfocusin:this._saveFocus.bind(this),onsapskipback:this._handleSkipBack.bind(this),onsapskipforward:this._handleSkipForward.bind(this),onBeforeFastNavigationFocus:this._handleBeforeFastNavigationFocus.bind(this)});this._oSectionsChangeDetection=new E("sections",this);this._oSectionsChangeDetection.attachItemDeleted(this.invalidate,this);this._oSectionsChangeDetection.attachItemsReordered(this.invalidate,this);this._oInvisibleMessageInstance=I.getInstance();};f.prototype._saveFocus=function(o){var s=o.srcControl;if(s.isA("sap.m.VBox")){var S=s.getParent();if(S){if(S.indexOfVisualization(this._oLastFocusedViz)===-1){this._oLastFocusedViz=S.getVisualizations()[0];this._oLastFocusedSection=this._oLastFocusedViz?undefined:S;}}else{this._oLastFocusedViz=undefined;this._oLastFocusedSection=undefined;}}else if(s.isA("sap.f.GridContainer")){var g=s.getItems();this._oLastFocusedViz=g.find(function(h){var i=h.getDomRef();return i&&i.parentNode===o.target;});}else if(s.isA("sap.ushell.ui.launchpad.VizInstanceLink")){this._oLastFocusedViz=s;}};f.prototype._handleSkipBack=function(o){if(this.getEdit()){var t;var s=o.srcControl;if(s.isA("sap.f.GridContainer")||s.isA("sap.ushell.ui.launchpad.VizInstanceLink")){t=this._getAncestorSection(s);}if(t){o.preventDefault();t.focus();}}};f.prototype._handleSkipForward=function(o){var t,s;var S=o.srcControl;if(S.isA("sap.m.VBox")){s=S.getParent();}if(s){if(s.indexOfVisualization(this._oLastFocusedViz)!==-1){t=this._oLastFocusedViz;}else{t=s.getAllItems()[0];}}if(t){o.preventDefault();this._focusVisualization(t);}};f.prototype._handleBeforeFastNavigationFocus=function(o){var s=this.getSections();var g=this.getEdit();if(g&&this._oLastFocusedSection){this._oLastFocusedSection.focus();}else if(g&&o.forward&&this._oLastFocusedViz){this._getAncestorSection(this._oLastFocusedViz).focus();}else if(this._oLastFocusedViz&&this._oLastFocusedViz.getDomRef()){this._focusVisualization(this._oLastFocusedViz);}else if(g&&o.forward&&s.length>0){this._getFirstVisibleSection().focus();}else if(g&&!o.forward&&s.length>0){var F=s[0];if(F.getAllItems().length===0){F.focus();}else{this._focusVisualization(F.getAllItems()[0]);}}else{var S=s.find(function(h){return h.getDomRef()&&h.getAllItems().length>0;});this._focusVisualization(S.getAllItems()[0]);}o.preventDefault();};f.prototype._getAncestorSection=function(o){if(!o){return null;}if(o.isA("sap.ushell.ui.launchpad.Section")){return o;}else if(o.getParent){return this._getAncestorSection(o.getParent());}return null;};f.prototype.exit=function(){this._oDragDropInfo.destroy();this._oSectionsChangeDetection.destroy();};f.prototype.onBeforeRendering=function(){var n=this.getSections().length;var A=this.getAggregation("_addSectionButtons")||[];var o;for(var i=A.length;i<n+1;i++){o=new B({type:a.Transparent,icon:"sap-icon://add",text:r.i18n.getText("Page.Button.AddSection"),press:this.fireAddSectionButtonPressed.bind(this,{index:i})});o.addStyleClass("sapUshellPageAddSectionButton");this.addAggregation("_addSectionButtons",o);}};f.prototype.getFocusDomRef=function(){var A=this.getAggregation("_addSectionButtons")||[];if(!this.getSections().length&&A.length&&this.getEdit()){return A[0].getFocusDomRef();}return this.getDomRef();};f.prototype.setEnableSectionReordering=function(v){if(v===undefined||this.getEnableSectionReordering()===v){return this;}this.setProperty("enableSectionReordering",!!v,true);if(v){this.addDragDropConfig(this._oDragDropInfo);}else{this.removeDragDropConfig(this._oDragDropInfo);}return this;};f.prototype.setNoSectionsText=function(t){if(t===undefined||this.getNoSectionsText()===t){return this;}this.setProperty("noSectionsText",t,true);var n=this.getAggregation("_noSectionText");n.setText(t||r.i18n.getText("Page.NoSectionText"));return this;};f.prototype._focusVisualization=function(v){if(!v){return;}else if(v.isA("sap.ushell.ui.launchpad.VizInstanceLink")){v.focus();}else{v.getDomRef().parentElement.focus();}};f.prototype._focusNextVisualization=function(i){var s=this.getSections();var S=this.indexOfSection(i.section);var o=i.event.getParameter?i.event.getParameter("event"):i.event;var g=o.target.firstElementChild;var h,F;while(true){if(i.direction==="up"){S--;}else{S++;}h=s[S];if(!h){return;}F=h.focusVisualization({keycode:o.keyCode,ref:g});if(F){o.preventDefault();return;}}};f.prototype._handleKeyboardPageNavigation=function(o){if(this._isFocusInInput()){return;}var s=this.getSections();for(var i=0;i<s.length;i++){var S=s[i].getDomRef();if(S.contains(window.document.activeElement)){this._focusNextVisualization({event:o,section:s[i],direction:o.type==="sappagedown"?"down":"up",prefIndex:0});return;}}};f.prototype._handleKeyboardArrowNavigation=function(m,o){if((m&&!this.getEnableSectionReordering())||(m&&!o.ctrlKey)){return;}var s=this.getSections();var p,S,n;for(var i=0;i<s.length;i++){p=s[i-1];S=s[i];n=s[i+1];if(window.document.activeElement===S.getFocusDomRef()){if(o.type==="sapup"&&p){p.focus();}else if(o.type==="sapdown"&&n){n.focus();}else if(o.type==="sapupmodifiers"&&p){if(p.getDefault()){return;}this.fireSectionDrop({draggedControl:S,droppedControl:p,dropPosition:"Before"});o.preventDefault();o.stopPropagation();p.focus();}else if(o.type==="sapdownmodifiers"&&n){if(S.getDefault()){return;}this.fireSectionDrop({draggedControl:S,droppedControl:n,dropPosition:"After"});o.preventDefault();o.stopPropagation();n.focus();}return;}}};f.prototype._isFocusInInput=function(){var t=(document.activeElement||{}).tagName;return t==="INPUT"||t==="TEXTAREA";};f.prototype._handleKeyboardHomeEndNavigation=function(o){if(this._isFocusInInput()){return;}var s,i;var L=false;if(o.type==="saphome"){i=this._getSectionAreaItems(o.srcControl);}else if(o.type==="saphomemodifiers"){s=this._getFirstVisibleSection(true);}else if(o.type==="sapend"){i=this._getSectionAreaItems(o.srcControl);L=true;}else if(o.type==="sapendmodifiers"){s=this._getLastVisibleSection(true);L=true;}if(s){i=s.getAllItems();}if(L){this._focusVisualization(i[i.length-1]);}else{this._focusVisualization(i[0]);}o.preventDefault();o.stopPropagation();};f.prototype._getFirstVisibleSection=function(A){var s=this.getSections();return s.find(function(S){return this._isSectionVisible(S,A);}.bind(this));};f.prototype._getLastVisibleSection=function(A){var s=this.getSections().reverse();return s.find(function(S){return this._isSectionVisible(S,A);}.bind(this));};f.prototype._isSectionVisible=function(s,A){var g=A?false:this.getEdit();return g||s.getVisualizations().length>0&&s.getDomRef()&&s.getShowSection();};f.prototype._getSectionAreaItems=function(o){var i,s;var g=o.getBindingContext();if(g){s=g.getProperty("displayFormatHint");}var S=this.getSections();var t=S.find(function(h){var j=h.getDomRef();return j&&j.contains(o.getDomRef());});if(t){switch(s){case e.Compact:return t.getCompactItems();case e.Standard:case e.StandardWide:return t.getDefaultItems();case e.Flat:case e.FlatWide:return t.getFlatItems();default:i=t.getDefaultItems();if(i.length>0){return i;}i=t.getFlatItems();if(i.length>0){return i;}i=t.getCompactItems();return i;}}return[];};f.prototype._getCurrentlyFocusedSection=function(){var s=this.getSections();var o=window.document.activeElement;return s.find(function(S){return S.getDomRef().contains(o);});};f.prototype._handleSectionBorderReached=function(i){this._focusNextVisualization(i.getParameters());};f.prototype.addAggregation=function(A,o){C.prototype.addAggregation.apply(this,arguments);if(A==="sections"){o.attachEvent("borderReached",this._handleSectionBorderReached.bind(this));}return this;};f.prototype.insertAggregation=function(A,o){C.prototype.insertAggregation.apply(this,arguments);if(A==="sections"){o.attachEvent("borderReached",this._handleSectionBorderReached.bind(this));}return this;};f.prototype.announceMove=function(){var s=r.i18n.getText("PageRuntime.Message.SectionMoved");this._oInvisibleMessageInstance.announce(s,d.Polite);};return f;});
