// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/Controller","sap/base/Log","sap/ushell/Config","sap/ushell/resources","sap/ui/thirdparty/hasher","sap/ui/core/library"],function(C,L,a,r,h,c){"use strict";var V=c.ValueState;return C.extend("sap.ushell.ui.bookmark.SaveOnPage",{onInit:function(){var v=this.getView();v.setModel(r.i18nModel,"i18n");this.byId("bookmarkTitleInput").attachLiveChange(function(){if(this.getValue()===""){this.setValueStateText(r.i18n.getText("bookmarkTitleInputError"));this.setValueState(V.Error);}else{this.setValueState(V.None);}});this.byId("pageSelect").attachSelectionFinish(function(){if(this.getSelectedKeys().length===0){this.setValueStateText(r.i18n.getText("bookmarkPageSelectError"));this.setValueState(V.Error);}else{this.setValueState(V.None);}});},loadPagesIntoModel:function(s,p){if(s&&!p){var P=a.last("/core/shell/enablePersonalization");var m=a.last("/core/spaces/myHome/enabled");if(!P&&!m){var M=this.getView().getModel();M.setProperty("/pages",[]);M.setProperty("/cannotLoadPages",true);L.error("SaveOnPage controller: Unable to determine or use targets for bookmark placement, because personalization is disabled");return Promise.resolve();}var S=!P&&m;var b=a.last("/core/spaces/myHome/myHomeSpaceId");return Promise.all([sap.ushell.Container.getServiceAsync("Menu"),sap.ushell.Container.getServiceAsync("CommonDataModel")]).then(function(d){return Promise.all([d[0].getSpacesPagesHierarchy(),d[1].getAllPages()]);}).then(function(R){var d=R[0].spaces;var A=R[1];var e={};A.forEach(function(o){e[o.identification.id]=o.identification.title;});return d.reduce(function(t,o){if(S&&b!==o.id){return t;}o.pages.map(function(f){if(e[f.id]){t.push({id:f.id,title:e[f.id],spaceTitle:o.title});}});return t;},[]);}).then(function(t){if(t.length<1){return Promise.reject();}this.getView().getModel().setProperty("/pages",t);}.bind(this)).catch(function(){var M=this.getView().getModel();M.setProperty("/pages",[]);M.setProperty("/cannotLoadPages",true);L.error("SaveOnPage controller: Unable to determine or use targets for bookmark placement.");}.bind(this));}return Promise.resolve();},removeFocusFromTile:function(){this.getView().getDomRef().querySelector(".sapMGT").removeAttribute("tabindex");},getBookmarkTileData:function(){var v=this.getView();var m=v.getModel();var o=v.getViewData();var u;if(o.customUrl){if(typeof(o.customUrl)==="function"){u=o.customUrl();}else{u=o.customUrl;}}else{u=h.getHash()?("#"+h.getHash()):window.location.href;}var p=this.byId("pageSelect");var d={title:m.getProperty("/title")||"",subtitle:m.getProperty("/subtitle")||"",url:u,icon:m.getProperty("/icon"),info:m.getProperty("/info")||"",numberUnit:m.getProperty("/numberUnit"),serviceUrl:typeof(o.serviceUrl)==="function"?o.serviceUrl():o.serviceUrl,serviceRefreshInterval:m.getProperty("/serviceRefreshInterval"),pages:p?p.getSelectedKeys():[],keywords:m.getProperty("/keywords")};d.title=d.title.substring(0,256).trim();d.subtitle=d.subtitle.substring(0,256).trim();d.info=d.info.substring(0,256).trim();return d;},groupBySpace:function(b){return b.getObject().spaceTitle;},sortPages:function(p,b){if(a.last("/core/spaces/myHome/enabled")){var m=a.last("/core/spaces/myHome/myHomePageId");if(p.id===m){return-1;}if(b.id===m){return 1;}}if(p.spaceTitle.toUpperCase()>b.spaceTitle.toUpperCase()){return 1;}if(p.spaceTitle.toUpperCase()<b.spaceTitle.toUpperCase()){return-1;}return 0;}});});
