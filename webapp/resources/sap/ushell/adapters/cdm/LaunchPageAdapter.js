// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/adapters/cdm/_LaunchPage/readHome","sap/ushell/adapters/cdm/_LaunchPage/modifyHome","sap/ushell/adapters/cdm/_LaunchPage/readCatalogs","sap/m/GenericTile","sap/m/library","sap/ui/core/ComponentContainer","sap/ushell/adapters/cdm/_LaunchPage/uri.transform","sap/ushell/Config","sap/ushell/EventHub","sap/ushell/navigationMode","sap/ushell/resources","sap/ushell/utils","sap/ushell/utils/utilsCdm","sap/ushell/utils/WindowUtils","sap/ushell/utils/UrlParsing","sap/ushell/components/tiles/utilsRT","sap/base/util/Version","sap/ui/model/json/JSONModel","sap/ui/thirdparty/jquery","sap/base/util/deepExtend","sap/base/util/isPlainObject","sap/base/util/isEmptyObject","sap/base/util/ObjectPath","sap/base/Log","sap/ushell/library"],function(r,m,R,G,M,C,u,a,E,n,o,U,b,W,c,d,V,J,q,f,i,g,O,L,h){"use strict";var j=M.GenericTileMode;var k=h.UI5ComponentType;var l=L.getLogger("sap/ushell/adapters/cdm/LaunchPageAdapter"),p=L.Level;function s(t,P,A){var _,S="sap.ushell.components.tiles.cdm.applauncher",D="sap.ushell.components.tiles.cdm.applauncherdynamic";this._mResolvedTiles={};this._mCatalogTilePromises={};this._mFailedResolvedCatalogTiles={};this._mFailedResolvedTiles={};this._mContentProviders={};Promise.all([sap.ushell.Container.getServiceAsync("URLParsing"),sap.ushell.Container.getServiceAsync("CommonDataModel")]).then(function(e){this.oURLParsingService=e[0];this.oCDMService=e[1];}.bind(this));this.getCdmVersionsSupported=function(){return{min:V("0"),max:V("2.0.0")};};this.isSiteSupported=function(e){if(!!e._version&&V(e._version).compareTo(this.getCdmVersionsSupported().max)>0){L.fatal("Invalid CDM site version: Only sites up to version 2.0.0 are supported");return false;}return true;};this.TileType={Tile:"tile",Link:"link"};this.getGroups=function(){var e=new q.Deferred();this._assureLoaded().done(function(N){U.setPerformanceMark("FLP - homepage groups processed");e.resolve(N);}).fail(function(){e.resolve([]);});return e.promise();};this._getTileFromHashInContextOfSite=function(e,N,Q){var T=new q.Deferred(),X=N[Q];if(!X){X=e(Q);N[Q]=X;}X.done(function(Y){var Z={tileIntent:Q,tileResolutionResult:Y};T.resolve(Z);}).fail(function(Y){T.reject("Hash '"+Q+"' could not be resolved to a tile. "+Y);});return T.promise();};this._getTileFromHash=function(e){var N=new q.Deferred();sap.ushell.Container.getServiceAsync("ClientSideTargetResolution").then(function(Q){var T=Q.resolveTileIntent.bind(Q);this._getTileFromHashInContextOfSite(T,this._mCatalogTilePromises,e).done(N.resolve).fail(N.reject);}.bind(this));return N.promise();};this._getTileForUrl=function(T){var e=T.indicatorDataSource?"#Shell-dynamicTile":"#Shell-staticTile";return{tileIntent:"#",tileResolutionResult:{tileComponentLoadInfo:e,isCustomTile:false}};};this._assureGroupItemsResolved=function(e,N){var Q=[],T,X;if(e.payload&&e.payload.tiles){T=this._assureGroupTilesResolved(e.payload.tiles,N);Array.prototype.push.apply(Q,T);}if(e.payload&&e.payload.links){X=this._assureGroupLinksResolved(e.payload.links,N);Array.prototype.push.apply(Q,X);}return Q;};this._assureGroupTilesResolved=function(e,N){return(e||[]).map(function(T,Q){return this._resolveGroupTile(T,N).then(function(X){X.isLink=false;return X;});},this);};this._assureGroupLinksResolved=function(e,N){return(e||[]).map(function(Q){return this._resolveGroupTile(Q,N).then(function(T){T.isLink=true;return T;});},this);};this._resolveGroupTile=function(T,e){var N=this._mResolvedTiles;var Q=this._mFailedResolvedTiles;var X;function Y($){N[T.id]=$;if(Q[T.id]){delete Q[T.id];}return $;}function Z(T){var $=T.target;return $&&$.semanticObject==="Shell"&&$.action==="launchURL";}if(N[T.id]){return(new q.Deferred()).resolve(N[T.id]).promise();}if(T.target&&T.target.url){X=q.when(this._getTileForUrl(T));}else if(T.isBookmark){X=this._resolveTileByIntent(T,e);}else if(Z(T)){X=this._resolveTileByIntent(T,e);}else{X=this._resolveTileByAppId(T,e);}X.done(function($){Y($);}).fail(function($){Q[T.id]=$;});return X;};this._resolveTileByAppId=function(T,e){var N,Q,X,Y,Z;function $(f1,g1){return new q.Deferred().reject({logLevel:f1,message:g1}).promise();}if(!i(T)){return $(p.ERROR,"Cannot resolve tile: oTile must be an object");}if(!i(e)){return $(p.ERROR,"Cannot resolve tile: oSite must be an object");}N=T.appId||T.appIDHint;if(!N){return $(p.ERROR,["Cannot resolve tile '",T.id,"': either appId or appIDHint must be specified"].join(""));}Q=e.applications&&e.applications[N];if(!Q){return $(p.INFO,["Tile '",T.id,"' filtered from result: no app found for appId '",N,"' (dangling app reference)"].join(""));}X=this._getFirstInbound(Q);if(!X){return $(p.ERROR,["Cannot resolve tile '",T.id,"': app '",N,"' has no navigation inbound"].join(""));}var a1=b.mapOne(X.key,X.inbound,Q),b1=a1.resolutionResult.applicationType,c1=a1.resolutionResult.additionalInformation,d1=a.last("/core/navigation/enableInPlaceForClassicUIs"),e1=d1?d1[b1]:false;Y=a1.tileResolutionResult;Y.navigationMode=n.computeNavigationModeForHomepageTiles(b1,c1,e1);Y.isLink=false;if(!this._isFormFactorSupported(Y)){return $(p.INFO,["Tile '",T.id,"' filtered from result: form factor not supported"].join(""));}Z=this._toHashFromInbound(X.inbound);return q.when({tileResolutionResult:Y,tileIntent:Z});};this._isFormFactorSupported=function(e){var N=U.getFormFactor();return r.supportsFormFactor(e,N);};this._getFirstInbound=function(e){var N=Object.keys(e["sap.app"].crossNavigation.inbounds).shift(),Q=e["sap.app"].crossNavigation.inbounds[N];return{key:N,inbound:Q};};this._resolveTileByIntent=function(T,e){var N=this._prepareTileHash(T);return this._getTileFromHash(N);};this._prepareTileHash=function(T){var e={},N,Q;if(this._isCatalogTile(T)){return T.tileIntent;}if(this._isGroupTile(T)&&T.target){Q=T.target.parameters||[];Q.forEach(function(X){if(X.name&&X.value){e[X.name]=[X.value];}});N={target:{semanticObject:T.target.semanticObject,action:T.target.action},params:e,appSpecificRoute:T.target.appSpecificRoute};return"#"+c.constructShellHash(N);}return undefined;};this._allPromisesDone=function(e){var N=new q.Deferred(),Q;if(e.length===0){N.resolve([]);}else{var T=e.map(function(X){Q=new q.Deferred();X.always(Q.resolve.bind(Q));return Q.promise();});q.when.apply(this,T).done(function(){var X=Array.prototype.slice.call(arguments);N.resolve(X);});}return N.promise();};this._assureLoaded=function(){var e=this,N;if(this._assureLoadedDeferred){return this._assureLoadedDeferred.promise();}N=new q.Deferred();this._assureLoadedDeferred=N;sap.ushell.Container.getServiceAsync("CommonDataModel").then(function(Q){Q.getSite().done(function(T){if(!e.isSiteSupported(T)){throw new Error("Invalid CDM site version: Check configuration of launchpage adapter and version of FLP site");}var X=[];var Y=r.getGroupsArrayFromSite(T);var Z=r.getDefaultGroup(Y);if(!Z){Z=m.createDefaultGroup(U.generateUniqueId(r.getGroupIdsFromSite(T)));T=m.addGroupToSite(T,Z,0);Y=r.getGroupsArrayFromSite(T);}_=Z;Y.forEach(function($){X=e._assureGroupItemsResolved($,T).concat(X);});e._allPromisesDone(X).done(function(){e._assureLoadedDeferred.resolve(Y);delete e._assureLoadedDeferred;e._logTileResolutionFailures(e._mFailedResolvedTiles);});}).fail(function(T){L.error("Delivering hompage groups failed - "+T);e._assureLoadedDeferred.resolve([]);delete e._assureLoadedDeferred;});});return N.promise();};this._logTileResolutionFailures=function(e){var N={};if(!e){return;}Object.keys(p).filter(function(Q){var T=p[Q];return T>=p.FATAL&&T<=p.ALL;}).forEach(function(Q){N[p[Q]]="";});Object.keys(e).forEach(function(Q){var T=e[Q];if(T.logLevel){N[T.logLevel]=N[T.logLevel].concat(T.message).concat("\n");}});if(N[p.FATAL]){l.fatal(N[p.FATAL]);}if(N[p.ERROR]){l.error(N[p.ERROR]);}if(N[p.WARNING]){l.warning(N[p.WARNING]);}if(N[p.INFO]){l.info(N[p.INFO]);}if(N[p.DEBUG]){l.debug(N[p.DEBUG]);}if(N[p.TRACE]){l.trace(N[p.TRACE]);}};this.getDefaultGroup=function(){var e=new q.Deferred(),N;if(!_){N=this._assureLoaded();}if(N){N.done(function(){e.resolve(_);}).fail(function(Q){e.reject("Failed to access default group. "+Q);});}else{e.resolve(_);}return e.promise();};this._isValidTitle=function(T){if(typeof T!=="string"||!T){return false;}return true;};this._isGroupPreset=function(e){return r.isGroupPreset(e);};this._isGroupLocked=function(e){return r.isGroupLocked(e);};this.addGroup=function(T){var e=new q.Deferred(),N=this.oCDMService,Q,X,Y=this;if(!this._isValidTitle(T)){return e.reject("No valid group title").promise();}X="Failed to add the group with title '"+T+"' to the homepage. ";N.getSite().done(function(Z){Q=U.generateUniqueId(r.getGroupIdsFromSite(Z));m.addGroupToSite(Z,m.createEmptyGroup(Q,T));N.save().done(function(){delete Y._assureLoadedDeferred;e.resolve(Z.groups[Q],Q);}).fail(function($){e.reject($);});}).fail(function(Z){e.reject(X+Z);});return e.promise();};this.getGroupTitle=function(e){return r.getGroupTitle(e);};this.setGroupTitle=function(e,N){var Q=this,T=new q.Deferred(),X=this.oCDMService,Y,Z;if(typeof e!=="object"||!r.getGroupId(e)){return T.reject("Unexpected group value").promise();}if(!Q._isValidTitle(N)){return T.reject("Unexpected oGroup title value").promise();}Z="Failed to set new title for group with id '"+r.getGroupId(e)+"'. ";Y=r.getGroupTitle(e);X.getSite().done(function($){if(e){m.setGroupTitle(e,N);}X.save().done(function(){T.resolve();}).fail(function(a1){L.error(a1);T.reject(Y);});}).fail(function($){T.reject(Y,Z+$);});return T.promise();};this.getGroupId=function(e){return r.getGroupId(e);};this.hideGroups=function(e){var N=new q.Deferred(),Q=this.oCDMService,T;if(e&&Array.isArray(e)){T="Failed to hide group. ";Q.getSite().done(function(X){r.getGroupsArrayFromSite(X).forEach(function(Y){m.setGroupVisibility(Y,e&&Array.prototype.indexOf.call(e,r.getGroupId(Y))===-1);});Q.save().done(function(){N.resolve();}).fail(function(Y){N.reject("Hiding of groups did not work as expected - "+Y);});}).fail(function(X){N.reject(T+X);});}else{N.reject("Invalid input parameter aHiddenGroupIds. Please pass a valid input parameter.");}return N.promise();};this.isGroupVisible=function(e){return r.isGroupVisible(e);};this.moveGroup=function(e,N){var Q=new q.Deferred(),T=this.oCDMService,X,Y;if(!e||!r.getGroupId(e)||N<0){return Q.reject("Unable to move groups - invalid parameters").promise();}Y="Failed to move group with id '"+e.identification.id+"'. ";T.getSite().done(function(Z){var $=r.getGroupIdsFromSite(Z),a1=r.getGroupId(e);if(!$){return Q.reject("groupsOrder not found - abort operation of adding a group.");}else if($.indexOf(a1)===N){return Q.resolve();}X=U.moveElementInsideOfArray($,$.indexOf(a1),N);if(!X){return Q.reject("invalid move group operation - abort.");}m.setGroupsOrder(Z,X);T.save().done(function(){Q.resolve();}).fail(function(b1){Q.reject(b1);});return undefined;}).fail(function(Z){Q.reject(Y+Z);});return Q.promise();};this.removeGroup=function(e){var N=new q.Deferred(),Q=this.oCDMService,T,X;if(typeof e!=="object"){return N.reject("invalid group parameter").promise();}X=r.getGroupId(e);if(!X){return N.reject("group without id given").promise();}T="Failed to remove group with id '"+X+"'. ";Q.getSite().done(function(Y){m.removeGroupFromSite(Y,e);Q.save().done(function(){N.resolve();}).fail(function(Z){N.reject(Z);});}).fail(function(Y){N.reject(T+Y);});return N.promise();};this.resetGroup=function(e){var N=new q.Deferred(),Q=this.oCDMService,T=[],X=this,Y,Z;if(typeof e==="object"&&r.getGroupId(e)){Z=r.getGroupId(e);Y="Failed to reset group with id '"+Z+"'. ";Q.getSite().done(function($){q.extend(true,T,r.getGroupsArrayFromSite($));if(X.isGroupRemovable(e)===false){Q.getGroupFromOriginalSite(Z).done(function(a1){if(typeof $==="object"&&r.getGroupFromSite($,Z)){m.overwriteGroup($,a1,Z);}Q.save().done(function(){N.resolve(a1);}).fail(function(b1){N.reject("Group could not be reset - "+b1,T);});}).fail(function(a1){N.reject("Group could not be reset - "+a1,T);});}else{N.reject("Group could not be reset as it was created by the user",T);}}).fail(function($){N.reject(Y+$,[]);});}return N.promise();};this.getTileTitle=function(T){return r.getTileTitle(this._mResolvedTiles,T);};this.getTileSubtitle=function(T){return r.getTileSubtitle(this._mResolvedTiles,T);};this.getTileIcon=function(T){return r.getTileIcon(this._mResolvedTiles,T);};this.getTileInfo=function(T){return r.getTileInfo(this._mResolvedTiles,T);};this.getTileIndicatorDataSource=function(T){var e=this._mResolvedTiles[T.id],N={},Q;if(T.indicatorDataSource){N.indicatorDataSource=f({},T.indicatorDataSource);if(T.dataSource){N.dataSource=f({},T.dataSource);}return N;}if(!e){return N;}Q=e.tileResolutionResult;if(Q.indicatorDataSource){N.indicatorDataSource=f({},Q.indicatorDataSource);if(Q.indicatorDataSource.hasOwnProperty("dataSource")){var X=Q.indicatorDataSource.dataSource,Y=Q.dataSources;if(Y&&Y.hasOwnProperty(X)){N.dataSource=f({},Y[X]);}else{L.warning("datasource referenced but not found for tile: "+e.tileIntent);}}if(U.getMember(Q,"runtimeInformation.componentProperties.url")){var Z=U.getMember(N,"indicatorDataSource.path");var $=U.getMember(N,"dataSource.uri");var a1=U.getMember(Q,"runtimeInformation.componentProperties.url");var b1=u(Z,$,a1,this.getWindowLocationHref());if(!b1.error){if(Z){N.indicatorDataSource.path=b1.uri;}if($){N.dataSource.uri=b1.uriParent;}}}}return N;};this.getWindowLocationHref=function(){return window.location.href;};this.isGroupRemovable=function(e){return!this._isGroupPreset(e);};this.isGroupLocked=function(e){return this._isGroupLocked(e);};this.getGroupTiles=function(e){return r.getGroupTiles(e).concat(r.getGroupLinks(e));};this.getLinkTiles=function(e){return r.getGroupLinks(e);};this.getTileType=function(T){if(r.isLink(this._mResolvedTiles,T)){return this.TileType.Link;}return this.TileType.Tile;};this.getTileId=function(T){return r.getTileId(T);};this.getTileSize=function(T){return r.getTileSize(this._mResolvedTiles,T)||"1x1";};this.getTileTarget=function(T){var e,N=r.getTileId(T),Q=this._mResolvedTiles[N],X;if(T.target&&T.target.url){return T.target.url;}if(Q&&Q.tileResolutionResult){e=Q.tileResolutionResult;if(e.isCustomTile!==true){return Q.tileIntent;}if(e&&typeof e.targetOutbound==="object"){X=this._toHashFromOutbound(e.targetOutbound);if(X){return X;}}}L.warning("Could not find a target for Tile with id '"+N+"'","sap.ushell.adapters.cdm.LaunchPageAdapter");return"";};this.isLinkPersonalizationSupported=function(T){return true;};this.isTileIntentSupported=function(T){return(this._mFailedResolvedTiles[T.id]===undefined);};this._notifyTileAboutRefresh=function(T){if(typeof T.tileRefresh==="function"){T.tileRefresh();}};this.refreshTile=function(T){var e=this._mResolvedTiles[T.id];if(e){if(e.tileComponent){this._notifyTileAboutRefresh(e.tileComponent);}}};this._notifyTileAboutVisibility=function(T,N,e){if(typeof T.tileSetVisible==="function"&&e!==N){T.tileSetVisible(N);}};this.setTileVisible=function(T,N){var e=this._mResolvedTiles[T.id];if(e){if(e.tileComponent){this._notifyTileAboutVisibility(e.tileComponent,N,e.visibility);}e.visibility=N;}};this.getTileView=function(e){var N=this;return new q.Deferred(function(Q){return N._getTileView(e,false).then(function(T){Q.resolve(T);},function(T){var X="Tile with ID '"+e.id+"' could not be initialized"+(T?":\n"+T:".");L.error(X,null,e.tileType);Q.reject(X);});}).promise();};this._getTileUiComponentContainerSync=function(T,e,N){var Q=this,X,Y,Z,$,a1={};if(N===true){Y=Q._createTileComponentData(T,true,e);}else{Y=Q._createTileComponentData(T,false,e);}X=e.tileResolutionResult;if(e.isLink){Z=X.navigationMode;return Q._createLinkInstance(T,N,Z,G,o);}if(typeof X.tileComponentLoadInfo==="string"){if(Y.properties.indicatorDataSource&&Y.properties.indicatorDataSource.path){a1.name="sap.ushell.components.tiles.cdm.applauncherdynamic";}else{a1.name="sap.ushell.components.tiles.cdm.applauncher";}}else if(typeof X.tileComponentLoadInfo==="object"&&X.tileComponentLoadInfo!==null){a1=X.tileComponentLoadInfo.componentProperties||{};a1.name=X.tileComponentLoadInfo.componentName;}a1.componentData=Y;if(a1.manifest){a1.componentData.properties=a1.componentData.properties||{};a1.componentData.properties.manifest=a1.manifest;}if(a1.name){a1.async=false;var b1;try{$=sap.ui.component(a1);}catch(c1){L.error(c1.message+"\n-- An error occurred while instantiating "+"the tile component for "+a1.name,c1.stack?c1.stack:"","sap.ushell.adapters.cdm.LaunchPageAdapter");return null;}b1=new C({component:$,height:"100%"});if(!N){Q._mResolvedTiles[T.id].tileComponent=$;}return b1;}return null;};this._getTileUiComponentContainer=function(T,e,N){var Q=this,X,Y,Z,$,a1,b1,c1=new q.Deferred();if(N===true){Y=Q._createTileComponentData(T,true,e);}else{Y=Q._createTileComponentData(T,false,e);}X=e.tileResolutionResult;if(e.isLink){Z=X.navigationMode;c1.resolve(Q._createLinkInstance(T,N,Z,G,o));return c1.promise();}var d1=this._createTileComponentProperties(Y,X.tileComponentLoadInfo);if(!d1.name){return c1.reject("Cannot find name of tile component for tile with id: '"+T.id+"'").promise();}if(d1.manifest){Y.properties=Y.properties||{};Y.properties.manifest=d1.manifest;}b1=this.isCustomTile(d1.name);var e1=function(i1){var e;$=i1.componentHandle.getInstance();a1=new C({component:$,height:"100%"});if(!N){e=Q._mResolvedTiles[T.id];e.tileComponent=$;if(typeof e.visibility==="boolean"){Q._notifyTileAboutVisibility($,e.visibility);}}return a1;};var f1=function(i1){return i1.createComponent({loadCoreExt:b1,loadDefaultDependencies:false,componentData:Y,url:d1.url,applicationConfiguration:{},reservedParameters:{},applicationDependencies:d1,ui5ComponentName:d1.name},{},[],k.Visualization).then(e1);};var g1=function(){var i1={componentData:Y,url:d1.url,name:d1.name,async:false};$=sap.ui.component(i1);var j1={componentHandle:{getInstance:function(){return $;}}};return e1(j1);};if(b1){E.once("CoreResourcesComplementLoaded").do(function(){sap.ushell.Container.getServiceAsync("Ui5ComponentLoader").then(function(i1){f1(i1).then(function(a1){c1.resolve(a1);}).fail(function(j1){c1.reject(j1);});});});}else{var h1=g1();c1.resolve(h1);}return c1.promise();};this._createTileComponentProperties=function(T,e){var N={};if(typeof e==="string"){if(T.properties.indicatorDataSource&&T.properties.indicatorDataSource.path){N.name=D;}else{N.name=S;}return N;}if(typeof e==="object"&&e!==null){N=e.componentProperties||{};N.name=e.componentName;}return N;};this._getTileView=function(e){var N,Q,T=new q.Deferred();if(typeof e!=="object"||!e.id){Q="Invalid input parameter passed to _getTileView: "+e;L.error(Q);return T.reject(Q).promise();}N=this._mResolvedTiles[e.id];if(N){return this._getTileUiComponentContainer(e,N,false);}Q="No resolved tile found for tile ID: "+e.id;L.error(Q);return T.reject(Q).promise();};this._getCatalogTileView=function(e){if(typeof e!=="object"){throw new Error(e);}return this._getTileUiComponentContainerSync(e,e,true);};this._getCatalogTileViewControl=function(e){var N=new q.Deferred();if(typeof e!=="object"){var Q="Invalid input parameter passed to _getCatalogTileView: "+e;L.error(Q);return N.reject(Q).promise();}return this._getTileUiComponentContainer(e,e,true);};this._createTileComponentData=function(T,e,N){var Q=e?this.getCatalogTileTitle(T):this.getTileTitle(T),X=e?this.getCatalogTilePreviewSubtitle(T):this.getTileSubtitle(T),Y=e?this.getCatalogTilePreviewIcon(T):this.getTileIcon(T),Z=e?this.getCatalogTilePreviewInfo(T):this.getTileInfo(T),$=e?this.getCatalogTileTargetURL(T):this.getTileTarget(T),a1=this.getTileIndicatorDataSource(T),b1={properties:{},startupParameters:{}};if(N.tileResolutionResult.isCustomTile===true&&N.tileResolutionResult.startupParameters){b1.startupParameters=N.tileResolutionResult.startupParameters;}if(Q){b1.properties.title=Q;}if(Z){b1.properties.info=Z;}if(X){b1.properties.subtitle=X;}if(Y){b1.properties.icon=Y;}if($){b1.properties.targetURL=$;}if(a1.indicatorDataSource){b1.properties.indicatorDataSource=a1.indicatorDataSource;if(a1.dataSource){b1.properties.dataSource=a1.dataSource;}}if(N.tileResolutionResult){b1.properties.navigationMode=N.tileResolutionResult.navigationMode;}return b1;};this._createLinkInstance=function(T,e,N,Q,o){var X,Y,Z,$=this.getTileSubtitle(T);var G=Q;if(e===true){X=this.getCatalogTileTitle(T);}else{X=this.getTileTitle(T);}Y=new G({mode:j.LineMode,subheader:$,header:X,url:W.getLeanURL(this.getTileTarget(T)),press:function(a1){this._genericTilePressHandler(T,a1);}.bind(this)});if(N){Z=o.i18n.getText(N+"NavigationMode");Y.setAriaLabel(Z+" "+X+" "+$);}this._mResolvedTiles[T.id].linkTileControl=Y;return Y;};this._genericTilePressHandler=function(T,e){var N;if(e.getSource().getScope&&e.getSource().getScope()==="Display"){N=this.getTileTarget(T);if(N){if(N[0]==="#"){hasher.setHash(N);}else{W.openURL(N,"_blank");}}}};this._addTileToSite=function(e,N,Q,T){var X=this,Y=new q.Deferred(),Z=c.parseShellHash(Q.properties.targetURL),$={id:X.getTileId(Q),target:{semanticObject:Z.semanticObject,action:Z.action,parameters:K(Z.params)}};e.groups[N.identification.id].payload.tiles.push($);T.save().done(function(){Y.resolve($);}).fail(function(a1){Y.reject(a1);});return Y.promise();};this.addTile=function(e,N){var Q=new q.Deferred(),T,X=this.oCDMService,Y;if(!N){N=_;}if(e.contentProviderId){if(e.externalUrl){return this.addBookmark(this._getBookmarkDataForExtensionCatalogTile(e),N);}return Q.reject("Extension Tile without URL").promise();}Y=x();Y.appId=e.tileResolutionResult.appId;this._mResolvedTiles[Y.id]={tileIntent:e.tileIntent,tileResolutionResult:e.tileResolutionResult,isLink:false};X.getSite().done(function(Z){Z.groups[N.identification.id].payload.tiles.push(Y);X.save().done(function(){Q.resolve(Y);}).fail(function($){Q.reject($);});}).fail(function(Z){T="Failed to add tile with id '"+Y.id+"' to group with id '"+N.identification.id+"'. ";Q.reject(T+Z);});return Q.promise();};this._getBookmarkDataForExtensionCatalogTile=function(e){var N={title:e.tileResolutionResult.title,subtitle:e.tileResolutionResult.subTitle,icon:e.tileResolutionResult.icon,info:e.tileResolutionResult.info,url:e.externalUrl};if(e.tileResolutionResult.indicatorDataSource&&e.tileResolutionResult.indicatorDataSource.path){N.serviceUrl=e.tileResolutionResult.indicatorDataSource.path;N.serviceRefreshInterval=e.tileResolutionResult.indicatorDataSource.refresh;}return N;};this.removeTile=function(N,T,Q){var X=this.oCDMService,Y,Z=new q.Deferred(),$=this;if(!N||typeof N!=="object"||!N.identification||!N.identification.id||!T||typeof T!=="object"||!T.id){return Z.reject({},"Failed to remove tile. No valid input parameters passed to removeTile method.").promise();}Y="Failed to remove tile with id '"+T.id+"' from group with id '"+N.identification.id+"'. ";X.getSite().done(function(a1){var b1,c1;Q=+Q;try{b1=a1.groups[N.identification.id].payload;}catch(e){Z.reject(a1.groups[N.identification.id],Y);}c1=$.getTileType(T)===$.TileType.Link?"links":"tiles";if($.getTileType(T)===$.TileType.Link){Q-=b1.tiles.length;}if(Q>=0){b1[c1].splice(Q,1);}else{b1[c1]=b1[c1].filter(function(d1){return d1.id!==T.id;});}X.save().done(function(){Z.resolve();}).fail(function(d1){L.error(d1);Z.reject(a1.groups[N.identification.id],d1);});}).fail(function(e){Z.reject({},Y+e);});return Z.promise();};this.moveTile=function(T,e,N,Q,X,Y){var Z=new q.Deferred(),$=this.oCDMService,a1=this,b1;if(!T||g(T)||e===undefined||e<0||N===undefined||N<0||!Q||!Q.identification||!Q.identification.id||!X||!X.identification||!X.identification.id){return Z.reject("Invalid input parameters").promise();}b1="Failed to move tile with id '"+T.id+"'. ";$.getSite().done(function(c1){var d1,e1,f1=a1.getTileType(T)===a1.TileType.Link?"links":"tiles";if(!Y){Y=a1._mResolvedTiles[T.id].isLink?"link":"tile";}d1=Y==="link"?"links":"tiles";if(f1!==d1&&a1._mResolvedTiles[T.id]){a1._mResolvedTiles[T.id].isLink=Y==="link";}if(d1==="links"){N-=c1.groups[X.identification.id].payload.tiles.length;}if(f1==="links"){e-=c1.groups[Q.identification.id].payload.tiles.length;}if(Q.identification.id===X.identification.id){if(e!==N||f1!==d1){e1=c1.groups[X.identification.id].payload;e1[f1].splice(e,1);e1[d1].splice(N,0,T);}else{return Z.resolve(T).promise();}}else{c1.groups[Q.identification.id].payload[f1].splice(e,1);c1.groups[X.identification.id].payload[d1].splice(N,0,T);}$.save().done(function(){Z.resolve(T);}).fail(function(g1){L.error(b1+g1);Z.reject(b1+g1);});return undefined;}).fail(function(c1){L.error(b1+c1);Z.reject(b1+c1);});return Z.promise();};this._compareCatalogs=function(e,N){if(e.identification.id>N.identification.id){return 1;}return-1;};this.getCatalogs=function(){var e=this,N=new q.Deferred(),Q=[];function T(X,Y,Q,Z,$,a1){var b1=X.catalogs[Y];if($&&a1){b1.contentProviderId=$;a1.catalogsMap[Y]=b1;}Q.push(b1);Z.notify(b1);}sap.ushell.Container.getServiceAsync("CommonDataModel").then(function(X){X.getSite().done(function(Y){Object.keys(Y.catalogs).forEach(function(Z){T(Y,Z,Q,N);});X.getExtensionSites().progress(function(Z){var $=Z.providerId;var a1=Z.site;var b1=Promise.resolve(a1);var c1={sitePromise:b1,site:a1,catalogsMap:{}};Object.keys(a1.catalogs).forEach(function(d1){e._mContentProviders[$]=c1;T(a1,d1,Q,N,$,c1);});}).done(function(Z){Z.filter(function($){return!$.success;}).forEach(function($,a1){Q.push({identification:{id:$.providerId},contentProviderId:$.providerId,error:"The following content providers could not provide catalogs: "+$.providerId+($.error?" -> "+$.error:"")});});N.resolve(Q.sort(e._compareCatalogs));});});},0);return N.promise();};this._isStartableInbound=function(e){var N=["Shell-plugin","Shell-bootConfig"],Q;if(!e.semanticObject||!e.action){return false;}if(N.indexOf(e.semanticObject+"-"+e.action)>-1){return false;}if(!O.get("signature.parameters",e)){return true;}Q=Object.keys(e.signature.parameters).every(function(P){return!e.signature.parameters[P].filter||(!!e.signature.parameters[P].launcherValue||P==="sap-external-url");});return Q;};this._isHiddenInbound=function(e){return!!e.hideLauncher;};this._toHashFromInbound=function(e){var N=b.toHashFromInbound(e);if(!N){return undefined;}return"#"+N;};this._getExternalUrlFromInbound=function(e){return O.get("signature.parameters.sap-external-url.launcherValue.value",e)||null;};this._toHashFromOutbound=function(e){var N=b.toHashFromOutbound(e);if(!N){return undefined;}return"#"+N;};this._isCustomTile=function(e){if(U.getMember(e,"sap|flp.type")==="tile"){return true;}return false;};this.getCatalogTiles=function(e){var N=this,Q=new q.Deferred();if(typeof e!=="object"||e===null){return Q.reject("Invalid input parameter '"+e+"' passed to getCatalogTiles.").promise();}if(e.contentProviderId&&this._mContentProviders[e.contentProviderId]){this._mContentProviders[e.contentProviderId].sitePromise.then(function(T){v.call(N,e,T).done(Q.resolve).fail(Q.reject);},function(T){Q.reject("Failed to get site: "+T);});}else{N.oCDMService.getSite().done(function(T){v.call(N,e,T).done(Q.resolve).fail(Q.reject);}).fail(function(T){Q.reject("Failed to get site: "+T);});}return Q.promise();};this.isCustomTile=function(e){return!(e===S||e===D);};function v(e,N){var Q=this,T=new q.Deferred();setTimeout(function(){var X=((e.payload&&e.payload.appDescriptors)||[]).reduce(function(Y,Z){var $=N.applications[Z.id],a1,b1,c1,d1,e1,f1,g1,h1,i1,j1,k1,l1;if(!$){return Y;}a1=Q._getMember($,"sap|app.crossNavigation.inbounds");if(!a1||Object.keys(a1).length===0){return Y;}c1=Object.keys(a1)[0];d1=a1[c1];if(Q._isStartableInbound(d1)&&!Q._isHiddenInbound(d1)){e1=b.mapOne(c1,d1,$);if(!e1||!e1.tileResolutionResult){return Y;}i1=e1.resolutionResult.applicationType;l1=a.last("/core/navigation/enableInPlaceForClassicUIs");k1=l1?l1[i1]:false;j1=e1.resolutionResult.additionalInformation;e1.tileResolutionResult.navigationMode=n.computeNavigationModeForHomepageTiles(i1,j1,k1);f1=e1.tileResolutionResult;b1=Q._toHashFromInbound(d1);if(e.contentProviderId){h1=Q._getMember($,"sap|app.crossNavigation.inbounds.Shell-launchURL.signature.parameters.sap-external-url.launcherValue.value");}g1={id:h1||b1,tileIntent:h1||b1,tileResolutionResult:f1,isCatalogTile:true};if(e.contentProviderId&&h1){g1.contentProviderId=e.contentProviderId;g1.externalUrl=h1;}Y.push(g1);}return Y;},[]);T.resolve(X);},0);return T.promise();}this.getCatalogError=function(e){if(e.error){return e.error;}return undefined;};this.getCatalogId=function(e){return R.getCatalogId(e);};this.getCatalogTitle=function(e){return R.getCatalogTitle(e);};this._isGroupTile=function(T){return r.isGroupTile(T);};this._isCatalogTile=function(T){return!!(T&&T.isCatalogTile);};this._isFailedGroupTile=function(T){return!!(T&&this._mFailedResolvedTiles&&this._mFailedResolvedTiles[r.getTileId(T)]);};this._isFailedCatalogTile=function(T){return!!(T&&this._mFailedResolvedCatalogTiles&&this._mFailedResolvedCatalogTiles[r.getTileId(T)]);};this.getCatalogTileId=function(e){if(this._isGroupTile(e)){if(this._isFailedGroupTile(e)){return undefined;}if(e.isBookmark&&O.get("target.url",e)){return e.target.url;}return(this._mResolvedTiles[r.getTileId(e)]||{}).tileIntent;}if(this._isCatalogTile(e)){return e.id;}return undefined;};this.getCatalogTileTitle=function(e){if(this._isGroupTile(e)){if(this._isFailedGroupTile(e)){return"";}return this._mResolvedTiles[e.id].tileResolutionResult.title;}if(this._isCatalogTile(e)){if(this._isFailedCatalogTile(e)){return undefined;}return e.tileResolutionResult.title;}return undefined;};this.getCatalogTileSize=function(e){return e.tileResolutionResult.size||"1x1";};this.getCatalogTileView=function(e){return this._getCatalogTileView(e);};this.getCatalogTileViewControl=function(e){return this._getCatalogTileViewControl(e);};this.getCatalogTileTargetURL=function(e){if(!e){throw new Error("The given tile is falsy");}if(this._isCatalogTile(e)){if(e.tileResolutionResult&&e.tileResolutionResult.isCustomTile){if(!e.tileResolutionResult.targetOutbound){return"";}return this._toHashFromOutbound(e.tileResolutionResult.targetOutbound);}return e.tileIntent||"";}return this.getTileTarget(e);};this.getCatalogTilePreviewTitle=function(e){if(this._isGroupTile(e)){return this.getTileTitle(e);}return(e.tileResolutionResult&&e.tileResolutionResult.title)||"";};this.getCatalogTilePreviewSubtitle=function(e){if(this._isGroupTile(e)){return this.getTileSubtitle(e);}return(e.tileResolutionResult&&e.tileResolutionResult.subTitle)||"";};this.getCatalogTilePreviewIcon=function(e){if(this._isGroupTile(e)){return this.getTileIcon(e);}return(e.tileResolutionResult&&e.tileResolutionResult.icon)||"";};this.getCatalogTilePreviewInfo=function(e){if(this._isGroupTile(e)){return this.getTileInfo(e);}return(e.tileResolutionResult&&e.tileResolutionResult.info)||"";};this.getCatalogTileKeywords=function(e){var N=[],Q=e;if(!Q){L.error("Could not find the Tile","sap.ushell.adapters.cdm.LaunchPageAdapter");return N;}if(this._mResolvedTiles&&this._mResolvedTiles[e.id]){Q=this._mResolvedTiles[e.id];}if(Q&&Q.tileResolutionResult&&Q.tileResolutionResult.title){N.push(Q.tileResolutionResult.title);}if(Q&&Q.tileResolutionResult&&Q.tileResolutionResult.subTitle){N.push(Q.tileResolutionResult.subTitle);}return N;};this._visitBookmarks=function(e,N){var Q=this.oCDMService;var T;var X=c.parseShellHash(e);if(X){T=I(X);}else{T=H(e);}return Q.getSite().then(function(Y){var Z=Y.groups;var $=Object.keys(Z).filter(function(a1){return!Z[a1].payload.locked;}).map(function(a1){return Z[a1].payload.tiles.filter(function(b1){return b1.isBookmark&&z(T,b1.target);});}).reduce(function(a1,b1){Array.prototype.push.apply(a1,b1);return a1;},[]);if(!N){return $.length;}return q.when($.map(N)).then(function(){return $.length;});});};this.addBookmark=function(e,N){var Q=this;return new q.Deferred(function(T){var X=Q.oCDMService;q.when(N||Q.getDefaultGroup(),X.getSite()).done(function(N,Y){var Z,$,a1=c.parseShellHash(e.url),b1,c1=false;if(!a1){$=H(e.url);c1=true;}else{$=I(a1);}Z=w(e,$);if(c1){b1=new q.Deferred();b1.resolve(Q._getTileForUrl(Z));}else{b1=Q._getTileFromHash(e.url);}b1.done(function(d1){d1.isLink=false;Q._mResolvedTiles[Z.id]=d1;Y.groups[N.identification.id].payload.tiles.push(Z);X.save().done(function(){T.resolve(Z);}).fail(function(e1){T.reject(e1);});}).fail(function(d1){T.reject("Bookmark creation failed because: "+d1);});}).fail(function(Y){T.reject(Y);});}).promise();};this.countBookmarks=function(e){return this._visitBookmarks(e);};this.updateBookmarks=function(e,N){var Q=this.oCDMService;var T=this._mResolvedTiles;function X(Y){return new q.Deferred(function(Z){var $,a1;var b1;var c1=false;var d1={};if(N.url||N.url===""){$=c.parseShellHash(N.url);if(!$){a1=H(N.url);}else{a1=I($);}}if(Y.icon!==N.icon){d1.icon=N.icon;c1=true;}if(Y.title!==N.title){d1.title=N.title;c1=true;}if(Y.subTitle!==N.subtitle){d1.subtitle=N.subtitle;c1=true;}if(N.url&&e!==N.url){d1.targetURL=N.url;c1=true;}if(Y.info!==N.info){d1.info=N.info;c1=true;}y(Y,N,a1);if(c1&&T[Y.id]){b1=T[Y.id].tileComponent;if(b1){b1.tileSetVisualProperties(d1);}}Z.resolve(Y);}).promise();}return this._visitBookmarks(e,X).then(function(Y){return Q.save().then(function(){return Y;});});};this.deleteBookmarks=function(e){var N=this.oCDMService;var Q=c.parseShellHash(e);var T;if(Q){T=I(Q);}else{T=H(e);}return N.getSite().then(function(X){var Y=X.groups;var Z=Object.keys(Y).map(function($){var a1=Y[$].payload;var b1=0;a1.tiles=a1.tiles.filter(function(c1){if(c1.isBookmark&&z(T,c1.target)){++b1;return false;}return true;});return b1;}).reduce(function($,a1){$+=a1;return $;},0);return N.save().then(function(){return Z;});});};this.onCatalogTileAdded=function(T){};this._onTileSettingsSave=function(T,e){var N=new q.Deferred(),Q,X,Y,Z,$,a1,b1;if(!T||!T.id||!e){return N.reject().promise();}X=e.oTitleInput.getValue();Z=e.oSubTitleInput.getValue();Y=e.oInfoInput.getValue();$=this.getTileTitle(T);a1=this.getTileInfo(T);b1=this.getTileSubtitle(T);if($===X&&b1===Z&&a1===Y){return N.resolve().promise();}Q={};if($!==X){Q.title=X;T.title=X;}if(b1!==Z){Q.subtitle=Z;T.subTitle=Z;}if(a1!==Y){Q.info=Y;T.info=Y;}if(this._mResolvedTiles[T.id].tileComponent){this._mResolvedTiles[T.id].tileComponent.tileSetVisualProperties(Q);}else if(this._mResolvedTiles[T.id].linkTileControl){if(Q.title){this._mResolvedTiles[T.id].linkTileControl.setHeader(Q.title);}if(Q.subtitle){this._mResolvedTiles[T.id].linkTileControl.setSubheader(Q.subtitle);}if((Q.title)||(Q.subtitle)){this._mResolvedTiles[T.id].linkTileControl.rerender();}}sap.ushell.Container.getServiceAsync("CommonDataModel").then(function(c1){c1.save().fail(function(d1){L.error(d1);N.reject("Could not save personalization changes: "+d1);}).done(function(){N.resolve();});});return N.promise();};this.getTileActions=function(T){var e=[],N,Q;if(this._isGroupTile(T)&&!this._isFailedGroupTile(T)){Q=new J({config:{display_title_text:this.getTileTitle(T),display_subtitle_text:this.getTileSubtitle(T),display_info_text:this.getTileInfo(T)}});N=d.getTileSettingsAction(Q,this._onTileSettingsSave.bind(this,T),this.getTileType(T));e.push(N);}return e;};function w(e,T){var N=x(e,T);N.isBookmark=true;return N;}function x(e,T){var N={id:U.generateUniqueId([])};y(N,e,T);return N;}function y(T,e,N){e=q.extend(true,{},e);if(N){T.target=N;}if(e.title||e.title===""){T.title=e.title;}if(e.icon||e.icon===""){T.icon=e.icon;}if(e.subtitle||e.subtitle===""){T.subTitle=e.subtitle;}if(e.info||e.info===""){T.info=e.info;}if(e.dataSource){T.dataSource={};q.extend(true,T.dataSource,e.dataSource);delete e.serviceUrl;}else if(e.dataSource===null){delete T.dataSource;delete T.indicatorDataSource;delete e.serviceUrl;}if((e.dataSource||T.dataSource)&&e.serviceUrlPath){T.indicatorDataSource={path:e.serviceUrlPath};}if(e.serviceUrl||e.serviceUrl===""){if(T.dataSource){L.warning("`serviceUrl` is marked for deprecation in the future."+"It is not the preferred means for defining a dynamic "+"tile's data source. Please use `oParameter.dataSource`");delete T.dataSource;}T.indicatorDataSource={path:e.serviceUrl};}else if(e.serviceUrl===null&&!T.dataSource){delete T.indicatorDataSource;}if(e.serviceRefreshInterval||e.serviceRefreshInterval===0){T.indicatorDataSource.refresh=e.serviceRefreshInterval;}}function z(T,e){if(T&&e){if(T.url){return T.url===e.url;}return T.semanticObject===e.semanticObject&&T.action===e.action&&B(T.parameters,e.parameters)&&T.appSpecificRoute===e.appSpecificRoute;}return T===e;}function B(e,N){var Q,T;e=e||[];N=N||[];if(e.length===N.length){Q=F(e);T=F(N);return Q===T;}return false;}function F(e){return e.map(function(N){return N.name+N.value;}).sort().join();}function H(e){return{url:e};}function I(e){var T={semanticObject:e.semanticObject,action:e.action,parameters:K(e.params)};if(e.appSpecificRoute){T.appSpecificRoute=e.appSpecificRoute;}return T;}function K(e){return Object.keys(e).map(function(N){var Q=e[N]&&e[N][0];return{name:N,value:Q||""};});}}s.prototype._getMember=function(e,A){return U.getMember(e,A);};return s;},true);
