// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/deepExtend","sap/ushell/adapters/cdm/util/cdmSiteUtils","sap/ushell/utils/clone","sap/base/util/extend","sap/base/util/Version","sap/ui/thirdparty/jquery"],function(L,d,c,a,e,V,q){"use strict";var P=function(){this._oCDMPagesRequests={};this._sComponent="sap/ushell/adapters/cdm/PagesCommonDataModelAdapter";this.oSitePromise=new Promise(function(r,b){this.fnSiteResolve=r;this.fnSiteReject=b;}.bind(this));};P.prototype.getSite=function(){var D=new q.Deferred();sap.ushell.Container.getServiceAsync("NavigationDataProvider").then(function(n){return n.getNavigationData();}).then(function(n){var N={};var I=n.inbounds;for(var i=0;i<I.length;i++){var s=I[i].permanentKey||I[i].id;N[s]=I[i];}var S={_version:"3.1.0",site:{},catalogs:{},groups:{},visualizations:{},applications:c.getApplications(N),vizTypes:{},systemAliases:d({},n.systemAliases),pages:{}};this.fnSiteResolve(S);return S;}.bind(this)).then(D.resolve).catch(function(b){D.reject(b);this.fnSiteReject(b);}.bind(this));return D.promise();};P.prototype.getPage=function(p){if(!p){var E="PagesCommonDataModelAdapter: getPage was called without a pageId";L.fatal(E,null,this._sComponent);return Promise.reject(E);}return this.oSitePromise.then(function(s){if(s.pages[p]){return s.pages[p];}return Promise.all([sap.ushell.Container.getServiceAsync("PagePersistence"),sap.ushell.Container.getServiceAsync("NavigationDataProvider")]).then(function(S){var o=S[0];var n=S[1];return Promise.all([o.getPage(p),n.getNavigationData(),sap.ushell.Container.getServiceAsync("URLParsing")]);}).then(function(r){var o=r[0];var n=r[1];var u=r[2];this._addVisualizationsToSite(s,o.visualizations,u);this._addVizTypesToSite(s,o);this._addPageToSite(s,o.page,n);return s.pages[o.page.id];}.bind(this)).catch(function(v){L.fatal("PagesCommonDataModelAdapter encountered an error while fetching required services: ",v,this._sComponent);return Promise.reject(v);}.bind(this));}.bind(this));};P.prototype._addVizTypesToSite=function(s,D){var v={};Object.keys(D.vizTypes).forEach(function(b){if(!s.vizTypes[b]){v[b]=D.vizTypes[b];}});e(s.vizTypes,c.getVizTypes(v));};P.prototype._addVisualizationsToSite=function(s,v,u,C){var o;if(C){o={};Object.keys(v).forEach(function(b){if(!s.visualizations[b]){o[b]=v[b];}});}else{o=v;}e(s.visualizations,c.getVisualizations(o,u));};P.prototype._addPageToSite=function(s,p,n){var N={};var I=n.inbounds;for(var i=0;i<I.length;i++){var b=I[i].permanentKey||I[i].id;N[b]=I[i];}var o=s.pages[p.id]={identification:{id:p.id,title:p.title},payload:{layout:{sectionOrder:p.sections.map(function(l){return l.id;})},sections:{}}};var S;var f;for(var j=0;j<p.sections.length;j++){S=p.sections[j];f=o.payload.sections[S.id]={id:S.id,title:S.title,layout:{vizOrder:S.viz.map(function(v){return v.id;})},viz:{}};var v,g,t;for(var k=0;k<S.viz.length;k++){v=S.viz[k];g=!s.visualizations[v.vizId];t=v.targetMappingId&&!N[v.targetMappingId];if(g||t){var h=f.layout.vizOrder;h.splice(h.indexOf(v.id),1);if(g){L.error("Tile "+v.id+" with vizId "+v.vizId+" has no matching visualization. As the tile cannot be used to start an app it is removed from the page.");}if(t){L.error("Tile "+v.id+" with vizId "+v.vizId+" has no matching target with id "+v.targetMappingId+". As the tile cannot be used to start an app it is removed from the page.");}continue;}f.viz[v.id]={id:v.id,vizId:v.vizId,displayFormatHint:v.displayFormatHint};}}};P.prototype.getPages=function(p){if(!(p&&Array.isArray(p)&&p.length!==0)){var E="PagesCommonDataModelAdapter: getPages is not an array or does not contain any Page id";L.fatal(E,null,this._sComponent);return Promise.reject(E);}return sap.ushell.Container.getServiceAsync("VisualizationDataProvider").then(function(v){return Promise.all([v.getVisualizationData(),sap.ushell.Container.getServiceAsync("URLParsing"),this.oSitePromise]).then(function(r){var o=r[0];var u=r[1];var s=r[2];this._addVisualizationsToSite(s,o.visualizations,u);this._addVizTypesToSite(s,o);var b=[],f;for(var i=0;i<p.length;i++){f=p[i];if(!s.pages[f]){b.push(p[i]);}}if(b.length===0){return s.pages;}return Promise.all([sap.ushell.Container.getServiceAsync("PagePersistence"),sap.ushell.Container.getServiceAsync("NavigationDataProvider")]).then(function(S){var g=S[0];var n=S[1];return Promise.all([g.getPages(b),n.getNavigationData()]);}).then(function(R){var g=R[0];var n=R[1];for(var j=0;j<g.length;j++){this._addVisualizationsToSite(s,g[j].visualizations,u,true);this._addVizTypesToSite(s,g[j]);this._addPageToSite(s,g[j].page,n);}return s.pages;}.bind(this)).catch(function(g){L.fatal("PagesCommonDataModelAdapter encountered an error while fetching required services: ",g,this._sComponent);return Promise.reject(g);}.bind(this));}.bind(this));}.bind(this));};P.prototype.getPersonalization=function(C){var D=new q.Deferred();sap.ushell.Container.getServiceAsync("Personalization").then(function(p){var o;var b=new V(C);o={container:"sap.ushell.cdm.personalization",item:"data"};if(b.inRange("3.1.0","4.0.0")){o={container:"sap.ushell.cdm3-1.personalization",item:"data"};}var s={validity:"Infinity",keyCategory:p.constants.keyCategory.GENERATED_KEY,writeFrequency:p.constants.writeFrequency.HIGH,clientStorageAllowed:false};p.getPersonalizer(o,s).getPersData().done(function(f){D.resolve(f||{});}).fail(function(E){D.reject(E);});}).catch(function(){D.reject("Personalization Service could not be loaded");});return D.promise();};P.prototype.setPersonalization=function(p){var D=new q.Deferred();sap.ushell.Container.getServiceAsync("Personalization").then(function(o){var b;var C=new V(p.version);b={container:"sap.ushell.cdm.personalization",item:"data"};if(C.inRange("3.1.0","4.0.0")){b={container:"sap.ushell.cdm3-1.personalization",item:"data"};}var s={validity:"Infinity",keyCategory:o.constants.keyCategory.GENERATED_KEY,writeFrequency:o.constants.writeFrequency.HIGH,clientStorageAllowed:false};o.getPersonalizer(b,s).setPersData(p).done(function(){D.resolve(p);}).fail(D.reject);}).catch(function(){D.reject("Personalization Service could not be loaded");});return D.promise();};P.prototype.getVisualizations=function(){return sap.ushell.Container.getServiceAsync("VisualizationDataProvider").then(function(v){return Promise.all([sap.ushell.Container.getServiceAsync("URLParsing"),v.getVisualizationData(),this.oSitePromise]).then(function(r){var u=r[0];var o=r[1];var s=r[2];this._addVisualizationsToSite(s,o.visualizations,u);return s.visualizations;}.bind(this));}.bind(this));};P.prototype.getVizTypes=function(){return sap.ushell.Container.getServiceAsync("VisualizationDataProvider").then(function(v){return Promise.all([v.getVisualizationData(),this.oSitePromise]).then(function(r){var o=r[0];var s=r[1];this._addVizTypesToSite(s,o);return s.vizTypes;}.bind(this));}.bind(this));};P.prototype.getVizType=function(v){return this.oSitePromise.then(function(s){var o=s.vizTypes[v];if(o){return o;}if(!v.startsWith("X-SAP-UI2-CHIP:")){return;}return sap.ushell.Container.getServiceAsync("VisualizationDataProvider").then(function(b){return b.loadVizType(v);}).then(function(l){if(!l){return;}var b={};b[v]=l;e(s.vizTypes,c.getVizTypes(b));return s.vizTypes[v];});});};P.prototype.getCachedVisualizations=function(){return this.oSitePromise.then(function(s){return s.visualizations;});};P.prototype.getCachedVizTypes=function(){return this.oSitePromise.then(function(s){return s.vizTypes;});};return P;},true);
