// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/utils/UrlParsing","sap/ushell/utils","sap/ushell/EventHub","sap/base/Log","sap/ui/util/Mobile","sap/ui/thirdparty/jquery","sap/base/util/ObjectPath","sap/base/i18n/ResourceBundle","sap/ushell/resources","sap/ui/core/IconPool","sap/m/library"],function(U,u,E,L,M,q,O,R,r,I,m){"use strict";var B=m.ButtonType;function A(){var o={},a=true,c=null,b=[],d=[];E.on("AppRendered").do(e.bind(this));function e(){a=false;while(d.length>0){d.shift()();}}this.addActivity=function(g){var D=new q.Deferred();sap.ushell.Container.getServiceAsync("UserRecents").then(function(h){h.addActivity(g).done(D.resolve).fail(D.reject);}).catch(D.reject);return D.promise();};this.setApplicationInInitMode=function(){a=true;};this.getApplicationRequestQueue=function(){return d;};this.getCurrentApplication=function(){return c;};this.getCurrentAppliction=this.getCurrentApplication;this.getMetadata=function(g){if(!g){g=c;}if(g){var h=hasher&&hasher.getHash?hasher.getHash():"";var k=this._getMemoizationKey(h);return this._getMetadata(g,k);}return{};};this._getMemoizationKey=function(C){var h=C.split("?");var i=h[0];var p=h[1];p=this._processParams(p);if(p){return i+p;}var P=U.parseShellHash(C);i=P?P.semanticObject+"-"+P.action:"";return i;};this._processParams=function(p){if(p){var P="";var g={};p.split("&").forEach(function(i){var C=i.split("=");g[C[0]]=C[1];});var s=Object.keys(g).sort();var h="";s.forEach(function(k,i){P=i?"&":"?";h+=P+k+"="+g[k];});return h;}return"";};this._getMetadata=function(g,k){if(!(o.hasOwnProperty(k))||!o[k].complete){this.addMetadata(g,k);}if(!o[k]){o[k]={complete:false};}if(!o[k].title){o[k].title=g.text||r.i18n.getText("default_app_title");}return o[k];};this.setCurrentApplication=function(g){c=g;d.splice(0);};this.setHeaderHiding=function(){L.warning("Application configuration headerHiding property is deprecated and has no effect");};this.addApplicationSettingsButtons=function(g){if(a){d.push(function(){f(g);});}else{f(g);}};function f(g){var i,h=[],j=sap.ushell.Container.getRenderer("fiori2");for(i=0;i<g.length;i++){var C=g[i];h.push(C.getId());C.setIcon(C.getIcon()||I.getIconURI("customize"));if(r.i18n.getText("userSettings")===C.getProperty("text")){C.setProperty("text",r.i18n.getText("userAppSettings"));}C.setType(B.Unstyled);}if(sap.ushell.Container&&j){if(b.length){j.hideActionButton(b,true);}b=h;j.showActionButton(h,true,undefined,true);}}this.setWindowTitle=function(t){window.document.title=t;};this.setIcons=function(i){M.setIcons(i);};this.setApplicationFullWidth=function(v){sap.ushell.components.applicationIntegration.AppLifeCycle.setApplicationFullWidth(v);};this.getSettingsControlAsync=function(){var D=new q.Deferred();sap.ui.require(["sap/ushell/ui/footerbar/SettingsButton"],function(S){D.resolve(new S());});return D.promise();};this.getSettingsControl=function(){var s="sap/ushell/ui/footerbar/SettingsButton",S=sap.ui.require(s);if(S){return new S();}L.warning("sap.ushell.services.AppConfiguration.getSettingsControl is deprecated. Use getSettingsControlasync instead.");L.error("sap.ushell.services.AppConfiguration.getSettingsControl: sap.ushell.ui.footerbar.SettingsButton must be loaded before use.");return undefined;};this.getApplicationName=function(g){var h,s=(g&&g.additionalInformation)||null;if(s){h=/^SAPUI5\.Component=(.+)$/i.exec(s);if(h){return h[1];}}return null;};this.getApplicationUrl=function(g){var s=(g&&g.url)||null,S="P_TCODE",i;if(s){if(g.applicationType==="NWBC"&&s.indexOf(S)){return s;}i=s.indexOf("?");if(i>=0){s=s.slice(0,i);}if(s.slice(-1)!=="/"){s+="/";}}return s;};this.getPropertyValueFromConfig=function(C,p,g){var v;if(g&&C.hasOwnProperty(p+"Resource")){v=g.getText(C[p+"Resource"]);}else if(C.hasOwnProperty(p)){v=C[p];}return v;};this.getPropertyValueFromManifest=function(l,p,P){var s=p[P].manifestEntryKey,g=p[P].path,h=l.getManifestEntry(s);return O.get(g||"",h);};this.addMetadata=function(g,k){try{var C=this.getApplicationName(g),s=this.getApplicationUrl(g),l,h,p={fullWidth:{manifestEntryKey:"sap.ui",path:"fullWidth"},hideLightBackground:{manifestEntryKey:"sap.ui",path:"hideLightBackground"},title:{manifestEntryKey:"sap.app",path:"title"},icon:{manifestEntryKey:"sap.ui",path:"icons.icon"},favIcon:{manifestEntryKey:"sap.ui",path:"icons.favIcon"},homeScreenIconPhone:{manifestEntryKey:"sap.ui",path:"icons.phone"},"homeScreenIconPhone@2":{manifestEntryKey:"sap.ui",path:"icons.phone@2"},homeScreenIconTablet:{manifestEntryKey:"sap.ui",path:"icons.tablet"},"homeScreenIconTablet@2":{manifestEntryKey:"sap.ui",path:"icons.tablet@2"},startupImage320x460:{manifestEntryKey:"sap.ui",path:"icons.startupImage640x920"},startupImage640x920:{manifestEntryKey:"sap.ui",path:"icons.startupImage640x920"},startupImage640x1096:{manifestEntryKey:"sap.ui",path:"icons.startupImage640x1096"},startupImage768x1004:{manifestEntryKey:"sap.ui",path:"icons.startupImage768x1004"},startupImage748x1024:{manifestEntryKey:"sap.ui",path:"icons.startupImage748x1024"},startupImage1536x2008:{manifestEntryKey:"sap.ui",path:"icons.startupImage1536x2008"},startupImage1496x2048:{manifestEntryKey:"sap.ui",path:"icons.startupImage1496x2048"},compactContentDensity:{manifestEntryKey:"sap.ui5",path:"contentDensities.compact"},cozyContentDensity:{manifestEntryKey:"sap.ui5",path:"contentDensities.cozy"}},i,j,n,t,P,v,w,x=g&&g.componentHandle;if(k){if(!(o.hasOwnProperty(k))){o[k]={complete:false};}if(!o[k].complete){if(x){l=x.getMetadata();}else if(C){L.warning("No component handle available for '"+C+"'; SAPUI5 component metadata is incomplete",null,"sap.ushell.services.AppConfiguration");return;}if(l){h=l.getConfig();t=(l.getManifest()!==undefined);o[k].complete=true;if(h){v=h.resourceBundle||"";if(v){if(v.slice(0,1)!=="/"){v=s+v;}w=R.create({url:v,locale:sap.ui.getCore().getConfiguration().getLanguage()});}}for(P in p){if(p.hasOwnProperty(P)){if(t){o[k][P]=this.getPropertyValueFromManifest(l,p,P);}if(h&&o[k][P]===undefined){o[k][P]=this.getPropertyValueFromConfig(h,P,w);}}}o[k].version=l.getVersion();o[k].technicalName=l.getComponentName();}else if(u.isApplicationTypeEmbeddedInIframe(g.applicationType)){var W="/~canvas;window=app/wda/",y=g.url.indexOf(W),z="/sap/bc/webdynpro/sap/",D="/bc/gui/sap/its/webgui",F=g.url.indexOf(D);if(y>=0){o[k].technicalName=g.url.substring((y+W.length),g.url.indexOf("/",(y+W.length)));}if(g.url.indexOf(z)>=0){o[k].technicalName=new RegExp(z+"(.*)[?]").exec(g.url)[1];}o[k].complete=true;if(F>=0){var G="etransaction=",H=g.url.indexOf(G,F+D.length),J=g.url.indexOf("&",H),K=(J>=0)?J:g.url.length;o[k].technicalName=decodeURIComponent(g.url.substring(H+G.length,K))+" (TCODE)";}}else{L.warning("No technical information for the given application could be determined",null,"sap.ushell.services.AppConfiguration");}}i=["favIcon","homeScreenIconPhone","homeScreenIconPhone@2","homeScreenIconTablet","homeScreenIconTablet@2","startupImage320x460","startupImage640x920","startupImage640x1096","startupImage768x1004","startupImage748x1024","startupImage1536x2008","startupImage1496x2048"];j=(s&&s[s.length-1]==="/")?s.substring(0,s.length-1):s;n=function(s){if(s.match(/^https?:\/\/.*/)){return false;}return s&&s[0]!=="/";};i.forEach(function(Q){var S=o[k][Q],T=null;if(S){T=n(S)?j+"/"+S:S;}o[k][Q]=T;});}}catch(N){L.warning("Application configuration could not be parsed");}};}return new A();},true);
