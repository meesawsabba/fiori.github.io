// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ushell/Config","sap/base/util/ObjectPath"],function(L,C,O){"use strict";function U(a,c){this.getId=function(){return sap.ushell.Container.getUser().getId();};this.getFirstName=function(){return sap.ushell.Container.getUser().getFirstName();};this.getLastName=function(){return sap.ushell.Container.getUser().getLastName();};this.getFullName=function(){return sap.ushell.Container.getUser().getFullName();};this.getEmail=function(){return sap.ushell.Container.getUser().getEmail();};this.getUser=function(){return sap.ushell.Container.getUser();};function f(t){return t.id!==sap.ushell.User.prototype.constants.NEW_DESIGN||C.last("/core/themePreview/sapHorizonEnabled");}this.getThemeList=function(){var d=new jQuery.Deferred();a.getThemeList().then(function(t){t.options=(t.options||[]).filter(f);return d.resolve(t);}).fail(function(t){L.error("getThemeList failed");});return d.promise();};this.updateUserPreferences=function(){var p=a.updateUserPreferences(sap.ushell.Container.getUser());p.fail(function(){L.error("updateAttributes: ");});return p;};this.getLanguageList=function(){var p=a.getLanguageList();p.fail(function(){L.error("getLanguageList failed");});return p;};this.getUserSettingList=function(){var p=a.getUserProfilePropertyValueLists();p.fail(function(){L.error("getUserProfilePropertyValueLists failed");});return p;};this.getUserSettingListEditSupported=function(){if(typeof a.getUserProfilePropertyValueLists!=="undefined"){return true;}return false;};this.getStateNewDesignSwitch=function(){return this._getNewDesignSetting().then(function(n){return n.stateNewDesignSwitch;});};this.activateNewDesign=function(){if(!C.last("/core/shellHeader/newDesignSwitchVisible")){L.warning("Warning while activating new design: The new design feature is not enabled.");return Promise.resolve();}var u=this.getUser(),o=u.getTheme(sap.ushell.User.prototype.constants.themeFormat.ORIGINAL_THEME);if(o===sap.ushell.User.prototype.constants.NEW_DESIGN){L.warning("Warning while activating new design: The current theme is already the new design theme.");return Promise.resolve();}return Promise.all([this.updateThemeHistory(o),this.setTheme(sap.ushell.User.prototype.constants.NEW_DESIGN),this.updateNewDesignSetting(true)]);};this.deactivateNewDesign=function(){var u=this.getUser(),o=u.getTheme(sap.ushell.User.prototype.constants.themeFormat.ORIGINAL_THEME);if(o!==sap.ushell.User.prototype.constants.NEW_DESIGN){L.warning("Cannot disable new design: New design theme is not the current theme.");return Promise.resolve();}return this._getThemeHistory().then(function(t){var r;if(t&&t.previousTheme){if(t.previousTheme===sap.ushell.User.prototype.constants.NEW_DESIGN){L.warning("Warning while disabling new design: Previous theme is same as the new design theme. Falling back to default theme.");r=O.get("services.Container.adapter.config.theme",window["sap-ushell-config"]);}else{r=t.previousTheme;}}else{L.warning("Warning while disabling new design: Previous theme is empty. Falling back to default theme.");r=O.get("services.Container.adapter.config.theme",window["sap-ushell-config"]);}return Promise.all([this.setTheme(r),this.updateThemeHistory(o),this.updateNewDesignSetting(false)]);}.bind(this));};this._getPersonalizer=function(n){return sap.ushell.Container.getServiceAsync("Personalization").then(function(p){var s={keyCategory:p.constants.keyCategory.FIXED_KEY,writeFrequency:p.constants.writeFrequency.LOW,clientStorageAllowed:true};try{return p.getPersonalizer({container:n,item:"1"},s);}catch(e){L.error("Personalization service does not work:");L.error(e.name+": "+e.message);return Promise.reject(e);}});};this._getThemeHistory=function(){return this._getPersonalizer("themeHistory").then(function(p){return p.getPersData().then(function(t){return t||{previousTheme:false};});});};this.updateThemeHistory=function(o){return this._getPersonalizer("themeHistory").then(function(p){return p.setPersData({previousTheme:o});});};this._getNewDesignSetting=function(){return this._getPersonalizer("newDesignSetting").then(function(p){return p.getPersData().then(function(n){return n||{stateNewDesignSwitch:false};});});};this.updateNewDesignSetting=function(s){return this._getPersonalizer("newDesignSetting").then(function(p){C.emit("/core/shellHeader/newDesignSwitchActive",s);return p.setPersData({stateNewDesignSwitch:s});});};this._applyDarkMode=function(){return sap.ushell.Container.getServiceAsync("DarkModeSupport").then(function(d){if(C.last("/core/darkMode/enabled")&&d.canAutomaticallyToggleDarkMode()){d._toggleDarkModeBasedOnSystemColorScheme();}});};this._onThemeSwitchError=function(o,u,e,p){var i=o===sap.ushell.User.prototype.constants.NEW_DESIGN;u.setTheme(o);u.resetChangedProperty("theme");this.updateNewDesignSetting(i);L.error("Can not update selected theme",e);L.error("Error details",p);};this.setTheme=function(t){var n=t||"sap_fiori_3",u=this.getUser(),o=u.getTheme(sap.ushell.User.prototype.constants.themeFormat.ORIGINAL_THEME);if(n&&n!==o){u.setTheme(n);return this.updateUserPreferences(u).then(this._applyDarkMode.bind(this)).catch(this._onThemeSwitchError.bind(this,o,u));}return Promise.resolve();};}U.hasNoAdapter=false;return U;},true);
