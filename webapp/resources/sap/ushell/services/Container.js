// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/utils/UrlParsing","sap/ushell/utils","sap/ushell/System","sap/ushell/Ui5ServiceFactory","sap/ushell/Ui5NativeServiceFactory","sap/ui/base/EventProvider","sap/ui/core/service/ServiceFactoryRegistry","sap/ui/core/Control","sap/ui/performance/Measurement","sap/ui/thirdparty/URI","sap/ui/util/Mobile","sap/base/util/uid","sap/base/assert","sap/base/Log","sap/base/util/ObjectPath","sap/ui/thirdparty/jquery","sap/ushell/EventHub"],function(U,u,S,o,a,E,b,C,M,c,d,f,g,L,O,q,h){"use strict";var j="sap.ushell.services.Container",k="sap.ushell.Container.dirtyState.",l={},m,p,F,A=[];function n(){close();}function r(){document.location="about:blank";}function s(P){if(p&&p[P]){return p[P];}return"sap.ushell.adapters."+P;}function t(e){return(m.services&&m.services[e])||{};}function v(N,e,P,i,y){var z=t(N).adapter||{},B;function D(){return new(O.get(B))(e,P,{config:z.config||{}});}if(y===true){B=z.module;if(B===undefined){return(i?Promise.resolve():undefined);}}else{B=z.module||s(e.getPlatform())+"."+N+"Adapter";}var G=B.replace(/\./g,"/");if(i){return new Promise(function(H,I){sap.ui.require([G],function(){try{H(D());}catch(J){I(J);}},I);});}if(!sap.ui.require(G)){L.error("sap.ushell.Container.createAdapter. The adapter "+G+" must be loaded before use!");sap.ui.requireSync(G);}return D();}function w(y){var z=new E(),B=false,R=[],D={},G="sap.ushell.Container."+y.getSystem().getPlatform()+".remoteSystem.",H={},I,J,K=u.getLocalStorage(),N=new u.Map(),P=new u.Map(),Q="sap.ushell.Container."+y.getSystem().getPlatform()+".sessionTermination",T=this;this.cancelLogon=function(){if(this.oFrameLogonManager){this.oFrameLogonManager.cancelLogon();}};this.createRenderer=function(e,i){var X={async:!!i},Y,Z;M.start("FLP:Container.InitLoading","Initial Loading","FLP");u.setPerformanceMark("FLP - renderer created");e=e||m.defaultRenderer;if(!e){throw new Error("Missing renderer name");}Z=(m.renderers&&m.renderers[e])||{};Y=Z.module||(e.indexOf(".")<0?"sap.ushell.renderers."+e+".Renderer":e);if(Z.componentData&&Z.componentData.config){X.config=Z.componentData.config;}function $(){var b1=new(O.get(Y))({componentData:X}),c1=b1 instanceof sap.ui.core.UIComponent?new sap.ui.core.ComponentContainer({component:b1,height:"100%",width:"100%"}):b1;if(!(c1 instanceof C)){throw new Error("Unsupported renderer type for name "+e);}c1.placeAt=function(d1,e1){var f1=d1,g1="canvas",h1=document.body;if(d1===h1.id){f1=document.createElement("div");f1.setAttribute("id",g1);f1.classList.add("sapUShellFullHeight");switch(e1){case"first":if(h1.firstChild){h1.insertBefore(f1,h1.firstChild);break;}case"only":h1.innerHTML="";default:h1.appendChild(f1);}d1=g1;e1="";}C.prototype.placeAt.call(this,d1,e1);};D[e]=b1;if(i&&b1 instanceof sap.ui.core.UIComponent){return b1.rootControlLoaded().then(function(){z.fireEvent("rendererCreated",{renderer:b1});return c1;});}z.fireEvent("rendererCreated",{renderer:b1});return c1;}var a1=Y.replace(/\./g,"/");if(i){return new Promise(function(b1,c1){sap.ui.require([a1],function(){try{b1($());}catch(d1){c1(d1);}});});}L.error("sap.ushelContainer.createRenderer() should always be called with bAsync:true.");sap.ui.requireSync(a1);return $();};this.getRenderer=function(e){var i,X;e=e||m.defaultRenderer;if(e){i=D[e];}else{X=Object.keys(D);if(X.length===1){i=D[X[0]];}else{L.warning("getRenderer() - cannot determine renderer, because no default renderer is configured and multiple instances exist.",null,j);}}if(i&&i.isA("sap.ui.core.ComponentContainer")){return i.getComponentInstance();}return i;};this.DirtyState={CLEAN:"CLEAN",DIRTY:"DIRTY",MAYBE_DIRTY:"MAYBE_DIRTY",PENDING:"PENDING",INITIAL:"INITIAL"};this.getGlobalDirty=function(){var i,X=new q.Deferred(),Y=f(),Z,$=0,a1=this.DirtyState.CLEAN;function b1(){if($===0||a1===T.DirtyState.DIRTY){X.resolve(a1);L.debug("getGlobalDirty() Resolving: "+a1,null,"sap.ushell.Container");}}function c1(d1){if(d1.key.indexOf(k)===0&&d1.newValue!==T.DirtyState.INITIAL&&d1.newValue!==T.DirtyState.PENDING){L.debug("getGlobalDirty() Receiving event key: "+d1.key+" value: "+d1.newValue,null,"sap.ushell.Container");if(d1.newValue===T.DirtyState.DIRTY||d1.newValue===T.DirtyState.MAYBE_DIRTY){a1=d1.newValue;}$-=1;b1();}}try{K.setItem(Y,"CHECK");K.removeItem(Y);}catch(e){L.warning("Error calling localStorage.setItem(): "+e,null,"sap.ushell.Container");return X.resolve(this.DirtyState.MAYBE_DIRTY).promise();}if(I){throw new Error("getGlobalDirty already called!");}I=X;window.addEventListener("storage",c1);X.always(function(){window.removeEventListener("storage",c1);I=undefined;});for(i=K.length-1;i>=0;i-=1){Z=K.key(i);if(Z.indexOf(k)===0){if(K.getItem(Z)==="PENDING"){K.removeItem(Z);L.debug("getGlobalDirty() Cleanup of unresolved 'PENDINGS':"+Z,null,"sap.ushell.Container");}else{$+=1;u.localStorageSetItem(Z,this.DirtyState.PENDING,true);L.debug("getGlobalDirty() Requesting status for: "+Z,null,"sap.ushell.Container");}}}b1();setTimeout(function(){if(X.state()!=="resolved"){X.resolve("MAYBE_DIRTY");L.debug("getGlobalDirty() Timeout reached, - resolved 'MAYBE_DIRTY'",null,"sap.ushell.Container");}},$*2000);return X.promise();};this.getLogonSystem=function(){return y.getSystem();};this.getUser=function(){return y.getUser();};this.getDirtyFlag=function(){var e=B;var X=this._oShellNavigationService.getNavigationContext();for(var i=0;i<R.length;i++){e=e||R[i](X);}return e;};this.setDirtyFlag=function(i){B=i;};this.sessionKeepAlive=function(){if(y.sessionKeepAlive){y.sessionKeepAlive();}};this.extendSession=function(){h.emit("nwbcUserIsActive",Date.now());};this.registerDirtyStateProvider=function(e){if(typeof e!=="function"){throw new Error("fnDirty must be a function");}R.push(e);};this.deregisterDirtyStateProvider=function(e){if(typeof e!=="function"){throw new Error("fnDirty must be a function");}var X=-1;for(var i=R.length-1;i>=0;i--){if(R[i]===e){X=i;break;}}if(X===-1){return;}R.splice(X,1);};this.getService=function(e,i,X){return T._getService.apply(T,arguments);};this.getServiceAsync=function(e,i){return T._getService(e,i,true);};this._getService=function(e,i,X){var Y={},Z,$,a1,b1,c1,d1;function e1(i1){var j1=new q.Deferred();if(!i1){throw new Error("Missing system");}j1.resolve(v(e,i1,i));sap.ushell.Container.addRemoteSystem(i1);return j1.promise();}if(!e){throw new Error("Missing service name");}if(e.indexOf(".")>=0){throw new Error("Unsupported service name");}c1=t(e);Z=c1.module||"sap.ushell.services."+e;$=Z+"/"+(i||"");d1={config:c1.config||{}};function f1(i1,b1){Y.createAdapter=e1;return new i1(b1,Y,i,d1);}function g1(a1,X){var i1;if(N.containsKey($)){i1=N.get($);}else if(a1.hasNoAdapter){i1=new a1(Y,i,d1);}else{b1=v(e,y.getSystem(),i,X,a1.useConfigAdapterOnly);if(X){return b1.then(function(j1){var i1=f1(a1,j1);N.put($,i1);return i1;});}i1=f1(a1,b1);}N.put($,i1);return X?Promise.resolve(i1):i1;}if(!N.containsKey($)){if(X){if(!P.containsKey($)){var h1=new Promise(function(i1,j1){sap.ui.require([Z.replace(/[.]/g,"/")],function(k1){i1(g1(k1,true));},j1);});P.put($,h1);return h1;}return P.get($);}L.warning("Deprecated API call of 'sap.ushell.Container.getService'. Please use 'getServiceAsync' instead",null,"sap.ushell.services.Container");a1=sap.ui.requireSync(Z.replace(/[.]/g,"/"));return g1(a1);}if(X){return Promise.resolve(N.get($));}return N.get($);};function V(){var X,Y,i,Z;for(i=K.length-1;i>=0;i-=1){Z=K.key(i);if(Z.indexOf(G)===0){try{X=Z.substring(G.length);Y=JSON.parse(K.getItem(Z));H[X]=new S(Y);}catch(e){K.removeItem(Z);}}}return H;}function W(){if(typeof OData==="undefined"){return;}function e(i,X,Y){L.warning(i,null,"sap.ushell.Container");if(Y){setTimeout(Y.bind(null,i),5000);}return{abort:function(){return;}};}OData.read=function(i,X,Y){return e("OData.read('"+(i&&i.Uri?i.requestUri:i)+"') disabled during logout processing",X,Y);};OData.request=function(i,X,Y){return e("OData.request('"+(i?i.requestUri:"")+"') disabled during logout processing",X,Y);};}this.addRemoteSystem=function(e){var i=e.getAlias(),X=H[i];if(this._isLocalSystem(e)){return;}if(X){if(X.toString()===e.toString()){return;}L.warning("Replacing "+X+" by "+e,null,"sap.ushell.Container");}else{L.debug("Added "+e,null,"sap.ushell.Container");}H[i]=e;u.localStorageSetItem(G+i,e);};this._isLocalSystem=function(e){var i=e.getAlias();if(i&&i.toUpperCase()==="LOCAL"){return true;}var X=new c(u.getLocationHref()),Y=this.getLogonSystem().getClient()||"";if(e.getBaseUrl()===X.origin()&&e.getClient()===Y){return true;}return false;};this.addRemoteSystemForServiceUrl=function(e){var i,X={baseUrl:";o="};if(!e||e.charAt(0)!=="/"||e.indexOf("//")===0){return;}i=/^[^?]*;o=([^\/;?]*)/.exec(e);if(i&&i.length>=2){X.alias=i[1];}e=e.replace(/;[^\/?]*/g,"");if(/^\/sap\/(bi|hana|hba)\//.test(e)){X.platform="hana";X.alias=X.alias||"hana";}else if(/^\/sap\/opu\//.test(e)){X.platform="abap";}if(X.alias&&X.platform){this.addRemoteSystem(new S(X));}};this.attachLogoutEvent=function(e,X){var Y=false;if(X===true){g(typeof(e)==="function","Container.attachLogoutEvent: fnFunction must be a function");for(var i=0;i<A.length;i++){if(A[i]===e){Y=true;break;}}if(!Y){A.push(e);}}else{z.attachEvent("Logout",e);}};this.detachLogoutEvent=function(e){z.detachEvent("Logout",e);for(var i=0;i<A.length;i++){if(A[i]===e){A.splice(i,1);break;}}};this.attachRendererCreatedEvent=function(e){z.attachEvent("rendererCreated",e);};this.detachRendererCreatedEvent=function(e){z.detachEvent("rendererCreated",e);};this.defaultLogout=function(){var X=new q.Deferred();function Y(){y.logout(true).always(function(){K.removeItem(Q);X.resolve();});}function Z(){var e=new q.Deferred(),a1=e.promise(),b1=[];if(A.length>0){for(var i=0;i<A.length;i++){b1.push(A[i]());}Promise.all(b1).then(e.resolve);setTimeout(e.resolve,4000);}else{e.resolve();}a1.done(function(){if(z.fireEvent("Logout",true)){Y();}else{setTimeout(Y,1000);}});}function $(){var H,i=[];if(J){window.removeEventListener("storage",J);}u.localStorageSetItem(Q,"pending");T._suppressOData();H=T._getRemoteSystems();Object.keys(H).forEach(function(a1){try{i.push(v("Container",H[a1]).logout(false));}catch(e){L.warning("Could not create adapter for "+a1,e.toString(),"sap.ushell.Container");}K.removeItem(G+a1);});q.when.apply(q,i).done(Z);}if(typeof y.addFurtherRemoteSystems==="function"){y.addFurtherRemoteSystems().always($);}else{$();}return X.promise();};this.logout=this.defaultLogout;this.registerLogout=function(e){this.logout=e;};this.setLogonFrameProvider=function(e){if(this.oFrameLogonManager){this.oFrameLogonManager.logonFrameProvider=e;}};this.setXhrLogonTimeout=function(e,i){if(this.oFrameLogonManager){this.oFrameLogonManager.setTimeout(e,i);}};this.getFLPConfig=function(){var T=this,e=new Promise(function(i,X){var Y={URL:T.getFLPUrl()};if(l.CDMPromise){l.CDMPromise.then(function(Z){Z.getSiteWithoutPersonalization().then(function($){Y.scopeId=$.site.identification.id;i(Y);});});}else{i(Y);}});return e;};this.getFLPUrl=function(i){var e=u.getLocationHref(),X=e.indexOf(U.getShellHash(e));if(X===-1||i===true){return e;}return e.substr(0,X-1);};this.getFLPUrlAsync=function(i){return new q.Deferred().resolve(T.getFLPUrl(i)).promise();};this.inAppRuntime=function(){return false;};this.runningInIframe=this.inAppRuntime;this._getAdapter=function(){return y;};this.getFLPPlatform=function(){return Promise.resolve(m.flpPlatform);};this._closeWindow=n;this._redirectWindow=r;this._getRemoteSystems=V;this._suppressOData=W;sap.ui.getCore().getEventBus().subscribe("sap.ushell.Container","addRemoteSystemForServiceUrl",function(e,i,X){T.addRemoteSystemForServiceUrl(X);});if(typeof y.logoutRedirect==="function"){J=function(e){function i(){T._closeWindow();T._redirectWindow();}if(sap.ushell.Container!==T){return;}if(e.key.indexOf(G)===0&&e.newValue&&e.newValue!==K.getItem(e.key)){u.localStorageSetItem(e.key,e.newValue);}if(e.key===Q){if(e.newValue==="pending"){T._suppressOData();if(z.fireEvent("Logout",true)){i();}else{setTimeout(i,1000);}}}};window.addEventListener("storage",J);}this._getFunctionsForUnitTest=function(){return{createAdapter:v};};}function x(e,i){e.forEach(function(y){var z=o.createServiceFactory(y,i);b.register("sap.ushell.ui5service."+y,z);});}function _(e){e.forEach(function(i){var y=a.createServiceFactory(i);b.register("sap.ushell.ui5service."+i,y);});}sap.ushell.bootstrap=function(P,e){var i,D=new q.Deferred();d.init();if(sap.ushell.Container!==undefined){i=new Error("Unified shell container is already initialized - cannot initialize twice.\nStacktrace of first initialization:"+F);L.error(i,i.stack,j);throw i;}F=(new Error()).stack;m=q.extend({},true,window["sap-ushell-config"]||{});p=e;if(typeof window["sap.ushell.bootstrap.callback"]==="function"){setTimeout(window["sap.ushell.bootstrap.callback"]);}x(["Personalization","URLParsing","CrossApplicationNavigation"],true);x(["Configuration"],false);_(["CardNavigation","CardUserRecents","CardUserFrequents"]);var y=new S({alias:"",platform:m.platform||P});v("Container",y,null,true).then(function(z){z.load().then(function(){function B(){var J,K;var N=window["sap-ushell-config"];if(!N||!N.services){return false;}J=N.services.PluginManager;K=J&&J.config;return K&&K.loadPluginsFromSite;}sap.ushell.Container=new w(z);var G=[sap.ushell.Container.getServiceAsync("PluginManager")];if(B()){l.CDMPromise=sap.ushell.Container.getServiceAsync("CommonDataModel");G.push(l.CDMPromise);}Promise.all(G).then(function(J){var K=J[0];var N=J[1];var Q=N?N.getPlugins():q.when({});Q.then(function(R){var T=q.extend(true,{},m.bootstrapPlugins,R);K.registerPlugins(T);try{K.loadPlugins("EarlyLoading").catch(function(i){L.error("Error loading S/4's my home plugin");});}catch(i){L.error("Error loading S/4's my home plugin");}});}).then(function(){if(u.hasFLPReady2NotificationCapability()){sap.ui.require(["sap/ushell/NWBCInterface"],function(N){u.getPrivateEpcm().doEventFlpReady2(N);});}else if(u.hasFLPReadyNotificationCapability()){u.getPrivateEpcm().doEventFlpReady();}sap.ui.require(["sap/ushell/Config"],function(J){if(J.last("/core/darkMode/enabled")){sap.ushell.Container.getServiceAsync("DarkModeSupport").then(function(N){N.setup();});}if(J.last("/core/shellHeader/newDesignSwitchVisible")){var K=sap.ushell.Container.getUser().getTheme(sap.ushell.User.prototype.constants.themeFormat.ORIGINAL_THEME);if(K===sap.ushell.User.prototype.constants.NEW_DESIGN){J.emit("/core/shellHeader/newDesignSwitchActive",true);}}});});var H=[];if(m.preloadServices!==undefined&&Array.isArray(m.preloadServices)){m.preloadServices.forEach(function(J){H.push(sap.ushell.Container.getServiceAsync(J));});L.error("Ushell Config's preloadServices should not be used!");}var I=sap.ushell.Container.getServiceAsync("ShellNavigation").then(function(J){sap.ushell.Container._oShellNavigationService=J;});H.push(I);Promise.all(H).then(function(){D.resolve();});});});return D.promise();};});
