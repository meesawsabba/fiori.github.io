// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/resources","sap/base/util/ObjectPath","sap/ui/thirdparty/jquery","sap/ushell/library","sap/ushell/utils/chipsUtils","sap/base/Log"],function(r,O,q,u,c,L){"use strict";var D=u.DisplayFormat;function V(){this.S_COMPONENT_NAME="sap.ushell.services.VisualizationDataProvider";this._init.apply(this,arguments);}V.prototype._init=function(l){this.oLaunchPageAdapter=l;this.oCatalogTilePromise=null;};V.prototype._getCatalogTileIndex=function(){if(this._oCatalogTileIndexPromise){return this._oCatalogTileIndexPromise;}var l=this.oLaunchPageAdapter;return l._getCatalogTileIndex();};V.prototype._getCatalogTiles=function(){if(this.oCatalogTilePromise){return this.oCatalogTilePromise;}var l=this.oLaunchPageAdapter;this.oCatalogTilePromise=new Promise(function(a,b){l.getCatalogs().then(function(d){var e=[];var C=[];var f=[];var o={};for(var i=0;i<d.length;i++){if(typeof d[i].ui2catalog==="undefined"||d[i].ui2catalog.getType()!=="REMOTE"){e.push(l.getCatalogTiles(d[i]).then(function(g){C.push(g);}));}}q.when.apply(null,e).done(function(){f=[].concat.apply([],C);for(var y=0;y<f.length;y++){o[l.getCatalogTileId(f[y])]=f[y];}a(o);}).fail(b);}).fail(b);});return this.oCatalogTilePromise;};V.prototype.getVisualizationData=function(){var l=this.oLaunchPageAdapter,C;return Promise.all([this._getCatalogTiles(),this._getCatalogTileIndex()]).then(function(R){var o=R[0];var a=R[1];return Object.keys(o).reduce(function(d,i){C=o[i];var I=l.isTileIntentSupported(C);if(!I){return d;}var v=C.getChip().getBaseChipId();var t;if(!l.getCatalogTilePreviewTitle(C)){t=l.getCatalogTileView(C);}d.visualizations[i]={vizType:v,title:l.getCatalogTilePreviewTitle(C),subTitle:l.getCatalogTilePreviewSubtitle(C),icon:l.getCatalogTilePreviewIcon(C),info:l.getCatalogTilePreviewInfo(C),keywords:l.getCatalogTileKeywords(C),size:l.getCatalogTileSize(C),indicatorDataSource:l.getCatalogTilePreviewIndicatorDataSource(C),url:l.getCatalogTileTargetURL(C),numberUnit:l.getCatalogTileNumberUnit(C),isCustomTile:l.isCustomTile&&l.isCustomTile(C)};if(t){t.destroy();}if(a[i]){d.visualizations[i]._instantiationData={platform:"ABAP",simplifiedChipFormat:false,chip:a[i]};}if(d.visualizations[i].isCustomTile&&!d.vizTypes[v]){d.vizTypes[v]={id:v,url:undefined,vizOptions:{displayFormats:this._getDisplayFormats(C,d.visualizations[i].size)},tileSize:d.visualizations[i].size};}return d;}.bind(this),{visualizations:{},vizTypes:{},page:{}});}.bind(this)).catch(function(e){var E={component:this.S_COMPONENT_NAME,description:r.i18n.getText("VisualizationDataProvider.CannotLoadData"),detail:e};return Promise.reject(E);}.bind(this));};V.prototype._getDisplayFormats=function(C,t){var a=["tile"];var d="tile";var T=C.getContract("types");if(T){a=T.getAvailableTypes();d=T.getDefaultType();}return{supported:this._mapDisplayFormats(a,t),default:this._mapDisplayFormats([d],t)[0]};};V.prototype._mapDisplayFormats=function(d,t){var o={tile:D.Standard,tilewide:D.StandardWide,link:D.Compact,flat:D.Flat,flatwide:D.FlatWide};return d.map(function(s){s=o[s];if(s===D.Standard&&t==="1x2"){return D.StandardWide;}return s;});};V.prototype.loadVizType=function(b){var s={chipId:b};return c.loadChipInstanceFromSimplifiedChip(s).then(function(C){var S=c.getTileSize(C);return{id:b,url:undefined,vizOptions:{displayFormats:this._getDisplayFormats(C,S)},tileSize:S};}.bind(this)).catch(function(e){L.error("The chipInstance '"+b+"' could not be loaded: ",e);});};V.hasNoAdapter=false;return V;});
