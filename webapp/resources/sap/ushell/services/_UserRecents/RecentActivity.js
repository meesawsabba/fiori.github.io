// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["./UserRecentsBase","sap/ushell/library","sap/ushell/EventHub","sap/ui/Device","sap/base/Log"],function(U,u,E,D,L){"use strict";var A=u.AppType;var R=U.extend("sap.ushell.services.RecentActivity",{constructor:function(m){U.call(this,"RecentActivity",m,R._compareItems);}});R.MAX_DAYS=30;R.ITEM_COUNT=30;R._compareItems=function(a,b){if(a.appType===b.appType){if(a.appType!==A.APP){return a.url===b.url;}return a.appId===b.appId;}else if(a.appType===A.APP||b.appType===A.APP){return(a.appId===b.appId)&&(a.url===b.url);}return false;};R.prototype._updateIfAlreadyIn=function(i,t){return this.oRecentActivities.recentUsageArray.some(function(r){var f;if(R._compareItems(r.oItem,i)){if((i.appType===r.oItem.appType)||(i.appType!==A.APP)){jQuery.extend(r.oItem,i);r.iTimestamp=t;r.oItem.timestamp=t;r.mobile=undefined;r.tablet=undefined;r.desktop=undefined;if((i.appType===r.oItem.appType)||(i.appType!==A.APP&&r.oItem.appType!==A.APP)){r.aUsageArray[r.aUsageArray.length-1]+=1;r.iCount+=1;}this.oRecentActivities.recentUsageArray.sort(U._itemSorter);}f=true;}else{f=false;}return f;}.bind(this));};R.prototype._insertNew=function(i,t,I){i.timestamp=t;if(I){i.icon=I;}var n={oItem:i,iTimestamp:t,aUsageArray:[1],iCount:1,mobile:undefined,tablet:undefined,desktop:undefined};if(this.oRecentActivities.recentUsageArray.length===this.iMaxItems){this.oRecentActivities.recentUsageArray.pop();}this.oRecentActivities.recentUsageArray.unshift(n);};R.prototype.newItem=function(i){var d=new jQuery.Deferred();var t=Date.now();var I=this.getActivityIcon(i.appType,i.icon);var a;var c=this.getDayFromDateObj(new Date());this._load().done(function(l){this.oRecentActivities=this.getRecentActivitiesFromLoadedData(l);if(c!==this.oRecentActivities.recentDay){this.addNewDay();this.oRecentActivities.recentDay=c;}a=this._updateIfAlreadyIn(i,t);if(!a){this._insertNew(i,t,I);}this._save(this.oRecentActivities).done(function(){E.emit("newUserRecentsItem",this.oRecentActivities);d.resolve();}.bind(this)).fail(function(){d.reject();});}.bind(this));return d.promise();};R.prototype.getActivityIcon=function(a,i){switch(a){case A.SEARCH:return i||"sap-icon://search";case A.COPILOT:return i||"sap-icon://co";case A.URL:return i||"sap-icon://internet-browser";default:return i||"sap-icon://product";}};R.prototype.clearAllActivities=function(){var d=new jQuery.Deferred();this._save([]).done(function(){E.emit("userRecentsCleared",Date.now());d.resolve();}).fail(function(){d.reject();});return d.promise();};R.prototype.getRecentItemsHelper=function(m){var d=new jQuery.Deferred();var a;var o;var c;var i=false;var I=[];var b=[];var e=this.getDayFromDateObj(new Date());if(D.system.desktop){c="desktop";}else if(D.system.tablet){c="tablet";}else{c="mobile";}this._load().done(function(l){this.oRecentActivities=this.getRecentActivitiesFromLoadedData(l);var n=false;var M;if(e!==this.oRecentActivities.recentDay){this.addNewDay();this.oRecentActivities.recentDay=e;n=true;}for(a=0;a<this.oRecentActivities.recentUsageArray.length&&!i;a++){o=this.oRecentActivities.recentUsageArray[a];if(o[c]===undefined){if(!(o.oItem.url[0]==="#")){b.push(o.oItem.url);}else if(o.oItem.url.indexOf("?")>-1){M=o.oItem.url.substring(o.oItem.url.indexOf("?"));if(M.indexOf("&/")>-1){M=M.substring(0,M.indexOf("&/"));}I.push(o.oItem.appId+M);}else{I.push(o.oItem.appId);}}else{i=true;}}if(b.length>0){var f;for(a=0;a<this.oRecentActivities.recentUsageArray.length;a++){if(!(this.oRecentActivities.recentUsageArray[a].oItem.url[0]==="#")){f=this.oRecentActivities.recentUsageArray[a];f[c]=true;}}if(I.length<=0){this._save(this.oRecentActivities).done(function(){var g=this._getRecentItemsForDevice(c,this.oRecentActivities,m);d.resolve(g);}.bind(this)).fail(function(){d.reject();});}}if(I.length>0){sap.ushell.Container.getServiceAsync("CrossApplicationNavigation").then(function(C){C.isIntentSupported(I).done(function(r){i=false;for(a=0;a<this.oRecentActivities.recentUsageArray.length&&!i;a++){o=this.oRecentActivities.recentUsageArray[a];if(o[c]===undefined){M="";if(o.oItem.url.indexOf("?")>-1){M=o.oItem.url.substring(o.oItem.url.indexOf("?"));if(M.indexOf("&/")>-1){M=M.substring(0,M.indexOf("&/"));}}var h=r[o.oItem.appId+M];o[c]=!!(h&&h.supported);}else if(o.oItem.url[0]==="#"){i=true;}}this._save(this.oRecentActivities).done(function(){var g=this._getRecentItemsForDevice(c,this.oRecentActivities,m);d.resolve(g);}.bind(this)).fail(function(){d.reject();});}.bind(this)).fail(function(s){d.reject(s);});}.bind(this));}else if((I.length<=0)&&(b.length<=0)){if(n){this._save(this.oRecentActivities).done(function(){var g=this._getRecentItemsForDevice(c,this.oRecentActivities,m);d.resolve(g);}.bind(this)).fail(function(){d.reject();});}else{var g=this._getRecentItemsForDevice(c,this.oRecentActivities,m);d.resolve(g);}}}.bind(this)).fail(function(){d.reject();});return d.promise();};R.prototype._getRecentItemsForDevice=function(d,r,m){var a=[];var i=0;var o;for(var b=0;b<r.recentUsageArray.length&&(!m||i<m);b++){o=r.recentUsageArray[b];if(o[d]){a.push(o);i++;}}return a;};R.prototype.getRecentItems=function(){var d=new jQuery.Deferred();this.getRecentItemsHelper(R.ITEM_COUNT).done(function(r){d.resolve(jQuery.map(r,function(o){return o.oItem;}));}).fail(function(){d.reject();});return d.promise();};R.prototype.getFrequentItems=function(){var d=new jQuery.Deferred();this.getRecentItemsHelper().done(function(r){var c;var w=0;var f=[];var o;var p=r[0]?new Date(r[0].iTimestamp):undefined;var e;for(c=0;c<r.length&&w<R.MAX_DAYS;c++){o=r[c];if(o.iCount>1){f.push(o);}e=new Date(o.iTimestamp);if(p.toDateString()!==e.toDateString()){w++;p=e;}}f.sort(function(a,b){return b.iCount-a.iCount;});f=f.slice(0,R.ITEM_COUNT);d.resolve(jQuery.map(f,function(a){return a.oItem;}));}).fail(function(){d.reject();});return d.promise();};R.prototype.addNewDay=function(){var a,c;for(a=0;a<this.oRecentActivities.recentUsageArray.length;a++){if(this.oRecentActivities.recentUsageArray[a].aUsageArray){c=this.oRecentActivities.recentUsageArray[a].aUsageArray;}else{c=[];this.oRecentActivities.recentUsageArray[a].aUsageArray=c;this.oRecentActivities.recentUsageArray[a].iCount=0;}c[c.length]=0;if(c.length>R.MAX_DAYS){this.oRecentActivities.recentUsageArray[a].iCount-=c[0];c.shift();}}};R.prototype.getDayFromDateObj=function(d){return(d.getUTCFullYear()+"/"+(d.getUTCMonth()+1)+"/"+d.getUTCDate());};R.prototype.getRecentActivitiesFromLoadedData=function(l){var r;if(Array.isArray(l)){r={recentDay:null,recentUsageArray:l};}else{r=l||{recentDay:null,recentUsageArray:[]};}r.recentUsageArray=(r.recentUsageArray||[]).filter(function(a){var i=a&&a.oItem&&a.oItem.url;if(!i){L.error("FLP Recent Activity",a,"is not valid. The activity is removed from the list.");}return i;});return r;};return R;});
