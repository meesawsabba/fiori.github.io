// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["./UserRecentsBase","sap/base/Log","sap/ushell/utils"],function(U,L,u){"use strict";var R=U.extend("sap.ushell.services.RecentAppsUsage",{constructor:function(){U.call(this,"AppsUsage");}});R.MAX_DAYS=30;R.prototype.init=function(){var c=this.getDayFromDateObj(new Date());var d=false;if(this._oInitDeferred===undefined){this._oInitDeferred=new jQuery.Deferred();}if(!d||c!==this.oAppsUsageData.recentDay){d=true;this._load().done(function(a){this.oAppsUsageData=a||{recentDay:null,recentAppsUsageMap:{}};this.calculateInitialUsage(c);this._oInitDeferred.resolve(this.oAppsUsageData);}.bind(this)).fail(function(){L.error("UShell-lib ; RecentAppsUsage ; Load data in Init failed");this._oInitDeferred.reject();}.bind(this));}return this._oInitDeferred.promise();};R.prototype.calculateInitialUsage=function(c){if(c!==this.oAppsUsageData.recentDay){this.addNewDay();this.oAppsUsageData.recentDay=c;setTimeout(function(){this.cleanUnusedHashes();}.bind(this),3000);this.saveAppsUsage(this.oAppsUsageData);}};R.prototype.addAppUsage=function(h){if(!u.validHash(h)){return(new jQuery.Deferred()).reject("Non valid hash").promise();}return this.init().done(function(){var a=this.oAppsUsageData.recentAppsUsageMap[h]||[];if(a.length===0){a[0]=1;}else{a[a.length-1]+=1;}this.oAppsUsageData.recentAppsUsageMap[h]=a;this.saveAppsUsage(this.oAppsUsageData);}.bind(this)).fail(function(){L.error("Ushell-lib ; addAppUsage ; Initialization falied!");});};R.prototype.getAppsUsage=function(){var r;var d=new jQuery.Deferred();this.init().done(function(){r=this.summarizeUsage();d.resolve(r);}.bind(this)).fail(function(){d.reject("Not initialized yet");});return d.promise();};R.prototype.summarizeUsage=function(){var a={};var m,b;var f=true;for(var h in this.oAppsUsageData.recentAppsUsageMap){a[h]=this.getHashUsageSum(h);if(f){m=b=a[h];f=false;}else if(a[h]<b){b=a[h];}else if(a[h]>m){m=a[h];}}return{usageMap:a,maxUsage:m,minUsage:b};};R.prototype.addNewDay=function(){var a;for(var h in this.oAppsUsageData.recentAppsUsageMap){a=this.oAppsUsageData.recentAppsUsageMap[h];a[a.length]=0;if(a.length>R.MAX_DAYS){a=a.shift();}}};R.prototype.cleanUnusedHashes=function(){var i;for(var h in this.oAppsUsageData.recentAppsUsageMap){i=this.getHashUsageSum(h);if(i===0){delete(this.oAppsUsageData.recentAppsUsageMap[h]);}}};R.prototype.getHashUsageSum=function(h){var s=0;var d;var a=this.oAppsUsageData.recentAppsUsageMap[h];var l=a.length;for(d=0;d<l;d++){s+=a[d];}return s;};R.prototype.saveAppsUsage=function(o){return this._save(o).fail(function(){L.error("Ushell-lib ; saveAppsUsage ; Save action failed");});};R.prototype.getDayFromDateObj=function(d){return(d.getUTCFullYear()+"/"+(d.getUTCMonth()+1)+"/"+d.getUTCDate());};return R;});
