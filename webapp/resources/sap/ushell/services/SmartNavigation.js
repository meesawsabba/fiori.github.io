// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ushell/utils","sap/ushell/services/AppConfiguration","sap/base/Log","sap/ushell/utils/UrlParsing"],function(q,u,A,L,U){"use strict";function S(c,p,s){this._oServiceConfig=s;this._oCrossAppNavigationServicePromise=sap.ushell.Container.getServiceAsync("CrossApplicationNavigation");this._oPersonalizationServicePromise=sap.ushell.Container.getServiceAsync("Personalization");this._oHashCodeCache={"":0};}S.STATISTIC_COLLECTION_WINDOW_DAYS=90;S.PERS_CONTAINER_KEY_PREFIX="ushell.smartnav.";S.ONE_DAY_IN_MILLISECOND=24*60*60*1000;S.prototype.getLinks=function(a){var d=new q.Deferred();this._oCrossAppNavigationServicePromise.then(function(C){var o=C.getLinks(a);if(!this._isTrackingEnabled(this._oServiceConfig)){o.done(d.resolve).fail(d.reject);return;}var c=A.getCurrentApplication();var f=c.sShellHash;var b=c.componentHandle;if(c.componentHandle){b=c.componentHandle.getInstance();}if(!f){L.warning("Call to SmartNavigation#getLinks() simply delegated to CrossApplicationNavigation#getLinks()"+" because AppConfiguration#getCurrentApplication()#sShellHash evaluates to undefined.");o.done(d.resolve).fail(d.reject);return;}var n=this._getNavigationOccurrences(f,b);q.when(o,n).done(function(l,N){if(N.length===0){d.resolve(l);return;}var p=this._prepareLinksForSorting(l,N);l=p.sort(function(e,O){return O.clickCount-e.clickCount;});d.resolve(l);}.bind(this)).fail(d.reject);}.bind(this)).catch(d.reject);return d.promise();};S.prototype.toExternal=function(a){var b=arguments;this._oCrossAppNavigationServicePromise.then(function(C){if(!this._isTrackingEnabled(this._oServiceConfig)){C.toExternal.apply(C,b);return;}var c=A.getCurrentApplication();var f=c.sShellHash;var o=c.componentHandle;if(c.componentHandle){o=c.componentHandle.getInstance();}if(!f){L.warning("Current shell hash could not be identified. Navigation will not be tracked.",null,"sap.ushell.services.SmartNavigation");C.toExternal.apply(C,b);return;}var d=this._getHashFromOArgs(a.target);if(!d){L.warning("Destination hash does not conform with the ushell guidelines. Navigation will not be tracked.",null,"sap.ushell.services.SmartNavigation");C.toExternal.apply(C,b);return;}this._recordNavigationOccurrences(f,d,o).then(function(){C.toExternal.apply(C,b);});}.bind(this));};S.prototype.hrefForExternal=function(){L.warning("Deprecated API call of 'sap.ushell.services.SmartNavigation.hrefForExternal'. Please use 'hrefForExternalAsync' instead.",null,"sap.ushell.services.SmartNavigation");var C=sap.ushell.Container.getService("CrossApplicationNavigation");return C.hrefForExternal.apply(C,arguments);};S.prototype.hrefForExternalAsync=function(){var a=arguments;return this._oCrossAppNavigationServicePromise.then(function(C){return C.hrefForExternalAsync.apply(C,a);});};S.prototype.getPrimaryIntent=function(){var d=new q.Deferred();var a=arguments;this._oCrossAppNavigationServicePromise.then(function(C){C.getPrimaryIntent.apply(C,a).done(d.resolve).fail(d.reject);}).catch(d.reject);return d.promise();};S.prototype.trackNavigation=function(a){if(!this._isTrackingEnabled(this._oServiceConfig)){L.debug("Call to SmartNavigation#trackNavigation() ignored because Service is not enabled via Configuration",null,"sap.ushell.services.SmartNavigation");return q.when(null);}var t=a.target;var c=A.getCurrentApplication();var f=c.sShellHash;var d;if(!f){L.warning("Call to SmartNavigation#trackNavigation() simply ignored"+" because AppConfiguration#getCurrentApplication()#sShellHash evaluates to undefined.");return q.when(null);}d=this._getHashFromOArgs(t);if(!d){L.warning("Navigation not tracked - no valid destination provided",null,"sap.ushell.services.SmartNavigation");return q.when(null);}L.debug("Navigation to "+d+" was tracked out of "+f,null,"sap.ushell.services.SmartNavigation");return this._recordNavigationOccurrences(f,d,c.componentHandle.getInstance());};S.prototype._isTrackingEnabled=function(c){return u.isDefined(c)&&u.isDefined(c.config)&&u.isDefined(c.config.isTrackingEnabled)?c.config.isTrackingEnabled:false;};S.prototype._getHashCode=function(a){var s=a+"";if(this._oHashCodeCache[s]){return this._oHashCodeCache[s];}var h=0;var l=s.length;while(l--){h=(h<<5)-h+(s.charCodeAt(l)|0);h|=0;}this._oHashCodeCache[s]=h;return h;};S.prototype._getBaseHashPart=function(i){var t=U.parseShellHash(i);if(t&&t.semanticObject&&t.action){return t.semanticObject+"-"+t.action;}throw"Invalid intent `"+i+"`";};S.prototype._getHashFromOArgs=function(a){if(!a){return null;}if(a.shellHash&&U.parseShellHash(a.shellHash)){return this._getBaseHashPart(a.shellHash);}if(a.semanticObject&&a.action){return a.semanticObject+"-"+a.action;}return null;};S.prototype._getPersContainerKey=function(s){return S.PERS_CONTAINER_KEY_PREFIX+this._getHashCode(s);};S.prototype._getNavigationOccurrences=function(f,c){var d=new q.Deferred();var p=this._getPersContainerKey(f);this._oPersonalizationServicePromise.then(function(P){var C=P.getContainer(p,{keyCategory:P.constants.keyCategory.FIXED_KEY,writeFrequency:P.constants.writeFrequency.HIGH,clientStorageAllowed:true},c);C.done(function(o){var i=o.getItemKeys();var I=i.map(function(s){var a=o.getItemValue(s);var b=Object.keys(a.actions);return b.map(function(e){var g=a.actions[e];var h=g.dailyFrequency.reduce(function(j,k){return j+k;},0);return{intent:s+"-"+e,clickCount:h};});});var F=I.reduce(function(e,s){Array.prototype.push.apply(e,s);return e;},[]);d.resolve(F);});}).catch(d.reject);return d.promise();};S.prototype._prepareLinksForSorting=function(l,n){var N={};n.forEach(function(o){N[o.intent]=o;});l.forEach(function(o){var b=this._getBaseHashPart(o.intent);var a=N[b];o.clickCount=a?a.clickCount:0;}.bind(this));return l;};S.prototype._recordNavigationOccurrences=function(f,t,c){var T=U.parseShellHash(t);var p=this._getPersContainerKey(f);var s=T.semanticObject;var d=new q.Deferred();this._oPersonalizationServicePromise.then(function(P){var C=P.getContainer(p,{keyCategory:P.constants.keyCategory.FIXED_KEY,writeFrequency:P.constants.writeFrequency.HIGH,clientStorageAllowed:true},c);C.done(function(o){var a=o.getItemValue(s);var b=T.action;if(!a){a={actions:{},latestVisit:Date.now(),dailyFrequency:[0]};}var e=a.actions[b];if(!e){e={latestVisit:Date.now(),dailyFrequency:[0]};a.actions[b]=e;}this._updateHistoryEntryWithCurrentUsage(a);this._updateHistoryEntryWithCurrentUsage(e);o.setItemValue(s,a);o.save().done(d.resolve).fail(d.reject);}.bind(this)).fail(d.reject);}.bind(this)).catch(d.reject);return d.promise();};S.prototype._updateHistoryEntryWithCurrentUsage=function(h){var n=Date.now();var t=n-h.latestVisit;var d=Math.floor(t/S.ONE_DAY_IN_MILLISECOND);while(d--){h.dailyFrequency.unshift(0);if(h.dailyFrequency.length>S.STATISTIC_COLLECTION_WINDOW_DAYS){h.dailyFrequency.pop();}}++h.dailyFrequency[0];h.latestVisit=n;return h;};S.hasNoAdapter=true;return S;});
