// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/services/AppConfiguration","sap/ushell/utils","sap/ushell/utils/UrlParsing","sap/ushell/utils/UrlShortening","sap/ushell/navigationMode","sap/ui/thirdparty/jquery","sap/ui/performance/Measurement","sap/base/util/deepExtend","sap/base/util/isPlainObject","sap/base/util/UriParameters","sap/base/Log"],function(b,u,U,c,n,q,M,d,e,f,L){"use strict";function N(A,C,p,s){var S=s&&s.config,r=function(h){var a=this._isClientSideTargetResolutionEnabled()?this._resolveHashFragmentClientSide(h):A.resolveHashFragment(h);return a;}.bind(this),l,R=[{name:"DefaultAdapter",isApplicable:function(){return true;},resolveHashFragment:r.bind(this)}],o;this._isClientSideTargetResolutionEnabled=function(){return!!(S&&S.enableClientSideTargetResolution);};this._nextResolveHashFragment=function(a,h){var g=a.pop();if(g.isApplicable(h)){L.info("NavTargetResolution: custom resolver "+g.name+" resolves "+h);var i=this._nextResolveHashFragment.bind(this,a);return g.resolveHashFragment(h,i);}return this._nextResolveHashFragment(a,h);};this._resolveHashFragmentClientSide=function(h){var H=this._validateHashFragment(h),F;if(!H.success){return new q.Deferred().reject(h+" is not a valid hash fragment").promise();}F=H.hashFragmentWithoutHash;return this._resolveHashFragmentClientSideAndFixApplicationType(F);};this._resolveHashFragmentClientSideAndFixApplicationType=function(F){var D=new q.Deferred();sap.ushell.Container.getServiceAsync("ClientSideTargetResolution").then(function(a){a.resolveHashFragment(F).done(function(g){if(g&&g.applicationType==="SAPUI5"){g.applicationType="URL";}D.resolve(g);}).fail(D.reject);}).catch(D.reject);return D.promise();};this._validateHashFragment=function(h){var H="",v={success:false};if(h&&h.charAt(0)!=="#"){throw new u.Error("Hash fragment expected in _validateHashFragment","sap.ushell.services.NavTargetResolution");}H=h.substring(1);if(H){v.success=true;}v.hashFragmentWithoutHash=H;return v;};this.expandCompactHash=function(h){var P,D=new q.Deferred();P=U.parseShellHash(h);if(P&&P.params&&P.params["sap-intent-param"]){sap.ushell.Container.getServiceAsync("AppState").then(function(a){a.getAppState(P.params["sap-intent-param"][0]).done(function(g){var v=g.getData("sap-intent-param");var H=h;if(v){H=c.expandParamGivenRetrievalFunction(h,"sap-intent-param",function(){return v;});}D.resolve(H);}).fail(function(){D.resolve(h);});}).catch(D.reject);}else{D.resolve(h);}return D.promise();};var w=["NWBC","WDA","TR"];this._adjustResolutionResultForUi5Components=function(a){var m,g;if(typeof a!=="object"){return;}delete a["sap.platform.runtime"];if(a&&a.applicationType&&a.applicationType==="SAPUI5"){a.applicationType="URL";}if(a.applicationType==="URL"){m=/^SAPUI5\.Component=(.*)/.exec(a.additionalInformation);g=m&&m[1];if(g){a.ui5ComponentName=g;}}};this._getSapSystem=function(h,a){var g;if(a&&a["sap-system"]){return a["sap-system"];}if(a&&a.url){g=(new f(a.url)).get("sap-system");if(g){return g;}}if(w.indexOf(a.applicationType)>=0&&h&&h.substring(1)){g=(new f(h.substring(1))).get("sap-system");if(g){return g;}}return undefined;};this.resolveTarget=function(a){var h;var g=d({},a);var D=new q.Deferred();M.average("sap.ushell.navigation.resolveTarget");u.storeSapSystemToLocalStorage(g);h=U.constructShellHash(g);sap.ushell.Container.getServiceAsync("NavTargetResolution").then(function(i){i.resolveHashFragment("#"+h).done(function(j){M.end("sap.ushell.navigation.resolveTarget");D.resolve({url:j.url,text:j.text,externalNavigationMode:j.externalNavigationMode});}).fail(D.reject);}).catch(D.reject);return D.promise();};this.resolveHashFragment=function(h){var D=new q.Deferred();M.average("sap.ushell.navigation.resolveHashFragment");this.expandCompactHash(h).done(function(H){var E=q.when();if(H.indexOf("sap-ushell-enc-test")>=0){var m=/sap-ushell-enc-test=([^&]*)(&.*)?$/.exec(H);if(m){var a=m[1];if(a!=="A%20B%2520C"){E=new q.Deferred();sap.ushell.Container.getServiceAsync("Message").then(function(g){g.error("This navigation is flagged as erroneous because"+" (likely the calling procedure) generated a wrong encoded hash."+" Please track down the encoding error and make sure to use the CrossApplicationNavigation service for navigation.","Navigation encoding wrong");E.resolve();}).catch(E.reject);}H=H.replace(/sap-ushell-enc-test=([^&]*)&/,"");H=H.replace(/[&?]sap-ushell-enc-test=([^&]*)$/,"");}}var P=this._invokeResolveHashChain(H);if(typeof A.processPostResolution==="function"){P=A.processPostResolution(H,P);}q.when(P,E).done(function(g){this._adjustResolutionResultForUi5Components(g);if(e(g)){if(!g.hasOwnProperty("navigationMode")){g.navigationMode=n.getNavigationMode(g,b.getCurrentApplication());}g.targetNavigationMode=n.getExternalNavigationMode(g.navigationMode);}if(e(g)&&!g.hasOwnProperty("sap-system")){var i=this._getSapSystem(h,g);if(i){g["sap-system"]=i;}}M.end("sap.ushell.navigation.resolveHashFragment");D.resolve(g);}.bind(this)).fail(D.reject);}.bind(this)).fail(D.reject);return D.promise();};this._invokeResolveHashChain=function(h){var g=R.map(function(a){return a;});return this._nextResolveHashFragment(g,h).done(function(a){o=a;});};this.baseResolveHashFragment=r.bind(this);this._getGetLinksResolver=function(a){var g;if(this._isClientSideTargetResolutionEnabled()){g=this._getLinksClientSide.bind(this);return{resolver:g,warning:undefined,isGetSemanticObjectLinksCall:false};}if(Object.prototype.toString.apply(a.paramsOptions)==="[object Array]"&&a.paramsOptions.length>0){L.warning("Parameter options supplied to #getLinks will be ignored because FLP is not configured to use sap.ushell.services.ClientSideTargetResolution for target resolution","provided parameters options: "+JSON.stringify(a.paramsOptions,null,4),"sap.ushell.services.NavTargetResolution");}g=A&&A.getLinks&&A.getLinks.bind(A);if(g){return{resolver:g,warning:undefined,isGetSemanticObjectLinksCall:false};}g=A&&A.getSemanticObjectLinks&&A.getSemanticObjectLinks.bind(A);if(g){return{resolver:g,warning:a.hasOwnProperty("action")?"the action argument was given, however, NavTargetResolutionAdapter does not implement getLinks method. Action will be ignored.":undefined,isGetSemanticObjectLinksCall:true};}return{resolver:undefined,warning:"Cannot determine resolver for getLinks method",isGetSemanticObjectLinksCall:undefined};};this.getLinks=function(a){var g=a.semanticObject;var P=a.params;var i=a.ignoreFormFactor;var h=a.ui5Component;var j=a.appStateKey;var k=a.compactIntents;var D=new q.Deferred();if(/\?/.test(g)){throw new Error("Parameter must not be part of semantic object");}var m=(P===undefined)?undefined:JSON.parse(JSON.stringify(P));if(j){m=m||{};m["sap-xapp-state"]=encodeURIComponent(j);}var t=this._getGetLinksResolver(a);if(t.warning){L.warning("A problem occurred while determining the resolver for getLinks",t.warning,"sap.ushell.services.NavTargetResolution");}var v=t.resolver;if(v){var H=function(y){if(k){this._shortenGetSemanticObjectLinksResults(y,h).done(D.resolve);}else{D.resolve(y);}}.bind(this);if(t.isGetSemanticObjectLinksCall){var x={target:{semanticObject:g,action:"dummyAction"},params:m};sap.ushell.Container.getServiceAsync("ShellNavigation").then(function(y){y.hrefForExternal(x,true,h,true).done(function(z){var B=z.params||m;v(g,B,i).done(H).fail(D.reject);}).fail(D.reject);});}else{v(a).done(H).fail(D.reject);}}else{D.resolve([]);}return D.promise();};this.getDistinctSemanticObjects=function(){var D=new q.Deferred();if(this._isClientSideTargetResolutionEnabled()){sap.ushell.Container.getServiceAsync("ClientSideTargetResolution").then(function(a){a.getDistinctSemanticObjects().done(D.resolve).fail(D.reject);}).catch(D.reject);return D.promise();}if(A&&A.getDistinctSemanticObjects){return A.getDistinctSemanticObjects.call(A);}L.error("Cannot execute getDistinctSemanticObjects method","ClientSideTargetResolution must be enabled or NavTargetResolutionAdapter must implement getDistinctSemanticObjects method","sap.ushell.services.NavTargetResolution");return D.reject("Cannot execute getDistinctSemanticObjects").promise();};this._getLinksClientSide=function(a){var D=new q.Deferred();var g=new q.Deferred();if((a.params||{}).hasOwnProperty("sap-intent-param")){var h="#"+a.semanticObject+"-dummyAction?"+U.paramsToString(a.params);this.expandCompactHash(h).done(function(E){var P=U.parseShellHash(E);g.resolve(P.params);}).fail(D.reject);}else{g.resolve(a.params);}g.done(function(){sap.ushell.Container.getServiceAsync("ClientSideTargetResolution").then(function(i){i.getLinks(a).done(D.resolve).fail(D.reject);}).catch(D.reject);});return D.promise();};this._shortenGetSemanticObjectLinksResults=function(g,a){var h=[];var i=0;var P=g.length;var D=new q.Deferred();sap.ushell.Container.getServiceAsync("ShellNavigation").then(function(j){g.forEach(function(I){var k=U.parseShellHash(I.intent);var m=j.compactParams(k.params,undefined,a);h.push(m);h[i].done(function(t,v){h[t]={text:I.text,intent:"#"+k.semanticObject+"-"+k.action+"?"+U.paramsToString(v)};}.bind(null,i)).fail(function(t,v){L.warning("Cannot shorten GetSemanticObjectLinks result, using expanded form","Failure message: "+v+"; intent had title ''"+I.title+"'' and link ''"+I.intent+"'","sap.ushell.services.NavTargetResolution");h[t]={text:I.text,intent:I.intent};}.bind(null,i)).always(function(){P--;if(P===0){D.resolve(h);}});i++;});}).catch(D.reject);return D.promise();};this.isIntentSupported=function(i){var m={};var D=new q.Deferred();if(this._isClientSideTargetResolutionEnabled()){sap.ushell.Container.getServiceAsync("ClientSideTargetResolution").then(function(a){a.isIntentSupported(i).done(D.resolve).fail(D.reject);}).catch(D.reject);return D.promise();}if(A.isIntentSupported){return A.isIntentSupported(i);}i.forEach(function(I){m[I]={supported:undefined};});return D.resolve(m).promise();};this.isNavigationSupported=function(i){var D=new q.Deferred(),I=[];I=i.map(function(a){if(typeof a==="string"){return a;}return"#"+U.constructShellHash(a);});this.isIntentSupported(I).done(function(a){var g=I.map(function(h){return a[h]||{supported:false};});D.resolve(g);}).fail(D.reject.bind(D));return D.promise();};this.registerCustomResolver=function(a){if(typeof a.name!=="string"){L.error("NavTargetResolution: Custom Resolver must have name {string} member");return false;}if(typeof a.isApplicable!=="function"){L.error("NavTargetResolution: Custom Resolver must have isApplicable member");return false;}if(typeof a.resolveHashFragment!=="function"){L.error("NavTargetResolution: Custom Resolver must have \"resolveHashFragment\" member");return false;}R.push(a);return true;};if(S&&Array.isArray(S.resolveLocal)){l=S.resolveLocal.map(function(a){return a.linkId;});this.registerCustomResolver({name:"localResolveNavigationResolver",cleanHash:function(h){if(h===""){return"#";}var a=U.parseShellHash(h.substring(1));if(!a){return"#";}h="#"+a.semanticObject+"-"+a.action;return h;},_getIndex:function(O){var h=this.cleanHash(O);return l.indexOf(h.substring(1));},isApplicable:function(O){return this._getIndex(O)>=0;},resolveHashFragment:function(h){var D,i=this._getIndex(h),a,g,j,k;D=new q.Deferred();a=JSON.parse(JSON.stringify(S.resolveLocal[i].resolveTo));g=U.parseShellHash(h);if(g&&g.params){k=U.paramsToString(g.params);if(k){j=a.url.indexOf("?")>=0;a.url=a.url+(j?"&":"?")+k;}}D.resolve(a);return D.promise();}});}this.registerCustomResolver({name:"LocalResolver",aElement:undefined,cleanHash:function(h){if(h===""){return undefined;}var a=U.parseShellHash(h.substring(1));if(!a){return undefined;}h="#"+a.semanticObject+"-"+a.action;return h;},isApplicable:function(h){h=this.cleanHash(h);if(!h){return false;}return h==="#Test-url"||h==="#Test-local1"||h==="#Test-local2"||h==="#Test-config"||h==="#Test-clear";},parseUrl:function(a){if(!this.aElement){this.aElement=window.document.createElement("a");}this.aElement.href=a;return this.aElement;},resolveHashFragment:function(h){var D=new q.Deferred(),a=null,g,i,j,P,k,t=this;h=this.cleanHash(h);if(!h){return false;}a={"#Test-config":{applicationType:"URL",url:"/sap/bc/ui5_ui5/ui2/ushell/test-resources/sap/ushell/demoapps/FioriSandboxConfigApp",additionalInformation:"SAPUI5.Component=sap.ushell.demoapps.FioriSandboxConfigApp"},none:{applicationType:"URL",url:"",additionalInformation:""}};function m(K){if(localStorage){return localStorage[K];}return undefined;}function v(z){if(u.calculateOrigin(t.parseUrl(z))!==u.calculateOrigin(window.location)){return undefined;}return z;}function x(K){return(new f(window.location.href)).get(K);}function y(K,V){if(localStorage){localStorage[K]=V;}}if(a[h]){g=a[h];}else if(h==="#Test-clear"){y("sap.ushell.#Test-local1",undefined);y("sap.ushell.#Test-local2",undefined);L.info("NavTargetResolution: Local storage keys for #Test have been cleared");g=a["#Test-config"];}else if(h==="#Test-local1"||h==="#Test-local2"||h==="#Test-url"){g=m("sap.ushell."+h);if(!g||g==="undefined"){i={applicationType:"URL"};}else{i=JSON.parse(g);}if((window.location.hostname==="localhost")||(S&&S.allowTestUrlComponentConfig)){P="sap-ushell-test-"+h.substring(6);j=x(P+"-additionalInformation");if(j){i.additionalInformation=j;}k=x(P+"-url");if(k){i.url=v(k);}}if(!i.url){L.info("NavTargetResolution: No configured app for "+h+" found ( local storage or url params sap-ushell-test-local1-url  sap-ushell-test-local1-additionalInfo  not supplied? ");L.info("NavTargetResolution: Defaulting to config app ...\n");D.reject("URL is not resolvable");return D.promise();}i.url=v(i.url);g=i;}if(g.url===undefined){D.reject("URL is not resolvable");return D.promise();}L.info("NavTargetResolution: As URL:  http://localhost:8080/sap/bc/ui5_ui5/ui2/ushell/shells/abap/FioriLaunchpad.html?sap-ushell-test-local1-url="+encodeURIComponent((g&&g.url)||"")+"&sap-ushell-test-local1-additionalInformation="+encodeURIComponent((g&&g.additionalInfo)||"")+"#Test-local1");L.info("NavTargetResolution: Resolving "+h+" to "+JSON.stringify(g));D.resolve(g);return D.promise();}});this.getCurrentResolution=function(){return o;};}N.hasNoAdapter=false;return N;},true);
