/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2021 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/base/Object","sap/fe/core/AnnotationHelper","sap/fe/core/actions/draft","sap/fe/core/actions/sticky","sap/fe/core/actions/operations","sap/ui/model/json/JSONModel","sap/m/Popover","sap/m/VBox","sap/m/CheckBox","sap/m/Text","sap/m/Button","sap/m/MessageToast","sap/m/Dialog","sap/ui/model/BindingMode","sap/base/Log","sap/ui/core/message/Message","sap/fe/core/CommonUtils","sap/fe/core/BusyLocker","sap/ui/core/util/XMLPreprocessor","sap/ui/core/XMLTemplateProcessor","sap/ui/core/Fragment","sap/m/MessageBox","sap/fe/core/helpers/ModelHelper","sap/fe/core/library","sap/ui/core/ValueState","sap/fe/core/actions/messageHandling"],function(B,A,d,s,o,J,P,V,C,T,a,M,D,b,L,c,e,f,X,g,F,h,j,k,l,m){"use strict";var n=k.CreationMode,p=k.ProgrammingModel;function q(i){if(i&&i.getMetadata&&i.getMetadata().getName()==="sap.ui.base.Event"){i={};}return i||{};}return B.extend("sap.fe.core.TransactionHelper",{constructor:function(i,r){this._oAppComponent=i;this.oLockObject=r;},getProgrammingModel:function(i){if(!this.sProgrammingModel&&i){if(j.isDraftSupported(i.getModel().getMetaModel(),i.getPath())){this.sProgrammingModel=p.Draft;}else if(j.isStickySessionSupported(i.getModel().getMetaModel())){this.sProgrammingModel=p.Sticky;}else{return p.NonDraft;}}return this.sProgrammingModel;},createDocument:function(i,r,R,t,u){var N,v=this,S,w=i.getModel(),x=w.getMetaModel(),y=x.getMetaPath(i.getHeaderContext().getPath()),z=this._getAppComponent().getRouterProxy().getHash(),E=this._getAppComponent().getComponentData(),G=(E&&E.startupParameters)||{},H=!i.isRelative()?this._getNewAction(G,z,x,y):undefined,I,K={"$$patchWithoutSideEffects":true},O=x.getObject(y+"/@com.sap.vocabularies.Common.v1.Messages/$Path"),Q,U="/busy",W=x.getObject(y+"@com.sap.vocabularies.Common.v1.DefaultValuesFunction")||x.getObject(j.getTargetEntitySet(x.getContext(y))+"@com.sap.vocabularies.Common.v1.DefaultValuesFunction");if(O){K["$select"]=O;}r=q(r);if(!i){return Promise.reject("Binding required for new document creation");}Q=this.getProgrammingModel(i);if(Q!==p.Draft&&Q!==p.Sticky){return Promise.reject("Create document only allowed for draft or sticky session supported services");}if(r.busyMode==="Local"){U="/busyLocal/"+i.sId;}f.lock(this.oLockObject,U);S=!r.refreshList;var Y=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core");if(H){I=this.callAction(H,{contexts:i.getHeaderContext(),showActionParameterDialog:true,label:Y.getText("C_TRANSACTION_HELPER_SAPFE_ACTION_CREATE"),bindingParameters:K,parentControl:r.parentControl,bIsCreateAction:true},null,t);}else{var Z=r.creationMode!==n.CreationRow&&r.creationMode!==n.Inline;var $=Z?e.getNonComputedVisibleFields(x,y):[];W=u?null:W;I=o.callFunctionImport(W,w).then(function(_){if(_){return _.getObject();}else{return undefined;}}).catch(function(_){L.error("Error while calling function Import "+W,_);throw _;}).then(function(_){r.data=_?Object.assign({},_,r.data):r.data;if(r.data){delete r.data["@odata.context"];}if($.length>0){var a1=w.bindList(i.getPath(),i.getContext(),[],[],{$$updateGroupId:"submitLater"});a1.refreshInternal=function(){};N=a1.create(r.data,S);return v._launchDialogWithKeyFields(i,a1,N,$,w,r,t,W);}else{N=i.create(r.data,S,r.createAtEnd);return v.onAfterCreateCompletion(i,N,r,Y);}}).catch(function(_){L.error("Error while creating the new document",_);throw _;});}return I.then(function(_){if(!i.isRelative()){v._bCreateMode=true;}N=N||(_&&_.response);if(_&&_.bConsiderDocumentModified){v.handleDocumentModifications();}return t.showMessageDialog().then(function(){return N;});}).catch(function(_){return t.showMessageDialog().then(function(){if(_&&_.bDeleteTransientContext&&N.isTransient()){N.delete("$direct");}return Promise.reject(_);});}).finally(function(){f.unlock(v.oLockObject,U);});},findActiveDraftRootContexts:function(i,r){if(!r){return Promise.resolve();}var t=i.reduce(function(R,u){var v=u.getModel().getMetaModel();var w=v.getMetaPath(u.getPath());if(v.getObject(w+"@com.sap.vocabularies.Common.v1.DraftRoot")){var I=u.getObject().IsActiveEntity,H=u.getObject().HasActiveEntity,x;if(!I&&H){x=u.getModel().bindContext(u.getPath()+"/SiblingEntity").getBoundContext();R.push(x);}}return R;},[]);return Promise.all(t.map(function(u){return u.requestCanonicalPath().then(function(){return u;},function(){return;});}));},afterDeleteProcess:function(i,r,t,R){var I=i.internalModelContext;if(I&&I.getProperty("deleteEnabled")!=undefined){if(r.isCheckBoxVisible===true&&r.isCheckBoxSelected===false){I.setProperty("deleteEnabled",true);var u=Object.assign(I.getObject(),{});u.selectedContexts=u.selectedContexts.filter(function(v){return u.deletableContexts.indexOf(v)===-1;});u.deletableContexts=[];u.selectedContexts=[];u.numberOfSelectedContexts=u.selectedContexts.length;I.setProperty("",u);}else{I.setProperty("deleteEnabled",false);I.setProperty("selectedContexts",[]);I.setProperty("numberOfSelectedContexts",0);}}if(t.length===1){M.show(e.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_DELETE_TOAST_SINGULAR",R,null,i.entitySetName));}else{M.show(e.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_DELETE_TOAST_PLURAL",R,null,i.entitySetName));}},deleteDocument:function(v,r,R,t){var u,w,x=[],y=false,z=false,E=false,G,H=false,I=this,K=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core"),N,O={title:K.getText("C_COMMON_OBJECT_PAGE_DELETE")};f.lock(this.oLockObject);if(!Array.isArray(v)){v=[v];}Promise.resolve(this.getProgrammingModel(v[0])).then(function(Q){if(r){if(!r.numberOfSelectedContexts){if(Q===p.Draft){for(var i=0;i<v.length;i++){var S=v[i].getObject();if(S.IsActiveEntity===true&&S.HasDraftEntity===true&&S.DraftAdministrativeData&&S.DraftAdministrativeData.InProcessByUser&&!S.DraftAdministrativeData.DraftIsCreatedByMe){h.show(e.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_SINGLE_OBJECT_LOCKED",R),{title:K.getText("C_COMMON_OBJECT_PAGE_DELETE"),onClose:u});return;}}}r=q(r);if(r.title){if(r.description){N=[r.title,r.description];O.text=e.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO",R,N,r.entitySetName);}else{O.text=e.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR",R,null,r.entitySetName);}}else{O.text=e.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR",R);}x=v;}else{O={title:K.getText("C_COMMON_OBJECT_PAGE_DELETE")};if(r.numberOfSelectedContexts===1&&r.numberOfSelectedContexts===v.length){x=v;O.text=e.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR",R,null,r.entitySetName);}else if(r.numberOfSelectedContexts===1&&r.unSavedContexts.length===1){x=r.unSavedContexts;var U=x[0].getObject()["DraftAdministrativeData"];var W="";if(U){W=U["LastChangedByUserDescription"]||U["LastChangedByUser"]||"";}N=[W];O.text=e.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_UNSAVED_CHANGES",R,N);}else if(r.numberOfSelectedContexts===r.unSavedContexts.length){x=r.unSavedContexts;O.text=e.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_UNSAVED_CHANGES_MULTIPLE_OBJECTS",R);}else if(r.numberOfSelectedContexts===v.concat(r.unSavedContexts.concat(r.lockedContexts)).length){x=v.concat(r.unSavedContexts);O.text=x.length===1?e.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR",R,null,r.entitySetName):e.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_PLURAL",R,null,r.entitySetName);}else{x=v.concat(r.unSavedContexts);E=true;O.text=x.length===1?e.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR_NON_DELETABLE",R,null,r.entitySetName):e.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE_PLURAL_NON_DELETABLE",R,null,r.entitySetName);O.nonDeletableText=e.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_NON_DELETABLE",R,[r.numberOfSelectedContexts-v.concat(r.unSavedContexts).length,r.numberOfSelectedContexts]);}if(r.lockedContexts.length==1){z=true;O.nonDeletableText=e.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_ONE_OBJECT_LOCKED",R,[r.numberOfSelectedContexts]);}if(r.lockedContexts.length>1){z=true;O.nonDeletableText=e.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_LOCKED",R,[r.lockedContexts.length,r.numberOfSelectedContexts]);}if(r.unSavedContexts.length>0&&r.unSavedContexts.length!==r.numberOfSelectedContexts){if((E||z)&&x.length===r.unSavedContexts.length){y=false;x=r.unSavedContexts;if(r.unSavedContexts.length===1){O.text=e.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_UNSAVED_AND_FEW_OBJECTS_LOCKED_SINGULAR",R);}else{O.text=e.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_UNSAVED_AND_FEW_OBJECTS_LOCKED_PLURAL",R);}}else{if(r.unSavedContexts.length===1){O.checkBoxText=e.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_UNSAVED_SINGULAR",R);}else{O.checkBoxText=e.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_UNSAVED_PLURAL",R);}y=true;}}if(E&&z){if(r.unSavedContexts.length>1){O.nonDeletableText=e.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_LOCKED_AND_NON_DELETABLE",R,[r.numberOfSelectedContexts-v.concat(r.unSavedContexts).length-r.lockedContexts.length,r.lockedContexts.length,r.numberOfSelectedContexts]);}if(r.unSavedContexts.length==1){O.nonDeletableText=e.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO_AND_ONE_OBJECT_LOCKED_AND_NON_DELETABLE",R,[r.numberOfSelectedContexts-v.concat(r.unSavedContexts).length-r.lockedContexts.length,r.numberOfSelectedContexts]);}}}}var Y,Z,$=new V({items:[(Y=new T({text:O.nonDeletableText,visible:z||E})),(Z=new T({text:O.text})),new C({text:O.checkBoxText,selected:true,select:function(c1){var d1=c1.getSource().getSelected();if(d1){x=v.concat(r.unSavedContexts);G=true;}else{x=v;G=false;}},visible:y})]});var _=K.getText("C_COMMON_OBJECT_PAGE_DELETE");var a1=function(){H=true;f.lock(I.oLockObject);var c1=x;return I.findActiveDraftRootContexts(c1,r.bFindActiveContexts).then(function(d1){return Promise.all(c1.map(function(e1){return d.deleteDraft(e1);})).catch(function(e1){return t.showMessageDialog().then(function(){throw e1;});}).then(function(){var e1={"isCheckBoxVisible":y,"isCheckBoxSelected":G};if(d1&&d1.length){return Promise.all(d1.map(function(f1){return f1.delete();})).then(function(){I.afterDeleteProcess(r,e1,c1,R);return t.showMessageDialog().then(w);});}else{I.afterDeleteProcess(r,e1,c1,R);return t.showMessageDialog().then(w);}});}).catch(function(){u();}).finally(function(){f.unlock(I.oLockObject);});};var b1=new D({title:_,state:"Warning",content:[$],ariaLabelledBy:Y.getVisible()?[Y,Z]:Z,beginButton:new a({text:K.getText("C_COMMON_OBJECT_PAGE_DELETE"),type:"Emphasized",press:function(){b1.close();return a1();}}),endButton:new a({text:e.getTranslatedText("C_COMMON_OBJECT_PAGE_CANCEL",R),press:function(){b1.close();}}),afterClose:function(){b1.destroy();if(!H){u();}}});if(r.noDialog){return a1();}else{b1.addStyleClass("sapUiContentPadding");b1.open();}}).finally(function(){f.unlock(I.oLockObject);}).catch(function(){L.warning("Couldn't get Programming model");u();});return new Promise(function(i,Q){u=Q;w=i;});},editDocument:function(i,r,v,t){var u=this,w=this.getProgrammingModel(i),E;if(!i){return Promise.reject(new Error("Binding context to active document is required"));}this._bIsModified=false;f.lock(u.oLockObject);t.removeTransitionMessages();if(w===p.Draft){E=d.createDraftFromActiveDocument(i,this._getAppComponent(),{bPreserveChanges:true,bPrepareOnEdit:r,oView:v});}else if(w===p.Sticky){E=s.editDocumentInStickySession(i);}else{f.unlock(u.oLockObject);return Promise.reject(new Error("Edit is only allowed for draft or sticky session supported services"));}return E.then(function(N){u._bCreateMode=false;return t.showMessageDialog().then(function(){return N;});}).catch(function(x){return t.showMessageDialog().then(function(){return Promise.reject(x);});}).finally(function(){f.unlock(u.oLockObject);});},cancelDocument:function(i,r,R,t){var u=this,v;if(!i){return Promise.reject("No context exists. Pass a meaningful context");}f.lock(u.oLockObject);r=q(r);var w=i,x=r.cancelButton,y=w.getModel(),z;return Promise.resolve(this.getProgrammingModel(i)).then(function(E){v=E;if(E===p.Draft){var G=y.bindContext(w.getPath()+"/DraftAdministrativeData").getBoundContext();if(!u._bIsModified){return G.requestObject().then(function(H){if(H){u._bIsModified=!(H.CreationDateTime===H.LastChangeDateTime);}});}}}).then(function(){if(!r.bSkipDiscardPopover){return u._showDiscardPopover(x,u._bIsModified,R);}else{return Promise.resolve();}}).then(function(){switch(v){case p.Draft:return w.requestObject("HasActiveEntity").then(function(H){var E;if(!H){if(w&&w.hasPendingChanges()){w.getBinding().resetChanges();}E=d.deleteDraft(w);return E;}else{var G=y.bindContext(w.getPath()+"/SiblingEntity").getBoundContext();return G.requestCanonicalPath().then(function(I){z=I;if(w&&w.hasPendingChanges()){w.getBinding().resetChanges();}E=d.deleteDraft(w);return E;},function(){d.deleteDraft(w);return;}).then(function(){if(!z){return;}if(G.getPath()!==z){G=y.bindContext(z).getBoundContext();}return G;});}});case p.Sticky:return s.discardDocument(i).then(function(i){if(i){if(i.hasPendingChanges()){i.getBinding().resetChanges();}if(!u._bCreateMode){i.refresh();return i;}}return false;});default:return Promise.reject("Cancel document only allowed for draft or sticky session supported services");}}).then(function(E){u._bIsModified=false;t.removeTransitionMessages();return t.showMessageDialog().then(function(){return E;});}).catch(function(E){return t.showMessageDialog().then(function(){return Promise.reject(E);});}).finally(function(){f.unlock(u.oLockObject);});},saveDocument:function(i,r,E,t,u){var v=this,w=this.getProgrammingModel(i),S;if(!i){return Promise.reject(new Error("Binding context to draft document is required"));}u.removeTransitionMessages();f.lock(v.oLockObject);if(w===p.Draft){S=d.activateDocument(i,this._getAppComponent());}else if(w===p.Sticky){S=s.activateDocument(i);}else{f.unlock(v.oLockObject);return Promise.reject(new Error("Save is only allowed for draft or sticky session supported services"));}return S.then(function(x){var N=v.sProgrammingModel===p.Sticky?v._bCreateMode:!i.getObject().HasActiveEntity;M.show(N?e.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_CREATED",r):e.getTranslatedText("C_TRANSACTION_HELPER_OBJECT_SAVED",r));v._bIsModified=false;return u.showMessageDialog().then(function(){return x;});}).catch(function(x){if(t&&t.length>0){t.forEach(function(y){if(!e.hasTransientContext(y)&&E){var z=v._getAppComponent();z.getSideEffectsService().requestSideEffectsForNavigationProperty(y.getPath(),i);}});}return u.showMessageDialog().then(function(){return Promise.reject(x);});}).finally(function(){f.unlock(v.oLockObject);});},callAction:function(r,t,v,u){t=q(t);var w=this,x,y,z,N,E=t.bindingParameters;if(!r){return Promise.reject("Provide name of action to be executed");}N=r.split("/")[1];r=N||r;x=N?undefined:t.contexts;if(x&&((Array.isArray(x)&&x.length)||!Array.isArray(x))){x=Array.isArray(x)?x[0]:x;y=x.getModel();}if(t.model){y=t.model;}if(!y){return Promise.reject("Pass a context for a bound action or pass the model for an unbound action");}var G=w._getAppComponent();var S=G.getSideEffectsService().getODataActionSideEffects(r,x)||{};if(x&&y){z=new Promise(function(H,I){var K;var O={onClose:function(){K.close();H();},onContinue:function(){K.close();H(t.applicableContext);}};var Q=function(){var _,a1=t.notApplicableContext.length,b1=[];for(var i=0;i<t.notApplicableContext.length;i++){_=t.notApplicableContext[i].getObject();b1.push(_);}var c1=new J(b1);var d1=new J({total:a1,label:t.label});K.setModel(c1,"notApplicable");K.setModel(d1,"totals");K.open();};if(t.notApplicableContext&&t.notApplicableContext.length>=1){var R="sap.fe.core.controls.ActionPartial";var U=g.loadTemplate(R,"fragment");var W=y.getMetaModel();var Y=t.contexts[0].getCanonicalPath();var Z=Y.substr(0,Y.indexOf("("))+"/";var $=new J({title:t.label});Promise.resolve(X.process(U,{name:R},{bindingContexts:{entityType:W.createBindingContext(Z),label:$.createBindingContext("/")},models:{entityType:W,metaModel:W,label:$}})).then(function(i){return F.load({definition:i,controller:O});}).then(function(i){K=i;t.parentControl.addDependent(i);Q();}).catch(I);}else{H(t.contexts);}}).then(function(i){if(i){return o.callBoundAction(r,i,y,G,{invocationGrouping:t.invocationGrouping,label:t.label,showActionParameterDialog:true,mBindingParameters:E,entitySetName:t.entitySetName,additionalSideEffect:S,onSubmitted:function(){u.removeTransitionMessages();f.lock(w.oLockObject);},onResponse:function(){f.unlock(w.oLockObject);},parentControl:t.parentControl,internalModelContext:t.internalModelContext,operationAvailableMap:t.operationAvailableMap,bIsCreateAction:t.bIsCreateAction,bGetBoundContext:t.bGetBoundContext,bObjectPage:t.bObjectPage,messageHandler:u,defaultValuesExtensionFunction:t.defaultValuesExtensionFunction});}else{return null;}});}else{z=o.callActionImport(r,y,G,{label:t.label,showActionParameterDialog:true,bindingParameters:E,entitySetName:t.entitySetName,onSubmitted:function(){f.lock(w.oLockObject);},onResponse:function(){f.unlock(w.oLockObject);},parentControl:t.parentControl,internalModelContext:t.internalModelContext,operationAvailableMap:t.operationAvailableMap,messageHandler:u,bObjectPage:t.bObjectPage});}return z.then(function(R){return w._handleActionResponse(u,t,r).then(function(){return R;});}).catch(function(i){return w._handleActionResponse(u,t,r).then(function(){return Promise.reject(i);});});},_handleActionResponse:function(i,r,t){var u=m.getMessages(true,true);if(u.length>0&&r&&r.internalModelContext){r.internalModelContext.setProperty("sActionName",r.label?r.label:t);}return i.showMessageDialog();},handleValidationError:function(){var i=sap.ui.getCore().getMessageManager(),r=i.getMessageModel().getData().filter(function(t){if(t.validation){return t;}});i.removeMessages(r);},_showDiscardPopover:function(i,I,r){var t=this;t._bContinueDiscard=false;return new Promise(function(u,v){if(!i){v("Cancel button not found");}if(I){var O=function(){i.setEnabled(true);if(t._bContinueDiscard){u();}else{v("Discard operation was rejected. Document has not been discarded");}t._oPopover.detachAfterClose(O);};if(!t._oPopover){var w=new T({text:e.getTranslatedText("C_TRANSACTION_HELPER_DRAFT_DISCARD_MESSAGE",r)}),x=new a({text:e.getTranslatedText("C_TRANSACTION_HELPER_DRAFT_DISCARD_BUTTON",r),width:"100%",press:function(){t.handleValidationError();t._bContinueDiscard=true;t._oPopover.close();},ariaLabelledBy:w});t._oPopover=new P({showHeader:false,placement:"Top",content:[new V({items:[w,x]})],beforeOpen:function(){i.setEnabled(false);t._oPopover.setInitialFocus(x);}});t._oPopover.addStyleClass("sapUiContentPadding");}t._oPopover.attachAfterClose(O);t._oPopover.openBy(i);}else{t.handleValidationError();u();}});},handleDocumentModifications:function(){this._bIsModified=true;},_getAppComponent:function(){return this._oAppComponent;},_launchDialogWithKeyFields:function(r,t,u,v,w,x,y,z){var E=this,G,H=x.parentControl,S=false;return new Promise(function(I,K){var N="sap/fe/core/controls/NonComputedVisibleKeyFieldsDialog";var O=g.loadTemplate(N,"fragment"),R=H.getController().oResourceBundle,Q=w.getMetaModel(),U=[],W=E._getAppComponent(),Y=Q.createBindingContext(r.getPath()),Z=Q.getMetaPath(r.getPath());for(var i in v){U.push(Q.createBindingContext(Z+"/"+v[i]));}var $=new J(U);$=$.createBindingContext("/");return Promise.resolve(X.process(O,{name:N},{bindingContexts:{entitySet:Y,fields:$},models:{entitySet:Y.getModel(),fields:$.getModel(),metaModel:Q}})).then(function(O){var _=[],a1={},b1,c1=function(){return Promise.all(_.map(function(e1){return e1.getFields()[0];}).filter(function(e1){return e1.getRequired();}).map(function(e1){var f1=e1.getId();if(f1 in a1){return Promise.resolve(a1[f1]).then(function(g1){return g1;}).catch(function(){return undefined;});}return e1.getValueState()===l.Error?undefined:e1.getValue();})).then(function(e1){return e1.every(function(f1){return f1!==undefined&&f1!==null&&f1!=="";});}).catch(function(){return false;}).then(function(e1){b1.setEnabled(e1);});},d1={handleChange:function(e1){y.removeTransitionMessages();var f1=e1.getSource();var g1=e1.getParameter("id");var h1=e1.getParameter("promise");if(h1){a1[g1]=h1.then(function(){return f1.getValue();});}c1();},handleLiveChange:function(e1){var f1=e1.getParameter("id");var g1=e1.getParameter("value");a1[f1]=g1;c1();}};return F.load({definition:O,controller:d1}).then(function(e1){G=new D({title:e.getTranslatedText("C_TRANSACTION_HELPER_SAPFE_ACTION_CREATE",R),content:[e1],beginButton:{text:e.getTranslatedText("C_TRANSACTION_HELPER_SAPFE_ACTION_CREATE_BUTTON",R),type:"Emphasized",press:function(f1){var b1=f1.getSource();b1.setEnabled(false);f.lock(G);return Promise.all(Object.keys(a1).map(function(g1){return a1[g1];})).then(function(){var g1=E.onAfterCreateCompletion(t,u,x,R);w.submitBatch("submitLater");return g1;}).then(function(g1){G.setBindingContext(null);G.close();I(g1);}).finally(function(){f.unlock(G);b1.setEnabled(true);return y.showMessageDialog();});}},endButton:{text:e.getTranslatedText("C_COMMON_ACTION_PARAMETER_DIALOG_CANCEL",R),press:function(){G.close();}},beforeOpen:function(){if(z){for(var i=0;i<Object.keys(x.data).length;i++){if(x.data&&v.indexOf(Object.keys(x.data)[i])>-1){u.setProperty(v[i],x.data[v[i]]);}}}},afterClose:function(){G.getBindingContext("internal").setProperty("isCreateDialogOpen",false);G.destroy();if(!S){K({bDeleteTransientContext:true});}}});_=e1.getAggregation("form").getAggregation("formContainers")[0].getAggregation("formElements");if(H&&H.addDependent){H.addDependent(G);}b1=G.getBeginButton();G.setBindingContext(u);return e.setUserDefaults(W,U,u).then(function(){c1();G.getBindingContext("internal").setProperty("isCreateDialogOpen",true);G.open();}).catch(function(f1){return y.showMessageDialog().then(function(){return Promise.reject(f1);});});});});});},onAfterCreateCompletion:function(i,N,r,R){var t,u,v=new Promise(function(x,y){t=x;u=y;});var w=function(E){var x=E.getParameter("context"),S=E.getParameter("success");if(x===N){i.detachCreateCompleted(w,this);if(!S){var y={bDeleteTransientContext:false};if(!r.keepTransientContextOnFailed){y.bDeleteTransientContext=true;x.created().then(undefined,function(){L.trace("transient creation context deleted");}).catch(function(y){L.trace("transient creation context deletion error",y);});y.navigateBackFromTransientState=true;}u(y);}else{t();}}};i.attachCreateCompleted(w,this);return v;},_getNewAction:function(S,i,r,t){var N;if(S&&S.preferredMode&&i.indexOf("i-action=createWith")>-1){var u=S.preferredMode[0];N=u.indexOf("createWith:")>-1?u.substr(u.lastIndexOf(":")+1):undefined;}else{N=r&&r.getObject!==undefined?r.getObject(t+"@com.sap.vocabularies.Session.v1.StickySessionSupported/NewAction")||r.getObject(t+"@com.sap.vocabularies.Common.v1.DraftRoot/NewAction"):undefined;}return N;}});});
