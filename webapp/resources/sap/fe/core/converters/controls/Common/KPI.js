/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["../../helpers/ID","sap/fe/core/templating/PropertyHelper","sap/fe/core/formatters/TableFormatterTypes","../../helpers/Aggregation","sap/fe/core/converters/helpers/IssueManager","./Criticality","sap/fe/core/converters/helpers/SelectionVariantHelper"],function(I,P,T,A,a,C,S){"use strict";var _={};var g=S.getFilterDefinitionsFromSelectionVariant;var b=C.getMessageTypeFromCriticalityType;var c=a.IssueType;var d=a.IssueSeverity;var e=a.IssueCategory;var f=A.AggregationHelper;var M=T.MessageType;var i=P.isPathExpression;var K=I.KPIID;var D={"UI.TrendType/StrongUp":"Up","UI.TrendType/Up":"Up","UI.TrendType/StrongDown":"Down","UI.TrendType/Down":"Down","UI.TrendType/Sideways":"None"};var h={"UI.ChartType/ColumnStacked":"StackedColumn","UI.ChartType/BarStacked":"StackedBar","UI.ChartType/Donut":"Donut","UI.ChartType/Line":"Line","UI.ChartType/Bubble":"bubble","UI.ChartType/Column":"column","UI.ChartType/Bar":"bar","UI.ChartType/VerticalBullet":"vertical_bullet","UI.ChartType/Combination":"combination","UI.ChartType/Scatter":"scatter"};function j(p,q){var r,s;if(p.Measures===undefined){return undefined;}var t=p.Dimensions?p.Dimensions.map(function(w){var x,y,z,B;var E=(x=p.DimensionAttributes)===null||x===void 0?void 0:x.find(function(F){var G;return((G=F.Dimension)===null||G===void 0?void 0:G.value)===w.value;});return{name:w.value,label:((y=w.$target.annotations.Common)===null||y===void 0?void 0:(z=y.Label)===null||z===void 0?void 0:z.toString())||w.value,role:E===null||E===void 0?void 0:(B=E.Role)===null||B===void 0?void 0:B.replace("UI.ChartDimensionRoleType/","")};}):[];var v=p.Measures.map(function(w){var x,y,z,B;var E=(x=p.MeasureAttributes)===null||x===void 0?void 0:x.find(function(F){var G;return((G=F.Measure)===null||G===void 0?void 0:G.value)===w.value;});return{name:w.value,label:((y=w.$target.annotations.Common)===null||y===void 0?void 0:(z=y.Label)===null||z===void 0?void 0:z.toString())||w.value,role:E===null||E===void 0?void 0:(B=E.Role)===null||B===void 0?void 0:B.replace("UI.ChartMeasureRoleType/","")};});return{chartType:h[p.ChartType]||"Line",dimensions:t,measures:v,sortOrder:q===null||q===void 0?void 0:(r=q.SortOrder)===null||r===void 0?void 0:r.map(function(w){var x;return{name:((x=w.Property)===null||x===void 0?void 0:x.value)||"",descending:!!w.Descending};}),maxItems:q===null||q===void 0?void 0:(s=q.MaxItems)===null||s===void 0?void 0:s.valueOf()};}function u(p,q){var r,s;var t=p.Value.$target;if((r=t.annotations.Measures)!==null&&r!==void 0&&r.ISOCurrency){var v;var w=(v=t.annotations.Measures)===null||v===void 0?void 0:v.ISOCurrency;if(i(w)){q.datapoint.unit={value:w.$target.name,isCurrency:true,isPath:true};}else{q.datapoint.unit={value:w.toString(),isCurrency:true,isPath:false};}}else if((s=t.annotations.Measures)!==null&&s!==void 0&&s.Unit){var x;var y=(x=t.annotations.Measures)===null||x===void 0?void 0:x.Unit;if(i(y)){q.datapoint.unit={value:y.$target.name,isCurrency:false,isPath:true};}else{q.datapoint.unit={value:y.toString(),isCurrency:false,isPath:false};}}}function k(p,q,r){if(p.Criticality){if(typeof p.Criticality==="object"){var s=p.Criticality.$target;if(q.isPropertyAggregatable(s)){r.datapoint.criticalityPath=p.Criticality.path;}else{r.datapoint.criticalityValue=M.None;}}else{r.datapoint.criticalityValue=b(p.Criticality);}}else if(p.CriticalityCalculation){r.datapoint.criticalityCalculationMode=p.CriticalityCalculation.ImprovementDirection;r.datapoint.criticalityCalculationThresholds=[];switch(r.datapoint.criticalityCalculationMode){case"UI.ImprovementDirectionType/Target":r.datapoint.criticalityCalculationThresholds.push(p.CriticalityCalculation.DeviationRangeLowValue);r.datapoint.criticalityCalculationThresholds.push(p.CriticalityCalculation.ToleranceRangeLowValue);r.datapoint.criticalityCalculationThresholds.push(p.CriticalityCalculation.AcceptanceRangeLowValue);r.datapoint.criticalityCalculationThresholds.push(p.CriticalityCalculation.AcceptanceRangeHighValue);r.datapoint.criticalityCalculationThresholds.push(p.CriticalityCalculation.ToleranceRangeHighValue);r.datapoint.criticalityCalculationThresholds.push(p.CriticalityCalculation.DeviationRangeHighValue);break;case"UI.ImprovementDirectionType/Minimize":r.datapoint.criticalityCalculationThresholds.push(p.CriticalityCalculation.AcceptanceRangeHighValue);r.datapoint.criticalityCalculationThresholds.push(p.CriticalityCalculation.ToleranceRangeHighValue);r.datapoint.criticalityCalculationThresholds.push(p.CriticalityCalculation.DeviationRangeHighValue);break;case"UI.ImprovementDirectionType/Maximize":default:r.datapoint.criticalityCalculationThresholds.push(p.CriticalityCalculation.DeviationRangeLowValue);r.datapoint.criticalityCalculationThresholds.push(p.CriticalityCalculation.ToleranceRangeLowValue);r.datapoint.criticalityCalculationThresholds.push(p.CriticalityCalculation.AcceptanceRangeLowValue);}}else{r.datapoint.criticalityValue=M.None;}}function l(p,q,r){if(p.Trend){if(typeof p.Trend==="object"){var t=p.Trend.$target;if(q.isPropertyAggregatable(t)){r.datapoint.trendPath=p.Trend.path;}else{r.datapoint.trendValue="None";}}else{r.datapoint.trendValue=D[p.Trend]||"None";}}else if(p.TrendCalculation){r.datapoint.trendCalculationIsRelative=p.TrendCalculation.IsRelativeDifference?true:false;if(p.TrendCalculation.ReferenceValue.$target){var s=p.TrendCalculation.ReferenceValue.$target;if(q.isPropertyAggregatable(s)){r.datapoint.trendCalculationReferencePath=p.TrendCalculation.ReferenceValue.path;}else{r.datapoint.trendValue="None";}}else{r.datapoint.trendCalculationReferenceValue=p.TrendCalculation.ReferenceValue;}if(r.datapoint.trendCalculationReferencePath!==undefined||r.datapoint.trendCalculationReferenceValue!==undefined){r.datapoint.trendCalculationTresholds=[p.TrendCalculation.StrongDownDifference.valueOf(),p.TrendCalculation.DownDifference.valueOf(),p.TrendCalculation.UpDifference.valueOf(),p.TrendCalculation.StrongUpDifference.valueOf()];}}else{r.datapoint.trendValue="None";}}function m(p,q,r){if(p.TargetValue){if(p.TargetValue.$target){var t=p.TargetValue.$target;if(q.isPropertyAggregatable(t)){r.datapoint.targetPath=p.TargetValue.path;}}else{r.datapoint.targetValue=p.TargetValue;}}}function n(p,q,r){var s,t;var v=r.getConverterContextFor("/"+q.entitySet);var w=new f(v.getEntityType(),v);if(!w.isAnalyticsSupported()){r.getDiagnostics().addIssue(e.Annotation,d.Medium,c.KPI_ISSUES.NO_ANALYTICS+q.entitySet);return undefined;}var x;var y;var z;var B;var E=v.getAnnotationsByTerm("UI","com.sap.vocabularies.UI.v1.KPI");var F=E.find(function(a1){return a1.qualifier===q.qualifier;});if(F){var G,H,J,L;y=F.DataPoint;x=F.SelectionVariant;z=(G=F.Detail)===null||G===void 0?void 0:G.DefaultPresentationVariant;B=(H=z)===null||H===void 0?void 0:(J=H.Visualizations)===null||J===void 0?void 0:(L=J.find(function(a1){return a1.$target.$Type==="com.sap.vocabularies.UI.v1.ChartDefinitionType";}))===null||L===void 0?void 0:L.$target;}else{var N=v.getAnnotationsByTerm("UI","com.sap.vocabularies.UI.v1.SelectionPresentationVariant");var O=N.find(function(a1){return a1.qualifier===q.qualifier;});if(O){var Q,R,U,V,W,X;x=O.SelectionVariant;z=O.PresentationVariant;y=(Q=z)===null||Q===void 0?void 0:(R=Q.Visualizations)===null||R===void 0?void 0:(U=R.find(function(a1){return a1.$target.$Type==="com.sap.vocabularies.UI.v1.DataPointType";}))===null||U===void 0?void 0:U.$target;B=(V=z)===null||V===void 0?void 0:(W=V.Visualizations)===null||W===void 0?void 0:(X=W.find(function(a1){return a1.$target.$Type==="com.sap.vocabularies.UI.v1.ChartDefinitionType";}))===null||X===void 0?void 0:X.$target;}else{r.getDiagnostics().addIssue(e.Annotation,d.Medium,c.KPI_ISSUES.KPI_NOT_FOUND+q.qualifier);return undefined;}}if(!z||!y||!B){r.getDiagnostics().addIssue(e.Annotation,d.Medium,c.KPI_ISSUES.KPI_DETAIL_NOT_FOUND+q.qualifier);return undefined;}var Y=y.Value.$target;if(!w.isPropertyAggregatable(Y)){r.getDiagnostics().addIssue(e.Annotation,d.Medium,c.KPI_ISSUES.MAIN_PROPERTY_NOT_AGGREGATABLE+q.qualifier);return undefined;}var Z=j(B,z);if(!Z){return undefined;}var $={id:K(p),entitySet:q.entitySet,datapoint:{propertyPath:y.Value.path,annotationPath:v.getEntitySetBasedAnnotationPath(y.fullyQualifiedName),title:(s=y.Title)===null||s===void 0?void 0:s.toString(),description:(t=y.Description)===null||t===void 0?void 0:t.toString()},selectionVariantFilterDefinitions:x?g(x):undefined,chart:Z};u(y,$);k(y,w,$);l(y,w,$);m(y,w,$);return $;}function o(p){var q=p.getManifestWrapper().getKPIConfiguration(),r=[];Object.keys(q).forEach(function(s){var t=n(s,q[s],p);if(t){r.push(t);}});return r;}_.getKPIDefinitions=o;return _;},false);
