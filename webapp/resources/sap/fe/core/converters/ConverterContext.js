/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/core/converters/MetaModelConverter","sap/fe/core/templating/DataModelPathHelper","sap/fe/core/converters/ManifestWrapper"],function(M,D,a){"use strict";var g=D.getTargetObjectPath;var b=D.getContextRelativeTargetObjectPath;var e=D.enhanceDataModelPath;var c=M.convertTypes;function _(i,l){if(!(i instanceof l)){throw new TypeError("Cannot call a class as a function");}}function d(t,p){for(var i=0;i<p.length;i++){var l=p[i];l.enumerable=l.enumerable||false;l.configurable=true;if("value"in l)l.writable=true;Object.defineProperty(t,l.key,l);}}function f(i,p,s){if(p)d(i.prototype,p);if(s)d(i,s);return i;}var h=function(A){return typeof A==="object";};function j(o){return o&&o.hasOwnProperty("_type");}var k=function(r){var i;var l;var p;var m;var n=[];var o=[];r.objectPath.forEach(function(s){var t;if(j(s)){switch(s._type){case"NavigationProperty":n.push(s.name);o.push(s);m=s.targetType;if(p&&p.navigationPropertyBinding.hasOwnProperty(n.join("/"))){l=p.navigationPropertyBinding[n.join("/")];p=l;n=[];}else{l=undefined;}break;case"EntitySet":if(i===undefined){i=s;}l=s;p=l;m=(t=l)===null||t===void 0?void 0:t.entityType;break;default:break;}}});var q={startingEntitySet:i,targetEntityType:m,targetEntitySet:l,navigationProperties:o,contextLocation:undefined,targetObject:r.target};q.contextLocation=q;return q;};var C=function(){function C(i,m,l,n,t){_(this,C);this.convertedTypes=i;this.manifestSettings=m;this.diagnostics=l;this.mergeFn=n;this.targetDataModelPath=t;this.manifestWrapper=new a(this.manifestSettings,n);this.baseContextPath=g(this.targetDataModelPath);}f(C,[{key:"_getEntityTypeFromFullyQualifiedName",value:function l(i){var t=this.convertedTypes.entityTypes.find(function(m){if(i.startsWith(m.fullyQualifiedName)){var r=i.replace(m.fullyQualifiedName,"");return r.startsWith("/")||r.startsWith("@");}return false;});return t;}},{key:"getAnnotationEntityType",value:function m(i){if(i){var l=i.fullyQualifiedName;var t=this._getEntityTypeFromFullyQualifiedName(l);if(!t){throw new Error("Cannot find Entity Type for "+i.fullyQualifiedName);}return t;}else{return this.targetDataModelPath.targetEntityType;}}},{key:"getManifestControlConfiguration",value:function i(A){if(h(A)){return this.manifestWrapper.getControlConfiguration(A.fullyQualifiedName.replace(this.targetDataModelPath.targetEntityType.fullyQualifiedName,""));}return this.manifestWrapper.getControlConfiguration(A);}},{key:"getAbsoluteAnnotationPath",value:function i(A){if(!A){return A;}if(A[0]==="/"){return A;}return this.baseContextPath+"/"+A;}},{key:"getEntitySet",value:function i(){return this.targetDataModelPath.targetEntitySet;}},{key:"getContextPath",value:function i(){return this.baseContextPath;}},{key:"getDataModelObjectPath",value:function i(){return this.targetDataModelPath;}},{key:"getEntityContainer",value:function i(){return this.convertedTypes.entityContainer;}},{key:"getEntityType",value:function i(){return this.targetDataModelPath.targetEntityType;}},{key:"getSingleton",value:function l(i){return this.convertedTypes.singletons.find(function(s){return s.fullyQualifiedName===i;});}},{key:"getParameterEntityType",value:function n(){var i,l;var p=this.targetDataModelPath.startingEntitySet.entityType;var m=!!((i=p.annotations)!==null&&i!==void 0&&(l=i.Common)!==null&&l!==void 0&&l.ResultContext);return m&&p;}},{key:"getEntityTypeAnnotation",value:function x(l){var m;if(l.indexOf("@")===-1){l="@"+l;}var t=this.targetDataModelPath.targetEntityType.resolvePath(l,true);var r=this.targetDataModelPath.targetEntitySet;var n=this.targetDataModelPath.targetEntityType;var s=this.targetDataModelPath.startingEntitySet.entityType;var o=this.targetDataModelPath.navigationProperties.concat();var i=1;var p;var q=[];var v=t.visitedObjects;if(!r&&(m=s.annotations.Common)!==null&&m!==void 0&&m.ResultContext){r=this.targetDataModelPath.startingEntitySet;this.targetDataModelPath.navigationProperties.forEach(function(y){q.push(y.name);});}while(i<v.length){p=v[i++];if(p._type==="NavigationProperty"){q.push(p.name);o.push(p);n=p.targetType;if(r&&r.navigationPropertyBinding.hasOwnProperty(q.join("/"))){var u=q.join("/");r=r.navigationPropertyBinding[p.name]||r.navigationPropertyBinding[u];q=[];}else{r=undefined;}}if(p._type==="EntitySet"){r=p;n=r.entityType;}}var w={startingEntitySet:this.targetDataModelPath.startingEntitySet,targetEntitySet:r,targetEntityType:n,targetObject:o[o.length-1],navigationProperties:o,contextLocation:this.targetDataModelPath.contextLocation};return{annotation:t.target,converterContext:new C(this.convertedTypes,this.manifestSettings,this.diagnostics,this.mergeFn,w)};}},{key:"getTemplateType",value:function i(){return this.manifestWrapper.getTemplateType();}},{key:"getRelativeAnnotationPath",value:function m(i,l){return i.replace(l.fullyQualifiedName,"");}},{key:"getEntitySetBasedAnnotationPath",value:function m(i){if(!i){return i;}var l=this.targetDataModelPath.targetEntityType.fullyQualifiedName;if(this.targetDataModelPath.targetEntitySet||(this.baseContextPath.startsWith("/")&&this.baseContextPath.match(/\//g)||[]).length>1){var r=i.replace(l,"/");if(r.length>2&&r[0]==="/"&&r[1]==="/"){r=r.substr(1);}return this.baseContextPath+r;}else{return"/"+i;}}},{key:"getManifestWrapper",value:function i(){return this.manifestWrapper;}},{key:"getDiagnostics",value:function i(){return this.diagnostics;}},{key:"getConverterContextFor",value:function l(i){var r=this.convertedTypes.resolvePath(i);var t=k(r);return new C(this.convertedTypes,this.manifestSettings,this.diagnostics,this.mergeFn,t);}},{key:"getAnnotationsByTerm",value:function m(v,i){var l=arguments.length>2&&arguments[2]!==undefined?arguments[2]:[this.getEntityType()];var o=[];l.forEach(function(n){if(n){var p=(n===null||n===void 0?void 0:n.annotations[v])||{};if(p){o=Object.keys(p).filter(function(q){return p[q].term===i;}).reduce(function(q,r){q.push(p[r]);return q;},o);}}});return o;}},{key:"getRelativeModelPathFunction",value:function i(){var t=this.targetDataModelPath;return function(p){var l=e(t,p);return b(l,true);};}}],[{key:"createConverterContextForMacro",value:function r(E,m,i,l,t){var n=arguments.length>5&&arguments[5]!==undefined?arguments[5]:{};var o=m.isA("sap.ui.model.odata.v4.ODataMetaModel")?m:m.getModel();var p=c(o);var q=p.entitySets.find(function(s){return s.name===E;});if(!t){t={startingEntitySet:q,navigationProperties:[],targetEntitySet:q,targetEntityType:q.entityType,targetObject:q};}return new C(p,n,i,l,t);}}]);return C;}();return C;},false);
