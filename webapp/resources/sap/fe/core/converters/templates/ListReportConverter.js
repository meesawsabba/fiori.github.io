/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["../ManifestSettings","../controls/Common/DataVisualization","../helpers/ID","sap/fe/core/converters/controls/Common/Action","sap/fe/core/converters/helpers/ConfigurableObject","sap/fe/core/helpers/BindingExpression","../controls/Common/KPI","sap/fe/core/converters/controls/ListReport/FilterBar"],function(M,D,I,A,C,B,K,a){"use strict";var _={};var g=a.getFilterBarhideBasicSearch;var b=a.getManifestFilterFields;var c=a.getSelectionFields;var d=K.getKPIDefinitions;var f=B.compileBinding;var h=B.annotationExpression;var j=C.insertCustomElements;var k=A.getActionsFromManifest;var l=I.ChartID;var T=I.TableID;var m=I.FilterVariantManagementID;var p=I.FilterBarID;var q=I.CustomTabID;var r=D.isSelectionPresentationCompliant;var s=D.getSelectionVariant;var t=D.isPresentationCompliant;var u=D.getSelectionPresentationVariant;var v=D.getDefaultPresentationVariant;var w=D.getDefaultLineItem;var x=D.getDefaultChart;var y=D.getDataVisualizationConfiguration;var z=M.TemplateType;var V=M.VisualizationType;function E(o,n){var Y=typeof Symbol!=="undefined"&&o[Symbol.iterator]||o["@@iterator"];if(!Y){if(Array.isArray(o)||(Y=G(o))||n&&o&&typeof o.length==="number"){if(Y)o=Y;var i=0;var F=function(){};return{s:F,n:function(){if(i>=o.length)return{done:true};return{done:false,value:o[i++]};},e:function(e){throw e;},f:F};}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");}var Z=true,$=false,a1;return{s:function(){Y=Y.call(o);},n:function(){var e=Y.next();Z=e.done;return e;},e:function(e){$=true;a1=e;},f:function(){try{if(!Z&&Y.return!=null)Y.return();}finally{if($)throw a1;}}};}function G(o,e){if(!o)return;if(typeof o==="string")return H(o,e);var n=Object.prototype.toString.call(o).slice(8,-1);if(n==="Object"&&o.constructor)n=o.constructor.name;if(n==="Map"||n==="Set")return Array.from(o);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return H(o,e);}function H(e,n){if(n==null||n>e.length)n=e.length;for(var i=0,o=new Array(n);i<n;i++){o[i]=e[i];}return o;}function J(e){var i=[];e.forEach(function(n){if(!n.type){var o=n.secondaryVisualization?n.secondaryVisualization.visualizations:n.presentation.visualizations;o.forEach(function(F){if(F.type===V.Table){i.push(F);}});}});return i;}function L(e){var i=[];e.forEach(function(n){if(!n.type){var o=n.primaryVisualization?n.primaryVisualization.visualizations:n.presentation.visualizations;o.forEach(function(F){if(F.type===V.Chart){i.push(F);}});}});return i;}var N=function(e){var i={};for(var n in e){var o,F,Y;if((o=e[n])!==null&&o!==void 0&&(F=o.settings)!==null&&F!==void 0&&(Y=F.defaultValues)!==null&&Y!==void 0&&Y.length){var Z,$;i[n]=(Z=e[n])===null||Z===void 0?void 0:($=Z.settings)===null||$===void 0?void 0:$.defaultValues;}}return i;};function O(e,i,n){var o=i.getManifestWrapper().getDefaultTemplateAnnotationPath();var F=u(e,o,i);if(o&&F){var Y=F.PresentationVariant;if(!Y){throw new Error("Presentation Variant is not configured in the SPV mentioned in the manifest");}var Z=t(F.PresentationVariant);if(!Z){return undefined;}if(r(F,n)){return F;}}if(F){if(r(F,n)){return F;}}var $=v(e);if($){if(t($,n)){return $;}}if(!n){var a1=w(e);if(a1){return a1;}}return undefined;}var P=function(e){var i=e;if(i.converterContext){var n,o;var F=i.converterContext;i=i;var Y=y(i.annotation?F.getRelativeAnnotationPath(i.annotation.fullyQualifiedName,F.getEntityType()):"",true,F,i);var Z="";var $="";var a1="";var b1="";var c1=function(i){return i.key!==undefined;};var d1=function(Y,r1){var s1;var t1=E(Y.visualizations),u1;try{for(t1.s();!(u1=t1.n()).done;){var v1=u1.value;if(r1&&v1.type===V.Chart){s1=v1;break;}if(!r1&&v1.type===V.Table){s1=v1;break;}}}catch(w1){t1.e(w1);}finally{t1.f();}var x1=Object.assign({},Y);if(s1){x1.visualizations=[s1];}return x1;};var e1=function(r1){var l1=F.getEntityTypeAnnotation(r1.annotationPath);var s1=l1.annotation;F=l1.converterContext;var t1=s1;Y=y(t1?F.getRelativeAnnotationPath(t1.fullyQualifiedName,F.getEntityType()):"",true,F,i);return Y;};var f1=function(r1,s1){var t1=d1(r1[0],true);$=(t1===null||t1===void 0?void 0:t1.visualizations[0]).id;var u1=d1(r1[1]?r1[1]:r1[0]);Z=(u1===null||u1===void 0?void 0:u1.visualizations[0]).annotation.id;if(t1&&u1){var g1={primaryVisualization:t1,secondaryVisualization:u1,tableControlId:Z,chartControlId:$,defaultPath:s1};return g1;}};if(((n=Y)===null||n===void 0?void 0:(o=n.visualizations)===null||o===void 0?void 0:o.length)===2&&F.getTemplateType()===z.AnalyticalListPage){var g1=f1([Y],"both");if(g1){return g1;}}else if(F.getManifestWrapper().hasMultipleVisualizations(i)||F.getTemplateType()===z.AnalyticalListPage){var h1=i,i1=h1.primary,j1=h1.secondary;if(i1&&i1.length&&j1&&j1.length){var k1=f1([e1(i1[0]),e1(j1[0])],i.defaultPath);if(k1){return k1;}}else{throw new Error("SecondaryItems in the Views is not present");}}else if(c1(i)){var l1=F.getEntityTypeAnnotation(i.annotationPath);var m1=l1.annotation;F=l1.converterContext;a1=f(h(m1.Text));Y.visualizations.forEach(function(r1,s1){switch(r1.type){case V.Table:var t1=Y.visualizations[s1];var u1=t1.control.filters||{};u1.hiddenFilters=u1.hiddenFilters||{paths:[]};if(!i.keepPreviousPresonalization){t1.annotation.id=T(i.key||"","LineItem");}i=i;if(i&&i.annotation&&i.annotation.term==="com.sap.vocabularies.UI.v1.SelectionPresentationVariant"){b1=i.annotation.SelectionVariant.fullyQualifiedName.split("@")[1];}else{b1=i.annotationPath;}u1.hiddenFilters.paths.push({annotationPath:b1});t1.control.filters=u1;break;case V.Chart:var v1=Y.visualizations[s1];v1.id=l(i.key||"","Chart");break;default:break;}});}Y.visualizations.forEach(function(r1){if(r1.type===V.Table){Z=r1.annotation.id;}else if(r1.type===V.Chart){$=r1.id;}});return{presentation:Y,tableControlId:Z,chartControlId:$,title:a1,selectionVariantPath:b1};}else{i=i;var n1=i.label,o1=i.template,p1=i.type,q1=q(i.key||"");return{title:n1,fragment:o1,type:p1,customTabId:q1};}};var Q=function(e,i){var n=[];if(i){i.paths.forEach(function(F){if(e.getManifestWrapper().hasMultipleVisualizations(F)){if(i.paths.length>1){throw new Error("ALP flavor cannot have multiple views");}else{F=F;n.push({converterContext:e,primary:F.primary,secondary:F.secondary,defaultPath:F.defaultPath});}}else if(F.template){F=F;n.push({key:F.key,label:F.label,template:F.template,type:"Custom"});}else{F=F;var Y=e.getManifestWrapper(),Z=e.getConverterContextFor(F.contextPath||F.entitySet&&"/"+F.entitySet||e.getContextPath()),o=Z.getEntityType();if(o&&Z){var $=Y.getDefaultTemplateAnnotationPath();var a1;var b1=Z.getEntityTypeAnnotation(F.annotationPath);var c1=b1.annotation;var d1=b1.converterContext;if(c1){if(c1.term==="com.sap.vocabularies.UI.v1.SelectionVariant"){if($){a1=u(Z.getEntityType(),$,d1);}else{a1=w(Z.getEntityType());}}else{a1=c1;}n.push({converterContext:Z,annotation:a1,annotationPath:F.annotationPath,keepPreviousPresonalization:F.keepPreviousPresonalization,key:F.key});}}else{}}});}else{var o=e.getEntityType();if(e.getTemplateType()===z.AnalyticalListPage){n=R(e,n);}else{n.push({annotation:O(o,e,false),converterContext:e});}}return n.map(function(F){return P(F);});};function R(e,i){var n=e.getEntityType();var o=O(n,e,true);var F,Y;if(o){i.push({annotation:o,converterContext:e});}else{F=x(n);Y=w(n);if(F&&Y){var Z=[{annotationPath:F.term}];var $=[{annotationPath:Y.term}];i.push({converterContext:e,primary:Z,secondary:$,defaultPath:"both"});}}return i;}var S=function(e){var i=e.getManifestWrapper();return j([],k(i.getHeaderActions(),e));};_.getHeaderActions=S;var U=function(e,i){e.forEach(function(n){if(!n.type){var o=n.presentation;o.visualizations.forEach(function(F){if(F.type===V.Chart&&F.filterId!==i){F.filterId=i;}});}});};_.checkChartFilterBarId=U;var W=function(e){var i=e.getEntityType();var n=e.getContextPath();if(!n){throw new Error("An EntitySet is required to be able to display a ListReport, please adjust your `entitySet` property to point to one.");}var o=e.getManifestWrapper();var F=o.getViewConfiguration();var Y=o.hasMultipleEntitySets();var Z=Q(e,F);var $=F?(F===null||F===void 0?void 0:F.showCounts)||Y:undefined;var a1=J(Z);var b1=L(Z);var c1=a1.some(function(t1){return t1.control.type==="ResponsiveTable";});var d1="";var e1="";var f1=p(n);var g1=m(f1);var h1=[f1].concat(a1.map(function(t1){return t1.annotation.id;}));h1=h1.concat(b1.map(function(t1){return t1.id;}));var i1=o.getFilterConfiguration();var j1=(i1===null||i1===void 0?void 0:i1.initialLayout)!==undefined?i1===null||i1===void 0?void 0:i1.initialLayout.toLowerCase():"compact";var k1=(i1===null||i1===void 0?void 0:i1.layout)!==undefined?i1===null||i1===void 0?void 0:i1.layout.toLowerCase():"compact";var l1=i1.useSemanticDateRange!==undefined?i1.useSemanticDateRange:true;var m1=X(e,Z);if(m1){e1=m1.chartId;d1=m1.tableId;}var n1=c(e,a1);var o1=g(a1,e);var p1=s(i,e);var q1=l1?N(b(i,e)):{};var r1=S(e);var s1=o.hasMultipleVisualizations()||e.getTemplateType()===z.AnalyticalListPage;if(Y){U(Z,f1);}return{mainEntitySet:n,mainEntityType:n+"/",singleTableId:d1,singleChartId:e1,showTabCounts:$,headerActions:r1,showPinnableToggle:c1,filterBar:{selectionFields:n1,hideBasicSearch:o1},views:Z,filterBarId:f1,filterConditions:{selectionVariant:p1,defaultSemanticDates:q1},variantManagement:{id:g1,targetControlIds:h1.join(",")},isMultiEntitySets:Y,hasMultiVisualizations:s1,useSemanticDateRange:l1,filterInitialLayout:j1,filterLayout:k1,kpiDefinitions:d(e)};};_.convertPage=W;function X(e,i){var n="",o="";if(e.getManifestWrapper().hasMultipleVisualizations()||e.getTemplateType()===z.AnalyticalListPage){var F=E(i),Y;try{for(F.s();!(Y=F.n()).done;){var Z=Y.value;Z=Z;if(Z.chartControlId&&Z.tableControlId){o=Z.chartControlId;n=Z.tableControlId;break;}}}catch($){F.e($);}finally{F.f();}}else{var a1=E(i),b1;try{for(a1.s();!(b1=a1.n()).done;){var c1=b1.value;c1=c1;if(!n&&c1.tableControlId){n=c1.tableControlId||"";}if(!o&&c1.chartControlId){o=c1.chartControlId||"";}if(o&&n){break;}}}catch($){a1.e($);}finally{a1.f();}}if(n||o){return{chartId:o,tableId:n};}return undefined;}return _;},false);
