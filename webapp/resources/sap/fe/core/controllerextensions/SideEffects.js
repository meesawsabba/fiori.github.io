/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/ui/core/mvc/ControllerExtension","sap/fe/core/controllerextensions/ControllerExtensionMetadata","../helpers/ClassSupport","sap/fe/core/CommonUtils","sap/fe/macros/field/FieldRuntime","sap/base/Log"],function(C,a,b,c,F,L){"use strict";var _,d,f,g;var P=b.Private;var h=b.Final;var j=b.Public;var O=b.Override;var U=b.UI5Class;function k(i,e){if(!(i instanceof e)){throw new TypeError("Cannot call a class as a function");}}function l(e,p){for(var i=0;i<p.length;i++){var o=p[i];o.enumerable=o.enumerable||false;o.configurable=true;if("value"in o)o.writable=true;Object.defineProperty(e,o.key,o);}}function m(e,p,i){if(p)l(e.prototype,p);if(i)l(e,i);return e;}function n(e,i){if(typeof i!=="function"&&i!==null){throw new TypeError("Super expression must either be null or a function");}e.prototype=Object.create(i&&i.prototype,{constructor:{value:e,writable:true,configurable:true}});if(i)q(e,i);}function q(o,p){q=Object.setPrototypeOf||function q(o,p){o.__proto__=p;return o;};return q(o,p);}function r(D){var e=u();return function p(){var i=v(D),o;if(e){var N=v(this).constructor;o=Reflect.construct(i,arguments,N);}else{o=i.apply(this,arguments);}return s(this,o);};}function s(e,i){if(i&&(typeof i==="object"||typeof i==="function")){return i;}return t(e);}function t(e){if(e===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return e;}function u(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true;}catch(e){return false;}}function v(o){v=Object.setPrototypeOf?Object.getPrototypeOf:function v(o){return o.__proto__||Object.getPrototypeOf(o);};return v(o);}function w(e,p,i,o,x){var y={};Object.keys(o).forEach(function(z){y[z]=o[z];});y.enumerable=!!y.enumerable;y.configurable=!!y.configurable;if('value'in y||y.initializer){y.writable=true;}y=i.slice().reverse().reduce(function(y,z){return z(e,p,y)||y;},y);if(x&&y.initializer!==void 0){y.value=y.initializer?y.initializer.call(x):void 0;y.initializer=undefined;}if(y.initializer===void 0){Object.defineProperty(e,p,y);y=null;}return y;}var S=(_=U("sap.fe.core.controllerextensions.SideEffects",a),d=O(),_(f=(g=function(e){n(S,e);var i=r(S);function S(){k(this,S);return i.apply(this,arguments);}m(S,[{key:"onInit",value:function o(){this._oView=this.base.getView();this._oAppComponent=c.getAppComponent(this._oView);this._oSideEffectsService=this._oAppComponent.getSideEffectsService();this._mFieldGroupQueue={};this._aSourcePropertiesFailure=new Set();this._mFailedSideEffects={};}},{key:"clearPropertiesStatus",value:function o(){this._aSourcePropertiesFailure.clear();}},{key:"getRegisteredFailedRequests",value:function o(){return this._mFailedSideEffects;}},{key:"handleFieldChange",value:function z(E,o){var p=this;var x=this._getFieldProperties(E),I=this._initializeFieldSideEffects(x,o);var y=false;return this._generateImmediatePromise(x).then(function(){y=true;return Promise.all(I.map(function(A){return p.requestSideEffects(A.sideEffects,A.context);})||[]);}).catch(function(A){if(y){L.debug("Error while processing Field SideEffects",A);}else{I.filter(function(B){return B.previouslyFailed===true;}).forEach(function(B){return p._addFailedSideEffects(B.sideEffects,B.context);});}});}},{key:"handleFieldGroupChange",value:function y(E){var o=this,D=[],p=E.getParameter("fieldGroupIds");var x=function(z){var I=false;var A=z.sideEffectProperty;var B=A.context;var G=B.getPath();var H=o._oSideEffectsService.getEntityTypeFromContext(B);var J=o._getEntityTypeFromFQN(H);return Promise.all(z.promises).then(function(){I=true;if(J&&A.sideEffects.SourceProperties.every(function(K){if(K.type==="PropertyPath"){var M=o._generateStatusIndex(J,K.value,B);if(M){return!o._aSourcePropertiesFailure.has(M);}}return true;})){return o.requestSideEffects(A.sideEffects,A.context);}return null;}).catch(function(K){if(I){L.debug("Error while processing FieldGroup SideEffects on context "+G,K);}}).finally(function(){delete o._mFieldGroupQueue[A.name][G];});};p.forEach(function(z){var A;var B=z.replace("$$ImmediateRequest","");var G=(A=o._mFieldGroupQueue)===null||A===void 0?void 0:A[B];if(G){Object.keys(G).forEach(function(H){var I=G[H];if(!I.processStarted){I.processStarted=true;D.push(I);}});}});return Promise.all(D.map(function(z){return x(z);}));}},{key:"addControlSideEffects",value:function p(E,o){this._oSideEffectsService.addControlSideEffects(E,o);}},{key:"removeFailedSideEffects",value:function o(){this._mFailedSideEffects={};}},{key:"requestSideEffects",value:function B(o,p){var x=this;var R,y;var z=new Promise(function(D,E){R=D;y=E;});var T=(o.TargetEntities||[]).concat(o.TargetProperties||[]),A=o.TriggerAction;if(A){this._oSideEffectsService.executeAction(A,p);}this._oSideEffectsService.requestSideEffects(T,p).then(function(){return R();}).catch(function(E){x._addFailedSideEffects(o,p);y(E);});return z;}},{key:"removeControlSideEffects",value:function x(o){var p=o&&o.isA&&o.isA("sap.ui.base.ManagedObject")&&o.getId();if(p){this._oSideEffectsService.removeControlSideEffects(p);}}},{key:"_addFailedSideEffects",value:function y(o,p){var x=p.getPath();this._mFailedSideEffects[x]=this._mFailedSideEffects[x]||[];var I=this._mFailedSideEffects[x].every(function(z){return o.fullyQualifiedName!==z.fullyQualifiedName;});if(I){this._mFailedSideEffects[x].push(o);}}},{key:"_generateFieldGroupPromise",value:function x(E){var o=this;var p=true;return E.promise.then(function(){return p;}).catch(function(){p=false;return p;}).finally(function(){o._saveFieldPropertiesStatus(E.field,p);});}},{key:"_generateImmediatePromise",value:function o(E){var p=E.promise;return p.then(function(){var x=E.field;var y=x.getFieldHelp&&x.getFieldHelp();if(y){var z=sap.ui.getCore().byId(y);if(z){return Promise.all(z.getOutParameters().map(function(A){var B=A.getBinding("value");return B?B.requestValue():Promise.resolve();}));}}return Promise.all([]);});}},{key:"_generateStatusIndex",value:function z(E,p,o){var x=o.getPath();var y=E.resolvePath(p);if(y){if(y&&y._type==="Property"){return[y.fullyQualifiedName,x].join("__");}}return undefined;}},{key:"_getContextForSideEffects",value:function y(o,p){var B=o.getBindingContext();var x=B,E=this._oSideEffectsService.getEntityTypeFromContext(B);if(p!==E){x=B.getBinding().getContext();if(x){E=this._oSideEffectsService.getEntityTypeFromContext(x);if(p!==E){x=x.getBinding().getContext();if(x){E=this._oSideEffectsService.getEntityTypeFromContext(x);if(p!==E){return undefined;}}}}}return x||undefined;}},{key:"_getEntityTypeFromFQN",value:function p(o){var E=this._oSideEffectsService.getConvertedMetaModel().entityTypes.find(function(x){return x.fullyQualifiedName===o;});return E;}},{key:"_getFieldPromise",value:function o(E){var p=E.getParameter("promise")||Promise.resolve();return p.then(function(){var x=new Promise(function(y,z){if(!F.getFieldStateOnChange(E).state.validity){z();}else{y(true);}});return x;});}},{key:"_getFieldProperties",value:function p(E){var o=E.getSource();return{promise:this._getFieldPromise(E),field:o,sideEffectsMap:this._getFieldSideEffectsMap(o)};}},{key:"_getFieldSideEffectsMap",value:function H(o){var p=this;var x={},y=o.getFieldGroupIds(),V=this._oView.getViewData().entitySet,z=this._oSideEffectsService.getConvertedMetaModel().entitySets.find(function(I){return I.name===V;});y.forEach(function(I){var J;var K=I.indexOf("$$ImmediateRequest")!==-1,N=I.replace("$$ImmediateRequest",""),M=N.split("#"),Q=M[0],R=Q+"@com.sap.vocabularies.Common.v1.SideEffects"+(M.length===2?"#"+M[1]:""),T=(J=p._oSideEffectsService.getODataEntitySideEffects(Q))===null||J===void 0?void 0:J[R],D=p._getContextForSideEffects(o,Q);if(T&&D){x[N]={name:N,immediate:K,sideEffects:T,context:D};}});if(V&&z){var A=z.entityType.fullyQualifiedName,B=o.getAggregation("customData").find(function(I){return I.getKey()==="sourcePath";}),D=this._getContextForSideEffects(o,A);if(B&&D){var E=B.getValue().replace("/"+V+"/",""),G=this._oSideEffectsService.getControlEntitySideEffects(A);Object.keys(G).forEach(function(I){var J=G[I];if(J.SourceProperties.includes(E)){var N=I+"::"+A;x[N]={name:N,immediate:true,sideEffects:J,context:D};}});}}return x;}},{key:"_initializeFieldSideEffects",value:function A(E,o){var p=this;var x=E.sideEffectsMap,y=this._generateFieldGroupPromise(E),z={},I=[];o=o||Promise.resolve();Object.keys(x).forEach(function(B){var D=x[B],G=D.context.getPath(),H=p._mFailedSideEffects[G];if(H){delete p._mFailedSideEffects[G];z[G]={};H.forEach(function(M){z[G][M.fullyQualifiedName]=true;I.push({name:B,previouslyFailed:true,sideEffects:M,context:D.context});});}if(D.immediate){var J;if(!((J=z[G])!==null&&J!==void 0&&J[D.sideEffects.fullyQualifiedName])){I.push({name:B,sideEffects:D.sideEffects,context:D.context});}}else{p._mFieldGroupQueue[B]=p._mFieldGroupQueue[B]||{};var K=p._mFieldGroupQueue[B][G]||{promises:[],sideEffectProperty:D,processStarted:false};K.promises=K.promises.concat([y,o]);p._mFieldGroupQueue[B][G]=K;}});return I;}},{key:"_saveFieldPropertiesStatus",value:function D(o,p){var x=this;var B=o.getBindingContext();var E=this._oSideEffectsService.getEntityTypeFromContext(B);var y=this._getEntityTypeFromFQN(E);if(y){var z=this._getBindingForField(o);var A=z.isA("sap.ui.model.CompositeBinding")?(z.getBindings()||[]).map(function(G){return G.sPath;}):[z.getPath()];A.forEach(function(G){var I=x._generateStatusIndex(y,G,B);if(I){x._aSourcePropertiesFailure[p?"delete":"add"](I);}});}}},{key:"_getBindingForField",value:function p(o){var B;if(o.isA("sap.m.CheckBox")){B=o.getBinding("selected");}else{B=o.getBinding("value");}return B;}}]);return S;}(C),(w(g.prototype,"onInit",[d],Object.getOwnPropertyDescriptor(g.prototype,"onInit"),g.prototype),w(g.prototype,"clearPropertiesStatus",[j,h],Object.getOwnPropertyDescriptor(g.prototype,"clearPropertiesStatus"),g.prototype),w(g.prototype,"getRegisteredFailedRequests",[j,h],Object.getOwnPropertyDescriptor(g.prototype,"getRegisteredFailedRequests"),g.prototype),w(g.prototype,"handleFieldChange",[j,h],Object.getOwnPropertyDescriptor(g.prototype,"handleFieldChange"),g.prototype),w(g.prototype,"handleFieldGroupChange",[j,h],Object.getOwnPropertyDescriptor(g.prototype,"handleFieldGroupChange"),g.prototype),w(g.prototype,"addControlSideEffects",[j,h],Object.getOwnPropertyDescriptor(g.prototype,"addControlSideEffects"),g.prototype),w(g.prototype,"removeFailedSideEffects",[j,h],Object.getOwnPropertyDescriptor(g.prototype,"removeFailedSideEffects"),g.prototype),w(g.prototype,"requestSideEffects",[j,h],Object.getOwnPropertyDescriptor(g.prototype,"requestSideEffects"),g.prototype),w(g.prototype,"removeControlSideEffects",[j,h],Object.getOwnPropertyDescriptor(g.prototype,"removeControlSideEffects"),g.prototype),w(g.prototype,"_addFailedSideEffects",[P,h],Object.getOwnPropertyDescriptor(g.prototype,"_addFailedSideEffects"),g.prototype),w(g.prototype,"_getContextForSideEffects",[P,h],Object.getOwnPropertyDescriptor(g.prototype,"_getContextForSideEffects"),g.prototype)),g))||f);return S;},false);
