/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2021 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/mvc/ControllerExtension","sap/fe/core/controllerextensions/ControllerExtensionMetadata","sap/ui/core/mvc/OverrideExecution","sap/ui/core/Component","sap/fe/core/CommonUtils","sap/fe/core/BusyLocker","sap/fe/core/helpers/SemanticKeyHelper","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/base/Log","sap/fe/core/actions/messageHandling","sap/m/MessageBox","sap/fe/core/helpers/EditState","sap/fe/core/controllerextensions/MessageHandler","sap/fe/core/helpers/ModelHelper"],function(C,a,O,b,c,B,S,F,d,L,m,M,E,e,f){"use strict";return C.extend("sap.fe.core.controllerextensions.InternalRouting",{metadata:{methods:{"navigateToTarget":{"public":true,"final":false},"byId":{"public":false},"getView":{"public":false},"onRouteMatched":{"public":true,"final":false,overrideExecution:O.After},"onRouteMatchedFinished":{"public":true,"final":false,overrideExecution:O.After},"onBeforeBinding":{"public":true,"final":false,overrideExecution:O.After},"onAfterBinding":{"public":true,"final":false,overrideExecution:O.After},"navigateToContext":{"public":true,"final":true},"navigateBackFromContext":{"public":true,"final":true},"navigateForwardToContext":{"public":true,"final":true},"navigateBackFromTransientState":{"public":true,"final":true},"navigateToMessagePage":{"public":true,"final":true},"enterFullScreen":{"public":true,"final":false,overrideExecution:sap.ui.core.mvc.OverrideExecution.Before},"exitFullScreen":{"public":true,"final":false,overrideExecution:sap.ui.core.mvc.OverrideExecution.Before},"closeColumn":{"public":true,"final":false,overrideExecution:sap.ui.core.mvc.OverrideExecution.Before},"isCurrentStateImpactedBy":{"public":true,"final":true}}},onRouteMatched:function(){},onRouteMatchedFinished:function(){},onBeforeBinding:function(o,p){var r=this.base.getView().getController().routing;if(r&&r.onBeforeBinding){r.onBeforeBinding(o,p);}},onAfterBinding:function(o,p){this._oAppComponent.getRootViewController().onContextBoundToView(o);var r=this.base.getView().getController().routing;if(r&&r.onAfterBinding){r.onAfterBinding(o,p);}},navigateToTarget:function(o,n,s,p){var N=this._oPageComponent&&this._oPageComponent.getNavigationConfiguration&&this._oPageComponent.getNavigationConfiguration(n);if(N){var D=N.detail;var r=D.route;var P=D.parameters;this._oRoutingService.navigateTo(o,r,P,p,s);}else{this._oRoutingService.navigateTo(o,null,null,p);}this._oView.getViewData();},navigateToContext:function(o,p){var t=this;var g={};p=p||{};if(o.isA("sap.ui.model.odata.v4.ODataListBinding")){if(p.asyncContext){this._oRouterProxy.activateRouteMatchSynchronization();p.asyncContext.then(function(o){t.navigateToContext(o,{checkNoHashChange:p.checkNoHashChange,editable:p.editable,bPersistOPScroll:p.bPersistOPScroll,updateFCLLevel:p.updateFCLLevel});}).catch(function(h){L.error("Error with the async context",h);});}else if(!p.bDeferredContext){throw"navigation to a list binding is not yet supported";}}if(p.callExtension){g.sourceBindingContext=o.getObject();g.bindingContext=o;if(p.oEvent){g.oEvent=p.oEvent;}if(this.base.getView().getController().routing.onBeforeNavigation(g)){return Promise.resolve();}}p.FCLLevel=this._getFCLLevel();return this._oRoutingService.navigateToContext(o,p,this._oView.getViewData(),this._oTargetInformation);},navigateBackFromContext:function(o,p){p=p||{};p.updateFCLLevel=-1;return this.navigateToContext(o,p);},navigateForwardToContext:function(o,p){if(this._oView.getBindingContext("internal").getProperty("messageFooterContainsErrors")===true){return Promise.resolve();}p=p||{};p.updateFCLLevel=1;return this.navigateToContext(o,p,true);},navigateBackFromTransientState:function(){var h=this._oRouterProxy.getHash();if(h.indexOf("(...)")!==-1){this._oRouterProxy.navBack();}},navigateToMessagePage:function(s,p){p=p||{};if(this._oRouterProxy.getHash().indexOf("i-action=create")>-1){this._oRouterProxy.navToHash(this._oRoutingService.getDefaultCreateHash());}else{p.FCLLevel=this._getFCLLevel();this._oAppComponent.getRootViewController().displayMessagePage(s,p);}},isCurrentStateImpactedBy:function(o){return this._oRoutingService.isCurrentStateImpactedBy(o);},_onRouteMatched:function(o){var t=o.getParameter("routeInformation")&&o.getParameter("routeInformation").targets;if(!t||t.indexOf(this._oTargetInformation.targetName)===-1){return;}var T;if(this._oPageComponent&&this._oPageComponent.getBindingContextPattern){T=this._oPageComponent.getBindingContextPattern();}T=T||this._oTargetInformation.contextPattern;if(T===null||T===undefined){T=o.getParameter("routePattern");}T=T.replace(":?query:","");var A=o.getParameters().arguments,D=false,n=o.getParameter("navigationInfo");for(var k in A){var v=A[k];if(v==="..."&&T.indexOf("{"+k+"}")>=0){D=true;n.bTargetEditable=true;}T=T.replace("{"+k+"}",v);}if(A["?query"]&&A["?query"].hasOwnProperty("i-action")){n.bActionCreate=true;}if(T&&T[0]!=="/"){T="/"+T;}this.onRouteMatched();var g=this._oView.getModel(),h;if(D){h=this._bindDeferred(T,n);}else{h=this._bindPage(T,g,n);}var i=this;h.finally(function(){i.onRouteMatchedFinished();});this._oAppComponent.getRootViewController().updateUIStateForView(this._oView,this._getFCLLevel());},_bindDeferred:function(t,n){this.onBeforeBinding(null,{editable:n.bTargetEditable});if(n.bDeferredContext||!n.oAsyncContext){if(this._oPageComponent&&this._oPageComponent.createDeferredContext){this._oPageComponent.createDeferredContext(t,n.bActionCreate);}}if(this._getBindingContext()&&this._getBindingContext().hasPendingChanges()){this._getBindingContext().getBinding().resetChanges();}this._setBindingContext(null);this.onAfterBinding(null);return Promise.resolve();},_bindPage:function(t,o,n){var g=this;if(t===""){return Promise.resolve(this._bindPageToContext(null,o,n));}else{return this._resolveSemanticPath(t,o).then(function(T){g._bindPageToPath(T,o,n);}).catch(function(h){var r=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core");g.navigateToMessagePage(r.getText("C_COMMON_SAPFE_DATA_RECEIVED_ERROR"),{title:r.getText("C_COMMON_SAPFE_ERROR"),description:h.message});});}},_createFilterFromSemanticPath:function(s,g,o){var k=s.substring(s.indexOf("(")+1,s.length-1).split(","),h;if(g.length!=k.length){return null;}var i=f.isFilteringCaseSensitive(o);if(g.length===1){var K=k[0];if(K.indexOf("'")===0&&K.lastIndexOf("'")===K.length-1){K=decodeURIComponent(K.substring(1,K.length-1));}h=[new F({path:g[0].$PropertyPath,operator:d.EQ,value1:K,caseSensitive:i})];}else{var j={};k.forEach(function(p){var P=p.split("="),K=P[1];if(K.indexOf("'")===0&&K.lastIndexOf("'")===K.length-1){K=decodeURIComponent(K.substring(1,K.length-1));}j[P[0]]=K;});var l=false;h=g.map(function(p){var q=p.$PropertyPath,v=j[q];if(v!==undefined){return new F({path:q,operator:d.EQ,value1:v,caseSensitive:i});}else{l=true;return"XX";}});if(l){return null;}}var D=new F({filters:[new F("IsActiveEntity","EQ",false),new F("SiblingEntity/IsActiveEntity","EQ",null)],and:false});h.push(D);var n=new F(h,true);return n;},_getTechnicalPathFromSemanticPath:function(s,o,g){var h=o.getMetaModel(),i=h.getMetaContext(s).getPath();if(!g||g.length===0){return Promise.resolve(null);}var j=this._createFilterFromSemanticPath(s,g,h);if(j===null){return Promise.resolve(null);}var l=o.bindList("/"+i,undefined,undefined,j,{"$$groupId":"$auto.Heroes"});return l.requestContexts(0,2).then(function(k){if(k&&k.length){return k[0].getPath();}else{return null;}});},_checkPathForSemanticBookmarking:function(p,o){var g=/^[\/]?(\w+)\([^\/]+\)$/.exec(p);if(!g){return false;}var s="/"+g[1];var D=o.getObject(s+"@com.sap.vocabularies.Common.v1.DraftRoot");var h=o.getObject(s+"@com.sap.vocabularies.Common.v1.DraftNode");return D||h?true:false;},_resolveSemanticPath:function(p,o){var g=o.getMetaModel(),l=this._oRoutingService.getLastSemanticMapping(),s=this._oRouter.getHashChanger().getHash().split("?")[0],t=this;if(s&&s.lastIndexOf("/")===s.length-1){s=s.substring(0,s.length-1);}var r=s&&s.substr(0,s.indexOf("("));if(r.indexOf("/")===0){r=r.substring(1);}var A=this._checkPathForSemanticBookmarking(s,g),h=A&&S.getSemanticKeys(g,r);if(!h){return Promise.resolve(p);}else if(l&&l.semanticPath===p){return Promise.resolve(l.technicalPath);}else{return this._getTechnicalPathFromSemanticPath(s,o,h).then(function(T){if(T&&T!==p){t._oRoutingService.setLastSemanticMapping({technicalPath:T,semanticPath:p});return T;}else{return p;}});}},_bindPageToPath:function(t,o,n){var g=this._getBindingContext(),s=g&&g.getPath(),u=n.useContext;if(s!==t||(u&&u.getPath()===t)){var T;if(u&&u.getPath()===t){T=u;}else{T=this._createBindingContext(t,o);}if(T!==g){this._bindPageToContext(T,o,n);}}else if(!n.bReasonIsIappState&&E.isEditStateDirty()){this._refreshBindingContext(g);}},_bindPageToContext:function(o,g,n){var t=this;if(!o){this.onBeforeBinding(null);this.onAfterBinding(null);}else{var p=o.getBinding();if(!o.getBinding()||o.getBinding().isA("sap.ui.model.odata.v4.ODataListBinding")){o=this._createBindingContext(o.getPath(),g);if(E.isEditStateDirty()){setTimeout(function(){t._refreshBindingContext(o);},0);}}this.onBeforeBinding(o,{editable:n.bTargetEditable,listBinding:p,bPersistOPScroll:n.bPersistOPScroll,bDraftNavigation:n.bDraftNavigation,showPlaceholder:n.bShowPlaceholder});this._setBindingContext(o);this.onAfterBinding(o);}},_createBindingContext:function(p,o){var P=this._oPageComponent,s=P&&P.getEntitySet&&P.getEntitySet(),g=(P&&P.getContextPath&&P.getContextPath())||(s&&"/"+s),h=o.getMetaModel(),t=this,i={$$patchWithoutSideEffects:true,$$groupId:"$auto.Heroes",$$updateGroupId:"$auto"};if(s){var j=h.getObject(g+"/@com.sap.vocabularies.Common.v1.Messages/$Path");if(j){i.$select=j;}}var D=h.getObject(g+"@com.sap.vocabularies.Common.v1.DraftRoot");var k=h.getObject(g+"@com.sap.vocabularies.Common.v1.DraftNode");if(D||k){if(i.$select===undefined){i.$select="HasActiveEntity,HasDraftEntity,IsActiveEntity";}else{i.$select+=",HasActiveEntity,HasDraftEntity,IsActiveEntity";}}var H=o.bindContext(p,undefined,i);H.attachEventOnce("dataRequested",function(){B.lock(t._oView);});H.attachEventOnce("dataReceived",function(l){var n=l&&l.getParameter("error");B.unlock(t._oView);if(n){sap.ui.getCore().getLibraryResourceBundle("sap.fe.core",true).then(function(r){var q=new e();q.removeTransitionMessages();t.navigateToMessagePage(r.getText("C_COMMON_SAPFE_DATA_RECEIVED_ERROR"),{title:r.getText("SAPFE_ERROR"),description:n});}).catch(function(q){L.error("Error while getting the core resource bundle",q);});}});return H.getBoundContext();},_refreshBindingContext:function(o){var p=this._oPageComponent,s=this._oAppComponent.getSideEffectsService(),r=o.getPath(),g=p&&p.getEntitySet&&p.getEntitySet(),h=(p&&p.getContextPath&&p.getContextPath())||(g&&"/"+g),j=this._oView.getModel().getMetaModel(),k,n=[],P=[],l={TargetProperties:[],TargetEntities:[]};function q(t){var D,R=((t.getContext()&&t.getContext().getPath())||"").replace(r,""),u=(R?R.slice(1)+"/":R)+t.getPath();if(t.isA("sap.ui.model.odata.v4.ODataContextBinding")){D=t.getDependentBindings();if(D){for(var i=0;i<D.length;i++){q(D[i]);}}else if(n.indexOf(u)===-1){n.push(u);}}else if(t.isA("sap.ui.model.odata.v4.ODataListBinding")){if(n.indexOf(u)===-1){n.push(u);}}else if(t.isA("sap.ui.model.odata.v4.ODataPropertyBinding")){if(P.indexOf(u)===-1){P.push(u);}}}if(h){k=j.getObject(h+"/@com.sap.vocabularies.Common.v1.Messages/$Path");}q(o.getBinding());var i;for(i=0;i<n.length;i++){l.TargetEntities.push({$NavigationPropertyPath:n[i]});}l.TargetProperties=P;if(k){l.TargetProperties.push({$PropertyPath:k});}s.requestSideEffects(l.TargetEntities.concat(l.TargetProperties),o);},_getBindingContext:function(){if(this._oPageComponent){return this._oPageComponent.getBindingContext();}else{return this._oView.getBindingContext();}},_setBindingContext:function(o){if(this._oPageComponent){this._oPageComponent.setBindingContext(o);}else{this._oView.setBindingContext(o);}},_getFCLLevel:function(){return this._oTargetInformation.FCLLevel;},overflowToolbarButtonHover:function(){this.sCurrentFocusedControlId=sap.ui.getCore().getCurrentFocusedControlId();},enterFullScreen:function(){var s=this.base.getView();var o=s.getBindingContext(),n=s.getModel("fclhelper").getProperty("/actionButtonsInfo/fullScreen");var r=this._oRouterProxy;var g=this.sCurrentFocusedControlId;this.base._routing.navigateToContext(o,{sLayout:n}).then(function(){var l=r.getLastHistoryEntry();l.oLastFocusControl=Object.assign({},l.oLastFocusControl,{controlId:g,focusInfo:{id:g}});}).catch(function(){L.warning("cannot set focus on last focused control");});},exitFullScreen:function(){var s=this.base.getView();var o=s.getBindingContext(),n=s.getModel("fclhelper").getProperty("/actionButtonsInfo/exitFullScreen");var r=this._oRouterProxy;var g=this.sCurrentFocusedControlId;this.base._routing.navigateToContext(o,{sLayout:n}).then(function(){var l=r.getLastHistoryEntry();l.oLastFocusControl=Object.assign({},l.oLastFocusControl,{controlId:g,focusInfo:{id:g}});}).catch(function(){L.warning("cannot set focus on last focused control");});},closeColumn:function(){var s=this.base.getView();var v=s.getViewData();var o=s.getBindingContext();var g=this.base;var h=o.getModel().getMetaModel();if(v&&v.viewLevel===1&&f.isDraftSupported(h,o.getPath())){c.fnProcessDataLossOrDraftDiscardConfirmation(function(){g._routing.navigateBackFromContext(o,{noPreservationCache:true});},Function.prototype,o,s.getController(),false);}else{g._routing.navigateBackFromContext(o,{noPreservationCache:true});}},override:{onExit:function(){this._oRoutingService&&this._oRoutingService.detachRouteMatched(this._fnRouteMatchedBound);},onInit:function(){var t=this;this._oView=this.base.getView();this._oAppComponent=c.getAppComponent(this._oView);this._oPageComponent=b.getOwnerComponentFor(this._oView);this._oRouter=this._oAppComponent.getRouter();this._oRouterProxy=this._oAppComponent.getRouterProxy();if(!this._oAppComponent||!this._oPageComponent){throw new Error("Failed to initialize controler extension 'sap.fe.core.controllerextesions.InternalRouting");}if(this._oAppComponent===this._oPageComponent){this._oPageComponent=null;}this._oAppComponent.getService("routingService").then(function(r){t._oRoutingService=r;t._fnRouteMatchedBound=t._onRouteMatched.bind(t);t._oRoutingService.attachRouteMatched(t._fnRouteMatchedBound);t._oTargetInformation=r.getTargetInformationFor(t._oPageComponent||t._oView);}).catch(function(){throw new Error("This controller extension cannot work without a 'routingService' on the main AppComponent");});}}},a);});
