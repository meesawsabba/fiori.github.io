/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2021 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/mvc/ControllerExtension","sap/ui/core/mvc/OverrideExecution","sap/base/Log","sap/base/util/merge","sap/ui/fl/apply/api/ControlVariantApplyAPI","sap/ui/mdc/p13n/StateUtil","sap/fe/navigation/library","sap/fe/core/CommonUtils"],function(C,O,L,m,a,S,N,b){"use strict";var A="#additionalStates",c=N.NavType;var _={"sap.ui.fl.variants.VariantManagement":{retrieve:function(v){return{"variantId":v.getModified()?v.getId():v.getCurrentVariantKey()};},apply:function(v,o){if(o&&o.variantId!==undefined&&o.variantId!==v.getCurrentVariantKey()){return a.activateVariant({element:v,variantReference:o.variantId});}}},"sap.m.IconTabBar":{retrieve:function(t){return{selectedKey:t.getSelectedKey()};},apply:function(t,o){if(o&&o.selectedKey){var s=t.getItems().find(function(i){return i.getKey()===o.selectedKey;});if(s){t.setSelectedItem(s);}}}},"sap.ui.mdc.FilterBar":{retrieve:function(f){return S.retrieveExternalState(f).then(function(F){var p=f.getPropertyInfoSet(),d=F.filter||{};p.filter(function(P){return(d[P.path]&&(P.removeFromAppState||d[P.path].length===0));}).forEach(function(P){delete d[P.path];});return F;});},apply:function(f,o){if(o){return S.applyExternalState(f,o);}}},"sap.ui.mdc.Table":{retrieve:function(t){return S.retrieveExternalState(t);},apply:function(t,o){if(o){return S.applyExternalState(t,o);}},refreshBinding:function(t){var T=t.getRowBinding();if(T){var r=T.getRootBinding();if(r===T){T.refresh();}else{var h=T.getHeaderContext();var g=T.getGroupId();if(h){h.requestSideEffects([{$NavigationPropertyPath:""}],g);}}}else{L.info("Table: "+t.getId()+" was not refreshed. No binding found!");}}},"sap.uxap.ObjectPageLayout":{retrieve:function(o){return{selectedSection:o.getSelectedSection()};},apply:function(o,d){d&&o.setSelectedSection(d.selectedSection);},refreshBinding:function(o){var B=o.getBindingContext();var d=B&&B.getBinding();if(d){var M=b.getMetaPathForContext(B);var s=b.getControlRefreshStrategyForContextPath(o,M);if(s==="self"){var e=B.getModel(),f=e.getMetaModel(),n=b.getContextPathProperties(f,M,{$kind:"NavigationProperty"})||{},g=Object.keys(n).reduce(function(P,h){if(n[h].$isCollection!==true){P.push({$NavigationPropertyPath:h});}return P;},[]),p=[{$PropertyPath:"*"}],G=d.getGroupId();B.requestSideEffects(p.concat(g),G);}else if(s==="includingDependents"){d.refresh();}}else{L.info("ObjectPage: "+o.getId()+" was not refreshed. No binding found!");}}},"sap.fe.macros.table.QuickFilterContainer":{retrieve:function(q){return{selectedKey:q.getSelectorKey()};},apply:function(q,o){o&&q.setSelectorKey(o.selectedKey);}},"sap.m.SegmentedButton":{retrieve:function(s){return{selectedKey:s.getSelectedKey()};},apply:function(s,o){o&&s.setSelectedKey(o.selectedKey);}},"sap.m.Select":{retrieve:function(s){return{selectedKey:s.getSelectedKey()};},apply:function(s,o){o&&s.setSelectedKey(o.selectedKey);}},"sap.f.DynamicPage":{retrieve:function(d){return{headerExpanded:d.getHeaderExpanded()};},apply:function(d,o){o&&d.setHeaderExpanded(o.headerExpanded);}},"sap.ui.core.mvc.View":{retrieve:function(v){var o=v.getController();if(o&&o.viewState){return o.viewState.retrieveViewState(o.viewState);}return{};},apply:function(v,o,n){var d=v.getController();if(d&&d.viewState){return d.viewState.applyViewState(o,n);}},refreshBinding:function(v){var o=v.getController();if(o&&o.viewState){return o.viewState.refreshViewBindings();}}},"sap.ui.core.ComponentContainer":{retrieve:function(o){var d=o.getComponentInstance();if(d){return this.retrieveControlState(d.getRootControl());}return{};},apply:function(o,d,n){var e=o.getComponentInstance();if(e){return this.applyControlState(e.getRootControl(),d,n);}}}};var V=C.extend("sap.fe.core.controllerextensions.ViewState",{metadata:{methods:{refreshViewBindings:{"public":true,"final":true},adaptBindingRefreshControls:{"public":true,"final":false,overrideExecution:O.After},getControlRefreshBindingHandler:{"public":false,"final":true},refreshControlBinding:{"public":false,"final":true},adaptBindingRefreshHandler:{"public":true,"final":false,overrideExecution:O.After},collectResults:{"public":false,"final":true},adaptControlStateHandler:{"public":true,"final":false,overrideExecution:O.After},getControlStateHandler:{"public":false,"final":true},adaptStateControls:{"public":true,"final":false,overrideExecution:O.After},retrieveAdditionalStates:{"public":true,"final":false,overrideExecution:O.After},retrieveViewState:{"public":true,"final":true},retrieveControlState:{"public":false,"final":true},applyInitialStateOnly:{"public":true,"final":false,overrideExecution:O.Instead},applyViewState:{"public":true,"final":true},applyControlState:{"public":false,"final":true},applyAdditionalStates:{"public":true,"final":false,overrideExecution:O.After},applyNavigationParameters:{"public":true,"final":false,overrideExecution:O.After},onBeforeStateApplied:{"public":true,"final":false,overrideExecution:O.After},onAfterStateApplied:{"public":true,"final":false,overrideExecution:O.After},onSuspend:{"public":true,"final":false,overrideExecution:O.After},onRestore:{"public":true,"final":false,overrideExecution:O.After}}},constructor:function(){C.apply(this);var t=this;t._iRetrievingStateCounter=0;this._pInitialStateApplied=new Promise(function(r){t._pInitialStateAppliedResolve=r;});},refreshViewBindings:function(){var t=this;return t.collectResults(t.base.viewState.adaptBindingRefreshControls).then(function(d){var p=Promise.resolve();d.filter(function(o){return o&&o.isA&&o.isA("sap.ui.base.ManagedObject");}).forEach(function(o){p=p.then(t.refreshControlBinding.bind(t,o));});return p;});},adaptBindingRefreshControls:function(d){},refreshControlBinding:function(o){var d=this.getControlRefreshBindingHandler(o),p=Promise.resolve(),t=this;if(typeof d.refreshBinding!=="function"){L.info("refreshBinding handler for control: "+o.getMetadata().getName()+" is not provided");}else{p=p.then(d.refreshBinding.bind(t,o));}return p;},getControlRefreshBindingHandler:function(o){var r={};if(o){for(var t in _){if(o.isA(t)){r["refreshBinding"]=_[t].refreshBinding||{};break;}}}this.base.viewState.adaptBindingRefreshHandler(o,r);return r;},adaptBindingRefreshHandler:function(o,d){},onSuspend:function(){},onRestore:function(){},destroy:function(){delete this._pInitialStateApplied;delete this._pInitialStateAppliedResolve;delete this._iRetrievingStateCounter;C.prototype.destroy.apply(this);},collectResults:function(f){var r=[],d=Array.prototype.slice.call(arguments,1);d.push(r);f.apply(this,d);return Promise.all(r);},adaptControlStateHandler:function(o,d){},getControlStateHandler:function(o){var i=[],d=[];if(o){for(var t in _){if(o.isA(t)){i.push(Object.assign({},_[t]));break;}}}this.base.viewState.adaptControlStateHandler(o,d);return i.concat(d);},adaptStateControls:function(d){},getStateKey:function(o){return this.getView().getLocalId(o.getId())||o.getId();},retrieveViewState:function(){var t=this;++t._iRetrievingStateCounter;return t._pInitialStateApplied.then(function(){return t.collectResults(t.base.viewState.adaptStateControls);}).then(function(d){return Promise.all(d.filter(function(o){return o&&o.isA&&o.isA("sap.ui.base.ManagedObject");}).map(function(o){return t.retrieveControlState(o).then(function(r){return{key:t.getStateKey(o),value:r};});}));}).then(function(r){return r.reduce(function(s,d){var o={};o[d.key]=d.value;return m(s,o);},{});}).then(function(v){return Promise.resolve(t._retrieveAdditionalStates()).then(function(d){if(d&&Object.keys(d).length){v[A]=d;}return v;});}).finally(function(){--t._iRetrievingStateCounter;}).then(function(v){return t._iRetrievingStateCounter===0?v:undefined;});},retrieveAdditionalStates:function(d){},_retrieveAdditionalStates:function(){var d={};this.base.viewState.retrieveAdditionalStates(d);return d;},retrieveControlState:function(o){var d=this.getControlStateHandler(o);return Promise.all(d.map(function(e){if(typeof e.retrieve!=="function"){throw new Error("controlStateHandler.retrieve is not a function for control: "+o.getMetadata().getName());}return e.retrieve.call(this,o);})).then(function(s){return s.reduce(function(f,e){return m(f,e);},{});});},applyInitialStateOnly:function(){return true;},applyViewState:function(v,n){var t=this;if(this.base.viewState.applyInitialStateOnly()&&this._getInitialStateApplied()){return Promise.resolve();}return this.collectResults(this.base.viewState.onBeforeStateApplied).then(function(){return t.collectResults(t.base.viewState.adaptStateControls);}).then(function(d){var p=Promise.resolve();d.filter(function(o){return o&&o.isA&&o.isA("sap.ui.base.ManagedObject");}).forEach(function(o){var k=t.getStateKey(o);p=p.then(t.applyControlState.bind(t,o,v?v[k]:undefined,n));});return p;}).then(function(){if(n.navigationType===c.iAppState){return t.collectResults(t.base.viewState.applyAdditionalStates,v?v[A]:undefined);}else{return t.collectResults(t.base.viewState.applyNavigationParameters,n);}}).finally(function(){return t.collectResults(t.base.viewState.onAfterStateApplied).then(t._setInitialStateApplied.bind(t));});},_setInitialStateApplied:function(){if(this._pInitialStateAppliedResolve){var p=this._pInitialStateAppliedResolve;delete this._pInitialStateAppliedResolve;p();}},_getInitialStateApplied:function(){return!this._pInitialStateAppliedResolve;},onBeforeStateApplied:function(p){},onAfterStateApplied:function(p){},applyAdditionalStates:function(v,p){},applyNavigationParameters:function(n,p){},applyControlState:function(o,d,n){var e=this.getControlStateHandler(o),p=Promise.resolve(),t=this;e.forEach(function(f){if(typeof f.apply!=="function"){throw new Error("controlStateHandler.apply is not a function for control: "+o.getMetadata().getName());}p=p.then(f.apply.bind(t,o,d,n));});return p;}});return V;});
