/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2021 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/mvc/ControllerExtension","sap/ui/core/mvc/OverrideExecution","sap/fe/core/actions/messageHandling","sap/fe/core/TransactionHelper","sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/BusyLocker","sap/fe/core/library","sap/fe/core/helpers/EditState"],function(C,O,m,T,L,a,B,F,E){"use strict";var P=F.ProgrammingModel,D=F.DraftStatus,b=F.EditMode;var c=C.extend("sap.fe.core.controllerextensions.InternalEditFlow",{metadata:{methods:{createMultipleDocuments:{"public":true,"final":true},deleteMultipleDocuments:{"public":true,"final":true},computeEditMode:{"public":true,"final":true},setEditMode:{"public":true,"final":true},setDraftStatus:{"public":true,"final":true},getRoutingListener:{"public":true,"final":true},getGlobalUIModel:{"public":true,"final":true},syncTask:{"public":true,"final":true},getProgrammingModel:{"public":true,"final":true},deleteDocumentTransaction:{"public":true,"final":true},handleCreateEvents:{"public":true,"final":true},getTransactionHelper:{"public":true,"final":true},getInternalModel:{"public":true,"final":true},createActionPromise:{"public":true,"final":true},getCurrentActionPromise:{"public":true,"final":true},deleteCurrentActionPromise:{"public":true,"final":true},getActionResponseDataAndKeys:{"public":true,"final":true},setCreationMode:{"public":false,"final":false,"overrideExecution":O.After},getMessageHandler:{"public":true,"final":true}}},setCreationMode:function(){},createMultipleDocuments:function(l,d,e,f){var t=this,g=this.getTransactionHelper(),o=this.getGlobalUIModel(),r=t.getView().getController().oResourceBundle;B.lock(o);return this.syncTask().then(function(){var M=l.getModel(),h=M.getMetaModel(),s;if(l.getContext()){s=h.getMetaPath(l.getContext().getPath()+"/"+l.getPath());}else{s=h.getMetaPath(l.getPath());}t.handleCreateEvents(l);var i=d.map(function(p){var j={data:{}};j.keepTransientContextOnFailed=false;j.busyMode="None";j.creationMode="CreationRow";j.parentControl=t.getView();j.createAtEnd=e;for(var k in p){var n=h.getObject(s+"/"+k);if(n&&n.$kind!=="NavigationProperty"&&p[k]){j.data[k]=p[k];}}return g.createDocument(l,j,r,t.getMessageHandler(),f);});return Promise.all(i);}).then(function(h){return Promise.all(h.map(function(n){return n.created();}));}).then(function(){var h=t.getView().getBindingContext();if(!a.hasTransientContext(l)){t._oAppComponent.getSideEffectsService().requestSideEffectsForNavigationProperty(l.getPath(),h);}}).catch(function(h){L.error("Error while creating multiple documents.");return Promise.reject(h);}).finally(function(){B.unlock(o);});},deleteMultipleDocuments:function(d,p){var t=this,r=this.getRoutingListener(),l=this.getGlobalUIModel();var o=t.getView().byId(p.controlId);if(!o||!o.isA("sap.ui.mdc.Table")){throw new Error("parameter controlId missing or incorrect");}var e=o.getRowBinding();p.bFindActiveContexts=true;B.lock(l);return this.deleteDocumentTransaction(d,p).then(function(){var R;o.clearSelection();var f=t.getView().getBindingContext();if(e.isRoot()){R=new Promise(function(g){e.attachEventOnce("dataReceived",function(){g();});});e.refresh();}else if(f){if(!a.hasTransientContext(e)){t._oAppComponent.getSideEffectsService().requestSideEffectsForNavigationProperty(e.getPath(),f);}}E.setEditStateDirty();for(var i=0;i<d.length;i++){if(r.isCurrentStateImpactedBy(d[i])){r.navigateBackFromContext(d[i]);break;}}return R;}).finally(function(){B.unlock(l);});},computeEditMode:function(o){var t=this;return Promise.resolve((function(){var p=t.getProgrammingModel(o);if(p===P.Draft){t.setDraftStatus(D.Clear);return o.requestObject("IsActiveEntity").then(function(i){if(i===false){t.setEditMode(b.Editable);return o.requestObject("HasActiveEntity").then(function(h){t.setEditMode(undefined,!h);});}else{t.setEditMode(b.Display,false);}}).catch(function(e){L.error("Error while determining the editMode for draft",e);throw e;});}})());},setEditMode:function(e,d){var g=this.getGlobalUIModel();if(e){g.setProperty("/editMode",e,undefined,true);g.setProperty("/isEditable",e==="Editable",undefined,true);}if(d!==undefined){this.setCreationMode(d);}},setDraftStatus:function(d){this.base.getView().getModel("ui").setProperty("/draftStatus",d,undefined,true);},getRoutingListener:function(){if(this.base._routing){return this.base._routing;}else{throw new Error("Edit Flow works only with a given routing listener");}},getGlobalUIModel:function(){return this.base.getView().getModel("ui");},syncTask:function(t){var n;if(t instanceof Promise){n=function(){return t;};}else if(typeof t==="function"){n=t;}this._pTasks=this._pTasks||Promise.resolve();if(!!n){this._pTasks=this._pTasks.then(n).catch(function(){return Promise.resolve();});}return this._pTasks;},getProgrammingModel:function(o){return this.getTransactionHelper().getProgrammingModel(o);},deleteDocumentTransaction:function(o,p){var t=this,r=this.getView().getController().oResourceBundle,d=this.getTransactionHelper();p=p||{};p.internalModelContext=p.controlId?sap.ui.getCore().byId(p.controlId).getBindingContext("internal"):null;return this.syncTask().then(d.deleteDocument.bind(d,o,p,r,t.getMessageHandler())).then(function(){t.getInternalModel().setProperty("/sessionOn",false);});},handleCreateEvents:function(o){var t=this,p,d=t.getTransactionHelper();t.setDraftStatus(D.Clear);o=(o.getBinding&&o.getBinding())||o;p=t.getProgrammingModel(o);o.attachEvent("createSent",function(){d.handleDocumentModifications();if(p===P.Draft){t.setDraftStatus(D.Saving);}});o.attachEvent("createCompleted",function(e){var s=e.getParameter("success");if(p===P.Draft){t.setDraftStatus(s?D.Saved:D.Clear);}t.getMessageHandler().showMessageDialog();});},getTransactionHelper:function(){if(!this._oTransactionHelper){this._oTransactionHelper=new T(this._oAppComponent,this.getGlobalUIModel());}return this._oTransactionHelper;},getInternalModel:function(){return this.base.getView().getModel("internal");},createActionPromise:function(A,s){var t=this,r,R;this.oActionPromise=new Promise(function(d,e){r=d;R=e;}).then(function(o){return Object.assign({controlId:s},t.getActionResponseDataAndKeys(A,o));});return{fResolver:r,fRejector:R};},getCurrentActionPromise:function(){return this.oActionPromise;},deleteCurrentActionPromise:function(){this.oActionPromise=null;},getActionResponseDataAndKeys:function(A,r){if(Array.isArray(r)){if(r.length===1){r=r[0];}else{return null;}}if(!r){return null;}var v=this.getView(),M=v.getModel().getMetaModel().getData(),s=M&&M[A]&&M[A][0]&&M[A][0].$ReturnType?M[A][0].$ReturnType.$Type:null,k=s&&M[s]?M[s].$Key:null;return{oData:r.getObject(),keys:k};},getMessageHandler:function(){if(this.base.messageHandler){return this.base.messageHandler;}else{throw new Error("Edit Flow works only with a given message handler");}},override:{onInit:function(){this._oAppComponent=this.base.getAppComponent();}}});return c;});
