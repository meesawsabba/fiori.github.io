/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/ui/core/mvc/ControllerExtension","sap/fe/core/controllerextensions/ControllerExtensionMetadata","../helpers/ClassSupport","sap/ui/model/json/JSONModel","sap/base/Log","sap/fe/core/formatters/TableFormatterTypes","sap/ui/core/format/NumberFormat","sap/ui/core/format/DateFormat","sap/ui/core/Locale","sap/ui/model/Filter","sap/ui/model/Sorter","sap/m/Popover","sap/ui/integration/widgets/Card"],function(C,a,b,J,L,T,N,D,c,F,S,P,d){"use strict";var _,f,g,h,j;var M=T.MessageType;var k=b.Public;var O=b.Override;var U=b.UI5Class;function l(i,e){if(!(i instanceof e)){throw new TypeError("Cannot call a class as a function");}}function m(e,p){for(var i=0;i<p.length;i++){var o=p[i];o.enumerable=o.enumerable||false;o.configurable=true;if("value"in o)o.writable=true;Object.defineProperty(e,o.key,o);}}function n(e,p,i){if(p)m(e.prototype,p);if(i)m(e,i);return e;}function q(e,i){if(typeof i!=="function"&&i!==null){throw new TypeError("Super expression must either be null or a function");}e.prototype=Object.create(i&&i.prototype,{constructor:{value:e,writable:true,configurable:true}});if(i)r(e,i);}function r(o,p){r=Object.setPrototypeOf||function r(o,p){o.__proto__=p;return o;};return r(o,p);}function s(e){var i=v();return function $(){var o=w(e),p;if(i){var I=w(this).constructor;p=Reflect.construct(o,arguments,I);}else{p=o.apply(this,arguments);}return t(this,p);};}function t(e,i){if(i&&(typeof i==="object"||typeof i==="function")){return i;}return u(e);}function u(e){if(e===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return e;}function v(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true;}catch(e){return false;}}function w(o){w=Object.setPrototypeOf?Object.getPrototypeOf:function w(o){return o.__proto__||Object.getPrototypeOf(o);};return w(o);}function x(e,p,i,o,I){var $={};Object.keys(o).forEach(function(a1){$[a1]=o[a1];});$.enumerable=!!$.enumerable;$.configurable=!!$.configurable;if('value'in $||$.initializer){$.writable=true;}$=i.slice().reverse().reduce(function($,a1){return a1(e,p,$)||$;},$);if(I&&$.initializer!==void 0){$.value=$.initializer?$.initializer.call(I):void 0;$.initializer=undefined;}if($.initializer===void 0){Object.defineProperty(e,p,$);$=null;}return $;}var y={"1":M.Error,"2":M.Warning,"3":M.Success,"5":M.Information};var V={Error:"Error",Warning:"Critical",Success:"Good",Information:"None",None:"None"};function z(e,i){var o;if(i[0]!==undefined&&i[0]!==null&&e<i[0]){o=M.Error;}else if(i[1]!==undefined&&i[1]!==null&&e<i[1]){o=M.Warning;}else if(i[2]!==undefined&&i[2]!==null&&e<i[2]){o=M.None;}else if(i[5]!==undefined&&i[5]!==null&&e>i[5]){o=M.Error;}else if(i[4]!==undefined&&i[4]!==null&&e>i[4]){o=M.Warning;}else if(i[3]!==undefined&&i[3]!==null&&e>i[3]){o=M.None;}else{o=M.Success;}return o;}function A(e,i){var o;if(i[2]!==undefined&&i[2]!==null&&e>i[2]){o=M.Error;}else if(i[1]!==undefined&&i[1]!==null&&e>i[1]){o=M.Warning;}else if(i[0]!==undefined&&i[0]!==null&&e>i[0]){o=M.None;}else{o=M.Success;}return o;}function B(e,i){var o;if(i[0]!==undefined&&i[0]!==null&&e<i[0]){o=M.Error;}else if(i[1]!==undefined&&i[1]!==null&&e<i[1]){o=M.Warning;}else if(i[2]!==undefined&&i[2]!==null&&e<i[2]){o=M.None;}else{o=M.Success;}return o;}function E(e){var i;switch(e){case 1:case"1":case 2:case"2":i="Up";break;case 4:case"4":case 5:case"5":i="Down";break;default:i="None";}return i;}function G(e,i,o,p){var I;if(!p||o&&!i){return"None";}var $=o?(e-i)/i:e-i;if(p[0]!==undefined&&p[0]!==null&&$<=p[0]){I="Down";}else if(p[1]!==undefined&&p[1]!==null&&$<=p[1]){I="Down";}else if(p[3]!==undefined&&p[3]!==null&&$>=p[3]){I="Up";}else if(p[2]!==undefined&&p[2]!==null&&$>=p[2]){I="Up";}else{I="None";}return I;}function H(e){if(e.ranges.length===0){return undefined;}else if(e.ranges.length===1){return new F(e.propertyPath,e.ranges[0].operator,e.ranges[0].rangeLow,e.ranges[0].rangeHigh);}else{var i=e.ranges.map(function(o){return new F(e.propertyPath,o.operator,o.rangeLow,o.rangeHigh);});return new F({filters:i,and:false});}}function K(e){var i=new c(sap.ui.getCore().getConfiguration().getLanguage());var o=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core");var p=D.getDateInstance({style:"medium"},i);function I($){var a1=e.propertyType.indexOf("Edm.Date")===0?p.format(new Date($.rangeLow)):$.rangeLow;var b1=e.propertyType.indexOf("Edm.Date")===0?p.format(new Date($.rangeHigh)):$.rangeHigh;switch($.operator){case"BT":return"["+a1+" - "+b1+"]";case"Contains":return"*"+a1+"*";case"GE":return"\u2265"+a1;case"GT":return">"+a1;case"LE":return"\u2264"+a1;case"LT":return"<"+a1;case"NB":return o.getText("C_KPICARD_FILTERSTRING_NOT",["["+a1+" - "+b1+"]"]);case"NE":return"\u2260"+a1;case"NotContains":return o.getText("C_KPICARD_FILTERSTRING_NOT",["*"+a1+"*"]);case"EQ":default:return a1;}}if(e.ranges.length===0){return"";}else if(e.ranges.length===1){return I(e.ranges[0]);}else{return"("+e.ranges.map(I).join(",")+")";}}function Q(e){var i=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core");function o(p){if(p.length===0){return"";}else if(p.length===1){return p[0].label;}else{var $=p[0].label;for(var I=1;I<p.length-1;I++){$+=", "+p[I].label;}return i.getText("C_KPICARD_ITEMSLIST",[$,p[p.length-1].label]);}}return i.getText("C_KPICARD_CHARTTITLE",[o(e.chart.measures),o(e.chart.dimensions)]);}function R(e,o){switch(e.chartType){case"Donut":o.categoryAxis={title:{visible:false}};o.valueAxis={title:{visible:false},label:{formatString:"ShortFloat"}};o.plotArea.dataLabel={visible:true,type:"value",formatString:"ShortFloat_MFD2"};break;case"bubble":o.valueAxis={title:{visible:true},label:{formatString:"ShortFloat"}};o.valueAxis2={title:{visible:true},label:{formatString:"ShortFloat"}};o.legendGroup={layout:{position:"bottom",alignment:"topLeft"}};o.sizeLegend={visible:true};o.plotArea.dataLabel={visible:false};break;case"scatter":o.valueAxis={title:{visible:false},label:{formatString:"ShortFloat"}};o.valueAxis2={title:{visible:false},label:{formatString:"ShortFloat"}};o.plotArea.dataLabel={visible:false};break;default:o.categoryAxis={title:{visible:false}};o.valueAxis={title:{visible:false},label:{formatString:"ShortFloat"}};o.plotArea.dataLabel={visible:false};}}function W(o,e){if(e&&e.length){return o.filter(function(i){return e.indexOf(i.role)>=0;}).map(function(i){return i.label;});}else{return o.map(function(i){return i.label;});}}function X(e){var i=W(e.measures,["Axis1"]);var o=W(e.measures,["Axis2"]);var p=W(e.measures,["Axis3"]);var I=W(e.measures,[undefined]);var $=W(e.dimensions,["Series"]);var a1=e.dimensions.find(function(f1){return f1.role==="Category";});var b1=i.shift()||o.shift()||p.shift()||I.shift()||"";var c1=o.shift()||i.shift()||p.shift()||I.shift()||"";var d1=[{"uid":"valueAxis","type":"Measure","values":[b1]},{"uid":"valueAxis2","type":"Measure","values":[c1]}];if(e.chartType==="bubble"){var e1=p.shift()||i.shift()||o.shift()||I.shift()||"";d1.push({"uid":"bubbleWidth","type":"Measure","values":[e1]});}if($.length){d1.push({"uid":"color","type":"Dimension","values":$});}if(a1){d1.push({"uid":"shape","type":"Dimension","values":[a1.label]});}return d1;}function Y(e){var i;switch(e.chartType){case"Donut":i=[{"uid":"size","type":"Measure","values":W(e.measures)},{"uid":"color","type":"Dimension","values":W(e.dimensions)}];break;case"bubble":case"scatter":i=X(e);break;case"vertical_bullet":i=[{"uid":"actualValues","type":"Measure","values":W(e.measures,[undefined,"Axis1"])},{"uid":"targetValues","type":"Measure","values":W(e.measures,["Axis2"])},{"uid":"categoryAxis","type":"Dimension","values":W(e.dimensions,[undefined,"Category"])},{"uid":"color","type":"Dimension","values":W(e.dimensions,["Series"])}];break;default:i=[{"uid":"valueAxis","type":"Measure","values":W(e.measures)},{"uid":"categoryAxis","type":"Dimension","values":W(e.dimensions,[undefined,"Category"])},{"uid":"color","type":"Dimension","values":W(e.dimensions,["Series"])}];}return i;}var Z=(_=U("sap.fe.core.controllerextensions.KPIManagement",a),f=O(),g=O(),_(h=(j=function(e){q(Z,e);var i=s(Z);function Z(){l(this,Z);return i.apply(this,arguments);}n(Z,[{key:"initCardManifest",value:function c1(o,p){var I;var $={"sap.app":{id:"sap.fe",type:"card"},"sap.ui":{technology:"UI5"},"sap.card":{type:"Analytical",data:{json:{}},header:{type:"Numeric",title:o.datapoint.title,subTitle:o.datapoint.description,unitOfMeasurement:"{mainUnit}",mainIndicator:{number:"{mainValueNoScale}",unit:"{mainValueScale}",state:"{mainState}",trend:"{trend}"}},content:{minHeight:"25rem",chartProperties:{plotArea:{},title:{visible:true,alignment:"left"}},data:{path:"/chartData"}}}};if(o.datapoint.targetPath||o.datapoint.targetValue!==undefined){var a1=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core");$["sap.card"].header.sideIndicators=[{title:a1.getText("C_KPICARD_INDICATOR_TARGET"),number:"{targetNumber}",unit:"{targetUnit}"},{title:a1.getText("C_KPICARD_INDICATOR_DEVIATION"),number:"{deviationNumber}",unit:"%"}];}if((I=o.selectionVariantFilterDefinitions)!==null&&I!==void 0&&I.length){var b1=[];o.selectionVariantFilterDefinitions.forEach(function(d1){var e1=K(d1);if(e1){b1.push(e1);}});if(b1.length){$["sap.card"].header.details=b1.join(", ");}}$["sap.card"].content.chartType=o.chart.chartType;R(o.chart,$["sap.card"].content.chartProperties);$["sap.card"].content.chartProperties.title.text=Q(o);$["sap.card"].content.dimensions=o.chart.dimensions.map(function(d1){return{label:d1.label,value:"{"+d1.name+"}"};});$["sap.card"].content.measures=o.chart.measures.map(function(d1){return{label:d1.label,value:"{"+d1.name+"}"};});$["sap.card"].content.feeds=Y(o.chart);p.setProperty("/"+o.id,{manifest:$});}},{key:"onInit",value:function a1(){var o=this;this.aKPIDefinitions=this.getKPIData();if(this.aKPIDefinitions&&this.aKPIDefinitions.length){var p=this.getView();var I=p.getController().getAppComponent();var $=new J();p.setModel($,"kpiModel");this.aKPIDefinitions.forEach(function(b1){o.initCardManifest(b1,$);o.loadKPITagData(b1,I.getModel(),$).catch(function(c1){L.error(c1);});});}}},{key:"onExit",value:function p(){var o=this.getView().getModel("kpiModel");if(o){o.destroy();}}},{key:"getKPIData",value:function $(){var o=this.getView(),p=o.getContent()[0].data("KPIData");if(p){var I=typeof p==="string"?JSON.parse(p):p;if("customData"in I){return I["customData"];}else{return I;}}else{return undefined;}}},{key:"updateDatapointValueAndCurrency",value:function l1(o,p,I){var $,a1,b1;var c1=new c(sap.ui.getCore().getConfiguration().getLanguage());var d1=($=o.datapoint.unit)!==null&&$!==void 0&&$.isPath?p.getProperty(o.datapoint.unit.value):(a1=o.datapoint.unit)===null||a1===void 0?void 0:a1.value;var e1=((b1=o.datapoint.unit)===null||b1===void 0?void 0:b1.isCurrency)===false&&d1==="%";var f1=Number.parseFloat(p.getProperty(o.datapoint.propertyPath));var g1=N.getFloatInstance({style:e1?undefined:"short",minFractionDigits:0,maxFractionDigits:1,showScale:!e1},c1).format(f1);I.setProperty("/"+o.id+"/manifest/sap.card/data/json/mainValue",g1);var h1=N.getFloatInstance({maxFractionDigits:2,showScale:false,groupingEnabled:true},c1).format(f1);I.setProperty("/"+o.id+"/manifest/sap.card/data/json/mainValueUnscaled",h1);var i1=N.getFloatInstance({style:e1?undefined:"short",minFractionDigits:0,maxFractionDigits:1,showScale:false},c1).format(f1);I.setProperty("/"+o.id+"/manifest/sap.card/data/json/mainValueNoScale",i1);var j1=N.getFloatInstance({style:e1?undefined:"short",decimals:0,maxIntegerDigits:0,showScale:true},c1).format(f1);I.setProperty("/"+o.id+"/manifest/sap.card/data/json/mainValueScale",j1);if(o.datapoint.unit&&d1){if(o.datapoint.unit.isCurrency){I.setProperty("/"+o.id+"/manifest/sap.card/data/json/mainUnit",d1);}else{var k1=N.getUnitInstance({showNumber:false},c1).format(f1,d1);I.setProperty("/"+o.id+"/manifest/sap.card/data/json/mainUnit",k1);}}}},{key:"updateDatapointCriticality",value:function b1(o,p,I){var $=Number.parseFloat(p.getProperty(o.datapoint.propertyPath));var a1=M.None;if(o.datapoint.criticalityValue){a1=o.datapoint.criticalityValue;}else if(o.datapoint.criticalityPath){a1=y[p.getProperty(o.datapoint.criticalityPath)]||M.None;}else if(o.datapoint.criticalityCalculationThresholds&&o.datapoint.criticalityCalculationMode){switch(o.datapoint.criticalityCalculationMode){case"UI.ImprovementDirectionType/Target":a1=z($,o.datapoint.criticalityCalculationThresholds);break;case"UI.ImprovementDirectionType/Minimize":a1=A($,o.datapoint.criticalityCalculationThresholds);break;case"UI.ImprovementDirectionType/Maximize":default:a1=B($,o.datapoint.criticalityCalculationThresholds);break;}}I.setProperty("/"+o.id+"/manifest/sap.card/data/json/mainCriticality",a1);I.setProperty("/"+o.id+"/manifest/sap.card/data/json/mainState",V[a1]||"None");}},{key:"updateDatapointTrend",value:function c1(o,p,I){var $=Number.parseFloat(p.getProperty(o.datapoint.propertyPath));var a1="None";if(o.datapoint.trendValue){a1=o.datapoint.trendValue;}else if(o.datapoint.trendPath){a1=E(p.getProperty(o.datapoint.trendPath));}else if(o.datapoint.trendCalculationReferenceValue!==undefined||o.datapoint.trendCalculationReferencePath){var b1;if(o.datapoint.trendCalculationReferenceValue!==undefined){b1=o.datapoint.trendCalculationReferenceValue;}else{b1=Number.parseFloat(p.getProperty(o.datapoint.trendCalculationReferencePath||""));}a1=G($,b1,!!o.datapoint.trendCalculationIsRelative,o.datapoint.trendCalculationTresholds);}I.setProperty("/"+o.id+"/manifest/sap.card/data/json/trend",a1);}},{key:"updateTargetValue",value:function g1(o,p,I){if(o.datapoint.targetValue===undefined&&o.datapoint.targetPath===undefined){return;}var $=Number.parseFloat(p.getProperty(o.datapoint.propertyPath));var a1=new c(sap.ui.getCore().getConfiguration().getLanguage());var b1;if(o.datapoint.targetValue!==undefined){b1=o.datapoint.targetValue;}else{b1=Number.parseFloat(p.getProperty(o.datapoint.targetPath||""));}var c1=b1!==0?($-b1)/b1*100:undefined;var d1=N.getFloatInstance({style:"short",minFractionDigits:0,maxFractionDigits:1,showScale:false},a1).format(b1);var e1=N.getFloatInstance({style:"short",decimals:0,maxIntegerDigits:0,showScale:true},a1).format(b1);I.setProperty("/"+o.id+"/manifest/sap.card/data/json/targetNumber",d1);I.setProperty("/"+o.id+"/manifest/sap.card/data/json/targetUnit",e1);if(c1!==undefined){var f1=N.getFloatInstance({minFractionDigits:0,maxFractionDigits:1,showScale:false},a1).format(c1);I.setProperty("/"+o.id+"/manifest/sap.card/data/json/deviationNumber",f1);}else{I.setProperty("/"+o.id+"/manifest/sap.card/data/json/deviationNumber","N/A");}}},{key:"loadKPITagData",value:function g1(o,p,I,$){var a1,b1,c1=this;var d1=$?p.bindList("/"+o.entitySet):p.bindList("/"+o.entitySet,undefined,undefined,undefined,{$$groupId:"$auto.LongRunners"});var e1={};if((a1=o.datapoint.unit)!==null&&a1!==void 0&&a1.isPath){e1[o.datapoint.propertyPath]={unit:o.datapoint.unit.value};}else{e1[o.datapoint.propertyPath]={};}if(o.datapoint.criticalityPath){e1[o.datapoint.criticalityPath]={};}if($){if(o.datapoint.trendPath){e1[o.datapoint.trendPath]={};}if(o.datapoint.trendCalculationReferencePath){e1[o.datapoint.trendCalculationReferencePath]={};}if(o.datapoint.targetPath){e1[o.datapoint.targetPath]={};}}d1.setAggregation({aggregate:e1});if((b1=o.selectionVariantFilterDefinitions)!==null&&b1!==void 0&&b1.length){var f1=o.selectionVariantFilterDefinitions.map(H).filter(function(h1){return h1!==undefined;});d1.filter(f1);}return d1.requestContexts(0,1).then(function(h1){if(h1.length){var i1,j1;var k1=(i1=o.datapoint.unit)!==null&&i1!==void 0&&i1.isPath?h1[0].getProperty(o.datapoint.unit.value):(j1=o.datapoint.unit)===null||j1===void 0?void 0:j1.value;if(o.datapoint.unit&&!k1){I.setProperty("/"+o.id+"/manifest/sap.card/data/json/mainValue","*");I.setProperty("/"+o.id+"/manifest/sap.card/data/json/mainValueUnscaled","*");I.setProperty("/"+o.id+"/manifest/sap.card/data/json/mainValueNoScale","*");I.setProperty("/"+o.id+"/manifest/sap.card/data/json/mainValueScale","");I.setProperty("/"+o.id+"/manifest/sap.card/data/json/mainUnit",undefined);I.setProperty("/"+o.id+"/manifest/sap.card/data/json/mainCriticality",M.None);I.setProperty("/"+o.id+"/manifest/sap.card/data/json/mainState","None");I.setProperty("/"+o.id+"/manifest/sap.card/data/json/trend","None");I.setProperty("/"+o.id+"/manifest/sap.card/data/json/targetNumber",undefined);I.setProperty("/"+o.id+"/manifest/sap.card/data/json/targetUnit",undefined);I.setProperty("/"+o.id+"/manifest/sap.card/data/json/deviationNumber",undefined);}else{c1.updateDatapointValueAndCurrency(o,h1[0],I);c1.updateDatapointCriticality(o,h1[0],I);if($){c1.updateDatapointTrend(o,h1[0],I);c1.updateTargetValue(o,h1[0],I);}}}});}},{key:"loadKPICardData",value:function e1(o,p,I){var $;var a1=p.bindList("/"+o.entitySet);var b1={};var c1={};o.chart.dimensions.forEach(function(f1){b1[f1.name]={};});o.chart.measures.forEach(function(f1){c1[f1.name]={};});a1.setAggregation({group:b1,aggregate:c1});if(($=o.selectionVariantFilterDefinitions)!==null&&$!==void 0&&$.length){var d1=o.selectionVariantFilterDefinitions.map(H).filter(function(f1){return f1!==undefined;});a1.filter(d1);}if(o.chart.sortOrder){a1.sort(o.chart.sortOrder.map(function(f1){return new S(f1.name,f1.descending);}));}return a1.requestContexts(0,o.chart.maxItems).then(function(f1){var g1=f1.map(function(h1){var i1={};o.chart.dimensions.forEach(function(j1){i1[j1.name]=h1.getProperty(j1.name);});o.chart.measures.forEach(function(j1){i1[j1.name]=h1.getProperty(j1.name);});return i1;});I.setProperty("/"+o.id+"/manifest/sap.card/data/json/chartData",g1);});}},{key:"getPopover",value:function p(o){if(!this.oPopover){this.oCard=new d({width:"25rem",height:"auto"});this.oPopover=new P({id:"kpi-Popover",showHeader:false,placement:"Auto",content:[this.oCard]});o.addDependent(this.oPopover);}return this.oPopover;}},{key:"onKPIPressed",value:function e1(o,p){var I=this;var $=o.getModel("kpiModel");if(this.aKPIDefinitions&&this.aKPIDefinitions.length){var a1=this.aKPIDefinitions.find(function(f1){return f1.id===p;});if(a1){var b1=o.getModel();var c1=[this.loadKPITagData(a1,b1,$,true),this.loadKPICardData(a1,b1,$)];var d1=this.getPopover(o);Promise.all(c1).then(function(){I.oCard.setManifest($.getProperty("/"+p+"/manifest"));I.oCard.refresh();d1.openBy(o,false);}).catch(function(f1){L.error(f1);});}}}}]);return Z;}(C),(x(j.prototype,"onInit",[f],Object.getOwnPropertyDescriptor(j.prototype,"onInit"),j.prototype),x(j.prototype,"onExit",[g],Object.getOwnPropertyDescriptor(j.prototype,"onExit"),j.prototype),x(j.prototype,"onKPIPressed",[k],Object.getOwnPropertyDescriptor(j.prototype,"onKPIPressed"),j.prototype)),j))||h);return Z;},false);
