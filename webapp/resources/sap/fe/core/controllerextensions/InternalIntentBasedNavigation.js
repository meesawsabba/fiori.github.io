/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2021 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/mvc/ControllerExtension","sap/ui/core/mvc/OverrideExecution","sap/fe/navigation/SelectionVariant","sap/fe/core/helpers/ModelHelper","sap/ui/core/util/XMLPreprocessor","sap/ui/core/XMLTemplateProcessor","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/base/Log","sap/fe/core/CommonUtils","sap/base/util/merge"],function(C,O,S,M,X,a,F,J,L,b,m){"use strict";return C.extend("sap.fe.core.controllerextensions.InternalInternalBasedNavigation",{metadata:{methods:{navigate:{"final":true,"public":true},getEntitySet:{"final":false,"public":false},navigateOutbound:{"final":true,"public":true},navigateWithConfirmationDialog:{"final":true,"public":true},getNavigationMode:{"final":false,"public":true,overrideExecution:O.Instead},prepareContextForExternalNavigation:{"final":true,"public":true},removeSensitiveData:{"final":true,"public":true},prepareFiltersForExternalNavigation:{"final":true,"public":true},getOutboundParams:{"final":true,"public":true}}},navigate:function(s,A,n){var t=this;var _=function(c){var N=n&&n.navigationContexts,d=N&&!Array.isArray(N)?[N]:N,v=n&&n.semanticObjectMapping,e=n&&n.additionalNavigationParameters,T={semanticObject:s,action:A},V=t.base.getView(),f=V.getController();if(c){t._oView.setBindingContext(c);}if(s&&A){var g=[],h=new S();if(d&&d.length){d.map(function(q){if(q.isA&&q.isA("sap.ui.model.odata.v4.Context")){var u=q.getObject(),w=t._oMetaModel.getMetaPath(q.getPath());u=t.removeSensitiveData(u,w);var x=t.prepareContextForExternalNavigation(u,q);T["propertiesWithoutConflict"]=x.propertiesWithoutConflict;g.push(x.semanticAttributes);}else if(!(q&&Array.isArray(q.data))&&typeof q==="object"){g.push(t.removeSensitiveData(q.data,q.metaPath));}else if(q&&Array.isArray(q.data)){g=t.removeSensitiveData(q.data,q.metaPath);}});}if(g&&g.length){h=t._oNavigationService.mixAttributesAndSelectionVariant(g,h.toJSONString());}var i=t._oView.getModel(),E=t.getEntitySet(),j=E?t._oNavigationService.constructContextUrl(E,i):undefined;if(j){h.setFilterContextUrl(j);}if(e){t._applyOutboundParams(h,e);}f.intentBasedNavigation.adaptNavigationContext(h,T);if(v){t._applySemanticObjectMappings(h,v);}t._removeTechnicalParameters(h);var k=f._intentBasedNavigation.getNavigationMode();var r=(n&&n.refreshStrategies)||{},I=V.getModel("internal");if(I){if(V&&V.getViewData().refreshStrategyOnAppRestore){var l=V.getViewData().refreshStrategyOnAppRestore||{};m(r,l);}var R=b.getRefreshStrategyForIntent(r,s,A);if(R){I.setProperty("/refreshStrategyOnAppRestore",R);}}var p=function(){sap.ui.require(["sap/m/MessageBox"],function(q){var u=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core");q.show(u.getText("C_COMMON_HELPER_NAVIGATION_ERROR_MESSAGE"),{title:u.getText("C_COMMON_NAVIGATION_ERROR_TITLE")});});};t._oNavigationService.navigate(s,A,h.toJSONString(),null,p,null,k);}else{throw new Error("Semantic Object/action is not provided");}};var B=this.base.getView().getBindingContext();var o=B&&B.getModel().getMetaModel();if(this.getView().getViewData().converterType==="ObjectPage"&&o&&!M.isStickySessionSupported(o)){b.fnProcessDataLossOrDraftDiscardConfirmation(_.bind(this),Function.prototype,this.base.getView().getBindingContext(),this.base.getView().getController());}else{_();}},prepareContextForExternalNavigation:function(s,c){function _(u,v){for(var K in u){if(u[K]===null||typeof u[K]!=="object"){if(!d[K]){d[K]=[];}d[K].push(v);}else{var N=u[K];_(N,v+"/"+K);}}}var d={},e=c.getPath(),o=c.getModel().getMetaModel(),f=o.getMetaPath(e),g=f.split("/").filter(Boolean);_(s,f);var h=g[0],j=o.getObject("/"+h+"/@sapui.name"),p={};var k,l,n;for(var D in d){var q=d[D],w;if(q.length>1){for(var i=0;i<=q.length-1;i++){var P=q[i],r=P.replace(P===f?f:f+"/","");r=(r===""?r:r+"/")+D;var E=o.getObject(P+"/@sapui.name");if(E===j){k=r;}if(P===f){l=r;}n=r;s[(f+"/"+r).split("/").filter(function(v){return v!="";}).join(".")]=c.getProperty(r);}w=k||l||n;s[D]=c.getProperty(w);k=undefined;l=undefined;n=undefined;}else{var P=q[0],r=P.replace(P===f?f:f+"/","");r=(r===""?r:r+"/")+D;s[D]=c.getProperty(r);p[D]=(f+"/"+r).split("/").filter(function(v){return v!="";}).join(".");}}for(var t in s){if(s[t]!==null&&typeof s[t]==="object"){delete s[t];}}return{semanticAttributes:s,propertiesWithoutConflict:p};},prepareFiltersForExternalNavigation:function(f,r,p){function _(j,l){for(var k in j){if(j[k]){if(k.includes("/")){l=k;var n=k.split("/");k=n[n.length-1];}else{l=r;}if(!d[k]){d[k]=[];}d[k].push(l);}}}var d={};_(f,r);var o={};var s,c,e,w,P;for(var D in d){var g=d[D];if(g.length>1){for(var i=0;i<=g.length-1;i++){var h=g[i];if(h===r){e=r+"/"+D;P=D;s=D;if(p&&p.includes(D)){f["$Parameter."+D]=f[D];}}else{P=h;e=(r+"/"+h).replaceAll("*","");c=h;}f[e.split("/").filter(function(v){return v!="";}).join(".")]=f[P];delete f[h];}w=s||c;f[D]=f[w];}else{var h=g[0],e=h===r?r+"/"+D:(r+"/"+h).replaceAll("*","");o[D]=e.split("/").filter(function(v){return v!="";}).join(".");if(p&&p.includes(D)){f["$Parameter."+D]=f[D];}}}return{filterConditions:f,filterConditionsWithoutConflict:o};},getNavigationMode:function(){return"inplace";},navigateWithConfirmationDialog:function(s,A,n){var t=this;if(n.notApplicableContexts&&n.notApplicableContexts.length>=1){var o;var c={onClose:function(){o.close();},onContinue:function(){n.navigationContexts=n.applicableContexts;o.close();t.navigate(s,A,n);}};var f=function(){var j,k=n.notApplicableContexts.length,N=[];for(var i=0;i<n.notApplicableContexts.length;i++){j=n.notApplicableContexts[i].getObject();N.push(j);}var l=new J(N);var T=new J({total:k,label:n.label});o.setModel(l,"notApplicable");o.setModel(T,"totals");o.open();};var d="sap.fe.core.controls.ActionPartial";var D=a.loadTemplate(d,"fragment");var e=this._oView.getModel();var g=e.getMetaModel();var h=n.notApplicableContexts[0].getCanonicalPath();var E=h.substr(0,h.indexOf("("))+"/";Promise.resolve(X.process(D,{name:d},{bindingContexts:{entityType:g.createBindingContext(E)},models:{entityType:g,metaModel:g}})).then(function(i){return F.load({definition:i,controller:c});}).then(function(p){o=p;t.getView().addDependent(p);f();}).catch(function(){L.error("Error");});}else{t.navigate(s,A,n);}},_removeTechnicalParameters:function(s){s.removeSelectOption("@odata.context");s.removeSelectOption("@odata.metadataEtag");s.removeSelectOption("SAP__Messages");},getEntitySet:function(){return this._oView.getViewData().entitySet;},removeSensitiveData:function(A,s){var p=Object.keys(A);if(p.length){delete A["@odata.context"];delete A["@odata.metadataEtag"];delete A["SAP__Messages"];for(var j=0;j<p.length;j++){if(A[p[j]]&&typeof A[p[j]]==="object"){this.removeSensitiveData(A[p[j]],s+"/"+p[j]);}var P=p[j],c=this._oMetaModel.getObject(s+"/"+P+"@");if(c){if(c["@com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"]||c["@com.sap.vocabularies.UI.v1.ExcludeFromNavigationContext"]||c["@com.sap.vocabularies.Analytics.v1.Measure"]){delete A[P];}else if(c["@com.sap.vocabularies.Common.v1.FieldControl"]){var f=c["@com.sap.vocabularies.Common.v1.FieldControl"];if(f["$EnumMember"]&&f["$EnumMember"].split("/")[1]==="Inapplicable"){delete A[P];}else if(f["$Path"]&&this._isFieldControlPathInapplicable(f["$Path"],A)){delete A[P];}}}}}return A;},_isFieldControlPathInapplicable:function(f,A){var i=false,p=f.split("/");if(p.length>1){i=A[p[0]]&&A[p[0]].hasOwnProperty(p[1])&&A[p[0]][p[1]]===0;}else{i=A[f]===0;}return i;},_applySemanticObjectMappings:function(s,v){var o=typeof v==="string"?JSON.parse(v):v;for(var i=0;i<o.length;i++){var l=(o[i]["LocalProperty"]&&o[i]["LocalProperty"]["$PropertyPath"])||(o[i]["@com.sap.vocabularies.Common.v1.LocalProperty"]&&o[i]["@com.sap.vocabularies.Common.v1.LocalProperty"]["$Path"]);var c=o[i]["SemanticObjectProperty"]||o[i]["@com.sap.vocabularies.Common.v1.SemanticObjectProperty"];if(s.getSelectOption(l)){var d=s.getSelectOption(l);s.removeSelectOption(l);s.massAddSelectOption(c,d);}}return s;},navigateOutbound:function(o,n){var c=this.base.getAppComponent().getManifestEntry("sap.app"),d=c.crossNavigation&&c.crossNavigation.outbounds[o];if(!d){L.error("Outbound is not defined in manifest!!");return;}var s=d.semanticObject,A=d.action,e=d.parameters&&this.getOutboundParams(d.parameters);if(n){var N=[];Object.keys(n).forEach(function(k){if(Array.isArray(n[k])){var v=n[k];for(var i=0;i<v.length;i++){var p={};p[k]=v[i];N.push(p);}}else{var p={};p[k]=n[k];N.push(p);}});}if(N||e){n={navigationContexts:{data:N||e}};}this.base._intentBasedNavigation.navigate(s,A,n);},_applyOutboundParams:function(s,o){var p=Object.keys(o);var c=s.getSelectOptionsPropertyNames();p.forEach(function(k){if(!c.includes(k)){s.addSelectOption(k,"I","EQ",o[k]);}});return s;},getOutboundParams:function(o){var p={};if(o){var P=Object.keys(o)||[];if(P.length>0){P.forEach(function(k){var c=o[k];if(c.value&&c.value.value&&c.value.format==="plain"){if(!p[k]){p[k]=c.value.value;}}});}}return p;},onChevronPressNavigateOutBound:function(c,o,d,s){var e=c.getAppComponent().getRoutingService().getOutbounds(),D=e[o],f;if(D&&D.semanticObject&&D.action){var r={intents:{}},g={},h;if(d){if(d.isA&&d.isA("sap.ui.model.odata.v4.Context")){h=b.getMetaPathForContext(d);d=[d];}else{h=b.getMetaPathForContext(d[0]);}g[h]="self";r["_feDefault"]=g;}if(s){var k=D.semanticObject+"-"+D.action;r.intents[k]={};r.intents[k][s]="self";}if(D&&D.parameters){var p=D.parameters&&this.getOutboundParams(D.parameters);if(Object.keys(p).length>0){f=p;}}c._intentBasedNavigation.navigate(D.semanticObject,D.action,{navigationContexts:d,refreshStrategies:r,additionalNavigationParameters:f});return Promise.resolve();}else{throw new Error("outbound target "+o+" not found in cross navigation definition of manifest");}},override:{onInit:function(){this._oAppComponent=this.base.getAppComponent();this._oMetaModel=this._oAppComponent.getModel().getMetaModel();this._oNavigationService=this._oAppComponent.getNavigationService();this._oView=this.base.getView();}}});});
