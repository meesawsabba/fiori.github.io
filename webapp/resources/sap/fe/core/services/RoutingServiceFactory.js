/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2021 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/service/Service","sap/ui/core/service/ServiceFactory","sap/ui/core/Component","sap/ui/base/BindingParser","sap/fe/core/helpers/SemanticKeyHelper","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/base/Log","sap/ui/base/EventProvider","sap/fe/core/BusyLocker","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/EditState","sap/fe/core/actions/messageHandling","sap/fe/core/controllerextensions/Placeholder"],function(S,c,C,B,d,F,e,L,E,f,M,g,h,P){"use strict";var R=E.extend("sap.fe.core.services.RoutingServiceEventing",{metadata:{events:{"routeMatched":{},"afterRouteMatched":{}}}});var k=S.extend("sap.fe.core.services.RoutingService",{init:function(){var t=this;var o=this.getContext();if(o.scopeType==="component"){this.oAppComponent=o.scopeObject;this.oModel=this.oAppComponent.getModel();this.oMetaModel=this.oModel.getMetaModel();this.oRouter=this.oAppComponent.getRouter();this.oRouterProxy=this.oAppComponent.getRouterProxy();this.eventProvider=new R();var r=this.oAppComponent.getManifestEntry("/sap.ui5/routing");var a=this.oAppComponent.getManifestEntry("/sap.ui5/rootView");this._parseRoutingConfiguration(r,a);var A=this.oAppComponent.getManifestEntry("/sap.app");this.outbounds=A&&A.crossNavigation&&A.crossNavigation.outbounds;}this.initPromise=Promise.resolve(t);},exit:function(){this.oRouter.detachRouteMatched(this._fnOnRouteMatched);this.eventProvider.fireEvent("routeMatched",{});this.eventProvider.destroy();},_parseRoutingConfiguration:function(r,o){var t=this,j=o&&o.viewName==="sap.fe.templates.RootContainer.view.Fcl";this._mTargets={};Object.keys(r.targets).forEach(function(T){t._mTargets[T]=Object.assign({targetName:T},r.targets[T]);if(t._mTargets[T].contextPattern!==undefined){t._mTargets[T].viewLevel=t._getViewLevelFromPattern(t._mTargets[T].contextPattern,0);}});this._mRoutes={};for(var s in r.routes){var l=r.routes[s],m=Array.isArray(l.target)?l.target:[l.target],n=Array.isArray(r.routes)?l.name:s,p=l.pattern;if(p.length<8||p.indexOf(":?query:")!==p.length-8){L.error("Pattern for route "+n+" doesn't end with ':?query:' : "+p);}var q=t._getViewLevelFromPattern(p,0);t._mRoutes[n]={name:n,pattern:p,targets:m,routeLevel:q};for(var i=0;i<m.length;i++){var u=t._mTargets[m[i]].parent;if(u){m.push(u);}}if(!j){if(t._mTargets[m[0]].viewLevel===undefined||t._mTargets[m[0]].viewLevel<q){t._mTargets[m[0]].viewLevel=q;}t._mTargets[m[0]].FCLLevel=-1;}else if(m.length===1&&t._mTargets[m[0]].controlAggregation!=="beginColumnPages"){t._mTargets[m[0]].FCLLevel=3;}else{m.forEach(function(T){switch(t._mTargets[T].controlAggregation){case"beginColumnPages":t._mTargets[T].FCLLevel=0;break;case"midColumnPages":t._mTargets[T].FCLLevel=1;break;default:t._mTargets[T].FCLLevel=2;}});}}Object.keys(t._mTargets).forEach(function(T){while(t._mTargets[T].parent){var u=t._mTargets[T].parent;t._mTargets[u].viewLevel=t._mTargets[u].viewLevel||t._mTargets[T].viewLevel;t._mTargets[u].contextPattern=t._mTargets[u].contextPattern||t._mTargets[T].contextPattern;t._mTargets[u].FCLLevel=t._mTargets[u].FCLLevel||t._mTargets[T].FCLLevel;t._mTargets[u].controlAggregation=t._mTargets[u].controlAggregation||t._mTargets[T].controlAggregation;T=u;}});var v=[],w=[],D;for(var N in t._mRoutes){var x=t._mRoutes[N].routeLevel;if(x===0){v.push(N);}else if(x===1){w.push(N);}}if(v.length===1){D=v[0];}else if(w.length===1){D=w[0];}if(D){var y=t._mRoutes[D].targets.slice(-1)[0];t.sContextPath="";if(t._mTargets[y].options&&t._mTargets[y].options.settings){var z=t._mTargets[y].options.settings;t.sContextPath=z.contextPath||"/"+z.entitySet;}if(!t.sContextPath){L.error("Cannot determine default contextPath: contextPath or entitySet missing in default target: "+y);}}else{L.error("Cannot determine default contextPath: no default route found.");}Object.keys(t._mTargets).map(function(T){return t._mTargets[T];}).sort(function(a,b){return a.viewLevel<b.viewLevel?-1:1;}).forEach(function(a){if(a.options){var b=a.options.settings;var A=b.contextPath||(b.entitySet?"/"+b.entitySet:"");if(!b.fullContextPath&&A){if(a.viewLevel===0||a.viewLevel===undefined){b.fullContextPath="/";}else{b.fullContextPath=A+"/";}}Object.keys(b.navigation||{}).forEach(function(G){var H=t._mRoutes[b.navigation[G].detail.route];if(H&&H.targets){H.targets.forEach(function(T){if(t._mTargets[T].options&&t._mTargets[T].options.settings&&!t._mTargets[T].options.settings.fullContextPath){var I;if(G.startsWith("/")){I=G;}else{I=b.fullContextPath+G;}t._mTargets[T].options.settings.fullContextPath=I+"/";}});}});}});},_getViewLevelFromPattern:function(p,v){p=p.replace(":?query:","");var r=new RegExp("/[^/]*$");if(p&&p[0]!=="/"&&p[0]!=="?"){p="/"+p;}if(p.length){p=p.replace(r,"");if(this.oRouter.match(p)||p===""){return this._getViewLevelFromPattern(p,++v);}else{return this._getViewLevelFromPattern(p,v);}}else{return v;}},_getRouteInformation:function(r){return this._mRoutes[r];},_getTargetInformation:function(t){return this._mTargets[t];},_getComponentId:function(o,s){if(s.indexOf(o+"---")===0){return s.substr(o.length+3);}return s;},getTargetInformationFor:function(o){var t=this._getComponentId(o._sOwnerId,o.getId());var a=this;var s=null;Object.keys(this._mTargets).forEach(function(T){if(a._mTargets[T].id===t||a._mTargets[T].viewId===t){s=T;}});return this._getTargetInformation(s);},getLastSemanticMapping:function(){return this.oLastSemanticMapping;},setLastSemanticMapping:function(m){this.oLastSemanticMapping=m;},navigateTo:function(o,r,p,b){var t;if(!p){t=Promise.resolve(d.getSemanticPath(o));}else{t=this.prepareParameters(p,r,o).then(function(m){return this.oRouter.getURL(r,m);}.bind(this));}return t.then(function(T){this.oRouterProxy.navToHash(T,b);}.bind(this));},prepareParameters:function(p,t,o){var a;try{var s=o.getPath();var b=s.split("/");var A=Object.keys(p).map(function(j){var l=p[j];var m=B.complexParser(l);var n=m.parts||[m];var r=n.map(function(q){var u=q.path.split("../");var v=b.slice(0,b.length-u.length+1);v.push(u[u.length-1]);return o.requestProperty(v.join("/"));});return Promise.all(r).then(function(q){var v=m.formatter?m.formatter.apply(this,q):q.join("");return{key:j,value:v};}.bind(this));}.bind(this));a=Promise.all(A).then(function(j){var l={};j.forEach(function(r){l[r.key]=r.value;});return l;});}catch(i){L.error("Could not parse the parameters for the navigation to route "+t);a=Promise.resolve(undefined);}return a;},_fireRouteMatchEvents:function(p){this.eventProvider.fireEvent("routeMatched",p);this.eventProvider.fireEvent("afterRouteMatched",p);g.cleanProcessedEditState();},navigateToContext:function(o,p,v,a){var t,r;if(p.targetPath&&v&&v.navigation){var b=v.navigation[p.targetPath].detail;t=b.route;if(b.parameters){r=this.prepareParameters(b.parameters,t,o);}}var T=this._getPathFromContext(o,p);if(T.length===0&&this.bExitOnNavigateBackToRoot){return this.oRouterProxy.exitFromApp();}if(p.asyncContext||p.bDeferredContext){T+="(...)";}var l=this._calculateLayout(T,p);if(l){T+="?layout="+l;}var n={oAsyncContext:p.asyncContext,bDeferredContext:p.bDeferredContext,bTargetEditable:p.editable,bPersistOPScroll:p.bPersistOPScroll,useContext:p.updateFCLLevel===-1||p.bRecreateContext?undefined:o,bDraftNavigation:p.bDraftNavigation,bShowPlaceholder:p.showPlaceholder!==undefined?p.showPlaceholder:true};if(p.checkNoHashChange){var s=this.oRouterProxy.getHash().replace(/[&?]{1}sap-iapp-state=[A-Z0-9]+/,"");if(T===s){var m=this.oRouter.getRouteInfoByHash(this.oRouterProxy.getHash());m.navigationInfo=n;m.routeInformation=this._getRouteInformation(this.sCurrentRouteName);m.routePattern=this.sCurrentRoutePattern;m.views=this.aCurrentViews;this.oRouterProxy.storeFocusForHash(0,null,this.oRouterProxy.getHash());this._fireRouteMatchEvents(m);return Promise.resolve();}}if(p.transient&&p.editable==true&&T.indexOf("(...)")===-1){if(T.indexOf("?")>-1){T+="&i-action=create";}else{T+="?i-action=create";}}if(a&&a.name==="sap.fe.templates.ListReport"){var i=this.oRouter.getRouteInfoByHash(T);if(i){var j=this._getRouteInformation(i.name);if(j&&j.targets&&j.targets.length>0){var q=j.targets[j.targets.length-1];var u=this._getTargetInformation(q);if(u&&u.name==="sap.fe.templates.ObjectPage"){h.removeUnboundTransitionMessages();}}}}this.navigationInfoQueue.push(n);if(t&&r){return r.then(function(w){this.oRouter.navTo(t,w);return Promise.resolve();}.bind(this));}return this.oRouterProxy.navToHash(T,false,p.noPreservationCache);},isCurrentStateImpactedBy:function(o){var p=o.getPath();if(this.oRouterProxy.isCurrentStateImpactedBy(p)){return true;}else if(/^[^\(\)]+\([^\(\)]+\)$/.test(p)){var s;if(this.oLastSemanticMapping&&this.oLastSemanticMapping.technicalPath===p){s=this.oLastSemanticMapping.semanticPath;}else{s=d.getSemanticPath(o);}return s!=p?this.oRouterProxy.isCurrentStateImpactedBy(s):false;}else{return false;}},_findPathToNavigate:function(p){var r=new RegExp("/[^/]*$");p=p.replace(r,"");if(this.oRouter.match(p)||p===""){return p;}else{return this._findPathToNavigate(p);}},_checkContextForSemanticPath:function(o){var p=o.getPath();if(!/^\/[^\(]+\([^\)]+\)$/.test(p)){return false;}var m=o.getModel().getMetaModel(),s=m.getMetaContext(o.getPath()).getObject("@sapui.name");if(!d.getSemanticKeys(m,s)){return false;}return M.isDraftSupported(m,p);},_getPathFromContext:function(o,p){var s;if(o.isA("sap.ui.model.odata.v4.ODataListBinding")&&o.isRelative()){s=o.getHeaderContext().getPath();}else{s=o.getPath();}if(p.updateFCLLevel===-1){s=this._findPathToNavigate(s);if(this.oLastSemanticMapping&&this.oLastSemanticMapping.technicalPath===s){s=this.oLastSemanticMapping.semanticPath;}}else if(this._checkContextForSemanticPath(o)){var a=d.getSemanticPath(o,true);if(!a){this.setLastSemanticMapping(undefined);}else if(a!==s){this.setLastSemanticMapping({technicalPath:s,semanticPath:a});s=a;}}if(s[0]==="/"){s=s.substring(1);}return s;},_calculateLayout:function(p,m){var a=m.FCLLevel;if(m.updateFCLLevel){a+=m.updateFCLLevel;if(a<0){a=0;}}return this.oAppComponent.getRootViewController().calculateLayout(a,p,m.sLayout);},_beforeRouteMatched:function(o){var p=new P().isPlaceholderEnabled();if(!p){var r=this.oAppComponent.getRootControl();f.lock(r);}},_onRouteMatched:function(o){var a=this.oAppComponent.getAppStateHandler(),r=this.oAppComponent.getRootControl(),t=this;var p=new P().isPlaceholderEnabled();if(f.isLocked(r)&&!p){f.unlock(r);}var m=o.getParameters();if(this.navigationInfoQueue.length){m.navigationInfo=this.navigationInfoQueue[0];this.navigationInfoQueue=this.navigationInfoQueue.slice(1);}else{m.navigationInfo={};}if(a.checkIfRouteChangedByIApp()){m.navigationInfo.bReasonIsIappState=true;a.resetRouteChangedByIApp();}this.sCurrentRouteName=o.getParameter("name");this.sCurrentRoutePattern=o.getParameters().config.pattern;this.aCurrentViews=o.getParameter("views");m.routeInformation=this._getRouteInformation(this.sCurrentRouteName);m.routePattern=this.sCurrentRoutePattern;this._fireRouteMatchEvents(m);if(!history.state||history.state.feLevel===undefined){this.oRouterProxy.restoreHistory().then(function(){t.oRouterProxy.resolveRouteMatch();}).catch(function(b){L.error("Error while restoring history",b);});}else{this.oRouterProxy.resolveRouteMatch();}},attachRouteMatched:function(D,a,l){this.eventProvider.attachEvent("routeMatched",D,a,l);},detachRouteMatched:function(a,l){this.eventProvider.detachEvent("routeMatched",a,l);},attachAfterRouteMatched:function(D,a,l){this.eventProvider.attachEvent("afterRouteMatched",D,a,l);},detachAfterRouteMatched:function(a,l){this.eventProvider.detachEvent("afterRouteMatched",a,l);},getRouteFromHash:function(r,a){var H=r.getHashChanger().hash;var o=r.getRouteInfoByHash(H);return a.getMetadata().getManifestEntry("/sap.ui5/routing/routes").filter(function(b){return b.name===o.name;})[0];},getTargetsFromRoute:function(r,a){var t=r.target;var b=this;if(typeof t==="string"){return[this._mTargets[t]];}else{var T=[];t.forEach(function(s){T.push(b._mTargets[s]);});return T;}},initializeRouting:function(){var t=this;this._fnOnRouteMatched=this._onRouteMatched.bind(this);this.oRouter.attachRouteMatched(this._fnOnRouteMatched);var p=new P().isPlaceholderEnabled();if(!p){this.oRouter.attachBeforeRouteMatched(this._beforeRouteMatched.bind(this));}this.navigationInfoQueue=[];g.resetEditState();this.bExitOnNavigateBackToRoot=!this.oRouter.match("");var i=t.oRouter.getHashChanger().getHash().indexOf("sap-iapp-state")!==-1;var a=t.oAppComponent.getStartupParameters().then(function(s){var H=s!==undefined&&Object.keys(s).length!==0;if(!i&&H){var b=t.oRouter.getHashChanger().getHash();if(s.preferredMode&&s.preferredMode[0].indexOf("create")!==-1&&!b){return t._managePreferredModeCreateStartup(s);}else{return t._manageDeeplinkStartup(s);}}}).catch(function(o){L.error("Error during routing initialization",o);});return a;},getDefaultCreateHash:function(s){var a=this.getContextPath(),D=s&&s.preferredMode?s.preferredMode[0]:"create",H;D=D.indexOf(":")!==-1&&D.length>D.indexOf(":")+1?D.substr(0,D.indexOf(":")):"create";H=a.substring(1)+"(...)?i-action="+D;if(this.oRouter.getRouteInfoByHash(H)){return H;}else{throw new Error("No route match for creating a new "+a.substring(1));}},_managePreferredModeCreateStartup:function(s){var t=this;return this.oMetaModel.requestObject(this.getContextPath()+"@").then(function(o){var m,b=true;if(o["@com.sap.vocabularies.Common.v1.DraftRoot"]&&o["@com.sap.vocabularies.Common.v1.DraftRoot"]["NewAction"]){m=t.getContextPath()+"@com.sap.vocabularies.Common.v1.DraftRoot/NewAction@Org.OData.Core.V1.OperationAvailable";}else if(o["@com.sap.vocabularies.Session.v1.StickySessionSupported"]&&o["@com.sap.vocabularies.Session.v1.StickySessionSupported"]["NewAction"]){m=t.getContextPath()+"@com.sap.vocabularies.Session.v1.StickySessionSupported/NewAction@Org.OData.Core.V1.OperationAvailable";}if(m){var n=t.oMetaModel.getObject(m);if(n===false){b=false;}}else{var i=o["@Org.OData.Capabilities.V1.InsertRestrictions"];if(i&&i.Insertable===false){b=false;}}if(b){var p=t.getDefaultCreateHash(s);t.oRouter.getHashChanger().replaceHash(p);t.bExitOnNavigateBackToRoot=true;}}).catch(function(){L.error("Cannot fetch the Annotations");});},_manageDeeplinkStartup:function(s){var t=this,a;return this.oMetaModel.requestObject("/$EntityContainer/").then(function(){var l=t._getNavigablePages(t.oAppComponent.getManifest()["sap.ui5"].routing);a=t._findTargetPagesFromStartupParams(l,s);var b=a.map(function(p){var o,i;if(p.isSemanticKeyNavigation){o=t._createFilter(p.draft,p.semanticKeys,s);}else{o=t._createFilter(p.draft,p.technicalKeys,s);}i=t.oModel.bindList(p.contextPath,undefined,undefined,o);return i.requestContexts(0,2);});return Promise.all(b);}).then(function(v){if(v.length){var b=[];v.forEach(function(i){if(i.length===1){b.push(i[0]);}});if(b.length===v.length&&!t.oRouter.getHashChanger().getHash()){var H=t._buildStartupHash(a,b);if(H){t.oRouter.getHashChanger().replaceHash(H);}}}}).catch(function(b){L.info("Could not find results for list bind: "+b);});},_getNavigablePages:function(r){var a=r.routes,t=r.targets,p={};for(var i=0;i<a.length;i++){var o={},s=a[i].pattern,T=a[i].target,l=s.split("/").length-1;o["pattern"]=s;if(s===":?query:"||s===""){continue;}if(l===1&&s.split("/")[l]===":?query:"){l=0;}o["level"]=l;if(Array.isArray(T)){o["target"]=T[T.length-1];}else{o["target"]=T;}if(t[o.target].options&&t[o.target].options.settings){o["allowDeepLinking"]=t[o.target].options.settings.allowDeepLinking;var b=t[o.target].options.settings.contextPath||(t[o.target].options.settings.entitySet&&"/"+t[o.target].options.settings.entitySet);o["contextPath"]=b;}if(!o["allowDeepLinking"]&&o["level"]!==0){continue;}else if(!p[o.level]){p[o.level]=[];}p[o.level].push(o);}return p;},_findTargetPagesFromStartupParams:function(p,s){var l=0,r=[],b=true;while(b&&l in p){var o=p[l];b=false;for(var i=0;i<o.length;++i){var O=o[i];if(!O.contextPath&&O.level===0){O.contextPath=this.getContextPath();}if(!O.contextPath){continue;}O.entityType=this.oMetaModel.getObject("/$EntityContainer"+O.contextPath+"/");O.draft=this.oMetaModel.getObject("/$EntityContainer"+O.contextPath+"@com.sap.vocabularies.Common.v1.DraftRoot")||this.oMetaModel.getObject("/$EntityContainer"+O.contextPath+"@com.sap.vocabularies.Common.v1.DraftNode");O.technicalKeys=O.entityType["$Key"];O.semanticKeys=this.oMetaModel.getObject("/$EntityContainer"+O.contextPath+"/@com.sap.vocabularies.Common.v1.SemanticKey");if(this._checkForKeys(O.semanticKeys,s)){O.isSemanticKeyNavigation=true;r.push(O);b=true;break;}else if(O.level===0&&this._checkForKeys(O.technicalKeys,s)){O.isSemanticKeyNavigation=false;r.push(O);b=true;break;}}++l;}return r;},_createFilter:function(D,K,s){var a=[],b=M.isFilteringCaseSensitive(this.oMetaModel);for(var j=0;j<K.length;j++){var p=K[j].$PropertyPath;if(!p){p=K[j];if(p==="IsActiveEntity"){D=false;}}var v=s[p][0];if(v){a.push(new F({path:p,operator:e.EQ,value1:v,caseSensitive:b}));}else{return undefined;}}if(D){var o=new F({filters:[new F("IsActiveEntity","EQ",false),new F("SiblingEntity/IsActiveEntity","EQ",null)],and:false});a.push(o);}var i=new F(a,true);return i;},_checkForKeys:function(K,p){if(K&&K.length){for(var j=0;j<K.length;j++){var s=K[j].$PropertyPath;if(!s){s=K[j];}var a=p[s];if(!a||(a&&a.length>1)){return false;}}return true;}return false;},_buildStartupHash:function(r,a){var H;if(a.length===1){var t=a[0].getPath(),s=d.getSemanticPath(a[0]);if(s!==t){this.setLastSemanticMapping({technicalPath:t,semanticPath:s});}H=s.substring(1);}else if(a.length>1){var p=r[r.length-1].pattern.split("/");H=p.map(function(b,i){var K=b.split("(")[0];var v=a[i].getPath().split("(")[1];return K+"("+v;}).join("/");}return H;},getOutbounds:function(){return this.outbounds;},getContextPath:function(){return this.sContextPath;}});return c.extend("sap.fe.core.services.RoutingServiceFactory",{createInstance:function(s){var r=new k(s);return r.initPromise;}});},true);
