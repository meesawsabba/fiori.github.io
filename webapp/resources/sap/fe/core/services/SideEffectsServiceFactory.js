/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/ui/core/service/ServiceFactory","sap/ui/core/service/Service","sap/fe/core/converters/MetaModelConverter","sap/base/Log"],function(S,a,M,L){"use strict";var c=M.convertTypes;function b(o,e){var i=Object.keys(o);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(o);if(e){p=p.filter(function(u){return Object.getOwnPropertyDescriptor(o,u).enumerable;});}i.push.apply(i,p);}return i;}function _(e){for(var i=1;i<arguments.length;i++){var o=arguments[i]!=null?arguments[i]:{};if(i%2){b(Object(o),true).forEach(function(p){d(e,p,o[p]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(e,Object.getOwnPropertyDescriptors(o));}else{b(Object(o)).forEach(function(p){Object.defineProperty(e,p,Object.getOwnPropertyDescriptor(o,p));});}}return e;}function d(o,e,v){if(e in o){Object.defineProperty(o,e,{value:v,enumerable:true,configurable:true,writable:true});}else{o[e]=v;}return o;}function f(i,C){if(!(i instanceof C)){throw new TypeError("Cannot call a class as a function");}}function g(e,p){for(var i=0;i<p.length;i++){var o=p[i];o.enumerable=o.enumerable||false;o.configurable=true;if("value"in o)o.writable=true;Object.defineProperty(e,o.key,o);}}function h(C,p,e){if(p)g(C.prototype,p);if(e)g(C,e);return C;}function j(e,i){if(typeof i!=="function"&&i!==null){throw new TypeError("Super expression must either be null or a function");}e.prototype=Object.create(i&&i.prototype,{constructor:{value:e,writable:true,configurable:true}});if(i)k(e,i);}function k(o,p){k=Object.setPrototypeOf||function k(o,p){o.__proto__=p;return o;};return k(o,p);}function l(D){var e=q();return function p(){var i=r(D),o;if(e){var N=r(this).constructor;o=Reflect.construct(i,arguments,N);}else{o=i.apply(this,arguments);}return m(this,o);};}function m(e,i){if(i&&(typeof i==="object"||typeof i==="function")){return i;}return n(e);}function n(e){if(e===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return e;}function q(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true;}catch(e){return false;}}function r(o){r=Object.setPrototypeOf?Object.getPrototypeOf:function r(o){return o.__proto__||Object.getPrototypeOf(o);};return r(o);}var s=function(i){j(s,i);var o=l(s);function s(){f(this,s);return o.apply(this,arguments);}h(s,[{key:"init",value:function e(){this._oSideEffectsType={oData:{entities:{},actions:{}},control:{}};this._bInitialized=false;this.initPromise=Promise.resolve(this);}},{key:"addControlSideEffects",value:function u(e,p){if(p.sourceControlId){var C=_(_({},p),{},{fullyQualifiedName:e+"/SideEffectsForControl/"+p.sourceControlId});var E=this._oSideEffectsType.control[e]||{};E[C.sourceControlId]=C;this._oSideEffectsType.control[e]=E;}}},{key:"executeAction",value:function p(T,C,G){var e=C.getModel().bindContext(T+"(...)",C);e.execute(G||C.getBinding().getUpdateGroupId());}},{key:"getConvertedMetaModel",value:function u(){var C=this.getContext();var e=C.scopeObject;var p=e.getModel().getMetaModel();return c(p,this._oCapabilities);}},{key:"getEntityTypeFromContext",value:function u(C){var e=C.getModel().getMetaModel(),p=e.getMetaPath(C.getPath()),E=e.getObject(p)["$Type"];return E;}},{key:"getODataEntitySideEffects",value:function p(e){return this._oSideEffectsType.oData.entities[e]||{};}},{key:"getODataActionSideEffects",value:function u(A,C){if(C){var e=this.getEntityTypeFromContext(C);if(e){var p;return(p=this._oSideEffectsType.oData.actions[e])===null||p===void 0?void 0:p[A];}}return undefined;}},{key:"initializeSideEffects",value:function u(C){var e=this;this._oCapabilities=C;if(!this._bInitialized){var p=this.getConvertedMetaModel();p.entityTypes.forEach(function(v){e._oSideEffectsType.oData.entities[v.fullyQualifiedName]=e._retrieveODataEntitySideEffects(v);e._oSideEffectsType.oData.actions[v.fullyQualifiedName]=e._retrieveODataActionsSideEffects(v);});this._bInitialized=true;}}},{key:"removeControlSideEffects",value:function p(C){var e=this;Object.keys(this._oSideEffectsType.control).forEach(function(E){if(e._oSideEffectsType.control[E][C]){delete e._oSideEffectsType.control[E][C];}});}},{key:"requestSideEffects",value:function u(p,C,G){this._logRequest(p,C);var P;try{P=C.requestSideEffects(p,G);}catch(e){P=Promise.reject(e);}return P;}},{key:"requestSideEffectsForNavigationProperty",value:function u(N,C){var e=this;var B=this.getEntityTypeFromContext(C);if(B){var p=this.getODataEntitySideEffects(B);var T=[];Object.keys(p).filter(function(A){var v=p[A];return(v.SourceProperties||[]).some(function(P){return P.value.indexOf(N)>-1;})||(v.SourceEntities||[]).some(function(w){return w.value===N;});}).forEach(function(A){var v=p[A];if(v.TriggerAction){e.executeAction(v.TriggerAction,C);}(v.TargetEntities||[]).concat(v.TargetProperties||[]).forEach(function(w){return T.push(w);});});T=this._removeDuplicateTargets(T);if(T.length>0){return this.requestSideEffects(T,C).catch(function(E){return L.error("SideEffects - Error while processing SideEffects for Navigation Property "+N,E);});}}return Promise.resolve();}},{key:"getControlEntitySideEffects",value:function p(e){return this._oSideEffectsType.control[e]||{};}},{key:"_addRequiredTextProperties",value:function u(e,E){var I=e.TargetProperties||[],p=(e.TargetEntities||[]).map(function(v){return v.$NavigationPropertyPath;});var D=[];I.forEach(function(P){var v=P.endsWith("*"),N=P.substring(0,P.lastIndexOf("/")),R=N?N+"/":"",T=E.resolvePath(N)||E;if(T){var w;var x=T.entityProperties||((w=T.targetType)===null||w===void 0?void 0:w.properties)||T.targetType.entityProperties;if(x){if(v){if(x){p.push(N);D=D.concat(x.map(function(y){return{navigationPath:R,property:y};}));}}else{D.push({property:x.find(function(y){return y.name===P.split("/").pop();}),navigationPath:R});}}else{L.info("SideEffects - The entity type associated to property path "+P+" cannot be resolved");}}else{L.info("SideEffects - The property path "+P+" cannot be resolved");}});D.forEach(function(P){if(P.property){var v,w,x;var T=(v=P.property.annotations)===null||v===void 0?void 0:(w=v.Common)===null||w===void 0?void 0:(x=w.Text)===null||x===void 0?void 0:x.path,y=P.navigationPath+T;if(T&&p.indexOf(y.substring(0,y.lastIndexOf("/")))===-1&&I.indexOf(y)===-1){e.TargetProperties.push(y);}}});return e;}},{key:"_convertSideEffects",value:function u(e,E,B){var p=this.getConvertedMetaModel().entityTypes.find(function(v){return v.fullyQualifiedName===E;});var T=this._removeBindingParameter(this._convertTargetsFormat(e),B);return p?this._replaceReferencedProperties(this._addRequiredTextProperties(T,p),p):T;}},{key:"_convertTargetsFormat",value:function u(e){var T=(e.TargetProperties||[]).reduce(function(v,w){var x=typeof w==="string"&&w||w.type==="PropertyPath"&&w.value;if(x){v.push(x);}else{L.error("SideEffects - Error while processing TargetProperties for SideEffects"+e.fullyQualifiedName);}return v;},[]),p=(e.TargetEntities||[]).map(function(v){return{"$NavigationPropertyPath":v.$NavigationPropertyPath||v.value||""};});return _(_({},e),{TargetProperties:T,TargetEntities:p});}},{key:"_getSideEffectsFromSource",value:function y(e){var p=this;var u=[];var v=["EntityType","Action"];if(e._type&&v.indexOf(e._type)>-1){var E=e._type==="EntityType"?e:e.sourceEntityType;if(E){var w;var C=((w=e.annotations)===null||w===void 0?void 0:w.Common)||{};var B=(e.parameters||[]).find(function(P){return P.type===(E||e).fullyQualifiedName;});var x=B?B.fullyQualifiedName.split("/")[1]:"";Object.keys(C).filter(function(A){return C[A].$Type==="com.sap.vocabularies.Common.v1.SideEffectsType";}).forEach(function(A){u.push(p._convertSideEffects(C[A],E.fullyQualifiedName,x));});}}return u;}},{key:"_logRequest",value:function e(p,C){var T=p.reduce(function(P,u){return P+"\n\t\t"+(u.$NavigationPropertyPath||u||"");},"");L.debug("SideEffects - Request:\n\tContext path : "+C.getPath()+"\n\tProperty paths :"+T);}},{key:"_removeBindingParameter",value:function p(e,B){if(B){var T=["TargetProperties","TargetEntities"];T.forEach(function(u){var v=e[u];if(v){v=v.map(function(P){var N=P.$NavigationPropertyPath!==undefined;var V=(N?P.$NavigationPropertyPath:P).replace(new RegExp("^"+B+"?."),"");return N?{$NavigationPropertyPath:V}:V;});}e[u]=v;});}return e;}},{key:"_removeDuplicateTargets",value:function e(T){return T.filter(function(p,I,T){return T.findIndex(function(u){return u===p||p.$NavigationPropertyPath&&u.$NavigationPropertyPath===p.$NavigationPropertyPath;})===I;});}},{key:"_replaceReferencedProperties",value:function v(e,E){var p=false;var u=(e.TargetEntities||[]).map(function(N){return N.$NavigationPropertyPath;})||[],P=[];e.TargetProperties.forEach(function(w){var T=false;var x=w.lastIndexOf("/");if(x!==-1){var N=w.substring(0,x);var y=E.resolvePath(N);if(y&&y._type==="NavigationProperty"){p=true;T=true;if(!u.includes(N)){u.push(N);}}}if(!T){P.push(w);}});if(p){e.TargetProperties=P;e.TargetEntities=u.map(function(N){return{$NavigationPropertyPath:N};});}return e;}},{key:"_retrieveODataActionsSideEffects",value:function v(e){var p=this;var u={};var A=e.actions;if(A){Object.keys(A).forEach(function(w){var x=e.actions[w];var y=[];var z=[];var T=[];p._getSideEffectsFromSource(x).forEach(function(B){var C=B.TriggerAction;T=T.concat(B.TargetEntities||[]).concat(B.TargetProperties||[]);if(C&&y.indexOf(C)===-1){y.push(C);}});z=p._removeDuplicateTargets(T);u[w]={pathExpressions:z,triggerActions:y};});}return u;}},{key:"_retrieveODataEntitySideEffects",value:function p(e){var E={};this._getSideEffectsFromSource(e).forEach(function(u){E[u.fullyQualifiedName]=u;});return E;}},{key:"getInterface",value:function e(){return this;}}]);return s;}(a);var t=function(e){j(t,e);var i=l(t);function t(){f(this,t);return i.apply(this,arguments);}h(t,[{key:"createInstance",value:function u(o){var p=new s(o);return p.initPromise;}}]);return t;}(S);return t;},false);
