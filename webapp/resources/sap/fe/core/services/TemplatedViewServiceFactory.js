/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2021 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/service/Service","sap/ui/core/service/ServiceFactory","sap/ui/core/service/ServiceFactoryRegistry","sap/ui/model/base/ManagedObjectModel","sap/ui/model/resource/ResourceModel","sap/ui/core/mvc/View","sap/ui/core/Component","sap/ui/model/json/JSONModel","sap/base/Log","sap/fe/core/TemplateModel","sap/fe/core/helpers/DynamicAnnotationPathHelper","sap/ui/core/cache/CacheManager","sap/ui/VersionInfo","sap/ui/Device"],function(S,a,b,M,R,V,C,J,L,T,D,c,d,e){"use strict";var f=S.extend("sap.fe.core.services.TemplatedViewService",{initPromise:null,init:function(){var t=this;var g=[];var o=this.getContext();var h=o.scopeObject;var A=C.getOwnerComponentFor(h);var m=A.getMetaModel();var j=A.getMetadata().getComponentName()+"::"+A.getLocalId(h.getId());var E=h.getEnhanceI18n()||[];var k;if(E){k=A.getMetadata().getComponentName();for(var i=0;i<E.length;i++){var r=A.getModel(E[i]);if(r&&r.isA("sap.ui.model.resource.ResourceModel")){E[i]=r;}else{E[i]=k+"."+E[i].replace(".properties","");}}}var l=A.getMetadata().getName()+"_"+j+"_"+sap.ui.getCore().getConfiguration().getLanguageTag();g.push(b.get("sap.fe.core.services.ResourceModelService").createInstance({scopeType:"component",scopeObject:h,settings:{bundles:["sap.fe.core.messagebundle","sap.fe.templates.messagebundle"],enhanceI18n:E,modelName:"sap.fe.i18n"}}).then(function(n){t.oResourceModelService=n;return n.getResourceModel();}));g.push(b.get("sap.fe.core.services.CacheHandlerService").createInstance({settings:{metaModel:m,appComponent:A,component:h}}).then(function(n){t.oCacheHandlerService=n;return n.validateCacheKey(l);}));g.push(d.load().then(function(I){var n="";if(!I.libraries){n=sap.ui.buildinfo.buildtime;}else{I.libraries.forEach(function(q){n+=q.buildTimestamp;});}return n;}).catch(function(){return"<NOVALUE>";}));var p="";this.initPromise=Promise.all(g).then(function(n){var q=n[1];var v=n[2];var u=A.getShellServices();var w=A.getSideEffectsService();w.initializeSideEffects(A.getEnvironmentCapabilities().getCapabilities());p=q+"-"+v+"-"+j+"-"+u.instanceType+"-pageModel";return Promise.all(n.concat([t._getCachedModel(p)]));}).then(function(n){var r=n[0];var q=n[1];var P=n[3];return new Promise(function(u){sap.ui.require(["sap/fe/core/converters/TemplateConverter","sap/fe/core/converters/MetaModelConverter"],function(v,w){u(t.createView(r,j,q,p,P,v,w));});});}).then(function(n){var q=b.get("sap.fe.core.services.CacheHandlerService").getInstance(m);q.invalidateIfNeeded(n,l);});},_getCachedModel:function(g){if(sap.ui.getCore().getConfiguration().getViewCache()){return c.get(g);}return undefined;},_setCachedModel:function(g,o){if(sap.ui.getCore().getConfiguration().getViewCache()){c.set(g,o);}return undefined;},refreshView:function(o){var t=this;var r=o.getRootControl();if(r){r.destroy();}else if(t.oView){t.oView.destroy();}return t.createView(t.resourceModel,t.stableId,"","",undefined,t.TemplateConverter,t.MetaModelConverter).then(function(){o.oContainer.invalidate();}).catch(function(E){o.oContainer.invalidate();L.error(E);});},createView:function(r,g,h,p,P,i,j){var t=this;t.resourceModel=r;t.stableId=g;t.TemplateConverter=i;t.MetaModelConverter=j;var o=this.getContext(),m=o.settings,k=m.converterType,l=o.scopeObject,A=C.getOwnerComponentFor(l),F=A.getRoutingService().getTargetInformationFor(l).options.settings.fullContextPath,n=A.getMetaModel(),q=A.getManifest(),u=new J(sap.ui.Device).setDefaultBindingMode("OneWay"),v=new J(q),E=false,w,x,y,z;this.oFactory=o.factory;function B(){var H=F.split("/");var I=H.reduce(function(K,N){if(N===""){return K;}if(K===""){K="/"+N;}else{var O=n.getObject(K+"/$NavigationPropertyBinding/"+N);if(O&&Object.keys(O).length>0){K+="/$NavigationPropertyBinding";}K+="/"+N;}return K;},"");var y={type:"XML",preprocessors:{xml:{bindingContexts:{entitySet:I?n.createBindingContext(I):null,fullContextPath:F?n.createBindingContext(F):null,contextPath:F?n.createBindingContext(F):null,converterContext:w.createBindingContext("/",null,{noResolve:true}),viewData:z?x.createBindingContext("/"):null},models:{entitySet:n,fullContextPath:n,contextPath:n,"sap.fe.i18n":r,metaModel:n,"device":u,manifest:v,converterContext:w,viewData:x},appComponent:A}},id:g,viewName:m.viewName||l.getViewName(),viewData:z,cache:{keys:[h]},models:{"sap.fe.i18n":r},height:"100%"};return y;}function G(H){L.error(H.message,H);y.viewName=m.errorViewName||"sap.fe.core.services.view.TemplatingErrorPage";y.preprocessors.xml.models["error"]=new J(H);return l.runAsOwner(function(){return V.create(y).then(function(I){t.oView=I;t.oView.setModel(new M(t.oView),"$view");l.setAggregation("rootControl",t.oView);return h;});});}return A.getService("routingService").then(function(H){var I=H.getTargetInformationFor(l);var O=q["sap.app"]&&q["sap.app"].crossNavigation&&q["sap.app"].crossNavigation.outbounds;var N=l.getNavigation()||{};Object.keys(N).forEach(function(Q){var U=N[Q];var W;if(U.detail&&U.detail.outbound&&O[U.detail.outbound]){W=O[U.detail.outbound];U.detail.outboundDetail={semanticObject:W.semanticObject,action:W.action,parameters:W.parameters};}if(U.create&&U.create.outbound&&O[U.create.outbound]){W=O[U.create.outbound];U.create.outboundDetail={semanticObject:W.semanticObject,action:W.action,parameters:W.parameters};}});z={navigation:N,viewLevel:I.viewLevel,stableId:g,contentDensities:q["sap.ui5"].contentDensities,resourceBundle:r.__bundle,fullContextPath:F,isDesktop:e.system.desktop};if(l.getViewData){Object.assign(z,l.getViewData());}var K=A.getShellServices();z.converterType=k;z.shellContentDensity=K.getContentDensity();x=new J(z);if(z&&z.controlConfiguration){Object.keys(z.controlConfiguration).forEach(function(Q){if(Q.indexOf("[")!==-1){var U=D.resolveDynamicExpression(Q,n);z.controlConfiguration[U]=z.controlConfiguration[Q];}});}j.convertTypes(n,A.getEnvironmentCapabilities().getCapabilities());w=new T(function(){try{if(!!P){return P;}else{var Q=A.getDiagnostics();var U=Q.getIssues().length;var W=i.convertPage(k,n,z,Q,F,A.getEnvironmentCapabilities().getCapabilities());var X=Q.getIssues();var Y=X.slice(U);if(Y.length>0){L.warning("Some issues have been detected in your project, please check the UI5 support assistant rule for sap.fe.core");}t._setCachedModel(p,W);return W;}}catch(Z){L.error(Z,Z);return{};}},n);if(!E){y=B();l.setModel(w,"_pageModel");return l.runAsOwner(function(){return V.create(y).catch(G).then(function(Q){t.oView=Q;t.oView.setModel(new M(t.oView),"$view");t.oView.setModel(x,"viewData");l.setAggregation("rootControl",t.oView);return h;}).catch(L.error);});}}).catch(function(H){L.error(H.message,H);throw new Error("Error while creating view : "+H);});},getView:function(){return this.oView;},exit:function(){this.oResourceModelService&&this.oResourceModelService.destroy();this.oCacheHandlerService&&this.oCacheHandlerService.destroy();this.oFactory.removeGlobalInstance();}});var s=a.extend("sap.fe.core.services.TemplatedViewServiceFactory",{_oInstanceRegistry:{},iCreatingViews:0,createInstance:function(o){s.prototype.iCreatingViews++;var t=new f(Object.assign({factory:this},o));return t.initPromise.then(function(){s.prototype.iCreatingViews--;return t;});},removeGlobalInstance:function(){this._oInstanceRegistry={};}});s.getNumberOfViewsInCreationState=function(){return s.prototype.iCreatingViews;};return s;},true);
