/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2021 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","sap/ui/base/Object","sap/ui/base/EventProvider","sap/fe/core/Synchronization","sap/ui/thirdparty/URI"],function(L,B,E,S,U){"use strict";var e={EQUAL:0,COMPATIBLE:1,ANCESTOR:2,DIFFERENT:3};var a={LAYOUTPARAM:"layout",IAPPSTATEPARAM:"sap-iapp-state"};function c(g){return{_guardHash:g.replace(/\?[^\?]*$/,""),check:function(h){return h.indexOf(this._guardHash)===0;}};}function f(h){var A=h.match(new RegExp("\\?.*"+a.IAPPSTATEPARAM+"=([^&]*)"));return A&&A.length>1?A[1]:null;}function r(h){return h.replace(new RegExp("[&?]*"+a.IAPPSTATEPARAM+"=[^&]*"),"");}function s(h,A){var n;if(h.indexOf(a.IAPPSTATEPARAM)>=0){n=h.replace(new RegExp(a.IAPPSTATEPARAM+"=[^&]*"),a.IAPPSTATEPARAM+"="+A);}else{if(h.indexOf("?")<0){n=h+"?";}else{n=h+"&";}n+=a.IAPPSTATEPARAM+"="+A;}return n;}return B.extend("sap.fe.core.RouterProxy",{bIsRebuildHistoryRunning:false,bIsComputingTitleHierachy:false,bIsGuardCrossAllowed:false,sIAppStateKey:null,init:function(A,i){A.getService("shellServices").then(function(){this._oShellServices=A.getShellServices();this.initRaw(A.getRouter());this.waitForRouteMatchBeforeNavigation();history.replaceState(Object.assign({feLevel:0},history.state),"",window.location);this.fclEnabled=i;this._fnBlockingNavFilter=this._blockingNavigationFilter.bind(this);this._oShellServices.registerNavigationFilter(this._fnBlockingNavFilter);}.bind(this)).catch(function(o){L.error("Cannot retrieve the shell services",o);});this._fnHashGuard=this.hashGuard.bind(this);window.addEventListener("popstate",this._fnHashGuard);this._bDisableOnHashChange=false;this._bIgnoreRestore=false;this._bCleanedRestore=false;},destroy:function(){if(this._oShellServices){this._oShellServices.unregisterNavigationFilter(this._fnBlockingNavFilter);}window.removeEventListener("popstate",this._fnHashGuard);},initRaw:function(R){this._oRouter=R;this._oManagedHistory=[];this._oNavigationGuard=null;var C=this.getHash();this._oManagedHistory.push(this._extractStateFromHash(C));this.sIAppStateKey=f(C);},getHash:function(){return this._oRouter.getHashChanger().getHash();},removeIAppStateKey:function(){this.sIAppStateKey=null;},navToHash:function(h,p,d){var t=this;if(this._oRouteMatchSynchronization){return this._oRouteMatchSynchronization.waitFor().then(function(){t._oRouteMatchSynchronization=null;return t._internalNavToHash(h,p,d);});}else{if(this._bActivateRouteMatchSynchro){this.waitForRouteMatchBeforeNavigation();}return t._internalNavToHash(h,p,d);}},_internalNavToHash:function(h,p,d){var t=this,l=sap.ui.getCore().getCurrentFocusedControlId(),b=l&&sap.ui.getCore().byId(l)?sap.ui.getCore().byId(l).getFocusInfo():null,g=this.getHash();if(this.fclEnabled&&this.sIAppStateKey&&!f(h)){h=s(h,this.sIAppStateKey);}var n=this._extractStateFromHash(h);if(!this.checkHashWithGuard(h)){if(!this.oResourceBundle){this.oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core");}if(!confirm(this.oResourceBundle.getText("C_ROUTER_PROXY_SAPFE_EXIT_NOTSAVED_MESSAGE"))){return Promise.resolve();}this.bIsGuardCrossAllowed=true;}var H=this._pushNewState(n,false,p,d);return this._rebuildBrowserHistory(H,false).then(function(){t.storeFocusForHash(l,b,g);});},restoreHistory:function(){if(this._bApplyRestore){this._bApplyRestore=false;var t=this.getHash();t=t.replace(/(\?|&)restoreHistory=true/,"");var n=this._extractStateFromHash(t);var h=this._pushNewState(n,true,false,true);return this._rebuildBrowserHistory(h,true);}else{return Promise.resolve();}},getFocusControlForCurrentHash:function(){var C=this.getHash();var l;for(var i=this._oManagedHistory.length-1;i>=0;i--){if(C===this._oManagedHistory[i].hash){l=this._oManagedHistory[i].oLastFocusControl;break;}else{this._oManagedHistory[i].oLastFocusControl=undefined;}}return l;},storeFocusForHash:function(l,b,h){var m=this._oManagedHistory;for(var i=0;i<m.length;i++){if(h===m[i].hash){m[i].oLastFocusControl={controlId:l,focusInfo:b};break;}}},navBack:function(){var C=this.getHash(),p;for(var i=this._oManagedHistory.length-1;i>0;i--){if(this._oManagedHistory[i].hash===C){p=this._oManagedHistory[i-1].hash;break;}}if(p){return this.navToHash(p);}else{window.history.back();return Promise.resolve();}},navTo:function(R,p){var h=this._oRouter.getURL(R,p);return this.navToHash(h,false,p.noPreservationCache);},exitFromApp:function(){return this._oShellServices.backToPreviousApp();},isCurrentStateImpactedBy:function(h){if(h[0]==="/"){h=h.substring(1);}var l=c(h);return l.check(this.getHash());},isNavigationFinalized:function(){return!this.bIsRebuildHistoryRunning&&!this._bDelayedRebuild;},setNavigationGuard:function(){this._oNavigationGuard=c(this.getHash());this.bIsGuardCrossAllowed=false;},discardNavigationGuard:function(){this._oNavigationGuard=null;},hasNavigationGuard:function(){return this._oNavigationGuard!==null;},checkHashWithGuard:function(h){return this._oNavigationGuard===null||this._oNavigationGuard.check(h);},isGuardCrossAllowedByUser:function(){return this.bIsGuardCrossAllowed;},activateRouteMatchSynchronization:function(){this._bActivateRouteMatchSynchro=true;},resolveRouteMatch:function(){if(this._oRouteMatchSynchronization){this._oRouteMatchSynchronization.resolve();}},waitForRouteMatchBeforeNavigation:function(){this._oRouteMatchSynchronization=new S();this._bActivateRouteMatchSynchro=false;},_extractStateFromHash:function(h){var o={keys:[]};if(h===undefined){h="";}var H=h.split("?")[0];var t=H.split("/");t.forEach(function(T){var b=/[^\(\)]+\([^\(\)]+\)/;if(b.test(T)){o.keys.push(T.split("(")[0]);}});var l=h.match(new RegExp("\\?.*"+a.LAYOUTPARAM+"=([^&]*)"));o.sLayout=l&&l.length>1?l[1]:null;if(o.sLayout==="MidColumnFullScreen"){o.screenMode=1;}else if(o.sLayout==="EndColumnFullScreen"){o.screenMode=2;}else{o.screenMode=0;}o.hash=h;return o;},_pushNewState:function(n,R,p,d){var C=this.getHash(),l=this._oManagedHistory.length-1,P=R?1:0,t=this;if(!R){while(l>=0&&this._oManagedHistory[l].hash!==C){this._oManagedHistory.pop();l--;}if(this._oManagedHistory.length===0){this._oManagedHistory.push(this._extractStateFromHash(C));history.replaceState(Object.assign({feLevel:0},history.state),"");}}if(p&&!d){this._oManagedHistory[this._oManagedHistory.length-1].preserved=true;}var o;var b;while(this._oManagedHistory.length>0){var T=this._oManagedHistory[this._oManagedHistory.length-1];if((d||!T.preserved)&&this._compareCacheStates(T,n)!==e.ANCESTOR){o=T.oLastFocusControl;b=this._oManagedHistory.pop();P++;}else if(T.preserved&&r(T.hash)===r(n.hash)){o=T.oLastFocusControl;b=this._oManagedHistory.pop();P++;n.preserved=true;break;}else{break;}}this.sIAppStateKey=f(n.hash);if(this.fclEnabled&&this.sIAppStateKey){this._oManagedHistory.forEach(function(m){m.hash=s(m.hash,t.sIAppStateKey);});}else if(!this.fclEnabled&&b){var g=f(b.hash);var h=this._compareCacheStates(b,n);if(!this.sIAppStateKey&&g&&(h===e.EQUAL||h===e.COMPATIBLE)){n.hash=s(n.hash,g);}}n.oLastFocusControl=o;var H=b&&n.hash===b.hash;if(this._oManagedHistory.length===0||this._oManagedHistory[this._oManagedHistory.length-1].hash!==n.hash){this._oManagedHistory.push(n);}if(P===0){return{type:"append"};}else if(P===1){return H?{type:"none"}:{type:"replace"};}else{return H?{type:"back",steps:P-1}:{type:"back-replace",steps:P-1};}},_blockingNavigationFilter:function(){return this._bDisableOnHashChange?"Custom":"Continue";},_disableEventOnHashChange:function(){this._bDisableOnHashChange=true;this._oRouter.stop();},_enableEventOnHashChange:function(i){this._bDisableOnHashChange=false;this._oRouter.initialize(i);},_rebuildBrowserHistory:function(h,R){var t=this;return new Promise(function(b,d){t.bIsRebuildHistoryRunning=true;var T=t._oManagedHistory[t._oManagedHistory.length-1],n=t._oManagedHistory.length-1;function g(){if(!R){t._enableEventOnHashChange(true);}t._oRouter.getHashChanger().replaceHash(T.hash);history.replaceState(Object.assign({feLevel:n},history.state),"");if(R){setTimeout(function(){t._enableEventOnHashChange(true);},0);}t.bIsRebuildHistoryRunning=false;b();}function i(){window.removeEventListener("popstate",i);setTimeout(function(){g();},0);}function j(){window.removeEventListener("popstate",j);t.bIsRebuildHistoryRunning=false;b();}t._bIgnoreRestore=true;switch(h.type){case"replace":t._oRouter.getHashChanger().replaceHash(T.hash);history.replaceState(Object.assign({feLevel:n},history.state),"");t.bIsRebuildHistoryRunning=false;b();break;case"append":t._oRouter.getHashChanger().setHash(T.hash);history.replaceState(Object.assign({feLevel:n},history.state),"");t.bIsRebuildHistoryRunning=false;b();break;case"back":window.addEventListener("popstate",j);history.go(-h.steps);break;case"back-replace":t._disableEventOnHashChange();window.addEventListener("popstate",i);history.go(-h.steps);break;default:t.bIsRebuildHistoryRunning=false;b();}});},getLastHistoryEntry:function(){return this._oManagedHistory[this._oManagedHistory.length-1];},hashGuard:function(o){if(this._bCleanedRestore){this._bCleanedRestore=false;return;}var h=window.location.hash;if(h.indexOf("restoreHistory=true")!==-1){this._bApplyRestore=true;}else if(!this.bIsRebuildHistoryRunning){var H=h.split("&/");var A=H[1]?H[1]:"";if(this.checkHashWithGuard(A)){this._bDelayedRebuild=true;var n=this._extractStateFromHash(A);this._pushNewState(n,false,false,true);var t=this;setTimeout(function(){t._bDelayedRebuild=false;},0);}}},_compareCacheStates:function(o,b){if(o.keys.length>b.keys.length){return e.DIFFERENT;}var d=true;var i;for(i=0;d&&i<o.keys.length;i++){if(o.keys[i]!==b.keys[i]){d=false;}}if(!d){return e.DIFFERENT;}if(o.keys.length<b.keys.length||o.screenMode<b.screenMode){return e.ANCESTOR;}if(o.screenMode>b.screenMode){return e.DIFFERENT;}return o.sLayout===b.sLayout?e.EQUAL:e.COMPATIBLE;},checkIfBackIsOutOfGuard:function(p){var t=this,P;if(p===undefined){var o=this._oShellServices.splitHash(window.location.hash);if(o&&o.appSpecificRoute){p=o.appSpecificRoute;if(p.indexOf("&/")===0){p=p.substring(2);}}else{p=window.location.hash.substring(1);if(p[0]==="/"){p=p.substring(1);}}}p=U.decode(p);if(t._oNavigationGuard){for(var i=t._oManagedHistory.length-1;i>0;i--){if(t._oManagedHistory[i].hash===p){P=t._oManagedHistory[i-1].hash;break;}}return!P||!t.checkHashWithGuard(P);}return false;}});});
