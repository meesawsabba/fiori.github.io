/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2021 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/m/VBox","sap/m/VBoxRenderer","sap/fe/macros/CommonHelper","sap/fe/core/helpers/StableIdHelper","sap/fe/core/controls/filterbar/utils/VisualFilterUtils","sap/fe/core/templating/FilterHelper","sap/fe/macros/filter/FilterUtils"],function(V,a,C,S,b,F,c){"use strict";var d=V.extend("sap.fe.core.controls.filterbar.VisualFilter",{renderer:{apiVersion:2,render:a.render},metadata:{properties:{showValueHelp:{type:"boolean"},valueHelpIconSrc:{type:"string"}},events:{valueHelpRequest:{}},interfaces:["sap.ui.core.IFormContent"]}});d.prototype.onAfterRendering=function(){var i=this.getItems()[1].getItems()[0];var I=this.data("infoPath");var o=i.getBinding("segments")||i.getBinding("bars")||i.getBinding("points");var e=i.getBindingContext("internal");var r=sap.ui.getCore().getLibraryResourceBundle("sap.fe.macros");var s=i.data("showOverlayInitially");var f=i.data("selectionVariantAnnotation")?C.parseCustomData(i.data("selectionVariantAnnotation")):{SelectOptions:[]};var R=i.data("requiredProperties")?C.parseCustomData(i.data("requiredProperties")):[];var m=i.getModel().getMetaModel();var E=o?o.getPath():"";var g=this.getParent().getParent();if(g.getMetadata().getElementName()==="sap.ui.mdc.filterbar.p13n.AdaptationFilterBar"){g=g.getParent().getParent();}var h={};var p=[];var j;if(g.getMetadata().getElementName()==="sap.fe.core.controls.FilterBar"){h=g.getConditions();p=g.getPropertyInfoSet();j=g.data("entityType").split("/")[1];}var P=i.data("parameters")?i.data("parameters").customData:[];var k=m.getObject(E+"/");var l=F.getFiltersConditionsFromSelectionVariant(k,f,b.getCustomConditions.bind(b));var n=b.convertFilterCondions(l);var q={};Object.keys(h).forEach(function(K){if(h[K].length){q[K]=h[K];}});Object.keys(n).forEach(function(K){if(!q[K]){q[K]=n[K];}});if(s==="true"){if(!Object.keys(f).length){if(R.length>1){e.setProperty(I,{"showError":true,"errorMessageTitle":r.getText("M_VISUAL_FILTERS_ERROR_MESSAGE_TITLE"),"errorMessage":r.getText("M_VISUAL_FILTERS_PROVIDE_FILTER_VAL_MULTIPLEVF")});}else{var L=m.getObject(E+"/"+R[0]+"@com.sap.vocabularies.Common.v1.Label")||R[0];e.setProperty(I,{"showError":true,"errorMessageTitle":r.getText("M_VISUAL_FILTERS_ERROR_MESSAGE_TITLE"),"errorMessage":r.getText("M_VISUAL_FILTERS_PROVIDE_FILTER_VAL_SINGLEVF",L)});}}else{var t=[];var N=[];if(f.SelectOptions){f.SelectOptions.forEach(function(w){t.push(w.PropertyName.$PropertyPath);});}if(f.Parameters){f.Parameters.forEach(function(w){t.push(w.PropertyName.$PropertyPath);});}R.forEach(function(w){if(t.indexOf(w)===-1){N.push(w);}});if(N.length>1){e.setProperty(I,{"showError":true,"errorMessageTitle":r.getText("M_VISUAL_FILTERS_ERROR_MESSAGE_TITLE"),"errorMessage":r.getText("M_VISUAL_FILTERS_PROVIDE_FILTER_VAL_MULTIPLEVF")});}else{var L=m.getObject(E+"/"+N[0]+"@com.sap.vocabularies.Common.v1.Label")||N[0];e.setProperty(I,{"showError":true,"errorMessageTitle":r.getText("M_VISUAL_FILTERS_ERROR_MESSAGE_TITLE"),"errorMessage":r.getText("M_VISUAL_FILTERS_PROVIDE_FILTER_VAL_SINGLEVF",L)});}N.length>1?e.setProperty(I,{"showError":true,"errorMessageTitle":r.getText("M_VISUAL_FILTERS_ERROR_MESSAGE_TITLE"),"errorMessage":r.getText("M_VISUAL_FILTERS_PROVIDE_FILTER_VAL_MULTIPLEVF")}):e.setProperty(I,{"showError":true,"errorMessageTitle":r.getText("M_VISUAL_FILTERS_ERROR_MESSAGE_TITLE"),"errorMessage":r.getText("M_VISUAL_FILTERS_PROVIDE_FILTER_VAL_SINGLEVF",N[0])});}}if(!this._oChartBinding||this._oChartBinding!==o){if(this._oChartBinding){this.detachDataRecivedHandler(this._oChartBinding);}this.attachDataRecivedHandler(o);this._oChartBinding=o;}var u=e.getProperty(I)&&e.getProperty(I).showError;var v=E!==""?E.split("/")[1].split("(")[0]:"";if(P&&P.length&&j===v){var B=c.getBindingPathForParameters(g,q,p,P);if(B){o.sPath=B;}}if(o&&o.isSuspended()&&!u){o.resume();}};d.prototype.attachDataRecivedHandler=function(i){if(i){i.attachEvent("dataReceived",this.onInternalDataReceived,this);this._oChartBinding=i;}};d.prototype.detachDataRecivedHandler=function(i){if(i){i.detachEvent("dataReceived",this.onInternalDataReceived,this);this._oChartBinding=null;}};d.prototype.setShowValueHelp=function(s){if(this.getItems().length>0){var v=this.getItems()[0].getItems()[0];v.getContent().some(function(i){if(i.isA("sap.m.Button")){i.setVisible(s);}});this.setProperty("showValueHelp",s);}};d.prototype.setValueHelpIconSrc=function(i){if(this.getItems().length>0){var v=this.getItems()[0].getItems()[0];v.getContent().some(function(I){if(I.isA("sap.m.Button")){I.setIcon(i);}});this.setProperty("valueHelpIconSrc",i);}};d.prototype.onInternalDataReceived=function(e){var i=this.getId();var v=sap.ui.fl.Utils.getViewForControl(this);var I=this.getItems()[1].getItems()[0];var s=this.data("infoPath");var o=I.getBindingContext("internal");var r=sap.ui.getCore().getLibraryResourceBundle("sap.fe.macros");var u=I.data("uom");b.updateChartScaleFactorTitle(I,v,i,s);if(e.getParameter("error")){var f=r.getText("M_VISUAL_FILTERS_ERROR_MESSAGE_TITLE");var g=r.getText("M_VISUAL_FILTERS_ERROR_DATA_TEXT");b.applyErrorMessageAndTitle(f,g,s,v);}else if(e.getParameter("data")){var D=e.getSource().getCurrentContexts();if(D&&D.length===0){b.setNoDataMessage(s,r,v);}else{o.setProperty(s,{});}b.setMultiUOMMessage(D,I,s,r,v);}if(u&&((u["ISOCurrency"]&&u["ISOCurrency"].$Path)||(u["Unit"]&&u["Unit"].$Path))){var h=e.getSource().getContexts();var j=h&&h[0].getObject();b.applyUOMToTitle(I,j,v,s);}};return d;});
