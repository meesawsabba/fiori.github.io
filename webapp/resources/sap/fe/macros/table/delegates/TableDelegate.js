/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2021 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/model/json/JSONModel","sap/fe/macros/CommonHelper","sap/fe/macros/table/Utils","sap/fe/core/CommonUtils","sap/fe/core/helpers/ModelHelper","sap/fe/macros/DelegateUtil","sap/ui/model/Filter","sap/base/Log","sap/ui/mdc/odata/v4/TypeUtil","sap/fe/macros/FilterBarDelegate","sap/fe/core/helpers/ExcelFormatHelper","sap/fe/macros/table/TableHelper","sap/fe/macros/ResourceModel","sap/base/util/deepClone","sap/ui/mdc/odata/v4/TableDelegate"],function(J,C,T,a,M,D,F,L,b,c,E,d,R,e,f){"use strict";var g="sap_fe_TableDelegate_propertyInfoMap";var h=a.FilterRestrictions;function _(p){return p&&p.metadataPath.includes("@com.sap.vocabularies.UI.v1.LineItem");}function k(t,i,u){if(t instanceof window.Element){return;}var j=u?g+"_add":g;D.setCustomData(t,j,i);}function l(t,u){if(t instanceof window.Element){return null;}var i=u?g+"_add":g;return D.getCustomData(t,i);}var O=Object.assign({},f,{getColumnsFor:function(t){return C.parseCustomData(D.getCustomData(t,"columns"));},_getAggregatedPropertyMap:function(t){return C.parseCustomData(D.getCustomData(t,"aggregates")||{});},_fetchPropertyInfo:function(m,o,t,A,u){var s=o.annotationPath,i=m.getObject(o.annotationPath),n=m.createBindingContext(s),j=o.typeConfig&&o.typeConfig.className&&D.isTypeFilterable(o.typeConfig.className)?b.getTypeConfig(o.typeConfig.className,o.typeConfig.oFormatOptions,o.typeConfig.oConstraints):undefined,p=null,q=C.isPropertyFilterable(o.relativePath,{context:n},i),r=o.typeConfig&&o.typeConfig.className.indexOf("Edm.")!==0,v=o.isDataPointFakeTargetProperty?R.getText("TargetValue"):D.getLocalizedText(o.label,A||t),I=D.getCustomData(t,"enableAnalytics")==="true",w=I?this._getAggregatedPropertyMap(t):{},x=o.exportSettings,y=o.typeConfig&&o.typeConfig.className?this._getExportFormat(o.typeConfig.className):undefined;if(x){if(y){x.format=y;}if(x.template){x.template=o.exportSettings.template;}if(x.label){var z=x.label?D.getLocalizedText(o.exportSettings.label,t):undefined;if(z!==undefined&&!sap.ui.getCore().getConfiguration().getRTL()){v=z+" - "+v;}else{v=v+" - "+z;}}}var P={name:o.name,metadataPath:s,groupLabel:o.groupLabel,group:o.group,label:v,description:p||v,maxLength:n.$MaxLength,precision:n.$Precision,scale:n.$Scale,typeConfig:j,visible:o.availability!=="Hidden"&&!r,exportSettings:x,unit:o.unit};if(o.visualSettings&&Object.keys(o.visualSettings).length>0){P.visualSettings=o.visualSettings;}if(y){P.visualSettings={widthCalculation:{gap:3}};}if(o.propertyInfos&&o.propertyInfos.length){P.propertyInfos=o.propertyInfos;P.exportSettings.wrap=o.exportSettings.wrap;if(u&&o.additionalPropertyInfos&&o.additionalPropertyInfos.length){P.propertyInfos=P.propertyInfos.concat(o.additionalPropertyInfos);}}else{P.path=o.relativePath;P.sortable=o.sortable&&!o.relativePath.includes("/");P.filterable=!o.isDataPointFakeTargetProperty&&q&&!o.relativePath.includes("/")&&(!I||!w[P.name]);P.key=o.isKey;P.groupable=o.isGroupable;P.text=o.textArrangement&&o.textArrangement.textProperty;P.caseSensitive=o.caseSensitive;}return P;},_fetchCustomPropertyInfo:function(o,t,A){var s=D.getLocalizedText(o.header,A||t);var p={name:o.name,groupLabel:null,group:null,label:s,description:s,maxLength:undefined,precision:undefined,scale:undefined,type:"Edm.String",visible:o.availability!=="Hidden",exportSettings:{template:o.exportSettings.template}};if(o.propertyInfos&&o.propertyInfos.length){p.propertyInfos=o.propertyInfos;p.exportSettings.wrap=o.exportSettings.wrap;}else{p.path=o.name;p.sortable=false;p.filterable=false;}return p;},_fetchPropertiesForEntity:function(t,s,m,A,u){var B=M.getEntitySetPath(s),i=[],o=a.getFilterRestrictionsByPath(B,m),n=o[h.NON_FILTERABLE_PROPERTIES],j=o[h.ALLOWED_EXPRESSIONS],p=this;return Promise.resolve(p.getColumnsFor(t)).then(function(q){if(!q){return Promise.resolve([]);}var P;q.forEach(function(r){if(r.formatOptions&&r.formatOptions.hasDraftIndicator){var I=t.getBindingContext("internal");var v=I&&I.getPath();if(I&&I.getProperty(v+"/semanticKeyHasDraftIndicator")===undefined){I.setProperty(v+"/semanticKeyHasDraftIndicator",r.name);}}switch(r.type){case"Annotation":P=p._fetchPropertyInfo(m,r,t,A,u);if(P&&n.indexOf(P.name)===-1){if(j[P.name]){P.filterExpression=a.getSpecificAllowedExpression(j[P.name]);}else{P.filterExpression="auto";}P.maxConditions=D.isMultiValue(P)?-1:1;}break;case"Slot":case"Default":P=p._fetchCustomPropertyInfo(r,t,A);break;default:throw new Error("unhandled switch case "+r.type);}i.push(P);});i.forEach(function(P){var U=P.path&&P.exportSettings?P.exportSettings.unitProperty:undefined;if(U){var r=i.find(function(v){return v.path===U;});if(r){P.unit=r.name;}}});return i;});},_getCachedOrFetchPropertiesForEntity:function(t,s,m,A,u){var i=l(t,u);if(i){return Promise.resolve(i);}return this._fetchPropertiesForEntity(t,s,m,A,u).then(function(i){k(t,i,u);return i;});},_setTableNoDataText:function(t,B){var n="",o=T.getAllFilterInfo(t),s=B.path.substr(1);var i=function(){if(t.data("hiddenFilters")||t.data("quickFilterKey")){return"M_OP_TABLE_AND_CHART_NO_DATA_TEXT_WITH_FILTER_MULTI_VIEW";}else{return"T_OP_TABLE_AND_CHART_NO_DATA_TEXT_WITH_FILTER";}};var j=t.getFilter();if(j&&!/BasicSearch$/.test(j)){if(o.search||(o.filters&&o.filters.length)){n=i();}else{n="T_OP_TABLE_AND_CHART_NO_DATA_TEXT";}}else{if(o.search||(o.filters&&o.filters.length)){n=i();}else{n="M_OP_TABLE_AND_CHART_OP_NO_FILTERS_NO_DATA_TEXT";}}if(n==="T_OP_TABLE_AND_CHART_NO_DATA_TEXT_WITH_FILTER"||n==="T_OP_TABLE_AND_CHART_NO_DATA_TEXT"){return t.getModel("sap.fe.i18n").getResourceBundle().then(function(r){t.setNoDataText(a.getTranslatedText(n,r,null,s));}).catch(function(m){L.error(m);});}else{if(R){t.setNoDataText(R.getText(n));}}},handleTableDataReceived:function(t,i){var B=t&&t.getRowBinding(),j=i&&i.getProperty("dataReceivedAttached");if(i&&!j){B.attachDataReceived(function(){d.handleTableDeleteEnablementForSideEffects(t,i);i.setProperty("selectedContexts",[]);var s=t.getSelectedContexts();i.setProperty("selectedContexts",s);i.setProperty("numberOfSelectedContexts",s.length);});i.setProperty("dataReceivedAttached",true);}},rebindTable:function(t,B){if(!t.data("controlHidden")){T.clearSelection(t);f.rebindTable.apply(this,[t,B]);T.onTableBound(t);this._setTableNoDataText(t,B);T.whenBound(t).then(this.handleTableDataReceived(t,t.getBindingContext("internal"))).catch(function(o){L.error("Error while waiting for the table to be bound",o);});}},fetchProperties:function(t){var i=this;return D.fetchModel(t).then(function(m){if(!m){return[];}return i._getCachedOrFetchPropertiesForEntity(t,D.getCustomData(t,"entityType"),m.getMetaModel());});},updateBindingInfo:function(t,m,B){f.updateBindingInfo.apply(this,[t,m,B]);if(!t.data("controlHidden")){this._internalUpdateBindingInfo(t,m,B);this._setTableNoDataText(t,B);}},_manageSemanticTargets:function(m){var r=m.getRowBinding();if(r){r.attachEventOnce("dataRequested",function(){setTimeout(function(){var i=sap.ui.fl.Utils.getViewForControl(m);if(i){T.getSemanticTargetsFromTable(i.getController(),m);}},0);});}},updateBinding:function(t,B,o){f.updateBinding.apply(this,[t,B,o]);t.fireEvent("bindingUpdated");this._manageSemanticTargets(t);},_internalUpdateBindingInfo:function(t,m,B){Object.assign(B,e(D.getCustomData(t,"rowsBindingInfo")));if(t.getRowBinding()){B.suspended=false;}var o;var i=T.getAllFilterInfo(t);if(i.filters.length>0){o=new F({filters:i.filters,and:true});}if(i.bindingPath){B.path=i.bindingPath;}var j=t.getDataStateIndicator();if(j&&j.isFiltering()){if(B.filters.length>0){o=new F({filters:B.filters.concat(i.filters),and:true});T.updateBindingInfo(B,i,o);}}else{T.updateBindingInfo(B,i,o);}},_templateCustomColumnFragment:function(o,v,m,t){var i=new J(o),j=new J({id:t}),p={bindingContexts:{"this":j.createBindingContext("/"),"column":i.createBindingContext("/")},models:{"this":j,"column":i}};return D.templateControlFragment("sap.fe.macros.table.CustomColumn",p,{view:v},m).then(function(I){i.destroy();return I;});},_getExportFormat:function(i){switch(i){case"Edm.Date":return E.getExcelDatefromJSDate();case"Edm.DateTimeOffset":return E.getExcelDateTimefromJSDateTime();case"Edm.TimeOfDay":return E.getExcelTimefromJSTime();default:return undefined;}},_getVHRelevantFields:function(m,s,B){var i=[],o=m.getObject(s),t=this;if(o.$kind&&o.$kind==="Property"){o=m.getObject(s+"@com.sap.vocabularies.UI.v1.DataFieldDefault");s=s+"@com.sap.vocabularies.UI.v1.DataFieldDefault";}switch(o.$Type){case"com.sap.vocabularies.UI.v1.DataFieldForAnnotation":if(m.getObject(s+"/Target/$AnnotationPath").includes("com.sap.vocabularies.UI.v1.FieldGroup")){m.getObject(s+"/Target/$AnnotationPath/Data").forEach(function(v,I){i=i.concat(t._getVHRelevantFields(m,s+"/Target/$AnnotationPath/Data/"+I));});}break;case"com.sap.vocabularies.UI.v1.DataFieldWithNavigationPath":case"com.sap.vocabularies.UI.v1.DataFieldWithUrl":case"com.sap.vocabularies.UI.v1.DataField":i.push(m.getObject(s+"/Value/$Path"));break;case"com.sap.vocabularies.UI.v1.DataFieldForAction":case"com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation":break;default:if(s.indexOf(B)===0){i.push(s.substring(B.length+1));break;}i.push(C.getNavigationPath(s,true));break;}return i;},_setDraftIndicatorOnVisibleColumn:function(t,o){var m=this.getColumnsFor(t);if(m){var I=t.getBindingContext("internal");var s=I.getPath();var n=m.filter(function(r){return r.formatOptions&&r.formatOptions.hasDraftIndicator;});var v=t.getColumns();var A,V,p,q;for(var i=0;i<v.length;i++){V=v[i].getDataProperty();for(var j=0;j<n.length;j++){q=n[j].name;if(V===q){p=true;break;}if(o&&o.name===q){A=o.name;}}if(p){I.setProperty(s+"/semanticKeyHasDraftIndicator",V);break;}}if(!p&&A){I.setProperty(s+"/semanticKeyHasDraftIndicator",A);}}},removeItem:function(p,t,P){var i=true;var m=P.modifier;var s=m.getProperty(p,"dataProperty");if(s&&s.indexOf&&s.indexOf("InlineXML")!==-1){m.insertAggregation(t,"dependents",p);i=false;}this._setDraftIndicatorOnVisibleColumn(t);return Promise.resolve(i);},addItem:function(p,t,P){var m=P.appComponent&&P.appComponent.getModel().getMetaModel(),o=P.modifier,s=o.getId(t),i,G,j,n,q,r,u,v,V,w,x=this.getColumnsFor(t),y=this;q=x.find(function(B){return B.name===p;});if(!q){L.error(p+" not found while adding column");return Promise.resolve(null);}this._setDraftIndicatorOnVisibleColumn(t,q);if(q.type==="Default"){return this._templateCustomColumnFragment(q,P.view,o,s);}if(q.type==="Slot"){var z=o.getAggregation(t,"dependents");var A;z.forEach(function(B){var H=o.getProperty(B,"dataProperty");if(p===H){A=B;}});if(A){return Promise.resolve(A);}}if(!m){return Promise.resolve(null);}return Promise.resolve().then(D.getCustomData.bind(D,t,"metaPath",o)).then(function(B){i=B;return D.getCustomData(t,"entityType",o);}).then(function(B){w=B;return D.getCustomData(t,"requestGroupId",o);}).then(function(B){G=B||undefined;n=m.createBindingContext(i);return this._getCachedOrFetchPropertiesForEntity(t,w,m,P.appComponent).then(function(H){u=H.find(function(N){return N.name===p;});r=m.createBindingContext(u.metadataPath);V=y._getVHRelevantFields(m,u.metadataPath,i);v={sBindingPath:i,sValueHelpType:"TableValueHelp",oControl:t,oMetaModel:m,oModifier:o,oPropertyInfo:u};j=Promise.all(V.map(function(N){var Q=Object.assign({},v,{sPropertyName:N});return Promise.all([D.isValueHelpRequired(Q),D.doesValueHelpExist(Q)]).then(function(S){var U=S[0],W=S[1];if(U&&!W){return I("sap.fe.macros.table.ValueHelp");}return Promise.resolve();});}));function I(N){var Q=new J({id:s,requestGroupId:G}),S={bindingContexts:{"this":Q.createBindingContext("/"),"dataField":r},models:{"this":Q,"dataField":m,metaModel:m}};return D.templateControlFragment(N,S,{},o).then(function(U){if(U){return o.insertAggregation(t,"dependents",U,0);}}).catch(function(U){L.error("ValueHelp not loaded : "+U.message);return Promise.resolve(null);}).finally(function(){Q.destroy();});}function K(u,N){var Q=_(u)?"sap.fe.macros.table.Column":"sap.fe.macros.table.ColumnProperty";var S;var U;var W;var X;return Promise.all([D.getCustomData(t,"displayModePropertyBinding",o),D.getCustomData(t,"tableType",o),D.getCustomData(t,"onChange",o),D.getCustomData(t,"creationMode",o)]).then(function(Y){S=Y[0];U=Y[1];W=Y[2];X=Y[3];var Z;if(S!==undefined){S=typeof S==="boolean"?S:S==="true";Z=S?"Display":"Editable";}var $=new J({readOnly:S,columnEditMode:Z,tableType:U,onChange:W,id:s,navigationPropertyPath:p,columnInfo:q,collection:{sPath:i,oModel:m},creationMode:X}),a1={bindingContexts:{"entitySet":n,"collection":n,"dataField":r,"this":$.createBindingContext("/"),"column":$.createBindingContext("/columnInfo")},models:{"this":$,"entitySet":m,"collection":m,"dataField":m,metaModel:m,"column":$}};return D.templateControlFragment(Q,a1,{view:N},o).finally(function(){$.destroy();});});}return j.then(K.bind(this,u,P.view));});}.bind(this));},getFilterDelegate:function(){return Object.assign({},c,{addItem:function(p,P){if(p.indexOf("Property::")===0){p=p.replace("Property::","");}return c.addItem(p,P);}});},getTypeUtil:function(p){return b;}});return O;},false);
