/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2021 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/model/Filter","sap/ui/core/format/NumberFormat","sap/fe/core/CommonUtils","sap/fe/macros/CommonHelper","sap/fe/macros/filter/FilterUtils","sap/base/Log","sap/fe/macros/DelegateUtil","sap/fe/core/helpers/ModelHelper","sap/fe/core/converters/MetaModelConverter","sap/fe/core/converters/ConverterContext","sap/base/util/merge","sap/fe/core/helpers/BindingExpression"],function(F,N,C,a,b,L,D,M,c,d,m,B){"use strict";function g(T,s){var E=T.data("entityType"),i=C.getAppComponent(T).getMetaModel(),S=i.getObject(E+"@"+s),P={},v=[],x=[],y="";if(S){y=S.Text;(S.SelectOptions||[]).filter(function(j){return j&&j.PropertyName&&j.PropertyName.$PropertyPath;}).forEach(function(A){var H=A.PropertyName.$PropertyPath;if(!x.includes(H)){x.push(H);}for(var j in A.Ranges){var R=A.Ranges[j];P[H]=(P[H]||[]).concat(new F(H,R.Option.$EnumMember.split("/").pop(),R.Low,R.High));}});for(var z in P){v.push(new F({filters:P[z],and:false}));}}return{properties:x,filters:v,text:y};}function e(T){var i=[],j=T.data("hiddenFilters");if(j&&Array.isArray(j.paths)){j.paths.forEach(function(P){var s=g(T,P.annotationPath);i=i.concat(s.filters);});}return i;}function f(T){var i=[],Q=D.getCustomData(T,"quickFilterKey");if(Q){i=i.concat(g(T,Q).filters);}return i;}function h(T){return f(T).concat(e(T));}function k(T,P,i){var j=T.data("rowsBindingInfo"),s=T.getModel(),v,x,y=i.batchGroupId||"",z=n(T),A=Array.isArray(i.additionalFilters)?i.additionalFilters:[],E=z.bindingPath?z.bindingPath:j.path;A=A.concat(z.filters).concat(o(T));x=new F({filters:A,and:true});v=s.bindList((P?P.getPath()+"/":"")+E,T.getBindingContext(),null,x,{$count:true,$$groupId:y||"$auto",$search:z.search});return v.requestContexts(0,1).then(function(H){var I=H&&H.length?H[0].getBinding().getLength():0;v.destroy();return I;});}function l(i){var j=N.getIntegerInstance({groupingEnabled:true});return j.format(i);}function n(T){var i=D.getCustomData(T,"enableAnalytics"),I=[];function j(T){var A=a.parseCustomData(D.getCustomData(T,"aggregates")||{});return Object.keys(A).map(function(v){return A[v].relativePath;});}if(i==="true"||i===true){I=I.concat(["search"]).concat(j(T));}var s=b.getFilterInfo(T.getFilter(),{ignoredProperties:I,targetControl:T});return s;}function o(T){var P=T.getP13nMode();if(P&&P.indexOf("Filter")>-1){var i=(D.getCustomData(T,"sap_fe_TableDelegate_propertyInfoMap")||[]).filter(function(s){return s&&!(s.filterable===false);}),j=b.getFilterInfo(T,{propertiesMetadata:i});if(j&&j.filters){return j.filters;}}return[];}function p(T){var i=n(T);return{filters:i.filters.concat(h(T),o(T)),search:i.search,bindingPath:i.bindingPath};}function w(T){return _(T).promise;}function q(T){var i=_(T);if(i.resolve){i.resolve(T);T.data("boundPromiseResolve",null);}}function _(T){if(!T.data("boundPromise")){var R;T.data("boundPromise",new Promise(function(i){R=i;}));if(T.isBound()){R(T);}else{T.data("boundPromiseResolve",R);}}return{promise:T.data("boundPromise"),resolve:T.data("boundPromiseResolve")};}function u(i,j,s){i.filters=s;if(j.search){i.parameters.$search=j.search;}else{i.parameters.$search=undefined;}}function G(s,T){var v=s.getView();var I=v.getBindingContext("internal");if(I){var E=D.getCustomData(T,"targetCollectionPath");if(E){var x=s.getOwnerComponent();var A=sap.ui.core.Component.getOwnerComponentFor(x);var y=A.getMetaModel();var S=C.getShellServices(A);var z=S.hrefForExternal();var H=D.getCustomData(T,"columns");var J=[];var K=[];var P,O,Q,R=[];var U;var V=[];if(z&&z.indexOf("?")!==-1){z=z.split("?")[0];}for(var i=0;i<H.customData.length;i++){O=H.customData[i].annotationPath;if(O){Q=y.getObject(O);if(Q&&Q.$kind==="Property"){P=H.customData[i].annotationPath;}else if(Q&&Q.$Type==="com.sap.vocabularies.UI.v1.DataField"){P=E+"/"+y.getObject(O+"/Value/$Path");}}if(P){if(!(y.getObject(P+"@com.sap.vocabularies.Common.v1.SemanticObject")===undefined)){if(R.indexOf(P)===-1){R.push(P);V.push(C.getSemanticObjectPromise(A,v,y,P));}}}P=undefined;}if(V.length===0){return Promise.resolve();}else{Promise.all(V).then(function(W){var X=[],Y;var Z=W.filter(function($){if($.semanticObject&&typeof $.semanticObject.semanticObject==="object"){Y=B.compileBinding(B.bindingExpression($.semanticObject.semanticObject.$Path));$.semanticObject.semanticObject=Y;$.semanticObjectForGetLinks[0].semanticObject=Y;return true;}else if($){return $.semanticObject!==undefined;}else{return false;}});for(var j=0;j<Z.length;j++){U=Z[j];if(U&&U.semanticObject&&!(U.semanticObject.semanticObject.indexOf("{")===0)){J.push(U.semanticObjectForGetLinks);K.push({semanticObject:U.semanticObject&&U.semanticObject.semanticObject,unavailableActions:U.unavailableActions,path:Z[j].semanticObjectPath});X.push(S.getLinksWithCache([U.semanticObjectForGetLinks]));}}return C.updateSemanticTargets(X,K,I,z);}).catch(function(j){L.error("fnGetSemanticTargetsFromTable: Cannot get Semantic Objects",j);});}}}}function r(T){T.clearSelection();var i=T.getBindingContext("internal");if(i){i.setProperty("deleteEnabled",false);i.setProperty("numberOfSelectedContexts",0);i.setProperty("selectedContexts",[]);i.setProperty("deletableContexts",[]);}}var t={getCountFormatted:l,getHiddenFilters:e,getFiltersInfoForSV:g,getTableFilters:h,getListBindingForCount:k,getFilterInfo:n,getP13nFilters:o,getAllFilterInfo:p,whenBound:w,onTableBound:q,getSemanticTargetsFromTable:G,updateBindingInfo:u,clearSelection:r};return t;});
