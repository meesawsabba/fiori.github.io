/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2021 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/fe/macros/ResourceModel","sap/base/Log","sap/fe/core/CommonUtils","sap/ui/util/openWindow","sap/ui/mdc/enum/ConditionValidated","sap/fe/macros/FieldAPI","sap/ui/unified/FileUploaderParameter","sap/fe/core/helpers/ModelHelper","sap/m/MessageBox","sap/ui/core/IconPool"],function(R,L,C,o,a,F,b,M,c,I){"use strict";var d={formatDraftOwnerTextInPopover:function(h,D,s,e,f){if(h){var u=e||D||f||s;if(!u){return R.getText("M_FIELD_RUNTIME_DRAFT_POPOVER_UNSAVED_CHANGES_BY_UNKNOWN");}else{return D?R.getText("M_FIELD_RUNTIME_DRAFT_POPOVER_LOCKED_BY_KNOWN",u):R.getText("M_FIELD_RUNTIME_DRAFT_POPOVER_UNSAVED_CHANGES_BY_KNOWN",u);}}else{return R.getText("M_FIELD_RUNTIME_DRAFT_POPOVER_NO_DATA_TEXT");}},onDataFieldWithNavigationPath:function(s,e,S){if(e.routing){var B=s.getBindingContext(),v=C.getTargetView(s),m=B.getModel().getMetaModel(),n=function(f){if(f){B=f;}e._routing.navigateToTarget(B,S,undefined,true);};if(v.getViewData().converterType==="ObjectPage"&&!M.isStickySessionSupported(m)){C.fnProcessDataLossOrDraftDiscardConfirmation(n,Function.prototype,B,v.getController());}else{n();}}else{L.error("FieldRuntime: No routing listener controller extension found. Internal navigation aborted.","sap.fe.macros.field.FieldRuntime","onDataFieldWithNavigationPath");}},hasTargets:function(s,S){return s?s:false;},handleChange:function(e,E){var s=E.getSource(),i=s&&s.getBindingContext().isTransient(),p=E.getParameter("promise")||Promise.resolve(),S=E.getSource(),v=E.getParameter("valid"),f;p.then(function(){E.oSource=S;E.mParameters={valid:v};F.handleChange(E,e);}).catch(function(g){E.oSource=S;E.mParameters={valid:false};F.handleChange(E,e);});if(e.isA("sap.fe.core.ExtensionAPI")){f=e._controller;}else{f=e;}f._editFlow.syncTask(p);if(i){return;}f.sideEffects.handleFieldChange(E,p);},getFieldStateOnChange:function(e){var s=e.getSource(),f={},_=function(B){return B&&B.getDataState()?B.getDataState().getInvalidValue()===undefined:true;};if(s.isA("sap.fe.macros.FieldAPI")){s=s.getContent();}if(s.isA("sap.fe.core.controls.FieldWrapper")&&s.getEditMode()==="Editable"){s=s.getContentEdit()[0];}if(s.isA("sap.ui.mdc.Field")){var i=e.getParameter("valid")||e.getParameter("isValid");if(i===undefined){if(s.getMaxConditions()===1){var v=s.getBindingInfo("value");i=_(v&&v.binding);}if(s.getValue()===""&&!s.getProperty("required")){i=true;}}f={fieldValue:s.getValue(),validity:!!i};}else{var B=s.getBinding("value")||s.getBinding("selected");f={fieldValue:B&&B.getValue(),validity:_(B)};}return{field:s,state:f};},LinkModelContextChange:function(e){var l=e.getSource();if(!l.getModel()||!l.getBindingContext()){return;}var s,v,p;var S,f,m,g,h,j,k,n,V,q,A,r,t;var _=function(e,w){S=e&&e.getSource();f=l&&l.getBindingPath("text");m=l&&l.getModel();g=m&&m.getMetaModel();h=g&&g.getMetaPath(l.getBindingContext());j=h+"/"+f;k=w||(S&&S.getValue());V=l&&sap.ui.fl.Utils.getViewForControl(l);q=V&&V.getBindingContext("internal");A=V&&C.getAppComponent(V);r=A&&A.getShellServices();p=r&&r.getLinksWithCache([[{semanticObject:k}]]);n=g&&g.getObject(j+"@com.sap.vocabularies.Common.v1.SemanticObjectUnavailableActions");t=r&&r.hrefForExternal();if(t&&t.indexOf("?")!==-1){t=t.split("?")[0];}C.updateSemanticTargets([p],[{semanticObject:k,path:j}],q,t).then(function(x){var y=l.getParent();if(y&&y.isA("sap.fe.core.controls.ConditionalWrapper")){if(x&&x[k]){var z=false,T,B,D=Object.keys(x[k]);for(var P=0;P<D.length;P++){T=D[P];B=x[k]&&x[k][T];if(B&&B.path&&B.path===j){z=B[!n?"HasTargetsNotFiltered":"HasTargets"];y.setCondition(!!z);break;}}}}}).catch(function(E){L.error("LinkModelContextChange: Cannot update Semantic Targets model",E);});};var u=l.getCustomData();if(u&&u.length>0){for(var i=0;i<u.length;i++){s=u[i].getValue();if(!s){v=u[i].getBinding("value");if(v){v.attachEventOnce("change",_);}}_(null,s);}}},pressLink:function(e){var l=e.getSource();if(l.getDependents()&&l.getDependents().length>0){var f=l.getDependents()[0];if(f&&f.isA("sap.ui.mdc.Link")){f.getTriggerHref().then(function(h){if(!h){f.open(l).catch(function(E){L.error("Cannot retrieve the QuickView Popover dialog",E);});}else{var v=sap.ui.fl.Utils.getViewForControl(l);var A=C.getAppComponent(v);var s=A.getShellServices();var S=s.parseShellHash(h);var n={target:{semanticObject:S.semanticObject,action:S.action},params:S.params};if(C.isStickyEditMode(l)!==true){s.toExternal(n,A);}else{var N=s.hrefForExternal(n,A,false);o(N);}}}).catch(function(E){L.error("Error triggering link Href",E);});}}},uploadStream:function(e){var f=e.getSource();f.removeAllHeaderParameters();var t=f.getModel().getHttpHeaders()["X-CSRF-Token"];if(t){var h=new b();h.setName("x-csrf-token");h.setValue(t);f.addHeaderParameter(h);}f.upload();},handleUploadAborted:function(){c.error(R.getText("M_FIELD_FILEUPLOADER_ABORTED_TEXT"));},handleUploadComplete:function(e,p){var s=e.getParameter("status");if(s>=400){var E=e.getParameter("responseRaw")||e.getParameter("response"),f=E&&JSON.parse(E);if(f){c.error(f.error&&f.error.message);}}else{var g=e.getSource(),h=g.getBindingContext();if(p&&p!==""){h.setProperty(p,g.getValue());}h.requestSideEffects([{$NavigationPropertyPath:""}]);}},removeStream:function(e,p){var f=e.getSource().getBindingContext();f.setProperty(p,null);f.requestSideEffects([{$NavigationPropertyPath:""}]);},getIconForMimeType:function(m){return I.getIconForMimeType(m);}};return d;},true);
