/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2021 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/m/Dialog","sap/ui/core/XMLTemplateProcessor","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","sap/ui/core/util/XMLPreprocessor","sap/fe/core/templating/UIFormatters","sap/fe/core/converters/MetaModelConverter","sap/fe/macros/field/FieldHelper","sap/fe/macros/field/FieldTemplating","sap/fe/core/helpers/BindingExpression","sap/fe/core/CommonUtils","sap/fe/core/templating/FieldControlHelper"],function(D,X,J,F,a,U,M,b,c,B,C,d){"use strict";function g(v,i,q){if(v){return q.indexOf(v)===i;}}function e(i,v){if(i&&i.indexOf("/")>0){var P=i.split("/"),R;P.forEach(function(q){R=v&&v[q]?v[q]:R&&R[q];});return R;}}function f(t,i){if(i&&t){var S=t.getSelectedContexts(),P=[];S.forEach(function(q){var r=q.getObject();var v=i.indexOf("/")>-1&&r.hasOwnProperty(i.split("/")[0]);if(q&&(r.hasOwnProperty(i)||v)){P.push(q.getObject(i));}});var u=P.filter(g);if(u.length>1){return"Default/"+i;}else if(u.length===0){return"Empty/"+i;}else if(u.length===1){return i;}}}function h(t,P){var i=t&&t.getColumns().filter(function(q){return q.getDataProperty()===P;}),r="Values";if(i.length){var q=i[0],I=q.getTemplate().getContent&&q.getTemplate().getContent().getContentEdit&&q.getTemplate().getContent().getContentEdit()&&q.getTemplate().getContent().getContentEdit()[0]&&q.getTemplate().getContent().getContentEdit()[0].getMetadata().getName();switch(I){case"sap.m.DatePicker":r="Dates";break;case"sap.m.CheckBox":r="Settings";break;}}return r;}function s(v,t,P,i,q,u){var S=h(t,P);var V=t.getSelectedContexts().some(function(r){return r.getObject(P);});if(V){if(q!==true&&!u){v.unshift({text:i.clearFieldValue,key:"ClearFieldValue/"+P});}}else{v.unshift({text:i.leaveBlankValue,key:"Empty/"+P});}v.unshift({text:i.keepExistingPrefix+" "+S+" >",key:"Default/"+P});}function j(P,v){var i,q=0,r=P.split("/"),t="";r.forEach(function(u){if(!v[u]&&q===0){v[u]={};i=v[u];t=t+u;q++;}else if(!i[u]){t=t+"/"+u;if(t!==P){i[u]={};i=i[u];}else{i[u]=[];}}});return i;}function k(i,t){if(i&&i.$Path){return!(t&&t.getSelectedContexts().some(function(S){return S.getObject(i.$Path)===false;}));}return i;}function l(P,t,T,i,S){var q=T.getModel().getMetaModel();var r=C.computeDisplayMode(q.getObject(i+"/"+P+"@"));var u,v,w,x;if(t&&(t.path||(t.parameters&&t.parameters.length))&&P){if(t.path){if(r==="Description"){v=S.getObject(P);w=S.getObject(t.path);x=w;}else if(r==="Value"){v=S.getObject(P);x=v;}}else if(t.parameters){t.parameters.forEach(function(y){if(y.path&&y.path!==P){u=y.path;}});v=S.getObject(P);w=S.getObject(u);if(r==="ValueDescription"&&v&&w){x=v+" ("+w+")";}else if(r==="DescriptionValue"&&w&&v){x=w+" ("+v+")";}}return{"textArrangement":r,"valuePath":P,"descriptionPath":u,"value":v,"description":w,"fullText":x};}return false;}function p(i,t,q,r,T,u){var v=new J(),w,R,L,P,V,x,y,P,I,z,A;T.forEach(function(E){w=E.dataProperty;if(w){P=w&&q.getObject(r+"/"+w+"@");V=w&&q.getObject(r+"/"+w+"@")&&q.getObject(r+"/"+w+"@")["@com.sap.vocabularies.Common.v1.ValueList"];x=(P&&P["@Org.OData.Measures.V1.Unit"]&&P["@Org.OData.Measures.V1.Unit"].$Path)||(P&&P["@Org.OData.Measures.V1.ISOCurrency"]&&P["@Org.OData.Measures.V1.ISOCurrency"].$Path);L=E.label||(P&&P["@com.sap.vocabularies.Common.v1.Label"]);y=x&&q.getObject(r+"/"+x+"@")&&q.getObject(r+"/"+x+"@")["@com.sap.vocabularies.Common.v1.ValueList"];if(i){i.targetObject=i.targetEntityType.entityProperties.filter(function(W){return W.name===w;});}i.targetObject=i.targetObject[0]||{};A=c.getTextBinding(i,undefined,true)||{};var G=q.getContext(E.annotationPath),H=M.convertMetaModelContext(G),K=q.getContext(r+"/"+w+"@"),N=K&&K.getInterface();I=K&&K.getProperty()&&K.getProperty()["@Org.OData.Core.V1.Immutable"];z=K&&K.getProperty()&&K.getProperty()["@Org.OData.Core.V1.Computed"];var O=k(G&&G.getObject()["@com.sap.vocabularies.UI.v1.Hidden"],t)||false;N.context={getModel:function(){return N.getModel();},getPath:function(){return r+"/"+w;}};var Q=b.fieldControl(w,N);P=(H&&H.Value&&H.Value.$target)||(H&&H.Target&&H.Target.$target);var S=d.isReadOnlyExpression(P);if(w&&!O&&!I&&!z&&U.getEditableExpression(P,H,i)!=="false"){R={"label":L+":","visible":w&&!O&&!I&&!z&&U.getEditableExpression(P,H,i),"dataProperty":w,"isValueHelpEnabled":V?V:false,"unitProperty":x?x:false,"isValueHelpEnabledForUnit":y?y:false,"propertyPathForValueHelp":r+"/"+w,"propertyPathForValueHelpUnit":r+"/"+x,"isFieldRequired":b.getRequiredForDataField(Q,"Editable"),"defaultSelectionPath":w?f(t,w):false,"defaultSelectionUnitPath":x?f(t,x):false,"entitySet":r,"textBinding":A,"nullable":P.nullable!==undefined?P.nullable:true,"isPropertyReadOnly":S!==undefined?S:false};u.push(R);}}});v.setData(u);return v;}function m(t,q,r){var v=[],u=[],R=[],w=[],S=t.getSelectedContexts(),x={},P;q.forEach(function(y){if(y.dataProperty&&y.dataProperty.indexOf("/")>-1){var A=j(y.dataProperty,v),E=y.dataProperty.split("/"),G;for(var i=0;i<S.length;i++){var H=S[i].getObject(y.dataProperty);G=y.dataProperty+"/"+H;if(!x[G]&&A[E[E.length-1]]){var T=l(y.dataProperty,y.textBinding,t,y.entitySet,S[i]);A[E[E.length-1]].push({"text":(T&&T.fullText)||H,"key":y.dataProperty,"textInfo":T});x[G]=H;}}}else{v[y.dataProperty]=v[y.dataProperty]||[];if(y.unitProperty){u[y.unitProperty]=u[y.unitProperty]||[];}for(var i=0;i<S.length;i++){var I=S[i].getObject();P=y.dataProperty+"/"+I[y.dataProperty];if(y.dataProperty&&I[y.dataProperty]&&!x[P]){var T=l(y.dataProperty,y.textBinding,t,y.entitySet,S[i]);v[y.dataProperty].push({"text":(T&&T.fullText)||I[y.dataProperty],"key":y.dataProperty,"textInfo":T});x[P]=I[y.dataProperty];}if(y.unitProperty&&I[y.unitProperty]){P=y.unitProperty+"/"+I[y.unitProperty];if(!x[P]){var T=l(y.unitProperty,y.textBinding,t,y.entitySet,S[i]);u[y.unitProperty].push({"text":(T&&T.fullText)||I[y.unitProperty],"key":y.unitProperty,"textInfo":T});x[P]=I[y.unitProperty];}}}}});q.forEach(function(y){if(y.dataProperty.indexOf("/")>-1){var i=e(y.dataProperty,v);if(!i){i.push({text:r.leaveBlankValue,key:"Empty/"+y.dataProperty});}else{s(i,t,y.dataProperty,r,y.isFieldRequired);}}else if(v[y.dataProperty]&&v[y.dataProperty].length){s(v[y.dataProperty],t,y.dataProperty,r,y.isFieldRequired);}if(u[y.unitProperty]&&u[y.unitProperty].length){s(u[y.unitProperty],t,y.unitProperty,r,y.isFieldRequired,true);}else if((y.dataProperty&&v[y.dataProperty]&&!v[y.dataProperty].length)||(y.unitProperty&&u[y.unitProperty]&&!u[y.unitProperty].length)){var A=v[y.dataProperty]&&v[y.dataProperty].some(function(G){return G.text==="< Clear Values >"||G.text==="< Leave Blank >";});if(y.dataProperty&&!A){v[y.dataProperty].push({text:r.leaveBlankValue,key:"Empty/"+y.dataProperty});}var E=u[y.unitProperty]&&u[y.unitProperty].some(function(G){return G.text==="< Clear Values >"||G.text==="< Leave Blank >";});if(y.unitProperty&&!E){u[y.unitProperty].push({text:r.leaveBlankValue,key:"Empty/"+y.unitProperty});}}if(y.isPropertyReadOnly&&typeof y.isPropertyReadOnly==="boolean"){w.push({"property":y.dataProperty,value:y.isPropertyReadOnly,type:"Default"});}else if(y.isPropertyReadOnly&&y.isPropertyReadOnly.operand1&&y.isPropertyReadOnly.operand2){w.push({"property":y.dataProperty,propertyPath:y.isPropertyReadOnly.operand1.path,propertyValue:y.isPropertyReadOnly.operand2.value,type:"Path"});}});var y={"values":v,"unitData":u,"results":R,"readablePropertyData":w};var z=new J(y);return z;}function o(t,i){var q="sap/fe/macros/massedit/MassEditDialog",r=t&&t.getModel().getMetaModel(),u=[],v=t.data("metaPath"),R=sap.ui.getCore().getLibraryResourceBundle("sap.fe.macros"),S=t.getSelectedContexts().length,w={"keepExistingPrefix":"< Keep","leaveBlankValue":"< Leave Blank >","clearFieldValue":"< Clear Values >","massEditTitle":R.getText("C_MASS_EDIT_DIALOG_TITLE",S),"applyButtonText":R.getText("C_MASS_EDIT_APPLY_BUTTON_TEXT"),"cancelButtonText":R.getText("C_MASS_EDIT_CANCEL_BUTTON_TEXT")},T=[],E=i.getExtensionAPI();t&&t.getColumns().forEach(function(G){var H=G&&G.getDataProperty(),I=t.data("columns")&&t.data("columns").customData.filter(function(K){return K.name===H&&K.type==="Annotation";});T.push({"dataProperty":H,"label":G.getHeader(),"annotationPath":I&&I[0]&&I[0].annotationPath});});var x=r.getContext(v+"/@"),y=M.getInvolvedDataModelObjects(x),z=p(y,t,r,v,T,u,z),A=m(t,u,w);return new Promise(function(G,H){var I=X.loadTemplate(q,"fragment");return Promise.resolve(a.process(I,{name:q},{bindingContexts:{dataFieldModel:z.createBindingContext("/")},models:{dataFieldModel:z}})).then(function(I){return F.load({definition:I}).then(function(K){var L=new D({title:w.massEditTitle,content:[K],beginButton:{text:w.applyButtonText,type:"Emphasized",press:function(N){var L=N.getSource().getParent(),O=L.getModel("fieldsInfo"),P=O.getProperty("/results"),Q=O.getProperty("/readablePropertyData"),V=[],W=false;t.getSelectedContexts().forEach(function(Y){P.forEach(function(Z){if(Q){W=Q.some(function($){if(Z.keyValue===$.property){if($.type==="Default"){return $.value===true;}else if($.type==="Path"&&$.propertyValue&&$.propertyPath){return(Y.getObject($.propertyPath)===$.propertyValue);}}});}if(Z.keyValue&&Z.value!=="Default"&&!W){V.push(Y.setProperty(Z.keyValue,Z.value));}});});return Promise.all(V).then(function(Y){var Z=t.getRowBinding();return E.refresh(Z.getPath()).then(function(){L.close();L.destroy();return Y;});}).catch(function(Y){throw new Error(Y);});}},endButton:{text:w.cancelButtonText,press:function(N){var L=N.getSource().getParent();L.close();L.destroy();}}});L.open();L.setModel(A,"fieldsInfo");});}).catch(H);});}var n={openMassEditDialog:o};return n;});
