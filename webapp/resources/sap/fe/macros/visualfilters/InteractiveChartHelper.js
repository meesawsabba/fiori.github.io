/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2021 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","sap/ui/model/odata/v4/AnnotationHelper","sap/fe/macros/CommonHelper","sap/ui/core/format/NumberFormat","sap/fe/macros/ResourceModel","sap/fe/macros/ODataMetaModelUtil","sap/fe/core/templating/FilterHelper","sap/fe/core/templating/CriticalityFormatters","sap/fe/macros/field/FieldTemplating","sap/fe/core/controls/filterbar/utils/VisualFilterUtils","sap/fe/core/helpers/StableIdHelper","sap/ui/mdc/odata/v4/TypeUtil","sap/fe/macros/filter/FilterFieldHelper","sap/ui/model/odata/v4/ODataUtils","sap/base/util/JSTokenizer","sap/ui/mdc/condition/ConditionConverter","sap/fe/core/CommonUtils"],function(L,O,C,N,R,a,F,b,c,V,S,T,d,e,J,f,g){"use strict";var I={getChartDisplayedValue:function(v,o,m){var i=S.generate([m]);return("{parts:[{path:'"+v+"',type:'sap.ui.model.odata.type.Decimal', constraints:{'nullable':false}}"+(o&&o.ScaleFactor?",{value:'"+o.ScaleFactor.$Decimal+"'}":",{path:'internal>scalefactorNumber/"+i+"'}")+(o&&o.NumberOfFractionalDigits?",{value:'"+o.NumberOfFractionalDigits+"'}":",{value:'0'}")+",{path:'internal>currency/"+i+"'}"+"], formatter:'VisualFilterRuntime.scaleVisualFilterValue'}");},getChartValue:function(v){return"{path:'"+v+"',type:'sap.ui.model.odata.type.Decimal', constraints:{'nullable':false}}";},getChart:function(m){var M=m.getModel();var p=M.getObject(m.getPath());var v=p.Visualizations;for(var i=0;i<v.length;i++){if(v[i].$AnnotationPath.indexOf("com.sap.vocabularies.UI.v1.Chart")>-1){var s=O.getNavigationPath(m.getPath());return M.createBindingContext(s+"/"+v[i].$AnnotationPath);}}return undefined;},getChartLabel:function(){return arguments[2];},getAggregationBinding:function(o,h,j,t,D,s,k,l,A,u,p,m){var n=m.getProperty("contextPath");var E=n?n.getPath():"";var q=h.Dimensions[0].$PropertyPath;var M=h.Measures[0].$PropertyPath,B,r,v=[],w,U,x,y,z,G;var H=j.$kind=="NavigationProperty"?o.getPath(1):(j.$kind=="EntitySet"?"/":"")+o.getModel(1).getObject(o.getPath(1)+"@sapui.name");var K=I.getUoM(o,h,j,undefined,l,A);var P=o.getInterface(1).getPath(),Q=o.getInterface(1).getModel();if(k&&k.getObject()){var G=Q.getObject(P+"/");y=F.getFiltersConditionsFromSelectionVariant(G,k.getObject(),V.getCustomConditions.bind(V));for(var W in y){var X=y[W];X.forEach(function(f1){if(!f1.isParameter){v.push(f1);}});}}if(E!==H+"/"&&p&&p.length&&y){var Y=[];var Z=V.convertFilterCondions(y);var $=g.getParameterInfo(Q,H).parameterProperties;for(var i=0;i<p.length;i++){var _=$[p[i]];var a1=P.split("/")[1];var b1=Q.createBindingContext("/"+a1+"/"+p[i]);var c1=J.parseJS(d.formatOptions(_,{context:b1})||"{}");var d1=J.parseJS(d.constraints(_,{context:b1})||"{}");var e1=T.getTypeConfig(_.$Type,c1,d1);var f1=Z[p[i]];var g1=f1?f1[0]:undefined;if(g1){var h1=f.toType(g1,e1,T);var i1=e1.className;var j1=encodeURIComponent(e.formatLiteral(h1.values[0],i1));j1=j1.replaceAll("'","\\'");Y.push(p[i]+"="+j1);}}var k1=H.slice(0,H.lastIndexOf("/"));var l1=H.substring(H.lastIndexOf("/")+1);z=k1+"("+Y.toString()+")/"+l1;H=z;}if(l){if(u){w=K&&K.$Path?"{ 'unit' : '"+K.$Path+"' }":"{}";U="";}else{w="{}";U=K&&K.$Path?", '"+K.$Path+"' : {}":"";}}else if(A&&A.AggregatableProperty&&A.AggregatableProperty.value&&A.AggregationMethod){w="{ 'name' : '"+A.AggregatableProperty.value+"', 'with' : '"+A.AggregationMethod+"'}";U=K&&K.$Path?", '"+K.$Path+"' : {}":"";}x=t?"' : { 'additionally' : ['"+t.$Path+"'] }":"' : { }";r=JSON.stringify(v);B="{path: '"+H+"', templateShareable: true, suspended : true, 'filters' : "+r+",'parameters' : {"+I.getSortOrder(h,D,s)+", '$$aggregation' : {'aggregate' : {'"+M+"' : "+w+"},'group' : {'"+q+x+U+"} } }"+I.getMaxItems(h)+"}";return B;},getSortOrder:function(o,D,s){if(o.ChartType.$EnumMember==="com.sap.vocabularies.UI.v1.ChartType/Donut"||o.ChartType.$EnumMember==="com.sap.vocabularies.UI.v1.ChartType/Bar"){if(s&&s.length&&s[0].Property.$PropertyPath===o.Measures[0].$PropertyPath){return"'$orderby' : '"+s[0].Property.$PropertyPath+(s[0].Descending?" desc'":"'");}else{return"'$orderby' : '"+o.Measures[0].$PropertyPath+" desc'";}}else{if(D==="Edm.Date"||D==="Edm.Time"||D==="Edm.DateTimeOffset"){return"'$orderby' : '"+o.Dimensions[0].$PropertyPath+"'";}else{if(s&&s.length&&s[0].Property.$PropertyPath===o.Dimensions[0].$PropertyPath){return"'$orderby' : '"+s[0].Property.$PropertyPath+(s[0].Descending?" desc'":"'");}else{return"'$orderby' : '"+o.Dimensions[0].$PropertyPath+"'";}}}},getMaxItems:function(o){if(o.ChartType.$EnumMember==="com.sap.vocabularies.UI.v1.ChartType/Bar"){return",'startIndex' : 0,'length' : 3";}else if(o.ChartType.$EnumMember==="com.sap.vocabularies.UI.v1.ChartType/Line"){return",'startIndex' : 0,'length' : 6";}else{return"";}},getColorBinding:function(i,D,o){var m=i.getModel(0);var h=i.getPath(1);var v=m.getObject(h+"$PropertyPath@com.sap.vocabularies.UI.v1.ValueCriticality");D=D.targetObject;if(D.Criticality){return b.buildExpressionForCriticalityColorMicroChart(D);}else if(D.CriticalityCalculation){var j=D.CriticalityCalculation.ImprovementDirection&&D.CriticalityCalculation.ImprovementDirection.$EnumMember;var k=O.value(D.Value,{context:i.getInterface(0)});var l=O.value(D.CriticalityCalculation.DeviationRangeLowValue,{context:i.getInterface(0)});var t=O.value(D.CriticalityCalculation.ToleranceRangeLowValue,{context:i.getInterface(0)});var A=O.value(D.CriticalityCalculation.AcceptanceRangeLowValue,{context:i.getInterface(0)});var n=O.value(D.CriticalityCalculation.AcceptanceRangeHighValue,{context:i.getInterface(0)});var p=O.value(D.CriticalityCalculation.ToleranceRangeHighValue,{context:i.getInterface(0)});var q=O.value(D.CriticalityCalculation.DeviationRangeHighValue,{context:i.getInterface(0)});return C.getCriticalityCalculationBinding(j,k,l,t,A,n,p,q);}else if(v.length){return C.getValueCriticality(o.$PropertyPath,v);}else{return undefined;}},getScaleUoMTitle:function(i,o,h,m,j,A,s,k){var M=i.getModel(0);var l=M.getObject(i.getPath(0)+"/MeasureAttributes/0/DataPoint/$AnnotationPath/ValueFormat/ScaleFactor/$Decimal");var n=S.generate([m]);var p=N.getIntegerInstance({style:"short",showScale:false,shortRefNumber:l});var q=p.getScale();var u=I.getUoM(i,o,h,undefined,j,A);var E;u=u&&(u.$Path?"${internal>uom/"+n+"}":"'"+u+"'");q=q?"'"+q+"'":"${internal>scalefactor/"+n+"}";if(s){s=s;}else{s="|";}s=u?"' "+s+" ' + ":"";E=q&&u?s+q+" + ' ' + "+u:s+(q||u);return k?E:"{= "+E+"}";},getMeasureDimensionTitle:function(i,o,h,j,A){var m=i.getModel(0);var M;var s=m.getObject(i.getPath(0)+"/Measures/0/$PropertyPath");var D=m.getObject(i.getPath(0)+"/Dimensions/0/$PropertyPath");var k=I.getLabel(m,i,"Dimensions");if(!j&&A){M=A.annotations&&A.annotations.Common&&A.annotations.Common.Label;if(M===undefined){M=M=I.getLabel(m,i,"Measures");}}else{M=I.getLabel(m,i,"Measures");}if(M===undefined){M=s;}if(k===undefined){k=D;}return(R&&R.getText("M_INTERACTIVE_CHART_HELPER_VISUALFILTER_MEASURE_DIMENSION_TITLE",[M,k]));},getLabel:function(m,i,p){var l=m.getObject(i.getPath(0)+"/"+p+"/0/$PropertyPath@com.sap.vocabularies.Common.v1.Label");return l;},getToolTip:function(i,o,h,m,j,A,r){var s=o&&o["ChartType"]&&o["ChartType"]["$EnumMember"];var M=I.getMeasureDimensionTitle(i,o,h,j,A);if(r==="false"&&s==="com.sap.vocabularies.UI.v1.ChartType/Line"){return"{= '"+M+"'}";}var k=R.getText("M_INTERACTIVE_CHART_HELPER_VISUALFILTER_TOOLTIP_SEPERATOR");var l=S.generate([m]);var n=I.getScaleUoMTitle(i,o,h,l,j,A,k,true);return"{= '"+M+(n?"' + "+n:"'")+"}";},getUoM:function(i,o,h,j,k,A){var m=i.getModel(0);var v=m.getObject(i.getPath(0)+"/Measures/0/$PropertyPath@Org.OData.Measures.V1.ISOCurrency");var u=m.getObject(i.getPath(0)+"/Measures/0/$PropertyPath@Org.OData.Measures.V1.Unit");var M=m.getObject(i.getPath(0)+"/Measures/0/$PropertyPath");var s;if(!k&&A){s=A.AggregatableProperty&&A.AggregatableProperty.value;}else{s=M;}var _=function(U,l){var n=l&&l.split("V1.")[1];var p={};if(U){p[n]=U;return j&&U.$Path?JSON.stringify(p):U;}else if(s){U=i.getModel(1).getObject(i.getPath(1)+"/"+s+l);p[n]=U;return U&&j&&U.$Path?JSON.stringify(p):U;}};return _(v,"@Org.OData.Measures.V1.ISOCurrency")||_(u,"@Org.OData.Measures.V1.Unit");},getScaleFactor:function(v){if(v&&v.ScaleFactor){return v.ScaleFactor.$Decimal;}return undefined;},getUoMVisiblity:function(i,o,s){var h=o&&o["ChartType"]&&o["ChartType"]["$EnumMember"];if(s){return false;}else if(!(h==="com.sap.vocabularies.UI.v1.ChartType/Bar"||h==="com.sap.vocabularies.UI.v1.ChartType/Line")){return false;}else{return true;}},getInParameterFiltersBinding:function(i){if(i.length>0){var p=[],P="";i.forEach(function(o){if(o.localDataProperty){p.push("{path:'$filters>/conditions/"+o.localDataProperty+"'}");}});if(p.length>0){P=p.join();return("{parts:["+P+"], formatter:'sap.fe.macros.visualfilters.VisualFilterRuntime.getFiltersFromConditions'}");}else{return undefined;}}else{return undefined;}},getfilterCountBinding:function(i,o){var D=o.Dimensions[0].$PropertyPath;return("{path:'$filters>/conditions/"+D+"', formatter:'sap.fe.macros.visualfilters.VisualFilterRuntime.getFilterCounts'}");}};I.getfilterCountBinding.requiresIContext=true;I.getColorBinding.requiresIContext=true;I.getAggregationBinding.requiresIContext=true;I.getUoM.requiresIContext=true;I.getScaleUoMTitle.requiresIContext=true;I.getToolTip.requiresIContext=true;I.getMeasureDimensionTitle.requiresIContext=true;I.getUoMVisiblity.requiresIContext=true;return I;},true);
