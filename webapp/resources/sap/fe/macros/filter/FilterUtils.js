/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2021 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/mdc/util/FilterUtil","sap/ui/fl/Utils","sap/ui/core/Core","sap/fe/macros/CommonHelper","sap/fe/core/CommonUtils","sap/fe/core/helpers/ModelHelper","sap/ui/model/Filter","sap/fe/macros/DelegateUtil","sap/fe/core/converters/controls/ListReport/FilterBar","sap/fe/core/converters/ConverterContext","sap/fe/core/converters/MetaModelConverter","sap/base/util/merge","sap/ui/model/json/JSONModel","sap/ui/mdc/field/ConditionsType","sap/ui/mdc/p13n/StateUtil","sap/ui/mdc/condition/ConditionConverter","sap/ui/model/odata/v4/ODataUtils","sap/fe/macros/ODataMetaModelUtil","sap/base/Log"],function(F,a,C,b,c,M,d,D,e,f,g,m,J,h,S,j,O,k,L){"use strict";var o={getFilter:function(i){var l=o.getFilterInfo(i).filters;return l.length?new d(o.getFilterInfo(i).filters,false):undefined;},getConvertedFilterFields:function(i,E){var s=D.getCustomData(i,"entityType"),l=M.getEntitySetPath(s),n=E&&M.getEntitySetPath(E),t=n||l,T=t?t.slice(1):t,p="selectionFields"+(!t||l===t?"":"For"+T),q=D.getCustomData(i,p);if(!q&&(!t||!(i.data instanceof Function))){return[];}else if(!q){var v=a.getViewForControl(i);var r=i.getModel().getMetaModel();var A=c.getAppComponent(v);var V=g.getInvolvedDataModelObjects(r.createBindingContext("/"+T));var u=f.createConverterContextForMacro(V.startingEntitySet.name,r,A&&A.getDiagnostics(),m,V.contextLocation,v&&v.getViewData());q=e.getSelectionFields(u);if(i.isA("sap.ui.mdc.FilterBar")&&n!==l){var P=u.getConverterContextFor(l);var w=P.getEntityTypeAnnotation("@com.sap.vocabularies.UI.v1.SelectionFields").annotation||[];var x={};q.forEach(function(y){x[y.conditionPath]=true;});w.forEach(function(y){var z=y.value;if(!x[z]){var B=e.getFilterField(z,u,V.startingEntitySet.entityType);if(B){q.push(B);}}});}D.setCustomData(i,p,q);}return b.parseCustomData(q);},getBindingPathForParameters:function(I,l,n,p){var B,P=[];for(var i=0;i<p.length;i++){var s=p[i];if(l[s]&&l[s].length>0){var q=m({},l[s][0]);var r=F.getPropertyByKey(n,s);var t=j.toType(q,r.typeConfig,I.getTypeUtil());var E=r.typeConfig.className;P.push(s+"="+encodeURIComponent(O.formatLiteral(t.values[0],E)));}}var u=I.data("entityType");var v=u.substring(0,u.length-1);var w=v.slice(0,v.lastIndexOf("/"));var T=v.substring(v.lastIndexOf("/")+1);B=w+"("+P.toString()+")/"+T;return B;},getEditStateIsHideDraft:function(i){var I=false;if(i&&i.$editState){var l=i.$editState.find(function(n){return n.operator==="DRAFT_EDIT_STATE";});if(l&&l.values.includes("ALL_HIDING_DRAFTS")){I=true;}}return I;},getFilterInfo:function(I,p,l){var n=I,s,B,q=[],r=(p&&p.ignoredProperties)||[],P=p&&p.propertiesMetadata,t=p&&p.targetControl,T=t?t.data("entityType"):undefined;if(typeof I==="string"){n=C.byId(I);}if(n){s=n.getSearch&&r.indexOf("search")===-1?n.getSearch():null;var u=l||n.getConditions(),v=n.getPropertyInfoSet?n.getPropertyInfoSet():null;var w=n.data("parameters")||[];if(w.length>0){B=o.getBindingPathForParameters(n,u,v,w);}if(u){if(T&&n.data("entityType")!==T){var x=n.getModel().getMetaModel();var y=n.getControlDelegate().fetchPropertiesForEntity(T,x,n);P=y;var E={};for(var i=0;i<y.length;i++){var z=y[i];E[z.name]=true;}v.forEach(function(G){var H=G.name;if(!E[H]){r.push(H);}});}else if(!P){P=v;}var A=F.getFilterInfo(n,u,P,r.concat(w)).filters;q=A?[A]:[];}}return{filters:q,search:s||undefined,bindingPath:B};},getNotApplicableFilters:function(i,l){var t=l.data("entityType"),n=[],p=i.getConditions(),q=i.getModel().getMetaModel(),I=t===i.data("entityType"),r=l.isA("sap.ui.mdc.ChartNew"),s=!r&&D.getCustomData(l,"enableAnalytics")==="true";if(p&&(!I||s||r)){var T=I?[]:i.getControlDelegate().fetchPropertiesForEntity(t,q,i),u=T.reduce(function(y,z){y[z.name]=z;return y;},{}),v=!r&&b.parseCustomData(D.getCustomData(l,"aggregates")||{}),A={};Object.keys(v).forEach(function(y){var z=v[y];A[z.relativePath]=z;});if(l.isA("sap.ui.mdc.ChartNew")){var E=l.getModel().getMetaModel().getObject(l.data("targetCollectionPath")+"@"),w=k.getAllCustomAggregates(E);Object.keys(w).forEach(function(y){if(!A[y]){var z=w[y];A[y]=z;}});}for(var P in p){var x=p[P];if(Array.isArray(x)&&x.length>0&&((!u[P]&&!I)||A[P])){n.push(P.replace(/\+|\*/g,""));}}}if((s||r)&&i.getSearch()){n.push("$search");}return n;},attachConditionHandling:function(i){var l=new J(),E={filterControl:i,filterModel:l},t=this;i.setModel(l,"filterValues");return i.initialized().then(function(){var n=i._getConditionModel();n.attachPropertyChange(E,t._handleConditionModelChange,t);l.attachPropertyChange(E,t._handleFilterModelChange,t);});},detachConditionHandling:function(i){var l=i.getModel("filterValues"),n=i._getConditionModel();n.detachPropertyChange(this._handleConditionModelChange,this);l.detachPropertyChange(this._handleFilterModelChange,this);l.destroy();},setFilterValues:function(i,s,l,v){var n={};if(v===undefined){v=l;}else{n.operators=[l];}if(typeof v==="object"&&v.operator){n.operators=[v.operator];v=v.values;}var p=new h(n),q={},r={};v=Array.isArray(v)?v:[v];q[s]=[];if(l){r[s]=v.filter(function(V){return V!==undefined&&V!==null;}).reduce(function(A,V){return A.concat(p.parseValue(V.toString(),"any"));},[]);}return S.applyExternalState(i,{filter:q}).then(S.applyExternalState.bind(S,i,{filter:r}));},conditionToModelPath:function(s){return s.replace(/\//g,"\\");},modelToConditionPath:function(s){return s.replace(/\\/g,"/");},_handleConditionModelChange:function(E,i){var s=this.modelToConditionPath(E.getParameter("path").substring(12)),l=new h({maxConditions:-1}),n=i.filterModel,v=E.getParameter("value"),V=l.formatValue(v,"any");n.setProperty("/"+this.conditionToModelPath(s),V);},_handleFilterModelChange:function(E,i){var p=E.getParameter("context").getPath().substring(1).replace(/\\/g,"/"),v=E.getParameter("value");this.setFilterValues(i.filterControl,p,v);}};return o;});
