/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2021 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/mdc/library","sap/ui/mdc/odata/v4/vizChart/ChartDelegateNew","sap/fe/macros/ODataMetaModelUtil","sap/ui/mdc/odata/v4/ODataMetaModelUtil","sap/base/util/merge","sap/fe/macros/chart/ChartUtils","sap/ui/mdc/util/FilterUtil","sap/ui/mdc/odata/v4/util/DelegateUtil","sap/ui/base/SyncPromise","sap/base/Log","sap/fe/core/CommonUtils","sap/fe/macros/ResourceModel","sap/fe/macros/CommonHelper","sap/fe/macros/ChartAPI"],function(M,B,a,O,m,C,F,D,S,L,b,R,c,d){"use strict";var e=Object.assign({},B);function s(f,g){var n="",i=C.getAllFilterInfo(f),j=g.path.substr(1);if(f.getFilter()){if(i.search||(i.filters&&i.filters.length)){n="T_OP_TABLE_AND_CHART_NO_DATA_TEXT_WITH_FILTER";}else{n="T_OP_TABLE_AND_CHART_NO_DATA_TEXT";}}else{if(i.search||(i.filters&&i.filters.length)){n="T_OP_TABLE_AND_CHART_NO_DATA_TEXT_WITH_FILTER";}else{n="M_OP_TABLE_AND_CHART_OP_NO_FILTERS_NO_DATA_TEXT";}}if(n==="T_OP_TABLE_AND_CHART_NO_DATA_TEXT_WITH_FILTER"||n==="T_OP_TABLE_AND_CHART_NO_DATA_TEXT"){return f.getModel("sap.fe.i18n").getResourceBundle().then(function(r){f.setNoDataText(b.getTranslatedText(n,r,null,j));}).catch(function(k){L.error(k);});}else{if(R){f.setNoDataText(R.getText(n));}}}function h(f,E,k,g,p,l){var A=c.parseCustomData(f.data("applySupported"));var n=E["@Org.OData.Capabilities.V1.SortRestrictions"]||{};var q=O.getSortRestrictionsInfo(n);var r=E["@Org.OData.Capabilities.V1.FilterRestrictions"];var t=O.getFilterRestrictionsInfo(r);var u=this.getModel().getObject(this.getPath());var K=this.getModel().getObject(this.getPath()+"@sapui.name");var v=this.getModel();if(u&&u.$kind==="Property"){if(u.$isCollection){return;}var P=v.getObject(this.getPath()+"@");var w=v.getObject("@sapui.name",v.getMetaContext(this.getPath()));var G=A&&A.GroupableProperties;var x=A&&A.AggregatableProperties;var y=false,z=false;if(G&&G.length){for(var i=0;i<G.length;i++){if(G[i].$PropertyPath===w){y=true;break;}}}if(x&&x.length){for(var j=0;j<x.length;j++){if(x[j].Property.$PropertyPath===w){z=true;break;}}}if(!G||(G&&!G.length)){y=P["@Org.OData.Aggregation.V1.Groupable"];}if(!x||(x&&!x.length)){z=P["@Org.OData.Aggregation.V1.Aggregatable"];}if(!y&&!z){return;}if(z){var H=e._createPropertyInfosForAggregatable(K,P,t,q,k,g);H.forEach(function(J){p.push(J);});}if(y){var N=K||"",T=P["@com.sap.vocabularies.Common.v1.Text"]?P["@com.sap.vocabularies.Common.v1.Text"].$Path:null;var I=false;if(N&&N.indexOf("/")>-1){L.error("$expand is not yet supported. Property: "+N+" from an association cannot be used");return;}if(T&&T.indexOf("/")>-1){L.error("$expand is not yet supported. Text Property: "+T+" from an association cannot be used");I=true;}p.push({name:K,propertyPath:K,label:P["@com.sap.vocabularies.Common.v1.Label"]||K,sortable:q[K]?q[K].sortable:true,filterable:t[K]?t[K].filterable:true,groupable:true,aggregatable:false,maxConditions:O.isMultiValueFilterExpression(t.propertyInfo[K])?-1:1,sortKey:K,kind:"Groupable",availableRoles:e._getLayoutOptionsForType("groupable"),role:M.ChartItemRoleType.category,criticality:l,textProperty:!I&&P["@com.sap.vocabularies.Common.v1.Text"]?P["@com.sap.vocabularies.Common.v1.Text"].$Path:null,textFormatter:function(V,J){if(P["@com.sap.vocabularies.Common.v1.Text@com.sap.vocabularies.UI.v1.TextArrangement"]){var Q=P["@com.sap.vocabularies.Common.v1.Text@com.sap.vocabularies.UI.v1.TextArrangement"];if(Q.$EnumMember==="com.sap.vocabularies.UI.v1.TextArrangementType/TextFirst"){return J+" ("+V+")";}else if(Q.$EnumMember==="com.sap.vocabularies.UI.v1.TextArrangementType/TextLast"){return V+" ("+J+")";}else if(Q.$EnumMember==="com.sap.vocabularies.UI.v1.TextArrangementType/TextOnly"){return J;}}return J?J:V;}});}}}e.updateBindingInfo=function(f,g){s(f,g);var i=sap.ui.getCore().byId(f.getFilter());if(i){var j=i.getConditions();if(j){if(!g){g={};}var I=f.getControlDelegate()._getChart(f);var k;if(I){if(C.getChartSelectionsExist(f)){k=C.getAllFilterInfo(f);}}k=k?k:C.getFilterBarFilterInfo(f);if(k){g.filters=k.filters;}var p=D.getParametersInfo(i,j);if(p){g.path=p;}}}};e.fetchProperties=function(f){var g=this._getModel(f);var p;if(!g){p=new Promise(function(r){f.attachModelContextChange({resolver:r},o,this);}.bind(this)).then(function(g){return this._createPropertyInfos(f,g);}.bind(this));}else{p=this._createPropertyInfos(f,g);}return p.then(function(P){if(f.data){f.data("$mdcChartPropertyInfo",P);}return P;});};function o(E,f){var g=E.getSource();var i=this._getModel(g);if(i){g.detachModelContextChange(o);f.resolver(i);}}e._createPropertyInfos=function(f,g){var E="/"+f.data("entitySet");var i=g.getMetaModel();return Promise.all([i.requestObject(E+"/"),i.requestObject(E+"@")]).then(function(r){var p=[];var j=r[0],k=r[1];var l=c.parseCustomData(f.data("customAgg"));var A;var P=[];for(var n in k){if(n.startsWith("@Org.OData.Aggregation.V1.CustomAggregate")){A=n.replace("@Org.OData.Aggregation.V1.CustomAggregate#","");var q=A.split("@");if(q.length==2&&q[1]=="com.sap.vocabularies.Common.v1.Label"){l[q[0].label]=k[n];}}}var t=[],u=[];if(Object.keys(l).length>=1){var v=f.getItems();for(var w in v){if(v[w].isA("sap.ui.mdc.chart.DimensionItem")){t.push(v[w].getKey());}else if(v[w].isA("sap.ui.mdc.chart.MeasureItem")){u.push(v[w].getKey());}}if(u.filter(function(G){return t.indexOf(G)!=-1;}).length>=1){L.error("Dimension and Measure has the sameProperty Configured");}}var T=c.parseCustomData(f.data("transAgg"));var K={};for(var x in T){var y=T[x].propertyPath;K[y]=K[y]||{};K[y][T[x].aggregationMethod]={name:T[x].name,label:T[x].label};}for(var z in j){if(z.indexOf("$")!==0){P.push(a.fetchCriticality(i,i.createBindingContext(E+"/"+z)).then(h.bind(i.getMetaContext(E+"/"+z),f,k,K,l,p)));}}return Promise.all(P).then(function(){return p;});});};e._createPropertyInfosForAggregatable=function(k,p,f,g,K,i){var A=[];if(Object.keys(K).indexOf(k)>-1){for(var j in K[k]){A.push({name:K[k][j].name,propertyPath:k,label:K[k][j].label||p["@com.sap.vocabularies.Common.v1.Label"]+" ("+j+")"||k+" ("+j+")",sortable:g[k]?g[k].sortable:true,filterable:f[k]?f[k].filterable:true,groupable:false,aggregatable:true,aggregationMethod:j,maxConditions:O.isMultiValueFilterExpression(f.propertyInfo[k])?-1:1,kind:"Aggregatable",availableRoles:e._getLayoutOptionsForType("aggregatable"),role:M.ChartItemRoleType.axis1,datapoint:null});}}else if(Object.keys(i).indexOf(k)>-1){for(var l in i){if(l===k){var I=m({},i[l],{kind:M.ChartItemType.Measure,role:M.ChartItemRoleType.axis1,sortable:i[l].sortable});A.push(I);break;}}}return A;};e.rebindChart=function(f,g){B.rebindChart(f,g);};e._setChart=function(f,i){var g=f.getParent();i.setVizProperties(f.data("vizProperties"));i.detachSelectData(g.handleSelectionChange.bind(g));i.detachDeselectData(g.handleSelectionChange.bind(g));i.detachDrilledUp(g.handleSelectionChange.bind(g));i.attachSelectData(g.handleSelectionChange.bind(g));i.attachDeselectData(g.handleSelectionChange.bind(g));i.attachDrilledUp(g.handleSelectionChange.bind(g));i.setSelectionMode(f.getPayload().selectionMode.toUpperCase());B._setChart(f,i);};e._getBindingInfo=function(f){if(this._getBindingInfoFromState(f)){return this._getBindingInfoFromState(f);}var g=f.getDelegate().payload;var i=f.getModel()&&f.getModel().getMetaModel();var t=f.data("targetCollectionPath");var E=(i.getObject(t+"/$kind")==="EntitySet"?"/":"")+g.contextPath;var p=m({},g.parameters,{entitySet:f.data("entitySet"),useBatchRequests:true,provideGrandTotals:true,provideTotalResultSize:true,noPaging:true});var j={path:E,parameters:p};return j;};e.removeItemFromInnerChart=function(f,g){B.removeItemFromInnerChart.call(this,f,g);if(g.getType()==="groupable"){var i=this._getChart(f);i.fireDeselectData();}};return e;},false);
