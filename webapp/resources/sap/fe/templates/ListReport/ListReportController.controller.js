/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2021 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/fe/core/PageController","sap/fe/core/controllerextensions/SideEffects","sap/fe/core/controllerextensions/EditFlow","sap/base/Log","sap/base/util/ObjectPath","sap/fe/core/CommonUtils","sap/ui/mdc/p13n/StateUtil","sap/fe/macros/table/Utils","sap/fe/core/controllerextensions/InternalRouting","sap/ui/Device","sap/fe/core/controllerextensions/IntentBasedNavigation","./overrides/IntentBasedNavigation","sap/fe/core/controllerextensions/InternalIntentBasedNavigation","sap/fe/macros/chart/ChartRuntime","sap/fe/templates/ListReport/ExtensionAPI","sap/fe/macros/filter/FilterUtils","sap/fe/macros/chart/ChartUtils","sap/fe/macros/DelegateUtil","sap/ui/core/mvc/OverrideExecution","sap/fe/core/controllerextensions/ViewState","./overrides/ViewState","sap/fe/templates/RootContainer/overrides/EditFlow","sap/fe/core/helpers/EditState","sap/fe/core/library","sap/fe/core/controllerextensions/Share","./overrides/Share","sap/fe/macros/CommonHelper","sap/fe/core/controllerextensions/KPIManagement","sap/fe/templates/TableScroller","sap/fe/core/controllerextensions/Placeholder"],function(P,S,E,L,O,C,a,T,I,D,b,c,d,e,f,F,g,h,i,V,j,l,m,n,o,p,q,K,r,s){"use strict";var t=n.TemplateContentView,u=n.InitialLoadMode;return P.extend("sap.fe.templates.ListReport.ListReportController",{metadata:{methods:{getExtensionAPI:{"public":true,"final":true},onPageReady:{"public":false,"final":false,overrideExecution:i.After},onViewNeedsRefresh:{"public":true,"final":false,overrideExecution:i.After},onPendingFilters:{"public":true,"final":false,overrideExecution:i.After}}},_routing:I.override({onAfterBinding:function(k,v){this.getView().getController()._onAfterBinding(k,v);}}),_intentBasedNavigation:d.override({getEntitySet:function(){return this.base.getCurrentEntitySet();}}),sideEffects:S,intentBasedNavigation:b.override(c),share:o.override(p),editFlow:E.override(l),viewState:V.override(j),kpiManagement:K,placeholder:s,getExtensionAPI:function(){if(!this.extensionAPI){this.extensionAPI=new f(this);}return this.extensionAPI;},onInit:function(){P.prototype.onInit.apply(this);var k=this;var v=this._getControls();var w=this.getView().getBindingContext("internal");if(k._isMultiMode()){var M=k._getMultiModeControl();w.setProperty("tabs",{selected:M.getSelectedKey()||M.getItems()[0].getKey()});v.forEach(function(y){var U=function(){k._updateCounts();};C.addEventToBindingInfo(y,"dataRequested",U);});}w.setProperty("hasPendingFilters",true);w.setProperty("appliedFilters","");w.setProperty("hideDraftInfo",false);w.setProperty("uom",{});w.setProperty("scalefactor",{});w.setProperty("scalefactorNumber",{});w.setProperty("currency",{});if(this._hasMultiVisualizations()){var x=this._getDefaultPath();if(!D.system.desktop&&x===t.Hybrid){x=t.Chart;}w.setProperty("alpContentView",x);}this.filterBarConditions={};this.getAppComponent().getRouterProxy().waitForRouteMatchBeforeNavigation();this._isMultiMode()&&this._updateMultiControlHiddenStatus();F.attachConditionHandling(this._getFilterBarControl());},onExit:function(){F.detachConditionHandling(this._getFilterBarControl());delete this._sEntitySet;delete this.filterBarConditions;delete this._oListReportControl;delete this._bMultiMode;this.extensionAPI&&this.extensionAPI.destroy();delete this.extensionAPI;},_onAfterBinding:function(){var k=this._getControls("table");var v=this;if(m.isEditStateDirty()){var w=this._getTableBinding();if(w){if(!this.sUpdateTimer){this.sUpdateTimer=setTimeout(function(){w.refresh();delete v.sUpdateTimer;},0);}var U=function(){v._updateTableActions(k);w.detachDataReceived(U);};w.attachDataReceived(U);}m.setEditStateProcessed();}if(!this.sUpdateTimer){this._updateTableActions(k);}this.pageReady.waitFor(this.getAppComponent().getAppStateHandler().applyAppState());},onBeforeRendering:function(){P.prototype.onBeforeRendering.apply(this);},onAfterRendering:function(k){var v=this;this.getView().getModel("sap.fe.i18n").getResourceBundle().then(function(w){v.oResourceBundle=w;var x=v._getControls();var y=v.getView().getViewData().entitySet;var z=C.getTranslatedText("T_OP_TABLE_AND_CHART_NO_DATA_TEXT",v.oResourceBundle,undefined,y);x.forEach(function(A){A.setNoDataText(z);});}).catch(function(w){L.error("Error while retrieving the resource bundle",w);});},onPageReady:function(k){var v=k.lastFocusedControl;var w=this.getView();if(v&&v.controlId&&v.focusInfo){var x=w.byId(v.controlId);if(x){x.applyFocusInfo(v.focusInfo);}}var y=this._getFilterBarControl();if(y&&!y.getShowMessages()){y.setShowMessages(true);y.setFocusOnFirstErroneousField();}},onViewNeedsRefresh:function(k){},onPendingFilters:function(){},getCurrentEntitySet:function(){if(!this._sEntitySet){var k=(this._isMultiMode()&&this._getCurrentControl())||this._getTable();this._sEntitySet=k.data("targetCollectionPath").slice(1);}return this._sEntitySet;},_updateTableActions:function(k){var v=[];k.forEach(function(w){v=C.getIBNActions(w,v);var x=w.getBindingContext("internal"),A=JSON.parse(q.parseCustomData(h.getCustomData(w,"operationAvailableMap"))),y=w.getSelectedContexts();C.setActionEnablement(x,A,y);});C.updateDataFieldForIBNButtonsVisibility(v,this.getView());},_scrollTablesToRow:function(R){this._getControls("table").forEach(function(k){r.scrollTableToRow(k,R);});},_getPageTitleInformation:function(){var k=this;return new Promise(function(v,w){var x={title:"",subtitle:"",intent:"",icon:""};x.title=k.getView().getContent()[0].data().ListReportTitle;x.subtitle=k.getView().getContent()[0].data().ListReportSubtitle;v(x);});},_getFilterBarControl:function(){return this.getView().byId(this._getFilterBarControlId());},_getSegmentedButton:function(k){return this.getView().byId(this._getSegmentedButtonId(k));},_getSegmentedButtonId:function(k){if(k==="Chart"){return this._getChart().data("segmentedButtonId");}else{return this._getTable().data("segmentedButtonId");}},_getFilterBarControlId:function(){return this.getView().getContent()[0].data("filterBarId");},_getChartControlId:function(){return this.getView().getContent()[0].data("singleChartId");},getChartControl:function(){return this.getView().byId(this._getChartControlId());},_getVisualFilterBarControl:function(){return this.getView().byId(this._getVisualFilterBarControlId());},_getVisualFilterBarControlId:function(){return this.getView().getContent()[0].data("visualFilterBarId");},_getMultiModeControl:function(){return this.getView().byId("fe::TabMultipleMode");},_getTableControlId:function(){return this.getView().getContent()[0].data("singleTableId");},_getCurrentControl:function(){if(!this._oListReportControl){var M=this._getMultiModeControl();this._oListReportControl=this.getView().byId(M.getSelectedKey()||M.getItems()[0].getKey());}return this._oListReportControl;},_getTable:function(){if(this._isMultiMode()){var k=this._getCurrentControl();return k&&k.isA("sap.ui.mdc.Table")?k:undefined;}return this.getView().byId(this._getTableControlId());},_getChart:function(){return this.getView().byId(this._getChartControlId());},_getTableBinding:function(k){var v=k?this.getView().byId(k):this._getTable(),B=v&&v._getRowBinding();return B;},_getControls:function(k){var v=this;if(this._isMultiMode()){var w=[];var x=this._getMultiModeControl();x.getItems().forEach(function(y){var z=v.getView().byId(y.getKey());if(k){if(y.getKey().indexOf("fe::"+k)>-1){z&&w.push(z);}}else{z&&w.push(z);}});return w;}return k==="Chart"?[this._getChart()]:[this._getTable()];},_getDefaultPath:function(){var k=this.getView().getContent()[0].data("defaultPath");switch(k){case"primary":return t.Chart;case"secondary":return t.Table;case"both":default:return t.Hybrid;}},_isMultiMode:function(){if(!this._oListReportControl){this._bMultiMode=!!this._getMultiModeControl();}return this._bMultiMode;},_isMultiEntitySets:function(){return(this.getView().getContent()[0].data("isMultiEntitySets")==="true");},_hasMultiVisualizations:function(){return(this.getView().getContent()[0].data("hasMultiVisualizations")==="true");},_setShareModel:function(){var G=O.get("sap.ushell.Container.getUser");var k={bookmarkTitle:document.title,bookmarkCustomUrl:function(){var H=window.hasher.getHash();return H?"#"+H:window.location.href;},isShareInJamActive:!!G&&G().isJamActive()};var v=this.getOwnerComponent().getModel("_templPriv");v.setProperty("/listReport/share",k);},_updateMultiControlHiddenStatus:function(){var k=this._getCurrentControl();if(this._isMultiMode()&&k){var v=k.getId();var w=this._getControls();w.forEach(function(x){var y=x.getId();x.data("controlHidden",y!==v);});}},_updateMultiNotApplicableFields:function(k,v){var w={};var x={},y=this._getControls("table"),z=this._getControls("Chart");y.forEach(function(A){var B=A.data("targetCollectionPath"),G=B.slice(1),H=A.getParent().getParent().getKey(),J=G+(A.data("enableAnalytics")==="true"?"Analytical":"Regular");if(!w[J]){w[J]=F.getNotApplicableFilters(v,A);}x[H]=w[J];});z.forEach(function(A){var B=A.data("targetCollectionPath"),G=B.slice(1),H=A.getParent().getParent().getKey(),J=G+"Chart";if(!w[J]){w[J]=F.getNotApplicableFilters(v,A);}x[H]=w[J];});k.setProperty("tabs/ignoredFields",x);},_updateMultiModeSelectedControl:function(){this._sEntitySet=undefined;this._oListReportControl=undefined;this._getCurrentControl();},_updateCounts:function(){this._updateMutliModeCounts();},_isCustomTab:function(){var M=this._getMultiModeControl();return M&&M.getSelectedKey().indexOf("::CustomTab::")>-1;},_updateMutliModeCounts:function(){var v=this;var B=[];var M=this._getMultiModeControl();if(M&&M.data("showCounts")==="true"&&!this._isCustomTab()){var w=this._getCurrentControl();var x=w.getId();var y=[];var z=M.getItems();z.forEach(function(k){var A=v.getView().byId(k.getKey());if(A&&!A.isA("sap.ui.mdc.ChartNew")&&(k.data("outdatedCounts")||A.getId()===x)){y.push({control:A,item:k});}});B=y.map(function(k){k.item.setCount("...");var A=k.control;var G=T.getFiltersInfoForSV(A,k.item.data("selectionVariant"));return T.getListBindingForCount(A,v.getView().getBindingContext(),{batchGroupId:A.getId()===x?A.data("batchGroupId"):"$auto",additionalFilters:G.filters});});Promise.all(B).then(function(A){for(var k in A){var G=y[k].item;G.setCount(T.getCountFormatted(A[k]));G.data("outdatedCounts",false);}}).catch(function(k){L.error("Error while retrieving the values for the icon tab bar",k);});}},_shouldAutoTriggerSearch:function(v){if(this.getView().getViewData().initialLoad===u.Auto&&(!v||v.getStandardVariantKey()===v.getCurrentVariantKey())){var k=this._getFilterBarControl(),w=k.getConditions();for(var x in w){if(!x.startsWith("$")&&Array.isArray(w[x])&&w[x].length){return true;}}}return false;},_updateTable:function(k){if(!k.isTableBound()||this.hasPendingChartChanges){k.rebindTable();this.hasPendingChartChanges=false;}},_updateChart:function(k){var v=k.getControlDelegate()._getChart(k);if(!(v&&v.isBound("data"))||this.hasPendingTableChanges){k.getControlDelegate().rebindChart(k,v.getBindingInfo("data"));this.hasPendingTableChanges=false;}},handlers:{onTabMultiModeChange:function(k){this._updateMultiModeSelectedControl();this._updateMultiControlHiddenStatus();var v=this._getFilterBarControl();var w=this.getView().getBindingContext("internal");var x=this._getCurrentControl();var M=this._getMultiModeControl();w.setProperty("tabs/selected",M.getSelectedKey());if(v&&w.getProperty("hasPendingFilters")!==true){if(this._isCustomTab()){var y=v.getFilterConditions();this.onViewNeedsRefresh({filterConditions:y,currentTabId:M.getSelectedKey(),refreshCause:"tabChanged"});}else if(!x.isA("sap.ui.mdc.ChartNew")&&(!x.getRowBinding()||x.data("outdatedRows")===true)){x.rebindTable();x.data("outdatedRows",false);}else if(x.isA("sap.ui.mdc.ChartNew")&&(!x.getControlDelegate()._getChart(x).getBinding("data")||x.data("outdatedRows")===true)){var z=x.getControlDelegate()._getChart(x);x.getControlDelegate().rebindChart(x,z.getBindingInfo("data"));x.data("outdatedRows",false);}}this.getExtensionAPI().updateAppState();},onFiltersChanged:function(k){var v=this._getFilterBarControl(),w=this.getView().getBindingContext("internal");this.onPendingFilters();var H=F.getEditStateIsHideDraft(v.getConditions());w.setProperty("appliedFilters",v.getAssignedFiltersText().filtersText);w.setProperty("hasPendingFilters",true);w.setProperty("hideDraftInfo",H);if(k.getParameter("conditionsBased")){this.getExtensionAPI().updateAppState();}},onVariantSelected:function(k){var v=this,w=k.getSource();setTimeout(function(){if(v._shouldAutoTriggerSearch(w)){return v._getFilterBarControl().triggerSearch();}else{v.getExtensionAPI().updateAppState();}},0);},onVariantSaved:function(k){var v=this;setTimeout(function(){v.getExtensionAPI().updateAppState();},1000);},onSearch:function(k){var v=this;var w=this._getFilterBarControl();var x=this.getView().getBindingContext("internal");var M=this.getChartControl();x.setProperty("hasPendingFilters",false);if(this._isMultiMode()){var y=this._getControls(),z=this._getMultiModeControl();if(z&&z.data("showCounts")==="true"){var A=z.getItems();A.forEach(function(N){if(!N.getKey().indexOf("fe::Chart")>-1){N.data("outdatedCounts",true);}});}if(!this._isCustomTab()){var B=this._getCurrentControl().getId();this._updateMultiNotApplicableFields(x,w);y.forEach(function(N){N.data("outdatedRows",N.getId()!==B);});}else{var G=w.getFilterConditions();this.onViewNeedsRefresh({filterConditions:G,currentTabId:z.getSelectedKey(),refreshCause:"search"});}}if(M){M.getBindingContext("internal").setProperty("",{});var H=M.getBindingContext("pageInternal");var J=H.getProperty(H.getPath()+"/alpContentView");if(J===t.Chart){this.hasPendingChartChanges=true;}if(J===t.Table){this.hasPendingTableChanges=true;}}a.retrieveExternalState(w).then(function(N){v.filterBarConditions=N.filter;}).catch(function(N){L.error("Error while retrieving the external state",N);});if(this.getView().getViewData().liveMode===false){this.getExtensionAPI().updateAppState();}},onChevronPressNavigateOutBound:function(k,v,w,x){return k._intentBasedNavigation.onChevronPressNavigateOutBound(k,v,w,x);},onChartSelectionChanged:function(k){var M=k.getSource().getContent(),v=this._getTable(),w=k.getParameter("data"),x=this.getView().getBindingContext("internal");if(w){e.fnUpdateChart(k);g.setChartFilters(M);}var y=x.getProperty(x.getPath()+"/alpContentView");if(y===t.Chart){this.hasPendingChartChanges=true;}else{v&&v.rebindTable();this.hasPendingChartChanges=false;}},onSegmentedButtonPressed:function(k){var v=k.mParameters.key?k.mParameters.key:null;var w=this.getView().getBindingContext("internal");w.setProperty("alpContentView",v);var x;var y=this._getChart();var z=this._getTable();var A={onAfterRendering:function(){var B=x.getItems();B.forEach(function(G){if(G.getKey()===v){G.focus();}});x.removeEventDelegate(A);}};x=v===t.Table?this._getSegmentedButton("Table"):this._getSegmentedButton("Chart");if(x!==k.getSource()){x.addEventDelegate(A);}switch(v){case t.Table:this._updateTable(z);break;case t.Chart:this._updateChart(y);break;case t.Hybrid:this._updateTable(z);this._updateChart(y);break;default:break;}this.getExtensionAPI().updateAppState();},onFiltersSegmentedButtonPressed:function(k){if(k.getParameter("key")==="Compact"){this._getFilterBarControl().setVisible(true);this.getView().byId(this.getView().getContent()[0].data("visualFilterBarId")).setVisible(false);}else{this._getFilterBarControl().setVisible(false);this.getView().byId(this.getView().getContent()[0].data("visualFilterBarId")).setVisible(true);}}},formatters:{isDraftIndicatorVisible:function(k,v,H,w,x){if(w!==undefined&&H!==undefined&&(!w||H)&&!x){return k===v;}else{return false;}},setTabMessageStrip:function(k,v){var w="";if(Array.isArray(k)&&k.length>0&&v){var x=this._getFilterBarControl(),y=x.data("entityType"),M=this.getView().getModel().getMetaModel(),R=sap.ui.getCore().getLibraryResourceBundle("sap.fe.templates"),z=k.map(function(G){if(G==="$search"){var H=sap.ui.getCore().getLibraryResourceBundle("sap.fe.macros");return H?H.getText("M_FILTERBAR_SEARCH"):"";}var J=M.getObject(y+G+"@com.sap.vocabularies.Common.v1.Label");return h.getLocalizedText(J,x);});if(R){var A="C_LR_MULTITABLES_"+(z.length===1?"SINGLE":"MULTI")+"_IGNORED_FILTER_"+(D.system.desktop?"LARGE":"SMALL"),B=h.getLocalizedText(v,x);w=R.getText(A,[z.join(", "),B]);}}return w;}}});});
