/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2021 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/routing/HashChanger","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/SemanticKeyHelper","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/base/Log"],function(H,M,S,F,a,L){"use strict";var I,u,e;function c(k,i){var l,K=Object.keys(k);l=K.map(function(s){var v=k[s];if(v!==undefined){return new F(s,a.EQ,v);}});if(i){var A=new F({filters:[new F("SiblingEntity/IsActiveEntity",a.EQ,true)],and:false});l.push(A);}var C=new F(l,true);return C;}function g(C,p,o){var l=C.getView().getBindingContext().getModel().bindList("/"+p,undefined,undefined,o,{"$$groupId":"$auto.Heroes"});return l.requestContexts(0,2).then(function(i){if(i&&i.length){return i[0].getPath();}});}function b(C,o,E){var A=[];var p=[];var m=C.getModel().getMetaModel().getMetaPath(C.getPath());if(m.indexOf("/")===0){m=m.substring(1);}var k=m.split("/");var s=H.getInstance().getHash().split("?")[0];var l=s.split("/");var P={};var n=[];l.forEach(function(r){var K=r.substring(r.indexOf("(")+1,r.length-1).split(",");var t={};var v=r.split("(")[0];P[v]={};n.push(v);P[v]["bIsActiveEntityDefined"]=true;for(var i=0;i<K.length;i++){var w=K[i];var x=w.split("=");var y=x[1];var z=x[0];if(w.indexOf("=")===-1){var B=C.getModel().getMetaModel();var T=B.getObject("/"+n.join("/")+"/$Type/$Key");y=x[0];z=T[0];P[r.split("(")[0]]["bIsActiveEntityDefined"]=false;}if(z!=="IsActiveEntity"){if(y.indexOf("'")===0&&y.lastIndexOf("'")===y.length-1){y=decodeURIComponent(y.substring(1,y.length-1));}t[z]=y;}}P[v].mKeyValues=t;});var q=E;k.forEach(function(N){var i={};var r=q.$NavigationPropertyBinding&&q.$NavigationPropertyBinding[N];if(r){i.pageEntityName=q.$NavigationPropertyBinding[N];q=C.getModel().getMetaModel().getObject("/"+r)||E;}else{i.pageEntityName=N;}i.mKeyValues=P[N].mKeyValues;i.bIsActiveEntityDefined=P[N].bIsActiveEntityDefined;p.push(i);});p.forEach(function(i){var r=c(i.mKeyValues,i.bIsActiveEntityDefined);A.push(g(o,i.pageEntityName,r));});return A;}function d(C,o){var s=H.getInstance().getHash().split("?")[0];var r=s&&s.substr(0,s.indexOf("("));if(r.indexOf("/")===0){r=r.substring(1);}var E=C.getModel().getMetaModel().getObject("/"+r);var p=C;var A=b(C,o,E);if(A.length>0){return Promise.all(A).then(function(D){var k=[];var P=E;if(D[0].indexOf("/")===0){k.push(D[0].substring(1));}else{k.push(D[0]);}for(var i=1;i<D.length;i++){var l=D[i];var n="";var m=l&&l.substr(0,l.indexOf("("));if(m.indexOf("/")===0){m=m.substring(1);}if(l.indexOf("/")===0){l=l.substring(1);}n=Object.keys(P.$NavigationPropertyBinding)[Object.values(P.$NavigationPropertyBinding).indexOf(m)];if(n){k.push(l.replace(m,n));P=p.getModel().getMetaModel().getObject("/"+m)||E;}else{k.push(l);}}return k;}).catch(function(i){L.info("Failed to retrieve one or more active context path's",i);});}else{return Promise.resolve();}}function f(C,o){var p,s;var i=H.getInstance().getHash().split("?")[0];if(C){var m=C.getModel();var k=m.getMetaModel();I=M.isStickySessionSupported(k);var r=i&&i.substr(0,i.indexOf("("));if(r.indexOf("/")===0){r=r.substring(1);}s=S.getSemanticKeys(k,r);}var v=o.getView().getViewData();if(C&&!I&&((v.viewLevel===1&&!s)||v.viewLevel>=2)){p=d(C,o);return p;}else{return Promise.resolve();}}function h(e,I,A){var s;var i=H.getInstance().getHash();var B=H.getInstance().hrefForAppSpecificHash?H.getInstance().hrefForAppSpecificHash(""):"";if(e==="Editable"&&!I&&A){s=B+A.join("/");}else{s=i?B+i:window.location.hash;}return s;}function j(e,I,A){var J;var s=H.getInstance().getHash();var B=H.getInstance().hrefForAppSpecificHash?H.getInstance().hrefForAppSpecificHash(""):"";if(e==="Editable"&&!I&&A){J=B+A.join("/");}else{J=s?B+s:window.location.hash;}if(sap.ushell&&sap.ushell.Container&&sap.ushell.Container.runningInIframe&&sap.ushell.Container.runningInIframe()){sap.ushell.Container.getFLPUrl(true).then(function(U){return U.substr(0,U.indexOf("#"))+J;}).catch(function(E){L.error("Could not retrieve cFLP URL for the sharing dialog (dialog will not be opened)",E);});}else{return Promise.resolve(window.location.origin+window.location.pathname+J);}}return{adaptShareMetadata:function(s){var t=this;var C=this.base.getView().getBindingContext();u=this.base.getView().getModel("ui");e=u.getProperty("/editMode");return f(C,t.base.getView().getController()).then(function(A){var p=[];p.push(t.base.getView().getController()._getPageTitleInformation());p.push(j(e,I,A));return Promise.all(p).then(function(D){var P=D[0];var J=D[1];var T=P.title;var o=P.subtitle.toString();if(o){T=T+" - "+o;}s.tile={title:P.title,subtitle:P.subtitle.toString()};s.email.title=T;s.title=T;s.url=h(e,I,A);s.jam.url=J;return s;});});}};});
