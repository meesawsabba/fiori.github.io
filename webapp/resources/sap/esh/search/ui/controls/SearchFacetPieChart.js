/*!
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	
 */
sap.ui.define(["../i18n","sap/ui/thirdparty/d3"],function(f,g){"use strict";return sap.ui.core.Control.extend("sap.esh.search.ui.controls.SearchFacetPieChart",{setEshRole:function(){},metadata:{properties:{oSearchFacetDialog:{},},aggregations:{items:{type:"sap.esh.search.ui.FacetItem",multiple:true,},},},renderer:function(R,C){R.write("<div");R.write(' role="figure" ');R.writeControlData(C);R.writeClasses();R.write(">");var h=function(){if(navigator.appName==="Microsoft Internet Explorer"){return true;}return false;};var P=function(){this.init.apply(this,arguments);};P.Labelposition=(function(){var a=function(){this.init.apply(this,arguments);};a.prototype={init:function(b,c,s,e,r,d,i,j,t,k){this.backgroundWidth=b;this.backgroundHeight=c;this.startAngle=s;this.endAngle=e;this.r=r;this.labelPaddingX=3;this.labelPaddingY=3;this.radiusPadding=4.24;this.labelWidth=d+2*this.labelPaddingX;this.labelHeight=i;this.outsetMin=0.3;this.outsetMax=1.2;this.outsetStep=0.025;this.apexAngle=e-s;this.startLabelWidth=this.labelWidth;this.d3centroid=j;this.text=t;this.svgBackground=k;this.debug=false;this.labelHeight=this.labelHeight+2*this.labelPaddingY;var x=Math.round(this.backgroundWidth/2);var y=Math.round(this.backgroundHeight/2);this.translateStr="translate("+x+","+y+")";},update:function(){var o=Math.max(this.outsetMin,((Math.sin(this.apexAngle/2)/(this.apexAngle/2))*2)/3);var p=true;var i=Math.max(100,this.labelWidth*2,1/this.outsetStep);var b=0;var c;do{p=true;c=this.calc(o,this.labelWidth,this.labelHeight);if(o>this.outsetMax||o<this.outsetMin){break;}if(this.labelWidth<0){break;}var d,e,j,k;if(b===0){d=this.calc(o+this.outsetStep,this.labelWidth,this.labelHeight);e=this.calc(o-this.outsetStep,this.labelWidth,this.labelHeight);j=this.value(d,c);k=this.value(e,c);if(j<k&&k>0.5){b=-1;o+=this.outsetStep*b;p=false;}else if(j>0.5||c.labelWidth<=0){b=1;o+=this.outsetStep*b;p=false;}}else{d=this.calc(o+this.outsetStep*b,this.labelWidth,this.labelHeight);j=this.value(d,c);if(j>0.5||c.labelWidth<=0){o+=this.outsetStep*b;p=false;}}i--;}while(!p&&i>0&&!isNaN(o));c=this.calc(o,this.labelWidth,this.labelHeight);this.labelWidth=c.labelWidth;var x=c.x;var y=c.y;this.svgBackground.select("circle.centroid").remove();if(this.debug){this.svgBackground.append("svg:circle").attr("class","centroid").attr("cx",c.centroidX).attr("cy",c.centroidY).attr("r",2).style("fill","blue");}this.svgBackground.selectAll("line.helper").remove();if(this.debug){this.svgBackground.append("svg:line").attr("class","helper helper2").attr("x1",-this.backgroundWidth/2).attr("x2",this.backgroundWidth/2).attr("y1",y-this.labelHeight/2).attr("y2",y-this.labelHeight/2);this.svgBackground.append("svg:line").attr("class","helper helper2").attr("x1",-this.backgroundWidth/2).attr("x2",this.backgroundWidth/2).attr("y1",y+this.labelHeight/2).attr("y2",y+this.labelHeight/2);this.svgBackground.append("svg:line").attr("class","helper").attr("x1",0).attr("y1",0).attr("x2",Math.sin(this.startAngle)*(this.r+this.radiusPadding)).attr("y2",-Math.cos(this.startAngle)*(this.r+this.radiusPadding));this.svgBackground.append("svg:line").attr("class","helper").attr("x1",0).attr("y1",0).attr("x2",Math.sin(this.endAngle)*(this.r+this.radiusPadding)).attr("y2",-Math.cos(this.endAngle)*(this.r+this.radiusPadding));this.svgBackground.append("svg:line").attr("class","helper").attr("x1",Math.sin(this.startAngle)*(this.r+this.radiusPadding)).attr("y1",-Math.cos(this.startAngle)*(this.r+this.radiusPadding)).attr("x2",this.isStartAngleOnRight()?this.backgroundWidth/2:-this.backgroundWidth/2).attr("y2",-Math.cos(this.startAngle)*(this.r+this.radiusPadding));this.svgBackground.append("svg:line").attr("class","helper").attr("x1",Math.sin(this.endAngle)*(this.r+this.radiusPadding)).attr("y1",-Math.cos(this.endAngle)*(this.r+this.radiusPadding)).attr("x2",this.isEndAngleOnRight()?this.backgroundWidth/2:-this.backgroundWidth/2).attr("y2",-Math.cos(this.endAngle)*(this.r+this.radiusPadding));}if(this.labelWidth<2*this.labelPaddingX){this.labelWidth=0;}else if(this.labelWidth<this.startLabelWidth){this.labelWidth=this.labelWidth-2*this.labelPaddingX;}this.x=isNaN(x)?0:x;this.y=isNaN(x)?0:y;},calc:function(o,b){var c,d,e,r,p,i;if(this.startAngle-this.endAngle+2*Math.PI<1e-9){c=0;d=0;r=this.backgroundWidth/2;e=-this.backgroundWidth/2;i=-this.r;p=this.r;}else{c=Math.sin(this.apexAngle/2)*this.r*o;d=Math.cos(this.apexAngle/2)*-this.r*o;var t=c*Math.cos(this.startAngle)-d*Math.sin(this.startAngle);d=c*Math.sin(this.startAngle)+d*Math.cos(this.startAngle);c=t;var u=d-this.labelHeight/2;var j=d+this.labelHeight/2;e=Math.max(this.calcLeftBorder(c,u),this.calcLeftBorder(c,j),-this.backgroundWidth/2);if(Math.abs(this.startAngle-(this.endAngle%(2*Math.PI)))>1e-9&&c>0&&u<=0&&j>=0){e=Math.max(e,0);}if(!this.doesFitHeight(e,u,j,c<0,true)){e=this.backgroundWidth/2;}r=Math.min(this.calcRightBorder(c,u),this.calcRightBorder(c,j),this.backgroundWidth/2);if(Math.abs(this.startAngle-(this.endAngle%(2*Math.PI)))>1e-9&&c<0&&u<=0&&j>=0){r=Math.min(r,0);}if(!this.doesFitHeight(r,u,j,c<0,false)){r=-this.backgroundWidth/2;}var k=this.calcPerimeterBorder(1,d-this.labelHeight/2);if(k<c){k=this.backgroundWidth/2;}var m=this.calcPerimeterBorder(1,d+this.labelHeight/2);if(m<c){m=this.backgroundWidth/2;}p=Math.min(k,m,r);var n=this.calcPerimeterBorder(-1,d-this.labelHeight/2);if(n>c){n=-this.backgroundWidth/2;}var q=this.calcPerimeterBorder(-1,d+this.labelHeight/2);if(q>c){q=-this.backgroundWidth/2;}i=Math.max(n,q,e);if(isNaN(p)){p=r;}if(isNaN(i)){i=e;}}this.svgBackground.select("line.left").remove();this.svgBackground.select("line.right").remove();this.svgBackground.select("line.perimeterLeft").remove();this.svgBackground.select("line.perimeterRight").remove();if(this.debug){this.svgBackground.append("svg:line").attr("class","left").attr("y1",-this.backgroundHeight/2).attr("y2",this.backgroundHeight/2).attr("x1",e).attr("x2",e);this.svgBackground.append("svg:line").attr("class","right").attr("y1",-this.backgroundHeight/2).attr("y2",this.backgroundHeight/2).attr("x1",r).attr("x2",r);this.svgBackground.append("svg:line").attr("class","perimeterLeft").attr("y1",-this.backgroundHeight/2).attr("y2",this.backgroundHeight/2).attr("x1",i).attr("x2",i);this.svgBackground.append("svg:line").attr("class","perimeterRight").attr("y1",-this.backgroundHeight/2).attr("y2",this.backgroundHeight/2).attr("x1",p).attr("x2",p);}var s=b;b=Math.min(b,Math.floor(r-e));var x=c;x=Math.max(x,i+b/2);x=Math.min(x,p-b/2);if(x-b/2<i-1e-9||x+b/2>p+1e-9){x=(i+p)/2;}if(c>=0){x=Math.max(x,e+b/2);x=Math.min(x,r-b/2);}else{x=Math.min(x,r-b/2);x=Math.max(x,e-b/2);}var y=d;return{x:x,y:y,labelWidth:b,labelShortened:b!==s,xSpace:r-e,centroidX:c,centroidY:d,asymmetry:Math.abs(x-c),};},value:function(c,b){if(c.labelWidth<0){return-10000;}if(c.labelWidth<b.labelWidth){return-100;}if(c.labelWidth>b.labelWidth){return(c.labelWidth-b.labelWidth)*1000;}if(b.labelShortened&&c.labelWidth===b.labelWidth){return(c.xSpace-b.xSpace)*100;}return 0;},doesFitHeight:function(b,u,c,i,d){var y=-Math.cos(this.startAngle)*(this.r+this.radiusPadding);var e=-Math.cos(this.endAngle)*(this.r+this.radiusPadding);if(Math.abs(this.startAngle-(this.endAngle%(2*Math.PI)))<1e-9){y=-this.backgroundHeight/2;e=this.backgroundHeight/2;}else if(b===0){y=-this.backgroundHeight/2;e=this.backgroundHeight/2;}else if(b>0){if(!this.isStartAngleOnRight()){y=-this.backgroundHeight/2;}else if(b<=Math.sin(this.startAngle)*(this.r+this.radiusPadding)){y=b/-Math.tan(this.startAngle);}if(!this.isEndAngleOnRight()){e=this.backgroundHeight/2;}else if(b<=Math.sin(this.endAngle)*(this.r+this.radiusPadding)){e=b/-Math.tan(this.endAngle);}if(i&&!d&&y>=c){y=-this.backgroundHeight/2;}if(i&&!d&&e<=u){e=this.backgroundHeight/2;}}else{if(this.isStartAngleOnRight()){y=this.backgroundHeight/2;}else if(b>Math.sin(this.startAngle)*(this.r+this.radiusPadding)){y=b/-Math.tan(this.startAngle);}if(this.isEndAngleOnRight()){e=-this.backgroundHeight/2;}else if(b>Math.sin(this.endAngle)*(this.r+this.radiusPadding)){e=b/-Math.tan(this.endAngle);}if(!i&&d&&e>=c){e=-this.backgroundHeight/2;}if(!i&&d&&y<=u){y=this.backgroundHeight/2;}}if(!d){this.svgBackground.selectAll(".rightBorder").remove();if(this.debug){this.svgBackground.append("svg:rect").attr("class","rightBorder").attr("x",b-3).attr("y",y-3).attr("width",6).attr("height",6).style("fill","green");this.svgBackground.append("svg:circle").attr("class","rightBorder").attr("cx",b).attr("cy",e).attr("this.r",3).style("fill","green");}}else{this.svgBackground.selectAll(".leftBorder").remove();if(this.debug){this.svgBackground.append("svg:rect").attr("class","leftBorder").attr("x",b-3).attr("y",y-3).attr("width",6).attr("height",6).style("fill","red");this.svgBackground.append("svg:circle").attr("class","leftBorder").attr("cx",b).attr("cy",e).attr("this.r",3).style("fill","red");}}return u>=Math.min(y,e)-1e-9&&c<=Math.max(y,e)+1e-9;},calcLeftBorder:function(x,y){var b=-this.backgroundWidth/2;if(Math.abs(this.startAngle-(this.endAngle%(2*Math.PI)))<1e-9){return b;}if(y<=0){if(y>-Math.cos(this.startAngle)*(this.r+this.radiusPadding)){b=Math.tan(this.startAngle)*-y;}}else if(y<-Math.cos(this.endAngle)*(this.r+this.radiusPadding)){b=Math.tan(this.endAngle)*-y;}return b;},calcRightBorder:function(x,y){var b=this.backgroundWidth/2;if(Math.abs(this.startAngle-(this.endAngle%(2*Math.PI)))<1e-9){return b;}if(y>=0){if(-y>Math.cos(this.startAngle)*(this.r+this.radiusPadding)){b=Math.tan(this.startAngle)*-y;}}else if(-y<Math.cos(this.endAngle)*(this.r+this.radiusPadding)){b=Math.tan(this.endAngle)*-y;}return b;},calcPerimeterBorder:function(x,y){var b=x>0?this.backgroundWidth/2:-this.backgroundWidth/2;b=Math.sqrt(this.r*this.r-y*y);if(x<0){b*=-1;}return b;},isStartAngleOnRight:function(){return this.startAngle>0&&this.startAngle<=((2*Math.PI)/360)*180;},isEndAngleOnRight:function(){return this.endAngle%(2*Math.PI)<((2*Math.PI)/360)*180;},};return a;})();P.Tweens=(function(){var T={};T.tweenGenSimple=function(d,i,a,b,o,s){var c={startAngle:d.oldArc.startAngle,endAngle:d.oldArc.endAngle,innerRadius:b,outerRadius:o,};var e={startAngle:d.startAngle,endAngle:d.endAngle,innerRadius:b,outerRadius:o,};var j=g.interpolate(c,e);return function(t){return s(j(t));};};T.tweenGenSimpleText=function(d,i,a,b,o,c,e){var k=" ";if(d.labelElement.childNodes[1]&&d.labelElement.childNodes[1].childNodes[0]&&d.labelElement.childNodes[1].childNodes[0].data){k=d.labelElement.childNodes[1].childNodes[0].data;}var m=new P.Labelposition(c.options.width,c.options.height,d.oldArc.startAngle,d.oldArc.endAngle,c.options.outerRadius,d.labelElement.childNodes[1].getBBox().width,d.labelElement.childNodes[1].getBBox().height,c.svgArcGen(d).centroid(d),k,c.svg);m.update();var n=[m.x,m.y];var p=new P.Labelposition(c.options.width,c.options.height,d.startAngle,d.endAngle,c.options.outerRadius,d.labelElement.childNodes[1].getBBox().width,d.labelElement.childNodes[1].getBBox().height,c.svgArcGen(d).centroid(d),k,c.svg);p.update();if(p.labelWidth<d.labelElement.childNodes[1].getBBox().width){c.adjustLabelWidth(d.labelElement,p.labelWidth);}var q=[p.x,p.y];var j=g.interpolateArray(n,q);var r=function(s){var t;if(e){t=T.translateStr4Padding(d.startAngle,d.endAngle,c.options.padding4click,s[0],s[1]);}else{t="translate("+s+")";}return t;};return function(t){return r(j(t));};};T.translateStr4Padding=function(s,e,p,x,y){var a=e-s;var b=p*Math.sin(a/2);var c=-(p*Math.cos(a/2));var t=b*Math.cos(s)-c*Math.sin(s);c=b*Math.sin(s)+c*Math.cos(s);b=t;var d="translate("+(x+b)+", "+(y+c)+")";return d;};T.tweenGenEcstasy=function(d,i,a,b,o,s){var c=Math.round((b+o)/2);var e;var j;if(i%2){e=o;j=c;}else{e=c;j=b;}var k={startAngle:d.oldArc.startAngle,endAngle:d.oldArc.endAngle,innerRadius:b,outerRadius:o,};var m={startAngle:d.oldArc.startAngle,endAngle:d.oldArc.endAngle,innerRadius:j,outerRadius:e,};var n=g.interpolate(k,m);k={startAngle:d.oldArc.startAngle,endAngle:d.oldArc.endAngle,innerRadius:j,outerRadius:e,};m={startAngle:d.startAngle,endAngle:d.endAngle,innerRadius:j,outerRadius:e,};var r=g.interpolate(k,m);k={startAngle:d.startAngle,endAngle:d.endAngle,innerRadius:j,outerRadius:e,};m={startAngle:d.startAngle,endAngle:d.endAngle,innerRadius:b,outerRadius:o,};var u=g.interpolate(k,m);return function(t){if(t<=0.25){return s(n(t*4));}if(t<=0.75){return s(r((t-0.25)*2));}return s(u((t-0.75)*4));};};T.tweenGenLSD=function(d,i,a,b,o,s){var c=Math.round((b+o)/2);var e;var j;if(i%2){e=o;j=c;}else{e=c;j=b;}var k={startAngle:d.oldArc.startAngle,endAngle:d.oldArc.endAngle,innerRadius:b,outerRadius:o,};var m={startAngle:d.oldArc.startAngle,endAngle:d.oldArc.endAngle,innerRadius:j,outerRadius:e,};var n=g.interpolate(k,m);k={startAngle:d.oldArc.startAngle,endAngle:d.oldArc.endAngle,innerRadius:j,outerRadius:e,};m={startAngle:d.startAngle,endAngle:d.startAngle+(d.oldArc.endAngle-d.oldArc.startAngle),innerRadius:j,outerRadius:e,};var p=g.interpolate(k,m);k={startAngle:d.startAngle,endAngle:d.startAngle+(d.oldArc.endAngle-d.oldArc.startAngle),innerRadius:j,outerRadius:e,};m={startAngle:d.startAngle,endAngle:d.endAngle,innerRadius:j,outerRadius:e,};var r=g.interpolate(k,m);k={startAngle:d.startAngle,endAngle:d.endAngle,innerRadius:j,outerRadius:e,};m={startAngle:d.startAngle,endAngle:d.endAngle,innerRadius:b,outerRadius:o,};var u=g.interpolate(k,m);return function(t){if(t<=0.25){return s(n(t*4));}if(t<=0.5){return s(p((t-0.25)*4));}if(t<=0.75){return s(r((t-0.5)*4));}return s(u((t-0.75)*4));};};return T;})();var l={};l.debug=function(){};P.prototype={init:function(p,o,a,m){this.application=a;this.parent=p;this.model=m;this.chartElements=[];var b=g.select(p);var s=$(p).innerHeight();var c=$(p).innerWidth();if(o.height>s){s=o.height;}var r=Math.min(c,s)/2;this.options={"dimension-pie":"YEAR",backgroundWidth:c,backgroundHeight:s,width:c,height:s,innerRadius:0,outerRadius:r*0.8,tweenGen:P.Tweens.tweenGenSimple,tweenGenText:P.Tweens.tweenGenSimpleText,arcCalculator:P.generateHistoricalArcCalculator(),animationduration:1500,labelHideThreshold:0.05,easing:"linear",pieChartClass:"sap-piechart",pieChartParentClass:"sapUshellSearchFacetPieChart",color:"blue",strokewidth:1,strokewidthHover:3,padding4click:7,multipleselectable:true,oSearchFacetDialog:null,};if(o){for(var d in o){this.options[d]=o[d];}}this.createAttributeService(P,"innerRadius",function(){this.init();});this.createAttributeService(P,"outerRadius",function(){this.init();});this.createAttributeService(P,"tweenGen",function(){this.init();});this.createAttributeService(P,"tweenGenText",function(){this.init();});this.createAttributeService(P,"width",function(){this.init();});this.createAttributeService(P,"height",function(){this.init();});this.createAttributeService(P,"animationduration");this.createAttributeService(P,"labelHideThreshold");this.createAttributeService(P,"arcCalculator");var x=Math.round(this.options.width/2);var y=Math.round(this.options.height/2);this.svg=b.append("svg:svg").attr("width",c).attr("height",s).attr("id",p.id+"_svg").append("svg:g").attr("transform","translate("+x+","+y+")");this.svgArcs=this.svg.append("svg:g");this.svgLabels=this.svg.append("svg:g");this.svg.attr("class",this.options.pieChartClass);this.inittween();this.oldArcs=[];this.clickedSegment={};this.firstUpdate=true;},getParent:function(){return this.parent;},createAttributeService:function(c,a,i){c.prototype[a]=function(v){if(v===null){return this.options[a];}this.options[a]=v;if(i){i.call(this);}return this;};},inittween:function(){var t=this;t.xOrigin=Math.round(t.options.width/2);t.yOrigin=Math.round(t.options.height/2);t.svg.attr("width",this.options.width).attr("height",this.options.height);this.tweenGenArc=function(d,i,a){return t.options.tweenGen(d,i,a,t.options.innerRadius,t.options.outerRadius,t.svgArcGen(d));};this.tweenGenText=function(d,i,a,b){return t.options.tweenGenText(d,i,a,t.options.innerRadius,t.options.outerRadius,t,b);};},update:function(d){this.notAnimatedUpdate(d);},notAnimatedUpdate:function(a){var t=this;var b=[];if(!a){return;}this.chartElements=a;t.svgArcs.selectAll("path").remove();t.svgLabels.selectAll("g").remove();var c=0;for(var i=0;i<a.length;++i){c+=a[i].value;}for(var j=0;j<a.length;++j){a[j].percentage=a[j].value/c;}b=this.options.arcCalculator.calculateNewArcsOnly(a);var s=this.svgArcs.selectAll("path").data(b,P.getIdOfArc);if(!s.exit().empty()){s.exit().remove();}if(!s.empty()){s.attr("d",function(d){var p=t.svgArcGen(d);return p(d);}).attr("transform",function(d){var e;if(d.data.selected){e=P.translateStr4Padding(d.startAngle,d.endAngle,t.options.padding4click,0,0);}else{e="translate(0,0)";}return e;}).style("stroke",function(d){var e;if(d.data.stroke==="none"){e=d.data.stroke;}else if(d.data.selected||d.data.hovered){e="#dadada";}else{e="white";}return e;}).style("stroke-width",function(d){var e;if(d.data.selected||d.data.hovered){e=t.options.strokewidthHover;}else{e=t.options.strokewidth;}return e;}).style("opacity",function(d){var o;if(d.data.selected||d.data.hovered){o="1";}else if(d.data.initial){o="0.75";}else{o="0.5";}return o;}).each(function(d){while(this.hasChildNodes()){this.removeChild(this.lastChild);}g.select(this).append("svg:title").text(""+d.data.tooltip);});}s.enter().append("svg:path").attr("transform",function(d){var e;if(d.data.selected){t.clickedSegment[d.data.id]=this;e=P.translateStr4Padding(d.startAngle,d.endAngle,t.options.padding4click,0,0);}return e;}).attr("shape-rendering","geometricPrecision").attr("tabindex","0").style("stroke",function(d){var e;if(d.data.stroke==="none"){e=d.data.stroke;}else if(d.data.selected||d.data.hovered){e="#dadada";}else{e="white";}return e;}).style("stroke-width",function(d){var e;if(d.data.selected||d.data.hovered){e=t.options.strokewidthHover;}else{e=t.options.strokewidth;}return e;}).style("opacity",function(d){var o;if(d.data.selected||d.data.hovered){o="1";}else if(d.data.initial){o="0.75";}else{o="0.5";}return o;}).attr("fill",function(d){return d.data.fill;}).on("keydown",function(){var e=g.event;var d=e.keyCode||e.which;if(d==32){e.target.__onclick();}}).on("click",function(d,i){var e;if(d.data.click&&d.data.pieupdateuionly===false){var r=d.data.click(d,i);if(!t.options.multipleselectable&&!r){return;}}var m,n;var o;var p=t.getLabelElementtbyLabel(d.data.label);if(p){var q=" ";if(p.childNodes[1]&&p.childNodes[1].childNodes[0]&&p.childNodes[1].childNodes[0].data){q=p.childNodes[1].childNodes[0].data;}o=new P.Labelposition(t.options.width,t.options.height,d.startAngle,d.endAngle,t.options.outerRadius,p.childNodes[1].getBoundingClientRect().width,p.childNodes[1].getBoundingClientRect().height,t.svgArcGen(d).centroid(d),q,t.svg);o.update();if(o.labelWidth<p.childNodes[1].getBoundingClientRect().width){t.adjustLabelWidth(p,o.labelWidth);}}if(d.data.selected){if(!t.options.multipleselectable&&Object.keys(t.clickedSegment).length>0){delete t.clickedSegment[d.data.id];}m="translate(0,0)";if(p){n="translate("+o.x+","+o.y+")";}d.data.selected=false;if(t.options.oSearchFacetDialog){e={};e.cnt=t.getNumberOfClickedSegments();e.dataObject=d.data;t.options.oSearchFacetDialog.onDetailPageSelectionChangeCharts(e);}else{t.model.removeFilterCondition(d.data.filterCondition,true);}}else{if(!t.options.multipleselectable){if(Object.keys(t.clickedSegment).length>0){for(var u in t.clickedSegment){var v=t.clickedSegment[u];if(typeof v.__onclick==="function"){v.__data__.data.pieupdateuionly=true;v.__onclick.apply(v);}delete t.clickedSegment[u];}}if(Object.keys(t.clickedSegment).length<1){t.clickedSegment[d.data.id]=this;}}m=P.translateStr4Padding(d.startAngle,d.endAngle,t.options.padding4click,0,0);if(p){n=P.translateStr4Padding(d.startAngle,d.endAngle,t.options.padding4click,o.x,o.y);}d.data.selected=true;if(d.data.filterCondition){if(t.options.oSearchFacetDialog){e={};e.cnt=t.getNumberOfClickedSegments();e.dataObject=d.data;t.options.oSearchFacetDialog.onDetailPageSelectionChangeCharts(e);}else{t.model.addFilterCondition(d.data.filterCondition,true);}}}g.select(this).transition().duration(1000).ease(g.ease("elastic")).attr("transform",m).style("stroke",function(d){var x;if(d.data.stroke==="none"){x=d.data.stroke;}else if(d.data.selected){x="#dadada";}else{x="white";}return x;}).style("stroke-width",function(d){var x;if(d.data.selected){x=t.options.strokewidthHover;}else{x=t.options.strokewidth;}return x;}).style("opacity",function(d){var x;if(d.data.selected||d.data.hovered){x="1";}else if(d.data.initial){x="0.75";}else{x="0.5";}return x;});var w=t.getLabelElementtbyLabel(d.data.label);if(w){g.select(w).transition().duration(1000).ease(g.ease("elastic")).attr("transform",n);}}).on("mouseover",function(d,i){if(!t.options.multipleselectable&&Object.keys(t.clickedSegment).length>0){return;}if(d.data.selected||d.data.hovered){return;}if(d.data.mouseover){var r=d.data.mouseover(d,i);if(!t.options.multipleselectable&&!r){return;}}}).on("mouseout",function(d,i){if(d.data.selected){g.select(this).style("opacity",1);}if(!t.options.multipleselectable&&Object.keys(t.clickedSegment).length>0){return;}if(d.data.selected){return;}if(d.data.mouseout){var r=d.data.mouseout(d,i);if(!t.options.multipleselectable&&!r){return;}}}).attr("d",function(d){var p=t.svgArcGen(d);return p(d);}).append("svg:title").text(function(d){return""+d.data.tooltip;});s=t.svgLabels.selectAll("g").data(b,P.getIdOfArc);if(!s.exit().empty()){s.exit().remove();}if(!s.empty()){s.style("opacity",function(d){if(d.removed||d.data.percentage<t.options.labelHideThreshold){return 0;}return 1;}).attr("transform",function(d){var e;var m;if(this.childNodes[1]&&this.childNodes[1].childNodes[0]){m=new P.Labelposition(t.options.width,t.options.height,d.startAngle,d.endAngle,t.options.outerRadius,this.getBoundingClientRect().width,this.getBoundingClientRect().height,t.svgArcGen(d).centroid(d),d.data.label,t.svg);}else{m=new P.Labelposition(t.options.width,t.options.height,d.startAngle,d.endAngle,t.options.outerRadius,this.getBoundingClientRect().width,this.getBoundingClientRect().height,t.svgArcGen(d).centroid(d)," ",t.svg);}m.update();if(m.labelWidth<this.childNodes[1].getBoundingClientRect().width){t.adjustLabelWidth(this,m.labelWidth);}if(d.data.selected){e=P.translateStr4Padding(d.startAngle,d.endAngle,t.options.padding4click,m.x,m.y);}else{e="translate("+m.x+","+m.y+")";}return e;});}if(!s.enter().empty()){var k=s.enter().append("svg:g").style("opacity",0);k.append("svg:text").attr("class","labelshadow").attr("text-anchor","middle").text(function(d){return""+d.data.label;}).style("pointer-events","none");k.append("svg:text").attr("class","label").attr("text-anchor","middle").text(function(d){return""+d.data.label;}).style("pointer-events","none");k.style("opacity",function(d){if(d.removed||d.data.percentage<t.options.labelHideThreshold){return 0;}return 1;}).attr("transform",function(d){var e;var m=new P.Labelposition(t.options.width,t.options.height,d.startAngle,d.endAngle,t.options.outerRadius,this.getBoundingClientRect().width,this.getBoundingClientRect().height,t.svgArcGen(d).centroid(d),d.data.label,t.svg);m.update();if(m.labelWidth<this.childNodes[1].getBoundingClientRect().width){t.adjustLabelWidth(this,m.labelWidth);}if(d.data.selected){e=P.translateStr4Padding(d.startAngle,d.endAngle,t.options.padding4click,m.x,m.y);}else{e="translate("+m.x+","+m.y+")";}return e;});}t.oldArcs=P.removeDeletedArcs(b);},getNumberOfClickedSegments:function(){var c=0;var a=this.chartElements;for(var i=0;i<a.length;i++){if(a[i].selected===true){c++;}}return c;},adjustLabelWidth:function(e,t){var s=e.childNodes[0];var a=e.childNodes[1];if(t<=0){s.childNodes[0].data="";a.childNodes[0].data="";return;}var b=s.childNodes[0].data.length;s.childNodes[0].data+="...";var c="";while(s.getBBox().width>t){c=s.childNodes[0].data;c=c.substr(0,b-1)+c.substr(b,3);s.childNodes[0].data=c;b--;if(b<=0){s.childNodes[0].data="";break;}}a.childNodes[0].data=s.childNodes[0].data;},getArcsWithLabel:function(a){var t=this;var b=[];for(var i=0;i<a.length;++i){var c=a[i];if(c.data.percentage>t.options.labelHideThreshold){b.push(c);}}return b;},svgArcGen:function(){var t=this;var a=g.svg.arc().innerRadius(function(){return t.options.innerRadius;}).outerRadius(function(){return t.options.outerRadius;}).startAngle(function(d){return d.startAngle;}).endAngle(function(d){return d.endAngle;});return a;},getArcElementtbyLabel:function(a){var t=this;t.svgArcs.selectAll("g").each(function(d){if(d.data.label===a){t=this;}return;});return t;},getLabelElementtbyLabel:function(a){var t=this;t.svgLabels.selectAll("g").each(function(d){if(d.data.label===a){t=this;}});return t;},};P.removeDeletedArcs=function(a){var t=[];for(var i=0;i<a.length;++i){var b=a[i];if(!b.removed){t.push(b);}}return t;};P.createZeroArc=function(a,e){return{startAngle:a,endAngle:a,data:e,removed:true,};};P.insertAfter=function(a,i,b){var n;if(i>=0){var c=a[i];n=P.createZeroArc(c.endAngle,b.data);}else{n=P.createZeroArc(0,b.data);}n.oldArc=b;a.splice(i+1,0,n);};P.getIdOfArc=function(a){return a.data.id;};P.arcsGen=g.layout.pie().value(function(d){return d.value;}).sort(null);P.getIndexById=function(a,b){for(var i=0;i<a.length;++i){var c=a[i];if(P.getIdOfArc(c)===b){return i;}}return null;};P.add2arcSequence=function(d,a){if(h()){var b=function(x){a.getIndex(x.id);};d.forEach(b);}return d;};P.translateStr4Padding=function(s,e,p,x,y){var a=e-s;var b=p*Math.sin(a/2);var c=-(p*Math.cos(a/2));var t=b*Math.cos(s)-c*Math.sin(s);c=b*Math.sin(s)+c*Math.cos(s);b=t;var d="translate("+(x+b)+", "+(y+c)+")";return d;};P.Sequence=function(){this.init.apply(this,arguments);};P.Sequence.prototype={init:function(){this.maxIndex=0;this.objectMap={};},getIndex:function(o){var i=this.objectMap[o];if(typeof i!=="undefined"){return i;}i=this.maxIndex;this.maxIndex++;this.objectMap[o]=i;return i;},};P.generateDefaultArcCalculator=function(){return new P.DefaultArcCalculator();};P.DefaultArcCalculator=function(){this.init.apply(this,arguments);};P.DefaultArcCalculator.prototype={init:function(){this.arcSequence=new P.Sequence();},calculateNewArcsOnly:function(d){var t=this;d=d.slice();P.add2arcSequence(d,t.arcSequence);d.sort(function(a,b){return t.arcSequence.getIndex(a.id)-t.arcSequence.getIndex(b.id);});var n=P.arcsGen(d);return n;},calculateArcs:function(o,d){var n=P.arcsGen(d);this.insertMissingArcs(o,n,true);this.insertMissingArcs(n,o,false);return n;},insertMissingArcs:function(a,b,i){var c=-1;for(var d=0;d<b.length;++d){var e=b[d];var j=P.getIndexById(a,e.data.id);var k;if(j!==null){k=a[j];k.oldArc=e;c=j;continue;}else{if(i){c=this.determineInsertIndex(a,c,b,d);}var n;if(c>=0){var m=a[c];n=P.createZeroArc(m.endAngle,e.data);}else{n=P.createZeroArc(0,e.data);}n.oldArc=e;a.splice(c+1,0,n);c++;}}},determineInsertIndex:function(a,b,c,d){var e=c[d];var s=this.arcSequence.getIndex(e.data.id);var i;for(i=b+1;i<a.length;++i){var j=this.arcSequence.getIndex(a[i].data.id);if(j>s){break;}if(P.getIndexById(c,a[i].data.id)!==null){break;}}return i-1;},};P.generateHistoricalArcCalculator=function(){return new this.HistoricalArcCalculator();};P.HistoricalArcCalculator=function(){this.init.apply(this,arguments);};P.HistoricalArcCalculator.prototype={init:function(){this.arcSequence=new P.Sequence();},calculateNewArcsOnly:function(d){var t=this;d=d.slice();P.add2arcSequence(d,t.arcSequence);var n=P.arcsGen(d);return n;},calculateArcs:function(o,d){var t=this;d=d.slice();P.add2arcSequence(d,t.arcSequence);d.sort(function(a,b){return t.arcSequence.getIndex(a.id)-t.arcSequence.getIndex(b.id);});var n=P.arcsGen(d);this.insertMissingArcs(o,n);this.insertMissingArcs(n,o);return n;},insertMissingArcs:function(a,b){var t=this;var c=0;for(var d=0;d<b.length;++d){var e=b[d];var i=t.arcSequence.getIndex(e.data.id);var j;var k=false;for(;c<a.length;++c){j=a[c];var m=t.arcSequence.getIndex(j.data.id);if(m===i){k=true;break;}if(m>i){break;}}if(k){j.oldArc=e;}else{var n;if(c-1>=0&&c-1<a.length){var o=a[c-1];n=P.createZeroArc(o.endAngle,e.data);}else{n=P.createZeroArc(0,e.data);}a.splice(c,0,n);n.oldArc=e;}c++;}},};R.write("</div>");C.PieChart=P;},getFacetIndexById:function(c){var a=-1;var t=$("#"+c).parent().parent().parent().parent().parent()[0];var b=t.id;var d=$(".sapUshellSearchFacetIconTabBar");for(var i=0;i<d.length;i++){var e=d[i].id;if(e===b){a=i;break;}}return a;},getFacetIndexByIdForLargePieChart:function(c){var a=-1;var t=$("#"+c).parent().parent()[0];var b=t.id;var d=$(".searchFacetLargeChartContainer");for(var i=0;i<d.length;i++){var e=d[i].id;if(e===b){a=i;break;}}return a;},getPieChartIndexByFacetIndex:function(a){var s;var b=-1;var p=0;for(var i=0;i<a;i++){s=$($(".sapUshellSearchFacetIconTabBar")[i]).find(".sapMLIBContent")[1].firstChild.id;if(s.match(/pieChart/)!==null){p++;}}b=p;return b;},getSumSelected:function(d){var a;var b=0;if(d){for(var i=0;i<d.length;i++){if(d[i].facetType==="attribute"){for(var j=0;j<d[i].items.length;j++){a=d[i].items[j].value;if(a&&d[i].items[j].selected){b+=a;}}}}}return b;},getDataForPieChart:function(d,m,a){var r=[];var b=[];var c={};var e=0;var h=-1;var k="";var s=m.oData.count;var o=s;var p=0;this.iMissingCnt=0;for(var i=0;i<d.length;i++){if(d[i].facetType==="attribute"){h++;if(d[i].totalCount){o=d[i].totalCount;}b=[];p=0;for(var j=0;j<d[i].items.length;j++){c={};e=d[i].items[j].value;if(e){k=""+e;p+=e;c.filterCondition=d[i].items[j].filterCondition;c.dimension=d[i].items[j].facetTitle;c.label=d[i].items[j].label;c.selected=d[i].items[j].selected;c.filterLabel=d[i].items[j].label;c.id=d[i].items[j].label;c.value=e;c.valueLabel=d[i].items[j].valueLabel;if(k){c.tooltip=d[i].items[j].label+": "+e;}else{c.tooltip=d[i].items[j].label;}c.filtered=false;c.removed=false;c.fill="#007CAA";c.maxLabelLength=30;b.push(c);}else if(h===a){this.iMissingCnt++;}}var l=Math.round((p/o)*100);var n=100-l;if(n>0){if(n===100){n=99;}var q=(18*p)/350;var t=""+n;c={};c.filterCondition=null;c.dimension="";c.label=t;c.id="perc_missing";c.value=q;c.valueLabel=t;c.tooltip=f.getText("facetPieChartOverflowText",[t]);c.filtered=false;c.removed=false;c.fill="transparent";c.stroke="none";c.maxLabelLength=30;b.push(c);}r.push(b);}}return r;},getDataForPieChartLarge:function(d){var a=[];var i={};var b=0;var p=0;a=[];for(var j=0;j<d.length;j++){b=d[j].value;if(b){i={};p=p+b;i.filterCondition=d[j].filterCondition;i.dimension=d[j].facetAttribute;i.label=d[j].label;i.selected=d[j].selected;i.filterLabel=d[j].label;i.id=d[j].label;i.value=b;i.valueLabel=d[j].valueLabel;i.tooltip=d[j].label+"\t: "+b;i.filtered=false;i.removed=false;i.fill="#007CAA";i.maxLabelLength=30;a.push(i);}}return a;},directUpdate:function(d,p,m,o){var c,a,b;var e=[];var h=20;a=null;b=this.getModel();if(!b){b=this.oParent.getModel();}o.pieChartParentClass="sapUshellSearchFacetPieChartLarge";o.height=o.relevantContainerHeight;o.labelHideThreshold=0.000001;$(p).parent().parent().height(o.height);o.width=$(p).parent().parent().width();this.chartElements=this.getDataForPieChartLarge(d,m);c=new this.PieChart(p,o,a,b);for(var i=0;i<h;i++){if(this.chartElements[i]){e.push(this.chartElements[i]);}}c.update(e);},onAfterRendering:function(){var t=this;var d,c,a,m,b,p,e;var o={};if(typeof SVGElement.prototype.blur==="undefined"){SVGElement.prototype.blur=function(){};}b=null;m=this.getModel();if(!m){m=this.oParent.oModels.facets;}if(m){p=$("#"+this.sId)[0];if($(p).parent()[0].className==="sapMLIBContent"){o.pieChartParentClass="sapUshellSearchFacetPieChart";e=this.getFacetIndexById(this.sId);p.className=o.pieChartParentClass;d=this.getDataForPieChart(m.oData.facets,m,e);c=d[e];var A=c.map(function(j){return j.tooltip;});this.getDomRef().setAttribute("aria-label",A.join("; "));a=new this.PieChart(p,o,b,m);a.update(c);var i=$(this.getDomRef()).closest(".sapUshellSearchFacetIconTabBar").find(".sapUshellSearchFacetInfoZeile")[0];var I=sap.ui.getCore().byId(i.id);if(t.iMissingCnt>0){I.setVisible(true);var h=f.getText("infoZeileNumberMoreSelected",[t.iMissingCnt]);I.setText(h);I.rerender();}else{I.setVisible(false);}}else if($(p)[0].className==="largeChart2piechart"){$(p).attr("tabindex","0");}}},});});
