/*!
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/base/Log","sap/m/Button","sap/m/ButtonType","sap/ui/layout/HorizontalLayout","sap/ui/vbm/Container","sap/ui/vk/MapContainer","sap/ui/vk/ContainerContent","sap/ui/vbm/GeoMap","sap/ui/vbm/Containers","sap/ui/vbm/Spot","sap/ui/vbm/Spots",],function(L,B,a,H,C,M,b,G,c,S,d){"use strict";return sap.ui.core.Control.extend("sap.esh.search.ui.controls.SearchResultMap",{teststring:"",ContainerContent:null,MapContainer:null,minLat:0,minLon:0,maxLat:0,maxLon:0,centerLat:0,centerLon:0,iNrLocations:0,myMap:null,myMapContainer:null,metadata:{aggregations:{_map:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden",},},},init:function(){var t=this;var m={MapProvider:[{name:"OPENSTREETMAP",type:"",description:"",tileX:"256",tileY:"256",maxLOD:"19",copyright:"Â© openstreetmap",Source:[{id:"s1",url:"http://a.tile.openstreetmap.org/{LOD}/{X}/{Y}.png",},{id:"s2",url:"http://b.tile.openstreetmap.org/{LOD}/{X}/{Y}.png",},{id:"s3",url:"http://c.tile.openstreetmap.org/{LOD}/{X}/{Y}.png",},],},],MapLayerStacks:[{name:"DEFAULT",MapLayer:{name:"Open Street Map Layer",refMapProvider:"OPENSTREETMAP",opacity:"1",colBkgnd:"RGB(255,255,255)",},},],};try{t.MapContainer=M;t.ContainerContent=b;}catch(e){}t.geoMap=new G(this.getId()+"-sapUshellSearchGeoMap",{legendVisible:false,scaleVisible:false,refMapLayerStack:"DEFAULT",mapConfiguration:{parts:[{path:"/config/mapProvider"}],formatter:function(g){if(g!==undefined&&typeof g==="object"&&g.name&&g.name.length>0){m.MapProvider.push(g);m.MapLayerStacks[0].MapLayer.refMapProvider=g.name;}return m;},},});if(t.MapContainer&&t.ContainerContent){var f=new t.ContainerContent({content:t.geoMap,});this.myMapContainer=new t.MapContainer({content:[f],showRectangularZoom:true,showHome:true,showFullScreen:false,showSettings:false,showSelection:false,});t.myMap=t.myMapContainer.getContent()[0].getAggregation("content");t.setAggregation("_map",this.myMapContainer);}else{t.setAggregation("_map",t.geoMap);t.myMap=t.getAggregation("_map");}},renderer:function(r,o){o.loadObjects(o);r.write("<div ");r.writeControlData(o);r.addClass("sapUshellSearchResultMap");r.writeClasses();r.write(">");if(o.MapContainer){r.renderControl(o.myMapContainer);}else{r.renderControl(o.myMap);}r.write("</div>");},deg2rad:function(e){return(Math.PI*e)/180;},getSpotList:function(){var t=this;var s=new c();var r=t.getModel().oData.boResults;var n=0;var R,l,T,e,f,g,h,m,k,o,p,i;for(i=0;i<r.length;i++){R=r[i];l={};if(!R.geoJson){continue;}if(typeof R.geoJson.value==="string"){l=JSON.parse(R.geoJson.value);}else{l.coordinates=R.geoJson.value.coordinates;}T=R.geoJson.label;if(T==="LOC_4326"||T==="LOCATION"||T===undefined){T=R.title;}if(T==="LOC_4326"||T==="LOCATION"||T===undefined){for(var j=0;j<R.itemattributes.length;j++){if(R.itemattributes[j].isTitle===true){T=R.itemattributes[j].value;break;}}}if(T===undefined||typeof T!=="string"){T="unlabeled location";}else{T=T.replace(/<[^>]*>/g,"");}e=l.coordinates;if(!e||e.length===0){continue;}f=e[0];g=e[1];if(isNaN(g)||isNaN(f)){continue;}n++;if(n===1){m=f;k=f;o=g;p=g;}else{if(f<m){m=f;}if(f>k){k=f;}if(g<o){o=g;}if(g>p){p=g;}}t.minLon=m;t.maxLon=k;t.minLat=o;t.maxLat=p;var q=new B({text:T,});var u=new B({icon:"sap-icon://map",type:a.Emphasized,});var v=new H({content:[u,q],});h=new C({position:f+";"+g+";0",item:v,alignment:6,});s.addItem(h);}t.iNrLocations=n;if(n===0){s=t.getSpotList2();}return s;},getSpotList2:function(){var t=this;var r=t.getModel().oData.origBoResults.elements;var R,l,T,f,g,h,s;var i=new c();var n=0;var m,k,o,p;var q=0;for(var u in r){if(!Object.prototype.hasOwnProperty.call(r,u)){continue;}R=r[u];if(!R.LOC_4326){continue;}l=R.LOC_4326;for(var v in R){if(!Object.prototype.hasOwnProperty.call(R,v)){continue;}var A=R[v];T="";var w=false;if(A.$$MetaData$$){var x=A.$$MetaData$$.presentationUsage;if(x&&typeof x.length!=="undefined"){for(var j=0;j<x.length;j++){if(x[j]=="Title"){T=A.value;T=T.replace(/<[^>]*>/g,"");w=true;break;}}}}if(w){break;}}f=null;try{f=JSON.parse(l.value).coordinates;}catch(e){}if(!f||f.length===0){continue;}n++;g=f[0];h=f[1];if(isNaN(h)||isNaN(g)){continue;}q++;if(q===1){m=g;k=g;o=h;p=h;}else{if(g<m){m=g;}if(g>k){k=g;}if(h<o){o=h;}if(h>p){p=h;}}t.minLon=m;t.maxLon=k;t.minLat=o;t.maxLat=p;var y=new B({text:T,});var z=new B({icon:"sap-icon://map",type:a.Emphasized,});var D=new H({content:[z,y],});s=new C({position:g+";"+h+";0",item:D,alignment:6,});i.addItem(s);}t.iNrLocations=n;return i;},loadObjects:function(){var t=this;var s=t.getSpotList();L.debug("++++++");L.debug("number of locations: "+t.iNrLocations);t.myMap.removeAllVos();t.myMap.addVo(s);var p=t.getModel().config.parseUrlParameters();for(var e in p){if(e==="box"&&p[e]!=="false"){t.showBoundariesAndCenter();}}},setVisualFrame:function(){var t=this;var v={};v.minLon=t.minLon*0.5;v.maxLon=t.maxLon*1.2;v.minLat=t.minLat*0.8;v.maxLat=t.maxLat*1.2;t.myMap.setVisualFrame(v);},showBoundariesAndCenter:function(){var t=this;var e=new d({items:[new S({type:"Error",text:"center",position:t.centerLon+" ;  "+t.centerLat+";0",}),new S({type:"Error",text:"TLeft",position:t.minLon+" ;  "+t.maxLat+";0",}),new S({type:"Error",text:"TRight",position:t.maxLon+" ;  "+t.maxLat+";0",}),new S({type:"Error",text:"BLeft",position:t.minLon+" ;  "+t.minLat+";0",}),new S({type:"Error",text:"BRight",position:t.maxLon+" ;  "+t.minLat+";0",}),],});t.myMap.addVo(e);},resizeMap:function(){var h=$(".sapUshellSearchResultListsContainer").parent().parent().height();h=0.85*h;h=""+h+"px";var s=document.querySelectorAll('[id$="-sapUshellSearchGeoMap"]')[0].id;sap.ui.getCore().byId(s).setHeight(h);var w=$(".sapUshellSearchResultListsContainer").parent().parent().width();w=""+w+"px";sap.ui.getCore().byId(s).setWidth(w);},onAfterRendering:function(){var t=this;t.resizeMap();window.onresize=t.resizeMap;},});});
