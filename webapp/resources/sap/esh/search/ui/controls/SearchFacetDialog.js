/*!
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	
 */
sap.ui.define(["../i18n","sap/esh/search/ui/SearchHelper","sap/esh/search/ui/SearchFacetDialogHelper","sap/esh/search/ui/SearchFacetDialogHelper_SearchAdvancedCondition_ModuleLoader","sap/esh/search/ui/SearchFacetDialogHelperCharts","sap/esh/search/ui/controls/SearchAdvancedCondition","sap/esh/search/ui/FacetItem","sap/m/Dialog","sap/m/Select","sap/m/CheckBox","sap/m/SearchField","sap/m/ToggleButton","sap/m/Button","sap/m/ButtonType","sap/m/List","sap/m/ListMode","sap/m/ListSeparators","sap/m/StandardListItem","sap/m/Page","sap/m/SplitContainer","sap/ui/core/Item","sap/m/HBox","sap/m/VBox","sap/m/FlexAlignItems","sap/m/FlexJustifyContent","sap/m/BackgroundDesign","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/ScrollContainer","sap/m/Toolbar","sap/m/IconTabBar","sap/m/IconTabFilter","sap/ui/model/json/JSONModel",],function(a,s,b,_,c,S,F,D,d,C,f,T,B,g,L,h,k,l,P,o,I,H,V,p,q,r,t,u,v,w,x,y,J){"use strict";D.extend("sap.esh.search.ui.controls.SearchFacetDialog",{constructor:function(e){var i=this;i.bConditionValidateError=false;i.bShowCharts=true;i.bOldPieChart=true;if(jQuery.sap.getUriParameters().mParams.newpie&&jQuery.sap.getUriParameters().get("newpie")!=="false"){i.bOldPieChart=false;}i.chartOnDisplayIndex=e.selectedTabBarIndex;i.facetOnDisplayIndex=0;i.chartOnDisplayIndexByFilterArray=[];i.aItemsForBarChart=[];i.tabBarItems=e.tabBarItems;i.searchFacetDialogHelperCharts=c;if(!i.tabBarItems){c.setDummyTabBarItems(i);}e=jQuery.extend({},{showHeader:false,horizontalScrolling:false,verticalScrolling:false,contentHeight:"35rem",beginButton:new B({text:a.getText("okDialogBtn"),type:g.Emphasized,press:function(E){i.onOkClick(E);i.close();i.destroy();},}),endButton:new B({text:a.getText("cancelDialogBtn"),press:function(E){i.onCancelClick(E);i.close();i.destroy();},}),content:[i.createContainer()],},e);i.selectedAttribute=e.selectedAttribute?e.selectedAttribute:"";delete e.selectedAttribute;delete e.selectedTabBarIndex;delete e.tabBarItems;D.prototype.constructor.apply(this,[e]);b.init(i);c.init(i);i.addStyleClass("sapUshellSearchFacetDialog");i.onSearchFieldLiveChange=s.delayedExecution(i.onSearchFieldLiveChange,1000);},renderer:"sap.m.DialogRenderer",createContainer:function(){var e=this;e.oSplitContainer=new o({masterPages:e.createMasterPages(),});e.oSplitContainer.bindAggregation("detailPages","/facetDialog",function(i,j){return e.createDetailPages(i,j);});e.oSplitContainer.addStyleClass("sapUshellSearchFacetDialogContainer");return e.oSplitContainer;},createMasterPages:function(){var e=this;var m=new L({mode:h.SingleSelectMaster,selectionChange:function(E){e.onMasterPageSelectionChange(E);},});m.addStyleClass("sapUshellSearchFacetDialogFacetList");m.bindAggregation("items","/facetDialog",function(){var i=new l({title:"{title}",counter:"{count}",visible:"{visible}",});return i;});var R=new B({icon:"sap-icon://clear-filter",tooltip:a.getText("resetFilterButton_tooltip"),type:"Transparent",enabled:false,press:function(E){e.resetAllFilters(E);},});R.addStyleClass("sapUshellSearchFacetDialogFilterResetButton");var M=new P({title:a.getText("filters"),headerContent:R,content:[m],}).addStyleClass("sapUshellSearchFacetDialogMasterContainer");M.addEventDelegate({onAfterRendering:function(){if(e.selectedAttribute){for(var i=0;i<m.getItems().length;i++){var A=m.getItems()[i];var E=A.getBindingContext().getObject();if(e.selectedAttribute===E.dimension){m.setSelectedItem(A);e.facetOnDisplayIndex=i;e.chartOnDisplayIndexByFilterArray.push(e.chartOnDisplayIndex);}else{var n=0;var G=A.getBindingContext().getModel().oData.facets;for(var j=0;j<G.length;j++){if(G[j].chartIndex&&G[j].dimension===E.dimension&&!isNaN(G[j].chartIndex)){n=G[j].chartIndex;}}e.chartOnDisplayIndexByFilterArray.push(n);}}}if(!m.getSelectedItem()){m.setSelectedItem(m.getItems()[0]);}var K=m.getSelectedItem();b.updateDetailPage(K,null,true);e.resetEnabledForFilterResetButton();},});var z=[M];return z;},resetAllFilters:function(){var e=$(".sapUshellSearchFacetDialogSettingsContainer").find(".sapMCbBg.sapMCbHoverable.sapMCbMark");if(e.length===1){var i=e[0].parentNode.id;var m=sap.ui.getCore().byId(i);m.setSelected(false);m.setEnabled(false);}var M=this.getModel();M.aFilters=[];b.bResetFilterIsActive=true;var n=b.getFacetList();var z=n.getItems();for(var j=0;j<z.length;j++){z[j].setCounter(0);}this.resetAdvancedConditionFilters();b.resetChartQueryFilters();b.updateDetailPage(n.getSelectedItem());this.resetEnabledForFilterResetButton();b.bResetFilterIsActive=false;},resetAdvancedConditionFilters:function(){var e=this;var A,m,n,z,E,G,j;var K=e.oSplitContainer.getDetailPages();for(var i=0;i<K.length;i++){var M=K[i];n=b.POS_ATTRIBUTE_LIST_CONTAINER;A=M.getContent()[n];if(A){for(j=A.getContent().length-2;j>0;j--){m=A.getContent()[j];E=m.getParent();G=m;E.removeContent(G);}}else{n=b.POS_ICONTABBAR;z=b.POS_TABBAR_CONDITION;A=M.getContent()[n].getItems()[z].getContent()[0];if(A){for(j=A.getContent().length-1;j>-1;j--){m=A.getContent()[j];if(m.getContent&&m.getContent()[1]){var N=m.getContent()[1].getContent()[1];var O=N.getValue();if(O&&(""+O).length>0){E=m.getParent();G=m;E.removeContent(G);}}}}}}},resetEnabledForFilterResetButton:function(e){var j=false;var m=0;var M=b.getFacetList();var n=M.getItems();for(var i=0;i<n.length;i++){m+=n[i].getCounter();}var z=this.getModel();if((z.aFilters&&z.aFilters.length>0)||e||m>0){j=true;}var A=$(".sapUshellSearchFacetDialogFilterResetButton")[0].id;var R=sap.ui.getCore().byId(A);R.setEnabled(j);},onMasterPageSelectionChange:function(e){var i=this;var j=e.mParameters.listItem;i.facetOnDisplayIndex=j.getParent().indexOfItem(j.getParent().getSelectedItem());i.setChartOnDisplayIndexForFacetListItem(i.facetOnDisplayIndex);var m=j.getParent().getModel();var n=j.getBindingContext().sPath;i.resetIcons(m,n,i);b.updateDetailPage(j);if(i.oSplitContainer.getMode()==="ShowHideMode"){i.oSplitContainer.hideMaster();}i.controlChartVisibility(i,i.chartOnDisplayIndex);},createDetailPages:function(i,e){var j=this;var m=e.oModel.getProperty(e.sPath).facetType;var n=e.oModel.getAttributeDataType(e.oModel.getProperty(e.sPath));var z=new d({items:[new I({text:a.getText("notSorted"),key:"notSorted",}),new I({text:a.getText("sortByCount"),key:"sortCount",}),new I({text:a.getText("sortByName"),key:"sortName",}),],selectedKey:n==="string"||n==="text"?"sortCount":"notSorted",change:function(d1){j.onSelectChange(d1);},}).addStyleClass("sapUshellSearchFacetDialogSettingsSelect");var A=new H({alignItems:p.End,justifyContent:q.End,items:[z],});var E=new C({text:a.getText("showSelectedOnTop"),enabled:false,select:function(d1){j.onCheckBoxSelect(d1);},});var G=new V({items:[A,E],}).addStyleClass("sapUshellSearchFacetDialogSettingsContainer");G.setVisible(false);var K=new L({backgroundDesign:r.Transparent,includeItemInSelection:true,showNoData:false,showSeparators:k.None,selectionChange:function(d1){j.onDetailPageSelectionChange(d1);},});K.addStyleClass("sapUshellSearchFacetDialogDetailPageList");K.addStyleClass("largeChart0");if(m==="attribute"){K.setMode(h.MultiSelect);}var M={path:"items",factory:function(i,e){var d1=e.oModel.getProperty(e.sPath);var e1=new l({title:"{label}",tooltip:a.getText("facetListTooltip",["{label}","{value}"]),info:"{valueLabel}",selected:"{selected}",});if(d1.selected){e.oModel.addFilter(d1);}return e1;},};if(n==="number"||n==="integer"){z.removeItem(2);}M.filters=new t("advanced",u.NE,true);K.bindAggregation("items",M);K.data("dataType",n);if(j.bShowCharts){K.addEventDelegate({onAfterRendering:function(d1){j.hideSelectively(d1,j,0);},});}var N,O,Q;O=c.getBarChartPlaceholder();O.addEventDelegate({onAfterRendering:function(d1){j.hideSelectively(d1,j,1);},});O.data("dataType",n);if(j.bOldPieChart){Q=c.getPieChartPlaceholder();}else{Q={};}Q.addEventDelegate({onAfterRendering:function(d1){j.hideSelectively(d1,j,2);},});if(j.bShowCharts&&(n==="string"||n==="text")){N=new v({height:"67.2%",horizontal:false,vertical:true,content:[K,O,Q],});}else{N=new v({height:"calc(100% - 0.25rem)",horizontal:false,vertical:true,content:[K],});}N.addStyleClass("sapUshellSearchFacetDialogDetailPageListContainer");N.addStyleClass("searchFacetLargeChartContainer");N.setBusyIndicatorDelay(0);var R=new S({type:n,});var U;if(n==="string"||n==="text"){var W=new v({horizontal:false,vertical:true,content:[R],});W.addStyleClass("sapUshellSearchFacetDialogDetailPageAdvancedContainer");var X=new B({icon:"sap-icon://add",type:g.Transparent,press:function(d1){j.onPlusButtonPress(d1,n);},});X.addStyleClass("sapUshellSearchFacetDialogDetailPageAdvancedContainerPlusButton");W.addContent(X);W.data("dataType",n);W.data("initial",true);N.setHeight("calc(100% - 0.25rem)");W.setHeight("100%");var Y=c.getDropDownButton(j);var Z=new w({content:[new f({placeholder:a.getText("filterPlaceholder"),liveChange:function(d1){j.onSearchFieldLiveChange(d1.oSource.getValue());},}),new T({icon:"sap-icon://sort",press:function(d1){j.onSettingButtonPress(d1);},}).addStyleClass("sapUshellSearchFacetDialogSortButton"),],}).addStyleClass("sapUshellSearchFacetDialogSubheaderToolbar");Z.addEventDelegate({onAfterRendering:function(){$(".sapUshellSearchFacetDialogSubheaderToolbar").removeClass("sapContrastPlus");},});if(j.bShowCharts){Z.addContent(Y);}var a1=new P({showHeader:false,subHeader:Z,content:[G,N],}).addStyleClass("sapUshellSearchFacetDialogDetailPage");var b1=new x({expandable:false,stretchContentHeight:true,backgroundDesign:r.Transparent,applyContentPadding:false,select:function(){j.controlChartVisibility(j,j.chartOnDisplayIndex);},items:[new y({text:a.getText("selectFromList"),content:[a1],}),new y({text:a.getText("defineCondition"),content:[W],}),],});b1.addStyleClass("sapUshellSearchFacetDialogIconTabBar");U=new P({showHeader:true,title:e.oModel.getProperty(e.sPath).title,content:[b1],});U.addStyleClass("sapUshellSearchFacetDialogDetailPageString");}else{N.addContent(R);N.data("dataType",n);N.data("initial",true);if(j.bShowCharts){var c1=e.oModel.getProperty(e.sPath).title;U=new P({title:c1,showHeader:true,content:[G,N],});}else{U=new P({showHeader:true,title:e.oModel.getProperty(e.sPath).title,content:[G,N],});}U.addStyleClass("sapUshellSearchFacetDialogDetailPage");}U.addEventDelegate({onAfterRendering:function(){j.controlChartVisibility(j,j.chartOnDisplayIndex);},});return U;},onDetailPageSelectionChange:function(e){var i=this;var j=e.mParameters.listItem;var m=j.getBindingContext().getObject();if(j.getSelected()){m.listed=true;i.getModel().addFilter(m);}else{m.listed=false;i.getModel().removeFilter(m);}var n=e.oSource;var z;if(n.data("dataType")==="string"||n.data("dataType")==="text"){z=n.getParent().getParent().getParent().getParent().getParent().getParent();}else{z=n.getParent().getParent();}b.updateCountInfo(z);var A=n.getParent().getParent().getContent()[b.POS_SETTING_CONTAINER];var E=A.getItems()[b.POS_SHOWONTOP_CHECKBOX];var G=A.getItems()[b.POS_SORTING_SELECT].getItems()[0];if(E.getSelected()){E.setSelected(false);G.setSelectedKey("notSorted");}if(n.getSelectedContexts().length>0){E.setEnabled(true);}else{E.setEnabled(false);}},onSearchFieldLiveChange:function(e){var i=b.getFacetList().getSelectedItem();b.updateDetailPage(i,e);},onSettingButtonPress:function(e){var i=e.oSource.getPressed();var j=e.oSource.getParent().getParent().getContent()[b.POS_SETTING_CONTAINER];var m=e.oSource.getParent().getParent().getContent()[b.POS_ATTRIBUTE_LIST_CONTAINER];if(i){j.setVisible(true);m.setHeight("calc(100% - 4.25rem)");}else{j.setVisible(false);m.setHeight("calc(100% - 0.25rem)");}},onSelectChange:function(e){b.sortingAttributeList(e.oSource.getParent().getParent().getParent());},onCheckBoxSelect:function(e){b.sortingAttributeList(e.oSource.getParent().getParent());},onPlusButtonPress:function(e,i){var A=e.getSource().getParent();var n=new S({type:i,});var j=A.getAggregation("content").length-1;A.insertAggregation("content",n,j);},onOkClick:function(){var e=this;var M=e.getModel();var j=e.getModel("searchModel");j.resetFilterConditions(false);var n=e.oSplitContainer.getDetailPages();for(var m=0;m<M.aFilters.length;m++){var z=M.aFilters[m];if(!z.advanced||z.listed){j.addFilterCondition(z.filterCondition,false);}}for(var i=0;i<n.length;i++){if(b.getFacetList().getItems()[i]){b.applyAdvancedCondition(n[i],b.getFacetList().getItems()[i].getBindingContext().getObject(),j);}}if(!e.bConditionValidateError){j.filterChanged=true;j._firePerspectiveQuery();}j.eventLogger.logEvent({type:j.eventLogger.FACET_SHOW_MORE_CLOSE,});},onCancelClick:function(){var e=this.getModel("searchModel");e.eventLogger.logEvent({type:e.eventLogger.FACET_SHOW_MORE_CLOSE,});},setChartOnDisplayIndexForFacetListItem:function(i){var j=this;var m=0;try{m=j.chartOnDisplayIndexByFilterArray[i];}catch(e){m=0;}if(m===undefined){m=0;}j.chartOnDisplayIndex=m;},resetIcons:function(m,e,j){var n=this;var z=false;var A=m.getAttributeDataType(m.getProperty(e));if(n.bShowCharts&&(A==="string"||A==="text")){z=true;}var E=$(".sapUshellSearchFacetDialogTabBarButton");if(z){E.css("display","block");for(var i=0;i<E.length;i++){var G=E[i].id;var K=(sap.ui.getCore().byId(G));var M=j.tabBarItems[j.chartOnDisplayIndex].getIcon();K.setIcon(M);var N=j.tabBarItems[j.chartOnDisplayIndex].getText();var O=a.getText("displayAs",[N]);K.setTooltip(O);}}else{E.css("display","none");}},onDetailPageSelectionChangeCharts:function(e){var m=this;var n=0;var z,A,E,G,K,M,N,O,Q,R;var U,j,W,X,i,Y;if(e.getSource&&e.sId==="press"){z=e.getSource().getBindingContext();A=z.getModel();E=z.getObject();G=E.selected;K=!G;M=e.getSource();N=M.getBindingContext().sPath+"/selected";A.setProperty(N,K);O=M.getBindingContext().getObject();if(K){A.addFilter(O);}else{A.removeFilter(O);}Q=N.replace(/\/items.+/,"");Q+="/items";W=A.getProperty(Q);n=0;for(i=0;i<W.length;i++){X=W[i];if(X.selected===true){n++;}}}else if(e.getSource&&(e.sId==="selectData"||e.sId==="deselectData")){z=e.getSource().getBindingContext();A=z.getModel();E=z.getObject();K=e.sId==="selectData";M=e.getSource();N=M.getBindingContext().sPath+"/items/";for(j=0;j<e.getParameters().data.length;j++){U=e.getParameters().data[j].data._context_row_number;N+=U+"/selected";A.setProperty(N,K);O=M.getBindingContext().getObject().items[U];if(K){A.addFilter(O);}else{A.removeFilter(O);}}Q=N.replace(/\/items.+/,"");Q+="/items";W=A.getProperty(Q);n=0;for(i=0;i<W.length;i++){if(W[i].selected===true){n++;}}var Z=e.mParameters.data.length;if(!K&&Z>1){n=0;for(i=0;i<W.length;i++){W[i].selected=false;}}}else{E=e.dataObject;G=E.selected;K=!G;n=e.cnt;A=e.model;O=new F();O.facetAttribute=E.dimension;O.filterCondition=E.filterCondition;O.label=E.label;O.selected=E.selected;O.listed=E.selected;O.value=E.value;O.valueLabel=E.valueLabel;for(j=0;j<m.aItemsForBarChart.length;j++){var a1=m.aItemsForBarChart[j];if(a1.label===E.label){a1.selected=E.selected;}}if(G){m.getModel().addFilter(O);}else{m.getModel().removeFilter(O);}}R=b.getFacetList();Y=R.getSelectedItem();if(!Y){Y=R.getItems()[0];}Y.setCounter(n);this.resetEnabledForFilterResetButton();},updateDetailPageCharts:function(i){var e=this;if(e.bShowCharts===false){return;}e.aItemsForBarChart=i;var j=c.getListContainersForDetailPage();var m=j[1];var n=m.getContent();if(n&&e.chartOnDisplayIndex===2){var z=n[2];var A=j[5];var E=j[2];E=0.9*E;if(z.directUpdate){var G={};G.relevantContainerHeight=E;G.oSearchFacetDialog=e;var M=new J();M.setData(i);$("#"+A.id).empty();z.directUpdate(i,A,M,G);}}var K,N;if(n&&e.chartOnDisplayIndex===1){K=n[2].getDomRef();if(K){N=$("#"+K.id);N.css("display","none");}}if(n&&e.chartOnDisplayIndex===2){K=n[1].getDomRef();if(K){N=$("#"+K.id);N.css("display","none");}}},controlChartVisibility:function(e,j,m){var n=this;var z,A,E,G;if(n.bShowCharts===false)return;var K=e.searchFacetDialogHelperCharts.getListContainersForDetailPage();var M=K[1];if(!M||!M.getContent)return;var N=M.getContent();for(var i=0;i<N.length;i++){z=N[i].getDomRef();if(!z)return;E=z.className;G=false;if(E.indexOf("largeChart")>-1){G=true;}A=$("#"+z.id);if(G&&i!==j){A.css("display","none");}else{A.css("display","block");}}if(e.bOldPieChart){if(G&&j===2&&m){var O=n.aItemsForBarChart;var Q=n.getModel();n.updateDetailPageCharts(O,Q);}if(G&&j===2){M.setVertical(false);}else{M.setVertical(true);}}var R=K[6];var U=K[7];if(R){if(j===0){R.css("display","block");U.css("visibility","visible");}else{R.css("display","none");U.css("visibility","hidden");}}},hideSelectively:function(e,i,j){var m=$("#"+e.srcControl.sId);var n=i.chartOnDisplayIndex;var z=i.searchFacetDialogHelperCharts.getListContainersForDetailPage();var A=z[1];if(z[0].firstChild.children.length!=3)return;if(n!==undefined){if(i.chartOnDisplayIndex!==j){m.css("display","none");}else{m.css("display","block");}}else{m.css("display","block");}if(n===2){if(!z[0].firstChild.children[2]||!z[0].firstChild.children[2].firstChild){i.controlChartVisibility(i,i.chartOnDisplayIndex,true);}if(i.bOldPieChart){A.setVertical(false);}}else{A.setVertical(true);}var E=z[6];if(E){var G=$("#"+E.sId);if(n===0){G.css("display","block");}else{G.css("display","none");}}},});});
