/*! 
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	 
 */
(function(){var a=(this&&this.__awaiter)||function(t,_,P,g){function c(v){return v instanceof P?v:new P(function(r){r(v);});}return new(P||(P=Promise))(function(r,d){function f(v){try{s(g.next(v));}catch(e){d(e);}}function h(v){try{s(g["throw"](v));}catch(e){d(e);}}function s(e){e.done?r(e.value):c(e.value).then(f,h);}s((g=g.apply(t,_||[])).next());});};var b=(this&&this.__generator)||function(c,d){var _={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1];},trys:[],ops:[]},f,y,t,g;return g={next:h(0),"throw":h(1),"return":h(2)},typeof Symbol==="function"&&(g[Symbol.iterator]=function(){return this;}),g;function h(n){return function(v){return s([n,v]);};}function s(o){if(f)throw new TypeError("Generator is already executing.");while(_)try{if(f=1,y&&(t=o[0]&2?y["return"]:o[0]?y["throw"]||((t=y["return"])&&t.call(y),0):y.next)&&!(t=t.call(y,o[1])).done)return t;if(y=0,t)o=[o[0]&2,t.value];switch(o[0]){case 0:case 1:t=o;break;case 4:_.label++;return{value:o[1],done:false};case 5:_.label++;y=o[1];o=[0];continue;case 7:o=_.ops.pop();_.trys.pop();continue;default:if(!(t=_.trys,t=t.length>0&&t[t.length-1])&&(o[0]===6||o[0]===2)){_=0;continue;}if(o[0]===3&&(!t||(o[1]>t[0]&&o[1]<t[3]))){_.label=o[1];break;}if(o[0]===6&&_.label<t[1]){_.label=t[1];t=o;break;}if(t&&_.label<t[2]){_.label=t[2];_.ops.push(o);break;}if(t[2])_.ops.pop();_.trys.pop();continue;}o=d.call(c,_);}catch(e){o=[6,e];y=0;}finally{f=t=0;}if(o[0]&5)throw o[1];return{value:o[0]?o[1]:void 0,done:true};}};sap.ui.define(["require","exports","../../sina/SearchQuery","./typeConverter","../../sina/LogicalOperator","../../sina/ComparisonOperator","../../core/Log","../../core/errors","./HierarchyParser"],function(r,e,S,t,L,C,c,d,H){"use strict";Object.defineProperty(e,"__esModule",{value:true});e.FacetParser=void 0;var F=(function(){function F(p){this.provider=p;this.sina=p.sina;this.log=new c.Log("hana_odata facet parser");}F.prototype.parse=function(q,f){return a(this,void 0,void 0,function(){var h,v,g,i,j,k,l,m;return b(this,function(_){h=new H.HierarchyParser();v=f["@com.sap.vocabularies.Search.v1.Facets"];if(f.error&&!v){return[2,Promise.reject(new d.InternalServerError(f.error.message))];}if(!v){return[2,Promise.resolve([])];}if(f.error){this.log.warn("Server-side Warning: "+f.error.message);}g=[];for(i=0;i<v.length;i++){j=v[i];k=void 0;if(q.filter.dataSource===q.sina.getAllDataSource()){try{k=this.parseDataSourceFacet(q,j);}catch(n){this.log.warn("Error occurred by parsing dataource item number "+i+": "+n.message);continue;}}else{if(q.filter.dataSource.type===q.sina.DataSourceType.Category){continue;}if(j["@com.sap.vocabularies.Search.v1.Facet"].Dimensions[0].PropertyType==="GeometryPolygonFacet"){continue;}try{l=this.parseFacetAttribute(q,j);if(l.isHierarchy){k=h.parseHierarchyFacet(q,l,j);}else{k=this.parseChartFacet(q,l,j);}}catch(n){m="";if(j.Items&&Array.isArray(j.Items)){m=JSON.stringify(j);}this.log.warn("Error occurred by parsing facet "+(j["@com.sap.vocabularies.Common.v1.Label"]||"")+"', facet position: "+i+": "+n.message+"; item data: "+m);continue;}}g.push(k);}return[2,Promise.all(g)];});});};F.prototype.parseDataSourceFacet=function(q,f){var g=q;if(q instanceof S.SearchQuery){g=this.sina.createDataSourceQuery({dataSource:q.filter.dataSource,filter:q.filter.clone(),});}var h=[];for(var i=0;i<f.Items.length;i++){var j=f.Items[i];var k=this.sina.getDataSource(j.scope);if(!k){k=this.sina.createDataSource({type:this.sina.DataSourceType.Category,id:j.ValueLow,label:j.Description,});}h.push(this.sina._createDataSourceResultSetItem({dataSource:k,dimensionValueFormatted:k.labelPlural,measureValue:j._Count,measureValueFormatted:j._Count.toString(),}));}var l=this.sina._createDataSourceResultSet({title:q.filter.dataSource.label,items:h,query:g,});if(q instanceof S.SearchQuery){return g._setResultSet(l);}return l;};F.prototype.createAttributeFilterCondition=function(f,m,g){if(typeof g[f]==="object"&&(Object.prototype.hasOwnProperty.call(g[f],"From")||Object.prototype.hasOwnProperty.call(g[f],"From"))){var h=this.sina.createComplexCondition({attributeLabel:m.label,valueLabel:this.formatFacetValue(g[f]),operator:L.LogicalOperator.And,conditions:[],});var l=void 0,u=void 0;if(!g[f].From){u=this.sina.createSimpleCondition({attribute:f,operator:C.ComparisonOperator.Le,value:t.odata2Sina(m.type,g[f].To),});h.conditions.push(u);}else if(!g[f].To){l=this.sina.createSimpleCondition({attribute:f,operator:C.ComparisonOperator.Ge,value:t.odata2Sina(m.type,g[f].From),});h.conditions.push(l);}else{l=this.sina.createSimpleCondition({attribute:f,operator:C.ComparisonOperator.Ge,value:t.odata2Sina(m.type,g[f].From),});h.conditions.push(l);u=this.sina.createSimpleCondition({attribute:f,operator:C.ComparisonOperator.Le,value:t.odata2Sina(m.type,g[f].To),});h.conditions.push(u);}return h;}return this.sina.createSimpleCondition({attributeLabel:m.label,attribute:f,value:g[f],valueLabel:t.odata2Sina(m.type,g[f]),});};F.prototype.formatFacetValue=function(v){var i="";if(v["@com.sap.vocabularies.Common.v1.Label"]){return v["@com.sap.vocabularies.Common.v1.Label"];}if(typeof v==="object"&&(Object.prototype.hasOwnProperty.call(v,"From")||Object.prototype.hasOwnProperty.call(v,"To"))){v=(v.From||i)+"..."+(v.To||i);}return v;};F.prototype.parseFacetAttribute=function(q,f){var g=q.filter.dataSource;var h="";if(q.dimension){h=q.dimension;}else{if(f["@com.sap.vocabularies.Search.v1.Facet"]&&f["@com.sap.vocabularies.Search.v1.Facet"].Dimensions&&f["@com.sap.vocabularies.Search.v1.Facet"].Dimensions[0]&&f["@com.sap.vocabularies.Search.v1.Facet"].Dimensions[0].PropertyName){h=f["@com.sap.vocabularies.Search.v1.Facet"].Dimensions[0].PropertyName;}else{throw new d.FacetsParseError("parse error facets");}}var m=g.getAttributeMetadata(h);return m;};F.prototype.parseChartFacet=function(q,f,g){var h=q.filter.dataSource;var j=[];var k=q;var l=q.filter.clone();l.setDataSource(h);l.setRootCondition(q.filter.rootCondition.clone());k=this.sina.createChartQuery({filter:l,dimension:f.id,});for(var i=0;i<g.Items.length;i++){var m=g.Items[i];j.push(this.sina._createChartResultSetItem({filterCondition:this.createAttributeFilterCondition(f.id,f,m),dimensionValueFormatted:this.formatFacetValue(m[f.id]),measureValue:m._Count,measureValueFormatted:m._Count,icon:m[f.id+"@com.sap.vocabularies.Common.v1.Text"],}));}var n=this.sina._createChartResultSet({title:f.label,items:j,query:k,});if(q instanceof S.SearchQuery){return k._setResultSet(n);}return n;};return F;}());e.FacetParser=F;});})();
