/*! 
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	 
 */
(function(){sap.ui.define(["require","exports","../../core/Log","../../sina/AttributeType","../../sina/AttributeFormatType","../../sina/MatchingStrategy","../../core/errors"],function(r,a,L,A,b,M,c){"use strict";Object.defineProperty(a,"__esModule",{value:true});a.MetadataParser=void 0;var d;(function(d){d[d["AUTO_FACET"]=0]="AUTO_FACET";d[d["SUGGESTION"]=1]="SUGGESTION";})(d||(d={}));var P;(function(P){P[P["TITLE"]=0]="TITLE";P[P["SUMMARY"]=1]="SUMMARY";P[P["DETAIL"]=2]="DETAIL";P[P["IMAGE"]=3]="IMAGE";P[P["THUMBNAIL"]=4]="THUMBNAIL";P[P["HIDDEN"]=5]="HIDDEN";})(P||(P={}));var f=(function(){function f(p){this.log=new L.Log("hana_odata metadata parser");this.provider=p;this.sina=p.sina;}f.prototype._setAnnotationValue=function(e,g,v){var h=g.split(".");var j;var k=e;var l="___temporaryDummyEntriesForArrays___";var i;for(i=0;i<h.length-1;i++){j=h[i];if(k[j]===undefined){k[j]={};k=k[j];}else if(Array.isArray(k[j])){k[l]=k[l]||{};if(!k[l][j]){k[l][j]={};k[j].push(k[l][j]);}k=k[l][j];}else if(typeof k[j]==="object"){k=k[j];}else if(typeof k[j]==="boolean"){k[j]={};k=k[j];}else{return;}}if(i<h.length){j=h[i];if(k[j]===undefined){k[j]=v;}else if(Array.isArray(k[j])){if(Array.isArray(v)){k[j]=k[j].concat(v);}else{k[l]=k[l]||{};if(!k[l][j]){k[l][j]=v;k[j].push(k[l][j]);}else{for(var p in v){if(!k[l][j][p]){k[l][j][p]=v[p];}}}}}}};f.prototype.fillMetadataBuffer=function(g,h){if(g.attributesMetadata[0].id!=="dummy"){return;}g.attributesMetadata=[];g.attributeMetadataMap={};var i={dataSourceAnnotations:{},attributeAnnotations:{},};i.dataSourceAnnotations=g.annotations;for(var j in h.attributeMap){try{this.fillPublicMetadataBuffer(g,h.attributeMap[j],i);}catch(e){this.log.error("Attribue "+j+" of DataSource "+g.label+" can not be filled in meta data"+e.toString());}}var p=this.sina._createCDSAnnotationsParser({dataSource:g,cdsAnnotations:i,});p.parseCDSAnnotationsForDataSource();};f.prototype.fillPublicMetadataBuffer=function(e,g,h){var i=g.displayOrder;var j=(h.attributeAnnotations[g.labelRaw]={});for(var p in g.annotationsAttr){j[p]=g.annotationsAttr[p];}var t=this._parseAttributeTypeAndFormat(g,e);if(t&&t.type){var k=this.sina._createAttributeMetadata({id:g.labelRaw,label:g.label||g.labelRaw,isKey:g.isKey||false,isSortable:g.isSortable,usage:this._parseUsage(g,i)||{},type:t.type,format:t.format,matchingStrategy:this._parseMatchingStrategy(g),isHierarchy:!!g.hierarchyDefinition,});k._private.semanticObjectType=g.SemanticObjectTypeId;k._private.hierarchyDefinition=g.hierarchyDefinition;e.attributesMetadata.push(k);e.attributeMetadataMap[k.id]=k;}};f.prototype._parseMatchingStrategy=function(e){if(e.supportsTextSearch===true){return M.MatchingStrategy.Text;}return M.MatchingStrategy.Exact;};f.prototype._parseAttributeTypeAndFormat=function(e,g){for(var i=0;i<e.presentationUsage.length;i++){var p=e.presentationUsage[i]||"";switch(p.toUpperCase()){case"SUMMARY":continue;case"DETAIL":continue;case"TITLE":continue;case"HIDDEN":continue;case"FACTSHEET":continue;case"THUMBNAIL":case"IMAGE":return{type:A.AttributeType.ImageUrl,};case"LONGTEXT":return{type:A.AttributeType.String,format:b.AttributeFormatType.LongText,};default:throw new c.UnknownPresentationUsageError("Unknown presentation usage "+p);}}switch(e.type){case"Edm.Binary":if(e.annotationsAttr){if((e.annotationsAttr.SEMANTICS&&e.annotationsAttr.SEMANTICS.CONTACT&&e.annotationsAttr.SEMANTICS.CONTACT.PHOTO)||(e.annotationsAttr.SEMANTICS&&e.annotationsAttr.SEMANTICS.IMAGEURL)){return{type:A.AttributeType.ImageBlob,};}}return{type:A.AttributeType.String,};break;case"Edm.String":case"Edm.Boolean":case"Edm.Byte":case"Edm.Guid":return{type:A.AttributeType.String,};case"Edm.Double":case"Edm.Decimal":case"Edm.Float":case"Edm.Single":case"Edm.SingleRange":return{type:A.AttributeType.Double,};case"Edm.Int16":case"Edm.Int32":case"Edm.Int64":return{type:A.AttributeType.Integer,};case"Edm.Time":return{type:A.AttributeType.Time,};case"Edm.Date":return{type:A.AttributeType.Date,};case"Edm.DateTime":case"Edm.DateTimeOffset":if(e.TypeLength!==undefined&&e.TypeLength<=8){return{type:A.AttributeType.Date,};}return{type:A.AttributeType.Timestamp,};case"Collection(Edm.String)":return{type:A.AttributeType.String,};case"Edm.GeometryPoint":return{type:A.AttributeType.GeoJson,};case"GeoJson":return{type:A.AttributeType.GeoJson,};default:if(e.type&&e.type.startsWith("Collection")){this.log.warn("Unsupported data type "+e.type+" of attribute "+e.labelRaw+" in "+g.label);return{type:A.AttributeType.String,};}this.log.error("Unknown data type "+e.type+" of attribute "+e.labelRaw+" in "+g.label);return null;}};f.prototype._parseUsage=function(e,g){var u={};for(var i=0;i<e.presentationUsage.length;i++){var h=e.presentationUsage[i].toUpperCase()||"";if(h==="TITLE"){u.Title={displayOrder:g,};}if(h==="SUMMARY"||h==="DETAIL"||h==="IMAGE"||h==="THUMBNAIL"||h==="LONGTEXT"){u.Detail={displayOrder:g,};}}if(e.isFacet){u.AdvancedSearch={displayOrder:g,};u.Facet={displayOrder:g,};}return u;};f.prototype.parseDynamicMetadata=function(s){var e=s.data;if(!e){return;}var m=e["@com.sap.vocabularies.Search.v1.Metadata"];if(!m){return;}for(var g in m){var h=m[g];for(var i in h){if(i==="$Kind"){continue;}var j=h[i];this.parseDynamicAttributeMetadata(this.sina.getDataSource(g),i,j);}}};f.prototype.parseDynamicAttributeMetadata=function(g,h,i){var t=this._parseAttributeTypeAndFormat({presentationUsage:[],type:i.$Type,},g);var j;try{j=g.getAttributeMetadata(h);}catch(e){}if(j){if(!j._private.dynamic){return;}j.label=i["@SAP.Common.Label"];j.type=t.type;j.format=t.format;}else{j=this.sina._createAttributeMetadata({id:h,label:i["@SAP.Common.Label"],isKey:false,isSortable:false,usage:{},type:t.type,format:t.format,matchingStrategy:M.MatchingStrategy.Exact,_private:{dynamic:true,},});g.attributesMetadata.push(j);g.attributeMetadataMap[j.id]=j;}};f.prototype.getUniqueDataSourceFromSearchResult=function(s){var e=s.data;if(!e){return;}var g=e.value;if(!g){return;}var h,p;for(var i=0;i<g.length;++i){var j=g[i];var k=j["@odata.context"];if(!k){return;}h=k.split("#")[1];if(!h){return;}if(p&&p!==h){return;}p=h;}return this.sina.getDataSource(h);};return f;}());a.MetadataParser=f;});})();
