/*! 
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	 
 */
(function(){sap.ui.define(["require","exports","../../sina/ComparisonOperator","../../sina/LogicalOperator","../../sina/SearchQuery","./typeConverter"],function(r,e,C,L,S,t){"use strict";Object.defineProperty(e,"__esModule",{value:true});e.FacetParser=void 0;var F=(function(){function F(p){this.provider=p;this.sina=p.sina;}F.prototype.parse=function(q,d){if(d.ValueHelp){this.prepareValueHelpFacet(q,d);}var f=[];if(!d.Facets||!d.Facets.results){return[];}for(var i=0;i<d.Facets.results.length;i++){var a=d.Facets.results[i];var b=a.Type;if(b==="DataSource"){f.push(this.parseDataSourceFacet(q,a));}else{if(q.filter.dataSource.type===q.sina.DataSourceType.Category||q.filter.dataSource.type===q.sina.DataSourceType.UserCategory){continue;}f.push(this.parseChartFacet(q,a));}}return Promise.all(f);};F.prototype.prepareValueHelpFacet=function(q,d){var s=d.ValueHelp.results;var a=this.sina.getDataSource(q.filter.dataSource.id);var b=d.ValueHelpAttribute;var m=a.getAttributeMetadata(b);var c={Id:d.ValueHelpAttribute,Name:m.label,Type:"AttributeValue",Values:{results:[],},};var f=[];for(var i=0;i<s.length;i++){var g=s[i];f.push({Description:g.ValueFormatted,NumberOfObjects:g.NumberOfInstances,Type:"AttributeValue",ValueLow:g.Value,ValueLowFormatted:g.ValueFormatted,ValueHigh:"",ValueHighFormatted:"",});}c.Values.results=f;d.Facets={};d.Facets.results=[];d.Facets.results[0]=c;};F.prototype.parseDataSourceFacet=function(q,f){var d=q;if(q instanceof S.SearchQuery){d=this.sina.createDataSourceQuery({dataSource:q.filter.dataSource,filter:q.filter.clone(),});}var a=[];for(var i=0;i<f.Values.results.length;i++){var c=f.Values.results[i];var b=this.sina.getDataSource(c.ValueLow);if(!b){b=this.sina._createDataSource({type:this.sina.DataSourceType.Category,id:c.ValueLow,label:c.Description,});}a.push(this.sina._createDataSourceResultSetItem({dataSource:b,dimensionValueFormatted:b.labelPlural,measureValue:c.NumberOfObjects,measureValueFormatted:c.NumberOfObjects.toString(),}));}var g=this.sina._createDataSourceResultSet({title:q.filter.dataSource.label,items:a,query:d,});if(q instanceof S.SearchQuery){return d._setResultSet(g);}return g;};F.prototype.createAttributeFilterCondition=function(a,m,c){if(c.Type==="AttributeRange"){var b=[];if(c.ValueLow&&c.ValueLow.length!==0){b.push(this.sina.createSimpleCondition({attribute:a,operator:C.ComparisonOperator.Ge,value:t.odata2Sina(m.type,c.ValueLow),}));}if(c.ValueHigh&&c.ValueHigh.length!==0){b.push(this.sina.createSimpleCondition({attribute:a,operator:C.ComparisonOperator.Le,value:t.odata2Sina(m.type,c.ValueHigh),}));}return this.sina.createComplexCondition({attributeLabel:m.label,valueLabel:c.Description,operator:L.LogicalOperator.And,conditions:b,});}return this.sina.createSimpleCondition({attributeLabel:m.label,attribute:a,value:t.odata2Sina(m.type,c.ValueLow),valueLabel:c.Description,});};F.prototype.parseChartFacet=function(q,f){var d=this.sina.getDataSource(q.filter.dataSource.id);var a=f.Id;var m=d.getAttributeMetadata(a);var b,c=q;if(q instanceof S.SearchQuery){b=q.filter.clone();b.setDataSource(d);b.setRootCondition(q.filter.rootCondition.clone());c=this.sina.createChartQuery({filter:b,dimension:f.Id,});}var g=[];for(var i=0;i<f.Values.results.length;i++){var h=f.Values.results[i];g.push(this.sina._createChartResultSetItem({filterCondition:this.createAttributeFilterCondition(a,m,h),dimensionValueFormatted:h.Description,measureValue:h.NumberOfObjects,measureValueFormatted:h.ValueLowFormatted,}));}var j=this.sina._createChartResultSet({title:m.label,items:g,query:c,});if(q instanceof S.SearchQuery){return c._setResultSet(j);}return j;};return F;}());e.FacetParser=F;});})();
