/*! 
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	 
 */
(function(){var a=(this&&this.__extends)||(function(){var e=function(d,b){e=Object.setPrototypeOf||({__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b;})||function(d,b){for(var p in b)if(Object.prototype.hasOwnProperty.call(b,p))d[p]=b[p];};return e(d,b);};return function(d,b){if(typeof b!=="function"&&b!==null)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");e(d,b);function _(){this.constructor=d;}d.prototype=b===null?Object.create(b):(_.prototype=b.prototype,new _());};})();var c=(this&&this.__awaiter)||function(t,_,P,g){function b(v){return v instanceof P?v:new P(function(r){r(v);});}return new(P||(P=Promise))(function(r,d){function f(v){try{s(g.next(v));}catch(e){d(e);}}function i(v){try{s(g["throw"](v));}catch(e){d(e);}}function s(e){e.done?r(e.value):b(e.value).then(f,i);}s((g=g.apply(t,_||[])).next());});};var h=(this&&this.__generator)||function(b,d){var _={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1];},trys:[],ops:[]},f,y,t,g;return g={next:i(0),"throw":i(1),"return":i(2)},typeof Symbol==="function"&&(g[Symbol.iterator]=function(){return this;}),g;function i(n){return function(v){return s([n,v]);};}function s(o){if(f)throw new TypeError("Generator is already executing.");while(_)try{if(f=1,y&&(t=o[0]&2?y["return"]:o[0]?y["throw"]||((t=y["return"])&&t.call(y),0):y.next)&&!(t=t.call(y,o[1])).done)return t;if(y=0,t)o=[o[0]&2,t.value];switch(o[0]){case 0:case 1:t=o;break;case 4:_.label++;return{value:o[1],done:false};case 5:_.label++;y=o[1];o=[0];continue;case 7:o=_.ops.pop();_.trys.pop();continue;default:if(!(t=_.trys,t=t.length>0&&t[t.length-1])&&(o[0]===6||o[0]===2)){_=0;continue;}if(o[0]===3&&(!t||(o[1]>t[0]&&o[1]<t[3]))){_.label=o[1];break;}if(o[0]===6&&_.label<t[1]){_.label=t[1];t=o;break;}if(t&&_.label<t[2]){_.label=t[2];_.ops.push(o);break;}if(t[2])_.ops.pop();_.trys.pop();continue;}o=d.call(b,_);}catch(e){o=[6,e];y=0;}finally{f=t=0;}if(o[0]&5)throw o[1];return{value:o[0]?o[1]:void 0,done:true};}};sap.ui.define(["require","exports","../../core/ajax","../../core/core","./MetadataParserXML","./MetadataParserJson","./ItemParser","./FacetParser","./suggestionParser","./eshObjects/src/index","./conditionSerializerEshObj","../../core/Log","../../sina/SearchQuery","../../sina/SortOrder","../AbstractProvider","../../sina/SuggestionType","../../sina/ComplexCondition","../../core/errors","./HierarchyParser","./HierarchyNodePathParser"],function(r,e,b,d,M,f,I,F,s,g,k,L,S,l,A,m,C,n,H,o){"use strict";Object.defineProperty(e,"__esModule",{value:true});e.Provider=void 0;var P=(function(_){a(P,_);function P(){var i=_!==null&&_.apply(this,arguments)||this;i.id="hana_odata";return i;}P.prototype._initAsync=function(i){var j,p;return c(this,void 0,void 0,function(){var q,t;return h(this,function(u){switch(u.label){case 0:this.requestPrefix=i.url;this.odataVersion=i.odataVersion;this.sina=i.sina;this.querySuffix=this.convertQuerySuffixToExpression(i.querySuffix);this.metaDataSuffix=(j=i.metaDataSuffix)!==null&&j!==void 0?j:"";this.ajaxClient=(p=i.ajaxClient)!==null&&p!==void 0?p:new b.Client({csrf:false,});q=i.metaDataJsonType;if(q){this.metadataParser=new f.MetadataParserJson(this);}else{this.metadataParser=new M.MetadataParserXML(this);}this.itemParser=new I.ItemParser(this);this.facetParser=new F.FacetParser(this);this.suggestionParser=new s.SuggestionParser(this);this.hierarchyNodePathParser=new o.HierarchyNodePathParser(this.sina);t=this;return[4,this.loadServerInfo()];case 1:t.serverInfo=u.sent();if(!this.supports("Search")){throw new n.ESHNotActiveError();}return[4,this.loadBusinessObjectDataSources()];case 2:u.sent();if(this.sina.dataSources.length===0){return[2,Promise.reject(new n.ESHNotActiveError("Enterprise Search is not active - no datasources"))];}return[2,{capabilities:this.sina._createCapabilities({fuzzy:false,}),}];}});});};P.prototype.supports=function(i,p){var q=this.serverInfo.services;for(var t in q){if(t===i){if(!p){return true;}var u=q[t].Capabilities;for(var j=0;j<u.length;++j){var v=u[j];if(v===p){return true;}}}}return false;};P.prototype.loadServerInfo=function(){return c(this,void 0,void 0,function(){var i;return h(this,function(j){i={rawServerInfo:{Services:[{Service:"Search",Capabilities:[{Capability:"SemanticObjectType",},],},{Service:"Suggestions2",Capabilities:[{Capability:"ScopeTypes",},],},],},services:{Suggestions:{suggestionTypes:["objectdata"],},Search:{capabilities:["SemanticObjectType"],},},};return[2,i];});});};P.prototype._prepareMetadataRequest=function(){var i={metadataCall:true,resourcePath:this.getPrefix()+"/$metadata",};if(typeof this.metaDataSuffix==="string"&&this.metaDataSuffix.length>0){if(this.metaDataSuffix.startsWith("/EntitySets")){this.metaDataSuffix=this.metaDataSuffix.replace(/\/EntitySets\(/,"");this.metaDataSuffix=this.metaDataSuffix.substring(0,this.metaDataSuffix.length-1);}i.metadataObjects={entitySets:this.metaDataSuffix,};}return g.getEshSearchQuery(i);};P.prototype.loadBusinessObjectDataSources=function(){return c(this,void 0,void 0,function(){var j,p,q,i,t;return h(this,function(u){switch(u.label){case 0:j=this._prepareMetadataRequest();return[4,this.metadataParser.fireRequest(this.ajaxClient,j)];case 1:p=u.sent();return[4,this.metadataParser.parseResponse(p)];case 2:q=u.sent();for(i=0;i<q.dataSourcesList.length;++i){t=q.dataSourcesList[i];this.metadataParser.fillMetadataBuffer(t,q.businessObjectMap[t.id]);}return[2];}});});};P.prototype.assembleOrderBy=function(q){var j=[];if(Array.isArray(q.sortOrder)){for(var i=0;i<q.sortOrder.length;++i){var p=q.sortOrder[i];var t=p.order===l.SortOrder.Descending?g.ESOrderType.Descending:g.ESOrderType.Ascending;j.push({key:p.id,order:t,});}}return j;};P.prototype.assembleGroupBy=function(q){var i=null;if(q.groupBy&&q.groupBy.attributeName&&q.groupBy.attributeName.length>0){i.properties=q.groupBy.attributeName;if(q.groupBy.aggregateCountAlias&&q.groupBy.aggregateCountAlias!==""){i.aggregateCountAlias=q.groupBy.aggregateCountAlias;}}return i;};P.prototype.executeSearchQuery=function(q){var u=this._prepareSearchObjectSuggestionRequest(q);return this._fireSearchQuery(u);};P.prototype._prepareSearchObjectSuggestionRequest=function(q){var i=q.filter.rootCondition.clone();var j=k.serialize(q.filter.dataSource,i);if(!Array.isArray(j.items)){j.items=[];}var p=q.filter.searchTerm;if(this.querySuffix){j.items.push(this.querySuffix);}var t=q.filter.dataSource;var u=q.top||10;var v=q.skip||0;var w=this.assembleOrderBy(q);var x={resourcePath:this.getPrefix()+"/$all",$top:u,$skip:v,whyfound:true,$count:true,$orderby:w,freeStyleText:p,searchQueryFilter:j,};if(t!==this.sina.getAllDataSource()){x.scope=t.id;}if(q instanceof S.SearchQuery){if(q.calculateFacets){x.facets=["all"];x.facetlimit=q.facetTop||5;}var y=this.assembleGroupBy(q);if(y){x.groupby=y;x.whyfound=false;}}var z={url:g.getEshSearchQuery(x),query:q,};return z;};P.prototype._fireSearchQuery=function(i){return c(this,void 0,void 0,function(){var j,p,q,t,u,v;return h(this,function(w){switch(w.label){case 0:return[4,this.ajaxClient.getJson(i.url)];case 1:j=w.sent();this.metadataParser.parseDynamicMetadata(j);p=this.hierarchyNodePathParser.parse(j);return[4,this.itemParser.parse(i.query,j.data)];case 2:q=w.sent();u=j.data["@com.sap.vocabularies.Search.v1.SearchStatistics"].ConnectorStatistics;if(!(i.query.getDataSource()===this.sina.getAllDataSource()&&u&&Array.isArray(u)&&u.length===1))return[3,4];v=[{"@com.sap.vocabularies.Search.v1.Facet":{PropertyName:"scope",isConnectorFacet:true,},Items:[{scope:u[0].OdataID,_Count:j.data["@odata.count"],},],},];return[4,this.facetParser.parse(i.query,v)];case 3:t=w.sent();return[3,6];case 4:return[4,this.facetParser.parse(i.query,j.data)];case 5:t=w.sent();w.label=6;case 6:return[2,this.sina._createSearchResultSet({title:"Search Result List",query:i.query,items:q,totalCount:j.data["@odata.count"]||0,facets:t,hierarchyNodePaths:p,})];}});});};P.prototype._fireObjectSuggestionsQuery=function(i){return c(this,void 0,void 0,function(){var j,p;return h(this,function(q){switch(q.label){case 0:return[4,this.ajaxClient.getJson(i.url)];case 1:j=q.sent();this.metadataParser.parseDynamicMetadata(j);return[4,this.itemParser.parse(i.query,j.data)];case 2:p=q.sent();return[2,this.suggestionParser.parseObjectSuggestions(i.query,p)];}});});};P.prototype._prepareChartQueryRequest=function(q,i,j){var p=q.filter.searchTerm;var t=q.filter.dataSource;var u=15;var v=j.deleted||false;var w=k.serialize(t,i);if(!Array.isArray(w.items)){w.items=[];}var x=q.top||5;if(v===true){var y=j.value;if(!j.value||j.value===""||y.match(/^[*\s]+$/g)!==null){j.value="*";w.items.push(new g.Comparison({property:j.attribute,operator:g.SearchQueryComparisonOperator.Search,value:new g.Term({term:"*"}),}));}else{w.items.push(new g.Comparison({property:j.attribute,operator:g.SearchQueryComparisonOperator.EqualCaseInsensitive,value:new g.Phrase({phrase:j.value+"*",}),}));}}if(this.querySuffix){w.items.push(this.querySuffix);}var z={resourcePath:this.getPrefix()+"/$all",$top:0,$count:true,searchQueryFilter:w,freeStyleText:p,};if(t!==this.sina.getAllDataSource()){z.scope=t.id;}var B=[];z.facetlimit=x;if(q.dimension){B.push(q.dimension);var D=q.filter.dataSource.getAttributeMetadata(q.dimension);if(D&&(D.type==="Double"||D.type==="Integer")&&x>=20){z.facetlimit=u;}}z.facets=B;return g.getEshSearchQuery(z);};P.prototype.executeChartQuery=function(q){var i=new L.Log();var j=q.filter.rootCondition.clone();var p=j.removeAttributeConditions(q.dimension);var u=this._prepareChartQueryRequest(q,j,p);return this.ajaxClient.getJson(u).then(function(t){var v=this.facetParser.parse(q,t.data,i);return v;}.bind(this)).then(function(t){if(t.length>0){return t[0];}var v="";var w=q.filter.dataSource.getAttributeMetadata(q.dimension);if(w&&w.label){v=w.label;}return this.sina._createChartResultSet({title:v,items:[],query:q,log:i,});}.bind(this));};P.prototype.executeHierarchyQuery=function(q){return c(this,void 0,void 0,function(){var i,j,p,t,u,v,w;return h(this,function(x){switch(x.label){case 0:i=new H.HierarchyParser();j=k.serialize(q.filter.dataSource,q.filter.rootCondition);if(!Array.isArray(j.items)){j.items=[];}if(this.querySuffix){j.items.push(this.querySuffix);}p=g.getEshSearchQuery({resourcePath:this.getPrefix()+"/$all",$top:0,searchQueryFilter:j,freeStyleText:q.filter.searchTerm,scope:q.filter.dataSource.id,facets:[q.attributeId],facetroot:[new g.HierarchyFacet({facetColumn:q.attributeId,rootIds:[q.nodeId],levels:1}),],});return[4,this.ajaxClient.getJson(p)];case 1:t=x.sent();u=q.filter.dataSource.getAttributeMetadata(q.attributeId);v=t.data["@com.sap.vocabularies.Search.v1.Facets"];w=v.find(function(w){var y=d.getProperty(w,["@com.sap.vocabularies.Search.v1.Facet","Dimensions",0,"PropertyName",]);return y===q.attributeId;});return[2,i.parseHierarchyFacet(q,u,w)];}});});};P.prototype.executeSuggestionQuery=function(q){return c(this,void 0,void 0,function(){return h(this,function(i){return[2,Promise.all([this.executeRegularSuggestionQuery(q),this.executeObjectSuggestionQuery(q),]).then(function(j){var p=[];p.push.apply(p,j[1]);p.push.apply(p,j[0]);return this.sina._createSuggestionResultSet({title:"Suggestions",query:q,items:p,});}.bind(this))];});});};P.prototype.isObjectSuggestionQuery=function(q){return(q.types.indexOf(m.SuggestionType.Object)>=0&&q.filter.dataSource.type===q.sina.DataSourceType.BusinessObject);};P.prototype.executeObjectSuggestionQuery=function(q){return c(this,void 0,void 0,function(){var u;return h(this,function(i){switch(i.label){case 0:if(!this.isObjectSuggestionQuery(q)){return[2,Promise.resolve([])];}return[4,this._prepareSearchObjectSuggestionRequest(q)];case 1:u=i.sent();return[2,this._fireObjectSuggestionsQuery(u)];}});});};P.prototype.executeRegularSuggestionQuery=function(q){var p={SearchTerm:{Data:"SuggestObjectData",History:"SuggestSearchHistory",},Object:{},DataSource:{Data:"SuggestDataSources",},};var t=q.types;var u=q.calculationModes;var v=Promise.resolve([]);for(var i=0;i<t.length;i++){var w=t[i];for(var j=0;j<u.length;j++){var x=u[j];var y=p[w][x];switch(y){case"SuggestObjectData":return this._fireSuggestionQuery(q);default:return v;}}}};P.prototype._prepareSuggestionQueryRequest=function(q){var i=q.filter.searchTerm;var j=q.filter.dataSource;var p=q.filter.rootCondition.clone();var t=k.serialize(q.filter.dataSource,p);if(!Array.isArray(t.items)){t.items=[];}var u=q.top||10;var v=q.skip||0;if(this.querySuffix){t.items.push(this.querySuffix);}var w={suggestTerm:i,resourcePath:this.getPrefix()+"/$all",$top:u,$skip:v,searchQueryFilter:t,};if(j!==this.sina.getAllDataSource()){w.scope=j.id;}return g.getEshSearchQuery(w);};P.prototype._fireSuggestionQuery=function(q){var u=this._prepareSuggestionQueryRequest(q);return this.ajaxClient.getJson(u).then(function(i){var j=[];if(i.data.value){j=this.suggestionParser.parse(q,i.data.value);}return j;}.bind(this));};P.prototype.getPrefix=function(){var i,j;var p=(i=this.odataVersion)!==null&&i!==void 0?i:"/v20411";var q=(j=this.requestPrefix)!==null&&j!==void 0?j:"/sap/es/odata";var t=q+p;return t;};P.prototype.convertQuerySuffixToExpression=function(i){var j=null;if(i&&i instanceof C.ComplexCondition){j=k.serialize(null,i);}return j;};P.prototype.getDebugInfo=function(){return"ESH API Provider: "+this.id;};return P;}(A.AbstractProvider));e.Provider=P;});})();
