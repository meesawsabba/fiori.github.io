/*! 
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	 
 */
(function(){sap.ui.define(["require","exports","./pivotTableParser","./typeConverter","../../sina/ComparisonOperator","../../sina/SearchQuery","../../sina/LogicalOperator","../../core/errors"],function(r,e,p,t,C,S,L,a){"use strict";Object.defineProperty(e,"__esModule",{value:true});e.FacetParser=void 0;var F=(function(){function F(b){this.provider=b;this.sina=b.sina;}F.prototype.parse=function(q,d){var f=[];if(!d.ResultsetFacets||!d.ResultsetFacets.Elements){return[];}for(var i=0;i<d.ResultsetFacets.Elements.length;i++){var b=d.ResultsetFacets.Elements[i];var c=b.Metadata.Cube.ObjectName;if(c==="$$DataSources$$"){f.push(this.parseDataSourceFacet(q,b));}else{if(q.filter.dataSource.type===q.sina.DataSourceType.Category){continue;}f.push(this.parseChartFacet(q,b));}}return Promise.all(f);};F.prototype.parseDataSourceFacet=function(q,f){var d=q;if(q instanceof S.SearchQuery){d=this.sina.createDataSourceQuery({dataSource:q.filter.dataSource,filter:q.filter.clone(),});}var b=p.parse(f.ResultSet);var c=[];for(var i=0;i<b.cells.length;i++){var g=b.cells[i];var h=this.sina.getDataSource(g.$$DataSource$$[0].Value);if(!h){h=this.sina._createDataSource({type:this.sina.DataSourceType.Category,id:g.$$DataSource$$[0].Value,label:g.$$DataSource$$[0].ValueFormatted,});}c.push(this.sina._createDataSourceResultSetItem({dataSource:h,dimensionValueFormatted:g.$$DataSource$$[0].ValueFormatted,measureValue:g.Value,measureValueFormatted:g.ValueFormatted,}));}var j=this.sina._createDataSourceResultSet({title:q.filter.dataSource.label,items:c,query:d,});if(q instanceof S.SearchQuery){return d._setResultSet(j);}return j;};F.prototype.createAttributeFilterCondition=function(b,m,c){switch(c.$$AttributeValue$$.length){case 2:return this.sina.createSimpleCondition({attribute:b,value:t.ina2Sina(m.type,c.$$AttributeValue$$[0].Value),attributeLabel:m.label,valueLabel:c.$$AttributeValue$$[0].ValueFormatted,});case 3:{var d=this.sina.createComplexCondition({attributeLabel:m.label,valueLabel:c.$$AttributeValue$$[0].ValueFormatted,operator:L.LogicalOperator.And,});var f=[];if(c.$$AttributeValue$$[1].Value){f.push(this.sina.createSimpleCondition({attribute:b,operator:C.ComparisonOperator.Ge,value:t.ina2Sina(m.type,c.$$AttributeValue$$[1].Value),}));}if(c.$$AttributeValue$$[2].Value){f.push(this.sina.createSimpleCondition({attribute:b,operator:C.ComparisonOperator.Le,value:t.ina2Sina(m.type,c.$$AttributeValue$$[2].Value),}));}d.conditions=f;return d;}default:throw new a.FacetsParseError("parse error facets");}};F.prototype.parseChartFacet=function(q,f){var d=this.sina.getDataSource(f.Metadata.Cube.DataSource.ObjectName);var b=f.Metadata.Cube.ObjectName;var m=d.getAttributeMetadata(b);var c=q;if(q instanceof S.SearchQuery){var g=q.filter.clone();g.setDataSource(d);g.setRootCondition(q.filter.rootCondition.clone());c=this.sina.createChartQuery({filter:g,dimension:f.Metadata.Cube.ObjectName,});}var h=p.parse(f.ResultSet);var j=[];for(var i=0;i<h.cells.length;i++){var k=h.cells[i];j.push(this.sina._createChartResultSetItem({filterCondition:this.createAttributeFilterCondition(b,m,k),dimensionValueFormatted:k.$$AttributeValue$$[0].ValueFormatted||k.$$AttributeValue$$[0].Value,measureValue:k.Value,measureValueFormatted:k.ValueFormatted,}));}var l=this.sina._createChartResultSet({title:m.label,items:j,query:c,});if(q instanceof S.SearchQuery){return c._setResultSet(l);}return l;};return F;}());e.FacetParser=F;});})();
