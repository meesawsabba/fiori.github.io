/*! 
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	 
 */
(function(){var _=(this&&this.__extends)||(function(){var e=function(d,b){e=Object.setPrototypeOf||({__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b;})||function(d,b){for(var p in b)if(Object.prototype.hasOwnProperty.call(b,p))d[p]=b[p];};return e(d,b);};return function(d,b){if(typeof b!=="function"&&b!==null)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");e(d,b);function a(){this.constructor=d;}d.prototype=b===null?Object.create(b):(a.prototype=b.prototype,new a());};})();sap.ui.define(["require","exports","../../../sina/SinaObject","../../../sina/AttributeGroupTextArrangement","../../../sina/AttributeType","../../../sina/AttributeFormatType","../../../sina/AttributeSemanticsType","../../../core/Log"],function(r,a,S,A,b,c,d,L){"use strict";Object.defineProperty(a,"__esModule",{value:true});a.CDSAnnotationsParser=void 0;var C=(function(f){_(C,f);function C(p){var e=f.call(this,p)||this;e.log=new L.Log("hana odata cds annotations parser");e._datasource=p.dataSource;e._cdsAnnotations=p.cdsAnnotations;e._parsedAttributes={};e._knownAttributeGroups={};e._knownAttributeGroupsArray=[];e._attributeGroupReplacements={};e._AttributeUsagePrio={HIGH:"HIGH",MEDIUM:"MEDIUM",NONE:"NONE",};e._detailUsageStubsMap={};e._detailUsageStubsPrioHigh=[];e._detailUsageStubsPrioMedium=[];e._detailUsageStubsPrioNone=[];e._defaultTextArrangement=A.AttributeGroupTextArrangement.TextLast;return e;}C.prototype.parseCDSAnnotationsForDataSource=function(){this._parsingResult={dataSourceIsCdsBased:false,detailAttributesAreSorted:false,titleAttributesAreSorted:false,};this._parseDefaultTextArrangement();this._parseAttributeAnnotations();this._parseDataSourceAnnotations();return this._parsingResult;};C.prototype._addDetailUsageStub=function(e,g,p){var h;if(typeof e==="string"){h=e;e=undefined;}else{h=e.id;}var u={attribute:e,displayOrder:g,prio:p,obsolete:false,};this._detailUsageStubsMap[h]=u;if(p===this._AttributeUsagePrio.HIGH){this._detailUsageStubsPrioHigh.push(u);}else if(p===this._AttributeUsagePrio.MEDIUM){this._detailUsageStubsPrioMedium.push(u);}else{this._detailUsageStubsPrioNone.push(u);}};C.prototype._getDetailUsageStub=function(e){if(!e){return undefined;}var g;if(typeof e==="string"){g=e;}else{g=e.id;}return this._detailUsageStubsMap[g];};C.prototype._setParsedAttribute=function(e,g){this._parsedAttributes[e.toUpperCase()]=g;};C.prototype._getParsedAttribute=function(e){return this._parsedAttributes[e.toUpperCase()];};C.prototype._setknownAttributeGroup=function(q,e){this._knownAttributeGroups[q.toUpperCase()]=e;};C.prototype._getknownAttributeGroup=function(q){return this._knownAttributeGroups[q.toUpperCase()];};C.prototype._parseDefaultTextArrangement=function(){try{var g=this._deriveTextArrangementFromCdsAnnotation(this._cdsAnnotations.dataSourceAnnotations.UI&&this._cdsAnnotations.dataSourceAnnotations.UI.TEXTARRANGEMENT);this._defaultTextArrangement=g||this._defaultTextArrangement;}catch(e){}};C.prototype._parseDataSourceAnnotations=function(){if(Object.keys(this._cdsAnnotations.dataSourceAnnotations).length>0){try{var u=this._cdsAnnotations.dataSourceAnnotations.UI;var h=u&&u.HEADERINFO;var t=h&&h.TITLE;var g=void 0,i=void 0,j=void 0;if(t){g=t.TYPE&&t.TYPE.toUpperCase();if(g==="AS_CONNECTED_FIELDS"){i=t.VALUEQUALIFIER;if(i&&i.trim().length>0){j=this._getknownAttributeGroup(i);if(j){j.usage.Title={displayOrder:1,};}}}else if(!g){var k=t.VALUE;if(k){var l=this._getParsedAttribute(k);if(l){l.usage.Title={displayOrder:1,};}}}var m=t.URL;if(m){var n=this._getParsedAttribute(m);if(n){n.usage.Navigation={mainNavigation:true,};}}}var o=h&&h.DESCRIPTION;if(o){g=o.TYPE;if(g==="AS_CONNECTED_FIELDS"){i=o.VALUEQUALIFIER;if(i&&i.trim().length>0){j=this._getknownAttributeGroup(i);if(j){j.usage.TitleDescription={displayOrder:1,};}}}else if(!g){var p=o.VALUE;if(p){var q=this._getParsedAttribute(p);if(q){q.usage.TitleDescription={};}}}}var s=h&&h.IMAGEURL;if(s){var v=this._getParsedAttribute(s);if(v){v.usage.Title={};v.type=this.sina.AttributeType.ImageUrl;}}}catch(e){this.log.warn("Could not parse attribute for datasource: "+e);}}};C.prototype._parseAttributeAnnotations=function(){for(var e in this._datasource.attributeMetadataMap){this._parseSingleAttribute(e);}this._datasource.attributesMetadata=this._datasource.attributesMetadata.concat(this._knownAttributeGroupsArray);this._datasource.attributeMetadataMap=Object.assign(this._datasource.attributeMetadataMap,this._knownAttributeGroups);this._sortAttributes();};C.prototype._parseSingleAttribute=function(g){var p=this._getParsedAttribute(g);if(!p){p=this._getPropertyFromObject(this._datasource.attributeMetadataMap,g);if(p&&p.id){this._setParsedAttribute(p.id,p);var h=this._cdsAnnotations.attributeAnnotations[p.id]||{};if(Object.keys(h).length>0){this._parsingResult.dataSourceIsCdsBased=true;try{if(h.UI!==undefined){this._parseSingleAnnotationOrArray(p,h.UI.IDENTIFICATION,this._parseIdentification);this._parseSingleAnnotationOrArray(p,h.UI.CONNECTEDFIELDS,this._parseConnectedFields);this._parseURLsForDocumentResultItemThumbnail(p,h.UI.IDENTIFICATION,h.SEMANTICS);if(h.UI.MULTILINETEXT!==undefined){p.format=c.AttributeFormatType.MultilineText;}}this._parseSemantics(p,h.SEMANTICS);this._parseDescriptionAttribute(p,h.OBJECTMODEL,h.UI);}catch(e){}}}}return p;};C.prototype._parseConnectedFields=function(e,g){var q=g.QUALIFIER;if(q){var h={};if(g.NAME){h[g.NAME]=e;}this._createAttributeGroup(q,g.GROUPLABEL,g.TEMPLATE,h);}};C.prototype._createAttributeGroup=function(q,l,t,e){var g=this._getknownAttributeGroup(q);if(!g){g=this.sina._createAttributeGroupMetadata({id:q,label:l||"",type:b.AttributeType.Group,template:t||"",attributes:[],usage:{},});this._setknownAttributeGroup(q,g);this._knownAttributeGroupsArray.push(g);this._datasource.attributeGroupsMetadata.push(g);this._datasource.attributeGroupMetadataMap[q]=g;var u=this._getDetailUsageStub(q);if(u){u.attribute=g;}}else{if(l&&!g.label){g.label=l;}if(t&&!g.template){g.template=t;}}if(e){for(var n in e){var h=e[n];var i=this.sina._createAttributeGroupMembership({group:g,attribute:h,nameInGroup:n,});g.attributes.push(i);h.groups.push(i);}}return g;};C.prototype._parseIdentification=function(e,i){this._parseAttributePositions(e,i);};C.prototype._parseAttributePositions=function(e,i){var g=i.IMPORTANCE&&i.IMPORTANCE.toUpperCase();var p=i.POSITION;if(g&&!p){p=Number.MAX_VALUE;}if(p!==undefined){switch(g){case"HIGH":case"MEDIUM":case undefined:{p=this._parsePosition(p);var t=i.TYPE&&i.TYPE.toUpperCase();switch(t){case"AS_CONNECTED_FIELDS":{var q=i.VALUEQUALIFIER;if(q){var h=this._getknownAttributeGroup(q);if(h){e=h;}else{e=q;}}}case undefined:{var u=this._getDetailUsageStub(e);if(u){if(!u.attribute&&typeof e!=="string"){u.attribute=e;}}else{var j=void 0;if(g==="HIGH"){j=this._AttributeUsagePrio.HIGH;}else if(g==="MEDIUM"){j=this._AttributeUsagePrio.MEDIUM;}else{j=this._AttributeUsagePrio.NONE;}this._addDetailUsageStub(e,p,j);}}}}}}};C.prototype._parseURLsForDocumentResultItemThumbnail=function(e,g,s){if(!(s&&s.IMAGEURL)){return;}var u;if(g){if(Array.isArray(g)){for(var i=0;i<g.length;i++){if(g[i].URL){u=g[i].URL;break;}}}else{u=g.URL;}}if(u&&s&&s.IMAGEURL){var h=this._getPropertyFromObject(this._cdsAnnotations.attributeAnnotations,u);if(h){var m=h.SEMANTICS&&h.SEMANTICS.URL&&h.SEMANTICS.URL.MIMETYPE;if(m){var j=this._getPropertyFromObject(this._datasource.attributeMetadataMap,u);var k=this._getPropertyFromObject(this._datasource.attributeMetadataMap,m);e.suvUrlAttribute=j;e.suvMimeTypeAttribute=k;e.format=c.AttributeFormatType.DocumentThumbnail;}}}};C.prototype._parseSemantics=function(e,s){if(s){if(s.CONTACT&&s.CONTACT.PHOTO!==undefined){e.format=c.AttributeFormatType.Round;if(e.type!==b.AttributeType.ImageBlob){e.type=b.AttributeType.ImageUrl;}}if(s.IMAGEURL!==undefined){if(e.type!==b.AttributeType.ImageBlob){e.type=b.AttributeType.ImageUrl;}}if(s.NAME!==undefined){if(s.NAME.GIVENNAME!==undefined){e.semantics=d.AttributeSemanticsType.FirstName;}if(s.NAME.FAMILYNAME!==undefined){e.semantics=d.AttributeSemanticsType.LastName;}}if(s.EMAIL&&s.EMAIL.ADDRESS!==undefined){e.semantics=d.AttributeSemanticsType.EmailAddress;}if(s.TELEPHONE&&s.TELEPHONE.TYPE!==undefined){e.semantics=d.AttributeSemanticsType.PhoneNr;}if(s&&s.URL!==undefined){e.semantics=d.AttributeSemanticsType.HTTPURL;}if(s&&s.CURRENCYCODE!==undefined){e._private.isCurrency=true;}if(s&&s.UNITOFMEASURE!==undefined){e._private.isUnitOfMeasure=true;}var u=void 0,g=void 0,t=void 0;var h=s.QUANTITY&&s.QUANTITY.UNITOFMEASURE;if(h){e._private.isQuantity=true;u=this._parseSingleAttribute(h);if(u){if(u._private.isUnitOfMeasure){t="{"+e.id+"} {"+u.id+"}";this._createAttributeGroupForParentChildAttributes(e,u,"____UnitOfMeasureGroup",t);}}}var i=s.AMOUNT&&s.AMOUNT.CURRENCYCODE;if(i){g=this._parseSingleAttribute(i);if(g){if(g._private.isCurrency){t="{"+e.id+"} {"+g.id+"}";this._createAttributeGroupForParentChildAttributes(e,g,"____CurrencyGroup",t);}}}}};C.prototype._parseDescriptionAttribute=function(e,o,u){var g=o&&o.TEXT&&o.TEXT.ELEMENT;if(g){if(Array.isArray(g)){if(g.length>0){g=g[0];}else{return;}}var h=this._parseSingleAttribute(g);if(h){var t=this._deriveTextArrangementFromCdsAnnotation(u&&u.TEXTARRANGEMENT)||this._defaultTextArrangement;var i=!((e.semantics==d.AttributeSemanticsType.FirstName&&h.semantics==d.AttributeSemanticsType.LastName)||(h.semantics==d.AttributeSemanticsType.FirstName&&e.semantics==d.AttributeSemanticsType.LastName));var p=i?"(":"";var j=i?")":"";var k=void 0;if(t===A.AttributeGroupTextArrangement.TextFirst){k="{"+h.id+"} "+p+"{"+e.id+"}"+j;}else if(t===A.AttributeGroupTextArrangement.TextLast){k="{"+e.id+"} "+p+"{"+h.id+"}"+j;}else if(t===A.AttributeGroupTextArrangement.TextOnly){k="{"+h.id+"}";}else{k="{"+e.id+"} "+p+"{"+h.id+"}"+j;}var l=this._createAttributeGroupForParentChildAttributes(e,h,"____Description",k);l._private.isDescription=true;l._private.textArrangement=t;if(e._private.isUnitOfMeasure||h._private.isUnitOfMeasure){l._private.isUnitOfMeasure=true;}if(e._private.isCurrency||h._private.isCurrency){l._private.isCurrency=true;}}}};C.prototype._deriveTextArrangementFromCdsAnnotation=function(e){if(e){switch(e.toUpperCase()){case"TEXT_FIRST":return A.AttributeGroupTextArrangement.TextFirst;case"TEXT_LAST":return A.AttributeGroupTextArrangement.TextLast;case"TEXT_ONLY":return A.AttributeGroupTextArrangement.TextOnly;case"TEXT_SEPARATE":return A.AttributeGroupTextArrangement.TextSeparate;}}return undefined;};C.prototype._createAttributeGroupForParentChildAttributes=function(p,e,q,t){var g=p.id+q;var h={};h[p.id]=p;h[e.id]=e;var i=this._createAttributeGroup(g,p.label,t,h);var o=this._getDetailUsageStub(p);if(o){o.obsolete=true;this._addDetailUsageStub(i,o.displayOrder,o.prio);}this._replaceAttributeWithGroup(p,i);i._private.parentAttribute=p;i._private.childAttribute=e;if(e._private&&e._private.isCurrency){i._private.isCurrency=true;}if(e._private&&e._private.isUnitOfMeasure){i._private.isUnitOfMeasure=true;}return i;};C.prototype._replaceAttributeWithGroup=function(e,g){this._setParsedAttribute(e.id,g);for(var i=0;i<e.groups.length;i++){var h=e.groups[i];if(h.group!=g){h.attribute=g;}}};C.prototype._sortAttributes=function(){var s=function(j,k){if(j.displayOrder<k.displayOrder){return-1;}else if(j.displayOrder>k.displayOrder){return 1;}return 0;};var i,e;if(this._detailUsageStubsPrioHigh.length>0||this._detailUsageStubsPrioMedium.length>0){this._detailUsageStubsPrioHigh.sort(s);this._detailUsageStubsPrioMedium.sort(s);var g=this._detailUsageStubsPrioHigh.concat(this._detailUsageStubsPrioMedium);for(i=0;i<g.length;i++){if(!g[i].obsolete){e=g;break;}}}if(!e){e=this._detailUsageStubsPrioNone.sort(s);}for(i=0;i<e.length;i++){var h=e[i];if(!h.obsolete&&h.attribute&&typeof h.attribute!=="string"){h.attribute.usage=h.attribute.usage||{};h.attribute.usage.Detail={displayOrder:i,};}}this._parsingResult.detailAttributesAreSorted=true;};C.prototype._parseSingleAnnotationOrArray=function(e,g,p){if(g!==undefined){if(Array.isArray(g)){for(var j=0;j<g.length;j++){p.apply(this,[e,g[j]]);}}else{p.apply(this,[e,g]);}}};C.prototype._parsePosition=function(p){if(typeof p==="string"){try{p=parseInt(p,10);}catch(e){p=Number.MAX_VALUE;}}if(typeof p!=="number"||isNaN(p)){p=Number.MAX_VALUE;}return p;};C.prototype._getPropertyFromObject=function(o,p){if(o[p]){return o[p];}p=p.toLowerCase();for(var k in o){if(k.toLowerCase()===p){return o[k];}}return undefined;};return C;}(S.SinaObject));a.CDSAnnotationsParser=C;});})();
