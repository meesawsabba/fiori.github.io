/*! 
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	 
 */
(function(){var c=(this&&this.__extends)||(function(){var e=function(d,b){e=Object.setPrototypeOf||({__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b;})||function(d,b){for(var p in b)if(Object.prototype.hasOwnProperty.call(b,p))d[p]=b[p];};return e(d,b);};return function(d,b){if(typeof b!=="function"&&b!==null)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");e(d,b);function _(){this.constructor=d;}d.prototype=b===null?Object.create(b):(_.prototype=b.prototype,new _());};})();var h=(this&&this.__awaiter)||function(t,_,P,g){function a(v){return v instanceof P?v:new P(function(r){r(v);});}return new(P||(P=Promise))(function(r,b){function f(v){try{s(g.next(v));}catch(e){b(e);}}function d(v){try{s(g["throw"](v));}catch(e){b(e);}}function s(e){e.done?r(e.value):a(e.value).then(f,d);}s((g=g.apply(t,_||[])).next());});};var l=(this&&this.__generator)||function(a,b){var _={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1];},trys:[],ops:[]},f,y,t,g;return g={next:d(0),"throw":d(1),"return":d(2)},typeof Symbol==="function"&&(g[Symbol.iterator]=function(){return this;}),g;function d(n){return function(v){return s([n,v]);};}function s(o){if(f)throw new TypeError("Generator is already executing.");while(_)try{if(f=1,y&&(t=o[0]&2?y["return"]:o[0]?y["throw"]||((t=y["return"])&&t.call(y),0):y.next)&&!(t=t.call(y,o[1])).done)return t;if(y=0,t)o=[o[0]&2,t.value];switch(o[0]){case 0:case 1:t=o;break;case 4:_.label++;return{value:o[1],done:false};case 5:_.label++;y=o[1];o=[0];continue;case 7:o=_.ops.pop();_.trys.pop();continue;default:if(!(t=_.trys,t=t.length>0&&t[t.length-1])&&(o[0]===6||o[0]===2)){_=0;continue;}if(o[0]===3&&(!t||(o[1]>t[0]&&o[1]<t[3]))){_.label=o[1];break;}if(o[0]===6&&_.label<t[1]){_.label=t[1];t=o;break;}if(t&&_.label<t[2]){_.label=t[2];_.ops.push(o);break;}if(t[2])_.ops.pop();_.trys.pop();continue;}o=b.call(a,_);}catch(e){o=[6,e];y=0;}finally{f=t=0;}if(o[0]&5)throw o[1];return{value:o[0]?o[1]:void 0,done:true};}};sap.ui.define(["require","exports","../AbstractProvider","./FacetMode","./FederationType","./ProviderHelper","../../sina/Sina","./FederationMethod","../../core/Log","../../sina/SinaConfiguration","../abap_odata/Provider","../hana_odata/Provider","../sample/Provider","../inav2/Provider","../dummy/Provider"],function(r,e,A,F,d,P,S,f,L,g,m,n,o,p,q){"use strict";Object.defineProperty(e,"__esModule",{value:true});e.MultiProvider=void 0;var M=(function(_){c(M,_);function M(){var a=_!==null&&_.apply(this,arguments)||this;a.id="multi";return a;}M.prototype._initAsync=function(j){return h(this,void 0,void 0,function(){var k,s,t;var u=this;return l(this,function(v){switch(v.label){case 0:this.log=new L.Log("MultiProvider");this.sina=j.sina;this.facetMode=F.FacetMode[j.facetMode]||F.FacetMode.flat;this.federationType=d.FederationType[j.federationType]||d.FederationType.advanced_round_robin;this.multiSina=[];this.multiDataSourceMap={};this.sina.dataSourceMap[this.sina.allDataSource.id]=this.sina.allDataSource;this.providerHelper=new P.ProviderHelper(this);switch(this.federationType){case d.FederationType.advanced_round_robin:{this.federationMethod=new f.AdvancedRoundRobin();break;}case d.FederationType.ranking:{this.federationMethod=new f.Ranking();break;}case d.FederationType.round_robin:{this.federationMethod=new f.RoundRobin();break;}}this.sina.capabilities=this.sina._createCapabilities({fuzzy:false,});k=[];j.subProviders.forEach(function(a){var b=u.createAsync(a).then(function(w){u.providerHelper.updateProviderId(w);for(var i=0;i<w.dataSources.length;i++){var x=w.dataSources[i];var y=u.providerHelper.calculateMultiDataSourceId(x.id,w.provider.id);u.providerHelper.createMultiDataSource(y,x);u.multiDataSourceMap[y]=x;}u.multiSina.push(w);return w;});k.push(b);});s=false;return[4,Promise.allSettled(k)];case 1:t=v.sent();t.forEach(function(a){if(a.status==="rejected"){u.log.warn("Error during creation of subprovider: "+a.reason.stack);}else if(a.status==="fulfilled"){s=true;if(a.value.capabilities.fuzzy){u.sina.capabilities.fuzzy=true;}}});if(!s){this.log.error("Error during creation of multi provider: no valid subproviders");return[2,Promise.reject()];}this.sina.dataSources.sort(function(a,b){return a.label.localeCompare(b.label);});return[2,this.sina];}});});};M.prototype.createAsync=function(a){return h(this,void 0,void 0,function(){var b,i,s;return l(this,function(j){switch(j.label){case 0:this.log.debug("Creating new eshclient instance using provider "+a.provider);return[4,g._normalizeConfiguration(a)];case 1:b=j.sent();switch(b.provider){case g.AvailableProviders.HANA_ODATA:{i=new n.Provider();break;}case g.AvailableProviders.ABAP_ODATA:{i=new m.Provider();break;}case g.AvailableProviders.INAV2:{i=new p.Provider();break;}case g.AvailableProviders.MULTI:{i=new M();break;}case g.AvailableProviders.SAMPLE:{i=new o.Provider();break;}case g.AvailableProviders.DUMMY:{i=new q.Provider();break;}default:{throw new Error("Unknown Provider: '"+a.provider+"' - Available Providers: "+g.AvailableProviders.HANA_ODATA+", "+g.AvailableProviders.ABAP_ODATA+", "+g.AvailableProviders.INAV2+", "+g.AvailableProviders.MULTI+", "+g.AvailableProviders.SAMPLE+", "+g.AvailableProviders.DUMMY);}}s=new S.Sina(i);return[4,s._initAsync(b)];case 2:j.sent();return[2,s];}});});};M.prototype.executeSearchQuery=function(a){var t=this;var b;var s=[];t.searchResultSet=t.sina._createSearchResultSet({title:"Search Multi Result List",query:a,items:[],totalCount:0,facets:[],});t.searchResultSetItemList=[];if(a.filter.dataSource===t.sina.allDataSource){t.searchResultSet.facets.push(t.sina._createDataSourceResultSet({title:a.filter.dataSource.label,items:[],query:a,}));for(var i=0;i<t.multiSina.length;i++){b=t.multiSina[i].createSearchQuery({calculateFacets:a.calculateFacets,multiSelectFacets:a.multiSelectFacets,dataSource:t.multiSina[i].allDataSource,searchTerm:a.getSearchTerm(),top:a.top,skip:a.skip,sortOrder:a.sortOrder,sina:t.multiSina[i],});s.push(b.getResultSetAsync());}return Promise.all(s).then(function(y){for(var j=0;j<y.length;j++){var z=y[j];for(var k=0;k<z.items.length;k++){var B=z.items[k];var C=t.providerHelper.calculateMultiDataSourceId(B.dataSource.id,B.sina.provider.id);var D=t.sina.dataSourceMap[C];B.dataSource=D;B.sina=t.sina;}t.searchResultSet.totalCount+=z.totalCount;t.searchResultSetItemList.push(z.items);if(z.facets[0]){if(t.facetMode===F.FacetMode.tree){var E=t.sina.getDataSource(t.providerHelper.calculateMultiDataSourceId(z.query.filter.dataSource.id,z.sina.provider.id));t.searchResultSet.facets[0].items.push(t.sina._createDataSourceResultSetItem({dataSource:E,dimensionValueFormatted:t.providerHelper.calculateMultiDataSourceLabel(z.query.filter.dataSource.label,z.sina.provider),measureValue:z.totalCount,measureValueFormatted:z.totalCount,}));}else{var G=t.providerHelper.updateDataSourceFacets(z.facets);G[0].items.forEach(function(H){t.searchResultSet.facets[0].items.push(H);});}}}t.searchResultSet.items=t.federationMethod.sort(t.searchResultSetItemList);t.searchResultSet.items=t.searchResultSet.items.slice(a.skip,a.top);return t.searchResultSet;});}else if(a.filter.dataSource.id==="MyFavorites"){var u=t.sina.dataSourceMap[a.filter.dataSource.id];var v=[];t.multiSina.forEach(function(j){if(j.provider.id.startsWith("abap_odata")){var k=t.providerHelper.calculateMultiDataSourceId(u.id,j.provider.id);var y=t.multiDataSourceMap[k];if(!y){y=j.createDataSource({id:k,label:u.label,labelPlural:u.labelPlural,type:u.type,subDataSources:[],undefinedSubDataSourceIds:[],});t.multiDataSourceMap[k]=y;}else{y.subDataSources=[];}}});u.subDataSources.forEach(function(j){var w=t.multiDataSourceMap[j.id];var k=w.sina;if(k.provider.id.startsWith("abap_odata")){var y=t.providerHelper.calculateMultiDataSourceId(u.id,k.provider.id);var z=t.multiDataSourceMap[y];if(z.subDataSources.length===0){v.push(z);}z.subDataSources.push(w);}else{v.push(w);}});v.forEach(function(j){b=j.sina.createSearchQuery({calculateFacets:a.calculateFacets,multiSelectFacets:a.multiSelectFacets,dataSource:j,searchTerm:a.getSearchTerm(),top:a.top,skip:a.skip,sortOrder:a.sortOrder,sina:j.sina,});s.push(b.getResultSetAsync());});return Promise.all(s).then(function(y){t.searchResultSet.facets.push(t.sina._createDataSourceResultSet({title:a.filter.dataSource.label,items:[],query:a,}));for(var j=0;j<y.length;j++){var z=y[j];for(var k=0;k<z.items.length;k++){var B=z.items[k];var C=t.providerHelper.calculateMultiDataSourceId(B.dataSource.id,B.sina.provider.id);var D=t.sina.dataSourceMap[C];B.dataSource=D;B.sina=t.sina;}t.searchResultSet.totalCount+=z.totalCount;t.searchResultSetItemList.push(z.items);if(a.calculateFacets){var E=z.query.filter.dataSource;var G=z.sina._createDataSourceResultSet({title:E.label,items:[],query:z.query,});if(z.facets.length===0&&z.items.length>0){G.items.push(z.sina._createDataSourceResultSetItem({dataSource:E.subDataSources[0],dimensionValueFormatted:E.subDataSources[0].label,measureValue:z.totalCount,measureValueFormatted:z.totalCount,}));z.facets.push(G);}if(z.facets.length>0&&z.facets[0].type==="Chart"&&z.items.length>0){G.items.push(z.sina._createDataSourceResultSetItem({dataSource:E,dimensionValueFormatted:E.label,measureValue:z.totalCount,measureValueFormatted:z.totalCount,}));z.facets=[G];}if(z.facets.length===1&&z.facets[0].type==="DataSource"){t.providerHelper.updateDataSourceFacets(z.facets);t.searchResultSet.facets[0].items=t.searchResultSet.facets[0].items.concat(z.facets[0].items);}}}t.searchResultSet.items=t.federationMethod.sort(t.searchResultSetItemList);t.searchResultSet.items=t.searchResultSet.items.slice(a.skip,a.top);return t.searchResultSet;});}var w=t.multiDataSourceMap[a.filter.dataSource.id];var x=a.getRootCondition().clone();t.providerHelper.updateRootCondition(x,w.sina);b=w.sina.createSearchQuery({calculateFacets:a.calculateFacets,multiSelectFacets:a.multiSelectFacets,dataSource:w,searchTerm:a.getSearchTerm(),rootCondition:a.getRootCondition(),top:a.top,skip:a.skip,sortOrder:a.sortOrder,sina:w.sina,});return b.getResultSetAsync().then(function(j){t.searchResultSet.items=j.items;t.searchResultSet.totalCount=j.totalCount;for(var i=0;i<t.searchResultSet.items.length;i++){var y=t.searchResultSet.items[i];var z=t.providerHelper.calculateMultiDataSourceId(y.dataSource.id,y.sina.provider.id);t.providerHelper.updateAttributesMetadata(y.dataSource,t.sina.dataSourceMap[z]);y.dataSource=t.sina.dataSourceMap[z];y.sina=t.sina;}var B;if(j.facets.length===1&&j.facets[0].items[0].dataSource){B=j.facets;B[0].title=t.providerHelper.calculateMultiDataSourceLabel(j.facets[0].title,j.facets[0].sina.provider);t.providerHelper.updateDataSourceFacets(B);}else{B=[];for(var k=0;k<j.facets.length;k++){var C=j.facets[k];B.push(t.providerHelper.createMultiChartResultSet(C));}}t.searchResultSet.facets=B;return t.searchResultSet;});};M.prototype.executeChartQuery=function(a){var t=this;var b=t.multiDataSourceMap[a.filter.dataSource.id];var i=a.getRootCondition().clone();t.providerHelper.updateRootCondition(i,b.sina);var j=b.sina.createChartQuery({dimension:a.dimension,dataSource:b,searchTerm:a.getSearchTerm(),rootCondition:i,top:a.top,skip:a.skip,sortOrder:a.sortOrder,});return j.getResultSetAsync().then(function(k){return t.providerHelper.createMultiChartResultSet(k);});};M.prototype.executeHierarchyQuery=function(a){throw new Error("Method not implmented.");};M.prototype.executeSuggestionQuery=function(a){var t=this;var b;if(a.filter.dataSource===t.sina.allDataSource){var k=[];for(var i=0;i<t.multiSina.length;i++){b=t.multiSina[i].createSuggestionQuery({types:a.types,calculationModes:a.calculationModes,dataSource:t.multiSina[i].allDataSource,searchTerm:a.getSearchTerm(),top:a.top,skip:a.skip,sortOrder:a.sortOrder,});k.push(b.getResultSetAsync());}return Promise.allSettled(k).then(function(u){var v=t.sina._createSuggestionResultSet({title:"Multi Suggestions",query:a,items:[],});for(var j=0;j<u.length;j++){var w=u[j];if(w.status==="fulfilled"){var x=t.providerHelper.updateSuggestionDataSource(w.value);v.items=new f.RoundRobin().mergeMultiResults(v.items,x.items,j+1);}}return v;});}var s=t.multiDataSourceMap[a.filter.dataSource.id];b=s.sina.createSuggestionQuery({types:a.types,calculationModes:a.calculationModes,dataSource:s,searchTerm:a.getSearchTerm(),top:a.top,skip:a.skip,sortOrder:a.sortOrder,});return b.getResultSetAsync().then(function(j){return t.providerHelper.updateSuggestionDataSource(j);});};return M;}(A.AbstractProvider));e.MultiProvider=M;});})();
