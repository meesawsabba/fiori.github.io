/*! 
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	 
 */
(function(){var _=(this&&this.__extends)||(function(){var e=function(d,b){e=Object.setPrototypeOf||({__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b;})||function(d,b){for(var p in b)if(Object.prototype.hasOwnProperty.call(b,p))d[p]=b[p];};return e(d,b);};return function(d,b){if(typeof b!=="function"&&b!==null)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");e(d,b);function a(){this.constructor=d;}d.prototype=b===null?Object.create(b):(a.prototype=b.prototype,new a());};})();sap.ui.define(["require","exports","./labelCalculation","../../sina/SinaObject","../../sina/MatchingStrategy","../../sina/AttributeType","../../sina/AttributeFormatType","../../core/errors"],function(r,a,l,S,M,A,b,c){"use strict";Object.defineProperty(a,"__esModule",{value:true});a.MetadataParser=void 0;var d=(function(f){_(d,f);function d(p){var e=f.call(this)||this;e._provider=p;e._sina=p.sina;e._labelCalculator=l.createLabelCalculator();e._appSearchDataSource=undefined;return e;}d.prototype.getAppSearchDataSource=function(){return this._appSearchDataSource;};d.prototype.parseDataSourceData=function(e,s){for(var i=0;i<e.length;++i){var g=e[i];var h=g.Name;if(!h){h=g.Id;}var j=g.NamePlural;if(!j){j=h;}var k=this._sina._createDataSource({id:g.Id,label:h,labelPlural:j,type:this._sina.DataSourceType.BusinessObject,usage:g.Id.endsWith("TRANSACTIONS~")?{appSearch:{},}:{},attributesMetadata:[{id:"dummy",},],});k._private.system=g.SourceSystem;k._private.client=g.SourceClient;k._private.semanticObjectType=g.SemanticObjectTypeId;k._private.annotations=(g.Annotations&&g.Annotations.results)||[];this._labelCalculator.calculateLabel(k);this._fillMetadataBufferForDataSource(k,g.Attributes.results);s.registerObjectType({type:k.id,label:k.label,properties:k.attributesMetadata,});if(k.id.endsWith("TRANSACTIONS~")&&this._appSearchDataSource===undefined){this._appSearchDataSource=k;}}};d.prototype._fillMetadataBufferForDataSource=function(e,g){if(e.attributesMetadata[0].id!=="dummy"){return;}e.attributesMetadata=[];e.attributeMetadataMap={};var i;var t=[];var h=[];var j=[];var k=[];var m;var n={dataSourceAnnotations:{},attributeAnnotations:{},};n.dataSourceAnnotations=this._parseAnnotationsIntoJsonStructure(e._private.annotations);for(i=0;i<g.length;i++){m=g[i];var p=this._fillMetadataBufferForAttribute(e,m);var o=(m.Annotations&&m.Annotations.results)||[];var q=this._parseAnnotationsIntoJsonStructure(o);n.attributeAnnotations[p.id.toUpperCase()]=q;this._parseSemanticsAnnotation(m,q);if(p._private.temporaryUsage.Title!==undefined){t.push(p);}if(p._private.temporaryUsage.Detail!==undefined){if(m.isSummary){h.push(p);}else{j.push(p);}}}var s=this._sina._createCDSAnnotationsParser({dataSource:e,cdsAnnotations:n,});var u=s.parseCDSAnnotationsForDataSource();if(!u.dataSourceIsCdsBased){this._sortAttributesOfNonCDSBasedDataSource(e,t,k,h,j);}for(i=0;i<e.attributesMetadata.length;i++){m=e.attributesMetadata[i];if(m._private.temporaryUsage){for(var v in m._private.temporaryUsage){if(v!="Title"&&v!="Detail"){m.usage[v]=m._private.temporaryUsage[v];}}}}};d.prototype._fillMetadataBufferForAttribute=function(e,g){var h=g.Displayed&&g.DisplayOrder?g.DisplayOrder:-1;var t=this._parseAttributeTypeAndFormat(g);var p=this._sina._createAttributeMetadata({id:g.Id,label:g.Name!==""?g.Name:g.Id,isKey:g.Key,isSortable:g.Sortable,usage:{},type:t.type,format:t.format,matchingStrategy:this._parseMatchingStrategy(g),});p._private.semanticObjectType=g.SemanticObjectTypeId;p._private.temporaryUsage=g.UIAreas?this._parseUsage(g,h):{};e.attributesMetadata.push(p);e.attributeMetadataMap[p.id]=p;return p;};d.prototype._parseSemanticsAnnotation=function(e,g){var h=false;var s="SEMANTICS";for(var i in g){if(i.substr(0,s.length)==s){h=true;break;}}if(e.Semantics&&!h){var j=void 0;switch(e.Semantics){case"EMAIL.ADDRESS":case"TELEPHONE.TYPE":case"CURRENCYCODE":case"UNITOFMEASURE":j="TRUE";break;case"QUANTITY.UNITOFMEASURE":case"AMOUNT.CURRENCYCODE":j=e.UnitAttribute;break;}if(j){g[s+e.Semantics]=j;}}};d.prototype._sortAttributesOfNonCDSBasedDataSource=function(e,t,g,h,j){var i,k;t.sort(this._createSortFunction("Title"));for(i=0;i<t.length;++i){var m=t[i].id;k=e.getAttributeMetadata(m);k.usage.Title=k._private.temporaryUsage.Title;k.usage.Title.displayOrder=i;}var s=this._createSortFunction("Detail");h.sort(s);j.sort(s);g.push.apply(g,h);g.push.apply(g,j);for(i=0;i<g.length;++i){g[i].usage.Detail=g[i]._private.temporaryUsage.Detail;g[i].usage.Detail.displayOrder=i;}};d.prototype._arrayIncludesEntry=function(e,g,h){var i;if(h){for(i=0;i<e.length;i++){if(h(e[i],g)){return true;}}}else{for(i=0;i<e.length;i++){if(e[i]==g){return true;}}}return false;};d.prototype._parseAnnotationsIntoJsonStructure=function(g){if(g.length==0){return{};}var i,j;var p={};var h,k;var m,n;var o;var q=[];var s;var t=function(B,C){return(B.annotationPointer==C.annotationPointer&&B.annotationName==C.annotationName);};try{for(j=0;j<g.length;j++){h=/\[\d+\]$/g;n=p;o=g[j].Name.split(".");for(i=0;i<o.length;i++){m=o[i].toUpperCase();k=h.exec(m);if(k!==null){m=m.substring(0,k.index);}n[m]=n[m]||{};if(k!==null&&k[0].length>0){s={annotationPointer:n,annotationName:m,};if(!this._arrayIncludesEntry(q,s,t)){q.push(s);}if(i<o.length-1){n[m][k[0]]=n[m][k[0]]||{};n=n[m][k[0]];}else{n[m][k[0]]=g[j].Value;}}else if(i<o.length-1){n=n[m];}else{n[m]=g[j].Value;}}}var u=void 0;var v=void 0;var w=void 0,x=void 0,y=void 0;var z=/\[\d+\]/g;for(j=0;j<q.length;j++){u=q[j].annotationPointer;m=q[j].annotationName;v=u[m];w=[];y={};for(x in v){if(x.match(z)){w.push(v[x]);}else{y[x]=v[x];}}if(Object.keys(y).length>0){w.push(y);}u[m]=w;}}catch(e){return{};}return p;};d.prototype._createSortFunction=function(u){return function(e,g){if(e._private.temporaryUsage[u].displayOrder<g._private.temporaryUsage[u].displayOrder){return-1;}else if(e._private.temporaryUsage[u].displayOrder>g._private.temporaryUsage[u].displayOrder){return 1;}return 0;};};d.prototype._parseMatchingStrategy=function(e){if(e.TextIndexed){return M.MatchingStrategy.Text;}return M.MatchingStrategy.Exact;};d.prototype._parseAttributeTypeAndFormat=function(e){for(var i=0;i<e.UIAreas.results.length;i++){var p=e.UIAreas.results[i];var g=p.Id;switch(g){case"SUMMARY":continue;case"DETAILS":continue;case"TITLE":continue;case"#HIDDEN":case"HIDDEN":continue;case"FACTSHEET":continue;case"DETAILIMAGE":case"PREVIEWIMAGE":return{type:A.AttributeType.ImageUrl,};case"LONGTEXT":return{type:A.AttributeType.String,format:b.AttributeFormatType.LongText,};default:throw new c.UnknownPresentationUsageError("Unknown presentation usage "+p);}}switch(e.EDMType){case"Edm.String":case"Edm.Binary":case"Edm.Boolean":case"Edm.Byte":case"Edm.Guid":return{type:A.AttributeType.String,};case"Edm.Double":case"Edm.Decimal":case"Edm.Float":return{type:A.AttributeType.Double,};case"Edm.Int16":case"Edm.Int32":case"Edm.Int64":return{type:A.AttributeType.Integer,};case"Edm.Time":return{type:A.AttributeType.Time,};case"Edm.DateTime":if(e.TypeLength>8){return{type:A.AttributeType.Timestamp,};}return{type:A.AttributeType.Date,};case"GeoJson":return{type:A.AttributeType.GeoJson,};default:throw new c.UnknownDataTypeError("Unknown data type "+e.EDMType);}};d.prototype._parseUsage=function(e,g){var u=e.UIAreas.results;var h=e.AdvancedSearchRelevant;var i=e.Facet;var j={};u.forEach(function(k){var m=k.Id;if(m==="TITLE"){j.Title={displayOrder:g,};}if(m==="SUMMARY"||m==="DETAILIMAGE"||m==="PREVIEWIMAGE"){e.isSummary=true;j.Detail={displayOrder:g,};}if(m==="DETAILS"||m==="LONGTEXT"){j.Detail={displayOrder:g,};}});if(h){j.AdvancedSearch={};}if(i){j.Facet={};}return j;};d.prototype.parseDynamicMetadata=function(s){var g;try{g=s.ResultList.SearchResults.results;}catch(e){return;}for(var i=0;i<g.length;++i){var h=g[i];if(!h.HitAttributes||!h.HitAttributes.results){continue;}var k=this._sina.getDataSource(h.DataSourceId);var m=h.HitAttributes.results;for(var j=0;j<m.length;++j){var n=m[j];this.parseDynamicAtributeMetadata(k,n);}}};d.prototype.parseDynamicAtributeMetadata=function(e,g){var t;var m=e.getAttributeMetadata(g.Id);if(m){if(!m._private.dynamic){return;}g.UIAreas=g.UIAreas||{results:[],};t=this._parseAttributeTypeAndFormat(g);m.label=g.Name;m.type=t.type;m.format=t.format;}else{g.UIAreas=g.UIAreas||{results:[],};t=this._parseAttributeTypeAndFormat(g);m=this._sina._createAttributeMetadata({id:g.Id,label:g.Name,isKey:false,isSortable:false,usage:{},type:t.type,format:t.format,matchingStrategy:M.MatchingStrategy.Exact,_private:{dynamic:true,},});e.attributesMetadata.push(m);e.attributeMetadataMap[m.id]=m;}};return d;}(S.SinaObject));a.MetadataParser=d;});})();
