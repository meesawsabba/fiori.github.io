/*! 
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	 
 */
(function(){var c=(this&&this.__extends)||(function(){var e=function(d,b){e=Object.setPrototypeOf||({__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b;})||function(d,b){for(var p in b)if(Object.prototype.hasOwnProperty.call(b,p))d[p]=b[p];};return e(d,b);};return function(d,b){if(typeof b!=="function"&&b!==null)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");e(d,b);function _(){this.constructor=d;}d.prototype=b===null?Object.create(b):(_.prototype=b.prototype,new _());};})();var h=(this&&this.__awaiter)||function(t,_,P,g){function a(v){return v instanceof P?v:new P(function(r){r(v);});}return new(P||(P=Promise))(function(r,b){function f(v){try{s(g.next(v));}catch(e){b(e);}}function d(v){try{s(g["throw"](v));}catch(e){b(e);}}function s(e){e.done?r(e.value):a(e.value).then(f,d);}s((g=g.apply(t,_||[])).next());});};var l=(this&&this.__generator)||function(a,b){var _={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1];},trys:[],ops:[]},f,y,t,g;return g={next:d(0),"throw":d(1),"return":d(2)},typeof Symbol==="function"&&(g[Symbol.iterator]=function(){return this;}),g;function d(n){return function(v){return s([n,v]);};}function s(o){if(f)throw new TypeError("Generator is already executing.");while(_)try{if(f=1,y&&(t=o[0]&2?y["return"]:o[0]?y["throw"]||((t=y["return"])&&t.call(y),0):y.next)&&!(t=t.call(y,o[1])).done)return t;if(y=0,t)o=[o[0]&2,t.value];switch(o[0]){case 0:case 1:t=o;break;case 4:_.label++;return{value:o[1],done:false};case 5:_.label++;y=o[1];o=[0];continue;case 7:o=_.ops.pop();_.trys.pop();continue;default:if(!(t=_.trys,t=t.length>0&&t[t.length-1])&&(o[0]===6||o[0]===2)){_=0;continue;}if(o[0]===3&&(!t||(o[1]>t[0]&&o[1]<t[3]))){_.label=o[1];break;}if(o[0]===6&&_.label<t[1]){_.label=t[1];t=o;break;}if(t&&_.label<t[2]){_.label=t[2];_.ops.push(o);break;}if(t[2])_.ops.pop();_.trys.pop();continue;}o=b.call(a,_);}catch(e){o=[6,e];y=0;}finally{f=t=0;}if(o[0]&5)throw o[1];return{value:o[0]?o[1]:void 0,done:true};}};sap.ui.define(["require","exports","../core/core","./Query","./EqualsMode","./ConditionType","./DataSourceType","../core/errors"],function(r,e,d,Q,E,C,D,f){"use strict";Object.defineProperty(e,"__esModule",{value:true});e.SearchQuery=void 0;var S=(function(_){c(S,_);function S(p){var a,b,g,i,j;var k=_.call(this,p)||this;k.calculateFacets=false;k.multiSelectFacets=false;k.nlq=false;k.facetTop=5;k.calculateFacets=(a=p.calculateFacets)!==null&&a!==void 0?a:k.calculateFacets;k.multiSelectFacets=(b=p.multiSelectFacets)!==null&&b!==void 0?b:k.multiSelectFacets;k.nlq=(g=p.nlq)!==null&&g!==void 0?g:k.nlq;k.facetTop=(i=p.facetTop)!==null&&i!==void 0?i:k.facetTop;k.groupBy=(j=p.groupBy)!==null&&j!==void 0?j:k.groupBy;return k;}S.prototype.setCalculateFacets=function(a){if(a===void 0){a=false;}this.calculateFacets=a;};S.prototype.setMultiSelectFacets=function(m){if(m===void 0){m=false;}this.multiSelectFacets=m;};S.prototype.setNlq=function(n){if(n===void 0){n=false;}this.nlq=n;};S.prototype.setFacetTop=function(a){if(a===void 0){a=5;}this.facetTop=a;};S.prototype._createReadOnlyClone=function(){var q=this.clone();q.getResultSetAsync=function(){throw new f.QueryIsReadOnlyError("this query is readonly");};return q;};S.prototype.clone=function(){var a=new S({skip:this.skip,top:this.top,filter:this.filter.clone(),sortOrder:this.sortOrder,sina:this.sina,groupBy:this.groupBy,calculateFacets:this.calculateFacets,multiSelectFacets:this.multiSelectFacets,nlq:this.nlq,facetTop:this.facetTop,});return a;};S.prototype.equals=function(o,m){if(m===void 0){m=E.EqualsMode.CheckFireQuery;}if(!(o instanceof S)){return false;}if(!o){return false;}if(!_.prototype.equals.call(this,o)){return false;}if(this.groupBy!==o.groupBy){return false;}if(this.nlq!==o.nlq){return false;}if(this.multiSelectFacets!==o.multiSelectFacets){return false;}if(this.facetTop!==o.facetTop){return false;}switch(m){case E.EqualsMode.CheckFireQuery:if(o.calculateFacets&&!this.calculateFacets){return true;}return this.calculateFacets===o.calculateFacets;default:return this.calculateFacets===o.calculateFacets;}};S.prototype._execute=function(q){return h(this,void 0,void 0,function(){var a,b,g,k,i,m,n,o,p,j,s,n,t,u,v;return l(this,function(w){switch(w.label){case 0:b=[];if(this.multiSelectFacets){a=this._collectAttributesWithFilter(q);b=this._createChartQueries(q,a);}g=[];k=[];g.push(this._doExecuteSearchQuery(q));for(i=0;i<b.length;++i){m=b[i];n=q.filter.dataSource.getAttributeMetadata(m.dimension);if(!n){k.push(m);}else{if(n.usage.Facet){g.push(m.getResultSetAsync());}}}return[4,Promise.all(g)];case 1:o=w.sent();p=[];for(j=0;j<k.length;++j){s=k[j];n=q.filter.dataSource.getAttributeMetadata(s.dimension);if(n.usage.Facet){p.push(s.getResultSetAsync());}}return[4,Promise.all(p)];case 2:t=w.sent();o=o.concat(t);u=o[0];v=o.slice(1);this._mergeFacetsToSearchResultSet(u,v);return[2,u];}});});};S.prototype._doExecuteSearchQuery=function(q){return h(this,void 0,void 0,function(){var t,a;return l(this,function(b){switch(b.label){case 0:t=this._filteredQueryTransform(q);return[4,this.sina.provider.executeSearchQuery(t)];case 1:a=b.sent();return[2,this._filteredQueryBackTransform(q,a)];}});});};S.prototype._filteredQueryTransform=function(q){return this._genericFilteredQueryTransform(q);};S.prototype._filteredQueryBackTransform=function(q,a){if(q.filter.dataSource.type!==D.DataSourceType.BusinessObject||q.filter.dataSource.subType!==D.DataSourceSubType.Filtered){return a;}a.query=q;for(var b=0,g=a.facets;b<g.length;b++){var i=g[b];i.query.filter=q.filter.clone();}return a;};S.prototype._formatResultSetAsync=function(a){return h(this,void 0,void 0,function(){return l(this,function(b){return[2,d.executeSequentialAsync(this.sina.searchResultSetFormatters,function(g){return g.formatAsync(a);})];});});};S.prototype._collectAttributesWithFilter=function(q){var a={};this._doCollectAttributes(a,q.filter.rootCondition);var b=Object.keys(a);return b.filter(function(g){var i=q.filter.dataSource.getAttributeMetadata(g);if(!i){return true;}return!i.isHierarchy;});};S.prototype._doCollectAttributes=function(a,b){switch(b.type){case C.ConditionType.Simple:a[b.attribute]=true;break;case C.ConditionType.Complex:for(var i=0;i<b.conditions.length;++i){var s=b.conditions[i];this._doCollectAttributes(a,s);}break;}};S.prototype._createChartQuery=function(q,a){var b=this.sina.createChartQuery({dimension:a,top:this.facetTop,});b.setFilter(q.filter.clone());b.filter.rootCondition.removeAttributeConditions(a);return b;};S.prototype._createChartQueries=function(q,a){var b=[];for(var i=0;i<a.length;++i){var g=a[i];var j=this._createChartQuery(q,g);b.push(j);}return b;};S.prototype._mergeFacetsToSearchResultSet=function(s,a){this._addSelectedFiltersToSearchResultSet(s);for(var i=0;i<a.length;++i){var b=a[i];this._addChartResultSetToSearchResultSet(s,b);}};S.prototype._calculateFacetTitle=function(a,b){var g=a._getAttribute();var i=b.getAttributeMetadata(g);return i.label;};S.prototype._addSelectedFiltersToSearchResultSet=function(s){var a=s.query.filter.dataSource;var b=s.query.filter.rootCondition;for(var j=0;j<b.conditions.length;j++){var g=b.conditions[j].conditions;var i=this._calculateFacetTitle(g[0],s.query.filter.dataSource);var m=void 0;switch(g[0].type){case C.ConditionType.Simple:m=g[0].attribute;break;case C.ConditionType.Complex:m=g[0].conditions[0].attribute;break;}var n=a.getAttributeMetadata(m);if(n.isHierarchy){continue;}var o=this._findMatchFacet(m,s.facets);var p=s.facets[o];if(!p){var q=this._createChartQuery(s.query,m);p=this.sina._createChartResultSet({title:i,items:[],query:q,});s.facets.splice(o,1,p);}var t=null;if(g.length===1){t=s.totalCount;}var u=[];for(var k=0;k<g.length;k++){var v=void 0;if(this._findFilterConditionInFacetItemList(g[k],p.items)>=0){v=this._findFilterConditionInFacetItemList(g[k],p.items);u.push(p.items[v]);}else{u.push(this.sina._createChartResultSetItem({filterCondition:g[k],dimensionValueFormatted:g[k].valueLabel||g[k].value,measureValue:t,measureValueFormatted:g[k].valueLabel||g[k].value,}));}}p.items=u;}};S.prototype._addChartResultSetToSearchResultSet=function(s,g){if(g.items.length===0){return;}var i=g.query.dimension;var j=this._findMatchFacet(i,s.facets);var k=s.facets[j];var n=k.items;var o=false;var p=[];for(var m=0;m<n.length;m++){var q=this._findFilterConditionInFacetItemList(n[m].filterCondition,g.items);if(q>=0){if(this._isRangeFacet(g.query)){p.push(g.items[q]);}}else{if(this._isRangeFacet(g.query)){o=true;}p.push(n[m]);}}p.sort(function(a,b){return b.measureValue-a.measureValue;});if(this._isRangeFacet(g.query)){if(o){g.items=p;}}else{g.items=g.items.concat(p);}s.facets.splice(j,1,g);};S.prototype._findMatchFacet=function(a,b){var i=0;for(;i<b.length;i++){var g=b[i];if(g.query.dimension===a){break;}}return i;};S.prototype._findFilterConditionInFacetItemList=function(a,b){var g=-1;for(var i=0;i<b.length;i++){var j=b[i];if(a.equals(j.filterCondition)){g=i;break;}}return g;};S.prototype._isRangeFacet=function(q){var a=q.filter.dataSource.getAttributeMetadata(q.dimension);if(a.type===q.sina.AttributeType.Double){return true;}return false;};return S;}(Q.Query));e.SearchQuery=S;});})();
