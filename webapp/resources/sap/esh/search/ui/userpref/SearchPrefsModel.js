/*!
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	
 */
sap.ui.define(["../i18n","sap/ui/model/json/JSONModel"],function(i,J){"use strict";var p="sap.esh.search.ui.userpref.SearchPrefsModel";return J.extend(p,{asyncInit:function(){var t=this;if(t.initializePromise){return t.initializePromise;}t.searchModel=sap.esh.search.ui.getModelSingleton({},"flp");t.initializePromise=t.searchModel.initBusinessObjSearch().then(function(){if(!t.searchModel.config.searchBusinessObjects){t.setProperty("/isSearchPrefsActive",false);t.setProperty("/isPersonalizedSearchEditable",false);t.setProperty("/personalizedSearch",false);t.setProperty("/resetButtonWasClicked",false);return undefined;}t.setProperty("/isSearchPrefsActive",true);t.setProperty("/userDefinedDatasources",t.searchModel.config.userDefinedDatasources);var s=t.searchModel.sinaNext;if(t.searchModel.config.userDefinedDatasources){t.initSubDataSources();}return s.getConfigurationAsync({forceReload:true,}).then(function(c){t.configuration=c;t.setProperty("/isPersonalizedSearchEditable",c.isPersonalizedSearchEditable);t.setProperty("/personalizedSearch",c.personalizedSearch);t.setProperty("/resetButtonWasClicked",false);});});return t.initializePromise;},reload:function(){this.initializePromise=false;return this.asyncInit();},initSubDataSources:function(){var n=[];this.searchModel.getUserCategoryManager().then(function(u){this.userCategoryManager=u;this.userCategory=u.getCategory("MyFavorites");var d=this.searchModel.sinaNext.dataSources;for(var _=0,a=d;_<a.length;_++){var b=a[_];if(b.type!==this.searchModel.sinaNext.DataSourceType.BusinessObject){continue;}n.push({id:b.id,label:b.labelPlural,selected:this.userCategory.hasSubDataSource(b.id),undefined:false,});}var c=this.userCategory.getUndefinedSubDataSourceIds().reverse();for(var e=0,f=c;e<f.length;e++){var g=f[e];n.unshift({id:g,label:g+" "+i.getText("sp.connectorNotExists"),selected:true,undefined:true,});}this.setProperty("/favActive",this.userCategoryManager.isFavActive());this.setProperty("/subDataSources",n);this.setProperty("/dataSourceCount",this.getNumberSubDataSources());this.setProperty("/selectedDataSourceCount",this.getNumberSelectedSubDataSources());}.bind(this));},getNumberSubDataSources:function(){return this.getProperty("/subDataSources").length;},getNumberSelectedSubDataSources:function(){return this.getProperty("/subDataSources").filter(function(x){return x.selected;}).length;},saveSubDataSources:function(){var s=this.getProperty("/subDataSources");this.userCategoryManager.setFavActive(this.getProperty("/favActive"));this.userCategory.clearSubDataSources();this.userCategory.clearUndefinedSubDataSourceIds();for(var _=0,a=s;_<a.length;_++){var b=a[_];if(b.selected===true){var c=this.userCategoryManager.sina.getDataSource(b.id);if(c){this.userCategory.addSubDataSource(c);}else{this.userCategory.addUndefinedSubDataSourceId(b.id);}}}this.userCategoryManager.save();},shortStatus:function(){return this.asyncInit().then(function(){return this.getProperty("/personalizedSearch")?i.getText("sp.on"):i.getText("sp.off");}.bind(this));},isPersonalizedSearchActive:function(){return this.asyncInit().then(function(){return this.getProperty("/personalizedSearch");}.bind(this));},isSearchPrefsActive:function(){return this.asyncInit().then(function(){return this.getProperty("/isSearchPrefsActive");}.bind(this));},isMultiProvider:function(){return this.asyncInit().then(function(){return this.searchModel.sinaNext.provider.id==="multi";}.bind(this));},savePreferences:function(){if(this.searchModel.config.userDefinedDatasources){this.saveSubDataSources();}this.configuration.setPersonalizedSearch(this.getProperty("/personalizedSearch"));return this.configuration.saveAsync().then(function(){this.setProperty("/resetButtonWasClicked",false);}.bind(this));},cancelPreferences:function(){this.setProperty("/personalizedSearch",this.configuration.personalizedSearch);this.setProperty("/resetButtonWasClicked",false);},resetProfile:function(){return this.configuration.resetPersonalizedSearchDataAsync().then(function(){this.setProperty("/resetButtonWasClicked",true);}.bind(this));},});});
