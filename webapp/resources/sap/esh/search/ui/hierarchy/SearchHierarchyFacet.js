/*!
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	
 */
sap.ui.define(["./SearchHierarchyNode","./StructureTree"],function(S,a){var r="$$ROOT$$";var F=function(){this.init.apply(this,arguments);};F.prototype={init:function(p){this.model=p.model;this.sina=p.sina;this.dataSource=p.dataSource;this.attributeId=p.attributeId;this.dimension=this.attributeId;this.title=p.title;this.filter=p.filter;this.facetType="hierarchy";this.nodeMap={};this.node=this.createNode({id:r,expanded:true});this.facetIndex=-1;this.structureTree=new a({rootNode:{id:r,label:"root"}});this.notDisplayedFilterConditions=[];},updateStructureTree:function(s){this.structureTree.update(s);},createNode:function(p){p.facet=this;var n=S.createNode(p);this.nodeMap[n.id]=n;return n;},refreshUI:function(){this.model.setProperty("/facets/"+this.facetIndex,this);},activateFilters:function(){this.model._firePerspectiveQuery({preserveFormerResults:false,});this.model.notifyFilterChanged();},updateFromServer:function(){return this.node.updateFromServer().then(function(){return this;}.bind(this));},updateFromResultSet:function(b){this.node.update(b.node);this.updateStructureTree(b.node);return Promise.resolve(this);},getComplexConditionOfFacet:function(){for(var i=0;i<this.filter.rootCondition.conditions.length;++i){var c=this.filter.rootCondition.conditions[i];if(c.containsAttribute(this.attributeId)){return c;}}return null;},getFilterConditions:function(){var f=[];var c=this.getComplexConditionOfFacet();if(!c){return f;}for(var i=0;i<c.conditions.length;++i){var b=c.conditions[i];f.push(b);}return f;},mixinFilterNodes:function(){this.node.hasFilter=false;this.node.visitChildNodesRecursively(function(d){d.hasFilter=false;});var n;var b=[];var f=this.getFilterConditions();for(var i=0;i<f.length;++i){var c=f[i];n=c.value;var d=this.nodeMap[n];if(d){d.hasFilter=true;}else{b.push(c);}}for(var j=0;j<b.length;++j){var e=b[j];n=e.value;if(this.addMissingFilterNode(n)){b.splice(j,1);j--;}}this.notDisplayedFilterConditions=b;this.calculateCheckboxStatus();},addMissingFilterNode:function(i){var g=function(s){var t=this.nodeMap[s.id];if(t){if(t.isVisible()){return t;}else{return false;}}if(!s.parentNode){throw new Error("program error parent node missing for "+s.id);}var p=g(s.parentNode);if(!p||!p.expanded){return false;}t=this.createNode({id:s.id,label:s.label,expanded:true,});p.addChildNode(t);return t;}.bind(this);var s=this.structureTree.getNode(i);if(!s){return false;}var t=g(s);if(!t){return false;}t.hasFilter=true;return true;},calculateCheckboxStatus:function(){this.node.selected=false;this.node.partiallySelected=false;this.node.visitChildNodesRecursively(function(n){n.selected=false;n.partiallySelected=false;});var l=[];if(!this.node.hasChildNodes()){l.push(this);}this.node.visitChildNodesRecursively(function(n){if(!n.hasChildNodes()){l.push(n);}});for(var i=0;i<l.length;++i){var b=l[i];this.calculateCheckboxStatusFromLeafNode(b);}},calculateCheckboxStatusFromLeafNode:function(l){var n=l;var m=false;while(n){if(n.selected&&n.partiallySelected){return;}if(n.hasFilter){n.selected=true;n.partiallySelected=false;m=true;}else{if(m){n.selected=true;n.partiallySelected=true;}}n=n.getParentNode();}},};return F;});
