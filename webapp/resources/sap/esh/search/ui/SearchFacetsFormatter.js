/*!
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	
 */
sap.ui.define(["./error/ErrorHandler","./hierarchy/SearchHierarchyFacetsFormatter","./Facet","./FacetItem"],function(E,S,F,c){"use strict";var d=function(){this.init.apply(this,arguments);};d.prototype={init:function(m){this.model=m;this.errorHandler=new E({model:m,});this.hierarchyFacetsFormatter=new S(m);},_getAncestorDataSources:function(s){var r=[];var a=s.dataSourceTree.findNode(s.getProperty("/uiFilter/dataSource")).getAncestors().reverse();for(var i=0;i<a.length;i++){var b=a[i].dataSource;var e=new c({label:b.labelPlural,icon:b.icon||"sap-icon://none",filterCondition:b,level:0,value:a[i].count,});r.push(e);}return r;},_getSiblingDataSources:function(s,l){var a=[];var b=s.getProperty("/uiFilter/dataSource");var e=s.dataSourceTree.findNode(b);var f;if(e.parent&&!e.unsureWhetherNodeisBelowRoot){f=e.parent.getChildren();}else{f=[];}if(f.length===0){f.push(e);}for(var j=0,g=f.length;j<g;j++){var h=f[j].dataSource;var i=new c({label:h.labelPlural,icon:h.icon||"sap-icon://none",value:f[j].count,filterCondition:h,selected:b===h,level:l,});a.push(i);if(i.selected){a.push.apply(a,this._getChildrenDataSources(s,l+1));}}return a;},_getChildrenDataSources:function(s,l){var C=[];var a=s.getProperty("/uiFilter/dataSource");var b=s.dataSourceTree.findNode(a).getChildren();for(var j=0,e=b.length;j<e;j++){var f=b[j].dataSource;var g=new c({label:f.labelPlural,icon:f.icon||"sap-icon://none",value:b[j].count,filterCondition:f,selected:false,level:l,});C.push(g);}return C;},getDataSourceFacetFromTree:function(s){var D=new F({facetType:"datasource",title:"Search In",});var a=s.getProperty("/uiFilter/dataSource");var A=this._getAncestorDataSources(s);D.items.push.apply(D.items,A);var b=this._getSiblingDataSources(s,s.allDataSource===a?0:1);D.items.push.apply(D.items,b);return D;},_createFacetItemsFromConditionGroup:function(a,r){var f=[];for(var i=0;i<r.conditions.length;i++){var b=r.conditions[i];for(var j=0;j<b.conditions.length;j++){var e=b.conditions[j];var g;if(e.type===this.model.sinaNext.ConditionType.Simple){g=e.attribute;if(a.getAttributeMetadata(g).isHierarchy){continue;}f.push(new c({facetAttribute:g,label:this._formatLabel(e.valueLabel,e.operator),filterCondition:e,selected:true,}));}else{g=e.conditions[0].attribute;if(a.getAttributeMetadata(g).isHierarchy){continue;}f.push(new c({facetAttribute:g,label:e.valueLabel,filterCondition:e,selected:true,}));}}}return f;},_formatLabel:function(l,o){var a;switch(o){case"Bw":a=l+"*";break;case"Ew":a="*"+l;break;case"Co":a="*"+l+"*";break;default:a=l;break;}return a;},getAttributeFacetsFromPerspective:function(r,s){var D=s.getDataSource();if(D.type===s.sinaNext.DataSourceType.Category){return Promise.resolve([]);}var a=r.facets.filter(function(G){return G&&G.type&&G.type===s.sinaNext.FacetType.Chart;});var C=[];var b={};for(var i=0,l=a.length;i<l;i++){var o=a[i];var e=new F({title:o.title,facetType:"attribute",dimension:o.query.dimension,totalCount:r.totalCount,});if(o.items.length===0){continue;}for(var j=0;j<o.items.length;j++){var f=o.items[j];var g="";if(typeof s.config.checkAndSetSpaceIcon==="function"){g=s.config.checkAndSetSpaceIcon(f.icon,o.query.dimension);}else{g=f.icon;}var h=new c({facetAttribute:o.query.dimension,label:this._formatLabel(f.dimensionValueFormatted,f.filterCondition.operator),value:f.measureValue,filterCondition:f.filterCondition,icon:g,});h.facetTitle=o.title;h.serverSideItem=true;e.items.push(h);}b[o.query.dimension]=e;C.push(e);}this.addDataTypeToClientSideFacets(C,s);var p={};var q=this._createFacetItemsFromConditionGroup(D,s.getProperty("/uiFilter/rootCondition"));for(var k=0,t=q.length;k<t;k++){var u=q[k];var v=b[u.facetAttribute];if(v){var w=C.indexOf(v);if(w>0){C.splice(w,1);C.splice(0,0,v);}for(var m=0,x=v.items.length;m<x;m++){var y=v.items[m];if(u.filterCondition.equals(y.filterCondition)){y.selected=true;if(!s.config.multiSelect){y.value=null;y.valueLabel=null;}}}}p[u.facetAttribute]=v;}if(!s.config.multiSelect){for(var z in p){if(typeof p["facetAttribute"]!=="undefined"){var A=p[z];for(var n=A.items.length-1;n>=0;n--){var B=A.items[n];if(!B.selected){A.items.splice(n,1);}}}}}return Promise.resolve(C);},addDataTypeToClientSideFacets:function(C,s){var D=s.getDataSource();for(var i=0;i<C.length;i++){var f=C[i];try{var m=D.getAttributeMetadata(f.dimension);f.dataType=m.type;}catch(e){this.errorHandler.onError(e);}}},addQuickSelectDataSourceFacet:function(m,f){if(m.config.quickSelectDataSources.length>0){var a=[];for(var i=0;i<m.config.quickSelectDataSources.length;++i){var b=m.config.quickSelectDataSources[i];var e={dataSource:b,};a.push(e);}f.push({facetType:"quickSelectDataSource",items:a,});}},getFacets:function(D,i,s){var f=[this.getDataSourceFacetFromTree(s)];this.addQuickSelectDataSourceFacet(s,f);if(D===s.appDataSource||D.type===s.sinaNext.DataSourceType.Category){return Promise.resolve(f);}if(!i){return Promise.resolve(f);}var a=[];return this.hierarchyFacetsFormatter.getFacets(i,s).then(function(h){a.push.apply(a,h);return this.getAttributeFacetsFromPerspective(i,s);}.bind(this)).then(function(b){a.push.apply(a,b);this.sortFacets(a,s);f.push.apply(f,a);this.setFacetIndex(f);return f;}.bind(this));},setFacetIndex:function(f){for(var i=0;i<f.length;++i){var a=f[i];a.facetIndex=i;}},sortFacets:function(A,s){if(A.length===0){return A;}var C=function(a,b){if(a.position<b.position){return-1;}if(a.position>b.position){return 1;}return 0;};for(var i=0;i<A.length;i++){var e=A[i];if(s.config.searchInAttibuteFacetPostion){e.position=s.config.searchInAttibuteFacetPostion[e.dimension]||i+1000;}else{e.position=i+1000;}}A.sort(C);return A;},getDialogFacetsFromMetaData:function(m,s){var e=jQuery.map(m.attributeMetadataMap,function(a){return a;});var C=[];for(var i=0,l=e.length;i<l;i++){var o=e[i];if(o.usage.Facet||o.usage.AdvancedSearch){var f=new F({title:o.label,facetType:"attribute",dimension:o.id,dataType:o.type,matchingStrategy:o.matchingStrategy,});if(s.config.showSpaceFacetInShowMoreDialog){if(s.config.showSpaceFacetInShowMoreDialog(o.id)===false){f.visible=false;}}var g=this._createFacetItemsFromConditionGroup(s.getDataSource(),s.getProperty("/uiFilter/rootCondition"));var h=0;for(var k=0,j=g.length;k<j;k++){var n=g[k];n.visible=f.visible;if(n.facetAttribute===f.dimension){h++;f.items.splice(0,0,n);}}f.count=h;C.push(f);}}C.sort(function(a,b){return a.title.localeCompare(b.title);});return C;},getDialogFacetsFromChartQuery:function(r,s,i,a){var C=new F({dimension:a||s.chartQuery.dimension,});if(r){for(var j=0;j<r.items.length;j++){var f=r.items[j];var b=new c({value:f.measureValue,filterCondition:f.filterCondition,label:f.dimensionValueFormatted,facetAttribute:r.query.dimension,});C.items.push(b);}var e;if(i){e=this._createFacetItemsFromConditionGroup(s.getDataSource(),s.getProperty("/uiFilter/rootCondition"));}else{e=s.aFilters;}for(var k=0,l=e.length;k<l;k++){var o=e[k];if(o.facetAttribute===C.dimension){var g=false;for(var m=0,h=C.items.length;m<h;m++){var n=C.items[m];if(o.filterCondition.equals(n.filterCondition)){n.selected=true;g=true;}}if(!g){C.items.splice(C.items.length,0,o);if(o.filterCondition.userDefined){o.advanced=true;}else{o.listed=true;o.value="";o.valueLabel="";}}else{o.listed=true;}}}}return C;},hasDialogFacetsFromMetaData:function(s){var m=s.getDataSource();var a=jQuery.map(m.attributeMetadataMap,function(e){return e;});var h=false;for(var i=0,l=a.length;i<l;i++){var o=a[i];if(o.usage){if(o.usage.Facet||o.usage.AdvancedSearch){h=true;break;}}}return h;},handleDataSourceChanged:function(){this.hierarchyFacetsFormatter.handleDataSourceChanged();},};return d;});
