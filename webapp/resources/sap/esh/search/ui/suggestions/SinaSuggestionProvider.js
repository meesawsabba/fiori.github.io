/*!
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	
 */
sap.ui.define(["../i18n","sap/esh/search/ui/SearchHelper","sap/esh/search/ui/suggestions/SinaBaseSuggestionProvider","sap/esh/search/ui/suggestions/SuggestionType","sap/esh/search/ui/suggestions/SinaObjectSuggestionFormatter",],function(a,S,b,c,d){"use strict";var m=function(){this.init.apply(this,arguments);};m.prototype=jQuery.extend(new b(),{init:function(){b.prototype.init.apply(this,arguments);this.suggestionLimit=sap.ui.Device.system.phone?5:7;this.suggestionStartingCharacters=this.model.config.suggestionStartingCharacters;this.suggestionQuery=this.sinaNext.createSuggestionQuery();this.sinaObjectSuggestionFormatter=new d(this);},abortSuggestions:function(){this.suggestionQuery.abort();},getSuggestions:function(f){var t=this;this.suggestions=[];this.firstObjectDataSuggestion=true;this.numberSuggestionsByType={};for(var i=0;i<c.types.length;++i){var s=c.types[i];this.numberSuggestionsByType[s]=0;}var e=f.searchTerm;if(this.suggestionTypes.length===1&&this.suggestionTypes.indexOf(c.SearchTermData)>=0&&e.length<this.suggestionStartingCharacters){return Promise.resolve(this.suggestions);}if(this.suggestionTypes.length===1&&this.suggestionTypes.indexOf(c.Object)>=0&&e.length<this.suggestionStartingCharacters){return Promise.resolve(this.suggestions);}if(this.suggestionTypes.length===1&&this.suggestionTypes.indexOf(c.DataSource)>=0&&t.model.getDataSource()!==t.model.sinaNext.allDataSource){return Promise.resolve(this.suggestions);}t.createAllAndAppDsSuggestions();if(!t.model.config.searchBusinessObjects){return Promise.resolve(this.suggestions);}if(t.model.getDataSource()===t.model.appDataSource){return Promise.resolve(this.suggestions);}t.prepareSuggestionQuery(f);return t.suggestionQuery.getResultSetAsync().then(function(r){var g=r.items;t.formatSinaSuggestions(g);return t.suggestions;});},createAllAndAppDsSuggestions:function(){if(this.suggestionTypes.indexOf(c.DataSource)<0){return;}if(this.model.getDataSource()!==this.model.allDataSource){return;}var e=[];e.unshift(this.model.appDataSource);e.unshift(this.model.allDataSource);var s=this.model.getProperty("/uiFilter/searchTerm");var f=s.replace(/\*/g,"");var t=new S.Tester(f);for(var i=0;i<e.length;++i){var g=e[i];if(g.id===this.model.getDataSource().id){continue;}var T=t.test(g.label);if(T.bMatch===true){if(this.isSuggestionLimitReached(c.DataSource)){return;}var h={};h.label="<i>"+a.getText("searchInPlaceholder",[""])+"</i> "+T.sHighlightedText;h.dataSource=g;h.position=c.properties.DataSource.position;h.type=this.sinaNext.SuggestionType.DataSource;h.calculationMode=this.sinaNext.SuggestionCalculationMode.Data;h.uiSuggestionType=c.DataSource;h.uiSuggestionType=c.DataSource;this.addSuggestion(h);}}},isSuggestionLimitReached:function(s){var l=this.suggestionHandler.getSuggestionLimit(s);var n=this.numberSuggestionsByType[s];if(n>=l){return true;}return false;},preFormatSuggestions:function(s){for(var i=0;i<s.length;++i){var e=s[i];e.uiSuggestionType=this.getSuggestionType(e);e.position=c.properties[e.uiSuggestionType].position;this.assembleKey(e);if(e.childSuggestions){this.preFormatSuggestions(e.childSuggestions);}}},assembleKey:function(s){switch(s.uiSuggestionType){case c.DataSource:s.key=c.DataSource+s.dataSource.id;break;case c.SearchTermData:s.key=c.SearchTermData+s.searchTerm;if(s.dataSource){s.key+=s.dataSource.id;}break;case c.SearchTermHistory:s.key=c.SearchTermData+s.searchTerm;if(s.dataSource){s.key+=s.dataSource.id;}break;case c.Object:var o=s.object.title?s.object.title:s.object.detailAttributes[0].value;s.key=c.Object+o;break;}},formatSinaSuggestions:function(s){this.preFormatSuggestions(s);for(var i=0;i<s.length;++i){var e=s[i];if(this.isSuggestionLimitReached(e.uiSuggestionType)){continue;}switch(e.uiSuggestionType){case c.DataSource:if(this.model.getDataSource()!==this.model.allDataSource){continue;}this.addSuggestion(e);break;case c.SearchTermData:this.formatSearchTermDataSuggestion(e);break;case c.SearchTermHistory:this.addSuggestion(e);break;case c.Object:this.sinaObjectSuggestionFormatter.format(this,e);break;default:break;}}return this.suggestions;},addSuggestion:function(s){this.suggestions.push(s);this.numberSuggestionsByType[s.uiSuggestionType]+=1;},formatSearchTermDataSuggestion:function(s){if(this.model.getDataSource()===this.model.allDataSource){if(this.firstObjectDataSuggestion){this.firstObjectDataSuggestion=false;if(s.childSuggestions.length>0){s.label=this.assembleSearchInSuggestionLabel(s);s.grouped=true;this.addSuggestion(s);this.addChildSuggestions(s);}else{this.addSuggestion(s);}}else{this.addSuggestion(s);}}else{this.addSuggestion(s);}},addChildSuggestions:function(s){for(var i=0;i<Math.min(2,s.childSuggestions.length);++i){if(this.isSuggestionLimitReached(c.SearchTermData)){return;}var e=s.childSuggestions[i];e.label=this.assembleSearchInSuggestionLabel(e);e.grouped=true;this.addSuggestion(e);}},assembleSearchInSuggestionLabel:function(s){return a.getText("resultsIn",["<span>"+s.label+"</span>",s.filter.dataSource.labelPlural,]);},getSuggestionType:function(s){switch(s.type){case this.sinaNext.SuggestionType.SearchTerm:if(s.calculationMode===this.sinaNext.SuggestionCalculationMode.History){return c.SearchTermHistory;}return c.SearchTermData;case this.sinaNext.SuggestionType.SearchTermAndDataSource:if(s.calculationMode===this.sinaNext.SuggestionCalculationMode.History){return c.SearchTermHistory;}return c.SearchTermData;case this.sinaNext.SuggestionType.DataSource:return c.DataSource;case this.sinaNext.SuggestionType.Object:return c.Object;}},});return m;});
